{"version":3,"file":"excalibur.min.js","mappings":"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","sources":["webpack://ex/webpack/universalModuleDefinition","webpack://ex/./Director/Loader.css","webpack://ex/./Util/Toaster.css","webpack://ex/../../node_modules/css-loader/dist/runtime/api.js","webpack://ex/../../node_modules/css-loader/dist/runtime/sourceMaps.js","webpack://ex/../../node_modules/core-js/es/array/sort.js","webpack://ex/../../node_modules/core-js/es/object/keys.js","webpack://ex/../../node_modules/core-js/internals/a-callable.js","webpack://ex/../../node_modules/core-js/internals/an-object.js","webpack://ex/../../node_modules/core-js/internals/array-includes.js","webpack://ex/../../node_modules/core-js/internals/array-method-is-strict.js","webpack://ex/../../node_modules/core-js/internals/array-slice.js","webpack://ex/../../node_modules/core-js/internals/array-sort.js","webpack://ex/../../node_modules/core-js/internals/classof-raw.js","webpack://ex/../../node_modules/core-js/internals/classof.js","webpack://ex/../../node_modules/core-js/internals/copy-constructor-properties.js","webpack://ex/../../node_modules/core-js/internals/create-non-enumerable-property.js","webpack://ex/../../node_modules/core-js/internals/create-property-descriptor.js","webpack://ex/../../node_modules/core-js/internals/define-built-in.js","webpack://ex/../../node_modules/core-js/internals/define-global-property.js","webpack://ex/../../node_modules/core-js/internals/delete-property-or-throw.js","webpack://ex/../../node_modules/core-js/internals/descriptors.js","webpack://ex/../../node_modules/core-js/internals/document-create-element.js","webpack://ex/../../node_modules/core-js/internals/engine-ff-version.js","webpack://ex/../../node_modules/core-js/internals/engine-is-ie-or-edge.js","webpack://ex/../../node_modules/core-js/internals/engine-user-agent.js","webpack://ex/../../node_modules/core-js/internals/engine-v8-version.js","webpack://ex/../../node_modules/core-js/internals/engine-webkit-version.js","webpack://ex/../../node_modules/core-js/internals/entry-unbind.js","webpack://ex/../../node_modules/core-js/internals/enum-bug-keys.js","webpack://ex/../../node_modules/core-js/internals/export.js","webpack://ex/../../node_modules/core-js/internals/fails.js","webpack://ex/../../node_modules/core-js/internals/function-bind-native.js","webpack://ex/../../node_modules/core-js/internals/function-call.js","webpack://ex/../../node_modules/core-js/internals/function-name.js","webpack://ex/../../node_modules/core-js/internals/function-uncurry-this.js","webpack://ex/../../node_modules/core-js/internals/get-built-in.js","webpack://ex/../../node_modules/core-js/internals/get-method.js","webpack://ex/../../node_modules/core-js/internals/global.js","webpack://ex/../../node_modules/core-js/internals/has-own-property.js","webpack://ex/../../node_modules/core-js/internals/hidden-keys.js","webpack://ex/../../node_modules/core-js/internals/ie8-dom-define.js","webpack://ex/../../node_modules/core-js/internals/indexed-object.js","webpack://ex/../../node_modules/core-js/internals/inspect-source.js","webpack://ex/../../node_modules/core-js/internals/internal-state.js","webpack://ex/../../node_modules/core-js/internals/is-callable.js","webpack://ex/../../node_modules/core-js/internals/is-forced.js","webpack://ex/../../node_modules/core-js/internals/is-null-or-undefined.js","webpack://ex/../../node_modules/core-js/internals/is-object.js","webpack://ex/../../node_modules/core-js/internals/is-pure.js","webpack://ex/../../node_modules/core-js/internals/is-symbol.js","webpack://ex/../../node_modules/core-js/internals/length-of-array-like.js","webpack://ex/../../node_modules/core-js/internals/make-built-in.js","webpack://ex/../../node_modules/core-js/internals/math-trunc.js","webpack://ex/../../node_modules/core-js/internals/object-define-property.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-descriptor.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-names.js","webpack://ex/../../node_modules/core-js/internals/object-get-own-property-symbols.js","webpack://ex/../../node_modules/core-js/internals/object-is-prototype-of.js","webpack://ex/../../node_modules/core-js/internals/object-keys-internal.js","webpack://ex/../../node_modules/core-js/internals/object-keys.js","webpack://ex/../../node_modules/core-js/internals/object-property-is-enumerable.js","webpack://ex/../../node_modules/core-js/internals/ordinary-to-primitive.js","webpack://ex/../../node_modules/core-js/internals/own-keys.js","webpack://ex/../../node_modules/core-js/internals/path.js","webpack://ex/../../node_modules/core-js/internals/require-object-coercible.js","webpack://ex/../../node_modules/core-js/internals/shared-key.js","webpack://ex/../../node_modules/core-js/internals/shared-store.js","webpack://ex/../../node_modules/core-js/internals/shared.js","webpack://ex/../../node_modules/core-js/internals/symbol-constructor-detection.js","webpack://ex/../../node_modules/core-js/internals/to-absolute-index.js","webpack://ex/../../node_modules/core-js/internals/to-indexed-object.js","webpack://ex/../../node_modules/core-js/internals/to-integer-or-infinity.js","webpack://ex/../../node_modules/core-js/internals/to-length.js","webpack://ex/../../node_modules/core-js/internals/to-object.js","webpack://ex/../../node_modules/core-js/internals/to-primitive.js","webpack://ex/../../node_modules/core-js/internals/to-property-key.js","webpack://ex/../../node_modules/core-js/internals/to-string-tag-support.js","webpack://ex/../../node_modules/core-js/internals/to-string.js","webpack://ex/../../node_modules/core-js/internals/try-to-string.js","webpack://ex/../../node_modules/core-js/internals/uid.js","webpack://ex/../../node_modules/core-js/internals/use-symbol-as-uid.js","webpack://ex/../../node_modules/core-js/internals/v8-prototype-define-bug.js","webpack://ex/../../node_modules/core-js/internals/weak-map-basic-detection.js","webpack://ex/../../node_modules/core-js/internals/well-known-symbol.js","webpack://ex/../../node_modules/core-js/modules/es.array.sort.js","webpack://ex/../../node_modules/core-js/modules/es.object.keys.js","webpack://ex/webpack/bootstrap","webpack://ex/webpack/runtime/compat get default export","webpack://ex/webpack/runtime/define property getters","webpack://ex/webpack/runtime/global","webpack://ex/webpack/runtime/hasOwnProperty shorthand","webpack://ex/webpack/runtime/make namespace object","webpack://ex/./Input/PointerScope.ts","webpack://ex/./Polyfill.ts","webpack://ex/./Flags.ts","webpack://ex/./Id.ts","webpack://ex/./Util/Future.ts","webpack://ex/./EventEmitter.ts","webpack://ex/./Math/Random.ts","webpack://ex/./Math/util.ts","webpack://ex/./Math/vector.ts","webpack://ex/./Color.ts","webpack://ex/./Util/Log.ts","webpack://ex/./Collision/Side.ts","webpack://ex/./Math/matrix.ts","webpack://ex/./Collision/BoundingBox.ts","webpack://ex/./Util/Util.ts","webpack://ex/./Math/affine-matrix.ts","webpack://ex/./Graphics/Context/transform-stack.ts","webpack://ex/./Graphics/Context/state-stack.ts","webpack://ex/./Resources/Resource.ts","webpack://ex/./Util/Watch.ts","webpack://ex/./Graphics/Graphic.ts","webpack://ex/./Graphics/Sprite.ts","webpack://ex/./Graphics/Filtering.ts","webpack://ex/./Graphics/Wrapping.ts","webpack://ex/./Graphics/Context/texture-loader.ts","webpack://ex/./Graphics/ImageSource.ts","webpack://ex/./Graphics/SpriteFont.ts","webpack://ex/./Graphics/SpriteSheet.ts","webpack://ex/./Graphics/Context/debug-text.ts","webpack://ex/./Graphics/Context/debug-font.png","webpack://ex/./Graphics/Context/render-source.ts","webpack://ex/./Graphics/Context/render-target.ts","webpack://ex/./Graphics/Context/webgl-util.ts","webpack://ex/./Graphics/Context/shader.ts","webpack://ex/./Graphics/Context/vertex-buffer.ts","webpack://ex/./Graphics/Context/vertex-layout.ts","webpack://ex/./Graphics/GraphicsDiagnostics.ts","webpack://ex/./Graphics/Context/line-renderer/line-renderer.ts","webpack://ex/./Graphics/Context/line-renderer/line-vertex.glsl","webpack://ex/./Graphics/Context/line-renderer/line-fragment.glsl","webpack://ex/./Graphics/Context/point-renderer/point-renderer.ts","webpack://ex/./Graphics/Context/point-renderer/point-vertex.glsl","webpack://ex/./Graphics/Context/point-renderer/point-fragment.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-pass-painter.ts","webpack://ex/./Graphics/Context/screen-pass-painter/screen-vertex.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-fragment.glsl","webpack://ex/./Graphics/Context/quad-index-buffer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.frag.glsl","webpack://ex/./Graphics/Context/image-renderer/image-renderer.vert.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.ts","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.frag.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.vert.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.ts","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.frag.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.vert.glsl","webpack://ex/./Util/Pool.ts","webpack://ex/./Graphics/Context/draw-call.ts","webpack://ex/./Graphics/Context/material.ts","webpack://ex/./Graphics/Context/material-renderer/material-renderer.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContextWebGL.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContext2DCanvas.ts","webpack://ex/./Screen.ts","webpack://ex/./Resources/Sound/AudioContext.ts","webpack://ex/./Util/WebAudio.ts","webpack://ex/./Graphics/Raster.ts","webpack://ex/./Graphics/Canvas.ts","webpack://ex/./Interfaces/AudioImplementation.ts","webpack://ex/./Util/StateMachine.ts","webpack://ex/./Resources/Sound/WebAudioInstance.ts","webpack://ex/./Events.ts","webpack://ex/./Events/MediaEvents.ts","webpack://ex/./Util/Sound.ts","webpack://ex/./Resources/Sound/Sound.ts","webpack://ex/./Director/DefaultLoader.ts","webpack://ex/./Util/DrawUtil.ts","webpack://ex/./Director/Loader.ts","webpack://ex/./Director/Loader.logo.png","webpack://ex/./Util/Detector.ts","webpack://ex/./Collision/CollisionType.ts","webpack://ex/./Math/coord-plane.ts","webpack://ex/./Collision/SolverStrategy.ts","webpack://ex/./Collision/Physics.ts","webpack://ex/./Collision/Solver/ContactBias.ts","webpack://ex/./Math/vector-view.ts","webpack://ex/./Math/watch-vector.ts","webpack://ex/./Math/transform.ts","webpack://ex/./EntityComponentSystem/Component.ts","webpack://ex/./Util/Observable.ts","webpack://ex/./EntityComponentSystem/Components/TransformComponent.ts","webpack://ex/./EntityComponentSystem/Components/MotionComponent.ts","webpack://ex/./Collision/Group/CollisionGroupManager.ts","webpack://ex/./Collision/Group/CollisionGroup.ts","webpack://ex/./Collision/Detection/Pair.ts","webpack://ex/./Math/projection.ts","webpack://ex/./Collision/Detection/DynamicTree.ts","webpack://ex/./Math/ray.ts","webpack://ex/./Collision/Detection/DynamicTreeCollisionProcessor.ts","webpack://ex/./Collision/Colliders/Collider.ts","webpack://ex/./Collision/PhysicsConfig.ts","webpack://ex/./Collision/Colliders/CompositeCollider.ts","webpack://ex/./Math/line-segment.ts","webpack://ex/./Collision/Colliders/ClosestLineJumpTable.ts","webpack://ex/./Collision/Colliders/CircleCollider.ts","webpack://ex/./Collision/Detection/CollisionContact.ts","webpack://ex/./Collision/Colliders/SeparatingAxis.ts","webpack://ex/./Collision/Colliders/CollisionJumpTable.ts","webpack://ex/./Collision/Colliders/EdgeCollider.ts","webpack://ex/./Graphics/Debug.ts","webpack://ex/./Collision/Colliders/PolygonCollider.ts","webpack://ex/./Collision/Colliders/Shape.ts","webpack://ex/./Collision/ColliderComponent.ts","webpack://ex/./Collision/BodyComponent.ts","webpack://ex/./EntityComponentSystem/Entity.ts","webpack://ex/./Graphics/Animation.ts","webpack://ex/./Graphics/GraphicsGroup.ts","webpack://ex/./Graphics/GraphicsComponent.ts","webpack://ex/./Graphics/Rectangle.ts","webpack://ex/./Graphics/Circle.ts","webpack://ex/./Input/PointerComponent.ts","webpack://ex/./Util/EasingFunctions.ts","webpack://ex/./Actions/ActionQueue.ts","webpack://ex/./Actions/Action/Repeat.ts","webpack://ex/./Actions/Action/RepeatForever.ts","webpack://ex/./Actions/Action/MoveBy.ts","webpack://ex/./Actions/Action/MoveTo.ts","webpack://ex/./Actions/RotationType.ts","webpack://ex/./Graphics/FontCommon.ts","webpack://ex/./Actions/Action/RotateTo.ts","webpack://ex/./Actions/Action/RotateBy.ts","webpack://ex/./Actions/Action/ScaleTo.ts","webpack://ex/./Actions/Action/ScaleBy.ts","webpack://ex/./Actions/Action/CallMethod.ts","webpack://ex/./Actions/Action/EaseTo.ts","webpack://ex/./Actions/Action/EaseBy.ts","webpack://ex/./Actions/Action/Blink.ts","webpack://ex/./Actions/Action/Fade.ts","webpack://ex/./Actions/Action/Delay.ts","webpack://ex/./Actions/Action/Die.ts","webpack://ex/./Actions/Action/Follow.ts","webpack://ex/./Actions/Action/Meet.ts","webpack://ex/./Actions/ActionContext.ts","webpack://ex/./Actions/ActionsComponent.ts","webpack://ex/./Graphics/FontTextInstance.ts","webpack://ex/./Graphics/FontCache.ts","webpack://ex/./Graphics/Font.ts","webpack://ex/./Graphics/Text.ts","webpack://ex/./Actor.ts","webpack://ex/./ScreenElement.ts","webpack://ex/./Timer.ts","webpack://ex/./Graphics/ParallaxComponent.ts","webpack://ex/./Graphics/DebugGraphicsComponent.ts","webpack://ex/./TileMap/TileMap.ts","webpack://ex/./Camera.ts","webpack://ex/./Trigger.ts","webpack://ex/./EntityComponentSystem/Priority.ts","webpack://ex/./EntityComponentSystem/System.ts","webpack://ex/./Particles.ts","webpack://ex/./EntityComponentSystem/EntityManager.ts","webpack://ex/./EntityComponentSystem/Query.ts","webpack://ex/./EntityComponentSystem/TagQuery.ts","webpack://ex/./EntityComponentSystem/QueryManager.ts","webpack://ex/./EntityComponentSystem/SystemManager.ts","webpack://ex/./EntityComponentSystem/World.ts","webpack://ex/./Collision/Integrator.ts","webpack://ex/./Collision/MotionSystem.ts","webpack://ex/./Collision/Solver/ArcadeSolver.ts","webpack://ex/./Collision/Solver/ContactConstraintPoint.ts","webpack://ex/./Collision/Solver/RealisticSolver.ts","webpack://ex/./Collision/CollisionSystem.ts","webpack://ex/./Configurable.ts","webpack://ex/./Graphics/TransformInterpolation.ts","webpack://ex/./Graphics/GraphicsSystem.ts","webpack://ex/./Debug/DebugSystem.ts","webpack://ex/./Input/PointerSystem.ts","webpack://ex/./Actions/ActionsSystem.ts","webpack://ex/./TileMap/IsometricEntityComponent.ts","webpack://ex/./TileMap/IsometricEntitySystem.ts","webpack://ex/./Graphics/OffscreenSystem.ts","webpack://ex/./Collision/PhysicsWorld.ts","webpack://ex/./Input/Gamepad.ts","webpack://ex/./Input/Keyboard.ts","webpack://ex/./Input/InputMapper.ts","webpack://ex/./Util/IFrame.ts","webpack://ex/./Math/global-coordinates.ts","webpack://ex/./Input/PointerEvent.ts","webpack://ex/./Input/WheelEvent.ts","webpack://ex/./Input/PointerAbstraction.ts","webpack://ex/./Input/WheelDeltaMode.ts","webpack://ex/./Input/NativePointerButton.ts","webpack://ex/./Input/PointerButton.ts","webpack://ex/./Input/PointerType.ts","webpack://ex/./Input/PointerEventReceiver.ts","webpack://ex/./Input/InputHost.ts","webpack://ex/./Scene.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessMode.ts","webpack://ex/./Graphics/PostProcessor/ScreenShader.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessPostProcessor.ts","webpack://ex/./Graphics/PostProcessor/color-blind-fragment.glsl","webpack://ex/./Debug/DebugFlags.ts","webpack://ex/./Debug/DebugConfig.ts","webpack://ex/./Util/Browser.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContext.ts","webpack://ex/./Util/Fps.ts","webpack://ex/./Util/Clock.ts","webpack://ex/./Util/Toaster.ts","webpack://ex/./Director/Director.ts","webpack://ex/./Engine.ts","webpack://ex/./Context.ts","webpack://ex/./EventDispatcher.ts","webpack://ex/./Label.ts","webpack://ex/./TileMap/IsometricMap.ts","webpack://ex/./Actions/Action/ActionSequence.ts","webpack://ex/./Actions/Action/ParallelActions.ts","webpack://ex/./Collision/Detection/QuadTree.ts","webpack://ex/./Interfaces/LifecycleEvents.ts","webpack://ex/./Resources/Gif.ts","webpack://ex/./Resources/Font.ts","webpack://ex/./Util/Coroutine.ts","webpack://ex/./Director/Transition.ts","webpack://ex/./Director/FadeInOut.ts","webpack://ex/./Director/CrossFade.ts","webpack://ex/./Graphics/Line.ts","webpack://ex/./Graphics/Polygon.ts","webpack://ex/./Util/Decorators.ts","webpack://ex/./Util/Semaphore.ts","webpack://ex/./index.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ex\"] = factory();\n\telse\n\t\troot[\"ex\"] = factory();\n})(self, () => {\nreturn ","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, `/* Buttons styles start */\r\n\r\nbutton#excalibur-play {\r\n  display: inline-block;\r\n  position: relative;\r\n  z-index: 999;\r\n  border-radius: 6px;\r\n  border: none;\r\n  /*border: 3px solid;\r\n    border-color: white;\r\n    box-shadow: 0 0 10px #ccc;*/\r\n  padding: 1rem 1.5rem 1rem 4rem;\r\n  margin: 0;\r\n  text-decoration: none;\r\n  background: #00b233;\r\n  color: #ffffff;\r\n  font-family: sans-serif;\r\n  font-size: 2rem;\r\n  white-space: nowrap;\r\n  line-height: 1;\r\n  cursor: pointer;\r\n  text-align: center;\r\n  transition: background 250ms ease-in-out, transform 150ms ease;\r\n  -webkit-appearance: none;\r\n  -moz-appearance: none;\r\n\r\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r\n  animation: excalibur-button-fadein 200ms;\r\n}\r\n\r\n/*\r\nbutton#excalibur-play {\r\n  display: none;\r\n}*/\r\n\r\nbutton#excalibur-play:after {\r\n  position: absolute;\r\n  content: '';\r\n  border: 8px solid;\r\n  border-color: transparent transparent transparent white;\r\n  left: 35px;\r\n  top: 24px;\r\n  width: 0;\r\n  height: 0;\r\n}\r\n\r\nbutton#excalibur-play:before {\r\n  position: absolute;\r\n  content: '';\r\n  border: 3px solid;\r\n  left: 19px;\r\n  top: 14px;\r\n  border-radius: 20px;\r\n  width: 30px;\r\n  height: 30px;\r\n}\r\n\r\nbutton#excalibur-play:hover,\r\nbutton#excalibur-play:focus {\r\n  background: #00982c;\r\n}\r\n\r\nbutton#excalibur-play:focus {\r\n  outline: 1px solid #fff;\r\n  outline-offset: -4px;\r\n}\r\n\r\nbutton#excalibur-play:active {\r\n  transform: scale(0.99);\r\n}\r\n\r\n@keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Firefox < 16 */\r\n@-moz-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Safari, Chrome and Opera > 12.1 */\r\n@-webkit-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Internet Explorer */\r\n@-ms-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Opera < 12.1 */\r\n@-o-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n`, \"\",{\"version\":3,\"sources\":[\"webpack://./Director/Loader.css\"],\"names\":[],\"mappings\":\"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB,8DAA8D;EAC9D,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF\",\"sourcesContent\":[\"/* Buttons styles start */\\r\\n\\r\\nbutton#excalibur-play {\\r\\n  display: inline-block;\\r\\n  position: relative;\\r\\n  z-index: 999;\\r\\n  border-radius: 6px;\\r\\n  border: none;\\r\\n  /*border: 3px solid;\\r\\n    border-color: white;\\r\\n    box-shadow: 0 0 10px #ccc;*/\\r\\n  padding: 1rem 1.5rem 1rem 4rem;\\r\\n  margin: 0;\\r\\n  text-decoration: none;\\r\\n  background: #00b233;\\r\\n  color: #ffffff;\\r\\n  font-family: sans-serif;\\r\\n  font-size: 2rem;\\r\\n  white-space: nowrap;\\r\\n  line-height: 1;\\r\\n  cursor: pointer;\\r\\n  text-align: center;\\r\\n  transition: background 250ms ease-in-out, transform 150ms ease;\\r\\n  -webkit-appearance: none;\\r\\n  -moz-appearance: none;\\r\\n\\r\\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\\r\\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\\r\\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\\r\\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\\r\\n  animation: excalibur-button-fadein 200ms;\\r\\n}\\r\\n\\r\\n/*\\r\\nbutton#excalibur-play {\\r\\n  display: none;\\r\\n}*/\\r\\n\\r\\nbutton#excalibur-play:after {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 8px solid;\\r\\n  border-color: transparent transparent transparent white;\\r\\n  left: 35px;\\r\\n  top: 24px;\\r\\n  width: 0;\\r\\n  height: 0;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:before {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 3px solid;\\r\\n  left: 19px;\\r\\n  top: 14px;\\r\\n  border-radius: 20px;\\r\\n  width: 30px;\\r\\n  height: 30px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:hover,\\r\\nbutton#excalibur-play:focus {\\r\\n  background: #00982c;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:focus {\\r\\n  outline: 1px solid #fff;\\r\\n  outline-offset: -4px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:active {\\r\\n  transform: scale(0.99);\\r\\n}\\r\\n\\r\\n@keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Firefox < 16 */\\r\\n@-moz-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Safari, Chrome and Opera > 12.1 */\\r\\n@-webkit-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Internet Explorer */\\r\\n@-ms-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Opera < 12.1 */\\r\\n@-o-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, `\r\n#ex-toast-container {\r\n  position: absolute;\r\n  height: 0;\r\n  min-width: 50%;\r\n  left: 50%;\r\n  top: 0;\r\n}\r\n\r\n.ex-toast-message {\r\n  left: -50%;\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: space-between;\r\n\r\n\r\n  padding: 10px;\r\n  margin-top: 5px;\r\n  font-size: 18px;\r\n  font-family: sans-serif;\r\n  border-radius: 6px;\r\n  border: 3px solid #b7b779;\r\n  background-color: rgb(253, 253, 192);\r\n}\r\n\r\n\r\n.ex-toast-message button {\r\n  align-self: flex-start;\r\n}`, \"\",{\"version\":3,\"sources\":[\"webpack://./Util/Toaster.css\"],\"names\":[],\"mappings\":\";AACA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;;EAG9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;;AAGA;EACE,sBAAsB;AACxB\",\"sourcesContent\":[\"\\r\\n#ex-toast-container {\\r\\n  position: absolute;\\r\\n  height: 0;\\r\\n  min-width: 50%;\\r\\n  left: 50%;\\r\\n  top: 0;\\r\\n}\\r\\n\\r\\n.ex-toast-message {\\r\\n  left: -50%;\\r\\n  position: relative;\\r\\n  display: flex;\\r\\n  justify-content: space-between;\\r\\n\\r\\n\\r\\n  padding: 10px;\\r\\n  margin-top: 5px;\\r\\n  font-size: 18px;\\r\\n  font-family: sans-serif;\\r\\n  border-radius: 6px;\\r\\n  border: 3px solid #b7b779;\\r\\n  background-color: rgb(253, 253, 192);\\r\\n}\\r\\n\\r\\n\\r\\n.ex-toast-message button {\\r\\n  align-self: flex-start;\\r\\n}\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","\"use strict\";\n\n/*\n  MIT License http://www.opensource.org/licenses/mit-license.php\n  Author Tobias Koppers @sokra\n*/\nmodule.exports = function (cssWithMappingToString) {\n  var list = [];\n\n  // return the list of modules as css string\n  list.toString = function toString() {\n    return this.map(function (item) {\n      var content = \"\";\n      var needLayer = typeof item[5] !== \"undefined\";\n      if (item[4]) {\n        content += \"@supports (\".concat(item[4], \") {\");\n      }\n      if (item[2]) {\n        content += \"@media \".concat(item[2], \" {\");\n      }\n      if (needLayer) {\n        content += \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\");\n      }\n      content += cssWithMappingToString(item);\n      if (needLayer) {\n        content += \"}\";\n      }\n      if (item[2]) {\n        content += \"}\";\n      }\n      if (item[4]) {\n        content += \"}\";\n      }\n      return content;\n    }).join(\"\");\n  };\n\n  // import a list of modules into the list\n  list.i = function i(modules, media, dedupe, supports, layer) {\n    if (typeof modules === \"string\") {\n      modules = [[null, modules, undefined]];\n    }\n    var alreadyImportedModules = {};\n    if (dedupe) {\n      for (var k = 0; k < this.length; k++) {\n        var id = this[k][0];\n        if (id != null) {\n          alreadyImportedModules[id] = true;\n        }\n      }\n    }\n    for (var _k = 0; _k < modules.length; _k++) {\n      var item = [].concat(modules[_k]);\n      if (dedupe && alreadyImportedModules[item[0]]) {\n        continue;\n      }\n      if (typeof layer !== \"undefined\") {\n        if (typeof item[5] === \"undefined\") {\n          item[5] = layer;\n        } else {\n          item[1] = \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\").concat(item[1], \"}\");\n          item[5] = layer;\n        }\n      }\n      if (media) {\n        if (!item[2]) {\n          item[2] = media;\n        } else {\n          item[1] = \"@media \".concat(item[2], \" {\").concat(item[1], \"}\");\n          item[2] = media;\n        }\n      }\n      if (supports) {\n        if (!item[4]) {\n          item[4] = \"\".concat(supports);\n        } else {\n          item[1] = \"@supports (\".concat(item[4], \") {\").concat(item[1], \"}\");\n          item[4] = supports;\n        }\n      }\n      list.push(item);\n    }\n  };\n  return list;\n};","\"use strict\";\n\nmodule.exports = function (item) {\n  var content = item[1];\n  var cssMapping = item[3];\n  if (!cssMapping) {\n    return content;\n  }\n  if (typeof btoa === \"function\") {\n    var base64 = btoa(unescape(encodeURIComponent(JSON.stringify(cssMapping))));\n    var data = \"sourceMappingURL=data:application/json;charset=utf-8;base64,\".concat(base64);\n    var sourceMapping = \"/*# \".concat(data, \" */\");\n    return [content].concat([sourceMapping]).join(\"\\n\");\n  }\n  return [content].join(\"\\n\");\n};","'use strict';\nrequire('../../modules/es.array.sort');\nvar entryUnbind = require('../../internals/entry-unbind');\n\nmodule.exports = entryUnbind('Array', 'sort');\n","'use strict';\nrequire('../../modules/es.object.keys');\nvar path = require('../../internals/path');\n\nmodule.exports = path.Object.keys;\n","'use strict';\nvar isCallable = require('../internals/is-callable');\nvar tryToString = require('../internals/try-to-string');\n\nvar $TypeError = TypeError;\n\n// `Assert: IsCallable(argument) is true`\nmodule.exports = function (argument) {\n  if (isCallable(argument)) return argument;\n  throw new $TypeError(tryToString(argument) + ' is not a function');\n};\n","'use strict';\nvar isObject = require('../internals/is-object');\n\nvar $String = String;\nvar $TypeError = TypeError;\n\n// `Assert: Type(argument) is Object`\nmodule.exports = function (argument) {\n  if (isObject(argument)) return argument;\n  throw new $TypeError($String(argument) + ' is not an object');\n};\n","'use strict';\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar toAbsoluteIndex = require('../internals/to-absolute-index');\nvar lengthOfArrayLike = require('../internals/length-of-array-like');\n\n// `Array.prototype.{ indexOf, includes }` methods implementation\nvar createMethod = function (IS_INCLUDES) {\n  return function ($this, el, fromIndex) {\n    var O = toIndexedObject($this);\n    var length = lengthOfArrayLike(O);\n    if (length === 0) return !IS_INCLUDES && -1;\n    var index = toAbsoluteIndex(fromIndex, length);\n    var value;\n    // Array#includes uses SameValueZero equality algorithm\n    // eslint-disable-next-line no-self-compare -- NaN check\n    if (IS_INCLUDES && el !== el) while (length > index) {\n      value = O[index++];\n      // eslint-disable-next-line no-self-compare -- NaN check\n      if (value !== value) return true;\n    // Array#indexOf ignores holes, Array#includes - not\n    } else for (;length > index; index++) {\n      if ((IS_INCLUDES || index in O) && O[index] === el) return IS_INCLUDES || index || 0;\n    } return !IS_INCLUDES && -1;\n  };\n};\n\nmodule.exports = {\n  // `Array.prototype.includes` method\n  // https://tc39.es/ecma262/#sec-array.prototype.includes\n  includes: createMethod(true),\n  // `Array.prototype.indexOf` method\n  // https://tc39.es/ecma262/#sec-array.prototype.indexof\n  indexOf: createMethod(false)\n};\n","'use strict';\nvar fails = require('../internals/fails');\n\nmodule.exports = function (METHOD_NAME, argument) {\n  var method = [][METHOD_NAME];\n  return !!method && fails(function () {\n    // eslint-disable-next-line no-useless-call -- required for testing\n    method.call(null, argument || function () { return 1; }, 1);\n  });\n};\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nmodule.exports = uncurryThis([].slice);\n","'use strict';\nvar arraySlice = require('../internals/array-slice');\n\nvar floor = Math.floor;\n\nvar sort = function (array, comparefn) {\n  var length = array.length;\n\n  if (length < 8) {\n    // insertion sort\n    var i = 1;\n    var element, j;\n\n    while (i < length) {\n      j = i;\n      element = array[i];\n      while (j && comparefn(array[j - 1], element) > 0) {\n        array[j] = array[--j];\n      }\n      if (j !== i++) array[j] = element;\n    }\n  } else {\n    // merge sort\n    var middle = floor(length / 2);\n    var left = sort(arraySlice(array, 0, middle), comparefn);\n    var right = sort(arraySlice(array, middle), comparefn);\n    var llength = left.length;\n    var rlength = right.length;\n    var lindex = 0;\n    var rindex = 0;\n\n    while (lindex < llength || rindex < rlength) {\n      array[lindex + rindex] = (lindex < llength && rindex < rlength)\n        ? comparefn(left[lindex], right[rindex]) <= 0 ? left[lindex++] : right[rindex++]\n        : lindex < llength ? left[lindex++] : right[rindex++];\n    }\n  }\n\n  return array;\n};\n\nmodule.exports = sort;\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nvar toString = uncurryThis({}.toString);\nvar stringSlice = uncurryThis(''.slice);\n\nmodule.exports = function (it) {\n  return stringSlice(toString(it), 8, -1);\n};\n","'use strict';\nvar TO_STRING_TAG_SUPPORT = require('../internals/to-string-tag-support');\nvar isCallable = require('../internals/is-callable');\nvar classofRaw = require('../internals/classof-raw');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar TO_STRING_TAG = wellKnownSymbol('toStringTag');\nvar $Object = Object;\n\n// ES3 wrong here\nvar CORRECT_ARGUMENTS = classofRaw(function () { return arguments; }()) === 'Arguments';\n\n// fallback for IE11 Script Access Denied error\nvar tryGet = function (it, key) {\n  try {\n    return it[key];\n  } catch (error) { /* empty */ }\n};\n\n// getting tag from ES6+ `Object.prototype.toString`\nmodule.exports = TO_STRING_TAG_SUPPORT ? classofRaw : function (it) {\n  var O, tag, result;\n  return it === undefined ? 'Undefined' : it === null ? 'Null'\n    // @@toStringTag case\n    : typeof (tag = tryGet(O = $Object(it), TO_STRING_TAG)) == 'string' ? tag\n    // builtinTag case\n    : CORRECT_ARGUMENTS ? classofRaw(O)\n    // ES3 arguments fallback\n    : (result = classofRaw(O)) === 'Object' && isCallable(O.callee) ? 'Arguments' : result;\n};\n","'use strict';\nvar hasOwn = require('../internals/has-own-property');\nvar ownKeys = require('../internals/own-keys');\nvar getOwnPropertyDescriptorModule = require('../internals/object-get-own-property-descriptor');\nvar definePropertyModule = require('../internals/object-define-property');\n\nmodule.exports = function (target, source, exceptions) {\n  var keys = ownKeys(source);\n  var defineProperty = definePropertyModule.f;\n  var getOwnPropertyDescriptor = getOwnPropertyDescriptorModule.f;\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    if (!hasOwn(target, key) && !(exceptions && hasOwn(exceptions, key))) {\n      defineProperty(target, key, getOwnPropertyDescriptor(source, key));\n    }\n  }\n};\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar definePropertyModule = require('../internals/object-define-property');\nvar createPropertyDescriptor = require('../internals/create-property-descriptor');\n\nmodule.exports = DESCRIPTORS ? function (object, key, value) {\n  return definePropertyModule.f(object, key, createPropertyDescriptor(1, value));\n} : function (object, key, value) {\n  object[key] = value;\n  return object;\n};\n","'use strict';\nmodule.exports = function (bitmap, value) {\n  return {\n    enumerable: !(bitmap & 1),\n    configurable: !(bitmap & 2),\n    writable: !(bitmap & 4),\n    value: value\n  };\n};\n","'use strict';\nvar isCallable = require('../internals/is-callable');\nvar definePropertyModule = require('../internals/object-define-property');\nvar makeBuiltIn = require('../internals/make-built-in');\nvar defineGlobalProperty = require('../internals/define-global-property');\n\nmodule.exports = function (O, key, value, options) {\n  if (!options) options = {};\n  var simple = options.enumerable;\n  var name = options.name !== undefined ? options.name : key;\n  if (isCallable(value)) makeBuiltIn(value, name, options);\n  if (options.global) {\n    if (simple) O[key] = value;\n    else defineGlobalProperty(key, value);\n  } else {\n    try {\n      if (!options.unsafe) delete O[key];\n      else if (O[key]) simple = true;\n    } catch (error) { /* empty */ }\n    if (simple) O[key] = value;\n    else definePropertyModule.f(O, key, {\n      value: value,\n      enumerable: false,\n      configurable: !options.nonConfigurable,\n      writable: !options.nonWritable\n    });\n  } return O;\n};\n","'use strict';\nvar global = require('../internals/global');\n\n// eslint-disable-next-line es/no-object-defineproperty -- safe\nvar defineProperty = Object.defineProperty;\n\nmodule.exports = function (key, value) {\n  try {\n    defineProperty(global, key, { value: value, configurable: true, writable: true });\n  } catch (error) {\n    global[key] = value;\n  } return value;\n};\n","'use strict';\nvar tryToString = require('../internals/try-to-string');\n\nvar $TypeError = TypeError;\n\nmodule.exports = function (O, P) {\n  if (!delete O[P]) throw new $TypeError('Cannot delete property ' + tryToString(P) + ' of ' + tryToString(O));\n};\n","'use strict';\nvar fails = require('../internals/fails');\n\n// Detect IE8's incomplete defineProperty implementation\nmodule.exports = !fails(function () {\n  // eslint-disable-next-line es/no-object-defineproperty -- required for testing\n  return Object.defineProperty({}, 1, { get: function () { return 7; } })[1] !== 7;\n});\n","'use strict';\nvar global = require('../internals/global');\nvar isObject = require('../internals/is-object');\n\nvar document = global.document;\n// typeof document.createElement is 'object' in old IE\nvar EXISTS = isObject(document) && isObject(document.createElement);\n\nmodule.exports = function (it) {\n  return EXISTS ? document.createElement(it) : {};\n};\n","'use strict';\nvar userAgent = require('../internals/engine-user-agent');\n\nvar firefox = userAgent.match(/firefox\\/(\\d+)/i);\n\nmodule.exports = !!firefox && +firefox[1];\n","'use strict';\nvar UA = require('../internals/engine-user-agent');\n\nmodule.exports = /MSIE|Trident/.test(UA);\n","'use strict';\nmodule.exports = typeof navigator != 'undefined' && String(navigator.userAgent) || '';\n","'use strict';\nvar global = require('../internals/global');\nvar userAgent = require('../internals/engine-user-agent');\n\nvar process = global.process;\nvar Deno = global.Deno;\nvar versions = process && process.versions || Deno && Deno.version;\nvar v8 = versions && versions.v8;\nvar match, version;\n\nif (v8) {\n  match = v8.split('.');\n  // in old Chrome, versions of V8 isn't V8 = Chrome / 10\n  // but their correct versions are not interesting for us\n  version = match[0] > 0 && match[0] < 4 ? 1 : +(match[0] + match[1]);\n}\n\n// BrowserFS NodeJS `process` polyfill incorrectly set `.v8` to `0.0`\n// so check `userAgent` even if `.v8` exists, but 0\nif (!version && userAgent) {\n  match = userAgent.match(/Edge\\/(\\d+)/);\n  if (!match || match[1] >= 74) {\n    match = userAgent.match(/Chrome\\/(\\d+)/);\n    if (match) version = +match[1];\n  }\n}\n\nmodule.exports = version;\n","'use strict';\nvar userAgent = require('../internals/engine-user-agent');\n\nvar webkit = userAgent.match(/AppleWebKit\\/(\\d+)\\./);\n\nmodule.exports = !!webkit && +webkit[1];\n","'use strict';\nvar global = require('../internals/global');\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nmodule.exports = function (CONSTRUCTOR, METHOD) {\n  return uncurryThis(global[CONSTRUCTOR].prototype[METHOD]);\n};\n","'use strict';\n// IE8- don't enum bug keys\nmodule.exports = [\n  'constructor',\n  'hasOwnProperty',\n  'isPrototypeOf',\n  'propertyIsEnumerable',\n  'toLocaleString',\n  'toString',\n  'valueOf'\n];\n","'use strict';\nvar global = require('../internals/global');\nvar getOwnPropertyDescriptor = require('../internals/object-get-own-property-descriptor').f;\nvar createNonEnumerableProperty = require('../internals/create-non-enumerable-property');\nvar defineBuiltIn = require('../internals/define-built-in');\nvar defineGlobalProperty = require('../internals/define-global-property');\nvar copyConstructorProperties = require('../internals/copy-constructor-properties');\nvar isForced = require('../internals/is-forced');\n\n/*\n  options.target         - name of the target object\n  options.global         - target is the global object\n  options.stat           - export as static methods of target\n  options.proto          - export as prototype methods of target\n  options.real           - real prototype method for the `pure` version\n  options.forced         - export even if the native feature is available\n  options.bind           - bind methods to the target, required for the `pure` version\n  options.wrap           - wrap constructors to preventing global pollution, required for the `pure` version\n  options.unsafe         - use the simple assignment of property instead of delete + defineProperty\n  options.sham           - add a flag to not completely full polyfills\n  options.enumerable     - export as enumerable property\n  options.dontCallGetSet - prevent calling a getter on target\n  options.name           - the .name of the function if it does not match the key\n*/\nmodule.exports = function (options, source) {\n  var TARGET = options.target;\n  var GLOBAL = options.global;\n  var STATIC = options.stat;\n  var FORCED, target, key, targetProperty, sourceProperty, descriptor;\n  if (GLOBAL) {\n    target = global;\n  } else if (STATIC) {\n    target = global[TARGET] || defineGlobalProperty(TARGET, {});\n  } else {\n    target = global[TARGET] && global[TARGET].prototype;\n  }\n  if (target) for (key in source) {\n    sourceProperty = source[key];\n    if (options.dontCallGetSet) {\n      descriptor = getOwnPropertyDescriptor(target, key);\n      targetProperty = descriptor && descriptor.value;\n    } else targetProperty = target[key];\n    FORCED = isForced(GLOBAL ? key : TARGET + (STATIC ? '.' : '#') + key, options.forced);\n    // contained in target\n    if (!FORCED && targetProperty !== undefined) {\n      if (typeof sourceProperty == typeof targetProperty) continue;\n      copyConstructorProperties(sourceProperty, targetProperty);\n    }\n    // add a flag to not completely full polyfills\n    if (options.sham || (targetProperty && targetProperty.sham)) {\n      createNonEnumerableProperty(sourceProperty, 'sham', true);\n    }\n    defineBuiltIn(target, key, sourceProperty, options);\n  }\n};\n","'use strict';\nmodule.exports = function (exec) {\n  try {\n    return !!exec();\n  } catch (error) {\n    return true;\n  }\n};\n","'use strict';\nvar fails = require('../internals/fails');\n\nmodule.exports = !fails(function () {\n  // eslint-disable-next-line es/no-function-prototype-bind -- safe\n  var test = (function () { /* empty */ }).bind();\n  // eslint-disable-next-line no-prototype-builtins -- safe\n  return typeof test != 'function' || test.hasOwnProperty('prototype');\n});\n","'use strict';\nvar NATIVE_BIND = require('../internals/function-bind-native');\n\nvar call = Function.prototype.call;\n\nmodule.exports = NATIVE_BIND ? call.bind(call) : function () {\n  return call.apply(call, arguments);\n};\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar hasOwn = require('../internals/has-own-property');\n\nvar FunctionPrototype = Function.prototype;\n// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe\nvar getDescriptor = DESCRIPTORS && Object.getOwnPropertyDescriptor;\n\nvar EXISTS = hasOwn(FunctionPrototype, 'name');\n// additional protection from minified / mangled / dropped function names\nvar PROPER = EXISTS && (function something() { /* empty */ }).name === 'something';\nvar CONFIGURABLE = EXISTS && (!DESCRIPTORS || (DESCRIPTORS && getDescriptor(FunctionPrototype, 'name').configurable));\n\nmodule.exports = {\n  EXISTS: EXISTS,\n  PROPER: PROPER,\n  CONFIGURABLE: CONFIGURABLE\n};\n","'use strict';\nvar NATIVE_BIND = require('../internals/function-bind-native');\n\nvar FunctionPrototype = Function.prototype;\nvar call = FunctionPrototype.call;\nvar uncurryThisWithBind = NATIVE_BIND && FunctionPrototype.bind.bind(call, call);\n\nmodule.exports = NATIVE_BIND ? uncurryThisWithBind : function (fn) {\n  return function () {\n    return call.apply(fn, arguments);\n  };\n};\n","'use strict';\nvar global = require('../internals/global');\nvar isCallable = require('../internals/is-callable');\n\nvar aFunction = function (argument) {\n  return isCallable(argument) ? argument : undefined;\n};\n\nmodule.exports = function (namespace, method) {\n  return arguments.length < 2 ? aFunction(global[namespace]) : global[namespace] && global[namespace][method];\n};\n","'use strict';\nvar aCallable = require('../internals/a-callable');\nvar isNullOrUndefined = require('../internals/is-null-or-undefined');\n\n// `GetMethod` abstract operation\n// https://tc39.es/ecma262/#sec-getmethod\nmodule.exports = function (V, P) {\n  var func = V[P];\n  return isNullOrUndefined(func) ? undefined : aCallable(func);\n};\n","'use strict';\nvar check = function (it) {\n  return it && it.Math === Math && it;\n};\n\n// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028\nmodule.exports =\n  // eslint-disable-next-line es/no-global-this -- safe\n  check(typeof globalThis == 'object' && globalThis) ||\n  check(typeof window == 'object' && window) ||\n  // eslint-disable-next-line no-restricted-globals -- safe\n  check(typeof self == 'object' && self) ||\n  check(typeof global == 'object' && global) ||\n  check(typeof this == 'object' && this) ||\n  // eslint-disable-next-line no-new-func -- fallback\n  (function () { return this; })() || Function('return this')();\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar toObject = require('../internals/to-object');\n\nvar hasOwnProperty = uncurryThis({}.hasOwnProperty);\n\n// `HasOwnProperty` abstract operation\n// https://tc39.es/ecma262/#sec-hasownproperty\n// eslint-disable-next-line es/no-object-hasown -- safe\nmodule.exports = Object.hasOwn || function hasOwn(it, key) {\n  return hasOwnProperty(toObject(it), key);\n};\n","'use strict';\nmodule.exports = {};\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar fails = require('../internals/fails');\nvar createElement = require('../internals/document-create-element');\n\n// Thanks to IE8 for its funny defineProperty\nmodule.exports = !DESCRIPTORS && !fails(function () {\n  // eslint-disable-next-line es/no-object-defineproperty -- required for testing\n  return Object.defineProperty(createElement('div'), 'a', {\n    get: function () { return 7; }\n  }).a !== 7;\n});\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar fails = require('../internals/fails');\nvar classof = require('../internals/classof-raw');\n\nvar $Object = Object;\nvar split = uncurryThis(''.split);\n\n// fallback for non-array-like ES3 and non-enumerable old V8 strings\nmodule.exports = fails(function () {\n  // throws an error in rhino, see https://github.com/mozilla/rhino/issues/346\n  // eslint-disable-next-line no-prototype-builtins -- safe\n  return !$Object('z').propertyIsEnumerable(0);\n}) ? function (it) {\n  return classof(it) === 'String' ? split(it, '') : $Object(it);\n} : $Object;\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar isCallable = require('../internals/is-callable');\nvar store = require('../internals/shared-store');\n\nvar functionToString = uncurryThis(Function.toString);\n\n// this helper broken in `core-js@3.4.1-3.4.4`, so we can't use `shared` helper\nif (!isCallable(store.inspectSource)) {\n  store.inspectSource = function (it) {\n    return functionToString(it);\n  };\n}\n\nmodule.exports = store.inspectSource;\n","'use strict';\nvar NATIVE_WEAK_MAP = require('../internals/weak-map-basic-detection');\nvar global = require('../internals/global');\nvar isObject = require('../internals/is-object');\nvar createNonEnumerableProperty = require('../internals/create-non-enumerable-property');\nvar hasOwn = require('../internals/has-own-property');\nvar shared = require('../internals/shared-store');\nvar sharedKey = require('../internals/shared-key');\nvar hiddenKeys = require('../internals/hidden-keys');\n\nvar OBJECT_ALREADY_INITIALIZED = 'Object already initialized';\nvar TypeError = global.TypeError;\nvar WeakMap = global.WeakMap;\nvar set, get, has;\n\nvar enforce = function (it) {\n  return has(it) ? get(it) : set(it, {});\n};\n\nvar getterFor = function (TYPE) {\n  return function (it) {\n    var state;\n    if (!isObject(it) || (state = get(it)).type !== TYPE) {\n      throw new TypeError('Incompatible receiver, ' + TYPE + ' required');\n    } return state;\n  };\n};\n\nif (NATIVE_WEAK_MAP || shared.state) {\n  var store = shared.state || (shared.state = new WeakMap());\n  /* eslint-disable no-self-assign -- prototype methods protection */\n  store.get = store.get;\n  store.has = store.has;\n  store.set = store.set;\n  /* eslint-enable no-self-assign -- prototype methods protection */\n  set = function (it, metadata) {\n    if (store.has(it)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);\n    metadata.facade = it;\n    store.set(it, metadata);\n    return metadata;\n  };\n  get = function (it) {\n    return store.get(it) || {};\n  };\n  has = function (it) {\n    return store.has(it);\n  };\n} else {\n  var STATE = sharedKey('state');\n  hiddenKeys[STATE] = true;\n  set = function (it, metadata) {\n    if (hasOwn(it, STATE)) throw new TypeError(OBJECT_ALREADY_INITIALIZED);\n    metadata.facade = it;\n    createNonEnumerableProperty(it, STATE, metadata);\n    return metadata;\n  };\n  get = function (it) {\n    return hasOwn(it, STATE) ? it[STATE] : {};\n  };\n  has = function (it) {\n    return hasOwn(it, STATE);\n  };\n}\n\nmodule.exports = {\n  set: set,\n  get: get,\n  has: has,\n  enforce: enforce,\n  getterFor: getterFor\n};\n","'use strict';\n// https://tc39.es/ecma262/#sec-IsHTMLDDA-internal-slot\nvar documentAll = typeof document == 'object' && document.all;\n\n// `IsCallable` abstract operation\n// https://tc39.es/ecma262/#sec-iscallable\n// eslint-disable-next-line unicorn/no-typeof-undefined -- required for testing\nmodule.exports = typeof documentAll == 'undefined' && documentAll !== undefined ? function (argument) {\n  return typeof argument == 'function' || argument === documentAll;\n} : function (argument) {\n  return typeof argument == 'function';\n};\n","'use strict';\nvar fails = require('../internals/fails');\nvar isCallable = require('../internals/is-callable');\n\nvar replacement = /#|\\.prototype\\./;\n\nvar isForced = function (feature, detection) {\n  var value = data[normalize(feature)];\n  return value === POLYFILL ? true\n    : value === NATIVE ? false\n    : isCallable(detection) ? fails(detection)\n    : !!detection;\n};\n\nvar normalize = isForced.normalize = function (string) {\n  return String(string).replace(replacement, '.').toLowerCase();\n};\n\nvar data = isForced.data = {};\nvar NATIVE = isForced.NATIVE = 'N';\nvar POLYFILL = isForced.POLYFILL = 'P';\n\nmodule.exports = isForced;\n","'use strict';\n// we can't use just `it == null` since of `document.all` special case\n// https://tc39.es/ecma262/#sec-IsHTMLDDA-internal-slot-aec\nmodule.exports = function (it) {\n  return it === null || it === undefined;\n};\n","'use strict';\nvar isCallable = require('../internals/is-callable');\n\nmodule.exports = function (it) {\n  return typeof it == 'object' ? it !== null : isCallable(it);\n};\n","'use strict';\nmodule.exports = false;\n","'use strict';\nvar getBuiltIn = require('../internals/get-built-in');\nvar isCallable = require('../internals/is-callable');\nvar isPrototypeOf = require('../internals/object-is-prototype-of');\nvar USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');\n\nvar $Object = Object;\n\nmodule.exports = USE_SYMBOL_AS_UID ? function (it) {\n  return typeof it == 'symbol';\n} : function (it) {\n  var $Symbol = getBuiltIn('Symbol');\n  return isCallable($Symbol) && isPrototypeOf($Symbol.prototype, $Object(it));\n};\n","'use strict';\nvar toLength = require('../internals/to-length');\n\n// `LengthOfArrayLike` abstract operation\n// https://tc39.es/ecma262/#sec-lengthofarraylike\nmodule.exports = function (obj) {\n  return toLength(obj.length);\n};\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar fails = require('../internals/fails');\nvar isCallable = require('../internals/is-callable');\nvar hasOwn = require('../internals/has-own-property');\nvar DESCRIPTORS = require('../internals/descriptors');\nvar CONFIGURABLE_FUNCTION_NAME = require('../internals/function-name').CONFIGURABLE;\nvar inspectSource = require('../internals/inspect-source');\nvar InternalStateModule = require('../internals/internal-state');\n\nvar enforceInternalState = InternalStateModule.enforce;\nvar getInternalState = InternalStateModule.get;\nvar $String = String;\n// eslint-disable-next-line es/no-object-defineproperty -- safe\nvar defineProperty = Object.defineProperty;\nvar stringSlice = uncurryThis(''.slice);\nvar replace = uncurryThis(''.replace);\nvar join = uncurryThis([].join);\n\nvar CONFIGURABLE_LENGTH = DESCRIPTORS && !fails(function () {\n  return defineProperty(function () { /* empty */ }, 'length', { value: 8 }).length !== 8;\n});\n\nvar TEMPLATE = String(String).split('String');\n\nvar makeBuiltIn = module.exports = function (value, name, options) {\n  if (stringSlice($String(name), 0, 7) === 'Symbol(') {\n    name = '[' + replace($String(name), /^Symbol\\(([^)]*)\\).*$/, '$1') + ']';\n  }\n  if (options && options.getter) name = 'get ' + name;\n  if (options && options.setter) name = 'set ' + name;\n  if (!hasOwn(value, 'name') || (CONFIGURABLE_FUNCTION_NAME && value.name !== name)) {\n    if (DESCRIPTORS) defineProperty(value, 'name', { value: name, configurable: true });\n    else value.name = name;\n  }\n  if (CONFIGURABLE_LENGTH && options && hasOwn(options, 'arity') && value.length !== options.arity) {\n    defineProperty(value, 'length', { value: options.arity });\n  }\n  try {\n    if (options && hasOwn(options, 'constructor') && options.constructor) {\n      if (DESCRIPTORS) defineProperty(value, 'prototype', { writable: false });\n    // in V8 ~ Chrome 53, prototypes of some methods, like `Array.prototype.values`, are non-writable\n    } else if (value.prototype) value.prototype = undefined;\n  } catch (error) { /* empty */ }\n  var state = enforceInternalState(value);\n  if (!hasOwn(state, 'source')) {\n    state.source = join(TEMPLATE, typeof name == 'string' ? name : '');\n  } return value;\n};\n\n// add fake Function#toString for correct work wrapped methods / constructors with methods like LoDash isNative\n// eslint-disable-next-line no-extend-native -- required\nFunction.prototype.toString = makeBuiltIn(function toString() {\n  return isCallable(this) && getInternalState(this).source || inspectSource(this);\n}, 'toString');\n","'use strict';\nvar ceil = Math.ceil;\nvar floor = Math.floor;\n\n// `Math.trunc` method\n// https://tc39.es/ecma262/#sec-math.trunc\n// eslint-disable-next-line es/no-math-trunc -- safe\nmodule.exports = Math.trunc || function trunc(x) {\n  var n = +x;\n  return (n > 0 ? floor : ceil)(n);\n};\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar IE8_DOM_DEFINE = require('../internals/ie8-dom-define');\nvar V8_PROTOTYPE_DEFINE_BUG = require('../internals/v8-prototype-define-bug');\nvar anObject = require('../internals/an-object');\nvar toPropertyKey = require('../internals/to-property-key');\n\nvar $TypeError = TypeError;\n// eslint-disable-next-line es/no-object-defineproperty -- safe\nvar $defineProperty = Object.defineProperty;\n// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe\nvar $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\nvar ENUMERABLE = 'enumerable';\nvar CONFIGURABLE = 'configurable';\nvar WRITABLE = 'writable';\n\n// `Object.defineProperty` method\n// https://tc39.es/ecma262/#sec-object.defineproperty\nexports.f = DESCRIPTORS ? V8_PROTOTYPE_DEFINE_BUG ? function defineProperty(O, P, Attributes) {\n  anObject(O);\n  P = toPropertyKey(P);\n  anObject(Attributes);\n  if (typeof O === 'function' && P === 'prototype' && 'value' in Attributes && WRITABLE in Attributes && !Attributes[WRITABLE]) {\n    var current = $getOwnPropertyDescriptor(O, P);\n    if (current && current[WRITABLE]) {\n      O[P] = Attributes.value;\n      Attributes = {\n        configurable: CONFIGURABLE in Attributes ? Attributes[CONFIGURABLE] : current[CONFIGURABLE],\n        enumerable: ENUMERABLE in Attributes ? Attributes[ENUMERABLE] : current[ENUMERABLE],\n        writable: false\n      };\n    }\n  } return $defineProperty(O, P, Attributes);\n} : $defineProperty : function defineProperty(O, P, Attributes) {\n  anObject(O);\n  P = toPropertyKey(P);\n  anObject(Attributes);\n  if (IE8_DOM_DEFINE) try {\n    return $defineProperty(O, P, Attributes);\n  } catch (error) { /* empty */ }\n  if ('get' in Attributes || 'set' in Attributes) throw new $TypeError('Accessors not supported');\n  if ('value' in Attributes) O[P] = Attributes.value;\n  return O;\n};\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar call = require('../internals/function-call');\nvar propertyIsEnumerableModule = require('../internals/object-property-is-enumerable');\nvar createPropertyDescriptor = require('../internals/create-property-descriptor');\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar toPropertyKey = require('../internals/to-property-key');\nvar hasOwn = require('../internals/has-own-property');\nvar IE8_DOM_DEFINE = require('../internals/ie8-dom-define');\n\n// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe\nvar $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\n\n// `Object.getOwnPropertyDescriptor` method\n// https://tc39.es/ecma262/#sec-object.getownpropertydescriptor\nexports.f = DESCRIPTORS ? $getOwnPropertyDescriptor : function getOwnPropertyDescriptor(O, P) {\n  O = toIndexedObject(O);\n  P = toPropertyKey(P);\n  if (IE8_DOM_DEFINE) try {\n    return $getOwnPropertyDescriptor(O, P);\n  } catch (error) { /* empty */ }\n  if (hasOwn(O, P)) return createPropertyDescriptor(!call(propertyIsEnumerableModule.f, O, P), O[P]);\n};\n","'use strict';\nvar internalObjectKeys = require('../internals/object-keys-internal');\nvar enumBugKeys = require('../internals/enum-bug-keys');\n\nvar hiddenKeys = enumBugKeys.concat('length', 'prototype');\n\n// `Object.getOwnPropertyNames` method\n// https://tc39.es/ecma262/#sec-object.getownpropertynames\n// eslint-disable-next-line es/no-object-getownpropertynames -- safe\nexports.f = Object.getOwnPropertyNames || function getOwnPropertyNames(O) {\n  return internalObjectKeys(O, hiddenKeys);\n};\n","'use strict';\n// eslint-disable-next-line es/no-object-getownpropertysymbols -- safe\nexports.f = Object.getOwnPropertySymbols;\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nmodule.exports = uncurryThis({}.isPrototypeOf);\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar hasOwn = require('../internals/has-own-property');\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar indexOf = require('../internals/array-includes').indexOf;\nvar hiddenKeys = require('../internals/hidden-keys');\n\nvar push = uncurryThis([].push);\n\nmodule.exports = function (object, names) {\n  var O = toIndexedObject(object);\n  var i = 0;\n  var result = [];\n  var key;\n  for (key in O) !hasOwn(hiddenKeys, key) && hasOwn(O, key) && push(result, key);\n  // Don't enum bug & hidden keys\n  while (names.length > i) if (hasOwn(O, key = names[i++])) {\n    ~indexOf(result, key) || push(result, key);\n  }\n  return result;\n};\n","'use strict';\nvar internalObjectKeys = require('../internals/object-keys-internal');\nvar enumBugKeys = require('../internals/enum-bug-keys');\n\n// `Object.keys` method\n// https://tc39.es/ecma262/#sec-object.keys\n// eslint-disable-next-line es/no-object-keys -- safe\nmodule.exports = Object.keys || function keys(O) {\n  return internalObjectKeys(O, enumBugKeys);\n};\n","'use strict';\nvar $propertyIsEnumerable = {}.propertyIsEnumerable;\n// eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe\nvar getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;\n\n// Nashorn ~ JDK8 bug\nvar NASHORN_BUG = getOwnPropertyDescriptor && !$propertyIsEnumerable.call({ 1: 2 }, 1);\n\n// `Object.prototype.propertyIsEnumerable` method implementation\n// https://tc39.es/ecma262/#sec-object.prototype.propertyisenumerable\nexports.f = NASHORN_BUG ? function propertyIsEnumerable(V) {\n  var descriptor = getOwnPropertyDescriptor(this, V);\n  return !!descriptor && descriptor.enumerable;\n} : $propertyIsEnumerable;\n","'use strict';\nvar call = require('../internals/function-call');\nvar isCallable = require('../internals/is-callable');\nvar isObject = require('../internals/is-object');\n\nvar $TypeError = TypeError;\n\n// `OrdinaryToPrimitive` abstract operation\n// https://tc39.es/ecma262/#sec-ordinarytoprimitive\nmodule.exports = function (input, pref) {\n  var fn, val;\n  if (pref === 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;\n  if (isCallable(fn = input.valueOf) && !isObject(val = call(fn, input))) return val;\n  if (pref !== 'string' && isCallable(fn = input.toString) && !isObject(val = call(fn, input))) return val;\n  throw new $TypeError(\"Can't convert object to primitive value\");\n};\n","'use strict';\nvar getBuiltIn = require('../internals/get-built-in');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar getOwnPropertyNamesModule = require('../internals/object-get-own-property-names');\nvar getOwnPropertySymbolsModule = require('../internals/object-get-own-property-symbols');\nvar anObject = require('../internals/an-object');\n\nvar concat = uncurryThis([].concat);\n\n// all object keys, includes non-enumerable and symbols\nmodule.exports = getBuiltIn('Reflect', 'ownKeys') || function ownKeys(it) {\n  var keys = getOwnPropertyNamesModule.f(anObject(it));\n  var getOwnPropertySymbols = getOwnPropertySymbolsModule.f;\n  return getOwnPropertySymbols ? concat(keys, getOwnPropertySymbols(it)) : keys;\n};\n","'use strict';\nvar global = require('../internals/global');\n\nmodule.exports = global;\n","'use strict';\nvar isNullOrUndefined = require('../internals/is-null-or-undefined');\n\nvar $TypeError = TypeError;\n\n// `RequireObjectCoercible` abstract operation\n// https://tc39.es/ecma262/#sec-requireobjectcoercible\nmodule.exports = function (it) {\n  if (isNullOrUndefined(it)) throw new $TypeError(\"Can't call method on \" + it);\n  return it;\n};\n","'use strict';\nvar shared = require('../internals/shared');\nvar uid = require('../internals/uid');\n\nvar keys = shared('keys');\n\nmodule.exports = function (key) {\n  return keys[key] || (keys[key] = uid(key));\n};\n","'use strict';\nvar IS_PURE = require('../internals/is-pure');\nvar globalThis = require('../internals/global');\nvar defineGlobalProperty = require('../internals/define-global-property');\n\nvar SHARED = '__core-js_shared__';\nvar store = module.exports = globalThis[SHARED] || defineGlobalProperty(SHARED, {});\n\n(store.versions || (store.versions = [])).push({\n  version: '3.36.1',\n  mode: IS_PURE ? 'pure' : 'global',\n  copyright: ' 2014-2024 Denis Pushkarev (zloirock.ru)',\n  license: 'https://github.com/zloirock/core-js/blob/v3.36.1/LICENSE',\n  source: 'https://github.com/zloirock/core-js'\n});\n","'use strict';\nvar store = require('../internals/shared-store');\n\nmodule.exports = function (key, value) {\n  return store[key] || (store[key] = value || {});\n};\n","'use strict';\n/* eslint-disable es/no-symbol -- required for testing */\nvar V8_VERSION = require('../internals/engine-v8-version');\nvar fails = require('../internals/fails');\nvar global = require('../internals/global');\n\nvar $String = global.String;\n\n// eslint-disable-next-line es/no-object-getownpropertysymbols -- required for testing\nmodule.exports = !!Object.getOwnPropertySymbols && !fails(function () {\n  var symbol = Symbol('symbol detection');\n  // Chrome 38 Symbol has incorrect toString conversion\n  // `get-own-property-symbols` polyfill symbols converted to object are not Symbol instances\n  // nb: Do not call `String` directly to avoid this being optimized out to `symbol+''` which will,\n  // of course, fail.\n  return !$String(symbol) || !(Object(symbol) instanceof Symbol) ||\n    // Chrome 38-40 symbols are not inherited from DOM collections prototypes to instances\n    !Symbol.sham && V8_VERSION && V8_VERSION < 41;\n});\n","'use strict';\nvar toIntegerOrInfinity = require('../internals/to-integer-or-infinity');\n\nvar max = Math.max;\nvar min = Math.min;\n\n// Helper for a popular repeating case of the spec:\n// Let integer be ? ToInteger(index).\n// If integer < 0, let result be max((length + integer), 0); else let result be min(integer, length).\nmodule.exports = function (index, length) {\n  var integer = toIntegerOrInfinity(index);\n  return integer < 0 ? max(integer + length, 0) : min(integer, length);\n};\n","'use strict';\n// toObject with fallback for non-array-like ES3 strings\nvar IndexedObject = require('../internals/indexed-object');\nvar requireObjectCoercible = require('../internals/require-object-coercible');\n\nmodule.exports = function (it) {\n  return IndexedObject(requireObjectCoercible(it));\n};\n","'use strict';\nvar trunc = require('../internals/math-trunc');\n\n// `ToIntegerOrInfinity` abstract operation\n// https://tc39.es/ecma262/#sec-tointegerorinfinity\nmodule.exports = function (argument) {\n  var number = +argument;\n  // eslint-disable-next-line no-self-compare -- NaN check\n  return number !== number || number === 0 ? 0 : trunc(number);\n};\n","'use strict';\nvar toIntegerOrInfinity = require('../internals/to-integer-or-infinity');\n\nvar min = Math.min;\n\n// `ToLength` abstract operation\n// https://tc39.es/ecma262/#sec-tolength\nmodule.exports = function (argument) {\n  var len = toIntegerOrInfinity(argument);\n  return len > 0 ? min(len, 0x1FFFFFFFFFFFFF) : 0; // 2 ** 53 - 1 == 9007199254740991\n};\n","'use strict';\nvar requireObjectCoercible = require('../internals/require-object-coercible');\n\nvar $Object = Object;\n\n// `ToObject` abstract operation\n// https://tc39.es/ecma262/#sec-toobject\nmodule.exports = function (argument) {\n  return $Object(requireObjectCoercible(argument));\n};\n","'use strict';\nvar call = require('../internals/function-call');\nvar isObject = require('../internals/is-object');\nvar isSymbol = require('../internals/is-symbol');\nvar getMethod = require('../internals/get-method');\nvar ordinaryToPrimitive = require('../internals/ordinary-to-primitive');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar $TypeError = TypeError;\nvar TO_PRIMITIVE = wellKnownSymbol('toPrimitive');\n\n// `ToPrimitive` abstract operation\n// https://tc39.es/ecma262/#sec-toprimitive\nmodule.exports = function (input, pref) {\n  if (!isObject(input) || isSymbol(input)) return input;\n  var exoticToPrim = getMethod(input, TO_PRIMITIVE);\n  var result;\n  if (exoticToPrim) {\n    if (pref === undefined) pref = 'default';\n    result = call(exoticToPrim, input, pref);\n    if (!isObject(result) || isSymbol(result)) return result;\n    throw new $TypeError(\"Can't convert object to primitive value\");\n  }\n  if (pref === undefined) pref = 'number';\n  return ordinaryToPrimitive(input, pref);\n};\n","'use strict';\nvar toPrimitive = require('../internals/to-primitive');\nvar isSymbol = require('../internals/is-symbol');\n\n// `ToPropertyKey` abstract operation\n// https://tc39.es/ecma262/#sec-topropertykey\nmodule.exports = function (argument) {\n  var key = toPrimitive(argument, 'string');\n  return isSymbol(key) ? key : key + '';\n};\n","'use strict';\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar TO_STRING_TAG = wellKnownSymbol('toStringTag');\nvar test = {};\n\ntest[TO_STRING_TAG] = 'z';\n\nmodule.exports = String(test) === '[object z]';\n","'use strict';\nvar classof = require('../internals/classof');\n\nvar $String = String;\n\nmodule.exports = function (argument) {\n  if (classof(argument) === 'Symbol') throw new TypeError('Cannot convert a Symbol value to a string');\n  return $String(argument);\n};\n","'use strict';\nvar $String = String;\n\nmodule.exports = function (argument) {\n  try {\n    return $String(argument);\n  } catch (error) {\n    return 'Object';\n  }\n};\n","'use strict';\nvar uncurryThis = require('../internals/function-uncurry-this');\n\nvar id = 0;\nvar postfix = Math.random();\nvar toString = uncurryThis(1.0.toString);\n\nmodule.exports = function (key) {\n  return 'Symbol(' + (key === undefined ? '' : key) + ')_' + toString(++id + postfix, 36);\n};\n","'use strict';\n/* eslint-disable es/no-symbol -- required for testing */\nvar NATIVE_SYMBOL = require('../internals/symbol-constructor-detection');\n\nmodule.exports = NATIVE_SYMBOL\n  && !Symbol.sham\n  && typeof Symbol.iterator == 'symbol';\n","'use strict';\nvar DESCRIPTORS = require('../internals/descriptors');\nvar fails = require('../internals/fails');\n\n// V8 ~ Chrome 36-\n// https://bugs.chromium.org/p/v8/issues/detail?id=3334\nmodule.exports = DESCRIPTORS && fails(function () {\n  // eslint-disable-next-line es/no-object-defineproperty -- required for testing\n  return Object.defineProperty(function () { /* empty */ }, 'prototype', {\n    value: 42,\n    writable: false\n  }).prototype !== 42;\n});\n","'use strict';\nvar global = require('../internals/global');\nvar isCallable = require('../internals/is-callable');\n\nvar WeakMap = global.WeakMap;\n\nmodule.exports = isCallable(WeakMap) && /native code/.test(String(WeakMap));\n","'use strict';\nvar global = require('../internals/global');\nvar shared = require('../internals/shared');\nvar hasOwn = require('../internals/has-own-property');\nvar uid = require('../internals/uid');\nvar NATIVE_SYMBOL = require('../internals/symbol-constructor-detection');\nvar USE_SYMBOL_AS_UID = require('../internals/use-symbol-as-uid');\n\nvar Symbol = global.Symbol;\nvar WellKnownSymbolsStore = shared('wks');\nvar createWellKnownSymbol = USE_SYMBOL_AS_UID ? Symbol['for'] || Symbol : Symbol && Symbol.withoutSetter || uid;\n\nmodule.exports = function (name) {\n  if (!hasOwn(WellKnownSymbolsStore, name)) {\n    WellKnownSymbolsStore[name] = NATIVE_SYMBOL && hasOwn(Symbol, name)\n      ? Symbol[name]\n      : createWellKnownSymbol('Symbol.' + name);\n  } return WellKnownSymbolsStore[name];\n};\n","'use strict';\nvar $ = require('../internals/export');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar aCallable = require('../internals/a-callable');\nvar toObject = require('../internals/to-object');\nvar lengthOfArrayLike = require('../internals/length-of-array-like');\nvar deletePropertyOrThrow = require('../internals/delete-property-or-throw');\nvar toString = require('../internals/to-string');\nvar fails = require('../internals/fails');\nvar internalSort = require('../internals/array-sort');\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar FF = require('../internals/engine-ff-version');\nvar IE_OR_EDGE = require('../internals/engine-is-ie-or-edge');\nvar V8 = require('../internals/engine-v8-version');\nvar WEBKIT = require('../internals/engine-webkit-version');\n\nvar test = [];\nvar nativeSort = uncurryThis(test.sort);\nvar push = uncurryThis(test.push);\n\n// IE8-\nvar FAILS_ON_UNDEFINED = fails(function () {\n  test.sort(undefined);\n});\n// V8 bug\nvar FAILS_ON_NULL = fails(function () {\n  test.sort(null);\n});\n// Old WebKit\nvar STRICT_METHOD = arrayMethodIsStrict('sort');\n\nvar STABLE_SORT = !fails(function () {\n  // feature detection can be too slow, so check engines versions\n  if (V8) return V8 < 70;\n  if (FF && FF > 3) return;\n  if (IE_OR_EDGE) return true;\n  if (WEBKIT) return WEBKIT < 603;\n\n  var result = '';\n  var code, chr, value, index;\n\n  // generate an array with more 512 elements (Chakra and old V8 fails only in this case)\n  for (code = 65; code < 76; code++) {\n    chr = String.fromCharCode(code);\n\n    switch (code) {\n      case 66: case 69: case 70: case 72: value = 3; break;\n      case 68: case 71: value = 4; break;\n      default: value = 2;\n    }\n\n    for (index = 0; index < 47; index++) {\n      test.push({ k: chr + index, v: value });\n    }\n  }\n\n  test.sort(function (a, b) { return b.v - a.v; });\n\n  for (index = 0; index < test.length; index++) {\n    chr = test[index].k.charAt(0);\n    if (result.charAt(result.length - 1) !== chr) result += chr;\n  }\n\n  return result !== 'DGBEFHACIJK';\n});\n\nvar FORCED = FAILS_ON_UNDEFINED || !FAILS_ON_NULL || !STRICT_METHOD || !STABLE_SORT;\n\nvar getSortCompare = function (comparefn) {\n  return function (x, y) {\n    if (y === undefined) return -1;\n    if (x === undefined) return 1;\n    if (comparefn !== undefined) return +comparefn(x, y) || 0;\n    return toString(x) > toString(y) ? 1 : -1;\n  };\n};\n\n// `Array.prototype.sort` method\n// https://tc39.es/ecma262/#sec-array.prototype.sort\n$({ target: 'Array', proto: true, forced: FORCED }, {\n  sort: function sort(comparefn) {\n    if (comparefn !== undefined) aCallable(comparefn);\n\n    var array = toObject(this);\n\n    if (STABLE_SORT) return comparefn === undefined ? nativeSort(array) : nativeSort(array, comparefn);\n\n    var items = [];\n    var arrayLength = lengthOfArrayLike(array);\n    var itemsLength, index;\n\n    for (index = 0; index < arrayLength; index++) {\n      if (index in array) push(items, array[index]);\n    }\n\n    internalSort(items, getSortCompare(comparefn));\n\n    itemsLength = lengthOfArrayLike(items);\n    index = 0;\n\n    while (index < itemsLength) array[index] = items[index++];\n    while (index < arrayLength) deletePropertyOrThrow(array, index++);\n\n    return array;\n  }\n});\n","'use strict';\nvar $ = require('../internals/export');\nvar toObject = require('../internals/to-object');\nvar nativeKeys = require('../internals/object-keys');\nvar fails = require('../internals/fails');\n\nvar FAILS_ON_PRIMITIVES = fails(function () { nativeKeys(1); });\n\n// `Object.keys` method\n// https://tc39.es/ecma262/#sec-object.keys\n$({ target: 'Object', stat: true, forced: FAILS_ON_PRIMITIVES }, {\n  keys: function keys(it) {\n    return nativeKeys(toObject(it));\n  }\n});\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\tid: moduleId,\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\n * Determines the scope of handling mouse/touch events.\n */\n\nexport enum PointerScope {\n  /**\n   * Handle events on the `canvas` element only. Events originating outside the\n   * `canvas` will not be handled.\n   */\n  Canvas = 'Canvas',\n\n  /**\n   * Handles events on the entire document. All events will be handled by Excalibur.\n   */\n  Document = 'Document'\n}\n","import 'core-js/es/array/sort';\nimport 'core-js/es/object/keys';\n\n/**\n * Polyfill adding function\n */\nexport function polyfill() {\n  /* istanbul ignore next */\n  if (typeof window === 'undefined') {\n    window = <any>{\n      audioContext: function () {\n        return;\n      }\n    };\n  }\n  /* istanbul ignore next */\n  if (typeof window !== 'undefined' && !window.requestAnimationFrame) {\n    (<any>window).requestAnimationFrame =\n      (<any>window).webkitRequestAnimationFrame ||\n      (<any>window).mozRequestAnimationFrame ||\n      function (callback: Function) {\n        window.setInterval(callback, 1000 / 60);\n      };\n  }\n  /* istanbul ignore next */\n  if (typeof window !== 'undefined' && !window.cancelAnimationFrame) {\n    (<any>window).cancelAnimationFrame =\n      (<any>window).webkitCancelAnimationFrame ||\n      (<any>window).mozCancelAnimationFrame ||\n      function () {\n        return;\n      };\n  }\n  /* istanbul ignore next */\n  if (typeof window !== 'undefined' && !(<any>window).AudioContext) {\n    if ((<any>window).webkitAudioContext) {\n      const ctx = (<any>window).webkitAudioContext;\n      const replaceMe = ctx.prototype.decodeAudioData;\n      (<any>window).webkitAudioContext.prototype.decodeAudioData = function (arrayBuffer: ArrayBuffer) {\n        return new Promise((resolve, reject) => {\n          replaceMe.call(this, arrayBuffer, resolve, reject);\n        });\n      };\n    }\n\n    (<any>window).AudioContext =\n      (<any>window).AudioContext ||\n      (<any>window).webkitAudioContext ||\n      (<any>window).mozAudioContext ||\n      (<any>window).msAudioContext ||\n      (<any>window).oAudioContext;\n  }\n\n  /* istanbul ignore next */\n  if (typeof window !== 'undefined' && !(<any>window).devicePixelRatio) {\n    (<any>window).devicePixelRatio = window.devicePixelRatio || 1;\n  }\n}\n","\r\n/**\r\n * Flags is a feature flag implementation for Excalibur. They can only be operated **before [[Engine]] construction**\r\n * after which they are frozen and are read-only.\r\n *\r\n * Flags are used to enable experimental or preview features in Excalibur.\r\n */\r\nexport class Flags {\r\n  private static _FROZEN = false;\r\n  private static _FLAGS: Record<string, boolean> = {};\r\n\r\n\r\n  /**\r\n   * Force excalibur to load the Canvas 2D graphics context fallback\r\n   * @warning not all features of excalibur are supported in the Canvas 2D fallback\r\n   */\r\n  public static useCanvasGraphicsContext() {\r\n    Flags.enable('use-canvas-context');\r\n  }\r\n\r\n  /**\r\n   * Freeze all flag modifications making them readonly\r\n   */\r\n  public static freeze() {\r\n    Flags._FROZEN = true;\r\n  }\r\n\r\n  /**\r\n   * Resets internal flag state, not meant to be called by users. Only used for testing.\r\n   *\r\n   * Calling this in your game is UNSUPPORTED\r\n   * @internal\r\n   */\r\n  public static _reset() {\r\n    Flags._FROZEN = false;\r\n    Flags._FLAGS = {};\r\n  }\r\n  /**\r\n   * Enable a specific feature flag by name. **Note: can only be set before [[Engine]] constructor time**\r\n   * @param flagName\r\n   */\r\n  public static enable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be enabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = true;\r\n  }\r\n\r\n  /**\r\n   * Disable a specific feature flag by name. **Note: can only be set before [[Engine]] constructor time**\r\n   * @param flagName\r\n   */\r\n  public static disable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be disabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = false;\r\n  }\r\n\r\n  /**\r\n   * Check if a flag is enabled. If the flag is disabled or does not exist `false` is returned\r\n   * @param flagName\r\n   */\r\n  public static isEnabled(flagName: string): boolean {\r\n    return !!Flags._FLAGS[flagName];\r\n  }\r\n\r\n  /**\r\n   * Show a list of currently known flags\r\n   */\r\n  public static show(): string[] {\r\n    return Object.keys(Flags._FLAGS);\r\n  }\r\n}\r\n","export type Id<T extends string> = {\r\n  type: T,\r\n  value: number\r\n};\r\n\r\n/**\r\n * Create a branded ID type from a number\r\n */\r\nexport function createId<T extends string>(type: T, value: number): Id<T> {\r\n  return { type, value };\r\n};\r\n","\r\n/**\r\n * Future is a wrapper around a native browser Promise to allow resolving/rejecting at any time\r\n */\r\nexport class Future<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _resolver: (value: T) => void;\r\n  private _rejecter: (error: Error) => void;\r\n  private _isCompleted: boolean = false;\r\n\r\n  constructor() {\r\n    this.promise = new Promise((resolve, reject) => {\r\n      this._resolver = resolve;\r\n      this._rejecter = reject;\r\n    });\r\n  }\r\n\r\n  public readonly promise: Promise<T>;\r\n\r\n  public get isCompleted(): boolean {\r\n    return this._isCompleted;\r\n  }\r\n\r\n  public resolve(value: T): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._resolver(value);\r\n  }\r\n\r\n  public reject(error: Error): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._rejecter(error);\r\n  }\r\n}","export type EventMap = Record<string, any>;\r\nexport type EventKey<T extends EventMap> = string & keyof T;\r\nexport type Handler<EventType> = (event: EventType) => void;\r\n\r\n/**\r\n * Interface that represents a handle to a subscription that can be closed\r\n */\r\nexport interface Subscription {\r\n  close(): void;\r\n}\r\n\r\n/**\r\n * Excalibur's typed event emitter, this allows events to be sent with any string to Type mapping\r\n */\r\nexport class EventEmitter<TEventMap extends EventMap = any> {\r\n  private _paused = false;\r\n  private _listeners: Record<string, Handler<any>[]> = {};\r\n  private _listenersOnce: Record<string, Handler<any>[]> = {};\r\n  private _pipes: EventEmitter<any>[] = [];\r\n\r\n  clear() {\r\n    this._listeners = {};\r\n    this._listenersOnce = {};\r\n    this._pipes.length = 0;\r\n  }\r\n\r\n  on<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription;\r\n  on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  on<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription {\r\n    this._listeners[eventName] = this._listeners[eventName] ?? [];\r\n    this._listeners[eventName].push(handler);\r\n    return {\r\n      close: () => this.off(eventName, handler)\r\n    };\r\n  }\r\n\r\n  once<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription;\r\n  once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  once<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription {\r\n    this._listenersOnce[eventName] = this._listenersOnce[eventName] ?? [];\r\n    this._listenersOnce[eventName].push(handler);\r\n    return {\r\n      close: () => this.off(eventName, handler)\r\n    };\r\n  }\r\n\r\n  off<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): void;\r\n  off(eventName: string, handler: Handler<unknown>): void;\r\n  off(eventName: string): void;\r\n  off<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler?: Handler<TEventMap[TEventName]>): void {\r\n    if (handler) {\r\n      const newListeners = this._listeners[eventName]?.filter(h => h !== handler);\r\n      this._listeners[eventName] = newListeners;\r\n\r\n      const newOnceListeners = this._listenersOnce[eventName]?.filter(h => h !== handler);\r\n      this._listenersOnce[eventName] = newOnceListeners;\r\n    } else {\r\n      delete this._listeners[eventName];\r\n    }\r\n  }\r\n\r\n  emit<TEventName extends EventKey<TEventMap>>(eventName: TEventName, event: TEventMap[TEventName]): void;\r\n  emit(eventName: string, event?: any): void;\r\n  emit<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, event?: TEventMap[TEventName]): void {\r\n    if (this._paused) {\r\n      return;\r\n    }\r\n    this._listeners[eventName]?.forEach((fn) => fn(event));\r\n    const onces = this._listenersOnce[eventName];\r\n    this._listenersOnce[eventName] = [];\r\n    if (onces) {\r\n      onces.forEach((fn) => fn(event));\r\n    }\r\n    this._pipes.forEach((pipe) => {\r\n      pipe.emit(eventName, event);\r\n    });\r\n  }\r\n\r\n  pipe(emitter: EventEmitter<any>): Subscription {\r\n    if (this === emitter) {\r\n      throw Error('Cannot pipe to self');\r\n    }\r\n    this._pipes.push(emitter);\r\n    return {\r\n      close: () => {\r\n        const i = this._pipes.indexOf(emitter);\r\n        if (i > -1) {\r\n          this._pipes.splice(i, 1);\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  unpipe(emitter: EventEmitter<any>): void {\r\n    const i = this._pipes.indexOf(emitter);\r\n    if (i > -1) {\r\n      this._pipes.splice(i, 1);\r\n    }\r\n  }\r\n\r\n  pause(): void {\r\n    this._paused = true;\r\n  }\r\n\r\n  unpause(): void {\r\n    this._paused = false;\r\n  }\r\n}","/**\n * @module\n * Pseudo-Random Utility\n *\n * A pseudo-random utility to add seeded random support for help in\n * generating things like terrain or reproducible randomness. Uses the\n * [Mersenne Twister](https://en.wikipedia.org/wiki/Mersenne_Twister) algorithm.\n */\n\n/**\n * 32-bit mask\n */\nconst BITMASK32: number = 0xffffffff;\n\n/**\n * Pseudo-random number generator following the Mersenne_Twister algorithm. Given a seed this generator will produce the same sequence\n * of numbers each time it is called.\n * See https://en.wikipedia.org/wiki/Mersenne_Twister for more details.\n * Uses the MT19937-32 (2002) implementation documented here http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/emt19937ar.html\n *\n * Api inspired by http://chancejs.com/# https://github.com/chancejs/chancejs\n */\nexport class Random {\n  // Separation point of one one word, the number of bits in the lower bitmask 0 <= r <= w-1\n  private _lowerMask: number = 0x7fffffff; // 31 bits same as _r\n  private _upperMask: number = 0x80000000; // 34 high bits\n\n  // Word size, 64 bits\n  private _w: number = 32;\n\n  // Degree of recurrence\n  private _n: number = 624;\n\n  // Middle word, an offset used in the recurrence defining the series x, 1<=m<n\n  private _m: number = 397;\n  // coefficients of teh rational normal form twist matrix\n  private _a: number = 0x9908b0df;\n\n  // tempering bit shifts and masks\n  private _u: number = 11;\n  private _s: number = 7;\n  private _b: number = 0x9d2c5680;\n  private _t: number = 15;\n  private _c: number = 0xefc60000;\n  private _l: number = 18;\n  private _f: number = 1812433253;\n\n  private _mt: number[];\n\n  private _index: number;\n\n  /**\n   * If no seed is specified, the Date.now() is used\n   */\n  constructor(public seed?: number) {\n    this._mt = new Array<number>(this._n);\n    // need to mask to support higher bit machines\n    this._mt[0] = (seed || Date.now()) >>> 0;\n\n    for (let i = 1; i < this._n; i++) {\n      const s = this._mt[i - 1] ^ (this._mt[i - 1] >>> (this._w - 2));\n      // numbers are bigger than the JS max safe int, add in 16-bit chunks to prevent IEEE rounding errors on high bits\n      this._mt[i] = (((this._f * ((s & 0xffff0000) >>> 16)) << 16) + this._f * (s & 0xffff) + i) >>> 0;\n    }\n    this._index = this._n;\n  }\n\n  /**\n   * Apply the twist\n   */\n  private _twist(): void {\n    const mag01 = [0x0, this._a];\n    let y = 0,\n      i = 0;\n    for (; i < this._n - this._m; i++) {\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\n      this._mt[i] = this._mt[i + this._m] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\n    }\n    for (; i < this._n - 1; i++) {\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\n      this._mt[i] = this._mt[i + (this._m - this._n)] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\n    }\n    y = (this._mt[this._n - 1] & this._upperMask) | (this._mt[0] & this._lowerMask);\n    this._mt[this._n - 1] = this._mt[this._m - 1] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\n\n    this._index = 0;\n  }\n\n  /**\n   * Return next 32 bit integer number in sequence\n   */\n  public nextInt(): number {\n    if (this._index >= this._n) {\n      this._twist();\n    }\n\n    let y = this._mt[this._index++];\n\n    y ^= y >>> this._u;\n    y ^= (y << this._s) & this._b;\n    y ^= (y << this._t) & this._c;\n    y ^= y >>> this._l;\n\n    return y >>> 0;\n  }\n\n  /**\n   * Return a random floating point number between [0, 1)\n   */\n  public next(): number {\n    return this.nextInt() * (1.0 / 4294967296.0); // divided by 2^32\n  }\n\n  /**\n   * Return a random floating point in range [min, max) min is included, max is not included\n   */\n  public floating(min: number, max: number): number {\n    return (max - min) * this.next() + min;\n  }\n\n  /**\n   * Return a random integer in range [min, max] min is included, max is included.\n   * Implemented with rejection sampling, see https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d#.i13tdiu5a\n   */\n  public integer(min: number, max: number): number {\n    return Math.floor((max - min + 1) * this.next() + min);\n  }\n\n  /**\n   * Returns true or false randomly with 50/50 odds by default.\n   * By default the likelihood of returning a true is .5 (50%).\n   * @param likelihood takes values between [0, 1]\n   */\n  public bool(likelihood: number = 0.5): boolean {\n    return this.next() <= likelihood;\n  }\n\n  /**\n   * Returns one element from an array at random\n   */\n  public pickOne<T>(array: Array<T>): T {\n    return array[this.integer(0, array.length - 1)];\n  }\n\n  /**\n   * Returns a new array random picking elements from the original\n   * @param array Original array to pick from\n   * @param numPicks can be any positive number\n   * @param allowDuplicates indicates whether the returned set is allowed duplicates (it does not mean there will always be duplicates\n   * just that it is possible)\n   */\n  public pickSet<T>(array: Array<T>, numPicks: number, allowDuplicates: boolean = false): Array<T> {\n    if (allowDuplicates) {\n      return this._pickSetWithDuplicates(array, numPicks);\n    } else {\n      return this._pickSetWithoutDuplicates(array, numPicks);\n    }\n  }\n\n  /**\n   * Returns a new array randomly picking elements in the original (not reused)\n   * @param array Array to pick elements out of\n   * @param numPicks must be less than or equal to the number of elements in the array.\n   */\n  private _pickSetWithoutDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\n    if (numPicks > array.length || numPicks < 0) {\n      throw new Error('Invalid number of elements to pick, must pick a value 0 < n <= length');\n    }\n    if (numPicks === array.length) {\n      return array;\n    }\n\n    const result: Array<T> = new Array<T>(numPicks);\n    let currentPick = 0;\n    const tempArray = array.slice(0);\n    while (currentPick < numPicks) {\n      const index = this.integer(0, tempArray.length - 1);\n      result[currentPick++] = tempArray[index];\n      tempArray.splice(index, 1);\n    }\n\n    return result;\n  }\n\n  /**\n   * Returns a new array random picking elements from the original allowing duplicates\n   * @param array Array to pick elements out of\n   * @param numPicks can be any positive number\n   */\n  private _pickSetWithDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\n    // Typescript numbers are all floating point, so do we add check for int? (or floor the input?)\n    if (numPicks < 0) {\n      throw new Error('Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT');\n    }\n    const result = new Array<T>(numPicks);\n    for (let i = 0; i < numPicks; i++) {\n      result[i] = this.pickOne(array);\n    }\n    return result;\n  }\n\n  /**\n   * Returns a new array that has its elements shuffled. Using the Fisher/Yates method\n   * https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle\n   */\n  public shuffle<T>(array: Array<T>): Array<T> {\n    const tempArray = array.slice(0);\n    let swap: T = null;\n    for (let i = 0; i < tempArray.length - 2; i++) {\n      const randomIndex = this.integer(i, tempArray.length - 1);\n      swap = tempArray[i];\n      tempArray[i] = tempArray[randomIndex];\n      tempArray[randomIndex] = swap;\n    }\n\n    return tempArray;\n  }\n\n  /**\n   * Generate a list of random integer numbers\n   * @param length the length of the final array\n   * @param min the minimum integer number to generate inclusive\n   * @param max the maximum integer number to generate inclusive\n   */\n  public range(length: number, min: number, max: number): Array<number> {\n    const result: Array<number> = new Array(length);\n    for (let i = 0; i < length; i++) {\n      result[i] = this.integer(min, max);\n    }\n    return result;\n  }\n\n  /**\n   * Returns the result of a d4 dice roll\n   */\n  public d4() {\n    return this.integer(1, 4);\n  }\n\n  /**\n   * Returns the result of a d6 dice roll\n   */\n  public d6() {\n    return this.integer(1, 6);\n  }\n\n  /**\n   * Returns the result of a d8 dice roll\n   */\n  public d8() {\n    return this.integer(1, 8);\n  }\n\n  /**\n   * Returns the result of a d10 dice roll\n   */\n  public d10() {\n    return this.integer(1, 10);\n  }\n\n  /**\n   * Returns the result of a d12 dice roll\n   */\n  public d12() {\n    return this.integer(1, 12);\n  }\n\n  /**\n   * Returns the result of a d20 dice roll\n   */\n  public d20() {\n    return this.integer(1, 20);\n  }\n}\n","import { Random } from './Random';\r\n\r\n/**\r\n * Two PI constant\r\n */\r\nexport const TwoPI: number = Math.PI * 2;\r\n\r\n/**\r\n * Returns the fractional part of a number\r\n * @param x\r\n */\r\nexport function frac(x: number): number {\r\n  if (x >= 0) {\r\n    return x - Math.floor(x);\r\n  } else {\r\n    return x - Math.ceil(x);\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the sign of a number, if 0 returns 0\r\n */\r\nexport function sign(val: number): number {\r\n  if (val === 0) {\r\n    return 0;\r\n  }\r\n  return val < 0 ? -1 : 1;\r\n};\r\n\r\n/**\r\n * Clamps a value between a min and max inclusive\r\n */\r\nexport function clamp(val: number, min: number, max: number) {\r\n  return Math.min(Math.max(min, val), max);\r\n}\r\n\r\n\r\n/**\r\n * Convert an angle to be the equivalent in the range [0, 2PI]\r\n */\r\nexport function canonicalizeAngle(angle: number): number {\r\n  let tmpAngle = angle;\r\n  if (angle > TwoPI) {\r\n    while (tmpAngle > TwoPI) {\r\n      tmpAngle -= TwoPI;\r\n    }\r\n  }\r\n\r\n  if (angle < 0) {\r\n    while (tmpAngle < 0) {\r\n      tmpAngle += TwoPI;\r\n    }\r\n  }\r\n  return tmpAngle;\r\n}\r\n\r\n/**\r\n * Convert radians to degrees\r\n */\r\nexport function toDegrees(radians: number): number {\r\n  return (180 / Math.PI) * radians;\r\n}\r\n\r\n/**\r\n * Convert degrees to radians\r\n */\r\nexport function toRadians(degrees: number): number {\r\n  return (degrees / 180) * Math.PI;\r\n}\r\n\r\n/**\r\n * Generate a range of numbers\r\n * For example: range(0, 5) -> [0, 1, 2, 3, 4, 5]\r\n * @param from inclusive\r\n * @param to inclusive\r\n */\r\nexport const range = (from: number, to: number) => Array.from(new Array(to - from + 1), (_x, i) => i + from);\r\n\r\n/**\r\n * Find a random floating point number in range\r\n */\r\nexport function randomInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.floating(min, max) : min + Math.random() * (max - min);\r\n}\r\n\r\n/**\r\n * Find a random integer in a range\r\n */\r\nexport function randomIntInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.integer(min, max) : Math.round(randomInRange(min, max));\r\n}","import { Clonable } from '../Interfaces/Clonable';\r\nimport { canonicalizeAngle, clamp } from './util';\r\n\r\n/**\r\n * A 2D vector on a plane.\r\n */\r\n\r\nexport class Vector implements Clonable<Vector> {\r\n  /**\r\n   * Get or set the vector equals epsilon, by default 0.001 meaning vectors within that tolerance on x or y will be considered equal.\r\n   */\r\n  public static EQUALS_EPSILON = .001;\r\n  /**\r\n   * A (0, 0) vector\r\n   */\r\n  public static get Zero() {\r\n    return new Vector(0, 0);\r\n  }\r\n\r\n  /**\r\n   * A (1, 1) vector\r\n   */\r\n  public static get One() {\r\n    return new Vector(1, 1);\r\n  }\r\n\r\n  /**\r\n   * A (0.5, 0.5) vector\r\n   */\r\n  public static get Half() {\r\n    return new Vector(0.5, 0.5);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing up (0, -1)\r\n   */\r\n  public static get Up() {\r\n    return new Vector(0, -1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing down (0, 1)\r\n   */\r\n  public static get Down() {\r\n    return new Vector(0, 1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing left (-1, 0)\r\n   */\r\n  public static get Left() {\r\n    return new Vector(-1, 0);\r\n  }\r\n  /**\r\n   * A unit vector pointing right (1, 0)\r\n   */\r\n  public static get Right() {\r\n    return new Vector(1, 0);\r\n  }\r\n\r\n  /**\r\n   * Returns a vector of unit length in the direction of the specified angle in Radians.\r\n   * @param angle The angle to generate the vector\r\n   */\r\n  public static fromAngle(angle: number) {\r\n    return new Vector(Math.cos(angle), Math.sin(angle));\r\n  }\r\n\r\n  /**\r\n   * Checks if vector is not null, undefined, or if any of its components are NaN or Infinity.\r\n   */\r\n  public static isValid(vec: Vector) {\r\n    if (vec === null || vec === undefined) {\r\n      return false;\r\n    }\r\n    if (isNaN(vec.x) || isNaN(vec.y)) {\r\n      return false;\r\n    }\r\n\r\n    if (vec.x === Infinity || vec.y === Infinity || vec.x === -Infinity || vec.y === -Infinity) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Calculates distance between two Vectors\r\n   * @param vec1\r\n   * @param vec2\r\n   */\r\n  public static distance(vec1: Vector, vec2: Vector) {\r\n    return Math.sqrt(Math.pow(vec1.x - vec2.x, 2) + Math.pow(vec1.y - vec2.y, 2));\r\n  }\r\n\r\n  public static min(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.min(vec1.x, vec2.x), Math.min(vec1.y, vec2.y));\r\n  }\r\n\r\n  public static max(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.max(vec1.x, vec2.x), Math.max(vec1.y, vec2.y));\r\n  }\r\n\r\n  /**\r\n   * @param x  X component of the Vector\r\n   * @param y  Y component of the Vector\r\n   */\r\n  constructor(x: number, y: number) {\r\n    this._x = x;\r\n    this._y = y;\r\n  }\r\n\r\n  protected _x = 0;\r\n  /**\r\n   * Get the x component of the vector\r\n   */\r\n  public get x(): number {\r\n    return this._x;\r\n  }\r\n\r\n  /**\r\n   * Set the x component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set x(val: number) {\r\n    this._x = val;\r\n  }\r\n\r\n  protected _y = 0;\r\n  /**\r\n   * Get the y component of the vector\r\n   */\r\n  public get y(): number {\r\n    return this._y;\r\n  }\r\n\r\n  /**\r\n   * Set the y component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set y(val: number) {\r\n    this._y = val;\r\n  }\r\n\r\n  /**\r\n   * Sets the x and y components at once, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  setTo(x: number, y: number) {\r\n    (this.x as number) = x;\r\n    (this.y as number) = y;\r\n  }\r\n\r\n  /**\r\n   * Compares this point against another and tests for equality\r\n   * @param vector The other point to compare to\r\n   * @param tolerance Amount of euclidean distance off we are willing to tolerate\r\n   */\r\n  public equals(vector: Vector, tolerance: number = Vector.EQUALS_EPSILON): boolean {\r\n    return Math.abs(this.x - vector.x) <= tolerance && Math.abs(this.y - vector.y) <= tolerance;\r\n  }\r\n\r\n  /**\r\n   * The distance to another vector. If no other Vector is specified, this will return the [[magnitude]].\r\n   * @param v  The other vector. Leave blank to use origin vector.\r\n   */\r\n  public distance(v?: Vector): number {\r\n    if (!v) {\r\n      return Math.sqrt(this.x * this.x + this.y * this.y);\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\r\n  }\r\n\r\n  public squareDistance(v?: Vector): number {\r\n    if (!v) {\r\n      v = Vector.Zero;\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return deltaX * deltaX + deltaY * deltaY;\r\n  }\r\n\r\n  /**\r\n   * Clamps the current vector's magnitude mutating it\r\n   * @param magnitude\r\n   */\r\n  public clampMagnitude(magnitude: number): Vector {\r\n    const size = this.size;\r\n    const newSize = clamp(size, 0, magnitude);\r\n    this.size = newSize;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * The size (magnitude) of the Vector\r\n   */\r\n  public get size(): number {\r\n    return this.distance();\r\n  }\r\n\r\n  /**\r\n   * Setting the size mutates the current vector\r\n   * @warning Can be used to set the size of the vector, **be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  public set size(newLength: number) {\r\n    const v = this.normalize().scale(newLength);\r\n    this.setTo(v.x, v.y);\r\n  }\r\n\r\n  /**\r\n   * Normalizes a vector to have a magnitude of 1.\r\n   */\r\n  public normalize(): Vector {\r\n    const d = this.distance();\r\n    if (d > 0) {\r\n      return new Vector(this.x / d, this.y / d);\r\n    } else {\r\n      return new Vector(0, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the average (midpoint) between the current point and the specified\r\n   */\r\n  public average(vec: Vector): Vector {\r\n    return this.add(vec).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Scales a vector's by a factor of size\r\n   * @param size  The factor to scale the magnitude by\r\n   * @param dest  Optionally provide a destination vector for the result\r\n   */\r\n  public scale(scale: Vector, dest?: Vector): Vector;\r\n  public scale(size: number, dest?: Vector): Vector;\r\n  public scale(sizeOrScale: number | Vector, dest?: Vector): Vector {\r\n    const result = dest || new Vector(0, 0);\r\n    if (sizeOrScale instanceof Vector) {\r\n      result.x = this.x * sizeOrScale.x;\r\n      result.y = this.y * sizeOrScale.y;\r\n    } else {\r\n      result.x = this.x * sizeOrScale;\r\n      result.y = this.y * sizeOrScale;\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to another\r\n   * @param v The vector to add\r\n   * @param dest Optionally copy the result into a provided vector\r\n   */\r\n  public add(v: Vector, dest?: Vector): Vector {\r\n    if (dest) {\r\n      dest.x = this.x + v.x;\r\n      dest.y = this.y + v.y;\r\n      return dest;\r\n    }\r\n    return new Vector(this.x + v.x, this.y + v.y);\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from another, if you subtract vector `B.sub(A)` the resulting vector points from A -> B\r\n   * @param v The vector to subtract\r\n   */\r\n  public sub(v: Vector): Vector {\r\n    return new Vector(this.x - v.x, this.y - v.y);\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to this one modifying the original\r\n   * @param v The vector to add\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public addEqual(v: Vector): Vector {\r\n    this.setTo(this.x + v.x, this.y + v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from this one modifying the original\r\n   * @param v The vector to subtract\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public subEqual(v: Vector): Vector {\r\n    this.setTo(this.x - v.x, this.y - v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Scales this vector by a factor of size and modifies the original\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public scaleEqual(size: number): Vector {\r\n    this.setTo(this.x * size, this.y * size);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Performs a dot product with another vector\r\n   * @param v  The vector to dot\r\n   */\r\n  public dot(v: Vector): number {\r\n    return this.x * v.x + this.y * v.y;\r\n  }\r\n\r\n  /**\r\n   * Performs a 2D cross product with scalar. 2D cross products with a scalar return a vector.\r\n   * @param v  The scalar to cross\r\n   */\r\n  public cross(v: number): Vector;\r\n  /**\r\n   * Performs a 2D cross product with another vector. 2D cross products return a scalar value not a vector.\r\n   * @param v  The vector to cross\r\n   */\r\n  public cross(v: Vector): number;\r\n  public cross(v: any): any {\r\n    if (v instanceof Vector) {\r\n      return this.x * v.y - this.y * v.x;\r\n    } else if (typeof v === 'number') {\r\n      return new Vector(v * this.y, -v * this.x);\r\n    }\r\n  }\r\n\r\n  static cross(num: number, vec: Vector): Vector {\r\n    return new Vector(-num * vec.y, num * vec.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the perpendicular vector to this one\r\n   */\r\n  public perpendicular(): Vector {\r\n    return new Vector(this.y, -this.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the normal vector to this one, same as the perpendicular of length 1\r\n   */\r\n  public normal(): Vector {\r\n    return this.perpendicular().normalize();\r\n  }\r\n\r\n  /**\r\n   * Negate the current vector\r\n   */\r\n  public negate(): Vector {\r\n    return this.scale(-1);\r\n  }\r\n\r\n  /**\r\n   * Returns the angle of this vector.\r\n   */\r\n  public toAngle(): number {\r\n    return canonicalizeAngle(Math.atan2(this.y, this.x));\r\n  }\r\n\r\n  /**\r\n   * Rotates the current vector around a point by a certain angle in radians.\r\n   */\r\n  public rotate(angle: number, anchor?: Vector): Vector {\r\n    if (!anchor) {\r\n      anchor = new Vector(0, 0);\r\n    }\r\n    const sinAngle = Math.sin(angle);\r\n    const cosAngle = Math.cos(angle);\r\n    const x = cosAngle * (this.x - anchor.x) - sinAngle * (this.y - anchor.y) + anchor.x;\r\n    const y = sinAngle * (this.x - anchor.x) + cosAngle * (this.y - anchor.y) + anchor.y;\r\n    return new Vector(x, y);\r\n  }\r\n\r\n  /**\r\n   * Creates new vector that has the same values as the previous.\r\n   */\r\n  public clone(dest?: Vector): Vector {\r\n    const v = dest ?? new Vector(0, 0);\r\n    v.x = this.x;\r\n    v.y = this.y;\r\n    return v;\r\n  }\r\n\r\n  /**\r\n   * Returns a string representation of the vector.\r\n   */\r\n  public toString(fixed?: number): string {\r\n    if (fixed) {\r\n      return `(${this.x.toFixed(fixed)}, ${this.y.toFixed(fixed)})`;\r\n    }\r\n    return `(${this.x}, ${this.y})`;\r\n  }\r\n}\r\n\r\n/**\r\n * Shorthand for creating new Vectors - returns a new Vector instance with the\r\n * provided X and Y components.\r\n * @param x  X component of the Vector\r\n * @param y  Y component of the Vector\r\n */\r\nexport function vec(x: number, y: number): Vector {\r\n  return new Vector(x, y);\r\n}\r\n","\r\n/**\r\n * Provides standard colors (e.g. [[Color.Black]])\r\n * but you can also create custom colors using RGB, HSL, or Hex. Also provides\r\n * useful color operations like [[Color.lighten]], [[Color.darken]], and more.\r\n */\r\nexport class Color {\r\n  /**\r\n   * Red channel\r\n   */\r\n  public r: number;\r\n  /**\r\n   * Green channel\r\n   */\r\n  public g: number;\r\n  /**\r\n   * Blue channel\r\n   */\r\n  public b: number;\r\n  /**\r\n   * Alpha channel (between 0 and 1)\r\n   */\r\n  public a: number;\r\n\r\n  /**\r\n   * Hue\r\n   */\r\n  public h: number;\r\n  /**\r\n   * Saturation\r\n   */\r\n  public s: number;\r\n  /**\r\n   * Lightness\r\n   */\r\n  public l: number;\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  constructor(r: number, g: number, b: number, a?: number) {\r\n    this.r = r;\r\n    this.g = g;\r\n    this.b = b;\r\n    this.a = a != null ? a : 1;\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  public static fromRGB(r: number, g: number, b: number, a?: number): Color {\r\n    return new Color(r, g, b, a);\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a rgb string\r\n   * @param string  CSS color string of the form rgba(255, 255, 255, 1) or rgb(255, 255, 255)\r\n   */\r\n  public static fromRGBString(string: string): Color {\r\n    const rgbaRegEx: RegExp = /^rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)(?:,\\s*(\\d+(?:\\.\\d+)?))?\\)/i;\r\n    let match = null;\r\n    if ((match = string.match(rgbaRegEx))) {\r\n      const r = parseInt(match[1], 10);\r\n      const g = parseInt(match[2], 10);\r\n      const b = parseInt(match[3], 10);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseFloat(match[4]);\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid rgb/a string: ' + string);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a hex string\r\n   * @param hex  CSS color string of the form #ffffff, the alpha component is optional\r\n   */\r\n  public static fromHex(hex: string): Color {\r\n    const hexRegEx: RegExp = /^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;\r\n    let match = null;\r\n    if ((match = hex.match(hexRegEx))) {\r\n      const r = parseInt(match[1], 16);\r\n      const g = parseInt(match[2], 16);\r\n      const b = parseInt(match[3], 16);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseInt(match[4], 16) / 255;\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid hex string: ' + hex);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from hsla values\r\n   * @param h  Hue is represented [0-1]\r\n   * @param s  Saturation is represented [0-1]\r\n   * @param l  Luminance is represented [0-1]\r\n   * @param a  Alpha is represented [0-1]\r\n   */\r\n  public static fromHSL(h: number, s: number, l: number, a: number = 1.0): Color {\r\n    const temp = new HSLColor(h, s, l, a);\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Lightens the current color by a specified amount\r\n   * @param factor  The amount to lighten by [0-1]\r\n   */\r\n  public lighten(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l += (1 - temp.l) * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Darkens the current color by a specified amount\r\n   * @param factor  The amount to darken by [0-1]\r\n   */\r\n  public darken(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l -= temp.l * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Saturates the current color by a specified amount\r\n   * @param factor  The amount to saturate by [0-1]\r\n   */\r\n  public saturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s += temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Desaturates the current color by a specified amount\r\n   * @param factor  The amount to desaturate by [0-1]\r\n   */\r\n  public desaturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s -= temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Multiplies a color by another, results in a darker color\r\n   * @param color  The other color\r\n   */\r\n  public multiply(color: Color): Color {\r\n    const newR = (((color.r / 255) * this.r) / 255) * 255;\r\n    const newG = (((color.g / 255) * this.g) / 255) * 255;\r\n    const newB = (((color.b / 255) * this.b) / 255) * 255;\r\n    const newA = color.a * this.a;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  /**\r\n   * Screens a color by another, results in a lighter color\r\n   * @param color  The other color\r\n   */\r\n  public screen(color: Color): Color {\r\n    const color1 = color.invert();\r\n    const color2 = color.invert();\r\n    return color1.multiply(color2).invert();\r\n  }\r\n\r\n  /**\r\n   * Inverts the current color\r\n   */\r\n  public invert(): Color {\r\n    return new Color(255 - this.r, 255 - this.g, 255 - this.b, 1.0 - this.a);\r\n  }\r\n\r\n  /**\r\n   * Averages the current color with another\r\n   * @param color  The other color\r\n   */\r\n  public average(color: Color): Color {\r\n    const newR = (color.r + this.r) / 2;\r\n    const newG = (color.g + this.g) / 2;\r\n    const newB = (color.b + this.b) / 2;\r\n    const newA = (color.a + this.a) / 2;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  public equal(color: Color): boolean {\r\n    return this.toString() === color.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   * @param format Color representation, accepts: rgb, hsl, or hex\r\n   */\r\n  public toString(format: 'rgb' | 'hsl' | 'hex' = 'rgb') {\r\n    switch (format) {\r\n      case 'rgb':\r\n        return this.toRGBA();\r\n      case 'hsl':\r\n        return this.toHSLA();\r\n      case 'hex':\r\n        return this.toHex();\r\n      default:\r\n        throw new Error('Invalid Color format');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns Hex Value of a color component\r\n   * @param c color component\r\n   * @see https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb\r\n   */\r\n  private _componentToHex(c: number) {\r\n    // Handle negative and fractional numbers\r\n    const hex = Math.max(Math.round(c), 0).toString(16);\r\n    return hex.length === 1 ? '0' + hex : hex;\r\n  }\r\n\r\n  /**\r\n   * Return Hex representation of a color.\r\n   */\r\n  public toHex() {\r\n    let hexRepresentation = '#' + this._componentToHex(this.r) + this._componentToHex(this.g) + this._componentToHex(this.b);\r\n    if (this.a !== 1) {\r\n      hexRepresentation += this._componentToHex(this.a * 255);\r\n    }\r\n    return hexRepresentation;\r\n  }\r\n\r\n  /**\r\n   * Return RGBA representation of a color.\r\n   */\r\n  public toRGBA() {\r\n    const result = String(this.r.toFixed(0)) + ', ' + String(this.g.toFixed(0)) + ', ' + String(this.b.toFixed(0));\r\n    if (this.a !== undefined || this.a !== null) {\r\n      return 'rgba(' + result + ', ' + String(this.a) + ')';\r\n    }\r\n    return 'rgb(' + result + ')';\r\n  }\r\n\r\n  /**\r\n   * Return HSLA representation of a color.\r\n   */\r\n  public toHSLA() {\r\n    return HSLColor.fromRGBA(this.r, this.g, this.b, this.a).toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   */\r\n  public fillStyle() {\r\n    return this.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of the current color.\r\n   */\r\n  public clone(): Color {\r\n    return new Color(this.r, this.g, this.b, this.a);\r\n  }\r\n\r\n  /**\r\n   * Black (#000000)\r\n   */\r\n  public static get Black(): Color {\r\n    return Color.fromHex('#000000');\r\n  }\r\n\r\n  /**\r\n   * White (#FFFFFF)\r\n   */\r\n  public static get White(): Color {\r\n    return Color.fromHex('#FFFFFF');\r\n  }\r\n\r\n  /**\r\n   * Gray (#808080)\r\n   */\r\n  public static get Gray(): Color {\r\n    return Color.fromHex('#808080');\r\n  }\r\n\r\n  /**\r\n   * Light gray (#D3D3D3)\r\n   */\r\n  public static get LightGray(): Color {\r\n    return Color.fromHex('#D3D3D3');\r\n  }\r\n\r\n  /**\r\n   * Dark gray (#A9A9A9)\r\n   */\r\n  public static get DarkGray(): Color {\r\n    return Color.fromHex('#A9A9A9');\r\n  }\r\n\r\n  /**\r\n   * Yellow (#FFFF00)\r\n   */\r\n  public static get Yellow(): Color {\r\n    return Color.fromHex('#FFFF00');\r\n  }\r\n\r\n  /**\r\n   * Orange (#FFA500)\r\n   */\r\n  public static get Orange(): Color {\r\n    return Color.fromHex('#FFA500');\r\n  }\r\n\r\n  /**\r\n   * Red (#FF0000)\r\n   */\r\n  public static get Red(): Color {\r\n    return Color.fromHex('#FF0000');\r\n  }\r\n\r\n  /**\r\n   * Vermilion (#FF5B31)\r\n   */\r\n  public static get Vermilion(): Color {\r\n    return Color.fromHex('#FF5B31');\r\n  }\r\n\r\n  /**\r\n   * Rose (#FF007F)\r\n   */\r\n  public static get Rose(): Color {\r\n    return Color.fromHex('#FF007F');\r\n  }\r\n\r\n  /**\r\n   * Magenta (#FF00FF)\r\n   */\r\n  public static get Magenta(): Color {\r\n    return Color.fromHex('#FF00FF');\r\n  }\r\n\r\n  /**\r\n   * Violet (#7F00FF)\r\n   */\r\n  public static get Violet(): Color {\r\n    return Color.fromHex('#7F00FF');\r\n  }\r\n\r\n  /**\r\n   * Blue (#0000FF)\r\n   */\r\n  public static get Blue(): Color {\r\n    return Color.fromHex('#0000FF');\r\n  }\r\n\r\n  /**\r\n   * Azure (#007FFF)\r\n   */\r\n  public static get Azure(): Color {\r\n    return Color.fromHex('#007FFF');\r\n  }\r\n\r\n  /**\r\n   * Cyan (#00FFFF)\r\n   */\r\n  public static get Cyan(): Color {\r\n    return Color.fromHex('#00FFFF');\r\n  }\r\n\r\n  /**\r\n   * Viridian (#59978F)\r\n   */\r\n  public static get Viridian(): Color {\r\n    return Color.fromHex('#59978F');\r\n  }\r\n\r\n  /**\r\n   * Green (#00FF00)\r\n   */\r\n  public static get Green(): Color {\r\n    return Color.fromHex('#00FF00');\r\n  }\r\n\r\n  /**\r\n   * Chartreuse (#7FFF00)\r\n   */\r\n  public static get Chartreuse(): Color {\r\n    return Color.fromHex('#7FFF00');\r\n  }\r\n\r\n  /**\r\n   * Transparent (#FFFFFF00)\r\n   */\r\n  public static get Transparent(): Color {\r\n    return Color.fromHex('#FFFFFF00');\r\n  }\r\n\r\n  /**\r\n   * ExcaliburBlue (#176BAA)\r\n   */\r\n  public static get ExcaliburBlue(): Color {\r\n    return Color.fromHex('#176BAA');\r\n  }\r\n}\r\n\r\n/**\r\n * Internal HSL Color representation\r\n *\r\n * http://en.wikipedia.org/wiki/HSL_and_HSV\r\n * http://axonflux.com/handy-rgb-to-hsl-and-rgb-to-hsv-color-model-c\r\n */\r\nclass HSLColor {\r\n  constructor(public h: number, public s: number, public l: number, public a: number) { }\r\n\r\n  public static hue2rgb(p: number, q: number, t: number): number {\r\n    if (t < 0) {\r\n      t += 1;\r\n    }\r\n    if (t > 1) {\r\n      t -= 1;\r\n    }\r\n    if (t < 1 / 6) {\r\n      return p + (q - p) * 6 * t;\r\n    }\r\n    if (t < 1 / 2) {\r\n      return q;\r\n    }\r\n    if (t < 2 / 3) {\r\n      return p + (q - p) * (2 / 3 - t) * 6;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public static fromRGBA(r: number, g: number, b: number, a: number): HSLColor {\r\n    r /= 255;\r\n    g /= 255;\r\n    b /= 255;\r\n    const max = Math.max(r, g, b),\r\n      min = Math.min(r, g, b);\r\n    let h, s;\r\n    const l = (max + min) / 2;\r\n\r\n    if (max === min) {\r\n      h = s = 0; // achromatic\r\n    } else {\r\n      const d = max - min;\r\n      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n      switch (max) {\r\n        case r:\r\n          h = (g - b) / d + (g < b ? 6 : 0);\r\n          break;\r\n        case g:\r\n          h = (b - r) / d + 2;\r\n          break;\r\n        case b:\r\n          h = (r - g) / d + 4;\r\n          break;\r\n      }\r\n      h /= 6;\r\n    }\r\n\r\n    return new HSLColor(h, s, l, a);\r\n  }\r\n\r\n  public toRGBA(): Color {\r\n    let r: number, g: number, b: number;\r\n\r\n    if (this.s === 0) {\r\n      r = g = b = this.l; // achromatic\r\n    } else {\r\n      const q = this.l < 0.5 ? this.l * (1 + this.s) : this.l + this.s - this.l * this.s;\r\n      const p = 2 * this.l - q;\r\n      r = HSLColor.hue2rgb(p, q, this.h + 1 / 3);\r\n      g = HSLColor.hue2rgb(p, q, this.h);\r\n      b = HSLColor.hue2rgb(p, q, this.h - 1 / 3);\r\n    }\r\n\r\n    return new Color(r * 255, g * 255, b * 255, this.a);\r\n  }\r\n\r\n  public toString(): string {\r\n    const h = this.h.toFixed(0),\r\n      s = this.s.toFixed(0),\r\n      l = this.l.toFixed(0),\r\n      a = this.a.toFixed(0);\r\n    return `hsla(${h}, ${s}, ${l}, ${a})`;\r\n  }\r\n}\r\n","/* eslint-disable no-console */\r\n\r\nimport { Engine } from '../Engine';\r\nimport { vec } from '../Math/vector';\r\nimport { Color } from '../Color';\r\n\r\n/**\r\n * Logging level that Excalibur will tag\r\n */\r\nexport enum LogLevel {\r\n  Debug,\r\n  Info,\r\n  Warn,\r\n  Error,\r\n  Fatal\r\n}\r\n\r\n/**\r\n * Static singleton that represents the logging facility for Excalibur.\r\n * Excalibur comes built-in with a [[ConsoleAppender]] and [[ScreenAppender]].\r\n * Derive from [[Appender]] to create your own logging appenders.\r\n */\r\nexport class Logger {\r\n  private static _INSTANCE: Logger = null;\r\n  private _appenders: Appender[] = [];\r\n\r\n  constructor() {\r\n    if (Logger._INSTANCE) {\r\n      throw new Error('Logger is a singleton');\r\n    }\r\n    Logger._INSTANCE = this;\r\n    // Default console appender\r\n    Logger._INSTANCE.addAppender(new ConsoleAppender());\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the default logging level. Excalibur will only log\r\n   * messages if equal to or above this level. Default: [[LogLevel.Info]]\r\n   */\r\n  public defaultLevel: LogLevel = LogLevel.Info;\r\n\r\n  /**\r\n   * Gets the current static instance of Logger\r\n   */\r\n  public static getInstance(): Logger {\r\n    if (Logger._INSTANCE == null) {\r\n      Logger._INSTANCE = new Logger();\r\n    }\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Adds a new [[Appender]] to the list of appenders to write to\r\n   */\r\n  public addAppender(appender: Appender): void {\r\n    this._appenders.push(appender);\r\n  }\r\n\r\n  /**\r\n   * Clears all appenders from the logger\r\n   */\r\n  public clearAppenders(): void {\r\n    this._appenders.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Logs a message at a given LogLevel\r\n   * @param level  The LogLevel`to log the message at\r\n   * @param args   An array of arguments to write to an appender\r\n   */\r\n  private _log(level: LogLevel, args: any[]): void {\r\n    if (level == null) {\r\n      level = this.defaultLevel;\r\n    }\r\n\r\n    const len = this._appenders.length;\r\n\r\n    for (let i = 0; i < len; i++) {\r\n      if (level >= this.defaultLevel) {\r\n        this._appenders[i].log(level, args);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  private _logOnceSet = new Set<any>();\r\n  private _logOnce(level: LogLevel, args: any[]): void {\r\n    const serialized = level + args.join('+');\r\n    if (this._logOnceSet.has(serialized)) {\r\n      return;\r\n    } else {\r\n      this._logOnceSet.add(serialized);\r\n      this._log(level, args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Debug]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public debug(...args: any[]): void {\r\n    this._log(LogLevel.Debug, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the [[LogLevel.Fatal]] level, if it sees the same args again it wont log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public debugOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Debug, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Info]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public info(...args: any[]): void {\r\n    this._log(LogLevel.Info, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the [[LogLevel.Info]] level, if it sees the same args again it wont log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public infoOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Info, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Warn]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public warn(...args: any[]): void {\r\n    this._log(LogLevel.Warn, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the [[LogLevel.Warn]] level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public warnOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Warn, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Error]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public error(...args: any[]): void {\r\n    this._log(LogLevel.Error, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the [[LogLevel.Error]] level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public errorOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Error, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the [[LogLevel.Fatal]] level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public fatal(...args: any[]): void {\r\n    this._log(LogLevel.Fatal, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the [[LogLevel.Fatal]] level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public fatalOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Fatal, args);\r\n  }\r\n}\r\n\r\n/**\r\n * Contract for any log appender (such as console/screen)\r\n */\r\nexport interface Appender {\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  log(level: LogLevel, args: any[]): void;\r\n}\r\n\r\n/**\r\n * Console appender for browsers (i.e. `console.log`)\r\n */\r\nexport class ConsoleAppender implements Appender {\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    // Check for console support\r\n    if (!console && !console.log && console.warn && console.error) {\r\n      // todo maybe do something better than nothing\r\n      return;\r\n    }\r\n\r\n    // Create a new console args array\r\n    const consoleArgs: any[] = [];\r\n    consoleArgs.unshift.apply(consoleArgs, args);\r\n    consoleArgs.unshift('[' + LogLevel[level] + '] : ');\r\n\r\n    if (level < LogLevel.Warn) {\r\n      // Call .log for Debug/Info\r\n      if (console.log.apply) {\r\n        // this is required on some older browsers that don't support apply on console.log :(\r\n        console.log.apply(console, consoleArgs);\r\n      } else {\r\n        console.log(consoleArgs.join(' '));\r\n      }\r\n    } else if (level < LogLevel.Error) {\r\n      // Call .warn for Warn\r\n      if (console.warn.apply) {\r\n        console.warn.apply(console, consoleArgs);\r\n      } else {\r\n        console.warn(consoleArgs.join(' '));\r\n      }\r\n    } else {\r\n      // Call .error for Error/Fatal\r\n      if (console.error.apply) {\r\n        console.error.apply(console, consoleArgs);\r\n      } else {\r\n        console.error(consoleArgs.join(' '));\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport interface ScreenAppenderOptions {\r\n  engine: Engine;\r\n  /**\r\n   * Optionally set the width of the overlay canvas\r\n   */\r\n  width?: number;\r\n  /**\r\n   * Optionally set the height of the overlay canvas\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Adjust the text offset from the left side of the screen\r\n   */\r\n  xPos?: number;\r\n  /**\r\n   * Provide a text color\r\n   */\r\n  color?: Color;\r\n  /**\r\n   * Optionally set the CSS zindex of the overlay canvas\r\n   */\r\n  zIndex?: number;\r\n}\r\n\r\n/**\r\n * On-screen (canvas) appender\r\n */\r\nexport class ScreenAppender implements Appender {\r\n\r\n  private _messages: string[] = [];\r\n  public canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _pos = 10;\r\n  private _color = Color.Black;\r\n  private _options: ScreenAppenderOptions;\r\n  constructor(options: ScreenAppenderOptions) {\r\n    this._options = options;\r\n    this.canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    this._ctx = this.canvas.getContext('2d')!;\r\n    this.canvas.style.position = 'absolute';\r\n    this.canvas.style.zIndex = options.zIndex?.toString() ?? '99';\r\n    document.body.appendChild(this.canvas);\r\n    this._positionScreenAppenderCanvas();\r\n    options.engine.screen.events.on('resize', () => {\r\n      this._positionScreenAppenderCanvas();\r\n    });\r\n  }\r\n\r\n  private _positionScreenAppenderCanvas() {\r\n    const options = this._options;\r\n    this.canvas.width = options.width ?? options.engine.screen.resolution.width;\r\n    this.canvas.height = options.height ?? options.engine.screen.resolution.height;\r\n    this.canvas.style.position = 'absolute';\r\n    const pagePos = options.engine.screen.screenToPageCoordinates(vec(0, 0));\r\n    this.canvas.style.left = pagePos.x + 'px';\r\n    this.canvas.style.top = pagePos.y + 'px';\r\n    this._pos = options.xPos ?? this._pos;\r\n    this._color = options.color ?? this._color;\r\n  }\r\n\r\n  /**\r\n   * Logs a message at the given [[LogLevel]]\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    const message = args.join(',');\r\n\r\n    this._ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n    this._messages.unshift('[' + LogLevel[level] + '] : ' + message);\r\n\r\n    let pos = 10;\r\n\r\n    this._messages = this._messages.slice(0, 1000);\r\n    for (let i = 0; i < this._messages.length; i++) {\r\n      this._ctx.fillStyle = this._color.toRGBA();\r\n      this._ctx.fillText(this._messages[i], this._pos, pos);\r\n      pos += 10;\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\n\n/**\n * An enum that describes the sides of an axis aligned box for collision\n */\nexport enum Side {\n  None = 'None',\n  Top = 'Top',\n  Bottom = 'Bottom',\n  Left = 'Left',\n  Right = 'Right'\n}\n\nexport module Side {\n  /**\n   * Returns the opposite side from the current\n   */\n  export function getOpposite(side: Side): Side {\n    if (side === Side.Top) {\n      return Side.Bottom;\n    }\n    if (side === Side.Bottom) {\n      return Side.Top;\n    }\n    if (side === Side.Left) {\n      return Side.Right;\n    }\n    if (side === Side.Right) {\n      return Side.Left;\n    }\n\n    return Side.None;\n  }\n\n  /**\n   * Given a vector, return the Side most in that direction (via dot product)\n   */\n  export function fromDirection(direction: Vector): Side {\n    const directions = [Vector.Left, Vector.Right, Vector.Up, Vector.Down];\n    const directionEnum = [Side.Left, Side.Right, Side.Top, Side.Bottom];\n\n    let max = -Number.MAX_VALUE;\n    let maxIndex = -1;\n    for (let i = 0; i < directions.length; i++) {\n      if (directions[i].dot(direction) > max) {\n        max = directions[i].dot(direction);\n        maxIndex = i;\n      }\n    }\n    return directionEnum[maxIndex];\n  }\n}\n","import { sign } from './util';\r\nimport { Vector, vec } from './vector';\r\nimport { canonicalizeAngle } from './util';\r\n\r\nexport enum MatrixLocations {\r\n  X = 12,\r\n  Y = 13\r\n}\r\n\r\n/**\r\n * Excalibur Matrix helper for 4x4 matrices\r\n *\r\n * Useful for webgl 4x4 matrices\r\n */\r\nexport class Matrix {\r\n  /**\r\n   *  4x4 matrix in column major order\r\n   *\r\n   * |         |         |          |          |\r\n   * | ------- | ------- | -------- | -------- |\r\n   * | data[0] | data[4] | data[8]  | data[12] |\r\n   * | data[1] | data[5] | data[9]  | data[13] |\r\n   * | data[2] | data[6] | data[10] | data[14] |\r\n   * | data[3] | data[7] | data[11] | data[15] |\r\n   *\r\n   */\r\n  public data: Float32Array = new Float32Array(16);\r\n\r\n  /**\r\n   * Creates an orthographic (flat non-perspective) projection\r\n   * https://en.wikipedia.org/wiki/Orthographic_projection\r\n   * @param left\r\n   * @param right\r\n   * @param bottom\r\n   * @param top\r\n   * @param near\r\n   * @param far\r\n   */\r\n  public static ortho(left: number, right: number, bottom: number, top: number, near: number, far: number): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 2 / (right - left);\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 2 / (top - bottom);\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = -2 / (far - near);\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = -(right + left) / (right - left);\r\n    mat.data[13] = -(top + bottom) / (top - bottom);\r\n    mat.data[14] = -(far + near) / (far - near);\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current 4x4\r\n   */\r\n  public clone(dest?: Matrix): Matrix {\r\n    const mat = dest || new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = this.data[2];\r\n    mat.data[3] = this.data[3];\r\n\r\n    mat.data[4] = this.data[4];\r\n    mat.data[5] = this.data[5];\r\n    mat.data[6] = this.data[6];\r\n    mat.data[7] = this.data[7];\r\n\r\n    mat.data[8] = this.data[8];\r\n    mat.data[9] = this.data[9];\r\n    mat.data[10] = this.data[10];\r\n    mat.data[11] = this.data[11];\r\n\r\n    mat.data[12] = this.data[12];\r\n    mat.data[13] = this.data[13];\r\n    mat.data[14] = this.data[14];\r\n    mat.data[15] = this.data[15];\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static fromFloat32Array(data: Float32Array) {\r\n    const matrix =  new Matrix();\r\n    matrix.data = data;\r\n    return matrix;\r\n  }\r\n\r\n  /**\r\n   * Creates a new identity matrix (a matrix that when applied does nothing)\r\n   */\r\n  public static identity(): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {Matrix} Current matrix as identity\r\n   */\r\n  public reset(): Matrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[12] = x;\r\n    mat.data[13] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[5] = sy;\r\n    mat.data[10] = 1;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle\r\n   * @param angleRadians\r\n   */\r\n  public static rotation(angleRadians: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = Math.cos(angleRadians);\r\n    mat.data[4] = -Math.sin(angleRadians);\r\n    mat.data[1] = Math.sin(angleRadians);\r\n    mat.data[5] = Math.cos(angleRadians);\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: Matrix, dest?: Matrix): Matrix;\r\n  multiply(vectorOrMatrix: Vector | Matrix, dest?: Vector | Matrix): Vector | Matrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[4] + this.data[12];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[5] + this.data[13];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as Matrix) || new Matrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      const a31 = this.data[2];\r\n      const a41 = this.data[3];\r\n\r\n      const a12 = this.data[4];\r\n      const a22 = this.data[5];\r\n      const a32 = this.data[6];\r\n      const a42 = this.data[7];\r\n\r\n      const a13 = this.data[8];\r\n      const a23 = this.data[9];\r\n      const a33 = this.data[10];\r\n      const a43 = this.data[11];\r\n\r\n      const a14 = this.data[12];\r\n      const a24 = this.data[13];\r\n      const a34 = this.data[14];\r\n      const a44 = this.data[15];\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      const b31 = other.data[2];\r\n      const b41 = other.data[3];\r\n\r\n      const b12 = other.data[4];\r\n      const b22 = other.data[5];\r\n      const b32 = other.data[6];\r\n      const b42 = other.data[7];\r\n\r\n      const b13 = other.data[8];\r\n      const b23 = other.data[9];\r\n      const b33 = other.data[10];\r\n      const b43 = other.data[11];\r\n\r\n      const b14 = other.data[12];\r\n      const b24 = other.data[13];\r\n      const b34 = other.data[14];\r\n      const b44 = other.data[15];\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;\r\n      result.data[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;\r\n      result.data[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;\r\n      result.data[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;\r\n\r\n      result.data[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;\r\n      result.data[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;\r\n      result.data[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;\r\n      result.data[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;\r\n\r\n      result.data[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;\r\n      result.data[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;\r\n      result.data[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;\r\n      result.data[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;\r\n\r\n      result.data[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;\r\n      result.data[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;\r\n      result.data[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;\r\n      result.data[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;\r\n\r\n      const s = this.getScale();\r\n      result._scaleSignX = sign(s.x) * sign(result._scaleSignX);\r\n      result._scaleSignY = sign(s.y) * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const a13 = this.data[8];\r\n    const a23 = this.data[9];\r\n    const a33 = this.data[10];\r\n    const a43 = this.data[11];\r\n\r\n    const a14 = this.data[12];\r\n    const a24 = this.data[13];\r\n    const a34 = this.data[14];\r\n    const a44 = this.data[15];\r\n\r\n    // Doesn't change z\r\n    const z = 0;\r\n    const w = 1;\r\n    this.data[12] = a11 * x + a12 * y + a13 * z + a14 * w;\r\n    this.data[13] = a21 * x + a22 * y + a23 * z + a24 * w;\r\n    this.data[14] = a31 * x + a32 * y + a33 * z + a34 * w;\r\n    this.data[15] = a41 * x + a42 * y + a43 * z + a44 * w;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[12] = x;\r\n    this.data[13] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[12], this.data[13]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n    this.data[2] = cosine * a31 + sine * a32;\r\n    this.data[3] = cosine * a41 + sine * a42;\r\n\r\n    this.data[4] = cosine * a12 - sine * a11;\r\n    this.data[5] = cosine * a22 - sine * a21;\r\n    this.data[6] = cosine * a32 - sine * a31;\r\n    this.data[7] = cosine * a42 - sine * a41;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n    this.data[2] = a31 * x;\r\n    this.data[3] = a41 * x;\r\n\r\n    this.data[4] = a12 * y;\r\n    this.data[5] = a22 * y;\r\n    this.data[6] = a32 * y;\r\n    this.data[7] = a42 * y;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[4] = -sine * currentScale.x;\r\n    this.data[5] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xscale = vec(this.data[0], this.data[4]).size;\r\n    return this._scaleSignX * xscale;\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yscale = vec(this.data[1], this.data[5]).size;\r\n    return this._scaleSignY * yscale;\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scaleX = 1;\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (this._scaleX === val) {\r\n      return;\r\n    }\r\n\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[4] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[4] = xscale.y * val;\r\n    this._scaleX = val;\r\n  }\r\n\r\n  private _scaleY = 1;\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (this._scaleY === val) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[5] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[5] = yscale.y * val;\r\n    this._scaleY = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  /**\r\n   * Determinant of the upper left 2x2 matrix\r\n   */\r\n  public getBasisDeterminant() {\r\n    return this.data[0] * this.data[5] - this.data[1] * this.data[4];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public getAffineInverse(target?: Matrix): Matrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.getBasisDeterminant();\r\n    const inverseDet = 1 / det; // todo zero check\r\n    const a = this.data[0];\r\n    const b = this.data[4];\r\n    const c = this.data[1];\r\n    const d = this.data[5];\r\n\r\n    const m = target || Matrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[4] = -b * inverseDet;\r\n    m.data[5] = a * inverseDet;\r\n\r\n    const tx = this.data[12];\r\n    const ty = this.data[13];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[12] = -(tx * m.data[0] + ty * m.data[4]);\r\n    m.data[13] = -(tx * m.data[1] + ty * m.data[5]);\r\n\r\n    return m;\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return (\r\n      this.data[0] === 1 &&\r\n      this.data[1] === 0 &&\r\n      this.data[2] === 0 &&\r\n      this.data[3] === 0 &&\r\n      this.data[4] === 0 &&\r\n      this.data[5] === 1 &&\r\n      this.data[6] === 0 &&\r\n      this.data[7] === 0 &&\r\n      this.data[8] === 0 &&\r\n      this.data[9] === 0 &&\r\n      this.data[10] === 1 &&\r\n      this.data[11] === 0 &&\r\n      this.data[12] === 0 &&\r\n      this.data[13] === 0 &&\r\n      this.data[14] === 0 &&\r\n      this.data[15] === 1\r\n    );\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]\r\n[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]\r\n[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]\r\n[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]\r\n`;\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Ray } from '../Math/ray';\r\nimport { Color } from '../Color';\r\nimport { Side } from './Side';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface BoundingBoxOptions {\r\n  left: number;\r\n  right: number;\r\n  top: number;\r\n  bottom: number;\r\n}\r\n\r\n/**\r\n * Axis Aligned collision primitive for Excalibur.\r\n */\r\nexport class BoundingBox {\r\n  public top: number;\r\n  public right: number;\r\n  public bottom: number;\r\n  public left: number;\r\n\r\n  /**\r\n   * Constructor allows passing of either an object with all coordinate components,\r\n   * or the coordinate components passed separately.\r\n   * @param leftOrOptions    Either x coordinate of the left edge or an options object\r\n   * containing the four coordinate components.\r\n   * @param top     y coordinate of the top edge\r\n   * @param right   x coordinate of the right edge\r\n   * @param bottom  y coordinate of the bottom edge\r\n   */\r\n  constructor(leftOrOptions: number | BoundingBoxOptions = 0, top: number = 0, right: number = 0, bottom: number = 0) {\r\n    if (typeof leftOrOptions === 'object') {\r\n      this.left = leftOrOptions.left;\r\n      this.top = leftOrOptions.top;\r\n      this.right = leftOrOptions.right;\r\n      this.bottom = leftOrOptions.bottom;\r\n    } else if (typeof leftOrOptions === 'number') {\r\n      this.left = leftOrOptions;\r\n      this.top = top;\r\n      this.right = right;\r\n      this.bottom = bottom;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of [[BoundingBox]] that is a copy of the current instance\r\n   */\r\n  public clone(): BoundingBox {\r\n    return new BoundingBox(this.left, this.top, this.right, this.bottom);\r\n  }\r\n\r\n  /**\r\n   * Given bounding box A & B, returns the side relative to A when intersection is performed.\r\n   * @param intersection Intersection vector between 2 bounding boxes\r\n   */\r\n  public static getSideFromIntersection(intersection: Vector): Side {\r\n    if (!intersection) {\r\n      return Side.None;\r\n    }\r\n    if (intersection) {\r\n      if (Math.abs(intersection.x) > Math.abs(intersection.y)) {\r\n        if (intersection.x < 0) {\r\n          return Side.Right;\r\n        }\r\n        return Side.Left;\r\n      } else {\r\n        if (intersection.y < 0) {\r\n          return Side.Bottom;\r\n        }\r\n        return Side.Top;\r\n      }\r\n    }\r\n    return Side.None;\r\n  }\r\n\r\n  public static fromPoints(points: Vector[]): BoundingBox {\r\n    let minX = Infinity;\r\n    let minY = Infinity;\r\n    let maxX = -Infinity;\r\n    let maxY = -Infinity;\r\n    for (let i = 0; i < points.length; i++) {\r\n      if (points[i].x < minX) {\r\n        minX = points[i].x;\r\n      }\r\n      if (points[i].x > maxX) {\r\n        maxX = points[i].x;\r\n      }\r\n      if (points[i].y < minY) {\r\n        minY = points[i].y;\r\n      }\r\n      if (points[i].y > maxY) {\r\n        maxY = points[i].y;\r\n      }\r\n    }\r\n    return new BoundingBox(minX, minY, maxX, maxY);\r\n  }\r\n\r\n  /**\r\n   * Creates a bounding box from a width and height\r\n   * @param width\r\n   * @param height\r\n   * @param anchor Default Vector.Half\r\n   * @param pos Default Vector.Zero\r\n   */\r\n  public static fromDimension(width: number, height: number, anchor: Vector = Vector.Half, pos: Vector = Vector.Zero) {\r\n    return new BoundingBox(\r\n      -width * anchor.x + pos.x,\r\n      -height * anchor.y + pos.y,\r\n      width - width * anchor.x + pos.x,\r\n      height - height * anchor.y + pos.y\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated width of the bounding box\r\n   */\r\n  public get width() {\r\n    return this.right - this.left;\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated height of the bounding box\r\n   */\r\n  public get height() {\r\n    return this.bottom - this.top;\r\n  }\r\n\r\n  /**\r\n   * Return whether the bounding box has zero dimensions in height,width or both\r\n   */\r\n  public hasZeroDimensions() {\r\n    return this.width === 0 || this.height === 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the bounding box\r\n   */\r\n  public get center(): Vector {\r\n    return new Vector((this.left + this.right) / 2, (this.top + this.bottom) / 2);\r\n  }\r\n\r\n  public get topLeft(): Vector {\r\n    return new Vector(this.left, this.top);\r\n  }\r\n\r\n  public get bottomRight(): Vector {\r\n    return new Vector(this.right, this.bottom);\r\n  }\r\n\r\n  public get topRight(): Vector {\r\n    return new Vector(this.right, this.top);\r\n  }\r\n\r\n  public get bottomLeft(): Vector {\r\n    return new Vector(this.left, this.bottom);\r\n  }\r\n\r\n  public translate(pos: Vector): BoundingBox {\r\n    return new BoundingBox(this.left + pos.x, this.top + pos.y, this.right + pos.x, this.bottom + pos.y);\r\n  }\r\n\r\n  /**\r\n   * Rotates a bounding box by and angle and around a point, if no point is specified (0, 0) is used by default. The resulting bounding\r\n   * box is also axis-align. This is useful when a new axis-aligned bounding box is needed for rotated geometry.\r\n   */\r\n  public rotate(angle: number, point: Vector = Vector.Zero): BoundingBox {\r\n    const points = this.getPoints().map((p) => p.rotate(angle, point));\r\n    return BoundingBox.fromPoints(points);\r\n  }\r\n\r\n  /**\r\n   * Scale a bounding box by a scale factor, optionally provide a point\r\n   * @param scale\r\n   * @param point\r\n   */\r\n  public scale(scale: Vector, point: Vector = Vector.Zero): BoundingBox {\r\n    const shifted = this.translate(point);\r\n    return new BoundingBox(shifted.left * scale.x, shifted.top * scale.y, shifted.right * scale.x, shifted.bottom * scale.y);\r\n  }\r\n\r\n  /**\r\n   * Transform the axis aligned bounding box by a [[Matrix]], producing a new axis aligned bounding box\r\n   * @param matrix\r\n   */\r\n  public transform(matrix: AffineMatrix) {\r\n    // inlined these calculations to not use vectors would speed it up slightly\r\n    // const matFirstColumn = vec(matrix.data[0], matrix.data[1]);\r\n    // const xa = matFirstColumn.scale(this.left);\r\n    const xa1 = matrix.data[0] * this.left;\r\n    const xa2 = matrix.data[1] * this.left;\r\n\r\n    // const xb = matFirstColumn.scale(this.right);\r\n    const xb1 = matrix.data[0] * this.right;\r\n    const xb2 = matrix.data[1] * this.right;\r\n\r\n    // const matSecondColumn = vec(matrix.data[2], matrix.data[3]);\r\n    // const ya = matSecondColumn.scale(this.top);\r\n    const ya1 = matrix.data[2] * this.top;\r\n    const ya2 = matrix.data[3] * this.top;\r\n\r\n    // const yb = matSecondColumn.scale(this.bottom);\r\n    const yb1 = matrix.data[2] * this.bottom;\r\n    const yb2 = matrix.data[3] * this.bottom;\r\n\r\n    const matrixPos = matrix.getPosition();\r\n    // const topLeft = Vector.min(xa, xb).add(Vector.min(ya, yb)).add(matrixPos);\r\n    // const bottomRight = Vector.max(xa, xb).add(Vector.max(ya, yb)).add(matrixPos);\r\n    const left = Math.min(xa1, xb1) + Math.min(ya1, yb1) + matrixPos.x;\r\n    const top = Math.min(xa2, xb2) + Math.min(ya2, yb2) + matrixPos.y;\r\n    const right = Math.max(xa1, xb1) + Math.max(ya1, yb1) + matrixPos.x;\r\n    const bottom = Math.max(xa2, xb2) + Math.max(ya2, yb2) + matrixPos.y;\r\n\r\n    return new BoundingBox({\r\n      left,//: topLeft.x,\r\n      top,//: topLeft.y,\r\n      right,//: bottomRight.x,\r\n      bottom//: bottomRight.y\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the perimeter of the bounding box\r\n   */\r\n  public getPerimeter(): number {\r\n    const wx = this.width;\r\n    const wy = this.height;\r\n    return 2 * (wx + wy);\r\n  }\r\n\r\n\r\n  // Cache bounding box point returns\r\n  private _points: Vector[] = [];\r\n  private _left?: number;\r\n  private _right?: number;\r\n  private _top?: number;\r\n  private _bottom?: number;\r\n\r\n  /**\r\n   * Returns the world space points that make up the corners of the bounding box as a polygon\r\n   */\r\n  public getPoints(): Vector[] {\r\n    if (this._left !== this.left ||\r\n        this._right !== this.right ||\r\n        this._top !== this.top ||\r\n        this._bottom !== this.bottom\r\n    ) {\r\n      this._points.length = 0;\r\n      this._points.push(new Vector(this.left, this.top));\r\n      this._points.push(new Vector(this.right, this.top));\r\n      this._points.push(new Vector(this.right, this.bottom));\r\n      this._points.push(new Vector(this.left, this.bottom));\r\n      this._left = this.left;\r\n      this._right = this.right;\r\n      this._top = this.top;\r\n      this._bottom = this.bottom;\r\n    }\r\n    return this._points;\r\n  }\r\n\r\n  /**\r\n   * Determines whether a ray intersects with a bounding box\r\n   */\r\n  public rayCast(ray: Ray, farClipDistance = Infinity): boolean {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tmin = -Infinity;\r\n    let tmax = +Infinity;\r\n\r\n    const xinv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yinv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xinv;\r\n    const tx2 = (this.right - ray.pos.x) * xinv;\r\n    tmin = Math.min(tx1, tx2);\r\n    tmax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yinv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yinv;\r\n    tmin = Math.max(tmin, Math.min(ty1, ty2));\r\n    tmax = Math.min(tmax, Math.max(ty1, ty2));\r\n\r\n    return tmax >= Math.max(0, tmin) && tmin < farClipDistance;\r\n  }\r\n\r\n  public rayCastTime(ray: Ray, farClipDistance = Infinity): number {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tmin = -Infinity;\r\n    let tmax = +Infinity;\r\n\r\n    const xinv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yinv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xinv;\r\n    const tx2 = (this.right - ray.pos.x) * xinv;\r\n    tmin = Math.min(tx1, tx2);\r\n    tmax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yinv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yinv;\r\n    tmin = Math.max(tmin, Math.min(ty1, ty2));\r\n    tmax = Math.min(tmax, Math.max(ty1, ty2));\r\n\r\n    if (tmax >= Math.max(0, tmin) && tmin < farClipDistance) {\r\n      return tmin;\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a point is contained within the bounding box\r\n   * @param p  The point to test\r\n   */\r\n  public contains(p: Vector): boolean;\r\n\r\n  /**\r\n   * Tests whether another bounding box is totally contained in this one\r\n   * @param bb  The bounding box to test\r\n   */\r\n  public contains(bb: BoundingBox): boolean;\r\n  public contains(val: any): boolean {\r\n    if (val instanceof Vector) {\r\n      return this.left <= val.x && this.top <= val.y && this.bottom >= val.y && this.right >= val.x;\r\n    } else if (val instanceof BoundingBox) {\r\n      if (this.left <= val.left && this.top <= val.top && val.bottom <= this.bottom && val.right <= this.right) {\r\n        return true;\r\n      }\r\n      return false;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Combines this bounding box and another together returning a new bounding box\r\n   * @param other  The bounding box to combine\r\n   */\r\n  public combine(other: BoundingBox): BoundingBox {\r\n    const compositeBB = new BoundingBox(\r\n      Math.min(this.left, other.left),\r\n      Math.min(this.top, other.top),\r\n      Math.max(this.right, other.right),\r\n      Math.max(this.bottom, other.bottom)\r\n    );\r\n    return compositeBB;\r\n  }\r\n\r\n  public get dimensions(): Vector {\r\n    return new Vector(this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * Returns true if the bounding boxes overlap.\r\n   * @param other\r\n   * @param epsilon Optionally specify a small epsilon (default 0) as amount of overlap to ignore as overlap.\r\n   * This epsilon is useful in stable collision simulations.\r\n   */\r\n  public overlaps(other: BoundingBox, epsilon?: number): boolean {\r\n    const e = epsilon || 0;\r\n    if (other.hasZeroDimensions()){\r\n      return this.contains(other);\r\n    }\r\n    if (this.hasZeroDimensions()) {\r\n      return other.contains(this);\r\n    }\r\n    const totalBoundingBox = this.combine(other);\r\n    return totalBoundingBox.width + e < other.width + this.width &&\r\n           totalBoundingBox.height + e < other.height + this.height;\r\n  }\r\n\r\n  /**\r\n   * Test wether this bounding box intersects with another returning\r\n   * the intersection vector that can be used to resolve the collision. If there\r\n   * is no intersection null is returned.\r\n   * @param other  Other [[BoundingBox]] to test intersection with\r\n   * @returns A Vector in the direction of the current BoundingBox, this <- other\r\n   */\r\n  public intersect(other: BoundingBox): Vector {\r\n    const totalBoundingBox = this.combine(other);\r\n\r\n    // If the total bounding box is less than or equal the sum of the 2 bounds then there is collision\r\n    if (\r\n      totalBoundingBox.width < other.width + this.width &&\r\n      totalBoundingBox.height < other.height + this.height &&\r\n      !totalBoundingBox.dimensions.equals(other.dimensions) &&\r\n      !totalBoundingBox.dimensions.equals(this.dimensions)\r\n    ) {\r\n      // collision\r\n      let overlapX = 0;\r\n      // right edge is between the other's left and right edge\r\n      /**\r\n       *     +-this-+\r\n       *     |      |\r\n       *     |    +-other-+\r\n       *     +----|-+     |\r\n       *          |       |\r\n       *          +-------+\r\n       *         <---\r\n       *          ^ overlap\r\n       */\r\n      if (this.right >= other.left && this.right <= other.right) {\r\n        overlapX = other.left - this.right;\r\n        // right edge is past the other's right edge\r\n        /**\r\n         *     +-other-+\r\n         *     |       |\r\n         *     |    +-this-+\r\n         *     +----|--+   |\r\n         *          |      |\r\n         *          +------+\r\n         *          --->\r\n         *          ^ overlap\r\n         */\r\n      } else {\r\n        overlapX = other.right - this.left;\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // top edge is between the other's top and bottom edge\r\n      /**\r\n       *     +-other-+\r\n       *     |       |\r\n       *     |    +-this-+   | <- overlap\r\n       *     +----|--+   |   |\r\n       *          |      |  \\ /\r\n       *          +------+   '\r\n       */\r\n      if (this.top <= other.bottom && this.top >= other.top) {\r\n        overlapY = other.bottom - this.top;\r\n        // top edge is above the other top edge\r\n        /**\r\n         *     +-this-+         .\r\n         *     |      |        / \\\r\n         *     |    +-other-+   | <- overlap\r\n         *     +----|-+     |   |\r\n         *          |       |\r\n         *          +-------+\r\n         */\r\n      } else {\r\n        overlapY = other.top - this.bottom;\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n      // Case of total containment of one bounding box by another\r\n    } else if (totalBoundingBox.dimensions.equals(other.dimensions) || totalBoundingBox.dimensions.equals(this.dimensions)) {\r\n      let overlapX = 0;\r\n      // this is wider than the other\r\n      if (this.width - other.width >= 0) {\r\n        // This right edge is closest to the others right edge\r\n        if (this.right - other.right <= other.left - this.left) {\r\n          overlapX = other.left - this.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = other.right - this.left;\r\n        }\r\n        // other is wider than this\r\n      } else {\r\n        // This right edge is closest to the others right edge\r\n        if (other.right - this.right <= this.left - other.left) {\r\n          overlapX = this.left - other.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = this.right - other.left;\r\n        }\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // this is taller than other\r\n      if (this.height - other.height >= 0) {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (this.bottom - other.bottom <= other.top - this.top) {\r\n          overlapY = other.top - this.bottom;\r\n        } else {\r\n          overlapY = other.bottom - this.top;\r\n        }\r\n        // other is taller than this\r\n      } else {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (other.bottom - this.bottom <= this.top - other.top) {\r\n          overlapY = this.top - other.bottom;\r\n        } else {\r\n          overlapY = this.bottom - other.top;\r\n        }\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Test whether the bounding box has intersected with another bounding box, returns the side of the current bb that intersected.\r\n   * @param bb The other actor to test\r\n   */\r\n  public intersectWithSide(bb: BoundingBox): Side {\r\n    const intersect = this.intersect(bb);\r\n    return BoundingBox.getSideFromIntersection(intersect);\r\n  }\r\n\r\n  /**\r\n   * Draw a debug bounding box\r\n   * @param ex\r\n   * @param color\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, color: Color = Color.Yellow) {\r\n    ex.debug.drawRect(this.left, this.top, this.width, this.height, { color });\r\n  }\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { Clock } from './Clock';\r\nimport { Future } from './Future';\r\n\r\n/**\r\n * Find the screen position of an HTML element\r\n */\r\nexport function getPosition(el: HTMLElement): Vector {\r\n  // do we need the scroll too? technically the offset method before did that\r\n  if (el) {\r\n    const rect = el.getBoundingClientRect();\r\n    return vec(rect.x + window.scrollX, rect.y + window.scrollY);\r\n  }\r\n  return Vector.Zero;\r\n}\r\n\r\n/**\r\n * Add an item to an array list if it doesn't already exist. Returns true if added, false if not and already exists in the array.\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function addItemToArray<T>(item: T, array: T[]): boolean {\r\n  if (array.indexOf(item) === -1) {\r\n    array.push(item);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Remove an item from an list\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function removeItemFromArray<T>(item: T, array: T[]): boolean {\r\n  let index = -1;\r\n  if ((index = array.indexOf(item)) > -1) {\r\n    array.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * See if an array contains something\r\n */\r\nexport function contains(array: Array<any>, obj: any): boolean {\r\n  for (let i = 0; i < array.length; i++) {\r\n    if (array[i] === obj) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Used for exhaustive checks at compile time\r\n */\r\nexport function fail(message: never): never {\r\n  throw new Error(message);\r\n}\r\n\r\n/**\r\n * Create a promise that resolves after a certain number of milliseconds\r\n *\r\n * It is strongly recommended you pass the excalibur clock so delays are bound to the\r\n * excalibur clock which would be unaffected by stop/pause.\r\n * @param milliseconds\r\n * @param clock\r\n */\r\nexport function delay(milliseconds: number, clock?: Clock): Promise<void> {\r\n  const future = new Future<void>();\r\n  const schedule = clock?.schedule.bind(clock) ?? setTimeout;\r\n  schedule(() => {\r\n    future.resolve();\r\n  }, milliseconds);\r\n  return future.promise;\r\n}\r\n\r\n/**\r\n * Remove keys from object literals\r\n * @param object\r\n * @param keys\r\n */\r\nexport function omit<TObject extends Object, Keys extends (keyof TObject)>(object: TObject, keys: Keys[]) {\r\n  const newObj: Omit<TObject, Keys> = {} as any;\r\n  for (const key in object) {\r\n    if (!keys.includes(key as any)) {\r\n      (newObj as any)[key] = object[key];\r\n    }\r\n  }\r\n  return newObj;\r\n}","import { Matrix } from './matrix';\r\nimport { canonicalizeAngle, sign } from './util';\r\nimport { vec, Vector } from './vector';\r\n\r\n\r\nexport class AffineMatrix {\r\n  /**\r\n   * |         |         |          |\r\n   * | ------- | ------- | -------- |\r\n   * | data[0] | data[2] | data[4]  |\r\n   * | data[1] | data[3] | data[5]  |\r\n   * |   0     |    0    |    1     |\r\n   */\r\n  public data = new Float64Array(6);\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static identity(): AffineMatrix {\r\n    const mat = new AffineMatrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[4] = x;\r\n    mat.data[5] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[3] = sy;\r\n    mat._scale[0] = sx;\r\n    mat._scale[1] = sy;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle\r\n   * @param angleRadians\r\n   */\r\n  public static rotation(angleRadians: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = Math.cos(angleRadians);\r\n    mat.data[1] = Math.sin(angleRadians);\r\n    mat.data[2] = -Math.sin(angleRadians);\r\n    mat.data[3] = Math.cos(angleRadians);\r\n    return mat;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[4] = x;\r\n    this.data[5] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[4], this.data[5]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n\r\n    this.data[2] = cosine * a12 - sine * a11;\r\n    this.data[3] = cosine * a22 - sine * a21;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    // const a31 = 0;\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n    // const a32 = 0;\r\n\r\n    const a13 = this.data[4];\r\n    const a23 = this.data[5];\r\n    // const a33 = 1;\r\n\r\n    // Doesn't change z\r\n    this.data[4] = a11 * x + a12 * y + a13;\r\n    this.data[5] = a21 * x + a22 * y + a23;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n\r\n    this.data[2] = a12 * y;\r\n    this.data[3] = a22 * y;\r\n\r\n    this._scale[0] = x;\r\n    this._scale[1] = y;\r\n    return this;\r\n  }\r\n\r\n  public determinant() {\r\n    return this.data[0] * this.data[3] - this.data[1] * this.data[2];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public inverse(target?: AffineMatrix): AffineMatrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.determinant();\r\n    const inverseDet = 1 / det; // TODO zero check\r\n    const a = this.data[0];\r\n    const b = this.data[2];\r\n    const c = this.data[1];\r\n    const d = this.data[3];\r\n\r\n    const m = target || AffineMatrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[2] = -b * inverseDet;\r\n    m.data[3] = a * inverseDet;\r\n\r\n    const tx = this.data[4];\r\n    const ty = this.data[5];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[4] = -(tx * m.data[0] + ty * m.data[2]);\r\n    m.data[5] = -(tx * m.data[1] + ty * m.data[3]);\r\n\r\n    return m;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: AffineMatrix, dest?: AffineMatrix): AffineMatrix;\r\n  multiply(vectorOrMatrix: Vector | AffineMatrix, dest?: Vector | AffineMatrix): Vector | AffineMatrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[2] + this.data[4];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[3] + this.data[5];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as AffineMatrix) || new AffineMatrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      //  const a31 = 0;\r\n\r\n      const a12 = this.data[2];\r\n      const a22 = this.data[3];\r\n      //  const a32 = 0;\r\n\r\n      const a13 = this.data[4];\r\n      const a23 = this.data[5];\r\n      //  const a33 = 1;\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      //  const b31 = 0;\r\n\r\n      const b12 = other.data[2];\r\n      const b22 = other.data[3];\r\n      //  const b32 = 0;\r\n\r\n      const b13 = other.data[4];\r\n      const b23 = other.data[5];\r\n      //  const b33 = 1;\r\n\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21;// + a13 * b31; // zero\r\n      result.data[1] = a21 * b11 + a22 * b21;// + a23 * b31; // zero\r\n\r\n      result.data[2] = a11 * b12 + a12 * b22;// + a13 * b32; // zero\r\n      result.data[3] = a21 * b12 + a22 * b22;// + a23 * b32; // zero\r\n\r\n      result.data[4] = a11 * b13 + a12 * b23 + a13;// * b33; // one\r\n      result.data[5] = a21 * b13 + a22 * b23 + a23;// * b33; // one\r\n\r\n      const s = this.getScale();\r\n      result._scaleSignX = sign(s.x) * sign(result._scaleSignX);\r\n      result._scaleSignY = sign(s.y) * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Packed array of length 8, that contains 4 vertices, with 2 components each\r\n   * So: [x0, y0, x1, y1, x2, y2, x3, y3]\r\n   * @param quad\r\n   */\r\n  multiplyQuadInPlace(quad: number[]) {\r\n    const resultTopLeftX = quad[0] * this.data[0] + quad[1] * this.data[2] + this.data[4];\r\n    const resultTopLeftY = quad[0] * this.data[1] + quad[1] * this.data[3] + this.data[5];\r\n    quad[0] = resultTopLeftX;\r\n    quad[1] = resultTopLeftY;\r\n\r\n    const resultTopRightX = quad[2] * this.data[0] + quad[3] * this.data[2] + this.data[4];\r\n    const resultTopRightY = quad[2] * this.data[1] + quad[3] * this.data[3] + this.data[5];\r\n    quad[2] = resultTopRightX;\r\n    quad[3] = resultTopRightY;\r\n\r\n    const resultBottomLeftX = quad[4] * this.data[0] + quad[5] * this.data[2] + this.data[4];\r\n    const resultBottomLeftY = quad[4] * this.data[1] + quad[5] * this.data[3] + this.data[5];\r\n    quad[4] = resultBottomLeftX;\r\n    quad[5] = resultBottomLeftY;\r\n\r\n    const resultBottomRightX = quad[6] * this.data[0] + quad[7] * this.data[2] + this.data[4];\r\n    const resultBottomRightY = quad[6] * this.data[1] + quad[7] * this.data[3] + this.data[5];\r\n    quad[6] = resultBottomRightX;\r\n    quad[7] = resultBottomRightY;\r\n  }\r\n\r\n  to4x4() {\r\n    const mat = new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = this.data[2];\r\n    mat.data[5] = this.data[3];\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = this.data[4];\r\n    mat.data[13] = this.data[5];\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[2] = -sine * currentScale.x;\r\n    this.data[3] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xscale = vec(this.data[0], this.data[2]).distance();\r\n    return this._scaleSignX * xscale;\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yscale = vec(this.data[1], this.data[3]).distance();\r\n    return this._scaleSignY * yscale;\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scale = new Float64Array([1, 1]);\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (val === this._scale[0]) {\r\n      return;\r\n    }\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[2] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[2] = xscale.y * val;\r\n    this._scale[0] = val;\r\n  }\r\n\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (val === this._scale[1]) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[3] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[3] = yscale.y * val;\r\n    this._scale[1] = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return (\r\n      this.data[0] === 1 &&\r\n      this.data[1] === 0 &&\r\n      this.data[2] === 0 &&\r\n      this.data[3] === 1 &&\r\n      this.data[4] === 0 &&\r\n      this.data[5] === 0\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {AffineMatrix} Current matrix as identity\r\n   */\r\n  public reset(): AffineMatrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current [[AffineMatrix]]\r\n   */\r\n  public clone(dest?: AffineMatrix): AffineMatrix {\r\n    const mat = dest || new AffineMatrix();\r\n    mat.data.set(this.data);\r\n    return mat;\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[2]} ${this.data[4]}]\r\n[${this.data[1]} ${this.data[3]} ${this.data[5]}]\r\n[0 0 1]\r\n`;\r\n  }\r\n\r\n}","import { AffineMatrix } from '../../Math/affine-matrix';\n\nexport class TransformStack {\n  private _transforms: AffineMatrix[] = [];\n  private _currentTransform: AffineMatrix = AffineMatrix.identity();\n\n  public save(): void {\n    this._transforms.push(this._currentTransform);\n    this._currentTransform = this._currentTransform.clone();\n  }\n\n  public restore(): void {\n    this._currentTransform = this._transforms.pop();\n  }\n\n  public translate(x: number, y: number): AffineMatrix {\n    return this._currentTransform.translate(x, y);\n  }\n\n  public rotate(angle: number): AffineMatrix {\n    return this._currentTransform.rotate(angle);\n  }\n\n  public scale(x: number, y: number): AffineMatrix {\n    return this._currentTransform.scale(x, y);\n  }\n\n  public set current(matrix: AffineMatrix) {\n    this._currentTransform = matrix;\n  }\n\n  public get current(): AffineMatrix {\n    return this._currentTransform;\n  }\n}\n","import { Color } from '../../Color';\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\nimport { Material } from './material';\n\nexport class StateStack {\n  public current: ExcaliburGraphicsContextState = this._getDefaultState();\n  private _states: ExcaliburGraphicsContextState[] = [];\n\n  private _getDefaultState() {\n    return {\n      opacity: 1,\n      z: 0,\n      tint: Color.White,\n      material: null as Material\n    };\n  }\n\n  private _cloneState() {\n    return {\n      opacity: this.current.opacity,\n      z: this.current.z,\n      tint: this.current.tint.clone(),\n      material: this.current.material // TODO is this going to cause problems when cloning\n    };\n  }\n\n  public save(): void {\n    this._states.push(this.current);\n    this.current = this._cloneState();\n  }\n\n  public restore(): void {\n    this.current = this._states.pop();\n  }\n}\n","import { Loadable } from '../Interfaces/Loadable';\r\nimport { Logger } from '../Util/Log';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport type ResourceEvents = {\r\n  complete: any,\r\n  load: ProgressEvent<XMLHttpRequestEventTarget>,\r\n  loadstart: ProgressEvent<XMLHttpRequestEventTarget>,\r\n  progress: ProgressEvent<XMLHttpRequestEventTarget>,\r\n  error: ProgressEvent<XMLHttpRequestEventTarget>\r\n}\r\n\r\nexport const ResourceEvents = {\r\n  Complete: 'complete',\r\n  Load: 'load',\r\n  LoadStart: 'loadstart',\r\n  Progress: 'progress',\r\n  Error: 'error'\r\n};\r\n\r\n/**\r\n * The [[Resource]] type allows games built in Excalibur to load generic resources.\r\n * For any type of remote resource it is recommended to use [[Resource]] for preloading.\r\n */\r\nexport class Resource<T> implements Loadable<T> {\r\n  public data: T = null;\r\n  public logger: Logger = Logger.getInstance();\r\n  public events = new EventEmitter();\r\n\r\n  /**\r\n   * @param path          Path to the remote resource\r\n   * @param responseType  The type to expect as a response: \"\" | \"arraybuffer\" | \"blob\" | \"document\" | \"json\" | \"text\";\r\n   * @param bustCache     Whether or not to cache-bust requests\r\n   */\r\n  constructor(\r\n    public path: string,\r\n    public responseType: '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text',\r\n    public bustCache: boolean = false\r\n  ) {}\r\n\r\n  /**\r\n   * Returns true if the Resource is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    return this.data !== null;\r\n  }\r\n\r\n\r\n  private _cacheBust(uri: string): string {\r\n    const query: RegExp = /\\?\\w*=\\w*/;\r\n    if (query.test(uri)) {\r\n      uri += '&__=' + Date.now();\r\n    } else {\r\n      uri += '?__=' + Date.now();\r\n    }\r\n    return uri;\r\n  }\r\n  /**\r\n   * Begin loading the resource and returns a promise to be resolved on completion\r\n   */\r\n  public load(): Promise<T> {\r\n    return new Promise((resolve, reject) => {\r\n      // Exit early if we already have data\r\n      if (this.data !== null) {\r\n        this.logger.debug('Already have data for resource', this.path);\r\n        this.events.emit('complete', this.data as any);\r\n        resolve(this.data);\r\n        return;\r\n      }\r\n\r\n      const request = new XMLHttpRequest();\r\n      request.open('GET', this.bustCache ? this._cacheBust(this.path) : this.path, true);\r\n      request.responseType = this.responseType;\r\n      request.addEventListener('loadstart', (e) => this.events.emit('loadstart', e as any));\r\n      request.addEventListener('progress', (e) => this.events.emit('progress', e as any));\r\n      request.addEventListener('error', (e) => this.events.emit('error', e as any));\r\n      request.addEventListener('load', (e) => this.events.emit('load', e as any));\r\n      request.addEventListener('load', () => {\r\n        // XHR on file:// success status is 0, such as with PhantomJS\r\n        if (request.status !== 0 && request.status !== 200) {\r\n          this.logger.error('Failed to load resource ', this.path, ' server responded with error code', request.status);\r\n          this.events.emit('error', request.response);\r\n          reject(new Error(request.statusText));\r\n          return;\r\n        }\r\n\r\n        this.data = request.response;\r\n        this.events.emit('complete', this.data as any);\r\n        this.logger.debug('Completed loading resource', this.path);\r\n        resolve(this.data);\r\n      });\r\n      request.send();\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Watch an object with a proxy, only fires if property value is different\r\n */\r\nexport function watch<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        if ((obj as any)[prop] !== value) {\r\n          (obj as any)[prop] = value;\r\n          // Avoid watching private junk\r\n          if (typeof prop === 'string') {\r\n            if (prop[0] !== '_') {\r\n              change(obj);\r\n            }\r\n          }\r\n        }\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n\r\nconst createHandler = <T>(path: string[] = [], change: (type: T) => any, typeType: T) => ({\r\n  get: (target: T, key: string): any => {\r\n    if (key === '__isProxy') {\r\n      return true;\r\n    }\r\n    if (typeof (target as any)[key] === 'object' && (target as any)[key] != null) {\r\n      return new Proxy(\r\n        (target as any)[key],\r\n        createHandler<any>([...path, key as string], change, typeType)\r\n      );\r\n    }\r\n    return (target as any)[key];\r\n  },\r\n  set: (target: T, key: string, value: any) =>  {\r\n    if (typeof key === 'string') {\r\n      if (key[0] !== '_') {\r\n        change(typeType);\r\n      }\r\n    }\r\n    (target as any)[key] = value;\r\n    return true;\r\n  }\r\n});\r\n\r\n/**\r\n *\r\n */\r\nexport function watchDeep<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, createHandler<T>([], change, type));\r\n  }\r\n  return type;\r\n}\r\n\r\n/**\r\n * Watch an object with a proxy, fires change on any property value change\r\n */\r\nexport function watchAny<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        (obj as any)[prop] = value;\r\n        // Avoid watching private junk\r\n        if (typeof prop === 'string') {\r\n          if (prop[0] !== '_') {\r\n            change(obj);\r\n          }\r\n        }\r\n\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { watch } from '../Util/Watch';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface GraphicOptions {\r\n  /**\r\n   * The width of the graphic\r\n   */\r\n  width?: number;\r\n  /**\r\n   * The height of the graphic\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Should the graphic be flipped horizontally\r\n   */\r\n  flipHorizontal?: boolean;\r\n  /**\r\n   * Should the graphic be flipped vertically\r\n   */\r\n  flipVertical?: boolean;\r\n  /**\r\n   * The rotation of the graphic\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * The scale of the graphic\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * The opacity of the graphic between (0 -1)\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * The tint of the graphic, this color will be multiplied by the original pixel colors\r\n   */\r\n  tint?: Color;\r\n  /**\r\n   * The origin of the drawing in pixels to use when applying transforms, by default it will be the center of the image in pixels\r\n   */\r\n  origin?: Vector;\r\n}\r\n\r\n/**\r\n * A Graphic is the base Excalibur primitive for something that can be drawn to the [[ExcaliburGraphicsContext]].\r\n * [[Sprite]], [[Animation]], [[GraphicsGroup]], [[Canvas]], [[Rectangle]], [[Circle]], and [[Polygon]] all derive from the\r\n * [[Graphic]] abstract class.\r\n *\r\n * Implementors of a Graphic must override the abstract [[Graphic._drawImage]] method to render an image to the graphics context. Graphic\r\n * handles all the position, rotation, and scale transformations in [[Graphic._preDraw]] and [[Graphic._postDraw]]\r\n */\r\nexport abstract class Graphic {\r\n  private static _ID: number = 0;\r\n  readonly id = Graphic._ID++;\r\n\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public tint: Color = null;\r\n\r\n  private _transformStale = true;\r\n  public isStale() {\r\n    return this._transformStale;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets wether to show debug information about the graphic\r\n   */\r\n  public showDebug: boolean = false;\r\n\r\n\r\n  private _flipHorizontal = false;\r\n  /**\r\n   * Gets or sets the flipHorizontal, which will flip the graphic horizontally (across the y axis)\r\n   */\r\n  public get flipHorizontal(): boolean {\r\n    return this._flipHorizontal;\r\n  }\r\n\r\n  public set flipHorizontal(value: boolean) {\r\n    this._flipHorizontal = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _flipVertical = false;\r\n  /**\r\n   * Gets or sets the flipVertical, which will flip the graphic vertically (across the x axis)\r\n   */\r\n  public get flipVertical(): boolean {\r\n    return this._flipVertical;\r\n  }\r\n\r\n  public set flipVertical(value: boolean) {\r\n    this._flipVertical = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _rotation = 0;\r\n  /**\r\n   * Gets or sets the rotation of the graphic\r\n   */\r\n  public get rotation(): number {\r\n    return this._rotation;\r\n  }\r\n\r\n  public set rotation(value: number) {\r\n    this._rotation = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the opacity of the graphic, 0 is transparent, 1 is solid (opaque).\r\n   */\r\n  public opacity: number = 1;\r\n\r\n  private _scale = Vector.One;\r\n  /**\r\n   * Gets or sets the scale of the graphic, this affects the width and\r\n   */\r\n  public get scale() {\r\n    return this._scale;\r\n  }\r\n\r\n  public set scale(value: Vector) {\r\n    this._scale = watch(value, () => {\r\n      this._transformStale = true;\r\n    });\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _origin: Vector | null = null;\r\n  /**\r\n   * Gets or sets the origin of the graphic, if not set the center of the graphic is the origin\r\n   */\r\n  public get origin(): Vector | null {\r\n    return this._origin;\r\n  }\r\n\r\n  public set origin(value: Vector | null) {\r\n    this._origin = watch(value, () => {\r\n      this._transformStale = true;\r\n    });\r\n    this._transformStale = true;\r\n  }\r\n\r\n  constructor(options?: GraphicOptions) {\r\n    if (options) {\r\n      this.origin = options.origin ?? this.origin;\r\n      this.flipHorizontal = options.flipHorizontal ?? this.flipHorizontal;\r\n      this.flipVertical = options.flipVertical ?? this.flipVertical;\r\n      this.rotation = options.rotation ?? this.rotation;\r\n      this.opacity = options.opacity ?? this.opacity;\r\n      this.scale = options.scale ?? this.scale;\r\n      this.tint = options.tint ?? this.tint;\r\n    }\r\n  }\r\n\r\n  public cloneGraphicOptions(): GraphicOptions {\r\n    return {\r\n      width: this.width / this.scale.x,\r\n      height: this.height / this.scale.y,\r\n      origin: this.origin ? this.origin.clone() : null,\r\n      flipHorizontal: this.flipHorizontal,\r\n      flipVertical: this.flipVertical,\r\n      rotation: this.rotation,\r\n      opacity: this.opacity,\r\n      scale: this.scale ? this.scale.clone() : null,\r\n      tint: this.tint ? this.tint.clone(): null\r\n    };\r\n  }\r\n\r\n  private _width: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the width of the graphic (always positive)\r\n   */\r\n  public get width() {\r\n    return Math.abs(this._width * this.scale.x);\r\n  }\r\n\r\n  private _height: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the height of the graphic (always positive)\r\n   */\r\n  public get height() {\r\n    return Math.abs(this._height * this.scale.y);\r\n  }\r\n\r\n  public set width(value: number) {\r\n    this._width = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  public set height(value: number) {\r\n    this._height = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets a copy of the bounds in pixels occupied by the graphic on the the screen. This includes scale.\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return BoundingBox.fromDimension(this.width, this.height, Vector.Zero);\r\n  }\r\n\r\n  /**\r\n   * Draw the whole graphic to the context including transform\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    this._preDraw(ex, x, y);\r\n    this._drawImage(ex, 0, 0);\r\n    this._postDraw(ex);\r\n  }\r\n\r\n  /**\r\n   * Meant to be overridden by the graphic implementation to draw the underlying image (HTMLCanvasElement or HTMLImageElement)\r\n   * to the graphics context without transform. Transformations like position, rotation, and scale are handled by [[Graphic._preDraw]]\r\n   * and [[Graphic._postDraw]]\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected abstract _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void;\r\n\r\n  /**\r\n   * Apply affine transformations to the graphics context to manipulate the graphic before [[Graphic._drawImage]]\r\n   * @param ex\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    ex.save();\r\n    ex.translate(x, y);\r\n    if (this._transformStale) {\r\n      this.transform.reset();\r\n      this.transform.scale(Math.abs(this.scale.x), Math.abs(this.scale.y));\r\n      this._rotate(this.transform);\r\n      this._flip(this.transform);\r\n      this._transformStale = false;\r\n    }\r\n    ex.multiply(this.transform);\r\n    // it is important to multiply alphas so graphics respect the current context\r\n    ex.opacity = ex.opacity * this.opacity;\r\n    if (this.tint) {\r\n      ex.tint = this.tint;\r\n    }\r\n  }\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    const scaleDirX = this.scale.x > 0 ? 1 : -1;\r\n    const scaleDirY = this.scale.y > 0 ? 1 : -1;\r\n    const origin = this.origin ?? vec(this.width / 2, this.height / 2);\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    // This is for handling direction changes 1 or -1, that way we don't have mismatched translates()\r\n    ex.scale(scaleDirX, scaleDirY);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, this.height / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply any additional work after [[Graphic._drawImage]] and restore the context state.\r\n   * @param ex\r\n   */\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    if (this.showDebug) {\r\n      ex.debug.drawRect(0, 0, this.width, this.height);\r\n    }\r\n    ex.restore();\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of the graphic that has the same properties\r\n   */\r\n  abstract clone(): Graphic;\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ImageSource } from './ImageSource';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport type SourceView = { x: number; y: number; width: number; height: number };\r\nexport type DestinationSize = { width: number; height: number };\r\n\r\nexport interface SpriteOptions {\r\n  /**\r\n   * Image to create a sprite from\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * By default the source is the entire dimension of the [[ImageSource]]\r\n   */\r\n  sourceView?: { x: number; y: number; width: number; height: number };\r\n  /**\r\n   * By default the size of the final sprite is the size of the [[ImageSource]]\r\n   */\r\n  destSize?: { width: number; height: number };\r\n}\r\n\r\nexport class Sprite extends Graphic {\r\n  private _logger = Logger.getInstance();\r\n  public image: ImageSource;\r\n  public sourceView: SourceView;\r\n  public destSize: DestinationSize;\r\n  private _dirty = true;\r\n\r\n  public static from(image: ImageSource): Sprite {\r\n    return new Sprite({\r\n      image: image\r\n    });\r\n  }\r\n\r\n  constructor(options: GraphicOptions & SpriteOptions) {\r\n    super(options);\r\n    this.image = options.image;\r\n    const { width, height } = options;\r\n    this.sourceView = options.sourceView ?? { x: 0, y: 0, width: width ?? 0, height: height ?? 0 };\r\n    this.destSize = options.destSize ?? { width: width ?? 0, height: height ?? 0 };\r\n    this._updateSpriteDimensions();\r\n    // Fire when loaded\r\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n    this.image.ready.then(() => {\r\n      this._updateSpriteDimensions();\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    return Math.abs(this.destSize.width * this.scale.x);\r\n  }\r\n\r\n  public override get height(): number {\r\n    return Math.abs(this.destSize.height * this.scale.y);\r\n  }\r\n\r\n  public override set width(newWidth: number) {\r\n    newWidth /= Math.abs(this.scale.x);\r\n    this.destSize.width = newWidth;\r\n    super.width = Math.ceil(this.destSize.width);\r\n  }\r\n\r\n  public override set height(newHeight: number) {\r\n    newHeight /= Math.abs(this.scale.y);\r\n    this.destSize.height = newHeight;\r\n    super.height = Math.ceil(this.destSize.height);\r\n  }\r\n\r\n  private _updateSpriteDimensions() {\r\n    const { width: nativeWidth, height: nativeHeight } = this.image;\r\n    // This code uses || to avoid 0's\r\n    // If the source is not specified, use the native dimension\r\n    this.sourceView.width = this.sourceView?.width || nativeWidth;\r\n    this.sourceView.height = this.sourceView?.height || nativeHeight;\r\n\r\n    // If the destination is not specified, use the source if specified, then native\r\n    this.destSize.width = this.destSize?.width || this.sourceView?.width || nativeWidth;\r\n    this.destSize.height = this.destSize?.height || this.sourceView?.height || nativeHeight;\r\n\r\n    this.width = Math.ceil(this.destSize.width) * this.scale.x;\r\n    this.height = Math.ceil(this.destSize.height) * this.scale.y;\r\n  }\r\n\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded() && this._dirty) {\r\n      this._dirty = false;\r\n      this._updateSpriteDimensions();\r\n    }\r\n    super._preDraw(ex, x, y);\r\n  }\r\n\r\n  public _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded()) {\r\n      ex.drawImage(\r\n        this.image.image,\r\n        this.sourceView.x,\r\n        this.sourceView.y,\r\n        this.sourceView.width,\r\n        this.sourceView.height,\r\n        x,\r\n        y,\r\n        this.destSize.width,\r\n        this.destSize.height\r\n      );\r\n    } else {\r\n      this._logger.warnOnce(\r\n        `ImageSource ${this.image.path}` +\r\n        ` is not yet loaded and won't be drawn. Please call .load() or include in a Loader.\\n\\n` +\r\n        `Read https://excaliburjs.com/docs/imagesource for more information.`\r\n      );\r\n    }\r\n  }\r\n\r\n  public clone(): Sprite {\r\n    return new Sprite({\r\n      image: this.image,\r\n      sourceView: { ...this.sourceView },\r\n      destSize: { ...this.destSize },\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n}\r\n","\r\n/**\r\n * Describes the different image filtering modes\r\n */\r\nexport enum ImageFiltering {\r\n\r\n  /**\r\n   * Pixel is useful when you do not want smoothing aka antialiasing applied to your graphics.\r\n   *\r\n   * Useful for Pixel art aesthetics.\r\n   */\r\n  Pixel = 'Pixel',\r\n\r\n  /**\r\n   * Blended is useful when you have high resolution artwork and would like it blended and smoothed\r\n   */\r\n  Blended = 'Blended'\r\n}\r\n\r\n/**\r\n * Parse the image filtering attribute value, if it doesn't match returns null\r\n */\r\nexport function parseImageFiltering(val: string): ImageFiltering | null {\r\n  switch (val) {\r\n    case ImageFiltering.Pixel: return ImageFiltering.Pixel;\r\n    case ImageFiltering.Blended: return ImageFiltering.Blended;\r\n    default: return null;\r\n  }\r\n}","\r\n/**\r\n * Describes the different image wrapping modes\r\n */\r\nexport enum ImageWrapping {\r\n\r\n  Clamp = 'Clamp',\r\n\r\n  Repeat = 'Repeat',\r\n\r\n  Mirror = 'Mirror'\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function parseImageWrapping(val: string): ImageWrapping {\r\n  switch (val) {\r\n    case ImageWrapping.Clamp: return ImageWrapping.Clamp;\r\n    case ImageWrapping.Repeat: return ImageWrapping.Repeat;\r\n    case ImageWrapping.Mirror: return ImageWrapping.Mirror;\r\n    default: return ImageWrapping.Clamp;\r\n  }\r\n}","import { Logger } from '../../Util/Log';\r\nimport { ImageFiltering } from '../Filtering';\r\nimport { ImageSourceOptions, ImageWrapConfiguration } from '../ImageSource';\r\nimport { ImageWrapping } from '../Wrapping';\r\nimport { HTMLImageSource } from './ExcaliburGraphicsContext';\r\n\r\n/**\r\n * Manages loading image sources into webgl textures, a unique id is associated with all sources\r\n */\r\nexport class TextureLoader {\r\n  private static _LOGGER = Logger.getInstance();\r\n\r\n  constructor(gl: WebGL2RenderingContext) {\r\n    this._gl = gl;\r\n    TextureLoader._MAX_TEXTURE_SIZE = gl.getParameter(gl.MAX_TEXTURE_SIZE);\r\n  }\r\n\r\n  public dispose() {\r\n    for (const [image] of this._textureMap) {\r\n      this.delete(image);\r\n    }\r\n    this._textureMap.clear();\r\n    this._gl = null;\r\n  }\r\n\r\n  /**\r\n   * Sets the default filtering for the Excalibur texture loader, default [[ImageFiltering.Blended]]\r\n   */\r\n  public static filtering: ImageFiltering = ImageFiltering.Blended;\r\n  public static wrapping: ImageWrapConfiguration = {x: ImageWrapping.Clamp, y: ImageWrapping.Clamp};\r\n\r\n  private _gl: WebGL2RenderingContext;\r\n\r\n  private _textureMap = new Map<HTMLImageSource, WebGLTexture>();\r\n\r\n  private static _MAX_TEXTURE_SIZE: number = 4096;\r\n\r\n  /**\r\n   * Get the WebGL Texture from a source image\r\n   * @param image\r\n   */\r\n  public get(image: HTMLImageSource): WebGLTexture {\r\n    return this._textureMap.get(image);\r\n  }\r\n\r\n  /**\r\n   * Returns whether a source image has been loaded as a texture\r\n   * @param image\r\n   */\r\n  public has(image: HTMLImageSource): boolean {\r\n    return this._textureMap.has(image);\r\n  }\r\n\r\n  /**\r\n   * Loads a graphic into webgl and returns it's texture info, a webgl context must be previously registered\r\n   * @param image Source graphic\r\n   * @param options {ImageSourceOptions} Optionally configure the ImageFiltering and ImageWrapping mode to apply to the loaded texture\r\n   * @param forceUpdate Optionally force a texture to be reloaded, useful if the source graphic has changed\r\n   */\r\n  public load(image: HTMLImageSource, options?: ImageSourceOptions, forceUpdate = false): WebGLTexture {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = this._gl;\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n\r\n    const { filtering, wrapping } = {...options};\r\n\r\n    let tex: WebGLTexture = null;\r\n    // If reuse the texture if it's from the same source\r\n    if (this.has(image)) {\r\n      tex = this.get(image);\r\n    }\r\n\r\n    // Update existing webgl texture and return early\r\n    if (tex) {\r\n      if (forceUpdate) {\r\n        gl.bindTexture(gl.TEXTURE_2D, tex);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n      }\r\n      return tex;\r\n    }\r\n\r\n    // No texture exists create a new one\r\n    tex = gl.createTexture();\r\n\r\n    // TODO implement texture gc with weakmap and timer\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n\r\n    gl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n    gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\r\n\r\n    let wrappingConfig: ImageWrapConfiguration;\r\n    if (wrapping) {\r\n      if (typeof wrapping === 'string') {\r\n        wrappingConfig = {\r\n          x: wrapping,\r\n          y: wrapping\r\n        };\r\n      } else {\r\n        wrappingConfig = {\r\n          x: wrapping.x,\r\n          y: wrapping.y\r\n        };\r\n      }\r\n    }\r\n    const { x: xWrap, y: yWrap} = (wrappingConfig ?? TextureLoader.wrapping);\r\n    switch (xWrap) {\r\n      case ImageWrapping.Clamp:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        break;\r\n      case ImageWrapping.Repeat:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\r\n        break;\r\n      case ImageWrapping.Mirror:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.MIRRORED_REPEAT);\r\n        break;\r\n      default:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    }\r\n    switch (yWrap) {\r\n      case ImageWrapping.Clamp:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        break;\r\n      case ImageWrapping.Repeat:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\r\n        break;\r\n      case ImageWrapping.Mirror:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.MIRRORED_REPEAT);\r\n        break;\r\n      default:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n    }\r\n\r\n    // NEAREST for pixel art, LINEAR for hi-res\r\n    const filterMode = filtering ?? TextureLoader.filtering;\r\n\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n\r\n    this._textureMap.set(image, tex);\r\n    return tex;\r\n  }\r\n\r\n  public delete(image: HTMLImageSource): void {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = this._gl;\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n\r\n    let tex: WebGLTexture = null;\r\n    if (this.has(image)) {\r\n      tex = this.get(image);\r\n      gl.deleteTexture(tex);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Takes an image and returns if it meets size criteria for hardware\r\n   * @param image\r\n   * @returns if the image will be supported at runtime\r\n   */\r\n  public static checkImageSizeSupportedAndLog(image: HTMLImageSource) {\r\n    const originalSrc = image.dataset.originalSrc ?? 'internal canvas bitmap';\r\n    if (image.width > TextureLoader._MAX_TEXTURE_SIZE || image.height > TextureLoader._MAX_TEXTURE_SIZE) {\r\n      TextureLoader._LOGGER.error(\r\n        `The image [${originalSrc}] provided to Excalibur is too large for the device's maximum texture size of `+\r\n        `(${TextureLoader._MAX_TEXTURE_SIZE}x${TextureLoader._MAX_TEXTURE_SIZE}) please resize to an image `\r\n        +`for excalibur to render properly.\\n\\nImages will likely render as black rectangles.\\n\\n`+\r\n        `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`);\r\n      return false;\r\n    } else if (image.width > 4096 || image.height > 4096) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits\r\n      TextureLoader._LOGGER.warn(\r\n        `The image [${originalSrc}] provided to excalibur is too large may not work on all mobile devices, `+\r\n        `it is recommended you resize images to a maximum (4096x4096).\\n\\n` +\r\n        `Images will likely render as black rectangles on some mobile platforms.\\n\\n` +\r\n        `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`);\r\n    }\r\n    return true;\r\n  }\r\n}\r\n","import { Resource } from '../Resources/Resource';\r\nimport { Sprite } from './Sprite';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { Logger } from '../Util/Log';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { Future } from '../Util/Future';\r\nimport { TextureLoader } from '../Graphics/Context/texture-loader';\r\nimport { ImageWrapping } from './Wrapping';\r\n\r\nexport interface ImageSourceOptions {\r\n  filtering?: ImageFiltering;\r\n  wrapping?: ImageWrapConfiguration | ImageWrapping;\r\n  bustCache?: boolean;\r\n}\r\n\r\nexport interface ImageWrapConfiguration {\r\n  x: ImageWrapping;\r\n  y: ImageWrapping;\r\n}\r\n\r\nexport const ImageSourceAttributeConstants = {\r\n  Filtering: 'filtering',\r\n  WrappingX: 'wrapping-x',\r\n  WrappingY: 'wrapping-y'\r\n} as const;\r\n\r\nexport class ImageSource implements Loadable<HTMLImageElement> {\r\n  private _logger = Logger.getInstance();\r\n  private _resource: Resource<Blob>;\r\n  public filtering: ImageFiltering;\r\n  public wrapping: ImageWrapConfiguration;\r\n\r\n  /**\r\n   * The original size of the source image in pixels\r\n   */\r\n  public get width() {\r\n    return this.image.naturalWidth;\r\n  }\r\n\r\n  /**\r\n   * The original height of the source image in pixels\r\n   */\r\n  public get height() {\r\n    return this.image.naturalHeight;\r\n  }\r\n\r\n  private _src: string;\r\n  /**\r\n   * Returns true if the Texture is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    if (!this._src) {\r\n      // this boosts speed of access\r\n      this._src = this.data.src;\r\n    }\r\n    return !!this._src;\r\n  }\r\n\r\n  /**\r\n   * Access to the underlying html image element\r\n   */\r\n  public data: HTMLImageElement = new Image();\r\n  public get image(): HTMLImageElement {\r\n    return this.data;\r\n  }\r\n\r\n  private _readyFuture = new Future<HTMLImageElement>();\r\n  /**\r\n   * Promise the resolves when the image is loaded and ready for use, does not initiate loading\r\n   */\r\n  public ready: Promise<HTMLImageElement> = this._readyFuture.promise;\r\n\r\n  public readonly path: string;\r\n\r\n  /**\r\n   * The path to the image, can also be a data url like 'data:image/'\r\n   * @param path {string} Path to the image resource relative from the HTML document hosting the game, or absolute\r\n   * @param options\r\n   */\r\n  constructor(path: string, options?: ImageSourceOptions);\r\n  /**\r\n   * The path to the image, can also be a data url like 'data:image/'\r\n   * @param path {string} Path to the image resource relative from the HTML document hosting the game, or absolute\r\n   * @param bustCache {boolean} Should excalibur add a cache busting querystring?\r\n   * @param filtering {ImageFiltering} Optionally override the image filtering set by [[EngineOptions.antialiasing]]\r\n   */\r\n  constructor(path: string, bustCache: boolean, filtering?: ImageFiltering);\r\n  constructor(path: string, bustCacheOrOptions: boolean | ImageSourceOptions, filtering?: ImageFiltering) {\r\n    this.path = path;\r\n    let bustCache = false;\r\n    let wrapping: ImageWrapConfiguration | ImageWrapping;\r\n    if (typeof bustCacheOrOptions === 'boolean') {\r\n      bustCache = bustCacheOrOptions;\r\n    } else {\r\n      ({ filtering, wrapping, bustCache } = {...bustCacheOrOptions});\r\n    }\r\n    this._resource = new Resource(path, 'blob', bustCache);\r\n    this.filtering = filtering ?? this.filtering;\r\n    if (typeof wrapping === 'string') {\r\n      this.wrapping = {\r\n        x: wrapping,\r\n        y: wrapping\r\n      };\r\n    } else {\r\n      this.wrapping = wrapping ?? this.wrapping;\r\n    }\r\n    if (path.endsWith('.svg') || path.endsWith('.gif')) {\r\n      this._logger.warn(`Image type is not fully supported, you may have mixed results ${path}. Fully supported: jpg, bmp, and png`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an ImageSource from and HTML <image> tag element\r\n   * @param image\r\n   */\r\n  static fromHtmlImageElement(image: HTMLImageElement, options?: ImageSourceOptions) {\r\n    const imageSource = new ImageSource('');\r\n    imageSource._src = 'image-element';\r\n    imageSource.data = image;\r\n    imageSource.data.setAttribute('data-original-src', 'image-element');\r\n\r\n    if (options?.filtering) {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, options?.filtering);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, ImageFiltering.Blended);\r\n    }\r\n\r\n    if (options?.wrapping) {\r\n      let wrapping: ImageWrapConfiguration;\r\n      if (typeof options.wrapping === 'string') {\r\n        wrapping = {\r\n          x: options.wrapping,\r\n          y: options.wrapping\r\n        };\r\n      } else {\r\n        wrapping = {\r\n          x: options.wrapping.x,\r\n          y: options.wrapping.y\r\n        };\r\n      }\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, wrapping.x);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, wrapping.y);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, ImageWrapping.Clamp);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, ImageWrapping.Clamp);\r\n    }\r\n\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n    imageSource._readyFuture.resolve(image);\r\n    return imageSource;\r\n  }\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  /**\r\n   * Begins loading the image and returns a promise that resolves when the image is loaded\r\n   */\r\n  async load(): Promise<HTMLImageElement> {\r\n    if (this.isLoaded()) {\r\n      return this.data;\r\n    }\r\n    try {\r\n      // Load base64 or blob if needed\r\n      let url: string;\r\n      if (!this.path.includes('data:image/')) {\r\n        const blob = await this._resource.load();\r\n        url = URL.createObjectURL(blob);\r\n      } else {\r\n        url = this.path;\r\n      }\r\n\r\n      // Decode the image\r\n      const image = new Image();\r\n      // Use Image.onload over Image.decode()\r\n      // https://bugs.chromium.org/p/chromium/issues/detail?id=1055828#c7\r\n      // Otherwise chrome will throw still Image.decode() failures for large textures\r\n      const loadedFuture = new Future<void>();\r\n      image.onload = () => loadedFuture.resolve();\r\n      image.src = url;\r\n      image.setAttribute('data-original-src', this.path);\r\n\r\n      await loadedFuture.promise;\r\n\r\n      // Set results\r\n      // We defer loading the texture into webgl until the first draw that way we avoid a singleton\r\n      // and for the multi-engine case the texture needs to be created in EACH webgl context to work\r\n      // See image-renderer.ts draw()\r\n      this.data = image;\r\n\r\n      // emit warning if potentially too big\r\n      TextureLoader.checkImageSizeSupportedAndLog(this.data);\r\n    } catch (error) {\r\n      throw `Error loading ImageSource from path '${this.path}' with error [${error.message}]`;\r\n    }\r\n    // Do a bad thing to pass the filtering as an attribute\r\n    this.data.setAttribute(ImageSourceAttributeConstants.Filtering, this.filtering);\r\n    this.data.setAttribute(ImageSourceAttributeConstants.WrappingX, this.wrapping?.x ?? ImageWrapping.Clamp);\r\n    this.data.setAttribute(ImageSourceAttributeConstants.WrappingY, this.wrapping?.y ?? ImageWrapping.Clamp);\r\n\r\n    // todo emit complete\r\n    this._readyFuture.resolve(this.data);\r\n    return this.data;\r\n  }\r\n\r\n  /**\r\n   * Build a sprite from this ImageSource\r\n   */\r\n  public toSprite(): Sprite {\r\n    return Sprite.from(this);\r\n  }\r\n\r\n  /**\r\n   * Unload images from memory\r\n   */\r\n  unload(): void {\r\n    this.data = new Image();\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\nimport { Logger } from '../Util/Log';\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\nimport { FontRenderer } from './FontCommon';\nimport { Graphic, GraphicOptions } from './Graphic';\nimport { Sprite } from './Sprite';\nimport { SpriteSheet } from './SpriteSheet';\nimport { BoundingBox } from '../Collision/BoundingBox';\nimport { Color } from '../Color';\n\nexport interface SpriteFontOptions {\n  /**\n   * Alphabet string in spritesheet order (default is row column order)\n   * example: 'abcdefghijklmnopqrstuvwxyz'\n   */\n  alphabet: string;\n  /**\n   * [[SpriteSheet]] to source character sprites from\n   */\n  spriteSheet: SpriteSheet;\n  /**\n   * Optionally ignore case in the supplied text;\n   */\n  caseInsensitive?: boolean;\n  /**\n   * Optionally override the text line height, useful for multiline text. If unset will use default.\n   */\n  lineHeight?: number | undefined;\n  /**\n   * Optionally adjust the spacing between character sprites\n   */\n  spacing?: number;\n  /**\n   * Optionally specify a \"shadow\"\n   */\n  shadow?: { offset: Vector };\n}\n\nexport class SpriteFont extends Graphic implements FontRenderer {\n  private _text: string = '';\n  public alphabet: string = '';\n  public spriteSheet: SpriteSheet;\n\n  public shadow: { offset: Vector } = null;\n  public caseInsensitive = false;\n  public spacing: number = 0;\n  public lineHeight: number | undefined = undefined;\n\n  private _logger = Logger.getInstance();\n\n  constructor(options: SpriteFontOptions & GraphicOptions) {\n    super(options);\n    const { alphabet, spriteSheet, caseInsensitive, spacing, shadow, lineHeight } = options;\n    this.alphabet = alphabet;\n    this.spriteSheet = spriteSheet;\n    this.caseInsensitive = caseInsensitive ?? this.caseInsensitive;\n    this.spacing = spacing ?? this.spacing;\n    this.shadow = shadow ?? this.shadow;\n    this.lineHeight = lineHeight ?? this.lineHeight;\n  }\n\n  private _getCharacterSprites(text: string): Sprite[] {\n    const results: Sprite[] = [];\n    // handle case insensitive\n    const textToRender = this.caseInsensitive ? text.toLocaleLowerCase() : text;\n    const alphabet = this.caseInsensitive ? this.alphabet.toLocaleLowerCase() : this.alphabet;\n\n    // for each letter in text\n    for (let letterIndex = 0; letterIndex < textToRender.length; letterIndex++) {\n      // find the sprite index in alphabet , if there is an error pick the first\n      const letter = textToRender[letterIndex];\n      let spriteIndex = alphabet.indexOf(letter);\n      if (spriteIndex === -1) {\n        spriteIndex = 0;\n        this._logger.warnOnce(`SpriteFont - Cannot find letter '${letter}' in configured alphabet '${alphabet}'.`);\n        this._logger.warnOnce('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\n      }\n\n      const letterSprite = this.spriteSheet.sprites[spriteIndex];\n      if (letterSprite) {\n        results.push(letterSprite);\n      } else {\n        this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${letter}' at index '${spriteIndex}' in configured SpriteSheet`);\n        this._logger.warnOnce('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\n      }\n    }\n    return results;\n  }\n\n  public measureText(text: string, maxWidth?: number): BoundingBox {\n    const lines = this._getLinesFromText(text, maxWidth);\n    const maxWidthLine = lines.reduce((a, b) => {\n      return a.length > b.length ? a : b;\n    });\n    const sprites = this._getCharacterSprites(maxWidthLine);\n    let width = 0;\n    let height = 0;\n    for (const sprite of sprites) {\n      width += sprite.width + this.spacing;\n      height = Math.max(height, sprite.height);\n    }\n    return BoundingBox.fromDimension(width, height * lines.length, Vector.Zero);\n  }\n\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number, maxWidth?: number): void {\n    let xCursor = 0;\n    let yCursor = 0;\n    let height = 0;\n    const lines = this._getLinesFromText(this._text, maxWidth);\n    for (const line of lines) {\n      for (const sprite of this._getCharacterSprites(line)) {\n        // draw it in the right spot and increase the cursor by sprite width\n        sprite.draw(ex, x + xCursor, y + yCursor);\n        xCursor += sprite.width + this.spacing;\n        height = Math.max(height, sprite.height);\n      }\n      xCursor = 0;\n      yCursor += this.lineHeight ?? height;\n    }\n  }\n\n  render(ex: ExcaliburGraphicsContext, text: string, _color: Color, x: number, y: number, maxWidth?: number) {\n    // SpriteFont doesn't support _color, yet...\n    this._text = text;\n    const bounds = this.measureText(text, maxWidth);\n    this.width = bounds.width;\n    this.height = bounds.height;\n    if (this.shadow) {\n      ex.save();\n      ex.translate(this.shadow.offset.x, this.shadow.offset.y);\n      this._preDraw(ex, x, y);\n      this._drawImage(ex, 0, 0, maxWidth);\n      this._postDraw(ex);\n      ex.restore();\n    }\n\n    this._preDraw(ex, x, y);\n    this._drawImage(ex, 0, 0, maxWidth);\n    this._postDraw(ex);\n  }\n\n  clone(): SpriteFont {\n    return new SpriteFont({\n      alphabet: this.alphabet,\n      spriteSheet: this.spriteSheet,\n      spacing: this.spacing\n    });\n  }\n\n  /**\n   * Return array of lines split based on the \\n character, and the maxWidth? constraint\n   * @param text\n   * @param maxWidth\n   */\n  private _cachedText: string;\n  private _cachedLines: string[];\n  private _cachedRenderWidth: number;\n  private _getLinesFromText(text: string, maxWidth?: number) {\n    if (this._cachedText === text && this._cachedRenderWidth === maxWidth) {\n      return this._cachedLines;\n    }\n\n    const lines = text.split('\\n');\n\n    if (maxWidth == null) {\n      return lines;\n    }\n\n    // If the current line goes past the maxWidth, append a new line without modifying the underlying text.\n    for (let i = 0; i < lines.length; i++) {\n      let line = lines[i];\n      let newLine = '';\n      // Note: we subtract the spacing to counter the initial padding on the left side.\n      if (this.measureText(line).width > maxWidth) {\n        while (this.measureText(line).width > maxWidth) {\n          newLine = line[line.length - 1] + newLine;\n          line = line.slice(0, -1); // Remove last character from line\n        }\n\n        // Update the array with our new values\n        lines[i] = line;\n        lines[i + 1] = newLine;\n      }\n    }\n\n    this._cachedText = text;\n    this._cachedLines = lines;\n    this._cachedRenderWidth = maxWidth;\n\n    return lines;\n  }\n}\n","import { ImageSource } from './ImageSource';\r\nimport { SourceView, Sprite } from './Sprite';\r\nimport { GraphicOptions } from './Graphic';\r\n\r\n/**\r\n * Specify sprite sheet spacing options, useful if your sprites are not tightly packed\r\n * and have space between them.\r\n */\r\nexport interface SpriteSheetSpacingDimensions {\r\n  /**\r\n   * The starting point to offset and start slicing the sprite sheet from the top left of the image.\r\n   * Default is (0, 0)\r\n   */\r\n  originOffset?: { x?: number, y?: number };\r\n\r\n  /**\r\n   * The margin between sprites.\r\n   * Default is (0, 0)\r\n   */\r\n  margin?: {x?: number, y?: number};\r\n}\r\n\r\n/**\r\n * Sprite sheet options for slicing up images\r\n */\r\nexport interface SpriteSheetGridOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * Grid definition for the sprite sheet\r\n   */\r\n  grid: {\r\n    /**\r\n     * Number of rows in the sprite sheet\r\n     */\r\n    rows: number;\r\n    /**\r\n     * Number of columns in the sprite sheet\r\n     */\r\n    columns: number;\r\n    /**\r\n     * Width of each individual sprite\r\n     */\r\n    spriteWidth: number;\r\n    /**\r\n     * Height of each individual sprite\r\n     */\r\n    spriteHeight: number;\r\n  };\r\n  /**\r\n   * Optionally specify any spacing information between sprites\r\n   */\r\n  spacing?: SpriteSheetSpacingDimensions;\r\n}\r\n\r\nexport interface SpriteSheetSparseOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * List of source view rectangles to create a sprite sheet from\r\n   */\r\n  sourceViews: SourceView[];\r\n}\r\n\r\nexport interface SpriteSheetOptions {\r\n  /**\r\n   * Source sprites for the sprite sheet\r\n   */\r\n  sprites: Sprite[];\r\n  /**\r\n   * Optionally specify the number of rows in a sprite sheet (default 1 row)\r\n   */\r\n  rows?: number;\r\n  /**\r\n   * Optionally specify the number of columns in a sprite sheet (default sprites.length)\r\n   */\r\n  columns?: number;\r\n}\r\n\r\nexport interface GetSpriteOptions extends GraphicOptions {}\r\n\r\n/**\r\n * Represents a collection of sprites from a source image with some organization in a grid\r\n */\r\nexport class SpriteSheet {\r\n  public readonly sprites: Sprite[] = [];\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  /**\r\n   * Build a new sprite sheet from a list of sprites\r\n   *\r\n   * Use [[SpriteSheet.fromImageSource]] to create a SpriteSheet from an [[ImageSource]] organized in a grid\r\n   * @param options\r\n   */\r\n  constructor(options: SpriteSheetOptions) {\r\n    const { sprites, rows, columns } = options;\r\n    this.sprites = sprites;\r\n    this.rows = rows ?? 1;\r\n    this.columns = columns ?? this.sprites.length;\r\n  }\r\n\r\n  /**\r\n   * Find a sprite by their x/y integer coordinates in the SpriteSheet, for example `getSprite(0, 0)` is the [[Sprite]] in the top-left\r\n   * and `getSprite(1, 0)` is the sprite one to the right.\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public getSprite(x: number, y: number, options?: GetSpriteOptions): Sprite {\r\n    if (x >= this.columns || x < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), x: ${x} should be between 0 and ${this.columns - 1}`);\r\n    }\r\n    if (y >= this.rows || y < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), y: ${y} should be between 0 and ${this.rows - 1}`);\r\n    }\r\n    const spriteIndex = x + y * this.columns;\r\n    const sprite = this.sprites[spriteIndex];\r\n    if (sprite) {\r\n      if (options) {\r\n        const spriteWithOptions = sprite.clone();\r\n        spriteWithOptions.flipHorizontal = options.flipHorizontal ?? spriteWithOptions.flipHorizontal;\r\n        spriteWithOptions.flipVertical = options.flipVertical ?? spriteWithOptions.flipVertical;\r\n        spriteWithOptions.width = options.width ?? spriteWithOptions.width;\r\n        spriteWithOptions.height = options.height ?? spriteWithOptions.height;\r\n        spriteWithOptions.rotation = options.rotation ?? spriteWithOptions.rotation;\r\n        spriteWithOptions.scale = options.scale ?? spriteWithOptions.scale;\r\n        spriteWithOptions.opacity = options.opacity ?? spriteWithOptions.opacity;\r\n        spriteWithOptions.tint = options.tint ?? spriteWithOptions.tint;\r\n        spriteWithOptions.origin = options.origin ?? spriteWithOptions.origin;\r\n        return spriteWithOptions;\r\n      }\r\n      return sprite;\r\n    }\r\n    throw Error(`Invalid sprite coordinates (${x}, ${y}`);\r\n  }\r\n\r\n  /**\r\n   * Create a sprite sheet from a sparse set of [[SourceView]] rectangles\r\n   * @param options\r\n   */\r\n  public static fromImageSourceWithSourceViews(options: SpriteSheetSparseOptions): SpriteSheet {\r\n    const sprites: Sprite[] = options.sourceViews.map(sourceView => {\r\n      return new Sprite({\r\n        image: options.image,\r\n        sourceView\r\n      });\r\n    });\r\n    return new SpriteSheet({sprites});\r\n  }\r\n\r\n  /**\r\n   * Create a SpriteSheet from an [[ImageSource]] organized in a grid\r\n   *\r\n   * Example:\r\n   * ```\r\n   * const spriteSheet = SpriteSheet.fromImageSource({\r\n   *   image: imageSource,\r\n   *   grid: {\r\n   *     rows: 5,\r\n   *     columns: 2,\r\n   *     spriteWidth: 32, // pixels\r\n   *     spriteHeight: 32 // pixels\r\n   *   },\r\n   *   // Optionally specify spacing\r\n   *   spacing: {\r\n   *     // pixels from the top left to start the sprite parsing\r\n   *     originOffset: {\r\n   *       x: 5,\r\n   *       y: 5\r\n   *     },\r\n   *     // pixels between each sprite while parsing\r\n   *     margin: {\r\n   *       x: 1,\r\n   *       y: 1\r\n   *     }\r\n   *   }\r\n   * })\r\n   * ```\r\n   * @param options\r\n   */\r\n  public static fromImageSource(options: SpriteSheetGridOptions): SpriteSheet {\r\n    const sprites: Sprite[] = [];\r\n    options.spacing = options.spacing ?? {};\r\n    const {\r\n      image,\r\n      grid: { rows, columns: cols, spriteWidth, spriteHeight },\r\n      spacing: { originOffset, margin }\r\n    } = options;\r\n    const offsetDefaults = { x: 0, y: 0, ...originOffset};\r\n    const marginDefaults = { x: 0, y: 0, ...margin};\r\n    for (let x = 0; x < cols; x++) {\r\n      for (let y = 0; y < rows; y++) {\r\n        sprites[x + y * cols] = new Sprite({\r\n          image: image,\r\n          sourceView: {\r\n            x: x * spriteWidth + marginDefaults.x * x + offsetDefaults.x,\r\n            y: y * spriteHeight + marginDefaults.y * y + offsetDefaults.y,\r\n            width: spriteWidth,\r\n            height: spriteHeight\r\n          },\r\n          destSize: { height: spriteHeight, width: spriteWidth }\r\n        });\r\n      }\r\n    }\r\n    return new SpriteSheet({\r\n      sprites: sprites,\r\n      rows: rows,\r\n      columns: cols\r\n    });\r\n  }\r\n\r\n  public clone(): SpriteSheet {\r\n    return new SpriteSheet({\r\n      sprites: this.sprites.map(sprite => sprite.clone()),\r\n      rows: this.rows,\r\n      columns: this.columns\r\n    });\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from '../Context/ExcaliburGraphicsContext';\nimport { ImageSource } from '../ImageSource';\nimport { SpriteFont } from '../SpriteFont';\nimport { SpriteSheet } from '../SpriteSheet';\nimport { Vector } from '../../Math/vector';\nimport debugFont from './debug-font.png';\n\n/**\n * Internal debugtext helper\n */\nexport class DebugText {\n  constructor() {\n    // We fire and forget, we don't care if it's loaded or not\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.load();\n  }\n\n  /**\n   * base64 font\n   */\n  public readonly fontSheet = debugFont;\n  public size: number = 16;\n  private _imageSource: ImageSource;\n  private _spriteSheet: SpriteSheet;\n  private _spriteFont: SpriteFont;\n  public load() {\n    this._imageSource = new ImageSource(this.fontSheet);\n    return this._imageSource.load().then(() => {\n      this._spriteSheet = SpriteSheet.fromImageSource({\n        image: this._imageSource,\n        grid: {\n          rows: 4,\n          columns: 16,\n          spriteWidth: 16,\n          spriteHeight: 16\n        }\n      });\n      this._spriteFont = new SpriteFont({\n        alphabet: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!\\'&.\"?-()+# ',\n        caseInsensitive: true,\n        spriteSheet: this._spriteSheet,\n        spacing: -6\n      });\n    });\n  }\n\n  /**\n   * Writes debug text using the built in sprint font\n   * @param ctx\n   * @param text\n   * @param pos\n   */\n  public write(ctx: ExcaliburGraphicsContext, text: string, pos: Vector) {\n    if (this._imageSource.isLoaded()) {\n      this._spriteFont.render(ctx, text, null, pos.x, pos.y);\n    }\n  }\n}\n","export default \"data:image/png;base64,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\"","export class RenderSource {\r\n  constructor(\r\n    private _gl: WebGLRenderingContext,\r\n    private _texture: WebGLTexture) {}\r\n\r\n  public use() {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0);\r\n    gl.bindTexture(gl.TEXTURE_2D, this._texture);\r\n  }\r\n\r\n  public disable() {\r\n    const gl = this._gl;\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}","import { RenderSource } from './render-source';\r\n\r\ndeclare global {\r\n  interface WebGL2RenderingContext {\r\n    /**\r\n     * Experimental only in chrome\r\n     */\r\n    drawingBufferFormat?: number;\r\n  }\r\n}\r\n\r\n\r\nexport interface RenderTargetOptions {\r\n  gl: WebGL2RenderingContext;\r\n  width: number;\r\n  height: number;\r\n  transparency: boolean;\r\n  /**\r\n   * Optionally enable render buffer multisample anti-aliasing\r\n   *\r\n   * By default false\r\n   */\r\n  antialias?: boolean;\r\n  /**\r\n   * Optionally specify number of anti-aliasing samples to use\r\n   *\r\n   * By default the max for the platform is used if antialias is on.\r\n   */\r\n  samples?: number;\r\n}\r\n\r\nexport class RenderTarget {\r\n  width: number;\r\n  height: number;\r\n  transparency: boolean;\r\n  antialias: boolean = false;\r\n  samples: number = 1;\r\n  private _gl: WebGL2RenderingContext;\r\n  public readonly bufferFormat: number;\r\n  constructor(options: RenderTargetOptions) {\r\n    this._gl = options.gl;\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.transparency = options.transparency;\r\n    this.antialias = options.antialias ?? this.antialias;\r\n    this.samples = options.samples ?? this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n\r\n    const gl = this._gl;\r\n    // Determine current context format for blitting later needs to match\r\n    if (gl.drawingBufferFormat) {\r\n      this.bufferFormat = gl.drawingBufferFormat;\r\n    } else {\r\n      // Documented in webgl spec\r\n      // https://registry.khronos.org/webgl/specs/latest/1.0/\r\n      if (this.transparency) {\r\n        this.bufferFormat = gl.RGBA8;\r\n      } else {\r\n        this.bufferFormat = gl.RGB8;\r\n      }\r\n    }\r\n\r\n    this._setupRenderBuffer();\r\n    this._setupFramebuffer();\r\n  }\r\n\r\n  setResolution(width: number, height: number) {\r\n    const gl = this._gl;\r\n    this.width = width;\r\n    this.height = height;\r\n\r\n    // update backing texture size\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\r\n    // update render buffer size\r\n    if (this._renderBuffer) {\r\n      gl.bindRenderbuffer(gl.RENDERBUFFER, this._renderBuffer);\r\n      gl.renderbufferStorageMultisample(\r\n        gl.RENDERBUFFER,\r\n        Math.min(this.samples, gl.getParameter(gl.MAX_SAMPLES)),\r\n        this.bufferFormat,\r\n        this.width,\r\n        this.height);\r\n    }\r\n  }\r\n\r\n  private _renderBuffer: WebGLRenderbuffer;\r\n  public get renderBuffer() {\r\n    return this._renderBuffer;\r\n  }\r\n  private _renderFrameBuffer: WebGLFramebuffer;\r\n  public get renderFrameBuffer() {\r\n    return this._renderFrameBuffer;\r\n  }\r\n\r\n  private _frameBuffer: WebGLFramebuffer;\r\n  public get frameBuffer() {\r\n    return this._frameBuffer;\r\n  }\r\n  private _frameTexture: WebGLTexture;\r\n  public get frameTexture() {\r\n    return this._frameTexture;\r\n  }\r\n\r\n  private _setupRenderBuffer() {\r\n    if (this.antialias) {\r\n      const gl = this._gl;\r\n      // Render buffers can be used as an input to a shader\r\n      this._renderBuffer = gl.createRenderbuffer();\r\n      this._renderFrameBuffer = gl.createFramebuffer();\r\n      gl.bindRenderbuffer(gl.RENDERBUFFER, this._renderBuffer);\r\n      gl.renderbufferStorageMultisample(\r\n        gl.RENDERBUFFER,\r\n        Math.min(this.samples, gl.getParameter(gl.MAX_SAMPLES)),\r\n        this.bufferFormat,\r\n        this.width,\r\n        this.height);\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._renderFrameBuffer);\r\n      gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, this._renderBuffer);\r\n    }\r\n  }\r\n\r\n  private _setupFramebuffer() {\r\n    // Allocates frame buffer\r\n    const gl = this._gl;\r\n    this._frameTexture = gl.createTexture();\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\r\n    // set the filtering so we don't need mips\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n\r\n    // attach the texture as the first color attachment\r\n    const attachmentPoint = gl.COLOR_ATTACHMENT0;\r\n\r\n    // After this bind all draw calls will draw to this framebuffer texture\r\n    this._frameBuffer = gl.createFramebuffer();\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, this._frameTexture, 0);\r\n\r\n    // Reset after initialized\r\n    this.disable();\r\n  }\r\n\r\n  public toRenderSource() {\r\n    if (this.renderBuffer) {\r\n      this.blitRenderBufferToFrameBuffer();\r\n    }\r\n    const source = new RenderSource(this._gl, this._frameTexture);\r\n    return source;\r\n  }\r\n\r\n  public blitToScreen() {\r\n    const gl = this._gl;\r\n    // set to size of canvas's drawingBuffer\r\n    if (this._renderBuffer) {\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.renderFrameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, null);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(\r\n        0, 0, this.width, this.height,\r\n        0, 0, this.width, this.height,\r\n        gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    } else {\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.frameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, null);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(\r\n        0, 0, this.width, this.height,\r\n        0, 0, this.width, this.height,\r\n        gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    }\r\n  }\r\n\r\n  public blitRenderBufferToFrameBuffer() {\r\n    if (this._renderBuffer) {\r\n      const gl = this._gl;\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.renderFrameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, this.frameBuffer);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(\r\n        0, 0, this.width, this.height,\r\n        0, 0, this.width, this.height,\r\n        gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    }\r\n  }\r\n\r\n  public copyToTexture(texture: WebGLTexture) {\r\n    const gl = this._gl;\r\n    if (this._renderBuffer) {\r\n      this.blitRenderBufferToFrameBuffer();\r\n    }\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n    gl.copyTexImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 0, 0, this.width, this.height, 0);\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing gets redirected to this render target\r\n   */\r\n  public use() {\r\n    const gl = this._gl;\r\n    if (this.antialias) {\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._renderFrameBuffer);\r\n    } else {\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    }\r\n\r\n    // very important to set the viewport to the size of the framebuffer texture\r\n    gl.viewport(0, 0, this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing is sent back to the canvas\r\n   */\r\n  public disable() {\r\n    const gl = this._gl;\r\n    // passing null switches rendering back to the canvas\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}","/**\r\n * Return the size of the GlType in bytes\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getGlTypeSizeBytes(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.FLOAT:\r\n      return 4;\r\n    case gl.SHORT:\r\n      return 2;\r\n    case gl.UNSIGNED_SHORT:\r\n      return 2;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if an attribute is present in vertex source\r\n */\r\nexport function isAttributeInSource(source: string, variable: string) {\r\n  const attributeRegexTemplate = `(?<type>[a-z0-9]+)\\\\s+${variable};`;\r\n  const regex = new RegExp(attributeRegexTemplate, 'g');\r\n  const matches = regex.exec(source);\r\n  return matches?.length > 0;\r\n}\r\n\r\n/**\r\n * Attempt to discern the glType of an attribute from vertex source\r\n * @param gl\r\n * @param source\r\n * @param variable\r\n */\r\nexport function getGLTypeFromSource(gl: WebGLRenderingContext, source: string, variable: string) {\r\n  const attributeRegexTemplate = `(?<type>[a-z0-9]+)\\\\s+${variable};`;\r\n  const regex = new RegExp(attributeRegexTemplate, 'g');\r\n  const matches = regex.exec(source);\r\n  const type = matches?.groups?.type;\r\n\r\n  switch (type) {\r\n    case 'float':\r\n    case 'vec2':\r\n    case 'vec3':\r\n    case 'vec4':\r\n      return gl.FLOAT;\r\n    case 'int':\r\n    case 'ivec2':\r\n    case 'ivec3':\r\n    case 'ivec4':\r\n      return gl.INT;\r\n    case 'uint':\r\n    case 'uvec2':\r\n    case 'uvec3':\r\n    case 'uvec4':\r\n      return gl.UNSIGNED_INT;\r\n    case 'bool':\r\n    case 'bvec2':\r\n    case 'bvec3':\r\n    case 'bvec4':\r\n      return gl.BOOL;\r\n    case 'short':\r\n      return gl.SHORT;\r\n    case 'ushort':\r\n      return gl.UNSIGNED_SHORT;\r\n    case 'ubyte':\r\n      return gl.UNSIGNED_BYTE;\r\n    case 'byte':\r\n      return gl.BYTE;\r\n    default:\r\n      return gl.FLOAT;\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * Based on the type return the number of attribute components\r\n *\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributeComponentSize(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n      return 1;\r\n    case gl.FLOAT_VEC2:\r\n      return 2;\r\n    case gl.FLOAT_VEC3:\r\n      return 3;\r\n    case gl.FLOAT_VEC4:\r\n      return 4;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_SHORT:\r\n    case gl.SHORT:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n/**\r\n * Based on the attribute return the corresponding supported attrib pointer type\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributePointerType(gl: WebGLRenderingContext, type: number) {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n    case gl.FLOAT_VEC2:\r\n    case gl.FLOAT_VEC3:\r\n    case gl.FLOAT_VEC4:\r\n      return gl.FLOAT;\r\n    case gl.BYTE:\r\n      return gl.BYTE;\r\n    case gl.UNSIGNED_BYTE:\r\n      return gl.UNSIGNED_BYTE;\r\n    case gl.SHORT:\r\n      return gl.SHORT;\r\n    case gl.UNSIGNED_SHORT:\r\n      return gl.UNSIGNED_SHORT;\r\n    default:\r\n      return gl.FLOAT;\r\n  }\r\n}","import { Color, Logger, Vector } from '../..';\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { getAttributeComponentSize, getAttributePointerType } from './webgl-util';\r\n\r\n/**\r\n * List of the possible glsl uniform types\r\n */\r\nexport type UniformTypeNames =\r\n  'uniform1f' |\r\n  'uniform1i' |\r\n  'uniform2f' |\r\n  'uniform2i' |\r\n  'uniform3f' |\r\n  'uniform3i' |\r\n  'uniform4f' |\r\n  'uniform4i' |\r\n  'uniform1fv' |\r\n  'uniform1iv' |\r\n  'uniform2fv' |\r\n  'uniform2iv' |\r\n  'uniform3fv' |\r\n  'uniform3iv' |\r\n  'uniform4fv' |\r\n  'uniform4iv' |\r\n  'uniformMatrix2fv' |\r\n  'uniformMatrix3fv' |\r\n  'uniformMatrix4fv';\r\n\r\ntype RemoveFirstFromTuple<T extends any[]> =\r\n  T['length'] extends 0 ? undefined :\r\n    (((...b: T) => void) extends (a: any, ...b: infer I) => void ? I : [])\r\n\r\ntype UniformParameters<TUniformType extends UniformTypeNames> = RemoveFirstFromTuple<Parameters<WebGLRenderingContext[TUniformType]>>\r\n\r\nexport interface UniformDefinition {\r\n  name: string;\r\n  glType: number;\r\n  location: WebGLUniformLocation;\r\n}\r\n\r\n\r\nexport interface VertexAttributeDefinition {\r\n  /**\r\n   * string name of the attribute in the shader program, commonly `a_nameofmyvariable`\r\n   */\r\n  name: string;\r\n  /**\r\n   * Number of components for a given attribute\r\n   * Must be 1, 2, 3, or 4\r\n   *\r\n   * For example a vec4 attribute would be `4` floats, so 4\r\n   */\r\n  size: number;\r\n  /**\r\n   * Supported types in webgl 1\r\n   * * gl.BYTE\r\n   * * gl.SHORT\r\n   * * gl.UNSIGNED_BYTE\r\n   * * gl.UNSIGNED_SHORT\r\n   * * gl.FLOAT\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n   */\r\n  glType: number;\r\n  /**\r\n   * Is the attribute normalized between (0-1)\r\n   */\r\n  normalized: boolean;\r\n  /**\r\n   * Location index in the shader program\r\n   */\r\n  location: number;\r\n}\r\n\r\nexport interface ShaderOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across webgl contexts.\r\n   */\r\n  gl: WebGL2RenderingContext;\r\n  /**\r\n   * Vertex shader source code in glsl #version 300 es\r\n   */\r\n  vertexSource: string;\r\n  /**\r\n   * Fragment shader source code in glsl #version 300 es\r\n   */\r\n  fragmentSource: string;\r\n}\r\n\r\nexport class Shader {\r\n  private static _ACTIVE_SHADER_INSTANCE: Shader = null;\r\n  private _logger = Logger.getInstance();\r\n  private _gl: WebGL2RenderingContext;\r\n  public program: WebGLProgram;\r\n  public uniforms: { [variableName: string]: UniformDefinition } = {};\r\n  public attributes: { [variableName: string]: VertexAttributeDefinition } = {};\r\n  private _compiled = false;\r\n  public readonly vertexSource: string;\r\n  public readonly fragmentSource: string;\r\n\r\n  public get compiled() {\r\n    return this._compiled;\r\n  }\r\n\r\n  /**\r\n   * Create a shader program in excalibur\r\n   * @param options specify shader vertex and fragment source\r\n   */\r\n  constructor(options?: ShaderOptions) {\r\n    const { gl, vertexSource, fragmentSource } = options;\r\n    this._gl = gl;\r\n    this.vertexSource = vertexSource;\r\n    this.fragmentSource = fragmentSource;\r\n  }\r\n\r\n  dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteProgram(this.program);\r\n    this._gl = null;\r\n  }\r\n\r\n  /**\r\n   * Binds the shader program\r\n   */\r\n  use() {\r\n    const gl = this._gl;\r\n    gl.useProgram(this.program);\r\n    Shader._ACTIVE_SHADER_INSTANCE = this;\r\n  }\r\n\r\n  isCurrentlyBound() {\r\n    return Shader._ACTIVE_SHADER_INSTANCE === this;\r\n  }\r\n\r\n  /**\r\n   * Compile the current shader against a webgl context\r\n   */\r\n  compile(): WebGLProgram {\r\n    const gl = this._gl;\r\n    const vertexShader = this._compileShader(gl, this.vertexSource, gl.VERTEX_SHADER);\r\n    const fragmentShader = this._compileShader(gl, this.fragmentSource, gl.FRAGMENT_SHADER);\r\n    this.program = this._createProgram(gl, vertexShader, fragmentShader);\r\n\r\n    const attributes = this.getAttributes();\r\n    for (const attribute of attributes) {\r\n      this.attributes[attribute.name] = attribute;\r\n    }\r\n    const uniforms = this.getUniforms();\r\n    for (const uniform of uniforms) {\r\n      this.uniforms[uniform.name] = uniform;\r\n    }\r\n\r\n    this._compiled = true;\r\n    return this.program;\r\n  }\r\n\r\n  getUniforms(): UniformDefinition[] {\r\n    const gl = this._gl;\r\n    const uniformCount = gl.getProgramParameter(this.program, gl.ACTIVE_UNIFORMS);\r\n    const uniforms: UniformDefinition[] = [];\r\n    for (let i = 0; i < uniformCount; i++) {\r\n      const uniform = gl.getActiveUniform(this.program, i);\r\n      const uniformLocation = gl.getUniformLocation(this.program, uniform.name);\r\n      uniforms.push({\r\n        name: uniform.name,\r\n        glType: uniform.type,\r\n        location: uniformLocation\r\n      });\r\n    }\r\n    return uniforms;\r\n  }\r\n\r\n  getAttributes(): VertexAttributeDefinition[] {\r\n    const gl = this._gl;\r\n    const attributeCount = gl.getProgramParameter(this.program, gl.ACTIVE_ATTRIBUTES);\r\n    const attributes: VertexAttributeDefinition[] = [];\r\n    for (let i = 0; i < attributeCount; i++) {\r\n      const attribute = gl.getActiveAttrib(this.program, i);\r\n      const attributeLocation = gl.getAttribLocation(this.program, attribute.name);\r\n      attributes.push({\r\n        name: attribute.name,\r\n        glType: getAttributePointerType(gl, attribute.type),\r\n        size: getAttributeComponentSize(gl, attribute.type),\r\n        location: attributeLocation,\r\n        normalized: false\r\n      });\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  /**\r\n   * Set a texture in a gpu texture slot\r\n   * @param slotNumber\r\n   * @param texture\r\n   */\r\n  setTexture(slotNumber: number, texture: WebGLTexture) {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0 + slotNumber);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n  }\r\n\r\n  /**\r\n   * Set an integer uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformInt(name: string, value: number) {\r\n    this.setUniform('uniform1i', name, ~~value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformInt(name: string, value: number): boolean {\r\n    return this.trySetUniform('uniform1i', name, ~~value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformIntArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1iv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer array uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformIntArray(name: string, value: number[]): boolean {\r\n    return this.trySetUniform('uniform1iv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a boolean uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformBoolean(name: string, value: boolean) {\r\n    this.setUniform('uniform1i', name, value ? 1 : 0);\r\n  }\r\n\r\n  /**\r\n   * Set a boolean uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformBoolean(name: string, value: boolean): boolean {\r\n    return this.trySetUniform('uniform1i', name, value ? 1 : 0);\r\n  }\r\n\r\n  /**\r\n   * Set a float uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloat(name: string, value: number) {\r\n    this.setUniform('uniform1f', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a float uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloat(name: string, value: number): boolean {\r\n    return this.trySetUniform('uniform1f', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a float array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1fv', name, value);\r\n  }\r\n  /**\r\n   * Set a float array uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatArray(name: string, value: number[]): boolean {\r\n    return this.trySetUniform('uniform1fv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a [[Vector]] uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatVector(name: string, value: Vector) {\r\n    this.setUniform('uniform2f', name, value.x, value.y);\r\n  }\r\n\r\n  /**\r\n   * Set a [[Vector]] uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatVector(name: string, value: Vector): boolean {\r\n    return this.trySetUniform('uniform2f', name, value.x, value.y);\r\n  }\r\n\r\n  /**\r\n   * Set a [[Color]] uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatColor(name: string, value: Color) {\r\n    this.setUniform('uniform4f', name, value.r / 255, value.g / 255, value.b / 255, value.a);\r\n  }\r\n\r\n  /**\r\n   * Set a [[Color]] uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatColor(name: string, value: Color): boolean {\r\n    return this.trySetUniform('uniform4f', name, value.r / 255, value.g / 255, value.b / 255, value.a);\r\n  }\r\n\r\n  /**\r\n   * Set an [[Matrix]] uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformMatrix(name: string, value: Matrix) {\r\n    this.setUniform('uniformMatrix4fv', name, false, value.data);\r\n  }\r\n\r\n  /**\r\n   * Set an [[Matrix]] uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformMatrix(name: string, value: Matrix): boolean {\r\n    return this.trySetUniform('uniformMatrix4fv', name, false, value.data);\r\n  }\r\n\r\n  /**\r\n   * Set any available uniform type in webgl\r\n   *\r\n   * For example setUniform('uniformMatrix2fv', 'u_my2x2_mat`, ...);\r\n   */\r\n  setUniform<TUniformType extends UniformTypeNames>(uniformType: TUniformType, name: string, ...value: UniformParameters<TUniformType>) {\r\n    if (!this._compiled) {\r\n      throw Error(`Must compile shader before setting a uniform ${uniformType}:${name}`);\r\n    }\r\n    if (!this.isCurrentlyBound()) {\r\n      throw Error('Currently accessed shader instance is not the current active shader in WebGL,' +\r\n      ' must call `shader.use()` before setting uniforms');\r\n    }\r\n    const gl = this._gl;\r\n    const location = gl.getUniformLocation(this.program, name);\r\n    if (location) {\r\n      const args = [location, ...value];\r\n      this._gl[uniformType].apply(this._gl, args);\r\n    } else {\r\n      throw Error(`Uniform ${uniformType}:${name} doesn\\'t exist or is not used in the shader source code,`+\r\n      ' unused uniforms are optimized away by most browsers');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set any available uniform type in webgl. Will try to set the uniform, will return false if the uniform didn't exist,\r\n   * true if it was set.\r\n   *\r\n   * WILL NOT THROW on error\r\n   *\r\n   * For example setUniform('uniformMatrix2fv', 'u_my2x2_mat`, ...);\r\n   *\r\n   */\r\n  trySetUniform<TUniformType extends UniformTypeNames>(\r\n    uniformType: TUniformType,\r\n    name: string,\r\n    ...value: UniformParameters<TUniformType>): boolean {\r\n    if (!this._compiled) {\r\n      this._logger.warn(`Must compile shader before setting a uniform ${uniformType}:${name}`);\r\n      return false;\r\n    }\r\n    if (!this.isCurrentlyBound()) {\r\n      this._logger.warn('Currently accessed shader instance is not the current active shader in WebGL,' +\r\n      ' must call `shader.use()` before setting uniforms');\r\n      return false;\r\n    }\r\n    const gl = this._gl;\r\n    const location = gl.getUniformLocation(this.program, name);\r\n    if (location) {\r\n      const args = [location, ...value];\r\n      this._gl[uniformType].apply(this._gl, args);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private _createProgram(gl: WebGLRenderingContext, vertexShader: WebGLShader, fragmentShader: WebGLShader): WebGLProgram {\r\n    const program = gl.createProgram();\r\n    if (program === null) {\r\n      throw Error('Could not create graphics shader program');\r\n    }\r\n\r\n    // attach the shaders.\r\n    gl.attachShader(program, vertexShader);\r\n    gl.attachShader(program, fragmentShader);\r\n\r\n    // link the program.\r\n    gl.linkProgram(program);\r\n\r\n    const success = gl.getProgramParameter(program, gl.LINK_STATUS);\r\n    if (!success) {\r\n      throw Error(`Could not link the program: [${gl.getProgramInfoLog(program)}]`);\r\n    }\r\n\r\n    return program;\r\n  }\r\n\r\n  private _compileShader(gl: WebGLRenderingContext, source: string, type: number): WebGLShader {\r\n    const typeName = gl.VERTEX_SHADER === type ? 'vertex' : 'fragment';\r\n    const shader = gl.createShader(type);\r\n    if (shader === null) {\r\n      throw Error(`Could not build shader: [${source}]`);\r\n    }\r\n\r\n    gl.shaderSource(shader, source);\r\n    gl.compileShader(shader);\r\n\r\n    const success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n    if (!success) {\r\n      const errorInfo = gl.getShaderInfoLog(shader);\r\n      throw Error(`Could not compile ${typeName} shader:\\n\\n${errorInfo}${this._processSourceForError(source, errorInfo)}`);\r\n    }\r\n    return shader;\r\n  }\r\n\r\n  private _processSourceForError(source: string, errorInfo: string) {\r\n    if (!source) {\r\n      return errorInfo;\r\n    }\r\n    const lines = source.split('\\n');\r\n    const errorLineStart = errorInfo.search(/\\d:\\d/);\r\n    const errorLineEnd = errorInfo.indexOf(' ', errorLineStart);\r\n    const [_, error2] = errorInfo.slice(errorLineStart, errorLineEnd).split(':').map(v => Number(v));\r\n    for (let i = 0; i < lines.length; i++) {\r\n      lines[i] = `${i+1}: ${lines[i]}${error2 === (i+1)? ' <----- ERROR!' : ''}`;\r\n    }\r\n\r\n    return '\\n\\nSource:\\n' + lines.join('\\n');\r\n  }\r\n}","export interface VertexBufferOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   */\r\n  gl: WebGL2RenderingContext,\r\n  /**\r\n   * Size in number of floats, so [4.2, 4.0, 2.1] is size = 3\r\n   *\r\n   * Ignored if data is passed directly\r\n   */\r\n  size?: number;\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  type?: 'static' | 'dynamic';\r\n\r\n  /**\r\n   * Optionally pass pre-seeded data, size parameter is ignored\r\n   */\r\n  data?: Float32Array\r\n}\r\n\r\n/**\r\n * Helper around vertex buffer to simplify creating and uploading geometry\r\n *\r\n * Under the hood uses Float32Array\r\n */\r\nexport class VertexBuffer {\r\n  private _gl: WebGL2RenderingContext;\r\n\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public readonly buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the vertex buffer\r\n   */\r\n  public readonly bufferData: Float32Array;\r\n\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  public type: 'static' | 'dynamic' = 'dynamic';\r\n\r\n  constructor(options: VertexBufferOptions) {\r\n    const { gl, size, type, data } = options;\r\n    this._gl = gl;\r\n    this.buffer = this._gl.createBuffer();\r\n    if (!data && !size) {\r\n      throw Error('Must either provide data or a size to the VertexBuffer');\r\n    }\r\n\r\n    if (!data) {\r\n      this.bufferData = new Float32Array(size);\r\n    } else {\r\n      this.bufferData = data;\r\n    }\r\n    this.type = type ?? this.type;\r\n    // Allocate buffer\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this vertex buffer\r\n   */\r\n  bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n  }\r\n\r\n  unbind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n  }\r\n\r\n  /**\r\n   * Upload vertex buffer geometry to the GPU\r\n   */\r\n  upload(count?: number) {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    if (count) {\r\n      gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.bufferData, 0, count);\r\n    } else {\r\n      // TODO always use bufferSubData? need to perf test it\r\n      gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteBuffer(this.buffer);\r\n    this._gl = null;\r\n  }\r\n}","import { Logger } from '../..';\r\nimport { Shader, VertexAttributeDefinition } from './shader';\r\nimport { VertexBuffer } from './vertex-buffer';\r\nimport { getGLTypeFromSource, getGlTypeSizeBytes, isAttributeInSource } from './webgl-util';\r\n\r\n\r\nexport interface VertexLayoutOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   */\r\n  gl: WebGL2RenderingContext,\r\n  /**\r\n   * Shader that this layout will be for, if null you must set a shader before using it.\r\n   */\r\n  shader?: Shader;\r\n  /**\r\n   * Vertex buffer to use for vertex data\r\n   */\r\n  vertexBuffer: VertexBuffer,\r\n  /**\r\n   * Specify the attributes that will exist in the vertex buffer\r\n   *\r\n   * **Important** must specify them in the order that they will be in the vertex buffer!!\r\n   */\r\n  attributes: [name: string, numberOfComponents: number][],\r\n  /**\r\n   * Optionally suppress any warnings out of vertex layouts\r\n   *\r\n   * **BEWARE** this may cause you to have issues go unnoticed\r\n   */\r\n  suppressWarnings?: boolean\r\n}\r\n\r\n/**\r\n * Helper around creating vertex attributes in a given [[VertexBuffer]], this is useful for describing\r\n * the memory layout for your vertices inside a particular buffer\r\n *\r\n * Note: This helper assumes interleaved attributes in one [[VertexBuffer]], not many.\r\n *\r\n * Working with `gl.vertexAttribPointer` can be tricky, and this attempts to double check you\r\n */\r\nexport class VertexLayout {\r\n  private _gl: WebGL2RenderingContext;\r\n  private _logger = Logger.getInstance();\r\n  private _suppressWarnings = false;\r\n  private _shader: Shader;\r\n  private _layout: VertexAttributeDefinition[] = [];\r\n  private _attributes: [name: string, numberOfComponents: number][] = [];\r\n  private _vertexBuffer: VertexBuffer;\r\n  private _vao: WebGLVertexArrayObject;\r\n\r\n  public get vertexBuffer() {\r\n    return this._vertexBuffer;\r\n  }\r\n\r\n  public get attributes(): readonly [name: string, numberOfComponents: number][] {\r\n    return this._attributes;\r\n  }\r\n\r\n  constructor(options: VertexLayoutOptions) {\r\n    const {gl, shader, vertexBuffer, attributes, suppressWarnings } = options;\r\n    this._gl = gl;\r\n    this._vertexBuffer = vertexBuffer;\r\n    this._attributes = attributes;\r\n    this._shader = shader;\r\n    this._suppressWarnings = suppressWarnings;\r\n    if (shader) {\r\n      this.initialize();\r\n    }\r\n  }\r\n\r\n  private _vertexTotalSizeBytes = 0;\r\n  /**\r\n   * Total number of bytes that the vertex will take up\r\n   */\r\n  public get totalVertexSizeBytes(): number {\r\n    return this._vertexTotalSizeBytes;\r\n  }\r\n\r\n  public set shader(shader: Shader) {\r\n    if (shader && this._shader !== shader) {\r\n      this._shader = shader;\r\n      this.initialize();\r\n    }\r\n  }\r\n\r\n  public get shader() {\r\n    return this._shader;\r\n  }\r\n\r\n  private _initialized = false;\r\n\r\n  /**\r\n   * Layouts need shader locations and must be bound to a shader\r\n   */\r\n  initialize() {\r\n    if (this._initialized) {\r\n      return;\r\n    }\r\n    if (!this._shader) {\r\n      return;\r\n    }\r\n\r\n    if (!this._shader.compiled) {\r\n      throw Error('Shader not compiled, shader must be compiled before defining a vertex layout');\r\n    }\r\n    this._vertexTotalSizeBytes = 0;\r\n    this._layout.length = 0;\r\n    const shaderAttributes = this._shader.attributes;\r\n    for (const attribute of this._attributes) {\r\n      const attrib = shaderAttributes[attribute[0]];\r\n      if (!attrib) {\r\n        if (!isAttributeInSource(this._shader.vertexSource, attribute[0])) {\r\n          throw Error(`The attribute named: ${attribute[0]} size ${attribute[1]}`+\r\n          ` not found in the shader source code:\\n ${this._shader.vertexSource}`);\r\n        }\r\n\r\n        if (!this._suppressWarnings) {\r\n          this._logger.warn(`The attribute named: ${attribute[0]} size ${attribute[1]}`+\r\n          ` not found in the compiled shader. This is possibly a bug:\\n` +\r\n          ` 1. Not a bug, but should remove unused code - attribute \"${attribute[0]}\" is unused in` +\r\n          ` vertex/fragment and has been automatically removed by glsl compiler.\\n` +\r\n          ` 2. Definitely a bug, attribute \"${attribute[0]}\" in layout has been mistyped or is missing` +\r\n          ` in shader, check vertex/fragment source.`);\r\n        }\r\n\r\n        const glType = getGLTypeFromSource(this._gl, this._shader.vertexSource, attribute[0]);\r\n\r\n        // Unused attribute placeholder\r\n        this._layout.push({\r\n          name: attribute[0],\r\n          glType,\r\n          size: attribute[1],\r\n          location: -1,\r\n          normalized: false\r\n        });\r\n      }\r\n      if (attrib) {\r\n        if (attrib.size !== attribute[1]) {\r\n          throw Error(`VertexLayout size definition for attribute: [${attribute[0]}, ${attribute[1]}],`\r\n          +` doesn\\'t match shader source size ${attrib.size}:\\n ${this._shader.vertexSource}`);\r\n        }\r\n        this._layout.push(attrib);\r\n      }\r\n    }\r\n\r\n    // calc size\r\n    let componentsPerVertex = 0;\r\n    for (const vertAttribute of this._layout) {\r\n      const typeSize = getGlTypeSizeBytes(this._gl, vertAttribute.glType);\r\n      this._vertexTotalSizeBytes += typeSize * vertAttribute.size;\r\n      componentsPerVertex += vertAttribute.size;\r\n    }\r\n\r\n    if (this._vertexBuffer.bufferData.length % componentsPerVertex !== 0) {\r\n      this._logger.warn(`The vertex component size (${componentsPerVertex})  does NOT divide evenly into the specified vertex buffer`\r\n      +` (${this._vertexBuffer.bufferData.length})`);\r\n    }\r\n\r\n\r\n    // create VAO\r\n    const gl = this._gl;\r\n    this._vao = gl.createVertexArray();\r\n    gl.bindVertexArray(this._vao);\r\n    this._vertexBuffer.bind();\r\n\r\n    let offset = 0;\r\n    for (const vert of this._layout) {\r\n      if (vert.location !== -1) { // skip unused attributes\r\n        gl.vertexAttribPointer(vert.location, vert.size, vert.glType, vert.normalized, this.totalVertexSizeBytes, offset);\r\n        gl.enableVertexAttribArray(vert.location);\r\n      }\r\n      offset += getGlTypeSizeBytes(gl, vert.glType) * vert.size;\r\n    }\r\n    gl.bindVertexArray(null);\r\n    this._vertexBuffer.unbind();\r\n\r\n    this._initialized = true;\r\n  }\r\n\r\n  /**\r\n   * Bind this layout with it's associated vertex buffer\r\n   * @param uploadBuffer Optionally indicate you wish to upload the buffer to the GPU associated with this layout\r\n   */\r\n  use(uploadBuffer = false, count?: number) {\r\n    if (!this._shader) {\r\n      throw Error('No shader is associated with this vertex layout, a shader must be set');\r\n    }\r\n\r\n    const gl = this._gl;\r\n    if (!this._shader.isCurrentlyBound()) {\r\n      throw Error('Shader associated with this vertex layout is not active! Call shader.use() before layout.use()');\r\n    }\r\n    this._vertexBuffer.bind();\r\n    if (uploadBuffer) {\r\n      this._vertexBuffer.upload(count);\r\n    }\r\n    gl.bindVertexArray(this._vao);\r\n  }\r\n}","export class GraphicsDiagnostics {\n  public static DrawCallCount: number = 0;\n  public static DrawnImagesCount: number = 0;\n  public static clear(): void {\n    GraphicsDiagnostics.DrawCallCount = 0;\n    GraphicsDiagnostics.DrawnImagesCount = 0;\n  }\n}\n","import { Vector } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport lineVertexSource from './line-vertex.glsl';\r\nimport lineFragmentSource from './line-fragment.glsl';\r\nimport { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader, VertexBuffer, VertexLayout } from '../..';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\n\r\nexport interface LineOptions {\r\n  color?: Color;\r\n  width?: number;\r\n}\r\n\r\nexport class LineRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.line';\r\n  public priority: number = 0;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGL2RenderingContext;\r\n  private _shader: Shader;\r\n  private _maxLines: number = 10922;\r\n  private _vertexBuffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _vertexIndex = 0;\r\n  private _lineCount = 0;\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: lineVertexSource,\r\n      fragmentSource: lineFragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    this._vertexBuffer = new VertexBuffer({\r\n      gl,\r\n      size: 6 * 2 * this._maxLines,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      vertexBuffer: this._vertexBuffer,\r\n      shader: this._shader,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_color', 4]\r\n      ]\r\n    });\r\n  }\r\n\r\n  public dispose() {\r\n    this._vertexBuffer.dispose();\r\n    this._shader.dispose();\r\n    this._context = null;\r\n    this._gl = null;\r\n  }\r\n\r\n  draw(start: Vector, end: Vector, color: Color): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._lineCount++;\r\n\r\n    const transform = this._context.getTransform();\r\n    const finalStart = transform.multiply(start);\r\n    const finalEnd = transform.multiply(end);\r\n\r\n\r\n    const vertexBuffer = this._vertexBuffer.bufferData;\r\n    // Start\r\n    vertexBuffer[this._vertexIndex++] = finalStart.x;\r\n    vertexBuffer[this._vertexIndex++] = finalStart.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n\r\n    // End\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.x;\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._lineCount >= this._maxLines) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._lineCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._lineCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use(true);\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    gl.drawArrays(gl.LINES, 0, this._lineCount * 2); // 2 verts per line\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._lineCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // reset\r\n    this._vertexIndex = 0;\r\n    this._lineCount = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\n\\r\\nout lowp vec4 v_color;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Passthrough the color\\r\\n   v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Color\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  fragColor = v_color;\\r\\n}\";","import pointVertexSource from './point-vertex.glsl';\nimport pointFragmentSource from './point-fragment.glsl';\nimport { Vector } from '../../../Math/vector';\nimport { Color } from '../../../Color';\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\nimport { RendererPlugin } from '../renderer';\nimport { Shader } from '../shader';\nimport { VertexBuffer } from '../vertex-buffer';\nimport { VertexLayout } from '../vertex-layout';\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\n\nexport class PointRenderer implements RendererPlugin {\n  public readonly type = 'ex.point';\n  public priority: number = 0;\n  private _shader: Shader;\n  private _maxPoints: number = 10922;\n  private _buffer: VertexBuffer;\n  private _layout: VertexLayout;\n  private _gl: WebGLRenderingContext;\n  private _context: ExcaliburGraphicsContextWebGL;\n  private _pointCount: number = 0;\n  private _vertexIndex: number = 0;\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\n    this._gl = gl;\n    this._context = context;\n    this._shader = new Shader({\n      gl,\n      vertexSource: pointVertexSource,\n      fragmentSource: pointFragmentSource\n    });\n    this._shader.compile();\n    this._shader.use();\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\n    this._buffer = new VertexBuffer({\n      gl,\n      size: 7 * this._maxPoints,\n      type: 'dynamic'\n    });\n\n    this._layout = new VertexLayout({\n      gl,\n      shader: this._shader,\n      vertexBuffer: this._buffer,\n      attributes: [\n        ['a_position', 2],\n        ['a_color', 4],\n        ['a_size', 1]\n      ]\n    });\n  }\n\n  public dispose() {\n    this._buffer.dispose();\n    this._shader.dispose();\n    this._context = null;\n    this._gl = null;\n  }\n\n  draw(point: Vector, color: Color, size: number): void {\n    // Force a render if the batch is full\n    if (this._isFull()) {\n      this.flush();\n    }\n\n    this._pointCount++;\n\n    const transform = this._context.getTransform();\n    const opacity = this._context.opacity;\n    const snapToPixel = this._context.snapToPixel;\n\n    const finalPoint = transform.multiply(point);\n\n    if (snapToPixel) {\n      finalPoint.x = ~~(finalPoint.x + pixelSnapEpsilon);\n      finalPoint.y = ~~(finalPoint.y + pixelSnapEpsilon);\n    }\n\n    const vertexBuffer = this._buffer.bufferData;\n    vertexBuffer[this._vertexIndex++] = finalPoint.x;\n    vertexBuffer[this._vertexIndex++] = finalPoint.y;\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\n    vertexBuffer[this._vertexIndex++] = color.a * opacity;\n    vertexBuffer[this._vertexIndex++] = size * Math.max(transform.getScaleX(), transform.getScaleY());\n  }\n\n  private _isFull() {\n    if (this._pointCount >= this._maxPoints) {\n      return true;\n    }\n    return false;\n  }\n\n  hasPendingDraws(): boolean {\n    return this._pointCount !== 0;\n  }\n\n  flush(): void {\n    // nothing to draw early exit\n    if (this._pointCount === 0) {\n      return;\n    }\n\n    const gl = this._gl;\n    this._shader.use();\n    this._layout.use(true);\n\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\n\n    gl.drawArrays(gl.POINTS, 0, this._pointCount);\n\n    GraphicsDiagnostics.DrawnImagesCount += this._pointCount;\n    GraphicsDiagnostics.DrawCallCount++;\n\n    this._pointCount = 0;\n    this._vertexIndex = 0;\n  }\n}\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\nin float a_size;\\r\\nout lowp vec4 v_color;\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n  gl_PointSize = a_size * 2.0;\\r\\n  v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  float r = 0.0, delta = 0.0, alpha = 1.0;\\r\\n  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\\r\\n  r = dot(cxy, cxy);\\r\\n\\r\\n  delta = fwidth(r);\\r\\n  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\\r\\n  // \\\"premultiply\\\" the color by alpha\\r\\n  vec4 color = v_color;\\r\\n  color.a = color.a * alpha;\\r\\n  color.rgb = color.rgb * color.a;\\r\\n  fragColor = color;\\r\\n}\";","\r\nimport screenVertex from './screen-vertex.glsl';\r\nimport screenFragment from './screen-fragment.glsl';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { PostProcessor } from '../../PostProcessor/PostProcessor';\r\n\r\n/**\r\n * This is responsible for painting the entire screen during the render passes\r\n */\r\nexport class ScreenPassPainter {\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(gl: WebGL2RenderingContext) {\r\n    this._gl = gl;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: screenVertex,\r\n      fragmentSource: screenFragment\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1,          0, 0,\r\n        -1, 1,           0, 1,\r\n        1, -1,           1, 0,\r\n\r\n        1, -1,            1, 0,\r\n        -1, 1,           0, 1,\r\n        1, 1,            1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_texcoord', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  renderWithPostProcessor(postprocessor: PostProcessor): void {\r\n    const gl = this._gl;\r\n    postprocessor.getShader().use();\r\n    postprocessor.getLayout().use();\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n\r\n  renderToScreen(): void {\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use();\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n}","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n  // Pass the texcoord to the fragment shader.\\r\\n  v_texcoord = a_texcoord;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// The texture.\\r\\nuniform sampler2D u_texture;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n   fragColor = texture(u_texture, v_texcoord);\\r\\n}\";","import { Logger } from '../..';\r\n\r\n/**\r\n * Helper that defines and index buffer for quad geometry\r\n *\r\n * Index buffers allow you to save space in vertex buffers when you share vertices in geometry\r\n * it is almost always worth it in terms of performance to use an index buffer.\r\n */\r\nexport class QuadIndexBuffer {\r\n  private _gl: WebGL2RenderingContext;\r\n  private _logger: Logger = Logger.getInstance();\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the index buffer\r\n   */\r\n  public bufferData: Uint16Array | Uint32Array;\r\n  /**\r\n   * Depending on the browser this is either gl.UNSIGNED_SHORT or gl.UNSIGNED_INT\r\n   */\r\n  public bufferGlType: number;\r\n\r\n  /**\r\n   * @param gl WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   * @param numberOfQuads Specify the max number of quads you want to draw\r\n   * @param useUint16 Optionally force a uint16 buffer\r\n   */\r\n  constructor(gl: WebGL2RenderingContext, numberOfQuads: number, useUint16?: boolean) {\r\n    this._gl = gl;\r\n    this.buffer = gl.createBuffer();\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n\r\n    const totalVertices = numberOfQuads * 6;\r\n\r\n    if (!useUint16) {\r\n      this.bufferData = new Uint32Array(totalVertices);\r\n    } else {\r\n      // fall back to using gl.UNSIGNED_SHORT or tell the user they are out of luck\r\n      const maxUint16 = 65_535;\r\n      const maxUint16Index = Math.floor((maxUint16 - 1) / 4); // max quads\r\n\r\n      this.bufferGlType = gl.UNSIGNED_SHORT;\r\n      this.bufferData = new Uint16Array(totalVertices);\r\n      // TODO Should we error if this happens?? maybe not might crash mid game\r\n      if (numberOfQuads > maxUint16Index) {\r\n        this._logger.warn(\r\n          `Total quads exceeds hardware index buffer limit (uint16), max(${maxUint16Index}) requested quads(${numberOfQuads})`);\r\n      }\r\n    }\r\n\r\n\r\n    let currentQuad = 0;\r\n    for (let i = 0; i < totalVertices; i += 6) {\r\n      // first triangle\r\n      this.bufferData[i + 0] = currentQuad + 0;\r\n      this.bufferData[i + 1] = currentQuad + 1;\r\n      this.bufferData[i + 2] = currentQuad + 2;\r\n      // second triangle\r\n      this.bufferData[i + 3] = currentQuad + 2;\r\n      this.bufferData[i + 4] = currentQuad + 1;\r\n      this.bufferData[i + 5] = currentQuad + 3;\r\n      currentQuad += 4;\r\n    }\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  public get size() {\r\n    return this.bufferData.length;\r\n  }\r\n\r\n  /**\r\n   * Upload data to the GPU\r\n   */\r\n  public upload() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this index buffer\r\n   */\r\n  public bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n  }\r\n\r\n  public dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteBuffer(this.buffer);\r\n    this._gl = null;\r\n  }\r\n}","import { sign } from '../../../Math/util';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport frag from './image-renderer.frag.glsl';\r\nimport vert from './image-renderer.vert.glsl';\r\n\r\nexport interface ImageRendererOptions {\r\n  pixelArtSampler: boolean;\r\n  uvPadding: number;\r\n}\r\n\r\nexport class ImageRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.image';\r\n  public priority: number = 0;\r\n\r\n  public readonly pixelArtSampler: boolean;\r\n  public readonly uvPadding: number;\r\n\r\n  private _maxImages: number = 10922; // max(uint16) / 6 verts\r\n  private _maxTextures: number = 0;\r\n\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n\r\n  // Per flush vars\r\n  private _imageCount: number = 0;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _textureIndex = 0;\r\n  private _textureToIndex = new Map<WebGLTexture, number>();\r\n  private _images = new Set<HTMLImageSource>();\r\n  private _vertexIndex: number = 0;\r\n\r\n  constructor(options: ImageRendererOptions) {\r\n    this.pixelArtSampler = options.pixelArtSampler;\r\n    this.uvPadding = options.uvPadding;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // Transform shader source\r\n    // FIXME: PIXEL 6 complains `ERROR: Expression too complex.` if we use it's reported max texture units, 125 seems to work for now...\r\n    this._maxTextures = Math.min(gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS), 125);\r\n    const transformedFrag = this._transformFragmentSource(frag, this._maxTextures);\r\n    // Compile shader\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: transformedFrag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n    // Initialize texture slots to [0, 1, 2, 3, 4, .... maxGPUTextures]\r\n    this._shader.setUniformIntArray(\r\n      'u_textures',\r\n      [...Array(this._maxTextures)].map((_, i) => i)\r\n    );\r\n\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 12 * 4 * this._maxImages, // 12 components * 4 verts\r\n      type: 'dynamic'\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_opacity', 1],\r\n        ['a_res', 2],\r\n        ['a_texcoord', 2],\r\n        ['a_textureIndex', 1],\r\n        ['a_tint', 4]\r\n      ]\r\n    });\r\n\r\n    // Setup index buffer\r\n    this._quads = new QuadIndexBuffer(gl, this._maxImages, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._textures.length = 0;\r\n    this._context = null;\r\n    this._gl = null;\r\n  }\r\n\r\n  private _transformFragmentSource(source: string, maxTextures: number): string {\r\n    let newSource = source.replace('%%count%%', maxTextures.toString());\r\n    let texturePickerBuilder = '';\r\n    for (let i = 0; i < maxTextures; i++) {\r\n      if (i === 0) {\r\n        texturePickerBuilder += `if (v_textureIndex <= ${i}.5) {\\n`;\r\n      } else {\r\n        texturePickerBuilder += `   else if (v_textureIndex <= ${i}.5) {\\n`;\r\n      }\r\n      texturePickerBuilder += `      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;\\n`;\r\n      texturePickerBuilder += `      color = texture(u_textures[${i}], uv);\\n`;\r\n      texturePickerBuilder += `   }\\n`;\r\n    }\r\n    newSource = newSource.replace('%%texture_picker%%', texturePickerBuilder);\r\n    return newSource;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    if (this._images.has(image)) {\r\n      return;\r\n    }\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : null;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX));\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY));\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force);\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n      this._textureToIndex.set(texture, this._textureIndex++);\r\n      this._images.add(image);\r\n    }\r\n  }\r\n\r\n  private _bindTextures(gl: WebGLRenderingContext) {\r\n    // Bind textures in the correct order\r\n    for (let i = 0; i < this._maxTextures; i++) {\r\n      gl.activeTexture(gl.TEXTURE0 + i);\r\n      gl.bindTexture(gl.TEXTURE_2D, this._textures[i] || this._textures[0]);\r\n    }\r\n  }\r\n\r\n  private _getTextureIdForImage(image: HTMLImageSource) {\r\n    if (image) {\r\n      const maybeTexture = this._context.textureLoader.get(image);\r\n      return this._textureToIndex.get(maybeTexture) ?? -1; //this._textures.indexOf(maybeTexture);\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._imageCount >= this._maxImages) {\r\n      return true;\r\n    }\r\n    if (this._textures.length >= this._maxTextures) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _imageToWidth = new Map<HTMLImageSource, number>();\r\n  private _getImageWidth(image: HTMLImageSource) {\r\n    let maybeWidth = this._imageToWidth.get(image);\r\n    if (maybeWidth === undefined) {\r\n      maybeWidth = image.width;\r\n      this._imageToWidth.set(image, maybeWidth);\r\n    }\r\n    return maybeWidth;\r\n  }\r\n\r\n  private _imageToHeight = new Map<HTMLImageSource, number>();\r\n  private _getImageHeight(image: HTMLImageSource) {\r\n    let maybeHeight = this._imageToHeight.get(image);\r\n    if (maybeHeight === undefined) {\r\n      maybeHeight = image.height;\r\n      this._imageToHeight.set(image, maybeHeight);\r\n    }\r\n    return maybeHeight;\r\n  }\r\n\r\n\r\n  private _view = [0, 0, 0, 0];\r\n  private _dest = [0, 0];\r\n  private _quad = [0, 0, 0, 0, 0, 0, 0, 0];\r\n  draw(image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number): void {\r\n\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._imageCount++;\r\n    // This creates and uploads the texture if not already done\r\n    this._addImageAsTexture(image);\r\n    const maybeImageWidth = this._getImageWidth(image);\r\n    const maybeImageHeight = this._getImageHeight(image);\r\n\r\n    let width = maybeImageWidth || swidth || 0;\r\n    let height = maybeImageHeight || sheight || 0;\r\n    this._view[0] = 0;\r\n    this._view[1] = 0;\r\n    this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n    this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n    this._dest[0] = sx ?? 1;\r\n    this._dest[1] = sy ?? 1;\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      this._view[0] = sx ?? 1;\r\n      this._view[1] = sy ?? 1;\r\n      this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n      this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n      this._dest[0] = dx;\r\n      this._dest[1] = dy;\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = this._view[0];\r\n    sy = this._view[1];\r\n    const sw = this._view[2];\r\n    const sh = this._view[3];\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    // top left\r\n    this._quad[0] = this._dest[0];\r\n    this._quad[1] = this._dest[1];\r\n\r\n    // top right\r\n    this._quad[2] = this._dest[0] + width;\r\n    this._quad[3] = this._dest[1];\r\n\r\n    // bottom left\r\n    this._quad[4] = this._dest[0];\r\n    this._quad[5] = this._dest[1] + height;\r\n\r\n    // bottom right\r\n    this._quad[6] = this._dest[0] + width;\r\n    this._quad[7] = this._dest[1] + height;\r\n\r\n    transform.multiplyQuadInPlace(this._quad);\r\n\r\n    if (snapToPixel) {\r\n      this._quad[0] = ~~(this._quad[0] + sign(this._quad[0]) * pixelSnapEpsilon);\r\n      this._quad[1] = ~~(this._quad[1] + sign(this._quad[1]) * pixelSnapEpsilon);\r\n\r\n      this._quad[2] = ~~(this._quad[2] + sign(this._quad[2]) * pixelSnapEpsilon);\r\n      this._quad[3] = ~~(this._quad[3] + sign(this._quad[3]) * pixelSnapEpsilon);\r\n\r\n      this._quad[4] = ~~(this._quad[4] + sign(this._quad[4]) * pixelSnapEpsilon);\r\n      this._quad[5] = ~~(this._quad[5] + sign(this._quad[5]) * pixelSnapEpsilon);\r\n\r\n      this._quad[6] = ~~(this._quad[6] + sign(this._quad[6]) * pixelSnapEpsilon);\r\n      this._quad[7] = ~~(this._quad[7] + sign(this._quad[7]) * pixelSnapEpsilon);\r\n    }\r\n\r\n    const tint = this._context.tint;\r\n\r\n    const textureId = this._getTextureIdForImage(image);\r\n    const imageWidth = maybeImageWidth || width;\r\n    const imageHeight = maybeImageHeight || height;\r\n\r\n    const uvx0 = (sx + this.uvPadding) / imageWidth;\r\n    const uvy0 = (sy + this.uvPadding) / imageHeight;\r\n    const uvx1 = (sx + sw - this.uvPadding) / imageWidth;\r\n    const uvy1 = (sy + sh - this.uvPadding) / imageHeight;\r\n\r\n    const txWidth = maybeImageWidth;\r\n    const txHeight = maybeImageHeight;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = this._quad[0];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[1];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = this._quad[4];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[5];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = this._quad[2];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[3];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = this._quad[6];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[7];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._imageCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._imageCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true, 4 * 12 * this._imageCount); // 4 verts * 12 components\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Turn on pixel art aa sampler\r\n    this._shader.setUniformBoolean('u_pixelart', this.pixelArtSampler);\r\n\r\n    // Bind textures to\r\n    this._bindTextures(gl);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._imageCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._imageCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._imageCount = 0;\r\n    this._vertexIndex = 0;\r\n    this._textures.length = 0;\r\n    this._textureIndex = 0;\r\n    this._textureToIndex.clear();\r\n    this._images.clear();\r\n    this._imageToWidth.clear();\r\n    this._imageToHeight.clear();\r\n  }\r\n}","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// Texture index\\r\\nin lowp float v_textureIndex;\\r\\n\\r\\n// Textures in the current draw\\r\\nuniform sampler2D u_textures[%%count%%];\\r\\n\\r\\nuniform bool u_pixelart;\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nin vec4 v_tint;\\r\\n\\r\\nin vec2 v_res;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\n// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\\r\\nvec2 uv_iq(in vec2 uv, in vec2 texture_size) {\\r\\n  vec2 pixel = uv * texture_size;\\r\\n  \\r\\n  vec2 seam=floor(pixel+.5);\\r\\n  vec2 dudv=fwidth(pixel);\\r\\n  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\\r\\n  \\r\\n  return pixel/texture_size;\\r\\n}\\r\\n\\r\\nvoid main(){\\r\\n  // In order to support the most efficient sprite batching, we have multiple\\r\\n  // textures loaded into the gpu (usually 8) this picker logic skips over textures\\r\\n  // that do not apply to a particular sprite.\\r\\n  \\r\\n  vec4 color=vec4(1.,0,0,1.);\\r\\n  \\r\\n  // GLSL is templated out to pick the right texture and set the vec4 color\\r\\n  %%texture_picker%%\\r\\n  \\r\\n  color.rgb=color.rgb*v_opacity;\\r\\n  color.a=color.a*v_opacity;\\r\\n  fragColor=color*v_tint;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// Opacity\\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\n// Texture res\\r\\nin vec2 a_res;\\r\\nout vec2 v_res;\\r\\n\\r\\n// Texture number\\r\\nin lowp float a_textureIndex;\\r\\nout lowp float v_textureIndex;\\r\\n\\r\\nin vec4 a_tint;\\r\\nout vec4 v_tint;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main(){\\r\\n  // Set the vertex position using the ortho transform matrix\\r\\n  gl_Position=u_matrix*vec4(a_position,0.,1.);\\r\\n  \\r\\n  // Pass through the Opacity to the fragment shader\\r\\n  v_opacity=a_opacity;\\r\\n  // Pass through the UV coord to the fragment shader\\r\\n  v_texcoord=a_texcoord;\\r\\n\\r\\n  v_res = a_res;\\r\\n\\r\\n  // Pass through the texture number to the fragment shader\\r\\n  v_textureIndex=a_textureIndex;\\r\\n  // Pass through the tint\\r\\n  v_tint=a_tint;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './rectangle-renderer.frag.glsl';\r\nimport vert from './rectangle-renderer.vert.glsl';\r\n\r\nexport class RectangleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.rectangle';\r\n  public priority: number = 0;\r\n\r\n  private _maxRectangles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader: Shader;\r\n  private _gl: WebGLRenderingContext;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n  private _rectangleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 16 * 4 * this._maxRectangles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_size', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n    this._quads = new QuadIndexBuffer(gl, this._maxRectangles, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._context = null;\r\n    this._gl = null;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._rectangleCount >= this._maxRectangles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(...args: any[]): void {\r\n    if (args[0] instanceof Vector && args[1] instanceof Vector) {\r\n      this.drawLine.apply(this, args);\r\n    } else {\r\n      this.drawRectangle.apply(this, args);\r\n    }\r\n  }\r\n\r\n  drawLine(start: Vector, end: Vector, color: Color, thickness: number = 1) {\r\n\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const dir = end.sub(start);\r\n    const length = dir.size;\r\n    const normal = dir.normalize().perpendicular();\r\n    const halfThick = thickness / 2;\r\n\r\n    /**\r\n     *    +---------------------^----------------------+\r\n     *    |                     | (normal)             |\r\n     *   (startx, starty)------------------>(endx, endy)\r\n     *    |                                            |\r\n     *    + -------------------------------------------+\r\n     */\r\n    const startTop = transform.multiply(normal.scale(halfThick).add(start));\r\n    const startBottom = transform.multiply(normal.scale(-halfThick).add(start));\r\n    const endTop = transform.multiply(normal.scale(halfThick).add(end));\r\n    const endBottom = transform.multiply(normal.scale(-halfThick).add(end));\r\n\r\n    if (snapToPixel) {\r\n      startTop.x = ~~(startTop.x + pixelSnapEpsilon);\r\n      startTop.y = ~~(startTop.y + pixelSnapEpsilon);\r\n\r\n      endTop.x = ~~(endTop.x + pixelSnapEpsilon);\r\n      endTop.y = ~~(endTop.y + pixelSnapEpsilon);\r\n\r\n      startBottom.x = ~~(startBottom.x + pixelSnapEpsilon);\r\n      startBottom.y = ~~(startBottom.y + pixelSnapEpsilon);\r\n\r\n      endBottom.x = ~~(endBottom.x + pixelSnapEpsilon);\r\n      endBottom.y = ~~(endBottom.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    const stroke = Color.Transparent;\r\n    const strokeThickness = 0;\r\n    const width = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = startTop.x;\r\n    vertexBuffer[this._vertexIndex++] = startTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = startBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = startBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = endTop.x;\r\n    vertexBuffer[this._vertexIndex++] = endTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = endBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = endBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n  }\r\n\r\n  drawRectangle(\r\n    pos: Vector,\r\n    width: number,\r\n    height: number,\r\n    color: Color,\r\n    stroke: Color = Color.Transparent,\r\n    strokeThickness: number = 0): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(0, 0)));\r\n    const topRight = transform.multiply(pos.add(vec(width, 0)));\r\n    const bottomRight = transform.multiply(pos.add(vec(width, height)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(0, height)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._rectangleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._rectangleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._rectangleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._rectangleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._rectangleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n\r\n}","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\nin vec2 v_size; // in pixels\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness; // in pixels\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\\r\\n    vec2 uv = v_uv;\\r\\n    vec2 fragCoord = uv * v_size;\\r\\n    float maxX = v_size.x - v_strokeThickness;\\r\\n    float minX = v_strokeThickness;\\r\\n    float maxY = v_size.y - v_strokeThickness;\\r\\n    float minY = v_strokeThickness;\\r\\n\\r\\n    if (fragCoord.x < maxX && fragCoord.x > minX &&\\r\\n        fragCoord.y < maxY && fragCoord.y > minY) {\\r\\n      fragColor = v_color;\\r\\n    } else {\\r\\n      fragColor = v_strokeColor;\\r\\n    }\\r\\n    fragColor.a *= v_opacity;\\r\\n    fragColor.rgb *= fragColor.a;\\r\\n\\r\\n    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\\r\\n    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\\r\\n\\r\\n    // float fHalfBorderDist      = 0.0;\\r\\n    // float fHalfBorderThickness = 0.0;\\r\\n\\r\\n    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \\r\\n    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \\r\\n    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else\\r\\n    // {\\r\\n    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\\r\\n    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\\r\\n    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\\r\\n        \\r\\n    //     float ellipse_ab    = v_radius-v_strokeThickness;\\r\\n    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\\r\\n    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \\r\\n            \\r\\n    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\\r\\n    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\\r\\n    // }\\r\\n\\r\\n    // vec4 v4FromColor = v_strokeColor;\\r\\n    // v4FromColor.rgb *= v4FromColor.a;\\r\\n    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\\r\\n    // if (fHalfBorderDist < 0.0) {\\r\\n    //     v4ToColor = v_color;\\r\\n    //     v4ToColor.rgb *= v4ToColor.a;\\r\\n    // }\\r\\n\\r\\n    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\\r\\n\\r\\n    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\\r\\n    // gl_FragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\nin vec2 a_size;\\r\\nout vec2 v_size;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through size\\r\\n   v_size = a_size;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './circle-renderer.frag.glsl';\r\nimport vert from './circle-renderer.vert.glsl';\r\n\r\nexport class CircleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.circle';\r\n  public priority: number = 0;\r\n\r\n  private _maxCircles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader: Shader;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGLRenderingContext;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  private _quads: QuadIndexBuffer;\r\n\r\n  private _circleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 14 * 4 * this._maxCircles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n\r\n    this._quads = new QuadIndexBuffer(gl, this._maxCircles, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._context = null;\r\n    this._gl = null;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._circleCount >= this._maxCircles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(pos: Vector, radius: number, color: Color, stroke: Color = Color.Transparent, strokeThickness: number = 0): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._circleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(-radius, -radius)));\r\n    const topRight = transform.multiply(pos.add(vec(radius, -radius)));\r\n    const bottomRight = transform.multiply(pos.add(vec(radius, radius)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(-radius, radius)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO UV could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._circleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._circleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._circleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._circleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._circleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n\r\n}","export default \"#version 300 es\\r\\nprecision highp float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness;\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  // make (0, 0) the center the uv \\r\\n  vec2 uv = v_uv * 2.0 - 1.0;\\r\\n\\r\\n  vec4 color = v_color;\\r\\n  vec4 strokeColor = v_strokeColor;\\r\\n\\r\\n  // circle border is at radius 1.0 \\r\\n  // dist is > 0 when inside the circle \\r\\n  float d = length(uv);\\r\\n  float dist = 1.0 - length(uv);\\r\\n\\r\\n  // Fade based on fwidth\\r\\n  float fade = fwidth(dot(uv, uv));\\r\\n\\r\\n  // if dist is greater than 0 step to 1;\\r\\n  // when we cross this 0 threshold add a smooth fade\\r\\n  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\\r\\n\\r\\n  // if dist is greater than the stroke thickness step to 1\\r\\n  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\\r\\n\\r\\n  strokeColor.a *= fill * stroke;\\r\\n  strokeColor.rgb *= strokeColor.a;\\r\\n\\r\\n  color.a *= fill * (1.0 - stroke);\\r\\n  color.rgb *= color.a;\\r\\n\\r\\n  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\\r\\n  finalColor.rgb = finalColor.rgb * v_opacity;\\r\\n  finalColor.a = finalColor.a * v_opacity;\\r\\n  fragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Logger } from '../Util/Log';\nexport class Pool<Type> {\n  public totalAllocations = 0;\n  public index = 0;\n  public objects: Type[] = [];\n  public disableWarnings = false;\n  private _logger = Logger.getInstance();\n\n  constructor(\n    public builder: () => Type,\n    public recycler: (instance: Type) => Type,\n    public maxObjects: number = 100\n  ) {}\n\n  dispose() {\n    this.objects.length = 0;\n  }\n\n  preallocate() {\n    for (let i = 0; i < this.maxObjects; i++) {\n      this.objects[i] = this.builder();\n    }\n  }\n\n  /**\n   * Use many instances out of the in the context and return all to the pool.\n   *\n   * By returning values out of the context they will be un-hooked from the pool and are free to be passed to consumers\n   * @param context\n   */\n  using(context: (pool: Pool<Type>) => Type[] | void) {\n    const result = context(this);\n    if (result) {\n      return this.done(...result);\n    }\n    return this.done();\n  }\n\n  /**\n   * Use a single instance out of th pool and immediately return it to the pool\n   * @param context\n   */\n  borrow(context: (object: Type) => void) {\n    const object = this.get();\n    context(object);\n    this.index--;\n  }\n\n  /**\n   * Retrieve a value from the pool, will allocate a new instance if necessary or recycle from the pool\n   */\n  get(): Type {\n    if (this.index === this.maxObjects) {\n      if (!this.disableWarnings) {\n        this._logger.warn('Max pooled objects reached, possible memory leak? Doubling');\n      }\n      this.maxObjects = this.maxObjects * 2;\n    }\n\n    if (this.objects[this.index]) {\n      // Pool has an available object already constructed\n      return this.recycler(this.objects[this.index++]);\n    } else {\n      // New allocation\n      this.totalAllocations++;\n      const object = (this.objects[this.index++] = this.builder());\n      return object;\n    }\n  }\n\n  /**\n   * Signals we are done with the pool objects for now, Reclaims all objects in the pool.\n   *\n   * If a list of pooled objects is passed to done they are un-hooked from the pool and are free\n   * to be passed to consumers\n   * @param objects A list of object to separate from the pool\n   */\n  done(...objects: Type[]): Type[];\n  done(): void;\n  done(...objects: Type[]): Type[] | void {\n    // All objects in pool now considered \"free\"\n    this.index = 0;\n    for (const object of objects) {\n      const poolIndex = this.objects.indexOf(object);\n      // Build a new object to take the pool place\n      this.objects[poolIndex] = (this as any).builder();\n      this.totalAllocations++;\n    }\n    return objects;\n  }\n}\n","import { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\r\n\r\nexport class DrawCall {\r\n  public z: number = 0;\r\n  public priority: number = 0;\r\n  public renderer: string;\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public state: ExcaliburGraphicsContextState = {\r\n    z: 0,\r\n    opacity: 1,\r\n    tint: Color.White,\r\n    material: null\r\n  };\r\n  public args: any[];\r\n}","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from './ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL } from './ExcaliburGraphicsContextWebGL';\r\nimport { Shader } from './shader';\r\nimport { Logger } from '../../Util/Log';\r\nimport { ImageSource, ImageSourceAttributeConstants } from '../ImageSource';\r\nimport { ImageFiltering, parseImageFiltering } from '../Filtering';\r\nimport { parseImageWrapping } from '../Wrapping';\r\n\r\nexport interface MaterialOptions {\r\n  /**\r\n   * Name the material for debugging\r\n   */\r\n  name?: string;\r\n\r\n  /**\r\n   * Excalibur graphics context to create the material (only WebGL is supported at the moment)\r\n   */\r\n  graphicsContext?: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Optionally specify a vertex shader\r\n   *\r\n   * If none supplied the default will be used\r\n   *\r\n   * ```\r\n   *  #version 300 es\r\n   *  // vertex position in local space\r\n   *  in vec2 a_position;\r\n   *  in vec2 a_uv;\r\n   *  out vec2 v_uv;\r\n   *  // orthographic projection matrix\r\n   *  uniform mat4 u_matrix;\r\n   *  // world space transform matrix\r\n   *  uniform mat4 u_transform;\r\n   *  void main() {\r\n   *    // Set the vertex position using the ortho & transform matrix\r\n   *    gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);\r\n   *    // Pass through the UV coord to the fragment shader\r\n   *    v_uv = a_uv;\r\n   *  }\r\n   * ```\r\n   */\r\n  vertexSource?: string,\r\n\r\n  /**\r\n   * Add custom fragment shader\r\n   *\r\n   * *Note: Excalibur image alpha's are pre-multiplied\r\n   *\r\n   * Pre-built varyings:\r\n   *\r\n   * * `in vec2 v_uv` - UV coordinate\r\n   * * `in vec2 v_screenuv` - UV coordinate\r\n   *\r\n   * Pre-built uniforms:\r\n   *\r\n   * * `uniform sampler2D u_graphic` - The current graphic displayed by the GraphicsComponent\r\n   * * `uniform vec2 u_resolution` - The current resolution of the screen\r\n   * * `uniform vec2 u_size;` - The current size of the graphic\r\n   * * `uniform vec4 u_color` - The current color of the material\r\n   * * `uniform float u_opacity` - The current opacity of the graphics context\r\n   *\r\n   */\r\n  fragmentSource: string,\r\n\r\n  /**\r\n   * Add custom color, by default ex.Color.Transparent\r\n   */\r\n  color?: Color,\r\n\r\n  /**\r\n   * Add additional images to the material, you are limited by the GPU's maximum texture slots\r\n   *\r\n   * Specify a dictionary of uniform sampler names to ImageSource\r\n   */\r\n  images?: Record<string, ImageSource>\r\n}\r\n\r\nconst defaultVertexSource = `#version 300 es\r\nin vec2 a_position;\r\n\r\nin vec2 a_uv;\r\nout vec2 v_uv;\r\n\r\nin vec2 a_screenuv;\r\nout vec2 v_screenuv;\r\n\r\nuniform mat4 u_matrix;\r\nuniform mat4 u_transform;\r\n\r\nvoid main() {\r\n  // Set the vertex position using the ortho & transform matrix\r\n  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);\r\n\r\n  // Pass through the UV coord to the fragment shader\r\n  v_uv = a_uv;\r\n  v_screenuv = a_screenuv;\r\n}\r\n`;\r\n\r\nexport interface MaterialImageOptions {\r\n  filtering?: ImageFiltering,\r\n\r\n}\r\n\r\nexport class Material {\r\n  private _logger = Logger.getInstance();\r\n  private _name: string;\r\n  private _shader: Shader;\r\n  private _color: Color = Color.Transparent;\r\n  private _initialized = false;\r\n  private _fragmentSource: string;\r\n  private _vertexSource: string;\r\n\r\n  private _images = new Map<string, ImageSource>();\r\n  private _textures = new Map<ImageSource, WebGLTexture>();\r\n  private _maxTextureSlots: number;\r\n  private _graphicsContext: ExcaliburGraphicsContextWebGL;\r\n\r\n  constructor(options: MaterialOptions) {\r\n    const { color, name, vertexSource, fragmentSource, graphicsContext, images } = options;\r\n    this._name = name ?? 'anonymous material';\r\n    this._vertexSource = vertexSource ?? defaultVertexSource;\r\n    this._fragmentSource = fragmentSource;\r\n    this._color = color ?? this._color;\r\n    if (!graphicsContext) {\r\n      throw Error(`Material ${name} must be provided an excalibur webgl graphics context`);\r\n    }\r\n    if (graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      this._graphicsContext = graphicsContext;\r\n      this._initialize(graphicsContext);\r\n    } else {\r\n      this._logger.warn(`Material ${name} was created in 2D Canvas mode, currently only WebGL is supported`);\r\n    }\r\n\r\n    if (images) {\r\n      for (const key in images) {\r\n        this.addImageSource(key, images[key]);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _initialize(graphicsContextWebGL: ExcaliburGraphicsContextWebGL) {\r\n    if (this._initialized) {\r\n      return;\r\n    }\r\n    const gl = graphicsContextWebGL.__gl;\r\n    // max texture slots - 2 for the graphic texture and screen texture\r\n    this._maxTextureSlots = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS) - 2;\r\n    this._shader = graphicsContextWebGL.createShader({\r\n      vertexSource: this._vertexSource,\r\n      fragmentSource: this._fragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._initialized = true;\r\n  }\r\n\r\n  get name() {\r\n    return this._name ?? 'anonymous material';\r\n  }\r\n\r\n  get isUsingScreenTexture() {\r\n    return this._fragmentSource.includes('u_screen_texture');\r\n  }\r\n\r\n  update(callback: (shader: Shader) => any) {\r\n    if (this._shader) {\r\n      this._shader.use();\r\n      callback(this._shader);\r\n    }\r\n  }\r\n\r\n  getShader(): Shader | null {\r\n    return this._shader;\r\n  }\r\n\r\n  addImageSource(textureUniformName: string, image: ImageSource) {\r\n    if (this._images.size < this._maxTextureSlots) {\r\n      this._images.set(textureUniformName, image);\r\n    } else {\r\n      this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material \"${this.name}\", `+\r\n      `no more textures will be uploaded due to hardware constraints.`);\r\n    }\r\n  }\r\n\r\n  removeImageSource(textureName: string) {\r\n    const image = this._images.get(textureName);\r\n    this._graphicsContext.textureLoader.delete(image.image);\r\n    this._images.delete(textureName);\r\n  }\r\n\r\n  private _loadImageSource(image: ImageSource) {\r\n    const imageElement = image.image;\r\n    const maybeFiltering = imageElement.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : null;\r\n    const wrapX = parseImageWrapping(imageElement.getAttribute(ImageSourceAttributeConstants.WrappingX));\r\n    const wrapY = parseImageWrapping(imageElement.getAttribute(ImageSourceAttributeConstants.WrappingY));\r\n\r\n    const force = imageElement.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._graphicsContext.textureLoader.load(\r\n      imageElement,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force);\r\n    // remove force attribute after upload\r\n    imageElement.removeAttribute('forceUpload');\r\n    if (!this._textures.has(image)) {\r\n      this._textures.set(image, texture);\r\n    }\r\n\r\n    return texture;\r\n  }\r\n\r\n  uploadAndBind(gl: WebGL2RenderingContext, startingTextureSlot: number = 2) {\r\n\r\n    let textureSlot = startingTextureSlot;\r\n    for (const [textureName, image] of this._images.entries()) {\r\n      if (!image.isLoaded()) {\r\n        this._logger.warnOnce(`Image named ${textureName} in material ${this.name} not loaded, nothing will be uploaded to the shader.` +\r\n        ` Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);\r\n        continue;\r\n      } // skip unloaded images, maybe warn\r\n      const texture = this._loadImageSource(image);\r\n\r\n      gl.activeTexture(gl.TEXTURE0 + textureSlot);\r\n      gl.bindTexture(gl.TEXTURE_2D, texture);\r\n      this._shader.trySetUniformInt(textureName, textureSlot);\r\n\r\n      textureSlot++;\r\n    }\r\n  }\r\n\r\n  use() {\r\n    if (this._initialized) {\r\n      // bind the shader\r\n      this._shader.use();\r\n      // Apply standard uniforms\r\n      this._shader.trySetUniformFloatColor('u_color', this._color);\r\n\r\n    } else {\r\n      throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`);\r\n    }\r\n  }\r\n}","import { vec } from '../../../Math/vector';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\n\r\nexport class MaterialRenderer implements RendererPlugin {\r\n  public readonly type: string = 'ex.material';\r\n  public priority: number = 0;\r\n  // private _maxTextures = 8;\r\n  private _context: ExcaliburGraphicsContextWebGL;\r\n  private _gl: WebGL2RenderingContext;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _quads: any;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 6 * 4, // 6 components * 4 verts\r\n      type: 'dynamic'\r\n    });\r\n\r\n    // Setup a vertex layout/buffer to the material\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_screenuv', 2]\r\n      ],\r\n      suppressWarnings: true\r\n    });\r\n\r\n    // Setup index buffer\r\n    this._quads = new QuadIndexBuffer(gl, 1, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._textures.length = 0;\r\n    this._context = null;\r\n    this._gl = null;\r\n  }\r\n\r\n  draw(image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number): void {\r\n    const gl = this._gl;\r\n\r\n    // Extract context info\r\n    const material = this._context.material;\r\n\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n\r\n    // material shader\r\n    const shader = material.getShader();\r\n\r\n    // construct geometry, or hold on to it in the material?\r\n    // geometry primitive for drawing rectangles?\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n    let vertexIndex = 0;\r\n\r\n    let width = image?.width || swidth || 0;\r\n    let height = image?.height || sheight || 0;\r\n    let view = [0, 0, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n    let dest = [sx ?? 1, sy ?? 1];\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      view = [sx ?? 1, sy ?? 1, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n      dest = [dx, dy];\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = view[0];\r\n    sy = view[1];\r\n    const sw = view[2];\r\n    const sh = view[3];\r\n\r\n    const topLeft = vec(dest[0], dest[1]);\r\n    const topRight = vec(dest[0] + width, dest[1]);\r\n    const bottomLeft = vec(dest[0], dest[1] + height);\r\n    const bottomRight = vec(dest[0] + width, dest[1] + height);\r\n\r\n    const imageWidth = image.width || width;\r\n    const imageHeight = image.height || height;\r\n\r\n    const uvx0 = (sx) / imageWidth;\r\n    const uvy0 = (sy) / imageHeight;\r\n    const uvx1 = (sx + sw - 0.01) / imageWidth;\r\n    const uvy1 = (sy + sh - 0.01) / imageHeight;\r\n\r\n    const topLeftScreen = transform.getPosition();\r\n    const bottomRightScreen = topLeftScreen.add(bottomRight);\r\n    const screenUVX0 = topLeftScreen.x / this._context.width;\r\n    const screenUVY0 = topLeftScreen.y / this._context.height;\r\n    const screenUVX1 = bottomRightScreen.x / this._context.width;\r\n    const screenUVY1 = bottomRightScreen.y / this._context.height;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[vertexIndex++] = topLeft.x;\r\n    vertexBuffer[vertexIndex++] = topLeft.y;\r\n    vertexBuffer[vertexIndex++] = uvx0;\r\n    vertexBuffer[vertexIndex++] = uvy0;\r\n    vertexBuffer[vertexIndex++] = screenUVX0;\r\n    vertexBuffer[vertexIndex++] = screenUVY0;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[vertexIndex++] = uvx0;\r\n    vertexBuffer[vertexIndex++] = uvy1;\r\n    vertexBuffer[vertexIndex++] = screenUVX0;\r\n    vertexBuffer[vertexIndex++] = screenUVY1;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[vertexIndex++] = topRight.x;\r\n    vertexBuffer[vertexIndex++] = topRight.y;\r\n    vertexBuffer[vertexIndex++] = uvx1;\r\n    vertexBuffer[vertexIndex++] = uvy0;\r\n    vertexBuffer[vertexIndex++] = screenUVX1;\r\n    vertexBuffer[vertexIndex++] = screenUVY0;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[vertexIndex++] = uvx1;\r\n    vertexBuffer[vertexIndex++] = uvy1;\r\n    vertexBuffer[vertexIndex++] = screenUVX1;\r\n    vertexBuffer[vertexIndex++] = screenUVY1;\r\n\r\n    // This creates and uploads the texture if not already done\r\n    const texture = this._addImageAsTexture(image);\r\n\r\n    // apply material\r\n    material.use();\r\n\r\n    this._layout.shader = shader;\r\n    // apply layout and geometry\r\n    this._layout.use(true);\r\n\r\n    // apply time in ms since the page (performance.now())\r\n    shader.trySetUniformFloat('u_time_ms', performance.now());\r\n\r\n    // apply opacity\r\n    shader.trySetUniformFloat('u_opacity', opacity);\r\n\r\n    // apply resolution\r\n    shader.trySetUniformFloatVector('u_resolution', vec(this._context.width, this._context.height));\r\n\r\n    // apply graphic resolution\r\n    shader.trySetUniformFloatVector('u_graphic_resolution', vec(imageWidth, imageHeight));\r\n\r\n    // apply size\r\n    shader.trySetUniformFloatVector('u_size', vec(sw, sh));\r\n\r\n    // apply orthographic projection\r\n    shader.trySetUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // apply geometry transform\r\n    shader.trySetUniformMatrix('u_transform', transform.to4x4());\r\n\r\n    // bind graphic image texture 'uniform sampler2D u_graphic;'\r\n    gl.activeTexture(gl.TEXTURE0 + 0);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n    shader.trySetUniformInt('u_graphic', 0);\r\n\r\n    // bind the screen texture\r\n    gl.activeTexture(gl.TEXTURE0 + 1);\r\n    gl.bindTexture(gl.TEXTURE_2D, this._context.materialScreenTexture);\r\n    shader.trySetUniformInt('u_screen_texture', 1);\r\n\r\n    // bind any additional textures in the material\r\n    material.uploadAndBind(gl);\r\n\r\n    // bind quad index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw a single quad\r\n    gl.drawElements(gl.TRIANGLES, 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount++;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : null;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX));\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY));\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force);\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n    }\r\n\r\n    return texture;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return false;\r\n  }\r\n  flush(): void {\r\n    // flush does not do anything, material renderer renders immediately per draw\r\n  }\r\n}","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  RectGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\n\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { TransformStack } from './transform-stack';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { Logger } from '../../Util/Log';\r\nimport { DebugText } from './debug-text';\r\nimport { Resolution } from '../../Screen';\r\nimport { RenderTarget } from './render-target';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { TextureLoader } from './texture-loader';\r\nimport { RendererPlugin } from './renderer';\r\n\r\n// renderers\r\nimport { LineRenderer } from './line-renderer/line-renderer';\r\nimport { PointRenderer } from './point-renderer/point-renderer';\r\nimport { ScreenPassPainter } from './screen-pass-painter/screen-pass-painter';\r\nimport { ImageRenderer } from './image-renderer/image-renderer';\r\nimport { RectangleRenderer } from './rectangle-renderer/rectangle-renderer';\r\nimport { CircleRenderer } from './circle-renderer/circle-renderer';\r\nimport { Pool } from '../../Util/Pool';\r\nimport { DrawCall } from './draw-call';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\nimport { MaterialRenderer } from './material-renderer/material-renderer';\r\nimport { Shader, ShaderOptions } from './shader';\r\n\r\nexport const pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContextWebGLDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _webglCtx: ExcaliburGraphicsContextWebGL) {}\r\n\r\n  /**\r\n   * Draw a debugging rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number, rectOptions: RectGraphicsOptions = { color: Color.Black }): void {\r\n    this.drawLine(vec(x, y), vec(x + width, y), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y), vec(x + width, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y + height), vec(x, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x, y + height), vec(x, y), { ...rectOptions });\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging line to the context\r\n   * @param start\r\n   * @param end\r\n   * @param lineOptions\r\n   */\r\n  drawLine(start: Vector, end: Vector, lineOptions: LineGraphicsOptions = { color: Color.Black }): void {\r\n    this._webglCtx.draw<LineRenderer>('ex.line', start, end, lineOptions.color);\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging point to the context\r\n   * @param point\r\n   * @param pointOptions\r\n   */\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._webglCtx.draw<PointRenderer>('ex.point', point, pointOptions.color, pointOptions.size);\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._webglCtx, text, pos);\r\n  }\r\n}\r\n\r\nexport interface WebGLGraphicsContextInfo {\r\n  transform: TransformStack;\r\n  state: StateStack;\r\n  ortho: Matrix;\r\n  context: ExcaliburGraphicsContextWebGL;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContextWebGLOptions extends ExcaliburGraphicsContextOptions {\r\n  context?: WebGL2RenderingContext,\r\n  handleContextLost?: (e: Event) => void,\r\n  handleContextRestored?: (e: Event) => void\r\n}\r\n\r\nexport class ExcaliburGraphicsContextWebGL implements ExcaliburGraphicsContext {\r\n  private _logger = Logger.getInstance();\r\n  private _renderers: Map<string, RendererPlugin> = new Map<string, RendererPlugin>();\r\n  private _isDrawLifecycle = false;\r\n  public useDrawSorting = true;\r\n\r\n  private _drawCallPool = new Pool<DrawCall>(\r\n    () => new DrawCall(),\r\n    (instance) => {\r\n      instance.priority = 0;\r\n      instance.z = 0;\r\n      instance.renderer = undefined;\r\n      instance.args = undefined;\r\n      return instance;\r\n    }, 4000);\r\n\r\n  private _drawCallIndex = 0;\r\n  private _drawCalls: DrawCall[] = (new Array(4000)).fill(null);\r\n\r\n  // Main render target\r\n  private _renderTarget: RenderTarget;\r\n\r\n  // Quad boundary MSAA\r\n  private _msaaTarget: RenderTarget;\r\n\r\n  // Postprocessing is a tuple with 2 render targets, these are flip-flopped during the postprocessing process\r\n  private _postProcessTargets: RenderTarget[] = [];\r\n\r\n  private _screenRenderer: ScreenPassPainter;\r\n\r\n  private _postprocessors: PostProcessor[] = [];\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __gl: WebGL2RenderingContext;\r\n\r\n  private _transform = new TransformStack();\r\n  private _state = new StateStack();\r\n  private _ortho!: Matrix;\r\n\r\n  /**\r\n   * Snaps the drawing x/y coordinate to the nearest whole pixel\r\n   */\r\n  public snapToPixel: boolean = false;\r\n\r\n  /**\r\n   * Native context smoothing\r\n   */\r\n  public readonly smoothing: boolean = false;\r\n\r\n\r\n  /**\r\n   * Whether the pixel art sampler is enabled for smooth sub pixel anti-aliasing\r\n   */\r\n  public readonly pixelArtSampler: boolean = false;\r\n\r\n  /**\r\n   * UV padding in pixels to use in internal image rendering to prevent texture bleed\r\n   *\r\n   */\r\n  public uvPadding = .01;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  public textureLoader: TextureLoader;\r\n\r\n  public materialScreenTexture: WebGLTexture;\r\n\r\n  public get z(): number {\r\n    return this._state.current.z;\r\n  }\r\n\r\n  public set z(value: number) {\r\n    this._state.current.z = value;\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public get width() {\r\n    return this.__gl.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__gl.canvas.height;\r\n  }\r\n\r\n  public get ortho(): Matrix {\r\n    return this._ortho;\r\n  }\r\n\r\n  /**\r\n   * Checks the underlying webgl implementation if the requested internal resolution is supported\r\n   * @param dim\r\n   */\r\n  public checkIfResolutionSupported(dim: Resolution): boolean {\r\n    // Slight hack based on this thread https://groups.google.com/g/webgl-dev-list/c/AHONvz3oQTo\r\n    let supported = true;\r\n    if (dim.width > 4096 || dim.height > 4096) {\r\n      supported = false;\r\n    }\r\n    return supported;\r\n  }\r\n\r\n  public readonly multiSampleAntialiasing: boolean = true;\r\n  public readonly samples?: number;\r\n  public readonly transparency: boolean = true;\r\n  private _isContextLost = false;\r\n\r\n  constructor(options: ExcaliburGraphicsContextWebGLOptions) {\r\n    const {\r\n      canvasElement,\r\n      context,\r\n      enableTransparency,\r\n      antialiasing,\r\n      uvPadding,\r\n      multiSampleAntialiasing,\r\n      pixelArtSampler,\r\n      powerPreference,\r\n      snapToPixel,\r\n      backgroundColor,\r\n      useDrawSorting,\r\n      handleContextLost,\r\n      handleContextRestored\r\n    } = options;\r\n    this.__gl = context ?? canvasElement.getContext('webgl2', {\r\n      antialias: antialiasing ?? this.smoothing,\r\n      premultipliedAlpha: false,\r\n      alpha: enableTransparency ?? this.transparency,\r\n      depth: false,\r\n      powerPreference: powerPreference ?? 'high-performance'\r\n    });\r\n    if (!this.__gl) {\r\n      throw Error('Failed to retrieve webgl context from browser');\r\n    }\r\n\r\n    if (handleContextLost) {\r\n      this.__gl.canvas.addEventListener('webglcontextlost', handleContextLost, false);\r\n    }\r\n\r\n    if (handleContextRestored) {\r\n      this.__gl.canvas.addEventListener('webglcontextrestored', handleContextRestored, false);\r\n    }\r\n\r\n    this.__gl.canvas.addEventListener('webglcontextlost', () => {\r\n      this._isContextLost = true;\r\n    });\r\n\r\n    this.__gl.canvas.addEventListener('webglcontextrestored', () => {\r\n      this._isContextLost = false;\r\n    });\r\n\r\n    this.textureLoader = new TextureLoader(this.__gl);\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = antialiasing ?? this.smoothing;\r\n    this.transparency = enableTransparency ?? this.transparency;\r\n    this.pixelArtSampler = pixelArtSampler ?? this.pixelArtSampler;\r\n    this.uvPadding = uvPadding ?? this.uvPadding;\r\n    this.multiSampleAntialiasing = typeof multiSampleAntialiasing === 'boolean' ? multiSampleAntialiasing : this.multiSampleAntialiasing;\r\n    this.samples = typeof multiSampleAntialiasing === 'object' ? multiSampleAntialiasing.samples : undefined;\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.useDrawSorting = useDrawSorting ?? this.useDrawSorting;\r\n    this._drawCallPool.disableWarnings = true;\r\n    this._drawCallPool.preallocate();\r\n    this._init();\r\n  }\r\n\r\n  private _disposed = false;\r\n  public dispose() {\r\n    if (!this._disposed) {\r\n      this._disposed = true;\r\n      this.textureLoader.dispose();\r\n      for (const renderer of this._renderers.values()) {\r\n        renderer.dispose();\r\n      }\r\n      this._renderers.clear();\r\n      this._drawCallPool.dispose();\r\n      this._drawCalls.length = 0;\r\n      this.__gl = null;\r\n    }\r\n  }\r\n\r\n  private _init() {\r\n    const gl = this.__gl;\r\n    // Setup viewport and view matrix\r\n    this._ortho = Matrix.ortho(0, gl.canvas.width, gl.canvas.height, 0, 400, -400);\r\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\r\n\r\n    // Clear background\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    // Enable alpha blending\r\n    // https://www.realtimerendering.com/blog/gpus-prefer-premultiplication/\r\n    gl.enable(gl.BLEND);\r\n    gl.blendEquation(gl.FUNC_ADD);\r\n    gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n    gl.blendEquationSeparate(gl.FUNC_ADD, gl.FUNC_ADD);\r\n    gl.blendFuncSeparate(gl.ONE, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n    // Setup builtin renderers\r\n    this.register(new ImageRenderer({\r\n      uvPadding: this.uvPadding,\r\n      pixelArtSampler: this.pixelArtSampler\r\n    }));\r\n    this.register(new MaterialRenderer());\r\n    this.register(new RectangleRenderer());\r\n    this.register(new CircleRenderer());\r\n    this.register(new PointRenderer());\r\n    this.register(new LineRenderer());\r\n\r\n\r\n    this.materialScreenTexture = gl.createTexture();\r\n    gl.bindTexture(gl.TEXTURE_2D, this.materialScreenTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n    this._screenRenderer = new ScreenPassPainter(gl);\r\n\r\n    this._renderTarget = new RenderTarget({\r\n      gl,\r\n      transparency: this.transparency,\r\n      width: gl.canvas.width,\r\n      height: gl.canvas.height\r\n    });\r\n\r\n    this._postProcessTargets = [\r\n      new RenderTarget({\r\n        gl,\r\n        transparency: this.transparency,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      }),\r\n      new RenderTarget({\r\n        gl,\r\n        transparency: this.transparency,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      })\r\n    ];\r\n\r\n    this._msaaTarget = new RenderTarget({\r\n      gl,\r\n      transparency: this.transparency,\r\n      width: gl.canvas.width,\r\n      height: gl.canvas.height,\r\n      antialias: this.multiSampleAntialiasing,\r\n      samples: this.samples\r\n    });\r\n  }\r\n\r\n  public register<T extends RendererPlugin>(renderer: T) {\r\n    this._renderers.set(renderer.type, renderer);\r\n    renderer.initialize(this.__gl, this);\r\n  }\r\n\r\n  public get(rendererName: string): RendererPlugin {\r\n    return this._renderers.get(rendererName);\r\n  }\r\n\r\n  private _currentRenderer: RendererPlugin;\r\n\r\n  private _isCurrentRenderer(renderer: RendererPlugin): boolean {\r\n    if (!this._currentRenderer || this._currentRenderer === renderer) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    this._isDrawLifecycle = true;\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    this._isDrawLifecycle = false;\r\n  }\r\n\r\n  public draw<TRenderer extends RendererPlugin>(rendererName: TRenderer['type'], ...args: Parameters<TRenderer['draw']>) {\r\n    if (!this._isDrawLifecycle) {\r\n      this._logger.warnOnce(\r\n        `Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.\\n` +\r\n        `If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`);\r\n    }\r\n    if (this._isContextLost) {\r\n      this._logger.errorOnce(`Unable to draw ${rendererName}, the webgl context is lost`);\r\n      return;\r\n    }\r\n\r\n    const renderer = this._renderers.get(rendererName);\r\n    if (renderer) {\r\n      if (this.useDrawSorting) {\r\n        const drawCall = this._drawCallPool.get();\r\n        drawCall.z = this._state.current.z;\r\n        drawCall.priority = renderer.priority;\r\n        drawCall.renderer = rendererName;\r\n        this.getTransform().clone(drawCall.transform);\r\n        drawCall.state.z = this._state.current.z;\r\n        drawCall.state.opacity = this._state.current.opacity;\r\n        drawCall.state.tint = this._state.current.tint;\r\n        drawCall.state.material = this._state.current.material;\r\n        drawCall.args = args;\r\n        this._drawCalls[this._drawCallIndex++] = drawCall;\r\n      } else {\r\n        // Set the current renderer if not defined\r\n        if (!this._currentRenderer) {\r\n          this._currentRenderer = renderer;\r\n        }\r\n\r\n        if (!this._isCurrentRenderer(renderer)) {\r\n          // switching graphics means we must flush the previous\r\n          this._currentRenderer.flush();\r\n        }\r\n\r\n        // If we are still using the same renderer we can add to the current batch\r\n        renderer.draw(...args);\r\n\r\n        this._currentRenderer = renderer;\r\n      }\r\n    } else {\r\n      throw Error(`No renderer with name ${rendererName} has been registered`);\r\n    }\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this._transform.current = AffineMatrix.identity();\r\n  }\r\n\r\n  public updateViewport(resolution: Resolution): void {\r\n    const gl = this.__gl;\r\n    this._ortho = this._ortho = Matrix.ortho(0, resolution.width, resolution.height, 0, 400, -400);\r\n\r\n    this._renderTarget.setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._msaaTarget.setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[0].setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[1].setResolution(gl.canvas.width, gl.canvas.height);\r\n  }\r\n\r\n  private _imageToWidth = new Map<HTMLImageSource, number>();\r\n  private _getImageWidth(image: HTMLImageSource) {\r\n    let maybeWidth = this._imageToWidth.get(image);\r\n    if (maybeWidth === undefined) {\r\n      maybeWidth = image.width;\r\n      this._imageToWidth.set(image, maybeWidth);\r\n    }\r\n    return maybeWidth;\r\n  }\r\n\r\n  private _imageToHeight = new Map<HTMLImageSource, number>();\r\n  private _getImageHeight(image: HTMLImageSource) {\r\n    let maybeHeight = this._imageToHeight.get(image);\r\n    if (maybeHeight === undefined) {\r\n      maybeHeight = image.height;\r\n      this._imageToHeight.set(image, maybeHeight);\r\n    }\r\n    return maybeHeight;\r\n  }\r\n\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (this._getImageWidth(image) === 0 || this._getImageHeight(image) === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    if (!image) {\r\n      Logger.getInstance().warn('Cannot draw a null or undefined image');\r\n      // tslint:disable-next-line: no-console\r\n      if (console.trace) {\r\n        // tslint:disable-next-line: no-console\r\n        console.trace();\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (this._state.current.material) {\r\n      this.draw<MaterialRenderer>('ex.material', image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n    } else {\r\n      this.draw<ImageRenderer>('ex.image', image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n    }\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', start, end, color, thickness);\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color, stroke?: Color, strokeThickness?: number) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', pos, width, height, color, stroke, strokeThickness);\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.draw<CircleRenderer>('ex.circle', pos, radius, color, stroke, thickness);\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContextWebGLDebug(this);\r\n\r\n  public save(): void {\r\n    this._transform.save();\r\n    this._state.save();\r\n  }\r\n\r\n  public restore(): void {\r\n    this._transform.restore();\r\n    this._state.restore();\r\n  }\r\n\r\n  public translate(x: number, y: number): void {\r\n    this._transform.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  public rotate(angle: number): void {\r\n    this._transform.rotate(angle);\r\n  }\r\n\r\n  public scale(x: number, y: number): void {\r\n    this._transform.scale(x, y);\r\n  }\r\n\r\n  public transform(matrix: AffineMatrix) {\r\n    this._transform.current = matrix;\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    return this._transform.current;\r\n  }\r\n\r\n  public multiply(m: AffineMatrix) {\r\n    this._transform.current.multiply(m, this._transform.current);\r\n  }\r\n\r\n  public addPostProcessor(postprocessor: PostProcessor) {\r\n    this._postprocessors.push(postprocessor);\r\n    postprocessor.initialize(this.__gl);\r\n  }\r\n\r\n  public removePostProcessor(postprocessor: PostProcessor) {\r\n    const index = this._postprocessors.indexOf(postprocessor);\r\n    if (index !== -1) {\r\n      this._postprocessors.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    this._postprocessors.length = 0;\r\n  }\r\n\r\n  private _totalPostProcessorTime = 0;\r\n  public updatePostProcessors(delta: number) {\r\n    for (const postprocessor of this._postprocessors) {\r\n      const shader = postprocessor.getShader();\r\n      shader.use();\r\n      const uniforms = shader.getUniforms();\r\n      this._totalPostProcessorTime += delta;\r\n\r\n      if (uniforms.find(u => u.name ==='u_time_ms')) {\r\n        shader.setUniformFloat('u_time_ms', this._totalPostProcessorTime);\r\n      }\r\n      if (uniforms.find(u => u.name ==='u_elapsed_ms')) {\r\n        shader.setUniformFloat('u_elapsed_ms', delta);\r\n      }\r\n      if (uniforms.find(u => u.name ==='u_resolution')) {\r\n        shader.setUniformFloatVector('u_resolution', vec(this.width, this.height));\r\n      }\r\n\r\n      if (postprocessor.onUpdate) {\r\n        postprocessor.onUpdate(delta);\r\n      }\r\n    }\r\n  }\r\n\r\n  public set material(material: Material) {\r\n    this._state.current.material = material;\r\n  }\r\n\r\n  public get material(): Material | null {\r\n    return this._state.current.material;\r\n  }\r\n\r\n  /**\r\n   * Creates and initializes the material which compiles the internal shader\r\n   * @param options\r\n   * @returns Material\r\n   */\r\n  public createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material {\r\n    const material = new Material({...options, graphicsContext: this});\r\n    return material;\r\n  }\r\n\r\n  public createShader(options: Omit<ShaderOptions, 'gl'>): Shader {\r\n    const gl = this.__gl;\r\n    const { vertexSource, fragmentSource } = options;\r\n    const shader = new Shader({\r\n      gl,\r\n      vertexSource,\r\n      fragmentSource\r\n    });\r\n    shader.compile();\r\n    return shader;\r\n  }\r\n\r\n  clear() {\r\n    const gl = this.__gl;\r\n    const currentTarget = this.multiSampleAntialiasing ? this._msaaTarget : this._renderTarget;\r\n    currentTarget.use();\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    // Clear the context with the newly set color. This is\r\n    // the function call that actually does the drawing.\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n  }\r\n\r\n  /**\r\n   * Flushes all batched rendering to the screen\r\n   */\r\n  flush() {\r\n    if (this._isContextLost) {\r\n      this._logger.errorOnce(`Unable to flush the webgl context is lost`);\r\n      return;\r\n    }\r\n\r\n    // render target captures all draws and redirects to the render target\r\n    let currentTarget = this.multiSampleAntialiasing ? this._msaaTarget : this._renderTarget;\r\n    currentTarget.use();\r\n\r\n    if (this.useDrawSorting) {\r\n      // null out unused draw calls\r\n      for (let i = this._drawCallIndex; i < this._drawCalls.length; i++) {\r\n        this._drawCalls[i] = null;\r\n      }\r\n      // sort draw calls\r\n      // Find the original order of the first instance of the draw call\r\n      const originalSort = new Map<string, number>();\r\n      for (const [name] of this._renderers) {\r\n        let firstIndex = 0;\r\n        for (firstIndex = 0; firstIndex < this._drawCallIndex; firstIndex++) {\r\n          if (this._drawCalls[firstIndex].renderer === name) {\r\n            break;\r\n          }\r\n        }\r\n        originalSort.set(name, firstIndex);\r\n      }\r\n\r\n      this._drawCalls.sort((a, b) => {\r\n        if (a === null || b === null) {\r\n          return 0;\r\n        }\r\n        const zIndex = a.z - b.z;\r\n        const originalSortOrder = originalSort.get(a.renderer) - originalSort.get(b.renderer);\r\n        const priority = a.priority - b.priority;\r\n        if (zIndex === 0) { // sort by z first\r\n          if (priority === 0) { // sort by priority\r\n            return originalSortOrder; // use the original order to inform draw call packing to maximally preserve painter order\r\n          }\r\n          return priority;\r\n        }\r\n        return zIndex;\r\n      });\r\n\r\n      const oldTransform = this._transform.current;\r\n      const oldState = this._state.current;\r\n\r\n      if (this._drawCalls.length && this._drawCallIndex) {\r\n        let currentRendererName = this._drawCalls[0].renderer;\r\n        let currentRenderer = this._renderers.get(currentRendererName);\r\n        for (let i = 0; i < this._drawCallIndex; i++) {\r\n          // hydrate the state for renderers\r\n          this._transform.current = this._drawCalls[i].transform;\r\n          this._state.current = this._drawCalls[i].state;\r\n\r\n          if (this._drawCalls[i].renderer !== currentRendererName) {\r\n            // switching graphics renderer means we must flush the previous\r\n            currentRenderer.flush();\r\n            currentRendererName = this._drawCalls[i].renderer;\r\n            currentRenderer = this._renderers.get(currentRendererName);\r\n          }\r\n\r\n          // ! hack to grab screen texture before materials run because they might want it\r\n          if (currentRenderer instanceof MaterialRenderer && this.material.isUsingScreenTexture) {\r\n            currentTarget.copyToTexture(this.materialScreenTexture);\r\n            currentTarget.use();\r\n          }\r\n          // If we are still using the same renderer we can add to the current batch\r\n          currentRenderer.draw(...this._drawCalls[i].args);\r\n        }\r\n        if (currentRenderer.hasPendingDraws()) {\r\n          currentRenderer.flush();\r\n        }\r\n      }\r\n\r\n      // reset state\r\n      this._transform.current = oldTransform;\r\n      this._state.current = oldState;\r\n\r\n      // reclaim draw calls\r\n      this._drawCallPool.done();\r\n      this._drawCallIndex = 0;\r\n      this._imageToHeight.clear();\r\n      this._imageToWidth.clear();\r\n    } else {\r\n      // This is the final flush at the moment to draw any leftover pending draw\r\n      for (const renderer of this._renderers.values()) {\r\n        if (renderer.hasPendingDraws()) {\r\n          renderer.flush();\r\n        }\r\n      }\r\n    }\r\n\r\n    currentTarget.disable();\r\n\r\n    // post process step\r\n    if (this._postprocessors.length > 0) {\r\n      const source = currentTarget.toRenderSource();\r\n      source.use();\r\n    }\r\n\r\n    // flip flop render targets for post processing\r\n    for (let i = 0; i < this._postprocessors.length; i++) {\r\n      currentTarget = this._postProcessTargets[i % 2];\r\n      this._postProcessTargets[i % 2].use();\r\n      this._screenRenderer.renderWithPostProcessor(this._postprocessors[i]);\r\n      this._postProcessTargets[i % 2].toRenderSource().use();\r\n    }\r\n\r\n    // Final blit to the screen\r\n    currentTarget.blitToScreen();\r\n  }\r\n}\r\n","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { GraphicsDiagnostics } from '../GraphicsDiagnostics';\r\nimport { DebugText } from './debug-text';\r\nimport { Resolution } from '../../Screen';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\n\r\nconst pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContext2DCanvasDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _ex: ExcaliburGraphicsContext2DCanvas) {}\r\n  /**\r\n   * Draw a debug rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.strokeStyle = 'red';\r\n    this._ex.__ctx.strokeRect(\r\n      this._ex.snapToPixel ? ~~(x + pixelSnapEpsilon) : x,\r\n      this._ex.snapToPixel ? ~~(y + pixelSnapEpsilon) : y,\r\n      this._ex.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this._ex.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawLine(start: Vector, end: Vector, lineOptions: LineGraphicsOptions = { color: Color.Black }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.strokeStyle = lineOptions.color.toString();\r\n    this._ex.__ctx.moveTo(\r\n      this._ex.snapToPixel ? ~~(start.x + pixelSnapEpsilon) : start.x,\r\n      this._ex.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this._ex.__ctx.lineTo(\r\n      this._ex.snapToPixel ? ~~(end.x + pixelSnapEpsilon) : end.x,\r\n      this._ex.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y\r\n    );\r\n    this._ex.__ctx.lineWidth = 2;\r\n    this._ex.__ctx.stroke();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.fillStyle = pointOptions.color.toString();\r\n    this._ex.__ctx.arc(\r\n      this._ex.snapToPixel ? ~~(point.x + pixelSnapEpsilon) : point.x,\r\n      this._ex.snapToPixel ? ~~(point.y + pixelSnapEpsilon) : point.y,\r\n      pointOptions.size,\r\n      0,\r\n      Math.PI * 2\r\n    );\r\n    this._ex.__ctx.fill();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._ex, text, pos);\r\n  }\r\n}\r\n\r\nexport interface ExcaliburGraphicsContext2DOptions extends ExcaliburGraphicsContextOptions {\r\n  context?: CanvasRenderingContext2D;\r\n}\r\n\r\nexport class ExcaliburGraphicsContext2DCanvas implements ExcaliburGraphicsContext {\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __ctx: CanvasRenderingContext2D;\r\n  public get width() {\r\n    return this.__ctx.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__ctx.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public readonly useDrawSorting: boolean = false;\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public z: number = 0;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  private _state = new StateStack();\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public snapToPixel: boolean = false;\r\n\r\n  public get smoothing(): boolean {\r\n    return this.__ctx.imageSmoothingEnabled;\r\n  }\r\n\r\n  public set smoothing(value: boolean) {\r\n    this.__ctx.imageSmoothingEnabled = value;\r\n  }\r\n\r\n  constructor(options: ExcaliburGraphicsContext2DOptions) {\r\n    const { canvasElement, context, enableTransparency, snapToPixel, antialiasing: smoothing, backgroundColor } = options;\r\n    this.__ctx = context ?? canvasElement.getContext('2d', {\r\n      alpha: enableTransparency ?? true\r\n    });\r\n    if (!this.__ctx) {\r\n      throw new Error('Cannot build new ExcaliburGraphicsContext2D for some reason!');\r\n    }\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = smoothing ?? this.smoothing;\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this.__ctx.resetTransform();\r\n  }\r\n\r\n  public updateViewport(_resolution: Resolution): void {\r\n    // pass\r\n  }\r\n\r\n  /**\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate using the images width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate with a specific width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context specifying the source image coordinates (sx, sy, swidth, sheight)\r\n   * and to a specific destination on the context (dx, dy, dwidth, dheight)\r\n   */\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (image.width === 0 || image.height === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    this.__ctx.globalAlpha = this.opacity;\r\n    const args = [image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight]\r\n      .filter((a) => a !== undefined)\r\n      .map((a) => (typeof a === 'number' && this.snapToPixel ? ~~a : a));\r\n    this.__ctx.drawImage.apply(this.__ctx, args);\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n    GraphicsDiagnostics.DrawnImagesCount = 1;\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    this.__ctx.strokeStyle = color.toString();\r\n    this.__ctx.moveTo(\r\n      this.snapToPixel ? ~~ (start.x + pixelSnapEpsilon) : start.x,\r\n      this.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this.__ctx.lineTo(\r\n      this.snapToPixel ? ~~ (end.x + pixelSnapEpsilon) : end.x,\r\n      this.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y\r\n    );\r\n    this.__ctx.lineWidth = thickness;\r\n    this.__ctx.stroke();\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color) {\r\n    this.__ctx.save();\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.fillRect(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y,\r\n      this.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    if (stroke) {\r\n      this.__ctx.strokeStyle = stroke.toString();\r\n    }\r\n    if (thickness) {\r\n      this.__ctx.lineWidth = thickness;\r\n    }\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.arc(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y, radius, 0, Math.PI * 2\r\n    );\r\n    this.__ctx.fill();\r\n    if (stroke) {\r\n      this.__ctx.stroke();\r\n    }\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContext2DCanvasDebug(this);\r\n\r\n  /**\r\n   * Save the current state of the canvas to the stack (transforms and opacity)\r\n   */\r\n  save(): void {\r\n    this.__ctx.save();\r\n    this._state.save();\r\n  }\r\n\r\n  /**\r\n   * Restore the state of the canvas from the stack\r\n   */\r\n  restore(): void {\r\n    this.__ctx.restore();\r\n    this._state.restore();\r\n  }\r\n\r\n  /**\r\n   * Translate the origin of the context by an x and y\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number): void {\r\n    this.__ctx.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  /**\r\n   * Rotate the context about the current origin\r\n   */\r\n  rotate(angle: number): void {\r\n    this.__ctx.rotate(angle);\r\n  }\r\n\r\n  /**\r\n   * Scale the context by an x and y factor\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number): void {\r\n    this.__ctx.scale(x, y);\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    throw new Error('Not implemented');\r\n  }\r\n\r\n  public multiply(_m: AffineMatrix): void {\r\n    this.__ctx.setTransform(this.__ctx.getTransform().multiply(_m.toDOMMatrix()));\r\n  }\r\n\r\n  public addPostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public removePostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    // pass\r\n  }\r\n\r\n  public updatePostProcessors(delta: number) {\r\n    // pass\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  public set material(material: Material | null) {\r\n    this._state.current.material = material;\r\n  }\r\n\r\n  public get material(): Material | null {\r\n    return this._state.current.material;\r\n  }\r\n\r\n  public createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material {\r\n    // pass\r\n    return null;\r\n  }\r\n\r\n  clear(): void {\r\n    // Clear frame\r\n    this.__ctx.clearRect(0, 0, this.width, this.height);\r\n    this.__ctx.fillStyle = this.backgroundColor.toString();\r\n    this.__ctx.fillRect(0, 0, this.width, this.height);\r\n    GraphicsDiagnostics.clear();\r\n  }\r\n\r\n  /**\r\n   * Flushes the batched draw calls to the screen\r\n   */\r\n  flush(): void {\r\n    // pass\r\n  }\r\n\r\n  dispose(): void {\r\n    this.__ctx = null;\r\n  }\r\n}\r\n","import { vec, Vector } from './Math/vector';\r\nimport { Logger } from './Util/Log';\r\nimport { Camera } from './Camera';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport { BoundingBox } from './Collision/Index';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { getPosition } from './Util/Util';\r\nimport { ExcaliburGraphicsContextWebGL } from './Graphics/Context/ExcaliburGraphicsContextWebGL';\r\nimport { ExcaliburGraphicsContext2DCanvas } from './Graphics/Context/ExcaliburGraphicsContext2DCanvas';\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\n/**\r\n * Enum representing the different display modes available to Excalibur.\r\n */\r\nexport enum DisplayMode {\r\n  /**\r\n   * Default, use a specified resolution for the game. Like 800x600 pixels for example.\r\n   */\r\n  Fixed = 'Fixed',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution within the container at all times will fill any gaps with canvas.\r\n   * The displayed area outside the aspect ratio is not guaranteed to be on the screen, only the [[Screen.contentArea]]\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitContainerAndFill = 'FitContainerAndFill',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution the screen at all times will fill the screen.\r\n   * This displayed area outside the aspect ratio is not guaranteed to be on the screen, only the [[Screen.contentArea]]\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitScreenAndFill = 'FitScreenAndFill',\r\n\r\n  /**\r\n   * Fit the viewport to the parent element maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in [[FitContainer]].\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use [[Screen.contentArea]] to know the safe to draw area.\r\n   */\r\n  FitContainerAndZoom = 'FitContainerAndZoom',\r\n\r\n  /**\r\n   * Fit the viewport to the device screen maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in [[FitScreen]].\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use [[Screen.contentArea]] to know the safe to draw area.\r\n   */\r\n  FitScreenAndZoom = 'FitScreenAndZoom',\r\n\r\n  /**\r\n   * Fit to screen using as much space as possible while maintaining aspect ratio and resolution.\r\n   * This is not the same as [[Screen.goFullScreen]] but behaves in a similar way maintaining aspect ratio.\r\n   *\r\n   * You may want to center your game here is an example\r\n   * ```html\r\n   * <!-- html -->\r\n   * <body>\r\n   * <main>\r\n   *   <canvas id=\"game\"></canvas>\r\n   * </main>\r\n   * </body>\r\n   * ```\r\n   *\r\n   * ```css\r\n   * // css\r\n   * main {\r\n   *   display: flex;\r\n   *   align-items: center;\r\n   *   justify-content: center;\r\n   *   height: 100%;\r\n   *   width: 100%;\r\n   * }\r\n   * ```\r\n   */\r\n  FitScreen = 'FitScreen',\r\n\r\n  /**\r\n   * Fill the entire screen's css width/height for the game resolution dynamically. This means the resolution of the game will\r\n   * change dynamically as the window is resized. This is not the same as [[Screen.goFullScreen]]\r\n   */\r\n  FillScreen = 'FillScreen',\r\n\r\n  /**\r\n   * Fit to parent element width/height using as much space as possible while maintaining aspect ratio and resolution.\r\n   */\r\n  FitContainer = 'FitContainer',\r\n\r\n  /**\r\n   * Use the parent DOM container's css width/height for the game resolution dynamically\r\n   */\r\n  FillContainer = 'FillContainer'\r\n}\r\n\r\n/**\r\n * Convenience class for quick resolutions\r\n * Mostly sourced from https://emulation.gametechwiki.com/index.php/Resolution\r\n */\r\nexport class Resolution {\r\n  /* istanbul ignore next */\r\n  public static get SVGA(): Resolution {\r\n    return { width: 800, height: 600 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Standard(): Resolution {\r\n    return { width: 1920, height: 1080 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Atari2600(): Resolution {\r\n    return { width: 160, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoy(): Resolution {\r\n    return { width: 160, height: 144 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoyAdvance(): Resolution {\r\n    return { width: 240, height: 160 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NintendoDS(): Resolution {\r\n    return { width: 256, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NES(): Resolution {\r\n    return { width: 256, height: 224 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get SNES(): Resolution {\r\n    return { width: 256, height: 244 };\r\n  }\r\n}\r\n\r\nexport type ViewportUnit = 'pixel' | 'percent';\r\n\r\nexport interface Resolution {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ViewportDimension {\r\n  widthUnit?: ViewportUnit;\r\n  heightUnit?: ViewportUnit;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ScreenOptions {\r\n  /**\r\n   * Canvas element to build a screen on\r\n   */\r\n  canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Graphics context for the screen\r\n   */\r\n  context: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Browser abstraction\r\n   */\r\n  browser: BrowserEvents;\r\n  /**\r\n   * Optionally set antialiasing, defaults to true. If set to true, images will be smoothed\r\n   */\r\n  antialiasing?: boolean;\r\n\r\n  /**\r\n   * Optionally set the image rendering CSS hint on the canvas element, default is auto\r\n   */\r\n  canvasImageRendering?: 'auto' | 'pixelated';\r\n  /**\r\n   * Optionally override the pixel ratio to use for the screen, otherwise calculated automatically from the browser\r\n   */\r\n  pixelRatio?: number;\r\n  /**\r\n   * Optionally specify the actual pixel resolution in width/height pixels (also known as logical resolution), by default the\r\n   * resolution will be the same as the viewport. Resolution will be overridden by [[DisplayMode.FillContainer]] and\r\n   * [[DisplayMode.FillScreen]].\r\n   */\r\n  resolution?: Resolution;\r\n  /**\r\n   * Visual viewport size in css pixel, if resolution is not specified it will be the same as the viewport\r\n   */\r\n  viewport: ViewportDimension;\r\n  /**\r\n   * Set the display mode of the screen, by default DisplayMode.Fixed.\r\n   */\r\n  displayMode?: DisplayMode;\r\n}\r\n\r\n/**\r\n * Fires when the screen resizes, useful if you have logic that needs to be aware of resolution/viewport constraints\r\n */\r\nexport interface ScreenResizeEvent {\r\n  /**\r\n   * Current viewport in css pixels of the screen\r\n   */\r\n  viewport: ViewportDimension;\r\n  /**\r\n   * Current resolution in world pixels of the screen\r\n   */\r\n  resolution: Resolution;\r\n}\r\n\r\n/**\r\n * Fires when the pixel ratio changes, useful to know if you've moved to a hidpi screen or back\r\n */\r\nexport interface PixelRatioChangeEvent {\r\n  /**\r\n   * Current pixel ratio of the screen\r\n   */\r\n  pixelRatio: number;\r\n}\r\n\r\n/**\r\n * Fires when the browser fullscreen api is successfully engaged or disengaged\r\n */\r\nexport interface FullScreenChangeEvent {\r\n  /**\r\n   * Current fullscreen state\r\n   */\r\n  fullscreen: boolean;\r\n}\r\n\r\n/**\r\n * Built in events supported by all entities\r\n */\r\nexport type ScreenEvents = {\r\n  /**\r\n   * Fires when the screen resizes, useful if you have logic that needs to be aware of resolution/viewport constraints\r\n   */\r\n  'resize': ScreenResizeEvent;\r\n  /**\r\n   * Fires when the pixel ratio changes, useful to know if you've moved to a hidpi screen or back\r\n   */\r\n  'pixelratio': PixelRatioChangeEvent;\r\n  /**\r\n   * Fires when the browser fullscreen api is successfully engaged or disengaged\r\n   */\r\n  'fullscreen': FullScreenChangeEvent;\r\n};\r\n\r\nexport const ScreenEvents = {\r\n  ScreenResize: 'resize',\r\n  PixelRatioChange: 'pixelratio',\r\n  FullScreenChange: 'fullscreen'\r\n} as const;\r\n\r\n/**\r\n * The Screen handles all aspects of interacting with the screen for Excalibur.\r\n */\r\nexport class Screen {\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n  /**\r\n   * Listen to screen events [[ScreenEvents]]\r\n   */\r\n  public events = new EventEmitter<ScreenEvents>();\r\n  private _canvas: HTMLCanvasElement;\r\n  private _antialiasing: boolean = true;\r\n  private _canvasImageRendering: 'auto' | 'pixelated' = 'auto';\r\n  private _contentResolution: Resolution;\r\n  private _browser: BrowserEvents;\r\n  private _camera: Camera;\r\n  private _resolution: Resolution;\r\n  private _resolutionStack: Resolution[] = [];\r\n  private _viewport: ViewportDimension;\r\n  private _viewportStack: ViewportDimension[] = [];\r\n  private _pixelRatioOverride: number | null = null;\r\n  private _displayMode: DisplayMode;\r\n  private _isFullScreen = false;\r\n  private _mediaQueryList: MediaQueryList;\r\n  private _isDisposed = false;\r\n  private _logger = Logger.getInstance();\r\n  private _resizeObserver: ResizeObserver;\r\n\r\n  constructor(options: ScreenOptions) {\r\n    this.viewport = options.viewport;\r\n    this.resolution = options.resolution ?? { ...this.viewport };\r\n    this._contentResolution = this.resolution;\r\n    this._displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    this._canvas = options.canvas;\r\n    this.graphicsContext = options.context;\r\n    this._antialiasing = options.antialiasing ?? this._antialiasing;\r\n    this._canvasImageRendering = options.canvasImageRendering ?? this._canvasImageRendering;\r\n    this._browser = options.browser;\r\n    this._pixelRatioOverride = options.pixelRatio;\r\n\r\n    this._applyDisplayMode();\r\n\r\n    this._listenForPixelRatio();\r\n\r\n    this._canvas.addEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n    this.applyResolutionAndViewport();\r\n  }\r\n\r\n  private _listenForPixelRatio() {\r\n    if (this._mediaQueryList && !this._mediaQueryList.addEventListener) {\r\n      // Safari <=13.1 workaround, remove any existing handlers\r\n      this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n    }\r\n    this._mediaQueryList = this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);\r\n\r\n    // Safari <=13.1 workaround\r\n    if (this._mediaQueryList.addEventListener) {\r\n      this._mediaQueryList.addEventListener('change', this._pixelRatioChangeHandler, { once: true });\r\n    } else {\r\n      this._mediaQueryList.addListener(this._pixelRatioChangeHandler);\r\n    }\r\n  }\r\n\r\n  public dispose(): void {\r\n    if (!this._isDisposed) {\r\n      // Clean up handlers\r\n      this._isDisposed = true;\r\n      this.events.clear();\r\n      this._browser.window.off('resize', this._resizeHandler);\r\n      this._browser.window.clear();\r\n      if (this._resizeObserver) {\r\n        this._resizeObserver.disconnect();\r\n      }\r\n      this.parent.removeEventListener('resize', this._resizeHandler);\r\n      // Safari <=13.1 workaround\r\n      if (this._mediaQueryList.removeEventListener) {\r\n        this._mediaQueryList.removeEventListener('change', this._pixelRatioChangeHandler);\r\n      } else {\r\n        this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n      }\r\n      this._canvas.removeEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n      this._canvas = null;\r\n    }\r\n  }\r\n\r\n  private _fullscreenChangeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    this._isFullScreen = !this._isFullScreen;\r\n    this._logger.debug('Fullscreen Change', this._isFullScreen);\r\n    this.events.emit('fullscreen', {\r\n      fullscreen: this.isFullScreen\r\n    } satisfies FullScreenChangeEvent);\r\n  };\r\n\r\n  private _pixelRatioChangeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    this._logger.debug('Pixel Ratio Change', window.devicePixelRatio);\r\n    this._listenForPixelRatio();\r\n    this._devicePixelRatio = this._calculateDevicePixelRatio();\r\n    this.applyResolutionAndViewport();\r\n    this.events.emit('pixelratio', {\r\n      pixelRatio: this.pixelRatio\r\n    } satisfies PixelRatioChangeEvent);\r\n  };\r\n\r\n  private _resizeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    const parent = this.parent;\r\n    this._logger.debug('View port resized');\r\n    this._setResolutionAndViewportByDisplayMode(parent);\r\n    this.applyResolutionAndViewport();\r\n    // Emit resize event\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  };\r\n\r\n  private _calculateDevicePixelRatio() {\r\n    if (window.devicePixelRatio < 1) {\r\n      return 1;\r\n    }\r\n\r\n    const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n    return devicePixelRatio;\r\n  }\r\n\r\n  // Asking the window.devicePixelRatio is expensive we do it once\r\n  private _devicePixelRatio = this._calculateDevicePixelRatio();\r\n\r\n  /**\r\n   * Returns the computed pixel ratio, first using any override, then the device pixel ratio\r\n   */\r\n  public get pixelRatio(): number {\r\n    if (this._pixelRatioOverride) {\r\n      return this._pixelRatioOverride;\r\n    }\r\n\r\n    return this._devicePixelRatio;\r\n  }\r\n\r\n  /**\r\n   * Get or set the pixel ratio override\r\n   *\r\n   * You will need to call applyResolutionAndViewport() affect change on the screen\r\n   */\r\n  public get pixelRatioOverride(): number | undefined {\r\n    return this._pixelRatioOverride;\r\n  }\r\n\r\n  public set pixelRatioOverride(value: number | undefined) {\r\n    this._pixelRatioOverride = value;\r\n  }\r\n\r\n  public get isHiDpi() {\r\n    return this.pixelRatio !== 1;\r\n  }\r\n\r\n  public get displayMode(): DisplayMode {\r\n    return this._displayMode;\r\n  }\r\n\r\n  public get canvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n\r\n  public get parent(): HTMLElement | Window {\r\n    switch (this.displayMode) {\r\n      case DisplayMode.FillContainer:\r\n      case DisplayMode.FitContainer:\r\n      case DisplayMode.FitContainerAndFill:\r\n      case DisplayMode.FitContainerAndZoom:\r\n        return this.canvas.parentElement || document.body;\r\n      default:\r\n        return window;\r\n    }\r\n  }\r\n\r\n  public get resolution(): Resolution {\r\n    return this._resolution;\r\n  }\r\n\r\n  public set resolution(resolution: Resolution) {\r\n    this._resolution = resolution;\r\n  }\r\n\r\n  /**\r\n   * Returns screen dimensions in pixels or percentage\r\n   */\r\n  public get viewport(): ViewportDimension {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n    return this._resolution;\r\n  }\r\n\r\n  public set viewport(viewport: ViewportDimension) {\r\n    this._viewport = viewport;\r\n  }\r\n\r\n  public get aspectRatio() {\r\n    return this._resolution.width / this._resolution.height;\r\n  }\r\n\r\n  public get scaledWidth() {\r\n    return this._resolution.width * this.pixelRatio;\r\n  }\r\n\r\n  public get scaledHeight() {\r\n    return this._resolution.height * this.pixelRatio;\r\n  }\r\n\r\n  public setCurrentCamera(camera: Camera) {\r\n    this._camera = camera;\r\n  }\r\n\r\n  public pushResolutionAndViewport() {\r\n    this._resolutionStack.push(this.resolution);\r\n    this._viewportStack.push(this.viewport);\r\n\r\n    this.resolution = { ...this.resolution };\r\n    this.viewport = { ...this.viewport };\r\n  }\r\n\r\n  public peekViewport(): ViewportDimension {\r\n    return this._viewportStack[this._viewportStack.length - 1];\r\n  }\r\n\r\n  public peekResolution(): Resolution {\r\n    return this._resolutionStack[this._resolutionStack.length - 1];\r\n  }\r\n\r\n  public popResolutionAndViewport() {\r\n    if (this._resolutionStack.length && this._viewportStack.length) {\r\n      this.resolution = this._resolutionStack.pop();\r\n      this.viewport = this._viewportStack.pop();\r\n    }\r\n  }\r\n\r\n\r\n\r\n  public applyResolutionAndViewport() {\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      const scaledResolutionSupported = this.graphicsContext.checkIfResolutionSupported({\r\n        width: this.scaledWidth,\r\n        height: this.scaledHeight\r\n      });\r\n      if (!scaledResolutionSupported) {\r\n        this._logger.warnOnce(\r\n          `The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio})` +\r\n          ' are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly.' +\r\n          ' Try reducing the resolution or disabling Hi DPI scaling to avoid this' +\r\n          ' (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).');\r\n\r\n        // Attempt to recover if the user hasn't configured a specific ratio for up scaling\r\n        if (!this.pixelRatioOverride) {\r\n          let currentPixelRatio = Math.max(1, this.pixelRatio - .5);\r\n          let newResolutionSupported = false;\r\n          while (currentPixelRatio > 1 && !newResolutionSupported) {\r\n            currentPixelRatio = Math.max(1, currentPixelRatio - .5);\r\n            const width = this._resolution.width * currentPixelRatio;\r\n            const height = this._resolution.height * currentPixelRatio;\r\n            newResolutionSupported = this.graphicsContext.checkIfResolutionSupported({ width, height });\r\n          }\r\n          this.pixelRatioOverride = currentPixelRatio;\r\n          this._logger.warnOnce(\r\n            'Scaled resolution too big attempted recovery!' +\r\n            ` Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit.` +\r\n            ' Setting `ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.` ' +\r\n            ' (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).');\r\n        }\r\n      }\r\n    }\r\n\r\n    this._canvas.width = this.scaledWidth;\r\n    this._canvas.height = this.scaledHeight;\r\n\r\n    if (this._canvasImageRendering === 'auto') {\r\n      this._canvas.style.imageRendering = 'auto';\r\n    } else {\r\n      this._canvas.style.imageRendering = 'pixelated';\r\n      // Fall back to 'crisp-edges' if 'pixelated' is not supported\r\n      // Currently for firefox https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering\r\n      if (this._canvas.style.imageRendering === '') {\r\n        this._canvas.style.imageRendering = 'crisp-edges';\r\n      }\r\n    }\r\n\r\n    const widthUnit = this.viewport.widthUnit === 'percent' ? '%' : 'px';\r\n    const heightUnit = this.viewport.heightUnit === 'percent' ? '%' : 'px';\r\n\r\n    this._canvas.style.width = this.viewport.width + widthUnit;\r\n    this._canvas.style.height = this.viewport.height + heightUnit;\r\n\r\n    // After messing with the canvas width/height the graphics context is invalidated and needs to have some properties reset\r\n    this.graphicsContext.updateViewport(this.resolution);\r\n    this.graphicsContext.resetTransform();\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContext2DCanvas) {\r\n      this.graphicsContext.scale(this.pixelRatio, this.pixelRatio);\r\n    }\r\n  }\r\n\r\n  public get antialiasing() {\r\n    return this._antialiasing;\r\n  }\r\n\r\n  public set antialiasing(isSmooth: boolean) {\r\n    this._antialiasing = isSmooth;\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Returns true if excalibur is fullscreen using the browser fullscreen api\r\n   */\r\n  public get isFullScreen() {\r\n    return this._isFullScreen;\r\n  }\r\n\r\n  /**\r\n   * Requests to go fullscreen using the browser fullscreen api, requires user interaction to be successful.\r\n   * For example, wire this to a user click handler.\r\n   *\r\n   * Optionally specify a target element id to go fullscreen, by default the game canvas is used\r\n   * @param elementId\r\n   */\r\n  public goFullScreen(elementId?: string): Promise<void> {\r\n    if (elementId) {\r\n      const maybeElement = document.getElementById(elementId);\r\n      if (maybeElement) {\r\n        if (!maybeElement.getAttribute('ex-fullscreen-listener')) {\r\n          maybeElement.setAttribute('ex-fullscreen-listener', 'true');\r\n          maybeElement.addEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n        }\r\n        const fullscreenPromise = maybeElement.requestFullscreen();\r\n        return fullscreenPromise;\r\n      }\r\n    }\r\n    return this._canvas.requestFullscreen();\r\n  }\r\n\r\n  /**\r\n   * Requests to exit fullscreen using the browser fullscreen api\r\n   */\r\n  public exitFullScreen(): Promise<void> {\r\n    return document.exitFullscreen();\r\n  }\r\n\r\n  private _viewportToPixels(viewport: ViewportDimension) {\r\n    return {\r\n      width: viewport.widthUnit === 'percent' ? this.canvas.offsetWidth : viewport.width,\r\n      height: viewport.heightUnit === 'percent' ? this.canvas.offsetHeight : viewport.height\r\n    } satisfies ViewportDimension;\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in normal html page space, for example from a pointer move event, and translates it to\r\n   * Excalibur screen space.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY). When using *AndFill suffixed display modes screen space\r\n   * (0, 0) is the top left of the safe content area bounding box not the viewport.\r\n   * @param point\r\n   */\r\n  public pageToScreenCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    if (!this._isFullScreen) {\r\n      newX -= getPosition(this._canvas).x;\r\n      newY -= getPosition(this._canvas).y;\r\n    }\r\n\r\n    const viewport = this._viewportToPixels(this.viewport);\r\n\r\n    // if fullscreen api on it centers with black bars\r\n    // we need to adjust the screen to world coordinates in this case\r\n    if (this._isFullScreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = ((newY - screenMarginY) / screenHeight) * viewport.height;\r\n        newX = (newX / window.innerWidth) * viewport.width;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = ((newX - screenMarginX) / screenWidth) * viewport.width;\r\n        newY = (newY / window.innerHeight) * viewport.height;\r\n      }\r\n    }\r\n\r\n    newX = (newX / viewport.width) * this.resolution.width;\r\n    newY = (newY / viewport.height) * this.resolution.height;\r\n\r\n    // offset by content area\r\n    newX = newX - this.contentArea.left;\r\n    newY = newY - this.contentArea.top;\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to normal html page space. For example,\r\n   * this is where html elements might live if you want to position them relative to Excalibur.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY)\r\n   * @param point\r\n   */\r\n  public screenToPageCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    // no need to offset by content area, drawing is already offset by this\r\n\r\n    const viewport = this._viewportToPixels(this.viewport);\r\n\r\n    newX = (newX / this.resolution.width) * viewport.width;\r\n    newY = (newY / this.resolution.height) * viewport.height;\r\n\r\n    if (this._isFullScreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = (newY / viewport.height) * screenHeight + screenMarginY;\r\n        newX = (newX / viewport.width) * window.innerWidth;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = (newX / viewport.width) * screenWidth + screenMarginX;\r\n        newY = (newY / viewport.height) * window.innerHeight;\r\n      }\r\n    }\r\n\r\n    if (!this._isFullScreen) {\r\n      newX += getPosition(this._canvas).x;\r\n      newY += getPosition(this._canvas).y;\r\n    }\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to Excalibur world space.\r\n   *\r\n   * World space is where [[Entity|entities]] in Excalibur live by default [[CoordPlane.World]]\r\n   * and extends infinitely out relative from the [[Camera]].\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    // offset by content area\r\n    point = point.add(vec(this.contentArea.left, this.contentArea.top));\r\n\r\n    // the only difference between screen & world is the camera transform\r\n    if (this._camera) {\r\n      return this._camera.inverse.multiply(point);\r\n    }\r\n    return point.sub(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur world space, and translates it to Excalibur screen space.\r\n   *\r\n   * Screen space is where [[ScreenElement|screen elements]] and [[Entity|entities]] with [[CoordPlane.Screen]] live.\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    if (this._camera) {\r\n      return this._camera.transform.multiply(point);\r\n    }\r\n    return point.add(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  public pageToWorldCoordinates(point: Vector): Vector {\r\n    const screen = this.pageToScreenCoordinates(point);\r\n    return this.screenToWorldCoordinates(screen);\r\n  }\r\n\r\n  public worldToPageCoordinates(point: Vector): Vector {\r\n    const screen = this.worldToScreenCoordinates(point);\r\n    return this.screenToPageCoordinates(screen);\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   *\r\n   * World bounds are in world coordinates, useful for culling objects offscreen that are in world space\r\n   */\r\n  public getWorldBounds(): BoundingBox {\r\n    const bounds = BoundingBox.fromDimension(\r\n      this.resolution.width,\r\n      this.resolution.height,\r\n      Vector.Half)\r\n      .scale(vec(1/this._camera.zoom, 1/this._camera.zoom))\r\n      .rotate(this._camera.rotation)\r\n      .translate(this._camera.drawPos);\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen and the bottom right corner of the screen.\r\n   *\r\n   * Screen bounds are in screen coordinates, useful for culling objects offscreen that are in screen space\r\n   */\r\n  public getScreenBounds(): BoundingBox {\r\n    const bounds = BoundingBox.fromDimension(\r\n      this.resolution.width,\r\n      this.resolution.height,\r\n      Vector.Zero, Vector.Zero);\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.canvas.width / 2;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.canvas.height / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    if (this._camera) {\r\n      return this.resolution.width / this._camera.zoom;\r\n    }\r\n    return this.resolution.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.drawWidth / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    if (this._camera) {\r\n      return this.resolution.height / this._camera.zoom;\r\n    }\r\n    return this.resolution.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.drawHeight / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns screen center coordinates including zoom and device pixel ratio.\r\n   */\r\n  public get center(): Vector {\r\n    return vec(this.halfDrawWidth, this.halfDrawHeight);\r\n  }\r\n\r\n  /**\r\n   * Returns the content area in screen space where it is safe to place content\r\n   */\r\n  public get contentArea(): BoundingBox {\r\n    return this._contentArea;\r\n  }\r\n\r\n  /**\r\n   * Returns the unsafe area in screen space, this is the full screen and some space may not be onscreen.\r\n   */\r\n  public get unsafeArea(): BoundingBox {\r\n    return this._unsafeArea;\r\n  }\r\n\r\n  private _contentArea: BoundingBox = new BoundingBox();\r\n  private _unsafeArea: BoundingBox = new BoundingBox();\r\n\r\n  private _computeFit() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (window.innerWidth / aspect < window.innerHeight) {\r\n      adjustedWidth = window.innerWidth;\r\n      adjustedHeight = window.innerWidth / aspect;\r\n    } else {\r\n      adjustedWidth = window.innerHeight * aspect;\r\n      adjustedHeight = window.innerHeight;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      height: adjustedHeight\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this._unsafeArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitScreenAndFill() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n    this._computeFitAndFill(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n\r\n\r\n  private _computeFitContainerAndFill() {\r\n    this.canvas.style.width = '100%';\r\n    this.canvas.style.height = '100%';\r\n\r\n    this._computeFitAndFill(\r\n      this.canvas.offsetWidth,\r\n      this.canvas.offsetHeight, {\r\n        width: 100,\r\n        widthUnit: 'percent',\r\n        height: 100,\r\n        heightUnit: 'percent'\r\n      });\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitAndFill(vw: number, vh: number, viewport?: ViewportDimension) {\r\n    this.viewport = viewport ?? {\r\n      width: vw,\r\n      height: vh\r\n    };\r\n    // if the current screen aspectRatio is less than the original aspectRatio\r\n    if (vw / vh <= this._contentResolution.width / this._contentResolution.height) {\r\n      // compute new resolution to match the original aspect ratio\r\n      this.resolution = {\r\n        width:  vw * this._contentResolution.width / vw,\r\n        height: vw * this._contentResolution.width / vw * vh / vw\r\n      };\r\n      const clip = (this.resolution.height - this._contentResolution.height) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: clip,\r\n        left: 0,\r\n        right: this._contentResolution.width,\r\n        bottom: this.resolution.height - clip\r\n      });\r\n      this._unsafeArea = new BoundingBox({\r\n        top: -clip,\r\n        left: 0,\r\n        right: this._contentResolution.width,\r\n        bottom: this.resolution.height + clip\r\n      });\r\n    } else {\r\n      this.resolution = {\r\n        width: vh *  this._contentResolution.height / vh * vw / vh,\r\n        height: vh *  this._contentResolution.height / vh\r\n      };\r\n      const clip = (this.resolution.width - this._contentResolution.width) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: 0,\r\n        left: clip,\r\n        right: this.resolution.width - clip,\r\n        bottom: this._contentResolution.height\r\n      });\r\n      this._unsafeArea = new BoundingBox({\r\n        top: 0,\r\n        left: -clip,\r\n        right: this.resolution.width + clip,\r\n        bottom: this._contentResolution.height\r\n      });\r\n    }\r\n  }\r\n\r\n  private _computeFitScreenAndZoom() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    this.canvas.style.position = 'absolute';\r\n\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitContainerAndZoom() {\r\n    this.canvas.style.width = '100%';\r\n    this.canvas.style.height = '100%';\r\n    this.canvas.style.position = 'relative';\r\n    const parent = this.canvas.parentElement;\r\n    parent.style.overflow = 'hidden';\r\n    const { offsetWidth: vw, offsetHeight: vh } = this.canvas;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitAndZoom(vw: number, vh: number) {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (vw / aspect < vh) {\r\n      adjustedWidth = vw;\r\n      adjustedHeight = vw / aspect;\r\n    } else {\r\n      adjustedWidth = vh * aspect;\r\n      adjustedHeight = vh;\r\n    }\r\n\r\n    const scaleX = vw / adjustedWidth;\r\n    const scaleY = vh / adjustedHeight;\r\n\r\n    const maxScaleFactor = Math.max(scaleX, scaleY);\r\n\r\n    const zoomedWidth = adjustedWidth * maxScaleFactor;\r\n    const zoomedHeight = adjustedHeight * maxScaleFactor;\r\n\r\n    // Center zoomed dimension if bigger than the screen\r\n    if (zoomedWidth > vw) {\r\n      this.canvas.style.left = -(zoomedWidth - vw) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.left = '';\r\n    }\r\n\r\n    if (zoomedHeight > vh) {\r\n      this.canvas.style.top = -(zoomedHeight - vh) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.top = '';\r\n    }\r\n\r\n    this.viewport = {\r\n      width: zoomedWidth,\r\n      height: zoomedHeight\r\n    };\r\n\r\n    const bounds = BoundingBox.fromDimension(this.viewport.width, this.viewport.height, Vector.Zero);\r\n    // return safe area\r\n    if (this.viewport.width > vw) {\r\n      const clip = (this.viewport.width - vw)/this.viewport.width * this.resolution.width;\r\n      bounds.top = 0;\r\n      bounds.left = clip / 2;\r\n      bounds.right = this.resolution.width - clip / 2;\r\n      bounds.bottom = this.resolution.height;\r\n    }\r\n\r\n    if (this.viewport.height > vh) {\r\n      const clip = (this.viewport.height - vh)/this.viewport.height * this.resolution.height;\r\n      bounds.top = clip / 2;\r\n      bounds.left = 0;\r\n      bounds.bottom = this.resolution.height - clip / 2;\r\n      bounds.right = this.resolution.width;\r\n    }\r\n    this._contentArea = bounds;\r\n  }\r\n\r\n  private _computeFitContainer() {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    let widthUnit: ViewportUnit = 'pixel';\r\n    let heightUnit: ViewportUnit = 'pixel';\r\n    const parent = this.canvas.parentElement;\r\n    if (parent.clientWidth / aspect < parent.clientHeight) {\r\n      this.canvas.style.width = '100%';\r\n      adjustedWidth = 100;\r\n      widthUnit = 'percent';\r\n      adjustedHeight = this.canvas.offsetWidth / aspect;\r\n    } else {\r\n      this.canvas.style.height = '100%';\r\n      adjustedHeight = 100;\r\n      heightUnit = 'percent';\r\n      adjustedWidth = this.canvas.offsetHeight * aspect;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      widthUnit,\r\n      height: adjustedHeight,\r\n      heightUnit\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _applyDisplayMode() {\r\n    this._setResolutionAndViewportByDisplayMode(this.parent);\r\n\r\n    // watch resizing\r\n    if (this.parent instanceof Window) {\r\n      this._browser.window.on('resize', this._resizeHandler);\r\n    } else {\r\n      this._resizeObserver = new ResizeObserver(() => {\r\n        this._resizeHandler();\r\n      });\r\n      this._resizeObserver.observe(this.parent);\r\n    }\r\n    this.parent.addEventListener('resize', this._resizeHandler);\r\n  }\r\n\r\n  /**\r\n   * Sets the resolution and viewport based on the selected display mode.\r\n   */\r\n  private _setResolutionAndViewportByDisplayMode(parent: HTMLElement | Window) {\r\n    if (this.displayMode === DisplayMode.FillContainer) {\r\n      this.canvas.style.width = '100%';\r\n      this.canvas.style.height = '100%';\r\n      this.viewport = {\r\n        width: 100,\r\n        widthUnit: 'percent',\r\n        height: 100,\r\n        heightUnit: 'percent'\r\n      };\r\n      this.resolution = {\r\n        width: this.canvas.offsetWidth,\r\n        height: this.canvas.offsetHeight\r\n      };\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FillScreen) {\r\n      document.body.style.margin = '0px';\r\n      document.body.style.overflow = 'hidden';\r\n      this.resolution = {\r\n        width: (<Window> parent).innerWidth,\r\n        height: (<Window> parent).innerHeight\r\n      };\r\n\r\n      this.viewport = this.resolution;\r\n    }\r\n\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n\r\n    if (this.displayMode === DisplayMode.FitScreen) {\r\n      this._computeFit();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainer) {\r\n      this._computeFitContainer();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndFill) {\r\n      this._computeFitScreenAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndFill){\r\n      this._computeFitContainerAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndZoom) {\r\n      this._computeFitScreenAndZoom();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndZoom){\r\n      this._computeFitContainerAndZoom();\r\n    }\r\n  }\r\n}\r\n","/**\n * Internal class used to build instances of AudioContext\n */\n/* istanbul ignore next */\nexport class AudioContextFactory {\n  private static _INSTANCE: AudioContext = null;\n\n  public static create(): AudioContext {\n    if (!this._INSTANCE) {\n      if ((<any>window).AudioContext || (<any>window).webkitAudioContext) {\n        this._INSTANCE = new AudioContext();\n      }\n    }\n\n    return this._INSTANCE;\n  }\n}\n","import { AudioContextFactory } from '../Resources/Sound/AudioContext';\nimport { Logger } from './Log';\n\nexport interface LegacyWebAudioSource {\n  playbackState: string;\n  PLAYING_STATE: 'playing';\n  FINISHED_STATE: 'finished';\n}\n\n/**\n * Patch for detecting legacy web audio in browsers\n * @internal\n * @param source\n */\nfunction isLegacyWebAudioSource(source: any): source is LegacyWebAudioSource {\n  return !!source.playbackState;\n}\n\nexport class WebAudio {\n  private static _UNLOCKED: boolean = false;\n\n  /**\n   * Play an empty sound to unlock Safari WebAudio context. Call this function\n   * right after a user interaction event.\n   * @source https://paulbakaus.com/tutorials/html5/web-audio-on-ios/\n   */\n  static unlock(): Promise<boolean> {\n    const promise = new Promise<boolean>((resolve, reject) => {\n      if (WebAudio._UNLOCKED || !AudioContextFactory.create()) {\n        return resolve(true);\n      }\n      const unlockTimeoutTimer = setTimeout(() => {\n        Logger.getInstance().warn('Excalibur was unable to unlock the audio context, audio probably will not play in this browser.');\n        resolve(false);\n      }, 200);\n\n      const audioContext = AudioContextFactory.create();\n      audioContext.resume().then(\n        () => {\n          // create empty buffer and play it\n          const buffer = audioContext.createBuffer(1, 1, 22050);\n          const source = audioContext.createBufferSource();\n          let ended = false;\n\n          source.buffer = buffer;\n          source.connect(audioContext.destination);\n          source.onended = () => (ended = true);\n\n          source.start(0);\n\n          // by checking the play state after some time, we know if we're really unlocked\n          setTimeout(() => {\n            if (isLegacyWebAudioSource(source)) {\n              if (source.playbackState === source.PLAYING_STATE || source.playbackState === source.FINISHED_STATE) {\n                WebAudio._UNLOCKED = true;\n              }\n            } else {\n              if (audioContext.currentTime > 0 || ended) {\n                WebAudio._UNLOCKED = true;\n              }\n            }\n          }, 0);\n\n          clearTimeout(unlockTimeoutTimer);\n          resolve(true);\n        },\n        () => {\n          reject();\n        }\n      );\n    });\n\n    return promise;\n  }\n\n  static isUnlocked() {\n    return this._UNLOCKED;\n  }\n}\n","import { Graphic, GraphicOptions } from './Graphic';\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\nimport { Color } from '../Color';\nimport { Vector } from '../Math/vector';\nimport { BoundingBox } from '../Collision/BoundingBox';\nimport { watch } from '../Util/Watch';\nimport { ImageFiltering } from './Filtering';\nimport { omit } from '../Util/Util';\n\nexport interface RasterOptions {\n  /**\n   * Optionally specify a quality number, which is how much to scale the internal Raster. Default is 1.\n   *\n   * For example if the quality is set to 2, it doubles the internal raster bitmap in memory.\n   *\n   * Adjusting this value can be useful if you are working with small rasters.\n   */\n  quality?: number;\n  /**\n   * Optionally specify \"smoothing\" if you want antialiasing to apply to the raster's bitmap context, by default `false`\n   */\n  smoothing?: boolean;\n\n  /**\n   * Optionally specify the color of the raster's bitmap context, by default [[Color.Black]]\n   */\n  color?: Color;\n\n  /**\n   * Optionally specify the stroke color of the raster's bitmap context, by default undefined\n   */\n  strokeColor?: Color;\n\n  /**\n   * Optionally specify the line width of the raster's bitmap, by default 1 pixel\n   */\n  lineWidth?: number;\n\n  /**\n   * Optionally specify the line dash of the raster's bitmap, by default `[]` which means none\n   */\n  lineDash?: number[];\n\n  /**\n   * Optionally specify the line end style, default is \"butt\".\n   */\n  lineCap?: 'butt' | 'round' | 'square';\n\n  /**\n   * Optionally specify the padding to apply to the bitmap\n   */\n  padding?: number;\n\n  /**\n   * Optionally specify what image filtering mode should be used, [[ImageFiltering.Pixel]] for pixel art,\n   * [[ImageFiltering.Blended]] for hi-res art\n   *\n   * By default unset, rasters defer to the engine antialiasing setting\n   */\n  filtering?: ImageFiltering;\n}\n\n/**\n * A Raster is a Graphic that needs to be first painted to a HTMLCanvasElement before it can be drawn to the\n * [[ExcaliburGraphicsContext]]. This is useful for generating custom images using the 2D canvas api.\n *\n * Implementors must implement the [[Raster.execute]] method to rasterize their drawing.\n */\nexport abstract class Raster extends Graphic {\n  public filtering: ImageFiltering = null;\n  public lineCap: 'butt' | 'round' | 'square' = 'butt';\n  public quality: number = 1;\n\n  public _bitmap: HTMLCanvasElement;\n  protected _ctx: CanvasRenderingContext2D;\n  private _dirty: boolean = true;\n\n  constructor(options?: GraphicOptions & RasterOptions) {\n    super(omit(options, ['width', 'height'])); // rasters do some special sauce with width/height\n    if (options) {\n      this.quality = options.quality ?? this.quality;\n      this.color = options.color ?? Color.Black;\n      this.strokeColor = options?.strokeColor;\n      this.smoothing = options.smoothing ?? this.smoothing;\n      this.lineWidth = options.lineWidth ?? this.lineWidth;\n      this.lineDash = options.lineDash ?? this.lineDash;\n      this.lineCap = options.lineCap ?? this.lineCap;\n      this.padding = options.padding ?? this.padding;\n      this.filtering = options.filtering ?? this.filtering;\n    }\n    this._bitmap = document.createElement('canvas');\n    // get the default canvas width/height as a fallback\n    const bitmapWidth = options?.width ?? this._bitmap.width;\n    const bitmapHeight = options?.height ?? this._bitmap.height;\n    this.width = bitmapWidth;\n    this.height = bitmapHeight;\n    const maybeCtx = this._bitmap.getContext('2d');\n    if (!maybeCtx) {\n      /* istanbul ignore next */\n      throw new Error('Browser does not support 2d canvas drawing, cannot create Raster graphic');\n    } else {\n      this._ctx = maybeCtx;\n    }\n  }\n\n  public cloneRasterOptions(): RasterOptions {\n    return {\n      color: this.color ? this.color.clone() : null,\n      strokeColor: this.strokeColor ? this.strokeColor.clone() : null,\n      smoothing: this.smoothing,\n      lineWidth: this.lineWidth,\n      lineDash: this.lineDash,\n      lineCap: this.lineCap,\n      quality: this.quality,\n      padding: this.padding\n    };\n  }\n\n  /**\n   * Gets whether the graphic is dirty, this means there are changes that haven't been re-rasterized\n   */\n  public get dirty() {\n    return this._dirty;\n  }\n\n  /**\n   * Flags the graphic as dirty, meaning it must be re-rasterized before draw.\n   * This should be called any time the graphics state changes such that it affects the outputted drawing\n   */\n  public flagDirty() {\n    this._dirty = true;\n  }\n\n  private _originalWidth: number;\n  /**\n   * Gets or sets the current width of the Raster graphic. Setting the width will cause the raster\n   * to be flagged dirty causing a re-raster on the next draw.\n   *\n   * Any `padding`s or `quality` set will be factored into the width\n   */\n  public get width() {\n    return Math.abs(this._getTotalWidth() * this.scale.x);\n  }\n  public set width(value: number) {\n    value /= Math.abs(this.scale.x);\n    this._bitmap.width = value;\n    this._originalWidth = value;\n    this.flagDirty();\n  }\n\n  private _originalHeight: number;\n  /**\n   * Gets or sets the current height of the Raster graphic. Setting the height will cause the raster\n   * to be flagged dirty causing a re-raster on the next draw.\n   *\n   * Any `padding` or `quality` set will be factored into the height\n   */\n  public get height() {\n    return Math.abs(this._getTotalHeight() * this.scale.y);\n  }\n\n  public set height(value: number) {\n    value /= Math.abs(this.scale.y);\n    this._bitmap.height = value;\n    this._originalHeight = value;\n    this.flagDirty();\n  }\n\n  private _getTotalWidth() {\n    return ((this._originalWidth ?? this._bitmap.width) + this.padding * 2) * 1;\n  }\n\n  private _getTotalHeight() {\n    return ((this._originalHeight ?? this._bitmap.height) + this.padding * 2) * 1;\n  }\n\n  /**\n   * Returns the local bounds of the Raster including the padding\n   */\n  public get localBounds() {\n    return BoundingBox.fromDimension(this._getTotalWidth() * this.scale.x, this._getTotalHeight() * this.scale.y, Vector.Zero);\n  }\n\n  private _smoothing: boolean = false;\n  /**\n   * Gets or sets the smoothing (anti-aliasing of the graphic). Setting the height will cause the raster\n   * to be flagged dirty causing a re-raster on the next draw.\n   */\n  public get smoothing() {\n    return this._smoothing;\n  }\n  public set smoothing(value: boolean) {\n    this._smoothing = value;\n    this.flagDirty();\n  }\n\n  private _color: Color = watch(Color.Black, () => this.flagDirty());\n  /**\n   * Gets or sets the fillStyle of the Raster graphic. Setting the fillStyle will cause the raster to be\n   * flagged dirty causing a re-raster on the next draw.\n   */\n  public get color() {\n    return this._color;\n  }\n  public set color(value) {\n    this.flagDirty();\n    this._color = watch(value, () => this.flagDirty());\n  }\n\n  private _strokeColor: Color;\n  /**\n   * Gets or sets the strokeStyle of the Raster graphic. Setting the strokeStyle will cause the raster to be\n   * flagged dirty causing a re-raster on the next draw.\n   */\n  public get strokeColor() {\n    return this._strokeColor;\n  }\n  public set strokeColor(value) {\n    this.flagDirty();\n    this._strokeColor = watch(value, () => this.flagDirty());\n  }\n\n  private _lineWidth: number = 1;\n  /**\n   * Gets or sets the line width of the Raster graphic. Setting the lineWidth will cause the raster to be\n   * flagged dirty causing a re-raster on the next draw.\n   */\n  public get lineWidth() {\n    return this._lineWidth;\n  }\n  public set lineWidth(value) {\n    this._lineWidth = value;\n    this.flagDirty();\n  }\n\n  private _lineDash: number[] = [];\n  public get lineDash() {\n    return this._lineDash;\n  }\n\n  public set lineDash(value) {\n    this._lineDash = value;\n    this.flagDirty();\n  }\n\n  private _padding: number = 0;\n  public get padding() {\n    return this._padding;\n  }\n\n  public set padding(value: number) {\n    this._padding = value;\n    this.flagDirty();\n  }\n\n  /**\n   * Rasterize the graphic to a bitmap making it usable as in excalibur. Rasterize is called automatically if\n   * the graphic is [[Raster.dirty]] on the next [[Graphic.draw]] call\n   */\n  public rasterize(): void {\n    this._dirty = false;\n    this._ctx.clearRect(0, 0, this._getTotalWidth(), this._getTotalHeight());\n    this._ctx.save();\n    this._applyRasterProperties(this._ctx);\n    this.execute(this._ctx);\n    this._ctx.restore();\n  }\n\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D) {\n    this._bitmap.width = this._getTotalWidth() * this.quality;\n    this._bitmap.height = this._getTotalHeight() * this.quality;\n    // Do a bad thing to pass the filtering as an attribute\n    this._bitmap.setAttribute('filtering', this.filtering);\n    this._bitmap.setAttribute('forceUpload', 'true');\n    ctx.scale(this.quality, this.quality);\n    ctx.translate(this.padding, this.padding);\n    ctx.imageSmoothingEnabled = this.smoothing;\n    ctx.lineWidth = this.lineWidth;\n    ctx.setLineDash(this.lineDash ?? ctx.getLineDash());\n    ctx.lineCap = this.lineCap;\n    ctx.strokeStyle = this.strokeColor?.toString();\n    ctx.fillStyle = this.color?.toString();\n  }\n\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\n    if (this._dirty) {\n      this.rasterize();\n    }\n    ex.scale(1 / this.quality, 1 / this.quality);\n    ex.drawImage(this._bitmap, x, y);\n  }\n\n  /**\n   * Executes drawing implementation of the graphic, this is where the specific drawing code for the graphic\n   * should be implemented. Once `rasterize()` the graphic can be drawn to the [[ExcaliburGraphicsContext]] via `draw(...)`\n   * @param ctx Canvas to draw the graphic to\n   */\n  abstract execute(ctx: CanvasRenderingContext2D): void;\n}\n","import { GraphicOptions } from './Graphic';\nimport { Raster, RasterOptions } from './Raster';\n\nexport interface CanvasOptions {\n  draw?: (ctx: CanvasRenderingContext2D) => void;\n  cache?: boolean;\n}\n\n/**\n * A canvas [[Graphic]] to provide an adapter between the 2D Canvas API and the [[ExcaliburGraphicsContext]].\n *\n * The [[Canvas]] works by re-rastering a draw handler to a HTMLCanvasElement for every draw which is then passed\n * to the [[ExcaliburGraphicsContext]] implementation as a rendered image.\n *\n * **Low performance API**\n */\nexport class Canvas extends Raster {\n  /**\n   * Return the 2D graphics context of this canvas\n   */\n  public get ctx() {\n    return this._ctx;\n  }\n\n  constructor(private _options: GraphicOptions & RasterOptions & CanvasOptions) {\n    super(_options);\n  }\n\n  public clone(): Canvas {\n    return new Canvas({\n      ...this._options,\n      ...this.cloneGraphicOptions(),\n      ...this.cloneRasterOptions()\n    });\n  }\n\n  execute(ctx: CanvasRenderingContext2D): void {\n    if (this._options?.draw) {\n      this._options?.draw(ctx);\n    }\n    if (!this._options.cache) {\n      this.flagDirty();\n    }\n  }\n}\n","import { Audio } from './Audio';\n\nexport type ExResponseType = '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text';\n\nexport interface ExResponseTypesLookup {\n  [name: string]: ExResponseType;\n}\n\nexport class ExResponse {\n  public static type: ExResponseTypesLookup = {\n    any: '',\n    blob: 'blob',\n    json: 'json',\n    text: 'text',\n    document: 'document',\n    arraybuffer: 'arraybuffer'\n  };\n}\n\n/**\n * Represents an audio implementation like [[WebAudioInstance]]\n */\nexport interface AudioImplementation {\n  /**\n   * XHR response type\n   */\n  responseType: ExResponseType;\n\n  /**\n   * Processes raw data and transforms into sound data\n   */\n  processData(data: Blob | ArrayBuffer): Promise<string | AudioBuffer>;\n\n  /**\n   * Factory method that returns an instance of a played audio track\n   */\n  createInstance(data: string | AudioBuffer): Audio;\n}\n","\r\nexport interface State {\r\n  name?: string;\r\n  transitions: string[];\r\n  onEnter?: (context: {from: string, eventData?: any, data: any}) => boolean | void;\r\n  onState?: () => any;\r\n  onExit?: (context: {to: string, data: any}) => boolean | void;\r\n  onUpdate?: (data: any, elapsedMs: number) => any;\r\n}\r\n\r\nexport interface StateMachineDescription {\r\n  start: string,\r\n  states: { [name: string]: State }\r\n}\r\n\r\nexport type PossibleStates<TMachine> = TMachine extends StateMachineDescription ? Extract<keyof TMachine['states'], string> : never;\r\n\r\nexport interface StateMachineState {\r\n  data: any;\r\n  currentState: string;\r\n}\r\n\r\nexport class StateMachine<TPossibleStates extends string, TData> {\r\n  public startState: State;\r\n  private _currentState: State;\r\n  public get currentState(): State {\r\n    return this._currentState;\r\n  }\r\n  public set currentState(state: State) {\r\n    this._currentState = state;\r\n  }\r\n  public states = new Map<string, State>();\r\n  public data: TData;\r\n\r\n  static create<TMachine extends StateMachineDescription, TData>(\r\n    machineDescription: TMachine, data?: TData): StateMachine<PossibleStates<TMachine>, TData> {\r\n    const machine = new StateMachine<PossibleStates<TMachine>, TData>();\r\n    machine.data = data;\r\n    for (const stateName in machineDescription.states) {\r\n      machine.states.set(stateName as PossibleStates<TMachine>, {\r\n        name: stateName,\r\n        ...machineDescription.states[stateName]\r\n      });\r\n    }\r\n\r\n    // validate transitions are states\r\n    for (const state of machine.states.values()) {\r\n      for (const transitionState of state.transitions) {\r\n        if (transitionState === '*') {\r\n          continue;\r\n        }\r\n        if (!machine.states.has(transitionState)) {\r\n          throw Error(\r\n            `Invalid state machine, state [${state.name}] has a transition to another state that doesn't exist [${transitionState}]`\r\n          );\r\n        }\r\n      }\r\n    }\r\n    machine.currentState = machine.startState = machine.states.get(machineDescription.start);\r\n    return machine;\r\n  }\r\n\r\n  in(state: TPossibleStates): boolean {\r\n    return this.currentState.name === state;\r\n  }\r\n\r\n  go(stateName: TPossibleStates, eventData?: any): boolean {\r\n    if (this.currentState.transitions.includes(stateName) || this.currentState.transitions.includes('*')) {\r\n      const potentialNewState = this.states.get(stateName);\r\n      if (this.currentState.onExit) {\r\n        const canExit = this.currentState?.onExit({to: potentialNewState.name, data: this.data});\r\n        if (canExit === false) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      if (potentialNewState?.onEnter) {\r\n        const canEnter = potentialNewState?.onEnter({from: this.currentState.name, eventData, data: this.data});\r\n        if (canEnter === false) {\r\n          return false;\r\n        }\r\n      }\r\n      // console.log(`${this.currentState.name} => ${potentialNewState.name} (${eventData})`);\r\n      this.currentState = potentialNewState;\r\n      if (this.currentState?.onState) {\r\n        this.currentState.onState();\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  update(elapsedMs: number) {\r\n    if (this.currentState.onUpdate) {\r\n      this.currentState.onUpdate(this.data, elapsedMs);\r\n    }\r\n  }\r\n\r\n  save(saveKey: string) {\r\n    localStorage.setItem(saveKey, JSON.stringify({\r\n      currentState: this.currentState.name,\r\n      data: this.data\r\n    }));\r\n  }\r\n\r\n  restore(saveKey: string) {\r\n    const state: StateMachineState = JSON.parse(localStorage.getItem(saveKey));\r\n    this.currentState = this.states.get(state.currentState);\r\n    this.data = state.data;\r\n  }\r\n}\r\n\r\n","import { StateMachine } from '../../Util/StateMachine';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { clamp } from '../../Math/util';\r\nimport { AudioContextFactory } from './AudioContext';\r\nimport { Future } from '../../Util/Future';\r\n\r\ninterface SoundState {\r\n  startedAt: number;\r\n  pausedAt: number;\r\n}\r\n\r\n/**\r\n * Internal class representing a Web Audio AudioBufferSourceNode instance\r\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API\r\n */\r\nexport class WebAudioInstance implements Audio {\r\n  private _instance: AudioBufferSourceNode;\r\n  private _audioContext: AudioContext = AudioContextFactory.create();\r\n  private _volumeNode = this._audioContext.createGain();\r\n\r\n  private _playingFuture = new Future<boolean>();\r\n  private _stateMachine = StateMachine.create({\r\n    start: 'STOPPED',\r\n    states: {\r\n      PLAYING: {\r\n        onEnter: ({data}: {from: string, data: SoundState}) => {\r\n\r\n          // Buffer nodes are single use\r\n          this._createNewBufferSource();\r\n          this._handleEnd();\r\n          if (this.loop) {\r\n            // when looping don't set a duration\r\n            this._instance.start(0, data.pausedAt * this._playbackRate);\r\n          } else {\r\n            this._instance.start(0, data.pausedAt * this._playbackRate, this.duration);\r\n          }\r\n          data.startedAt = (this._audioContext.currentTime - data.pausedAt);\r\n          data.pausedAt = 0;\r\n        },\r\n        onState: () => this._playStarted(),\r\n        onExit: ({to}) => {\r\n          // If you've exited early only resolve if explicitly STOPPED\r\n          if (to === 'STOPPED') {\r\n            this._playingFuture.resolve(true);\r\n          }\r\n          // Whenever you're not playing... you stop!\r\n          this._instance.onended = null; // disconnect the wired on-end handler\r\n          this._instance.disconnect();\r\n          this._instance.stop(0);\r\n          this._instance = null;\r\n        },\r\n        transitions: ['STOPPED', 'PAUSED', 'SEEK']\r\n      },\r\n      SEEK: {\r\n        onEnter: ({ eventData: position, data }: {eventData?: number, data: SoundState}) => {\r\n          data.pausedAt = (position ?? 0) / this._playbackRate;\r\n          data.startedAt = 0;\r\n        },\r\n        transitions: ['*']\r\n      },\r\n      STOPPED: {\r\n        onEnter: ({data}: {from: string, data: SoundState}) => {\r\n          data.pausedAt = 0;\r\n          data.startedAt = 0;\r\n          this._playingFuture.resolve(true);\r\n        },\r\n        transitions: ['PLAYING', 'PAUSED', 'SEEK']\r\n      },\r\n      PAUSED: {\r\n        onEnter: ({data}: {data: SoundState}) => {\r\n          // Playback rate will be a scale factor of how fast/slow the audio is being played\r\n          // default is 1.0\r\n          // we need to invert it to get the time scale\r\n          data.pausedAt = (this._audioContext.currentTime - data.startedAt);\r\n        },\r\n        transitions: ['PLAYING', 'STOPPED', 'SEEK']\r\n      }\r\n    }\r\n  }, {\r\n    startedAt: 0,\r\n    pausedAt: 0\r\n  } as SoundState);\r\n\r\n  private _createNewBufferSource() {\r\n    this._instance = this._audioContext.createBufferSource();\r\n    this._instance.buffer = this._src;\r\n    this._instance.loop = this.loop;\r\n    this._instance.playbackRate.value = this._playbackRate;\r\n    this._instance.connect(this._volumeNode);\r\n    this._volumeNode.connect(this._audioContext.destination);\r\n  }\r\n\r\n  private _handleEnd() {\r\n    if (!this.loop) {\r\n      this._instance.onended = () => {\r\n        this._playingFuture.resolve(true);\r\n      };\r\n    }\r\n  }\r\n\r\n  private _volume = 1;\r\n  private _loop = false;\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  private _playStarted: () => any = () => {};\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    if (this._instance) {\r\n      this._instance.loop = value;\r\n      if (!this.loop) {\r\n        this._instance.onended = () => {\r\n          this._playingFuture.resolve(true);\r\n        };\r\n      }\r\n    }\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    value = clamp(value, 0, 1.0);\r\n\r\n    this._volume = value;\r\n\r\n    if (this._stateMachine.in('PLAYING') && this._volumeNode.gain.setTargetAtTime) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime\r\n      // After each .1 seconds timestep, the target value will ~63.2% closer to the target value.\r\n      // This exponential ramp provides a more pleasant transition in gain\r\n      this._volumeNode.gain.setTargetAtTime(value, this._audioContext.currentTime, 0.1);\r\n    } else {\r\n      this._volumeNode.gain.value = value;\r\n    }\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Returns the set duration to play, otherwise returns the total duration if unset\r\n   */\r\n  public get duration() {\r\n    return this._duration ?? this.getTotalPlaybackDuration();\r\n  }\r\n\r\n  /**\r\n   * Set the duration that this audio should play.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number) {\r\n    this._duration = duration;\r\n  }\r\n\r\n  constructor(private _src: AudioBuffer) {\r\n    this._createNewBufferSource();\r\n  }\r\n\r\n  public isPlaying() {\r\n    return this._stateMachine.in('PLAYING');\r\n  }\r\n\r\n  public isPaused() {\r\n    return this._stateMachine.in('PAUSED') || this._stateMachine.in('SEEK');\r\n  }\r\n\r\n  public isStopped() {\r\n    return this._stateMachine.in('STOPPED');\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  public play(playStarted: () => any = () => {}) {\r\n    this._playStarted = playStarted;\r\n    this._stateMachine.go('PLAYING');\r\n    return this._playingFuture.promise;\r\n  }\r\n\r\n  public pause() {\r\n    this._stateMachine.go('PAUSED');\r\n  }\r\n\r\n  public stop() {\r\n    this._stateMachine.go('STOPPED');\r\n  }\r\n\r\n  public seek(position: number) {\r\n    this._stateMachine.go('PAUSED');\r\n    this._stateMachine.go('SEEK', position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    return this._src.duration;\r\n  }\r\n\r\n  public getPlaybackPosition() {\r\n    const {pausedAt, startedAt} =  this._stateMachine.data;\r\n    if (pausedAt) {\r\n      return pausedAt * this._playbackRate;\r\n    }\r\n    if (startedAt) {\r\n      return (this._audioContext.currentTime - startedAt) * this._playbackRate;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _playbackRate = 1.0;\r\n  public set playbackRate(playbackRate: number) {\r\n    this._instance.playbackRate.value = this._playbackRate = playbackRate;\r\n  }\r\n\r\n  public get playbackRate() {\r\n    return this._instance.playbackRate.value;\r\n  }\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Vector } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { Trigger } from './Trigger';\r\nimport { FrameStats } from './Debug';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Side } from './Collision/Side';\r\nimport { CollisionContact } from './Collision/Detection/CollisionContact';\r\nimport { Collider } from './Collision/Colliders/Collider';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate, SceneActivationContext } from './Interfaces/LifecycleEvents';\r\nimport { BodyComponent } from './Collision/BodyComponent';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\nimport { Axes, Buttons, Gamepad } from './Input/Gamepad';\r\nimport { Action } from './Actions/Action';\r\n\r\nexport enum EventTypes {\r\n  Kill = 'kill',\r\n  PreKill = 'prekill',\r\n  PostKill = 'postkill',\r\n\r\n  PreDraw = 'predraw',\r\n  PostDraw = 'postdraw',\r\n\r\n  PreDebugDraw = 'predebugdraw',\r\n  PostDebugDraw = 'postdebugdraw',\r\n\r\n  PreUpdate = 'preupdate',\r\n  PostUpdate = 'postupdate',\r\n\r\n  PreFrame = 'preframe',\r\n  PostFrame = 'postframe',\r\n\r\n  PreCollision = 'precollision',\r\n  CollisionStart = 'collisionstart',\r\n  CollisionEnd = 'collisionend',\r\n  PostCollision = 'postcollision',\r\n\r\n  Initialize = 'initialize',\r\n  Activate = 'activate',\r\n  Deactivate = 'deactivate',\r\n\r\n  ExitViewport = 'exitviewport',\r\n  EnterViewport = 'enterviewport',\r\n\r\n  ExitTrigger = 'exit',\r\n  EnterTrigger = 'enter',\r\n\r\n  Connect = 'connect',\r\n  Disconnect = 'disconnect',\r\n  Button = 'button',\r\n  Axis = 'axis',\r\n\r\n  Visible = 'visible',\r\n  Hidden = 'hidden',\r\n  Start = 'start',\r\n  Stop = 'stop',\r\n\r\n  PointerUp = 'pointerup',\r\n  PointerDown = 'pointerdown',\r\n  PointerMove = 'pointermove',\r\n  PointerEnter = 'pointerenter',\r\n  PointerLeave = 'pointerleave',\r\n  PointerCancel = 'pointercancel',\r\n  PointerWheel = 'pointerwheel',\r\n\r\n  Up = 'up',\r\n  Down = 'down',\r\n  Move = 'move',\r\n  Enter = 'enter',\r\n  Leave = 'leave',\r\n  Cancel = 'cancel',\r\n  Wheel = 'wheel',\r\n\r\n  Press = 'press',\r\n  Release = 'release',\r\n  Hold = 'hold',\r\n\r\n  PointerDragStart = 'pointerdragstart',\r\n  PointerDragEnd = 'pointerdragend',\r\n  PointerDragEnter = 'pointerdragenter',\r\n  PointerDragLeave = 'pointerdragleave',\r\n  PointerDragMove = 'pointerdragmove',\r\n\r\n  ActionStart = 'actionstart',\r\n  ActionComplete = 'actioncomplete'\r\n}\r\n\r\n/* istanbul ignore next */\r\n/* compiler only: these are internal to lib */\r\nexport type kill = 'kill';\r\nexport type prekill = 'prekill';\r\nexport type postkill = 'postkill';\r\n\r\nexport type predraw = 'predraw';\r\nexport type postdraw = 'postdraw';\r\n\r\nexport type predebugdraw = 'predebugdraw';\r\nexport type postdebugdraw = 'postdebugdraw';\r\n\r\nexport type preupdate = 'preupdate';\r\nexport type postupdate = 'postupdate';\r\n\r\nexport type preframe = 'preframe';\r\nexport type postframe = 'postframe';\r\n\r\nexport type precollision = 'precollision';\r\nexport type collisionstart = 'collisionstart';\r\nexport type collisionend = 'collisionend';\r\nexport type postcollision = 'postcollision';\r\n\r\nexport type initialize = 'initialize';\r\nexport type activate = 'activate';\r\nexport type deactivate = 'deactivate';\r\n\r\nexport type exitviewport = 'exitviewport';\r\nexport type enterviewport = 'enterviewport';\r\n\r\nexport type exittrigger = 'exit';\r\nexport type entertrigger = 'enter';\r\n\r\nexport type connect = 'connect';\r\nexport type disconnect = 'disconnect';\r\nexport type button = 'button';\r\nexport type axis = 'axis';\r\n\r\nexport type subscribe = 'subscribe';\r\nexport type unsubscribe = 'unsubscribe';\r\n\r\nexport type visible = 'visible';\r\nexport type hidden = 'hidden';\r\nexport type start = 'start';\r\nexport type stop = 'stop';\r\n\r\nexport type pointerup = 'pointerup';\r\nexport type pointerdown = 'pointerdown';\r\nexport type pointermove = 'pointermove';\r\nexport type pointerenter = 'pointerenter';\r\nexport type pointerleave = 'pointerleave';\r\nexport type pointercancel = 'pointercancel';\r\nexport type pointerwheel = 'pointerwheel';\r\n\r\nexport type up = 'up';\r\nexport type down = 'down';\r\nexport type move = 'move';\r\nexport type enter = 'enter';\r\nexport type leave = 'leave';\r\nexport type cancel = 'cancel';\r\nexport type wheel = 'wheel';\r\n\r\nexport type press = 'press';\r\nexport type release = 'release';\r\nexport type hold = 'hold';\r\n\r\nexport type pointerdragstart = 'pointerdragstart';\r\nexport type pointerdragend = 'pointerdragend';\r\nexport type pointerdragenter = 'pointerdragenter';\r\nexport type pointerdragleave = 'pointerdragleave';\r\nexport type pointerdragmove = 'pointerdragmove';\r\n\r\n/**\r\n * Base event type in Excalibur that all other event types derive from. Not all event types are thrown on all Excalibur game objects,\r\n * some events are unique to a type, others are not.\r\n *\r\n */\r\nexport class GameEvent<T, U = T> {\r\n  /**\r\n   * Target object for this event.\r\n   */\r\n  public target: T;\r\n\r\n  /**\r\n   * Other target object for this event\r\n   */\r\n  public other: U | null;\r\n\r\n  /**\r\n   * If set to false, prevents event from propagating to other actors. If true it will be propagated\r\n   * to all actors that apply.\r\n   */\r\n  public get bubbles(): boolean {\r\n    return this._bubbles;\r\n  }\r\n\r\n  public set bubbles(value: boolean) {\r\n    this._bubbles = value;\r\n  }\r\n\r\n  private _bubbles: boolean = true;\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation() {\r\n    this.bubbles = false;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'kill' event is emitted on actors when it is killed. The target is the actor that was killed.\r\n */\r\nexport class KillEvent extends GameEvent<Entity> {\r\n  constructor(public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'prekill' event is emitted directly before an actor is killed.\r\n */\r\nexport class PreKillEvent extends GameEvent<Actor> {\r\n  constructor(public target: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postkill' event is emitted directly after the actor is killed.\r\n */\r\nexport class PostKillEvent extends GameEvent<Actor> {\r\n  constructor(public target: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'start' event is emitted on engine when has started and is ready for interaction.\r\n */\r\nexport class GameStartEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'stop' event is emitted on engine when has been stopped and will no longer take input, update or draw.\r\n */\r\nexport class GameStopEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predraw' event is emitted on actors, scenes, and engine before drawing starts. Actors' predraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PreDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity | Scene | Engine | TileMap) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdraw' event is emitted on actors, scenes, and engine after drawing finishes. Actors' postdraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PostDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity | Scene | Engine | TileMap) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'pretransformdraw' event is emitted on actors/entities before any graphics transforms have taken place.\r\n * Useful if you need to completely customize the draw or modify the transform before drawing in the draw step (for example needing\r\n * latest camera positions)\r\n *\r\n */\r\nexport class PreTransformDrawEvent extends GameEvent<Entity> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'posttransformdraw' event is emitted on actors/entities after all graphics have been draw and transforms reset.\r\n * Useful if you need to completely custom the draw after everything is done.\r\n *\r\n */\r\nexport class PostTransformDrawEvent extends GameEvent<Entity> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public delta: number, public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predebugdraw' event is emitted on actors, scenes, and engine before debug drawing starts.\r\n */\r\nexport class PreDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public target: Entity | Actor | Scene | Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdebugdraw' event is emitted on actors, scenes, and engine after debug drawing starts.\r\n */\r\nexport class PostDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(public ctx: ExcaliburGraphicsContext, public target: Entity | Actor | Scene | Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preupdate' event is emitted on actors, scenes, camera, and engine before the update starts.\r\n */\r\nexport class PreUpdateEvent<T extends OnPreUpdate = Entity> extends GameEvent<T> {\r\n  constructor(public engine: Engine, public delta: number, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postupdate' event is emitted on actors, scenes, camera, and engine after the update ends.\r\n */\r\nexport class PostUpdateEvent<T extends OnPostUpdate = Entity> extends GameEvent<T> {\r\n  constructor(public engine: Engine, public delta: number, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preframe' event is emitted on the engine, before the frame begins.\r\n */\r\nexport class PreFrameEvent extends GameEvent<Engine> {\r\n  constructor(public engine: Engine, public prevStats: FrameStats) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postframe' event is emitted on the engine, after a frame ends.\r\n */\r\nexport class PostFrameEvent extends GameEvent<Engine> {\r\n  constructor(public engine: Engine, public stats: FrameStats) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is connected to Excalibur. [[Gamepads]] receives this event.\r\n */\r\nexport class GamepadConnectEvent extends GameEvent<Gamepad> {\r\n  constructor(public index: number, public gamepad: Gamepad) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is disconnected from Excalibur. [[Gamepads]] receives this event.\r\n */\r\nexport class GamepadDisconnectEvent extends GameEvent<Gamepad> {\r\n  constructor(public index: number, public gamepad: Gamepad) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad button event. See [[Gamepads]] for information on responding to controller input. [[Gamepad]] instances receive this event;\r\n */\r\nexport class GamepadButtonEvent extends GameEvent<Gamepad> {\r\n  /**\r\n   * @param button  The Gamepad button\r\n   * @param value   A numeric value between 0 and 1\r\n   */\r\n  constructor(public button: Buttons, public value: number, public target: Gamepad) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad axis event. See [[Gamepads]] for information on responding to controller input. [[Gamepad]] instances receive this event;\r\n */\r\nexport class GamepadAxisEvent extends GameEvent<Gamepad> {\r\n  /**\r\n   * @param axis  The Gamepad axis\r\n   * @param value A numeric value between -1 and 1\r\n   */\r\n  constructor(public axis: Axes, public value: number, public target: Gamepad) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the [[Engine]] when the browser window is visible on a screen.\r\n */\r\nexport class VisibleEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the [[Engine]] when the browser window is hidden from all screens.\r\n */\r\nexport class HiddenEvent extends GameEvent<Engine> {\r\n  constructor(public target: Engine) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor|actor]] when a collision will occur this frame if it resolves\r\n */\r\nexport class PreCollisionEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   * @param actor         The actor the event was thrown on\r\n   * @param other         The actor that will collided with the current actor\r\n   * @param side          The side that will be collided with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor|actor]] when a collision has been resolved (body reacted) this frame\r\n */\r\nexport class PostCollisionEvent<T extends Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   * @param actor         The actor the event was thrown on\r\n   * @param other         The actor that did collide with the current actor\r\n   * @param side          The side that did collide with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\nexport class ContactStartEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public contact: CollisionContact) {}\r\n}\r\n\r\nexport class ContactEndEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public lastContact: CollisionContact) {}\r\n}\r\n\r\nexport class CollisionPreSolveEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {}\r\n}\r\n\r\nexport class CollisionPostSolveEvent<T> {\r\n  constructor(public target: T, public other: T, public side: Side, public intersection: Vector, public contact: CollisionContact) {}\r\n}\r\n\r\n/**\r\n * Event thrown the first time an [[Actor|actor]] collides with another, after an actor is in contact normal collision events are fired.\r\n */\r\nexport class CollisionStartEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   * @param actor\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public contact: CollisionContact) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown when the [[Actor|actor]] is no longer colliding with another\r\n */\r\nexport class CollisionEndEvent<T extends BodyComponent | Collider | Entity = Actor> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   */\r\n  constructor(actor: T, public other: T, public side: Side, public lastContact: CollisionContact) {\r\n    super();\r\n    this.target = actor;\r\n  }\r\n\r\n  public get actor() {\r\n    return this.target;\r\n  }\r\n\r\n  public set actor(actor: T) {\r\n    this.target = actor;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]], [[Scene]], and [[Engine]] only once before the first update call\r\n */\r\nexport class InitializeEvent<T extends OnInitialize = Entity> extends GameEvent<T> {\r\n  /**\r\n   * @param engine  The reference to the current engine\r\n   */\r\n  constructor(public engine: Engine, public target: T) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a [[Scene]] on activation\r\n */\r\nexport class ActivateEvent<TData = undefined> extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene activation\r\n   */\r\n  constructor(public context: SceneActivationContext<TData>, public target: Scene) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a [[Scene]] on deactivation\r\n */\r\nexport class DeactivateEvent extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene deactivation\r\n   */\r\n  constructor(public context: SceneActivationContext<never>, public target: Scene) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when the graphics bounds completely leaves the screen.\r\n */\r\nexport class ExitViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when any part of the graphics bounds are on screen.\r\n */\r\nexport class EnterViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport class EnterTriggerEvent extends GameEvent<Actor> {\r\n  constructor(public target: Trigger, public actor: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport class ExitTriggerEvent extends GameEvent<Actor> {\r\n  constructor(public target: Trigger, public actor: Actor) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when an action starts.\r\n */\r\nexport class ActionStartEvent extends GameEvent<Entity> {\r\n  constructor(public action: Action, public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when an action completes.\r\n */\r\nexport class ActionCompleteEvent extends GameEvent<Entity> {\r\n  constructor(public action: Action, public target: Entity) {\r\n    super();\r\n  }\r\n}\r\n","import { GameEvent } from '../Events';\r\nimport { Sound } from '../Resources/Sound/Sound';\r\nimport { Actor } from '../Actor';\r\nimport { WebAudioInstance } from '../Resources/Sound/WebAudioInstance';\r\n\r\nexport class MediaEvent extends GameEvent<Sound> {\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public set bubbles(_value: boolean) {\r\n    // stubbed\r\n  }\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public get bubbles(): boolean {\r\n    return false;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected get _path(): Actor[] {\r\n    return null;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected set _path(_val: Actor[]) {\r\n    // stubbed\r\n  }\r\n\r\n  constructor(public target: Sound, protected _name: string = 'MediaEvent') {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Action, that calls when event happens\r\n   */\r\n  public action(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Propagate event further through event path\r\n   */\r\n  public propagate(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n\r\n  public layPath(_actor: Actor): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n}\r\n\r\nexport class NativeSoundEvent extends MediaEvent {\r\n  constructor(target: Sound, public track?: WebAudioInstance) {\r\n    super(target, 'NativeSoundEvent');\r\n  }\r\n}\r\n\r\nexport class NativeSoundProcessedEvent extends MediaEvent {\r\n  public data: string | AudioBuffer;\r\n\r\n  constructor(target: Sound, private _processedData: string | AudioBuffer) {\r\n    super(target, 'NativeSoundProcessedEvent');\r\n\r\n    this.data = this._processedData;\r\n  }\r\n}\r\n","import { Logger } from './Log';\n\n/**\n * Whether or not the browser can play this file as HTML5 Audio\n */\nexport function canPlayFile(file: string): boolean {\n  try {\n    const a = new Audio();\n    const filetype = /.*\\.([A-Za-z0-9]+)(?:(?:\\?|\\#).*)*$/;\n    const type = file.match(filetype)[1];\n    if (a.canPlayType('audio/' + type)) {\n      return true;\n    } else {\n      return false;\n    }\n  } catch (e) {\n    Logger.getInstance().warn('Cannot determine audio support, assuming no support for the Audio Tag', e);\n    return false;\n  }\n}\n","import { ExResponse } from '../../Interfaces/AudioImplementation';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { Engine } from '../../Engine';\r\nimport { Resource } from '../Resource';\r\nimport { WebAudioInstance } from './WebAudioInstance';\r\nimport { AudioContextFactory } from './AudioContext';\r\nimport { NativeSoundEvent, NativeSoundProcessedEvent } from '../../Events/MediaEvents';\r\nimport { canPlayFile } from '../../Util/Sound';\r\nimport { Loadable } from '../../Interfaces/Index';\r\nimport { Logger } from '../../Util/Log';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../../EventEmitter';\r\n\r\nexport type SoundEvents = {\r\n  volumechange: NativeSoundEvent,\r\n  processed: NativeSoundProcessedEvent,\r\n  pause: NativeSoundEvent,\r\n  stop: NativeSoundEvent,\r\n  playbackend: NativeSoundEvent,\r\n  resume: NativeSoundEvent,\r\n  playbackstart: NativeSoundEvent\r\n}\r\n\r\nexport const SoundEvents = {\r\n  VolumeChange: 'volumechange',\r\n  Processed: 'processed',\r\n  Pause: 'pause',\r\n  Stop: 'stop',\r\n  PlaybackEnd: 'playbackend',\r\n  Resume: 'resume',\r\n  PlaybackStart: 'playbackstart'\r\n};\r\n\r\n/**\r\n * The [[Sound]] object allows games built in Excalibur to load audio\r\n * components, from soundtracks to sound effects. [[Sound]] is an [[Loadable]]\r\n * which means it can be passed to a [[Loader]] to pre-load before a game or level.\r\n */\r\nexport class Sound implements Audio, Loadable<AudioBuffer> {\r\n  public events = new EventEmitter<SoundEvents>();\r\n  public logger: Logger = Logger.getInstance();\r\n  public data: AudioBuffer;\r\n  private _resource: Resource<ArrayBuffer>;\r\n  /**\r\n   * Indicates whether the clip should loop when complete\r\n   * @param value  Set the looping flag\r\n   */\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.loop = this._loop;\r\n    }\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._loop);\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    this._volume = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.volume = this._volume;\r\n    }\r\n\r\n    this.events.emit('volumechange', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._volume);\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Get the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   */\r\n  public get duration(): number | undefined {\r\n    return this._duration;\r\n  }\r\n  /**\r\n   * Set the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number | undefined){\r\n    this._duration = duration;\r\n  }\r\n\r\n  /**\r\n   * Return array of Current AudioInstances playing or being paused\r\n   */\r\n  public get instances(): Audio[] {\r\n    return this._tracks;\r\n  }\r\n\r\n  public get path() {\r\n    return this._resource.path;\r\n  }\r\n\r\n  public set path(val: string) {\r\n    this._resource.path = val;\r\n  }\r\n\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  private _loop = false;\r\n  private _volume = 1;\r\n  private _isStopped = false;\r\n  // private _isPaused = false;\r\n  private _tracks: Audio[] = [];\r\n  private _engine: Engine;\r\n  private _wasPlayingOnHidden: boolean = false;\r\n  private _playbackRate = 1.0;\r\n  private _audioContext = AudioContextFactory.create();\r\n\r\n  /**\r\n   * @param paths A list of audio sources (clip.wav, clip.mp3, clip.ogg) for this audio clip. This is done for browser compatibility.\r\n   */\r\n  constructor(...paths: string[]) {\r\n    this._resource = new Resource('', ExResponse.type.arraybuffer);\r\n    /**\r\n     * Chrome : MP3, WAV, Ogg\r\n     * Firefox : WAV, Ogg,\r\n     * IE : MP3, WAV coming soon\r\n     * Safari MP3, WAV, Ogg\r\n     */\r\n    for (const path of paths) {\r\n      if (canPlayFile(path)) {\r\n        this.path = path;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!this.path) {\r\n      this.logger.warn('This browser does not support any of the audio files specified:', paths.join(', '));\r\n      this.logger.warn('Attempting to use', paths[0]);\r\n      this.path = paths[0]; // select the first specified\r\n    }\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  public async load(): Promise<AudioBuffer> {\r\n    if (this.data) {\r\n      return this.data;\r\n    }\r\n    const arraybuffer = await this._resource.load();\r\n    const audiobuffer = await this.decodeAudio(arraybuffer.slice(0));\r\n    this._duration = this._duration ?? audiobuffer?.duration ?? undefined;\r\n    this.events.emit('processed', new NativeSoundProcessedEvent(this, audiobuffer));\r\n    return this.data = audiobuffer;\r\n  }\r\n\r\n  public async decodeAudio(data: ArrayBuffer): Promise<AudioBuffer> {\r\n    try {\r\n      return await this._audioContext.decodeAudioData(data.slice(0));\r\n    } catch (e) {\r\n      this.logger.error(\r\n        'Unable to decode ' +\r\n          ' this browser may not fully support this format, or the file may be corrupt, ' +\r\n          'if this is an mp3 try removing id3 tags and album art from the file.'\r\n      );\r\n      return await Promise.reject();\r\n    }\r\n  }\r\n\r\n  public wireEngine(engine: Engine) {\r\n    if (engine) {\r\n      this._engine = engine;\r\n\r\n      this._engine.on('hidden', () => {\r\n        if (engine.pauseAudioWhenHidden && this.isPlaying()) {\r\n          this._wasPlayingOnHidden = true;\r\n          this.pause();\r\n        }\r\n      });\r\n\r\n      this._engine.on('visible', () => {\r\n        if (engine.pauseAudioWhenHidden && this._wasPlayingOnHidden) {\r\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n          this.play();\r\n          this._wasPlayingOnHidden = false;\r\n        }\r\n      });\r\n\r\n      this._engine.on('start', () => {\r\n        this._isStopped = false;\r\n      });\r\n\r\n      this._engine.on('stop', () => {\r\n        this.stop();\r\n        this._isStopped = true;\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns how many instances of the sound are currently playing\r\n   */\r\n  public instanceCount(): number {\r\n    return this._tracks.length;\r\n  }\r\n\r\n  /**\r\n   * Whether or not the sound is playing right now\r\n   */\r\n  public isPlaying(): boolean {\r\n    return this._tracks.some((t) => t.isPlaying());\r\n  }\r\n\r\n  public isPaused(): boolean {\r\n    return this._tracks.some(t => t.isPaused());\r\n  }\r\n\r\n  public isStopped(): boolean {\r\n    return this._tracks.some(t => t.isStopped());\r\n  }\r\n\r\n  /**\r\n   * Play the sound, returns a promise that resolves when the sound is done playing\r\n   * An optional volume argument can be passed in to play the sound. Max volume is 1.0\r\n   */\r\n  public play(volume?: number): Promise<boolean> {\r\n    if (!this.isLoaded()) {\r\n      this.logger.warn('Cannot start playing. Resource', this.path, 'is not loaded yet');\r\n\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    if (this._isStopped) {\r\n      this.logger.warn('Cannot start playing. Engine is in a stopped state.');\r\n      return Promise.resolve(false);\r\n    }\r\n\r\n    this.volume = volume || this.volume;\r\n\r\n    if (this.isPaused()) {\r\n      return this._resumePlayback();\r\n    } else {\r\n      return this._startPlayback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop the sound, and do not rewind\r\n   */\r\n  public pause() {\r\n    if (!this.isPlaying()) {\r\n      return;\r\n    }\r\n\r\n    for (const track of this._tracks) {\r\n      track.pause();\r\n    }\r\n\r\n    this.events.emit('pause', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Paused all instances of sound', this.path);\r\n  }\r\n\r\n  /**\r\n   * Stop the sound if it is currently playing and rewind the track. If the sound is not playing, rewinds the track.\r\n   */\r\n  public stop() {\r\n    for (const track of this._tracks) {\r\n      track.stop();\r\n    }\r\n\r\n    this.events.emit('stop', new NativeSoundEvent(this));\r\n\r\n    this._tracks.length = 0;\r\n    this.logger.debug('Stopped all instances of sound', this.path);\r\n  }\r\n\r\n  public get playbackRate(): number {\r\n    return this._playbackRate;\r\n  }\r\n\r\n  public set playbackRate(playbackRate: number) {\r\n    this._playbackRate = playbackRate;\r\n    this._tracks.forEach(t => {\r\n      t.playbackRate = this._playbackRate;\r\n    });\r\n  }\r\n\r\n  public seek(position: number, trackId = 0) {\r\n    if (this._tracks.length === 0) {\r\n      this._getTrackInstance(this.data);\r\n    }\r\n\r\n    this._tracks[trackId].seek(position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    if (!this.isLoaded()) {\r\n      this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.` +\r\n      `Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`);\r\n      return 0;\r\n    }\r\n    return this.data.duration;\r\n  }\r\n\r\n  /**\r\n   * Return the current playback time of the playing track in seconds from the start.\r\n   *\r\n   * Optionally specify the track to query if multiple are playing at once.\r\n   * @param trackId\r\n   */\r\n  public getPlaybackPosition(trackId = 0) {\r\n    if (this._tracks.length) {\r\n      return this._tracks[trackId].getPlaybackPosition();\r\n    }\r\n    return 0;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Get Id of provided AudioInstance in current trackList\r\n   * @param track [[Audio]] which Id is to be given\r\n   */\r\n  public getTrackId(track: Audio): number {\r\n    return this._tracks.indexOf(track);\r\n  }\r\n\r\n  private async _resumePlayback(): Promise<boolean> {\r\n    if (this.isPaused) {\r\n      const resumed: Promise<boolean>[] = [];\r\n      // ensure we resume *current* tracks (if paused)\r\n      for (const track of this._tracks) {\r\n        resumed.push(track.play().then(() => {\r\n          this._tracks.splice(this.getTrackId(track), 1);\r\n          return true;\r\n        }));\r\n      }\r\n\r\n      this.events.emit('resume', new NativeSoundEvent(this));\r\n\r\n      this.logger.debug('Resuming paused instances for sound', this.path, this._tracks);\r\n      // resolve when resumed tracks are done\r\n      await Promise.all(resumed);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Starts playback, returns a promise that resolves when playback is complete\r\n   */\r\n  private async _startPlayback(): Promise<boolean> {\r\n    const track = this._getTrackInstance(this.data);\r\n\r\n    const complete = await track.play(() => {\r\n      this.events.emit('playbackstart', new NativeSoundEvent(this, track));\r\n      this.logger.debug('Playing new instance for sound', this.path);\r\n    });\r\n\r\n    this.events.emit('playbackend', new NativeSoundEvent(this, track));\r\n\r\n    // cleanup any done tracks\r\n    const trackId = this.getTrackId(track);\r\n    if (trackId !== -1) {\r\n      this._tracks.splice(trackId, 1);\r\n    }\r\n\r\n    return complete;\r\n  }\r\n\r\n  private _getTrackInstance(data: AudioBuffer): WebAudioInstance {\r\n    const newTrack = new WebAudioInstance(data);\r\n\r\n    newTrack.loop = this.loop;\r\n    newTrack.volume = this.volume;\r\n    newTrack.duration = this.duration;\r\n    newTrack.playbackRate = this._playbackRate;\r\n\r\n    this._tracks.push(newTrack);\r\n\r\n    return newTrack;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, event: SoundEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n}\r\n","import { WebAudio } from '../Util/WebAudio';\r\nimport { Engine } from '../Engine';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport { Canvas } from '../Graphics/Canvas';\r\nimport { ImageFiltering } from '../Graphics/Filtering';\r\nimport { clamp } from '../Math/util';\r\nimport { Sound } from '../Resources/Sound/Sound';\r\nimport { Future } from '../Util/Future';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { Color } from '../Color';\r\nimport { delay } from '../Util/Util';\r\n\r\nexport interface DefaultLoaderOptions {\r\n  /**\r\n   * List of loadables\r\n   */\r\n  loadables?: Loadable<any>[];\r\n}\r\n\r\nexport type LoaderEvents = {\r\n  // Add event types here\r\n  beforeload: void,\r\n  afterload: void,\r\n  useraction: void,\r\n  loadresourcestart: Loadable<any>,\r\n  loadresourceend: Loadable<any>,\r\n}\r\n\r\nexport const LoaderEvents = {\r\n  // Add event types here\r\n  BeforeLoad: 'beforeload',\r\n  AfterLoad: 'afterload',\r\n  UserAction: 'useraction',\r\n  LoadResourceStart: 'loadresourcestart',\r\n  LoadResourceEnd: 'loadresourceend'\r\n};\r\n\r\nexport type LoaderConstructor = new (...args: any[]) => DefaultLoader;\r\n/**\r\n * Returns true if the constructor is for an Excalibur Loader\r\n */\r\nexport function isLoaderConstructor(x: any): x is LoaderConstructor {\r\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\r\n}\r\n\r\nexport class DefaultLoader implements Loadable<Loadable<any>[]> {\r\n  public data: Loadable<any>[];\r\n  public events = new EventEmitter<LoaderEvents>();\r\n  public canvas: Canvas = new Canvas({\r\n    filtering: ImageFiltering.Blended,\r\n    smoothing: true,\r\n    cache: false,\r\n    draw: this.onDraw.bind(this)\r\n  });\r\n  private _resources: Loadable<any>[] = [];\r\n  public get resources(): readonly Loadable<any>[] {\r\n    return this._resources;\r\n  }\r\n  private _numLoaded: number = 0;\r\n  public engine: Engine;\r\n\r\n\r\n  /**\r\n   * @param options Optionally provide the list of resources you want to load at constructor time\r\n   */\r\n  constructor(options?: DefaultLoaderOptions) {\r\n    if (options && options.loadables?.length) {\r\n      this.addResources(options.loadables);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called by the engine before loading\r\n   * @param engine\r\n   */\r\n  public onInitialize(engine: Engine) {\r\n    this.engine = engine;\r\n    this.canvas.width = this.engine.screen.resolution.width;\r\n    this.canvas.height = this.engine.screen.resolution.height;\r\n  }\r\n\r\n  /**\r\n   * Return a promise that resolves when the user interacts with the loading screen in some way, usually a click.\r\n   *\r\n   * It's important to implement this in order to unlock the audio context in the browser. Browsers automatically prevent\r\n   * audio from playing until the user performs an action.\r\n   *\r\n   */\r\n  public async onUserAction(): Promise<void> {\r\n\r\n    return await Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called directly before loading starts\r\n   */\r\n  public async onBeforeLoad() {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called after loading has completed\r\n   */\r\n  public async onAfterLoad() {\r\n    // override me\r\n    await delay(500, this.engine.clock); // avoid a flicker\r\n  }\r\n\r\n  /**\r\n   * Add a resource to the loader to load\r\n   * @param loadable  Resource to add\r\n   */\r\n  public addResource(loadable: Loadable<any>) {\r\n    this._resources.push(loadable);\r\n  }\r\n\r\n  /**\r\n   * Add a list of resources to the loader to load\r\n   * @param loadables  The list of resources to load\r\n   */\r\n  public addResources(loadables: Loadable<any>[]) {\r\n    let i = 0;\r\n    const len = loadables.length;\r\n\r\n    for (i; i < len; i++) {\r\n      this.addResource(loadables[i]);\r\n    }\r\n  }\r\n\r\n  public markResourceComplete(): void {\r\n    this._numLoaded++;\r\n  }\r\n\r\n  /**\r\n   * Returns the progress of the loader as a number between [0, 1] inclusive.\r\n   */\r\n  public get progress(): number {\r\n    const total = this._resources.length;\r\n    return total > 0 ? clamp(this._numLoaded, 0, total) / total : 1;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the loader has completely loaded all resources\r\n   */\r\n  public isLoaded() {\r\n    return this._numLoaded === this._resources.length;\r\n  }\r\n\r\n  private _totalTimeMs = 0;\r\n\r\n  /**\r\n   * Optionally override the onUpdate\r\n   * @param engine\r\n   * @param elapsedMilliseconds\r\n   */\r\n  onUpdate(engine: Engine, elapsedMilliseconds: number): void {\r\n    this._totalTimeMs += elapsedMilliseconds;\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Optionally override the onDraw\r\n   */\r\n  onDraw(ctx: CanvasRenderingContext2D) {\r\n    const seconds = this._totalTimeMs / 1000;\r\n\r\n    ctx.fillStyle = Color.Black.toRGBA();\r\n    ctx.fillRect(0, 0, this.engine.screen.resolution.width, this.engine.screen.resolution.height);\r\n\r\n    ctx.save();\r\n    ctx.translate(this.engine.screen.resolution.width / 2, this.engine.screen.resolution.height / 2);\r\n    const speed = seconds * 10;\r\n    ctx.strokeStyle = 'white';\r\n    ctx.lineWidth = 10;\r\n    ctx.lineCap = 'round';\r\n    ctx.arc(0, 0, 40, speed, speed + (Math.PI * 3 / 2));\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = 'white';\r\n    ctx.font = '16px sans-serif';\r\n    const text = (this.progress * 100).toFixed(0) + '%';\r\n    const textbox = ctx.measureText(text);\r\n    const width = Math.abs(textbox.actualBoundingBoxLeft) + Math.abs(textbox.actualBoundingBoxRight);\r\n    const height = Math.abs(textbox.actualBoundingBoxAscent) + Math.abs(textbox.actualBoundingBoxDescent);\r\n    ctx.fillText(text, -width / 2, height / 2); // center\r\n    ctx.restore();\r\n  }\r\n\r\n\r\n  private _loadingFuture = new Future<void>();\r\n  public areResourcesLoaded() {\r\n    return this._loadingFuture.promise;\r\n  }\r\n\r\n  /**\r\n   * Not meant to be overridden\r\n   *\r\n   * Begin loading all of the supplied resources, returning a promise\r\n   * that resolves when loading of all is complete AND the user has interacted with the loading screen\r\n   */\r\n  public async load(): Promise<Loadable<any>[]> {\r\n    await this.onBeforeLoad();\r\n    this.events.emit('beforeload');\r\n    this.canvas.flagDirty();\r\n\r\n    await Promise.all(\r\n      this._resources.map(async (r) => {\r\n        this.events.emit('loadresourcestart', r);\r\n        await r.load().finally(() => {\r\n          // capture progress\r\n          this._numLoaded++;\r\n          this.canvas.flagDirty();\r\n          this.events.emit('loadresourceend', r);\r\n        });\r\n      })\r\n    );\r\n\r\n    // Wire all sound to the engine\r\n    for (const resource of this._resources) {\r\n      if (resource instanceof Sound) {\r\n        resource.wireEngine(this.engine);\r\n      }\r\n    }\r\n\r\n    this._loadingFuture.resolve();\r\n    this.canvas.flagDirty();\r\n    // Unlock browser AudioContext in after user gesture\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/262\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/1031\r\n    await this.onUserAction();\r\n    this.events.emit('useraction');\r\n    await WebAudio.unlock();\r\n\r\n    await this.onAfterLoad();\r\n    this.events.emit('afterload');\r\n    return (this.data = this._resources);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, event: LoaderEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n}\r\n","import { Color } from '../Color';\nimport { Vector } from '../Math/vector';\n\n/**\n * A canvas linecap style. \"butt\" is the default flush style, \"round\" is a semi-circle cap with a radius half the width of\n * the line, and \"square\" is a rectangle that is an equal width and half height cap.\n */\nexport type LineCapStyle = 'butt' | 'round' | 'square';\n\n/* istanbul ignore next */\n/**\n * Draw a line on canvas context\n * @param ctx The canvas context\n * @param color The color of the line\n * @param x1 The start x coordinate\n * @param y1 The start y coordinate\n * @param x2 The ending x coordinate\n * @param y2 The ending y coordinate\n * @param thickness The line thickness\n * @param cap The [[LineCapStyle]] (butt, round, or square)\n */\nexport function line(\n  ctx: CanvasRenderingContext2D,\n  color: Color = Color.Red,\n  x1: number,\n  y1: number,\n  x2: number,\n  y2: number,\n  thickness: number = 1,\n  cap: LineCapStyle = 'butt'\n) {\n  ctx.save();\n  ctx.beginPath();\n  ctx.lineWidth = thickness;\n  ctx.lineCap = cap;\n  ctx.strokeStyle = color.toString();\n  ctx.moveTo(x1, y1);\n  ctx.lineTo(x2, y2);\n  ctx.closePath();\n  ctx.stroke();\n  ctx.restore();\n}\n\n/* istanbul ignore next */\n/**\n * Draw the vector as a point onto the canvas.\n */\nexport function point(ctx: CanvasRenderingContext2D, color: Color = Color.Red, point: Vector): void {\n  ctx.beginPath();\n  ctx.strokeStyle = color.toString();\n  ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);\n  ctx.closePath();\n  ctx.stroke();\n}\n\n/**\n * Draw the vector as a line onto the canvas starting a origin point.\n */\n/* istanbul ignore next */\n/**\n *\n */\nexport function vector(ctx: CanvasRenderingContext2D, color: Color, origin: Vector, vector: Vector, scale: number = 1.0): void {\n  const c = color ? color.toString() : 'blue';\n  const v = vector.scale(scale);\n  ctx.beginPath();\n  ctx.strokeStyle = c;\n  ctx.moveTo(origin.x, origin.y);\n  ctx.lineTo(origin.x + v.x, origin.y + v.y);\n  ctx.closePath();\n  ctx.stroke();\n}\n\n/**\n * Represents border radius values\n */\nexport interface BorderRadius {\n  /**\n   * Top-left\n   */\n  tl: number;\n  /**\n   * Top-right\n   */\n  tr: number;\n  /**\n   * Bottom-right\n   */\n  br: number;\n  /**\n   * Bottom-left\n   */\n  bl: number;\n}\n\n/**\n * Draw a round rectangle on a canvas context\n * @param ctx The canvas context\n * @param x The top-left x coordinate\n * @param y The top-left y coordinate\n * @param width The width of the rectangle\n * @param height The height of the rectangle\n * @param radius The border radius of the rectangle\n * @param stroke The [[Color]] to stroke rectangle with\n * @param fill The [[Color]] to fill rectangle with\n */\nexport function roundRect(\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  radius: number | BorderRadius = 5,\n  stroke: Color = Color.White,\n  fill: Color = null\n) {\n  let br: BorderRadius;\n\n  if (typeof radius === 'number') {\n    br = { tl: radius, tr: radius, br: radius, bl: radius };\n  } else {\n    const defaultRadius: BorderRadius = { tl: 0, tr: 0, br: 0, bl: 0 };\n\n    for (const prop in defaultRadius) {\n      if (defaultRadius.hasOwnProperty(prop)) {\n        const side = <keyof BorderRadius>prop;\n        br[side] = radius[side] || defaultRadius[side];\n      }\n    }\n  }\n\n  ctx.beginPath();\n  ctx.moveTo(x + br.tl, y);\n  ctx.lineTo(x + width - br.tr, y);\n  ctx.quadraticCurveTo(x + width, y, x + width, y + br.tr);\n  ctx.lineTo(x + width, y + height - br.br);\n  ctx.quadraticCurveTo(x + width, y + height, x + width - br.br, y + height);\n  ctx.lineTo(x + br.bl, y + height);\n  ctx.quadraticCurveTo(x, y + height, x, y + height - br.bl);\n  ctx.lineTo(x, y + br.tl);\n  ctx.quadraticCurveTo(x, y, x + br.tl, y);\n  ctx.closePath();\n\n  if (fill) {\n    ctx.fillStyle = fill.toString();\n    ctx.fill();\n  }\n\n  if (stroke) {\n    ctx.strokeStyle = stroke.toString();\n    ctx.stroke();\n  }\n}\n\n/**\n *\n */\nexport function circle(\n  ctx: CanvasRenderingContext2D,\n  x: number,\n  y: number,\n  radius: number,\n  stroke: Color = Color.White,\n  fill: Color = null\n) {\n  ctx.beginPath();\n  ctx.arc(x, y, radius, 0, Math.PI * 2);\n  ctx.closePath();\n\n  if (fill) {\n    ctx.fillStyle = fill.toString();\n    ctx.fill();\n  }\n\n  if (stroke) {\n    ctx.strokeStyle = stroke.toString();\n    ctx.stroke();\n  }\n}\n","import { Color } from '../Color';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport * as DrawUtil from '../Util/DrawUtil';\r\n\r\nimport logoImg from './Loader.logo.png';\r\nimport loaderCss from './Loader.css';\r\nimport { Vector } from '../Math/vector';\r\nimport { delay } from '../Util/Util';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { DefaultLoader, DefaultLoaderOptions } from './DefaultLoader';\r\nimport { Engine } from '../Engine';\r\nimport { Screen } from '../Screen';\r\nimport { Logger } from '../Util/Log';\r\nimport { Future } from '../Util/Future';\r\n\r\nexport interface LoaderOptions extends DefaultLoaderOptions {\r\n  /**\r\n   * Go fullscreen after loading and clicking play\r\n   */\r\n  fullscreenAfterLoad?: boolean;\r\n  /**\r\n   * Fullscreen container element or id\r\n   */\r\n  fullscreenContainer?: HTMLElement | string;\r\n}\r\n\r\n/**\r\n * Pre-loading assets\r\n *\r\n * The loader provides a mechanism to preload multiple resources at\r\n * one time. The loader must be passed to the engine in order to\r\n * trigger the loading progress bar.\r\n *\r\n * The [[Loader]] itself implements [[Loadable]] so you can load loaders.\r\n *\r\n * ## Example: Pre-loading resources for a game\r\n *\r\n * ```js\r\n * // create a loader\r\n * var loader = new ex.Loader();\r\n *\r\n * // create a resource dictionary (best practice is to keep a separate file)\r\n * var resources = {\r\n *   TextureGround: new ex.Texture(\"/images/textures/ground.png\"),\r\n *   SoundDeath: new ex.Sound(\"/sound/death.wav\", \"/sound/death.mp3\")\r\n * };\r\n *\r\n * // loop through dictionary and add to loader\r\n * for (var loadable in resources) {\r\n *   if (resources.hasOwnProperty(loadable)) {\r\n *     loader.addResource(resources[loadable]);\r\n *   }\r\n * }\r\n *\r\n * // start game\r\n * game.start(loader).then(function () {\r\n *   console.log(\"Game started!\");\r\n * });\r\n * ```\r\n *\r\n * ## Customize the Loader\r\n *\r\n * The loader can be customized to show different, text, logo, background color, and button.\r\n *\r\n * ```typescript\r\n * const loader = new ex.Loader([playerTexture]);\r\n *\r\n * // The loaders button text can simply modified using this\r\n * loader.playButtonText = 'Start the best game ever';\r\n *\r\n * // The logo can be changed by inserting a base64 image string here\r\n *\r\n * loader.logo = 'data:image/png;base64,iVBORw...';\r\n * loader.logoWidth = 15;\r\n * loader.logoHeight = 14;\r\n *\r\n * // The background color can be changed like so by supplying a valid CSS color string\r\n *\r\n * loader.backgroundColor = 'red'\r\n * loader.backgroundColor = '#176BAA'\r\n *\r\n * // To build a completely new button\r\n * loader.startButtonFactory = () => {\r\n *     let myButton = document.createElement('button');\r\n *     myButton.textContent = 'The best button';\r\n *     return myButton;\r\n * };\r\n *\r\n * engine.start(loader).then(() => {});\r\n * ```\r\n */\r\nexport class Loader extends DefaultLoader {\r\n  private _logger = Logger.getInstance();\r\n  private static _DEFAULT_LOADER_OPTIONS: LoaderOptions = {\r\n    loadables: [],\r\n    fullscreenAfterLoad: false,\r\n    fullscreenContainer: undefined\r\n  };\r\n  private _originalOptions: LoaderOptions = {loadables:[]};\r\n  public events = new EventEmitter();\r\n  public screen: Screen;\r\n  private _playButtonShown: boolean = false;\r\n\r\n  // logo drawing stuff\r\n\r\n  // base64 string encoding of the excalibur logo (logo-white.png)\r\n  public logo = logoImg;\r\n  public logoWidth = 468;\r\n  public logoHeight = 118;\r\n  /**\r\n   * Positions the top left corner of the logo image\r\n   * If not set, the loader automatically positions the logo\r\n   */\r\n  public logoPosition: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the play button.\r\n   * If not set, the loader automatically positions the play button\r\n   */\r\n  public playButtonPosition: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the loading bar\r\n   * If not set, the loader automatically positions the loading bar\r\n   */\r\n  public loadingBarPosition: Vector | null;\r\n\r\n  /**\r\n   * Gets or sets the color of the loading bar, default is [[Color.White]]\r\n   */\r\n  public loadingBarColor: Color = Color.White;\r\n\r\n  /**\r\n   * Gets or sets the background color of the loader as a hex string\r\n   */\r\n  public backgroundColor: string = '#176BAA';\r\n\r\n  protected _imageElement: HTMLImageElement;\r\n  protected _imageLoaded: Future<void> = new Future();\r\n  protected get _image() {\r\n    if (!this._imageElement) {\r\n      this._imageElement = new Image();\r\n      this._imageElement.onload = () => this._imageLoaded.resolve();\r\n      this._imageElement.src = this.logo;\r\n    }\r\n\r\n    return this._imageElement;\r\n  }\r\n\r\n  public suppressPlayButton: boolean = false;\r\n  public get playButtonRootElement(): HTMLElement | null {\r\n    return this._playButtonRootElement;\r\n  }\r\n  public get playButtonElement(): HTMLButtonElement | null {\r\n    return this._playButtonElement;\r\n  }\r\n  protected _playButtonRootElement: HTMLElement;\r\n  protected _playButtonElement: HTMLButtonElement;\r\n  protected _styleBlock: HTMLStyleElement;\r\n  /** Loads the css from Loader.css */\r\n  protected _playButtonStyles: string = loaderCss.toString();\r\n  protected get _playButton() {\r\n    const existingRoot = document.getElementById('excalibur-play-root');\r\n    if (existingRoot) {\r\n      this._playButtonRootElement = existingRoot;\r\n    }\r\n    if (!this._playButtonRootElement) {\r\n      this._playButtonRootElement = document.createElement('div');\r\n      this._playButtonRootElement.id = 'excalibur-play-root';\r\n      this._playButtonRootElement.style.position = 'absolute';\r\n      document.body.appendChild(this._playButtonRootElement);\r\n    }\r\n    if (!this._styleBlock) {\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._playButtonStyles;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n    if (!this._playButtonElement) {\r\n      this._playButtonElement = this.startButtonFactory();\r\n      this._playButtonRootElement.appendChild(this._playButtonElement);\r\n    }\r\n    return this._playButtonElement;\r\n  }\r\n\r\n  /**\r\n   * Get/set play button text\r\n   */\r\n  public playButtonText: string = 'Play game';\r\n\r\n  /**\r\n   * Return a html button element for excalibur to use as a play button\r\n   */\r\n  public startButtonFactory = () => {\r\n    let buttonElement: HTMLButtonElement = document.getElementById('excalibur-play') as HTMLButtonElement;\r\n    if (!buttonElement) {\r\n      buttonElement = document.createElement('button');\r\n    }\r\n\r\n    buttonElement.id = 'excalibur-play';\r\n    buttonElement.textContent = this.playButtonText;\r\n    buttonElement.style.display = 'none';\r\n    return buttonElement;\r\n  };\r\n\r\n  /**\r\n   * @param options Optionally provide options to loader\r\n   */\r\n  constructor(options?: LoaderOptions);\r\n  /**\r\n   * @param loadables  Optionally provide the list of resources you want to load at constructor time\r\n   */\r\n  constructor(loadables?: Loadable<any>[]);\r\n  constructor(loadablesOrOptions?: Loadable<any>[] | LoaderOptions) {\r\n    const options = Array.isArray(loadablesOrOptions) ? {\r\n      loadables: loadablesOrOptions\r\n    } : loadablesOrOptions;\r\n    super(options);\r\n    this._originalOptions = { ...Loader._DEFAULT_LOADER_OPTIONS, ...options };\r\n  }\r\n\r\n  public override onInitialize(engine: Engine): void {\r\n    this.engine = engine;\r\n    this.screen = engine.screen;\r\n    this.canvas.width = this.engine.canvas.width;\r\n    this.canvas.height = this.engine.canvas.height;\r\n    this.screen.events.on('resize', () => {\r\n      this.canvas.width = this.engine.canvas.width;\r\n      this.canvas.height = this.engine.canvas.height;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Shows the play button and returns a promise that resolves when clicked\r\n   */\r\n  public async showPlayButton(): Promise<void> {\r\n    if (this.suppressPlayButton) {\r\n      this.hidePlayButton();\r\n      // Delay is to give the logo a chance to show, otherwise don't delay\r\n      await delay(500, this.engine?.clock);\r\n    } else {\r\n      const resizeHandler = () => {\r\n        try {\r\n          this._positionPlayButton();\r\n        } catch {\r\n          // swallow if can't position\r\n        };\r\n      };\r\n      if (this.engine?.browser) {\r\n        this.engine.browser.window.on('resize', resizeHandler);\r\n      }\r\n      this._playButtonShown = true;\r\n      this._playButton.style.display = 'block';\r\n      document.body.addEventListener('keyup', (evt: KeyboardEvent) => {\r\n        if (evt.key === 'Enter') {\r\n          this._playButton.click();\r\n        }\r\n      });\r\n      this._positionPlayButton();\r\n      const playButtonClicked = new Promise<void>(resolve => {\r\n        const startButtonHandler =  (e: Event) => {\r\n          // We want to stop propagation to keep bubbling to the engine pointer handlers\r\n          e.stopPropagation();\r\n          // Hide Button after click\r\n          this.hidePlayButton();\r\n          if (this.engine?.browser) {\r\n            this.engine.browser.window.off('resize', resizeHandler);\r\n          }\r\n\r\n          if (this._originalOptions.fullscreenAfterLoad) {\r\n            try {\r\n              this._logger.info('requesting fullscreen');\r\n              if (this._originalOptions.fullscreenContainer instanceof HTMLElement) {\r\n                this._originalOptions.fullscreenContainer.requestFullscreen();\r\n              } else {\r\n                this.engine.screen.goFullScreen(this._originalOptions.fullscreenContainer);\r\n              }\r\n            } catch (error) {\r\n              this._logger.error('could not go fullscreen', error);\r\n            }\r\n          }\r\n\r\n          resolve();\r\n        };\r\n        this._playButton.addEventListener('click', startButtonHandler);\r\n        this._playButton.addEventListener('touchend', startButtonHandler);\r\n        this._playButton.addEventListener('pointerup', startButtonHandler);\r\n      });\r\n\r\n      return await playButtonClicked;\r\n    }\r\n  }\r\n\r\n  public hidePlayButton() {\r\n    this._playButtonShown = false;\r\n    this._playButton.style.display = 'none';\r\n  }\r\n\r\n  /**\r\n   * Clean up generated elements for the loader\r\n   */\r\n  public dispose() {\r\n    if (this._playButtonRootElement.parentElement) {\r\n      this._playButtonRootElement.removeChild(this._playButtonElement);\r\n      document.body.removeChild(this._playButtonRootElement);\r\n      document.head.removeChild(this._styleBlock);\r\n      this._playButtonRootElement = null;\r\n      this._playButtonElement = null;\r\n      this._styleBlock = null;\r\n    }\r\n  }\r\n\r\n  data: Loadable<any>[];\r\n\r\n  public override async onUserAction(): Promise<void> {\r\n    // short delay in showing the button for aesthetics\r\n    await delay(200, this.engine?.clock);\r\n    this.canvas.flagDirty();\r\n    // show play button\r\n    await this.showPlayButton();\r\n  }\r\n\r\n  private _configuredPixelRatio: number | null = null;\r\n  public override async onBeforeLoad(): Promise<void> {\r\n    const image = this._image;\r\n    await this._imageLoaded.promise;\r\n    await image?.decode(); // decode logo if it exists\r\n  }\r\n\r\n  // eslint-disable-next-line require-await\r\n  public override async onAfterLoad(): Promise<void> {\r\n    this.screen.pixelRatioOverride = this._configuredPixelRatio;\r\n    this.screen.popResolutionAndViewport();\r\n    this.screen.applyResolutionAndViewport();\r\n    this.dispose();\r\n  }\r\n\r\n  private _positionPlayButton() {\r\n    if (this.engine) {\r\n      const {\r\n        x: left,\r\n        y: top,\r\n        width: screenWidth,\r\n        height: screenHeight\r\n      } = this.engine.canvas.getBoundingClientRect();\r\n      if (this._playButtonRootElement) {\r\n        const buttonWidth = this._playButton.clientWidth;\r\n        const buttonHeight = this._playButton.clientHeight;\r\n        if (this.playButtonPosition) {\r\n          this._playButtonRootElement.style.left = `${this.playButtonPosition.x}px`;\r\n          this._playButtonRootElement.style.top = `${this.playButtonPosition.y}px`;\r\n        } else {\r\n          this._playButtonRootElement.style.left = `${left + screenWidth / 2 - buttonWidth / 2}px`;\r\n          this._playButtonRootElement.style.top = `${top + screenHeight / 2 - buttonHeight / 2 + 100}px`;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loader draw function. Draws the default Excalibur loading screen.\r\n   * Override `logo`, `logoWidth`, `logoHeight` and `backgroundColor` properties\r\n   * to customize the drawing, or just override entire method.\r\n   */\r\n  public override onDraw(ctx: CanvasRenderingContext2D) {\r\n    const canvasHeight = this.engine.canvasHeight / this.engine.pixelRatio;\r\n    const canvasWidth = this.engine.canvasWidth / this.engine.pixelRatio;\r\n\r\n    this._positionPlayButton();\r\n\r\n    ctx.fillStyle = this.backgroundColor;\r\n    ctx.fillRect(0, 0, canvasWidth, canvasHeight);\r\n\r\n    let logoY = canvasHeight / 2;\r\n    const width = Math.min(this.logoWidth, canvasWidth * 0.75);\r\n    let logoX = canvasWidth / 2 - width / 2;\r\n\r\n    if (this.logoPosition) {\r\n      logoX = this.logoPosition.x;\r\n      logoY = this.logoPosition.y;\r\n    }\r\n\r\n    const imageHeight = Math.floor(width * (this.logoHeight / this.logoWidth)); // OG height/width factor\r\n    const oldAntialias = this.engine.getAntialiasing();\r\n    this.engine.setAntialiasing(true);\r\n    if (!this.logoPosition) {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY - imageHeight - 20, width, imageHeight);\r\n    } else {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY, width, imageHeight);\r\n    }\r\n\r\n    // loading box\r\n    if (!this.suppressPlayButton && this._playButtonShown) {\r\n      this.engine.setAntialiasing(oldAntialias);\r\n      return;\r\n    }\r\n\r\n    let loadingX = logoX;\r\n    let loadingY = logoY;\r\n    if (this.loadingBarPosition) {\r\n      loadingX = this.loadingBarPosition.x;\r\n      loadingY = this.loadingBarPosition.y;\r\n    }\r\n\r\n    ctx.lineWidth = 2;\r\n    DrawUtil.roundRect(ctx, loadingX, loadingY, width, 20, 10, this.loadingBarColor);\r\n    const progress = width * this.progress;\r\n    const margin = 5;\r\n    const progressWidth = progress - margin * 2;\r\n    const height = 20 - margin * 2;\r\n    DrawUtil.roundRect(\r\n      ctx,\r\n      loadingX + margin,\r\n      loadingY + margin,\r\n      progressWidth > 10 ? progressWidth : 10,\r\n      height,\r\n      5,\r\n      null,\r\n      this.loadingBarColor\r\n    );\r\n    this.engine.setAntialiasing(oldAntialias);\r\n  }\r\n}\r\n","export default \"data:image/png;base64,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\"","import { Logger } from './Log';\r\n/**\r\n * This is the list of features that will be used to log the supported\r\n * features to the console when Detector.logBrowserFeatures() is called.\r\n */\r\n\r\nconst REPORTED_FEATURES: { [key: string]: string } = {\r\n  webgl: 'WebGL',\r\n  webaudio: 'WebAudio',\r\n  gamepadapi: 'Gamepad API'\r\n};\r\n\r\n/**\r\n * Interface for detected browser features matrix\r\n */\r\nexport interface DetectedFeatures {\r\n  readonly canvas: boolean;\r\n  readonly arraybuffer: boolean;\r\n  readonly dataurl: boolean;\r\n  readonly objecturl: boolean;\r\n  readonly rgba: boolean;\r\n  readonly webaudio: boolean;\r\n  readonly webgl: boolean;\r\n  readonly gamepadapi: boolean;\r\n}\r\n\r\ninterface CriticalTests {\r\n  canvasSupport(): boolean;\r\n  arrayBufferSupport(): boolean;\r\n  dataUrlSupport(): boolean;\r\n  objectUrlSupport(): boolean;\r\n  rgbaSupport(): boolean;\r\n}\r\n\r\ninterface WarningTests {\r\n  webAudioSupport(): boolean;\r\n  webglSupport(): boolean;\r\n}\r\n\r\n/**\r\n * Excalibur internal feature detection helper class\r\n */\r\nexport class Detector {\r\n  private _features: DetectedFeatures = null;\r\n\r\n  public failedTests: string[] = [];\r\n\r\n  public constructor() {\r\n    this._features = this._loadBrowserFeatures();\r\n  }\r\n\r\n  /**\r\n   * Returns a map of currently supported browser features. This method\r\n   * treats the features as a singleton and will only calculate feature\r\n   * support if it has not previously been done.\r\n   */\r\n  public getBrowserFeatures(): DetectedFeatures {\r\n    if (this._features === null) {\r\n      this._features = this._loadBrowserFeatures();\r\n    }\r\n    return this._features;\r\n  }\r\n\r\n  /**\r\n   * Report on non-critical browser support for debugging purposes.\r\n   * Use native browser console colors for visibility.\r\n   */\r\n  public logBrowserFeatures(): void {\r\n    let msg = '%cSUPPORTED BROWSER FEATURES\\n==========================%c\\n';\r\n    const args = ['font-weight: bold; color: navy', 'font-weight: normal; color: inherit'];\r\n\r\n    const supported: any = this.getBrowserFeatures();\r\n    for (const feature of Object.keys(REPORTED_FEATURES)) {\r\n      if (supported[feature]) {\r\n        msg += '(%c\\u2713%c)'; // ()\r\n        args.push('font-weight: bold; color: green');\r\n        args.push('font-weight: normal; color: inherit');\r\n      } else {\r\n        msg += '(%c\\u2717%c)'; // ()\r\n        args.push('font-weight: bold; color: red');\r\n        args.push('font-weight: normal; color: inherit');\r\n      }\r\n\r\n      msg += ' ' + REPORTED_FEATURES[feature] + '\\n';\r\n    }\r\n\r\n    args.unshift(msg);\r\n    // eslint-disable-next-line no-console\r\n    console.log.apply(console, args);\r\n  }\r\n\r\n  /**\r\n   * Executes several IIFE's to get a constant reference to supported\r\n   * features within the current execution context.\r\n   */\r\n  private _loadBrowserFeatures(): DetectedFeatures {\r\n    return {\r\n      // IIFE to check canvas support\r\n      canvas: (() => {\r\n        return this._criticalTests.canvasSupport();\r\n      })(),\r\n\r\n      // IIFE to check arraybuffer support\r\n      arraybuffer: (() => {\r\n        return this._criticalTests.arrayBufferSupport();\r\n      })(),\r\n\r\n      // IIFE to check dataurl support\r\n      dataurl: (() => {\r\n        return this._criticalTests.dataUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check objecturl support\r\n      objecturl: (() => {\r\n        return this._criticalTests.objectUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check rgba support\r\n      rgba: (() => {\r\n        return this._criticalTests.rgbaSupport();\r\n      })(),\r\n\r\n      // IIFE to check webaudio support\r\n      webaudio: (() => {\r\n        return this._warningTest.webAudioSupport();\r\n      })(),\r\n\r\n      // IIFE to check webgl support\r\n      webgl: (() => {\r\n        return this._warningTest.webglSupport();\r\n      })(),\r\n\r\n      // IIFE to check gamepadapi support\r\n      gamepadapi: (() => {\r\n        return !!(<any>navigator).getGamepads;\r\n      })()\r\n    };\r\n  }\r\n\r\n  // critical browser features required for ex to run\r\n  private _criticalTests: CriticalTests = {\r\n    // Test canvas/2d context support\r\n    canvasSupport: function() {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('2d'));\r\n    },\r\n\r\n    // Test array buffer support ex uses for downloading binary data\r\n    arrayBufferSupport: function() {\r\n      const xhr = new XMLHttpRequest();\r\n      xhr.open('GET', '/');\r\n      try {\r\n        xhr.responseType = 'arraybuffer';\r\n      } catch (e) {\r\n        return false;\r\n      }\r\n      return xhr.responseType === 'arraybuffer';\r\n    },\r\n\r\n    // Test data urls ex uses for sprites\r\n    dataUrlSupport: function() {\r\n      const canvas = document.createElement('canvas');\r\n      return canvas.toDataURL('image/png').indexOf('data:image/png') === 0;\r\n    },\r\n\r\n    // Test object url support for loading\r\n    objectUrlSupport: function() {\r\n      return 'URL' in window && 'revokeObjectURL' in URL && 'createObjectURL' in URL;\r\n    },\r\n\r\n    // RGBA support for colors\r\n    rgbaSupport: function() {\r\n      const style = document.createElement('a').style;\r\n      style.cssText = 'background-color:rgba(150,255,150,.5)';\r\n      return ('' + style.backgroundColor).indexOf('rgba') > -1;\r\n    }\r\n  };\r\n\r\n  // warnings excalibur performance will be degraded\r\n  private _warningTest: WarningTests = {\r\n    webAudioSupport: function() {\r\n      return !!(\r\n        (<any>window).AudioContext ||\r\n        (<any>window).webkitAudioContext ||\r\n        (<any>window).mozAudioContext ||\r\n        (<any>window).msAudioContext ||\r\n        (<any>window).oAudioContext\r\n      );\r\n    },\r\n    webglSupport: function() {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('webgl'));\r\n    }\r\n  };\r\n\r\n  public test(): boolean {\r\n    // Critical test will for ex not to run\r\n    let failedCritical = false;\r\n    for (const test in this._criticalTests) {\r\n      if (!this._criticalTests[<keyof CriticalTests>test].call(this)) {\r\n        this.failedTests.push(test);\r\n        Logger.getInstance().error('Critical browser feature missing, Excalibur requires:', test);\r\n        failedCritical = true;\r\n      }\r\n    }\r\n    if (failedCritical) {\r\n      return false;\r\n    }\r\n\r\n    // Warning tests do not for ex to return false to compatibility\r\n    for (const warning in this._warningTest) {\r\n      if (!this._warningTest[<keyof WarningTests>warning]()) {\r\n        Logger.getInstance().warn('Warning browser feature missing, Excalibur will have reduced performance:', warning);\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","/**\n * An enum that describes the types of collisions bodies can participate in\n */\nexport enum CollisionType {\n  /**\n   * Bodies with the `PreventCollision` setting do not participate in any\n   * collisions and do not raise collision events.\n   */\n  PreventCollision = 'PreventCollision',\n  /**\n   * Bodies with the `Passive` setting only raise collision events, but are not\n   * influenced or moved by other bodies and do not influence or move other bodies.\n   * This is useful for use in trigger type behavior.\n   */\n  Passive = 'Passive',\n  /**\n   * Bodies with the `Active` setting raise collision events and participate\n   * in collisions with other bodies and will be push or moved by bodies sharing\n   * the `Active` or `Fixed` setting.\n   */\n  Active = 'Active',\n  /**\n   * Bodies with the `Fixed` setting raise collision events and participate in\n   * collisions with other bodies. Actors with the `Fixed` setting will not be\n   * pushed or moved by other bodies sharing the `Fixed`. Think of Fixed\n   * bodies as \"immovable/unstoppable\" objects. If two `Fixed` bodies meet they will\n   * not be pushed or moved by each other, they will not interact except to throw\n   * collision events.\n   */\n  Fixed = 'Fixed'\n}\n","/**\r\n * Enum representing the coordinate plane for the position 2D vector in the [[TransformComponent]]\r\n */\r\nexport enum CoordPlane {\r\n  /**\r\n   * The world coordinate plane (default) represents world space, any entities drawn with world\r\n   * space move when the camera moves.\r\n   */\r\n  World = 'world',\r\n  /**\r\n   * The screen coordinate plane represents screen space, entities drawn in screen space are pinned\r\n   * to screen coordinates ignoring the camera.\r\n   */\r\n  Screen = 'screen'\r\n}","/**\n * Possible collision resolution strategies\n *\n * The default is [[SolverStrategy.Arcade]] which performs simple axis aligned arcade style physics. This is useful for things\n * like platformers or top down games.\n *\n * More advanced rigid body physics are enabled by setting [[SolverStrategy.Realistic]] which allows for complicated\n * simulated physical interactions.\n */\nexport enum SolverStrategy {\n  Arcade = 'arcade',\n  Realistic = 'realistic'\n}\n","import { Vector } from '../Math/vector';\nimport { SolverStrategy } from './SolverStrategy';\n\n/**\n * Possible broadphase collision pair identification strategies\n *\n * The default strategy is [[BroadphaseStrategy.DynamicAABBTree]] which uses a binary tree of axis-aligned bounding boxes to identify\n * potential collision pairs which is O(nlog(n)) faster.\n * @deprecated Unused in Excalibur, will be removed in v0.30\n */\nexport enum BroadphaseStrategy {\n  DynamicAABBTree\n}\n\n/**\n * Possible numerical integrators for position and velocity\n * @deprecated Unused in Excalibur, will be removed in v0.30\n */\nexport enum Integrator {\n  Euler\n}\n\n/**\n * The [[Physics]] object is the global configuration object for all Excalibur physics.\n * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n */\n/* istanbul ignore next */\nexport class Physics {\n  /**\n   * Global acceleration that is applied to all vanilla actors that have a [[CollisionType.Active|active]] collision type.\n   * Global acceleration won't effect [[Label|labels]], [[ScreenElement|ui actors]], or [[Trigger|triggers]] in Excalibur.\n   *\n   * This is a great way to globally simulate effects like gravity.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static acc = new Vector(0, 0);\n  /**\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static get gravity() {\n    return Physics.acc;\n  }\n  public static set gravity(v: Vector) {\n    Physics.acc = v;\n  }\n\n  /**\n   * Globally switches all Excalibur physics behavior on or off.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static enabled = true;\n\n  /**\n   * Gets or sets the broadphase pair identification strategy.\n   *\n   * The default strategy is [[BroadphaseStrategy.DynamicAABBTree]] which uses a binary tree of axis-aligned bounding boxes to identify\n   * potential collision pairs which is O(nlog(n)) faster.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static broadphaseStrategy: BroadphaseStrategy = BroadphaseStrategy.DynamicAABBTree;\n\n  /**\n   * Gets or sets the global collision resolution strategy (narrowphase).\n   *\n   * The default is [[SolverStrategy.Arcade]] which performs simple axis aligned arcade style physics.\n   *\n   * More advanced rigid body physics are enabled by setting [[SolverStrategy.Realistic]] which allows for complicated\n   * simulated physical interactions.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static collisionResolutionStrategy: SolverStrategy = SolverStrategy.Arcade;\n  /**\n   * The default mass to use if none is specified\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static defaultMass: number = 10;\n  /**\n   * Gets or sets the position and velocity positional integrator, currently only Euler is supported.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static integrator: Integrator = Integrator.Euler;\n\n  /**\n   * Configures Excalibur to use \"arcade\" physics. Arcade physics which performs simple axis aligned arcade style physics.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static useArcadePhysics(): void {\n    Physics.collisionResolutionStrategy = SolverStrategy.Arcade;\n  }\n\n  /**\n   * Configures Excalibur to use rigid body physics. Rigid body physics allows for complicated\n   * simulated physical interactions.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static useRealisticPhysics(): void {\n    Physics.collisionResolutionStrategy = SolverStrategy.Realistic;\n  }\n\n  /**\n   * Factor to add to the RigidBody BoundingBox, bounding box (dimensions += vel * dynamicTreeVelocityMultiplier);\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static dynamicTreeVelocityMultiplier = 2;\n\n  /**\n   * Pad RigidBody BoundingBox by a constant amount\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static boundsPadding = 5;\n\n  /**\n   * Number of position iterations (overlap) to run in the solver\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static positionIterations = 3;\n\n  /**\n   * Number of velocity iteration (response) to run in the solver\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static velocityIterations = 8;\n\n  /**\n   * Amount of overlap to tolerate in pixels\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static slop = 1;\n\n  /**\n   * Amount of positional overlap correction to apply each position iteration of the solver\n   * O - meaning no correction, 1 - meaning correct all overlap\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static steeringFactor = 0.2;\n\n  /**\n   * Warm start set to true re-uses impulses from previous frames back in the solver\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static warmStart = true;\n\n  /**\n   * By default bodies do not sleep\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static bodiesCanSleepByDefault = false;\n\n  /**\n   * Surface epsilon is used to help deal with surface penetration\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static surfaceEpsilon = 0.1;\n\n  /**\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static sleepEpsilon = 0.07;\n\n  /**\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static wakeThreshold = Physics.sleepEpsilon * 3;\n\n  /**\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static sleepBias = 0.9;\n\n  /**\n   * Enable fast moving body checking, this enables checking for collision pairs via raycast for fast moving objects to prevent\n   * bodies from tunneling through one another.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static checkForFastBodies = true;\n\n  /**\n   * Disable minimum fast moving body raycast, by default if ex.Physics.checkForFastBodies = true Excalibur will only check if the\n   * body is moving at least half of its minimum dimension in an update. If ex.Physics.disableMinimumSpeedForFastBody is set to true,\n   * Excalibur will always perform the fast body raycast regardless of speed.\n   * @deprecated Use engine args to configure Physics `new ex.Engine({physics: {...}})`, will be removed in v0.30\n   */\n  public static disableMinimumSpeedForFastBody = false;\n}\n","\r\n/**\r\n * Tells the Arcade collision solver to prefer certain contacts over others\r\n */\r\nexport enum ContactSolveBias {\r\n  None = 'none',\r\n  VerticalFirst = 'vertical-first',\r\n  HorizontalFirst = 'horizontal-first'\r\n}\r\n\r\n/**\r\n * Contact bias values\r\n */\r\nexport interface ContactBias {\r\n  vertical: number;\r\n  horizontal: number;\r\n}\r\n\r\n/**\r\n * Vertical First contact solve bias Used by the [[ArcadeSolver]] to sort contacts\r\n */\r\nexport const VerticalFirst: ContactBias = {\r\n  'vertical': 1,\r\n  'horizontal': 2\r\n} as const;\r\n\r\n/**\r\n * Horizontal First contact solve bias Used by the [[ArcadeSolver]] to sort contacts\r\n */\r\nexport const HorizontalFirst: ContactBias = {\r\n  'horizontal': 1,\r\n  'vertical': 2\r\n} as const;\r\n\r\n/**\r\n * None value, [[ArcadeSolver]] sorts contacts using distance by default\r\n */\r\nexport const None: ContactBias = {\r\n  'horizontal': 0,\r\n  'vertical': 0\r\n} as const;","import { Vector } from './vector';\n\nexport interface VectorViewOptions {\n  getX: () => number;\n  getY: () => number;\n  setX: (x: number) => void;\n  setY: (y: number) => void;\n}\nexport class VectorView extends Vector {\n  private _getX: () => number;\n  private _getY: () => number;\n  private _setX: (x: number) => void;\n  private _setY: (y: number) => void;\n  constructor(options: VectorViewOptions) {\n    super(0, 0);\n    this._getX = options.getX;\n    this._getY = options.getY;\n    this._setX = options.setX;\n    this._setY = options.setY;\n  }\n  public get x() {\n    return (this._x = this._getX());\n  }\n\n  public set x(val) {\n    this._setX(val);\n    this._x = val;\n  }\n\n  public get y() {\n    return (this._y = this._getY());\n  }\n  public set y(val) {\n    this._setY(val);\n    this._y = val;\n  }\n}\n","import { Vector } from './vector';\r\n\r\n/**\r\n * Wraps a vector and watches for changes in the x/y, modifies the original vector.\r\n */\r\nexport class WatchVector extends Vector {\r\n  constructor(public original: Vector, public change: (x: number, y: number) => any) {\r\n    super(original.x, original.y);\r\n  }\r\n  public get x() {\r\n    return this._x = this.original.x;\r\n  }\r\n\r\n  public set x(newX: number) {\r\n    this.change(newX, this._y);\r\n    this._x = this.original.x = newX;\r\n  }\r\n\r\n  public get y() {\r\n    return this._y = this.original.y;\r\n  }\r\n\r\n  public set y(newY: number) {\r\n    this.change(this._x, newY);\r\n    this._y = this.original.y = newY;\r\n  }\r\n}","import { AffineMatrix } from './affine-matrix';\r\nimport { canonicalizeAngle } from './util';\r\nimport { vec, Vector } from './vector';\r\nimport { VectorView } from './vector-view';\r\nimport { WatchVector } from './watch-vector';\r\n\r\nexport class Transform {\r\n  private _parent: Transform | null = null;\r\n  get parent() {\r\n    return this._parent;\r\n  }\r\n  set parent(transform: Transform | null) {\r\n    if (this._parent) {\r\n      const index = this._parent._children.indexOf(this);\r\n      if (index > -1) {\r\n        this._parent._children.splice(index, 1);\r\n      }\r\n    }\r\n    this._parent = transform;\r\n    if (this._parent) {\r\n      this._parent._children.push(this);\r\n    }\r\n    this.flagDirty();\r\n  }\r\n  get children(): readonly Transform[] {\r\n    return this._children;\r\n  }\r\n  private _children: Transform[] = [];\r\n\r\n  private _pos: Vector = vec(0, 0);\r\n  set pos(v: Vector) {\r\n    if (!v.equals(this._pos)) {\r\n      this._pos.x = v.x;\r\n      this._pos.y = v.y;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get pos() {\r\n    return new WatchVector(this._pos, (x, y) => {\r\n      if (x !== this._pos.x || y !== this._pos.y) {\r\n        this.flagDirty();\r\n      }\r\n    });\r\n  }\r\n\r\n  set globalPos(v: Vector) {\r\n    let localPos = v.clone();\r\n    if (this.parent) {\r\n      localPos = this.parent.inverse.multiply(v);\r\n    }\r\n    if (!localPos.equals(this._pos)) {\r\n      this._pos = localPos;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get globalPos() {\r\n    return new VectorView({\r\n      getX: () => this.matrix.data[4],\r\n      getY: () => this.matrix.data[5],\r\n      setX: (x) => {\r\n        if (this.parent) {\r\n          const { x: newX } = this.parent.inverse.multiply(vec(x, this.pos.y));\r\n          this.pos.x = newX;\r\n        } else {\r\n          this.pos.x = x;\r\n        }\r\n        if (x !== this.matrix.data[4]) {\r\n          this.flagDirty();\r\n        }\r\n      },\r\n      setY: (y) => {\r\n        if (this.parent) {\r\n          const { y: newY } = this.parent.inverse.multiply(vec(this.pos.x, y));\r\n          this.pos.y = newY;\r\n        } else {\r\n          this.pos.y = y;\r\n        }\r\n        if (y !== this.matrix.data[5]) {\r\n          this.flagDirty();\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private _rotation: number = 0;\r\n  set rotation(rotation: number) {\r\n    const canonRotation = canonicalizeAngle(rotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n  get rotation() {\r\n    return this._rotation;\r\n  }\r\n\r\n  set globalRotation(rotation: number) {\r\n    let inverseRotation = 0;\r\n    if (this.parent) {\r\n      inverseRotation = this.parent.globalRotation;\r\n    }\r\n    const canonRotation = canonicalizeAngle(rotation + inverseRotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    if (this.parent) {\r\n      return this.matrix.getRotation();\r\n    }\r\n    return this.rotation;\r\n  }\r\n\r\n  private _scale: Vector = vec(1, 1);\r\n  set scale(v: Vector) {\r\n    if (v.x !== this._scale.x || v.y !== this._scale.y) {\r\n      this._scale.x = v.x;\r\n      this._scale.y = v.y;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  get scale() {\r\n    return new WatchVector(this._scale, (x, y) => {\r\n      if (x !== this._scale.x || y !== this._scale.y) {\r\n        this.flagDirty();\r\n      }\r\n    });\r\n  }\r\n\r\n  set globalScale(v: Vector) {\r\n    let inverseScale = vec(1, 1);\r\n    if (this.parent) {\r\n      inverseScale = this.parent.globalScale;\r\n    }\r\n    this.scale = v.scale(vec(1 / inverseScale.x, 1 / inverseScale.y));\r\n  }\r\n\r\n  get globalScale() {\r\n    return new VectorView({\r\n      getX: () => this.parent ? this.matrix.getScaleX() : this.scale.x,\r\n      getY: () => this.parent ? this.matrix.getScaleY() : this.scale.y,\r\n      setX: (x) => {\r\n        if (this.parent) {\r\n          const globalScaleX = this.parent.globalScale.x;\r\n          this.scale.x = x / globalScaleX;\r\n        } else {\r\n          this.scale.x = x;\r\n        }\r\n      },\r\n      setY: (y) => {\r\n        if (this.parent) {\r\n          const globalScaleY = this.parent.globalScale.y;\r\n          this.scale.y = y / globalScaleY;\r\n        } else {\r\n          this.scale.y = y;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private _isDirty = false;\r\n  private _isInverseDirty = false;\r\n  private _matrix = AffineMatrix.identity();\r\n  private _inverse = AffineMatrix.identity();\r\n\r\n  public get matrix() {\r\n    if (this._isDirty) {\r\n      if (this.parent === null) {\r\n        this._matrix = this._calculateMatrix();\r\n      } else {\r\n        this._matrix = this.parent.matrix.multiply(this._calculateMatrix());\r\n      }\r\n      this._isDirty = false;\r\n    }\r\n    return this._matrix;\r\n  }\r\n\r\n  public get inverse() {\r\n    if (this._isInverseDirty) {\r\n      this._inverse = this.matrix.inverse();\r\n      this._isInverseDirty = false;\r\n    }\r\n    return this._inverse;\r\n  }\r\n\r\n  private _calculateMatrix(): AffineMatrix {\r\n    const matrix = AffineMatrix.identity()\r\n      .translate(this.pos.x, this.pos.y)\r\n      .rotate(this.rotation)\r\n      .scale(this.scale.x, this.scale.y);\r\n    return matrix;\r\n  }\r\n\r\n\r\n  public flagDirty() {\r\n    this._isDirty = true;\r\n    this._isInverseDirty = true;\r\n    for (let i = 0; i < this._children.length; i ++) {\r\n      this._children[i].flagDirty();\r\n    }\r\n  }\r\n\r\n  public apply(point: Vector): Vector {\r\n    return this.matrix.multiply(point);\r\n  }\r\n\r\n  public applyInverse(point: Vector): Vector {\r\n    return this.inverse.multiply(point);\r\n  }\r\n\r\n  public setTransform(pos: Vector, rotation: number, scale: Vector) {\r\n    this._pos.x = pos.x;\r\n    this._pos.y = pos.y;\r\n    this._rotation = canonicalizeAngle(rotation);\r\n    this._scale.x = scale.x;\r\n    this._scale.y = scale.y;\r\n    this.flagDirty();\r\n  }\r\n\r\n  /**\r\n   * Clones the current transform\r\n   * **Warning does not clone the parent**\r\n   * @param dest\r\n   */\r\n  public clone(dest?: Transform) {\r\n    const target = dest ?? new Transform();\r\n    this._pos.clone(target._pos);\r\n    target._rotation = this._rotation;\r\n    this._scale.clone(target._scale);\r\n    target.flagDirty();\r\n    return target;\r\n  }\r\n}","import { Entity } from './Entity';\r\n\r\n/**\r\n * Component Constructor Types\r\n */\r\nexport declare type ComponentCtor<TComponent extends Component = Component> = new (...args:any[]) => TComponent;\r\n\r\n/**\r\n *\r\n */\r\nexport function isComponentCtor(value: any): value is ComponentCtor<Component> {\r\n  return !!value && !!value.prototype && !!value.prototype.constructor;\r\n}\r\n\r\n/**\r\n * Type guard to check if a component implements clone\r\n * @param x\r\n */\r\nfunction hasClone(x: any): x is { clone(): any } {\r\n  return !!x?.clone;\r\n}\r\n\r\n/**\r\n * Components are containers for state in Excalibur, the are meant to convey capabilities that an Entity possesses\r\n *\r\n * Implementations of Component must have a zero-arg constructor to support dependencies\r\n *\r\n * ```typescript\r\n * class MyComponent extends ex.Component {\r\n *   // zero arg support required if you want to use component dependencies\r\n *   constructor(public optionalPos?: ex.Vector) {}\r\n * }\r\n * ```\r\n */\r\nexport abstract class Component {\r\n  // TODO maybe generate a unique id?\r\n\r\n  /**\r\n   * Optionally list any component types this component depends on\r\n   * If the owner entity does not have these components, new components will be added to the entity\r\n   *\r\n   * Only components with zero-arg constructors are supported as automatic component dependencies\r\n   */\r\n  readonly dependencies?: ComponentCtor[];\r\n\r\n  /**\r\n   * Current owning [[Entity]], if any, of this component. Null if not added to any [[Entity]]\r\n   */\r\n  owner?: Entity = undefined;\r\n\r\n  /**\r\n   * Clones any properties on this component, if that property value has a `clone()` method it will be called\r\n   */\r\n  clone(): Component {\r\n    const newComponent = new (this.constructor as any)();\r\n    for (const prop in this) {\r\n      if (this.hasOwnProperty(prop)) {\r\n        const val = this[prop];\r\n        if (hasClone(val) && prop !== 'owner' && prop !== 'clone') {\r\n          newComponent[prop] = val.clone();\r\n        } else {\r\n          newComponent[prop] = val;\r\n        }\r\n      }\r\n    }\r\n    return newComponent;\r\n  }\r\n\r\n  /**\r\n   * Optional callback called when a component is added to an entity\r\n   */\r\n  onAdd?(owner: Entity): void;\r\n\r\n  /**\r\n   * Optional callback called when a component is removed from an entity\r\n   */\r\n  onRemove?(previousOwner: Entity): void;\r\n}","/**\n * Defines a generic message that can contain any data\n * @template T is the typescript Type of the data\n */\nexport interface Message<T> {\n  type: string;\n  data: T;\n}\n\n/**\n * Defines an interface for an observer to receive a message via a notify() method\n */\nexport interface Observer<T> {\n  notify(message: T): void;\n}\n\n/**\n * Defines an interface for something that might be an observer if a notify() is present\n */\nexport type MaybeObserver<T> = Partial<Observer<T>>;\n\n/**\n * Simple Observable implementation\n * @template T is the typescript Type that defines the data being observed\n */\nexport class Observable<T> {\n  public observers: Observer<T>[] = [];\n  public subscriptions: ((val: T) => any)[] = [];\n\n  /**\n   * Register an observer to listen to this observable\n   * @param observer\n   */\n  register(observer: Observer<T>) {\n    this.observers.push(observer);\n  }\n\n  /**\n   * Register a callback to listen to this observable\n   * @param func\n   */\n  subscribe(func: (val: T) => any) {\n    this.subscriptions.push(func);\n  }\n\n  /**\n   * Remove an observer from the observable\n   * @param observer\n   */\n  unregister(observer: Observer<T>) {\n    const i = this.observers.indexOf(observer);\n    if (i !== -1) {\n      this.observers.splice(i, 1);\n    }\n  }\n\n  /**\n   * Remove a callback that is listening to this observable\n   * @param func\n   */\n  unsubscribe(func: (val: T) => any) {\n    const i = this.subscriptions.indexOf(func);\n    if (i !== -1) {\n      this.subscriptions.splice(i, 1);\n    }\n  }\n\n  /**\n   * Broadcasts a message to all observers and callbacks\n   * @param message\n   */\n  notifyAll(message: T) {\n    const observersLength = this.observers.length;\n    for (let i = 0; i < observersLength; i++) {\n      this.observers[i].notify(message);\n    }\n    const subscriptionsLength = this.subscriptions.length;\n    for (let i = 0; i < subscriptionsLength; i++) {\n      this.subscriptions[i](message);\n    }\n  }\n\n  /**\n   * Removes all observers and callbacks\n   */\n  clear() {\n    this.observers.length = 0;\n    this.subscriptions.length = 0;\n  }\n}\n","import { Vector } from '../../Math/vector';\r\nimport { CoordPlane } from '../../Math/coord-plane';\r\nimport { Transform } from '../../Math/transform';\r\nimport { Component } from '../Component';\r\nimport { Entity } from '../Entity';\r\nimport { Observable } from '../../Util/Observable';\r\nimport { Logger } from '../../Util/Log';\r\n\r\n\r\nexport class TransformComponent extends Component {\r\n  private _logger = Logger.getInstance();\r\n  private _parentComponent: TransformComponent | null = null;\r\n  private _transform = new Transform();\r\n  public get() {\r\n    return this._transform;\r\n  }\r\n\r\n  private _addChildTransform = (child: Entity) => {\r\n    const childTxComponent = child.get(TransformComponent);\r\n    if (childTxComponent) {\r\n      childTxComponent._transform.parent = this._transform;\r\n      childTxComponent._parentComponent = this;\r\n    }\r\n  };\r\n  onAdd(owner: Entity): void {\r\n    for (const child of owner.children) {\r\n      this._addChildTransform(child);\r\n    }\r\n    owner.childrenAdded$.subscribe(child => this._addChildTransform(child));\r\n    owner.childrenRemoved$.subscribe(child => {\r\n      const childTxComponent = child.get(TransformComponent);\r\n      if (childTxComponent) {\r\n        childTxComponent._transform.parent = null;\r\n        childTxComponent._parentComponent = null;\r\n      }\r\n    });\r\n  }\r\n  onRemove(_previousOwner: Entity): void {\r\n    this._transform.parent = null;\r\n    this._parentComponent = null;\r\n  }\r\n\r\n  /**\r\n   * Observable that emits when the z index changes on this component\r\n   */\r\n  public zIndexChanged$ = new Observable<number>();\r\n  private _z = 0;\r\n\r\n  /**\r\n   * The z-index ordering of the entity, a higher values are drawn on top of lower values.\r\n   * For example z=99 would be drawn on top of z=0.\r\n   */\r\n  public get z(): number {\r\n    return this._z;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    const oldz = this._z;\r\n    this._z = val;\r\n    if (oldz !== val) {\r\n      this.zIndexChanged$.notifyAll(val);\r\n    }\r\n  }\r\n\r\n  private _coordPlane = CoordPlane.World;\r\n  /**\r\n   * The [[CoordPlane|coordinate plane|]] for this transform for the entity.\r\n   */\r\n  public get coordPlane() {\r\n    if (this._parentComponent) {\r\n      return this._parentComponent.coordPlane;\r\n    }\r\n    return this._coordPlane;\r\n  }\r\n\r\n  public set coordPlane(value: CoordPlane) {\r\n    if (!this._parentComponent) {\r\n      this._coordPlane = value;\r\n    } else {\r\n      this._logger.warn(\r\n        `Cannot set coordinate plane on child entity ${this.owner?.name}, children inherit their coordinate plane from their parents.`);\r\n    }\r\n  }\r\n\r\n  get pos() {\r\n    return this._transform.pos;\r\n  }\r\n  set pos(v: Vector) {\r\n    this._transform.pos = v;\r\n  }\r\n\r\n  get globalPos() {\r\n    return this._transform.globalPos;\r\n  }\r\n  set globalPos(v: Vector) {\r\n    this._transform.globalPos = v;\r\n  }\r\n\r\n  get rotation() {\r\n    return this._transform.rotation;\r\n  }\r\n  set rotation(rotation) {\r\n    this._transform.rotation = rotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    return this._transform.globalRotation;\r\n  }\r\n  set globalRotation(rotation) {\r\n    this._transform.globalRotation = rotation;\r\n  }\r\n\r\n  get scale() {\r\n    return this._transform.scale;\r\n  }\r\n  set scale(v: Vector) {\r\n    this._transform.scale = v;\r\n  }\r\n\r\n  get globalScale() {\r\n    return this._transform.globalScale;\r\n  }\r\n  set globalScale(v: Vector) {\r\n    this._transform.globalScale = v;\r\n  }\r\n\r\n  applyInverse(v: Vector) {\r\n    return this._transform.applyInverse(v);\r\n  }\r\n\r\n  apply(v: Vector) {\r\n    return this._transform.apply(v);\r\n  }\r\n\r\n  clone(): TransformComponent {\r\n    const component = new TransformComponent();\r\n    component._transform = this._transform.clone();\r\n    component._z = this._z;\r\n    return component;\r\n  }\r\n}","import { Vector } from '../../Math/vector';\r\nimport { Component } from '../Component';\r\n\r\nexport interface Motion {\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  vel: Vector;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  acc: Vector;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  scaleFactor: Vector;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  angularVelocity: number;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  torque: number;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  inertia: number;\r\n}\r\n\r\nexport class MotionComponent extends Component {\r\n\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  public scaleFactor: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  public angularVelocity = 0;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  public torque: number = 0;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  public inertia: number = 1;\r\n}\r\n","import { CollisionGroup } from './CollisionGroup';\n\n/**\n * Static class for managing collision groups in excalibur, there is a maximum of 32 collision groups possible in excalibur\n */\nexport class CollisionGroupManager {\n  // using bitmasking the maximum number of groups is 32, because that is the highest 32bit integer that JS can present.\n  private static _STARTING_BIT = 0b1 | 0;\n  private static _MAX_GROUPS = 32;\n  private static _CURRENT_GROUP = 1;\n  private static _CURRENT_BIT = CollisionGroupManager._STARTING_BIT;\n  private static _GROUPS: Map<string, CollisionGroup> = new Map<string, CollisionGroup>();\n\n  /**\n   * Create a new named collision group up to a max of 32.\n   * @param name Name for the collision group\n   * @param mask Optionally provide your own 32-bit mask, if none is provide the manager will generate one\n   */\n  public static create(name: string, mask?: number) {\n    if (this._CURRENT_GROUP > this._MAX_GROUPS) {\n      throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);\n    }\n    if (this._GROUPS.get(name)) {\n      const existingGroup = this._GROUPS.get(name);\n      if (existingGroup.mask === mask) {\n        return existingGroup;\n      }\n      throw new Error(`Collision group ${name} already exists with a different mask!`);\n    }\n    const group = new CollisionGroup(name, this._CURRENT_BIT, mask !== undefined ? mask : ~this._CURRENT_BIT);\n    this._CURRENT_BIT = (this._CURRENT_BIT << 1) | 0;\n    this._CURRENT_GROUP++;\n    this._GROUPS.set(name, group);\n    return group;\n  }\n\n  /**\n   * Get all collision groups currently tracked by excalibur\n   */\n  public static get groups(): CollisionGroup[] {\n    return Array.from(this._GROUPS.values());\n  }\n\n  /**\n   * Get a collision group by it's name\n   * @param name\n   */\n  public static groupByName(name: string) {\n    return this._GROUPS.get(name);\n  }\n\n  /**\n   * Resets the managers internal group management state\n   */\n  public static reset() {\n    this._GROUPS = new Map<string, CollisionGroup>();\n    this._CURRENT_BIT = this._STARTING_BIT;\n    this._CURRENT_GROUP = 1;\n  }\n}\n","import { CollisionGroupManager } from './CollisionGroupManager';\r\n\r\n/**\r\n * CollisionGroups indicate like members that do not collide with each other. Use [[CollisionGroupManager]] to create [[CollisionGroup]]s\r\n *\r\n * For example:\r\n *\r\n * Players have collision group \"player\"\r\n *\r\n * ![Player Collision Group](/assets/images/docs/CollisionGroupsPlayer.png)\r\n *\r\n * Enemies have collision group \"enemy\"\r\n *\r\n * ![Enemy Collision Group](/assets/images/docs/CollisionGroupsEnemy.png)\r\n *\r\n * Blocks have collision group \"ground\"\r\n *\r\n * ![Ground collision group](/assets/images/docs/CollisionGroupsGround.png)\r\n *\r\n * Players don't collide with each other, but enemies and blocks. Likewise, enemies don't collide with each other but collide\r\n * with players and blocks.\r\n *\r\n * This is done with bitmasking, see the following pseudo-code\r\n *\r\n * PlayerGroup = `0b001`\r\n * PlayerGroupMask = `0b110`\r\n *\r\n * EnemyGroup = `0b010`\r\n * EnemyGroupMask = `0b101`\r\n *\r\n * BlockGroup = `0b100`\r\n * BlockGroupMask = `0b011`\r\n *\r\n * Should Players collide? No because the bitwise mask evaluates to 0\r\n * `(player1.group & player2.mask) === 0`\r\n * `(0b001 & 0b110) === 0`\r\n *\r\n * Should Players and Enemies collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & enemy1.mask) === 1`\r\n * `(0b001 & 0b101) === 1`\r\n *\r\n * Should Players and Blocks collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & blocks1.mask) === 1`\r\n * `(0b001 & 0b011) === 1`\r\n */\r\nexport class CollisionGroup {\r\n  /**\r\n   * The `All` [[CollisionGroup]] is a special group that collides with all other groups including itself,\r\n   * it is the default collision group on colliders.\r\n   */\r\n  public static All = new CollisionGroup('Collide with all groups', -1, -1);\r\n\r\n  private _name: string;\r\n  private _category: number;\r\n  private _mask: number;\r\n\r\n  /**\r\n   * STOP!!** It is preferred that [[CollisionGroupManager.create]] is used to create collision groups\r\n   *  unless you know how to construct the proper bitmasks. See https://github.com/excaliburjs/Excalibur/issues/1091 for more info.\r\n   * @param name Name of the collision group\r\n   * @param category 32 bit category for the group, should be a unique power of 2. For example `0b001` or `0b010`\r\n   * @param mask 32 bit mask of category, or `~category` generally. For a category of `0b001`, the mask would be `0b110`\r\n   */\r\n  constructor(name: string, category: number, mask: number) {\r\n    this._name = name;\r\n    this._category = category;\r\n    this._mask = mask;\r\n  }\r\n\r\n  /**\r\n   * Get the name of the collision group\r\n   */\r\n  public get name() {\r\n    return this._name;\r\n  }\r\n\r\n  /**\r\n   * Get the category of the collision group, a 32 bit number which should be a unique power of 2\r\n   */\r\n  public get category() {\r\n    return this._category;\r\n  }\r\n\r\n  /**\r\n   * Get the mask for this collision group\r\n   */\r\n  public get mask() {\r\n    return this._mask;\r\n  }\r\n\r\n  /**\r\n   * Evaluates whether 2 collision groups can collide\r\n   *\r\n   * This means the mask has the same bit set the other category and vice versa\r\n   * @param other  CollisionGroup\r\n   */\r\n  public canCollide(other: CollisionGroup): boolean {\r\n    const overlap1 = this.category & other.mask;\r\n    const overlap2 = this.mask & other.category;\r\n    return (overlap1 !== 0) && (overlap2 !== 0);\r\n  }\r\n\r\n  /**\r\n   * Inverts the collision group. For example, if before the group specified \"players\",\r\n   * inverting would specify all groups except players\r\n   * @returns CollisionGroup\r\n   */\r\n  public invert(): CollisionGroup {\r\n    const group = CollisionGroupManager.create('~(' + this.name + ')', ~this.mask | 0);\r\n    group._category = ~this.category;\r\n    return group;\r\n  }\r\n\r\n  /**\r\n   * Combine collision groups with each other. The new group includes all of the previous groups.\r\n   * @param collisionGroups\r\n   */\r\n  public static combine(collisionGroups: CollisionGroup[]) {\r\n    const combinedName = collisionGroups.map((c) => c.name).join('+');\r\n    const combinedCategory = collisionGroups.reduce((current, g) => g.category | current, 0b0);\r\n    const combinedMask = ~combinedCategory;\r\n\r\n    return CollisionGroupManager.create(combinedName, combinedMask);\r\n  }\r\n\r\n  /**\r\n   * Creates a collision group that collides with the listed groups\r\n   * @param collisionGroups\r\n   */\r\n  public static collidesWith(collisionGroups: CollisionGroup[]) {\r\n    const combinedName = `collidesWith(${collisionGroups.map((c) => c.name).join('+')})`;\r\n    const combinedMask = collisionGroups.reduce((current, g) => g.category | current, 0b0);\r\n    return CollisionGroupManager.create(combinedName, combinedMask);\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\ncategory: ${this.category.toString(2).padStart(32, '0')}\r\nmask:     ${(this.mask>>>0).toString(2).padStart(32, '0')}\r\n    `;\r\n  }\r\n}\r\n","import { CollisionContact } from './CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Id } from '../../Id';\r\nimport { Collider } from '../Colliders/Collider';\r\n\r\n/**\r\n * Models a potential collision between 2 colliders\r\n */\r\nexport class Pair {\r\n  public id: string = null;\r\n  constructor(public colliderA: Collider, public colliderB: Collider) {\r\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n  }\r\n\r\n  /**\r\n   * Returns whether a it is allowed for 2 colliders in a Pair to collide\r\n   * @param colliderA\r\n   * @param colliderB\r\n   */\r\n  public static canCollide(colliderA: Collider, colliderB: Collider) {\r\n    const bodyA = colliderA?.owner?.get(BodyComponent);\r\n    const bodyB = colliderB?.owner?.get(BodyComponent);\r\n\r\n    // Prevent self collision\r\n    if (colliderA.id === colliderB.id) {\r\n      return false;\r\n    }\r\n\r\n    // Colliders with the same owner do not collide (composite colliders)\r\n    if (colliderA.owner &&\r\n        colliderB.owner &&\r\n        colliderA.owner.id === colliderB.owner.id) {\r\n      return false;\r\n    }\r\n\r\n    // if the pair has a member with zero dimension don't collide\r\n    if (colliderA.localBounds.hasZeroDimensions() || colliderB.localBounds.hasZeroDimensions()) {\r\n      return false;\r\n    }\r\n\r\n    // Body's needed for collision in the current state\r\n    // TODO can we collide without a body?\r\n    if (!bodyA || !bodyB) {\r\n      return false;\r\n    }\r\n\r\n    // If both are in the same collision group short circuit\r\n    if (!bodyA.group.canCollide(bodyB.group)) {\r\n      return false;\r\n    }\r\n\r\n    // if both are fixed short circuit\r\n    if (bodyA.collisionType === CollisionType.Fixed && bodyB.collisionType === CollisionType.Fixed) {\r\n      return false;\r\n    }\r\n\r\n    // if the either is prevent collision short circuit\r\n    if (bodyB.collisionType === CollisionType.PreventCollision || bodyA.collisionType === CollisionType.PreventCollision) {\r\n      return false;\r\n    }\r\n\r\n    // if either is dead short circuit\r\n    if (!bodyA.active || !bodyB.active) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Returns whether or not it is possible for the pairs to collide\r\n   */\r\n  public get canCollide(): boolean {\r\n    const colliderA = this.colliderA;\r\n    const colliderB = this.colliderB;\r\n    return Pair.canCollide(colliderA, colliderB);\r\n  }\r\n\r\n  /**\r\n   * Runs the collision intersection logic on the members of this pair\r\n   */\r\n  public collide(): CollisionContact[] {\r\n    return this.colliderA.collide(this.colliderB);\r\n  }\r\n\r\n  /**\r\n   * Check if the collider is part of the pair\r\n   * @param collider\r\n   */\r\n  public hasCollider(collider: Collider) {\r\n    return collider === this.colliderA || collider === this.colliderB;\r\n  }\r\n\r\n  /**\r\n   * Calculates the unique pair hash id for this collision pair (owning id)\r\n   */\r\n  public static calculatePairHash(idA: Id<'collider'>, idB: Id<'collider'>): string {\r\n    if (idA.value < idB.value) {\r\n      return `#${idA.value}+${idB.value}`;\r\n    } else {\r\n      return `#${idB.value}+${idA.value}`;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * A 1 dimensional projection on an axis, used to test overlaps\r\n */\r\n\r\nexport class Projection {\r\n  constructor(public min: number, public max: number) {}\r\n  public overlaps(projection: Projection): boolean {\r\n    return this.max > projection.min && projection.max > this.min;\r\n  }\r\n\r\n  public getOverlap(projection: Projection): number {\r\n    if (this.overlaps(projection)) {\r\n      if (this.max > projection.max) {\r\n        return projection.max - this.min;\r\n      } else {\r\n        return this.max - projection.min;\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n}\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Id } from '../../Id';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Color, ExcaliburGraphicsContext } from '../..';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\n\r\n/**\r\n * Dynamic Tree Node used for tracking bounds within the tree\r\n */\r\nexport class TreeNode<T> {\r\n  public left: TreeNode<T>;\r\n  public right: TreeNode<T>;\r\n  public bounds: BoundingBox;\r\n  public height: number;\r\n  public data: T;\r\n  constructor(public parent?: TreeNode<T>) {\r\n    this.parent = parent || null;\r\n    this.data = null;\r\n    this.bounds = new BoundingBox();\r\n    this.left = null;\r\n    this.right = null;\r\n    this.height = 0;\r\n  }\r\n\r\n  public isLeaf(): boolean {\r\n    return !this.left && !this.right;\r\n  }\r\n}\r\n\r\nexport interface ColliderProxy<T> {\r\n  id: Id<'collider'>;\r\n  owner: T;\r\n  bounds: BoundingBox;\r\n}\r\n\r\n/**\r\n * The DynamicTrees provides a spatial partitioning data structure for quickly querying for overlapping bounding boxes for\r\n * all tracked bodies. The worst case performance of this is O(n*log(n)) where n is the number of bodies in the tree.\r\n *\r\n * Internally the bounding boxes are organized as a balanced binary tree of bounding boxes, where the leaf nodes are tracked bodies.\r\n * Every non-leaf node is a bounding box that contains child bounding boxes.\r\n */\r\nexport class DynamicTree<T extends ColliderProxy<Entity>> {\r\n  public root: TreeNode<T>;\r\n  public nodes: { [key: number]: TreeNode<T> };\r\n  constructor(\r\n    private _config: Required<Pick<PhysicsConfig, 'dynamicTree'>['dynamicTree']>,\r\n    public worldBounds: BoundingBox = new BoundingBox(-Number.MAX_VALUE, -Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE)) {\r\n    this.root = null;\r\n    this.nodes = {};\r\n  }\r\n\r\n  /**\r\n   * Inserts a node into the dynamic tree\r\n   */\r\n  private _insert(leaf: TreeNode<T>): void {\r\n    // If there are no nodes in the tree, make this the root leaf\r\n    if (this.root === null) {\r\n      this.root = leaf;\r\n      this.root.parent = null;\r\n      return;\r\n    }\r\n\r\n    // Search the tree for a node that is not a leaf and find the best place to insert\r\n    const leafAABB = leaf.bounds;\r\n    let currentRoot = this.root;\r\n    while (!currentRoot.isLeaf()) {\r\n      const left = currentRoot.left;\r\n      const right = currentRoot.right;\r\n\r\n      const area = currentRoot.bounds.getPerimeter();\r\n      const combinedAABB = currentRoot.bounds.combine(leafAABB);\r\n      const combinedArea = combinedAABB.getPerimeter();\r\n\r\n      // Calculate cost heuristic for creating a new parent and leaf\r\n      const cost = 2 * combinedArea;\r\n\r\n      // Minimum cost of pushing the leaf down the tree\r\n      const inheritanceCost = 2 * (combinedArea - area);\r\n\r\n      // Cost of descending\r\n      let leftCost = 0;\r\n      const leftCombined = leafAABB.combine(left.bounds);\r\n      let newArea;\r\n      let oldArea;\r\n      if (left.isLeaf()) {\r\n        leftCost = leftCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = left.bounds.getPerimeter();\r\n        newArea = leftCombined.getPerimeter();\r\n        leftCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      let rightCost = 0;\r\n      const rightCombined = leafAABB.combine(right.bounds);\r\n      if (right.isLeaf()) {\r\n        rightCost = rightCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = right.bounds.getPerimeter();\r\n        newArea = rightCombined.getPerimeter();\r\n        rightCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      // cost is acceptable\r\n      if (cost < leftCost && cost < rightCost) {\r\n        break;\r\n      }\r\n\r\n      // Descend to the depths\r\n      if (leftCost < rightCost) {\r\n        currentRoot = left;\r\n      } else {\r\n        currentRoot = right;\r\n      }\r\n    }\r\n\r\n    // Create the new parent node and insert into the tree\r\n    const oldParent = currentRoot.parent;\r\n    const newParent = new TreeNode(oldParent);\r\n    newParent.bounds = leafAABB.combine(currentRoot.bounds);\r\n    newParent.height = currentRoot.height + 1;\r\n\r\n    if (oldParent !== null) {\r\n      // The sibling node was not the root\r\n      if (oldParent.left === currentRoot) {\r\n        oldParent.left = newParent;\r\n      } else {\r\n        oldParent.right = newParent;\r\n      }\r\n\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n    } else {\r\n      // The sibling node was the root\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n      this.root = newParent;\r\n    }\r\n\r\n    // Walk up the tree fixing heights and AABBs\r\n    let currentNode = leaf.parent;\r\n    while (currentNode) {\r\n      currentNode = this._balance(currentNode);\r\n\r\n      if (!currentNode.left) {\r\n        throw new Error('Parent of current leaf cannot have a null left child' + currentNode);\r\n      }\r\n      if (!currentNode.right) {\r\n        throw new Error('Parent of current leaf cannot have a null right child' + currentNode);\r\n      }\r\n\r\n      currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n      currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n\r\n      currentNode = currentNode.parent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a node from the dynamic tree\r\n   */\r\n  private _remove(leaf: TreeNode<T>) {\r\n    if (leaf === this.root) {\r\n      this.root = null;\r\n      return;\r\n    }\r\n\r\n    const parent = leaf.parent;\r\n    const grandParent = parent.parent;\r\n    let sibling: TreeNode<T>;\r\n    if (parent.left === leaf) {\r\n      sibling = parent.right;\r\n    } else {\r\n      sibling = parent.left;\r\n    }\r\n\r\n    if (grandParent) {\r\n      if (grandParent.left === parent) {\r\n        grandParent.left = sibling;\r\n      } else {\r\n        grandParent.right = sibling;\r\n      }\r\n      sibling.parent = grandParent;\r\n\r\n      let currentNode = grandParent;\r\n      while (currentNode) {\r\n        currentNode = this._balance(currentNode);\r\n        currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n        currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n\r\n        currentNode = currentNode.parent;\r\n      }\r\n    } else {\r\n      this.root = sibling;\r\n      sibling.parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tracks a body in the dynamic tree\r\n   */\r\n  public trackCollider(collider: T) {\r\n    const node = new TreeNode<T>();\r\n    node.data = collider;\r\n    node.bounds = collider.bounds;\r\n    node.bounds.left -= 2;\r\n    node.bounds.top -= 2;\r\n    node.bounds.right += 2;\r\n    node.bounds.bottom += 2;\r\n    this.nodes[collider.id.value] = node;\r\n    this._insert(node);\r\n  }\r\n\r\n  /**\r\n   * Updates the dynamic tree given the current bounds of each body being tracked\r\n   */\r\n  public updateCollider(collider: T) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return false;\r\n    }\r\n    const b = collider.bounds;\r\n\r\n    // if the body is outside the world no longer update it\r\n    if (!this.worldBounds.contains(b)) {\r\n      Logger.getInstance().warn(\r\n        'Collider with id ' + collider.id.value + ' is outside the world bounds and will no longer be tracked for physics'\r\n      );\r\n      this.untrackCollider(collider);\r\n      return false;\r\n    }\r\n\r\n    if (node.bounds.contains(b)) {\r\n      return false;\r\n    }\r\n\r\n    this._remove(node);\r\n    b.left -= this._config.boundsPadding;\r\n    b.top -= this._config.boundsPadding;\r\n    b.right += this._config.boundsPadding;\r\n    b.bottom += this._config.boundsPadding;\r\n\r\n    // THIS IS CAUSING UNNECESSARY CHECKS\r\n    if (collider.owner) {\r\n      const body = collider.owner?.get(BodyComponent);\r\n      if (body) {\r\n        const multdx = ((body.vel.x * 32) / 1000) * this._config.velocityMultiplier;\r\n        const multdy = ((body.vel.y * 32) / 1000) * this._config.velocityMultiplier;\r\n\r\n        if (multdx < 0) {\r\n          b.left += multdx;\r\n        } else {\r\n          b.right += multdx;\r\n        }\r\n\r\n        if (multdy < 0) {\r\n          b.top += multdy;\r\n        } else {\r\n          b.bottom += multdy;\r\n        }\r\n      }\r\n    }\r\n\r\n    node.bounds = b;\r\n    this._insert(node);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Untracks a body from the dynamic tree\r\n   */\r\n  public untrackCollider(collider: T) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return;\r\n    }\r\n    this._remove(node);\r\n    this.nodes[collider.id.value] = null;\r\n    delete this.nodes[collider.id.value];\r\n  }\r\n\r\n  /**\r\n   * Balances the tree about a node\r\n   */\r\n  private _balance(node: TreeNode<T>) {\r\n    if (node === null) {\r\n      throw new Error('Cannot balance at null node');\r\n    }\r\n\r\n    if (node.isLeaf() || node.height < 2) {\r\n      return node;\r\n    }\r\n\r\n    const left = node.left;\r\n    const right = node.right;\r\n\r\n    const a = node;\r\n    const b = left;\r\n    const c = right;\r\n    const d = left.left;\r\n    const e = left.right;\r\n    const f = right.left;\r\n    const g = right.right;\r\n\r\n    const balance = c.height - b.height;\r\n    // Rotate c node up\r\n    if (balance > 1) {\r\n      // Swap the right node with it's parent\r\n      c.left = a;\r\n      c.parent = a.parent;\r\n      a.parent = c;\r\n\r\n      // The original node's old parent should point to the right node\r\n      // this is mega confusing\r\n      if (c.parent) {\r\n        if (c.parent.left === a) {\r\n          c.parent.left = c;\r\n        } else {\r\n          c.parent.right = c;\r\n        }\r\n      } else {\r\n        this.root = c;\r\n      }\r\n\r\n      // Rotate\r\n      if (f.height > g.height) {\r\n        c.right = f;\r\n        a.right = g;\r\n        g.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(g.bounds);\r\n        c.bounds = a.bounds.combine(f.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, g.height);\r\n        c.height = 1 + Math.max(a.height, f.height);\r\n      } else {\r\n        c.right = g;\r\n        a.right = f;\r\n        f.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(f.bounds);\r\n        c.bounds = a.bounds.combine(g.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, f.height);\r\n        c.height = 1 + Math.max(a.height, g.height);\r\n      }\r\n\r\n      return c;\r\n    }\r\n    // Rotate left node up\r\n    if (balance < -1) {\r\n      // swap\r\n      b.left = a;\r\n      b.parent = a.parent;\r\n      a.parent = b;\r\n\r\n      // node's old parent should point to b\r\n      if (b.parent) {\r\n        if (b.parent.left === a) {\r\n          b.parent.left = b;\r\n        } else {\r\n          if (b.parent.right !== a) {\r\n            throw 'Error rotating Dynamic Tree';\r\n          }\r\n          b.parent.right = b;\r\n        }\r\n      } else {\r\n        this.root = b;\r\n      }\r\n\r\n      // rotate\r\n      if (d.height > e.height) {\r\n        b.right = d;\r\n        a.left = e;\r\n        e.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(e.bounds);\r\n        b.bounds = a.bounds.combine(d.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, e.height);\r\n        b.height = 1 + Math.max(a.height, d.height);\r\n      } else {\r\n        b.right = e;\r\n        a.left = d;\r\n        d.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(d.bounds);\r\n        b.bounds = a.bounds.combine(e.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, d.height);\r\n        b.height = 1 + Math.max(a.height, e.height);\r\n      }\r\n      return b;\r\n    }\r\n\r\n    return node;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal height of the tree, shorter trees are better. Performance drops as the tree grows\r\n   */\r\n  public getHeight(): number {\r\n    if (this.root === null) {\r\n      return 0;\r\n    }\r\n    return this.root.height;\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be colliding with the provided body.\r\n   *\r\n   * In the query callback, it will be passed a potential collider. Returning true from this callback indicates\r\n   * that you are complete with your query and you do not want to continue. Returning false will continue searching\r\n   * the tree until all possible colliders have been returned.\r\n   */\r\n  public query(collider: T, callback: (other: T) => boolean): void {\r\n    const bounds = collider.bounds;\r\n    const helper = (currentNode: TreeNode<T>): boolean => {\r\n      if (currentNode && currentNode.bounds.overlaps(bounds)) {\r\n        if (currentNode.isLeaf() && currentNode.data !== collider) {\r\n          if (callback.call(collider, currentNode.data)) {\r\n            return true;\r\n          }\r\n        } else {\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false;\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be intersecting. By default the raycast query uses an infinitely\r\n   * long ray to test the tree specified by `max`.\r\n   *\r\n   * In the query callback, it will be passed a potential body that intersects with the raycast. Returning true from this\r\n   * callback indicates that your are complete with your query and do not want to continue. Return false will continue searching\r\n   * the tree until all possible bodies that would intersect with the ray have been returned.\r\n   */\r\n  public rayCastQuery(ray: Ray, max: number = Infinity, callback: (other: T) => boolean): void {\r\n    const helper = (currentNode: TreeNode<T>): boolean => {\r\n      if (currentNode && currentNode.bounds.rayCast(ray, max)) {\r\n        if (currentNode.isLeaf()) {\r\n          if (callback.call(ray, currentNode.data)) {\r\n            // ray hit a leaf! return the body\r\n            return true;\r\n          }\r\n        } else {\r\n          // ray hit but not at a leaf, recurse deeper\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false; // ray missed\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  public getNodes(): TreeNode<T>[] {\r\n    const helper = (currentNode: TreeNode<T>): TreeNode<T>[] => {\r\n      if (currentNode) {\r\n        return [currentNode].concat(helper(currentNode.left), helper(currentNode.right));\r\n      } else {\r\n        return [];\r\n      }\r\n    };\r\n    return helper(this.root);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext) {\r\n    // draw all the nodes in the Dynamic Tree\r\n    const helper = (currentNode: TreeNode<T>) => {\r\n      if (currentNode) {\r\n        if (currentNode.isLeaf()) {\r\n          currentNode.bounds.draw(ex, Color.Green);\r\n        } else {\r\n          currentNode.bounds.draw(ex, Color.White);\r\n        }\r\n\r\n        if (currentNode.left) {\r\n          helper(currentNode.left);\r\n        }\r\n        if (currentNode.right) {\r\n          helper(currentNode.right);\r\n        }\r\n      }\r\n    };\r\n\r\n    helper(this.root);\r\n  }\r\n}\r\n","import { LineSegment } from './line-segment';\nimport { Vector } from './vector';\n\n/**\n * A 2D ray that can be cast into the scene to do collision detection\n */\n\nexport class Ray {\n  public pos: Vector;\n  public dir: Vector;\n\n  /**\n   * @param pos The starting position for the ray\n   * @param dir The vector indicating the direction of the ray\n   */\n  constructor(pos: Vector, dir: Vector) {\n    this.pos = pos;\n    this.dir = dir.normalize();\n  }\n\n  /**\n   * Tests a whether this ray intersects with a line segment. Returns a number greater than or equal to 0 on success.\n   * This number indicates the mathematical intersection time.\n   * @param line  The line to test\n   */\n  public intersect(line: LineSegment): number {\n    const numerator = line.begin.sub(this.pos);\n\n    // Test is line and ray are parallel and non intersecting\n    if (this.dir.cross(line.getSlope()) === 0 && numerator.cross(this.dir) !== 0) {\n      return -1;\n    }\n\n    // Lines are parallel\n    const divisor = this.dir.cross(line.getSlope());\n    if (divisor === 0) {\n      return -1;\n    }\n\n    const t = numerator.cross(line.getSlope()) / divisor;\n\n    if (t >= 0) {\n      const u = numerator.cross(this.dir) / divisor / line.getLength();\n      if (u >= 0 && u <= 1) {\n        return t;\n      }\n    }\n    return -1;\n  }\n\n  public intersectPoint(line: LineSegment): Vector {\n    const time = this.intersect(line);\n    if (time < 0) {\n      return null;\n    }\n    return this.getPoint(time);\n  }\n\n  /**\n   * Returns the point of intersection given the intersection time\n   */\n  public getPoint(time: number): Vector {\n    return this.pos.add(this.dir.scale(time));\n  }\n}\n","import { CollisionProcessor } from './CollisionProcessor';\nimport { DynamicTree } from './DynamicTree';\nimport { Pair } from './Pair';\n\nimport { Vector } from '../../Math/vector';\nimport { Ray } from '../../Math/ray';\nimport { FrameStats } from '../../Debug';\nimport { Logger } from '../../Util/Log';\nimport { CollisionType } from '../CollisionType';\nimport { Collider } from '../Colliders/Collider';\nimport { CollisionContact } from '../Detection/CollisionContact';\nimport { BodyComponent } from '../BodyComponent';\nimport { CompositeCollider } from '../Colliders/CompositeCollider';\nimport { CollisionGroup } from '../Group/CollisionGroup';\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\nimport { RayCastHit } from './RayCastHit';\nimport { DeepRequired } from '../../Util/Required';\nimport { PhysicsConfig } from '../PhysicsConfig';\n\nexport interface RayCastOptions {\n  /**\n   * Optionally specify the maximum distance in pixels to ray cast, default is Infinity\n   */\n  maxDistance?: number;\n  /**\n   * Optionally specify a collision group to target in the ray cast, default is All.\n   */\n  collisionGroup?: CollisionGroup;\n  /**\n   * Optionally specify a collision mask to target multiple collision categories\n   */\n  collisionMask?: number;\n  /**\n   * Optionally specify to search for all colliders that intersect the ray cast, not just the first which is the default\n   */\n  searchAllColliders?: boolean;\n  /**\n   * Optionally ignore things with CollisionGroup.All and only test against things with an explicit group\n   *\n   * Default false\n   */\n  ignoreCollisionGroupAll?: boolean;\n\n  /**\n   * Optionally provide a any filter function to filter on arbitrary qualities of a ray cast hit\n   *\n   * Filters run after any collision mask/collision group filtering, it is the last decision\n   *\n   * Returning true means you want to include the collider in your results, false means exclude it\n   */\n  filter?: (hit: RayCastHit) => boolean;\n}\n\n/**\n * Responsible for performing the collision broadphase (locating potential collisions) and\n * the narrowphase (actual collision contacts)\n */\nexport class DynamicTreeCollisionProcessor implements CollisionProcessor {\n  private _dynamicCollisionTree: DynamicTree<Collider>;\n  private _pairs = new Set<string>();\n\n  private _collisionPairCache: Pair[] = [];\n  private _colliders: Collider[] = [];\n\n  constructor(private _config: DeepRequired<PhysicsConfig>) {\n    this._dynamicCollisionTree = new DynamicTree<Collider>(_config.dynamicTree);\n  }\n\n  public getColliders(): readonly Collider[] {\n    return this._colliders;\n  }\n\n  public rayCast(ray: Ray, options?: RayCastOptions): RayCastHit[] {\n    const results: RayCastHit[] = [];\n    const maxDistance = options?.maxDistance ?? Infinity;\n    const collisionGroup = options?.collisionGroup;\n    const collisionMask = !collisionGroup ? options?.collisionMask ?? CollisionGroup.All.category : collisionGroup.category;\n    const searchAllColliders = options?.searchAllColliders ?? false;\n    this._dynamicCollisionTree.rayCastQuery(ray, maxDistance, (collider) => {\n      const owner = collider.owner;\n      const maybeBody = owner.get(BodyComponent);\n\n      if (options?.ignoreCollisionGroupAll && maybeBody.group === CollisionGroup.All) {\n        return false;\n      }\n\n      const canCollide = (collisionMask & maybeBody.group.category) !== 0;\n\n      // Early exit if not the right group\n      if (maybeBody?.group && !canCollide) {\n        return false;\n      }\n\n      const hit = collider.rayCast(ray, maxDistance);\n\n      if (hit) {\n        if (options?.filter) {\n          if (options.filter(hit)) {\n            results.push(hit);\n            if (!searchAllColliders) {\n              // returning true exits the search\n              return true;\n            }\n          }\n        } else {\n          results.push(hit);\n          if (!searchAllColliders) {\n            // returning true exits the search\n            return true;\n          }\n        }\n      }\n      return false;\n    });\n    return results;\n  }\n\n  /**\n   * Tracks a physics body for collisions\n   */\n  public track(target: Collider): void {\n    if (!target) {\n      Logger.getInstance().warn('Cannot track null collider');\n      return;\n    }\n    if (target instanceof CompositeCollider) {\n      const colliders = target.getColliders();\n      for (const c of colliders) {\n        c.owner = target.owner;\n        this._colliders.push(c);\n        this._dynamicCollisionTree.trackCollider(c);\n      }\n    } else {\n      this._colliders.push(target);\n      this._dynamicCollisionTree.trackCollider(target);\n    }\n  }\n\n  /**\n   * Untracks a physics body\n   */\n  public untrack(target: Collider): void {\n    if (!target) {\n      Logger.getInstance().warn('Cannot untrack a null collider');\n      return;\n    }\n\n    if (target instanceof CompositeCollider) {\n      const colliders = target.getColliders();\n      for (const c of colliders) {\n        const index = this._colliders.indexOf(c);\n        if (index !== -1) {\n          this._colliders.splice(index, 1);\n        }\n        this._dynamicCollisionTree.untrackCollider(c);\n      }\n    } else {\n      const index = this._colliders.indexOf(target);\n      if (index !== -1) {\n        this._colliders.splice(index, 1);\n      }\n      this._dynamicCollisionTree.untrackCollider(target);\n    }\n  }\n\n  private _pairExists(colliderA: Collider, colliderB: Collider) {\n    // if the collision pair has been calculated already short circuit\n    const hash = Pair.calculatePairHash(colliderA.id, colliderB.id);\n    return this._pairs.has(hash);\n  }\n\n  /**\n   * Detects potential collision pairs in a broadphase approach with the dynamic AABB tree strategy\n   */\n  public broadphase(targets: Collider[], delta: number, stats?: FrameStats): Pair[] {\n    const seconds = delta / 1000;\n\n    // Retrieve the list of potential colliders, exclude killed, prevented, and self\n    const potentialColliders = targets.filter((other) => {\n      const body = other.owner?.get(BodyComponent);\n      return other.owner?.active && body.collisionType !== CollisionType.PreventCollision;\n    });\n\n    // clear old list of collision pairs\n    this._collisionPairCache = [];\n    this._pairs.clear();\n\n    // check for normal collision pairs\n    let collider: Collider;\n    for (let j = 0, l = potentialColliders.length; j < l; j++) {\n      collider = potentialColliders[j];\n      // Query the collision tree for potential colliders\n      this._dynamicCollisionTree.query(collider, (other: Collider) => {\n        if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\n          const pair = new Pair(collider, other);\n          this._pairs.add(pair.id);\n          this._collisionPairCache.push(pair);\n        }\n        // Always return false, to query whole tree. Returning true in the query method stops searching\n        return false;\n      });\n    }\n    if (stats) {\n      stats.physics.pairs = this._collisionPairCache.length;\n    }\n\n    // Check dynamic tree for fast moving objects\n    // Fast moving objects are those moving at least there smallest bound per frame\n    if (this._config.continuous.checkForFastBodies) {\n      for (const collider of potentialColliders) {\n        const body = collider.owner.get(BodyComponent);\n        // Skip non-active objects. Does not make sense on other collision types\n        if (body.collisionType !== CollisionType.Active) {\n          continue;\n        }\n\n        // Maximum travel distance next frame\n        const updateDistance =\n          body.vel.size * seconds + // velocity term\n          body.acc.size * 0.5 * seconds * seconds; // acc term\n\n        // Find the minimum dimension\n        const minDimension = Math.min(collider.bounds.height, collider.bounds.width);\n        if (this._config.continuous.disableMinimumSpeedForFastBody || updateDistance > minDimension / 2) {\n          if (stats) {\n            stats.physics.fastBodies++;\n          }\n\n          // start with the oldPos because the integration for actors has already happened\n          // objects resting on a surface may be slightly penetrating in the current position\n          const updateVec = body.globalPos.sub(body.oldPos);\n          const centerPoint = collider.center;\n          const furthestPoint = collider.getFurthestPoint(body.vel);\n          const origin: Vector = furthestPoint.sub(updateVec);\n\n          const ray: Ray = new Ray(origin, body.vel);\n\n          // back the ray up by -2x surfaceEpsilon to account for fast moving objects starting on the surface\n          ray.pos = ray.pos.add(ray.dir.scale(-2 * this._config.continuous.surfaceEpsilon));\n          let minCollider: Collider;\n          let minTranslate: Vector = new Vector(Infinity, Infinity);\n          this._dynamicCollisionTree.rayCastQuery(ray, updateDistance + this._config.continuous.surfaceEpsilon * 2, (other: Collider) => {\n            if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\n              const hit = other.rayCast(ray, updateDistance + this._config.continuous.surfaceEpsilon * 10);\n              if (hit) {\n                const translate = hit.point.sub(origin);\n                if (translate.size < minTranslate.size) {\n                  minTranslate = translate;\n                  minCollider = other;\n                }\n              }\n            }\n            return false;\n          });\n\n          if (minCollider && Vector.isValid(minTranslate)) {\n            const pair = new Pair(collider, minCollider);\n            if (!this._pairs.has(pair.id)) {\n              this._pairs.add(pair.id);\n              this._collisionPairCache.push(pair);\n            }\n            // move the fast moving object to the other body\n            // need to push into the surface by ex.Physics.surfaceEpsilon\n            const shift = centerPoint.sub(furthestPoint);\n            body.globalPos = origin\n              .add(shift)\n              .add(minTranslate)\n              .add(ray.dir.scale(10 * this._config.continuous.surfaceEpsilon)); // needed to push the shape slightly into contact\n            collider.update(body.transform.get());\n\n            if (stats) {\n              stats.physics.fastBodyCollisions++;\n            }\n          }\n        }\n      }\n    }\n    // return cache\n    return this._collisionPairCache;\n  }\n\n  /**\n   * Applies narrow phase on collision pairs to find actual area intersections\n   * Adds actual colliding pairs to stats' Frame data\n   */\n  public narrowphase(pairs: Pair[], stats?: FrameStats): CollisionContact[] {\n    let contacts: CollisionContact[] = [];\n    for (let i = 0; i < pairs.length; i++) {\n      const newContacts = pairs[i].collide();\n      contacts = contacts.concat(newContacts);\n      if (stats && newContacts.length > 0) {\n        for (const c of newContacts) {\n          stats.physics.contacts.set(c.id, c);\n        }\n      }\n    }\n    if (stats) {\n      stats.physics.collisions += contacts.length;\n    }\n    return contacts;\n  }\n\n  /**\n   * Update the dynamic tree positions\n   */\n  public update(targets: Collider[]): number {\n    let updated = 0;\n    const len = targets.length;\n\n    for (let i = 0; i < len; i++) {\n      if (this._dynamicCollisionTree.updateCollider(targets[i])) {\n        updated++;\n      }\n    }\n    return updated;\n  }\n\n  public debug(ex: ExcaliburGraphicsContext) {\n    this._dynamicCollisionTree.debug(ex);\n  }\n}\n","import { Color } from '../../Color';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Clonable } from '../../Interfaces/Clonable';\r\nimport { Entity } from '../../EntityComponentSystem';\r\nimport { createId, Id } from '../../Id';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { EventEmitter } from '../../EventEmitter';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\nimport { CompositeCollider } from './CompositeCollider';\r\n\r\n/**\r\n * A collision collider specifies the geometry that can detect when other collision colliders intersect\r\n * for the purposes of colliding 2 objects in excalibur.\r\n */\r\nexport abstract class Collider implements Clonable<Collider> {\r\n  private static _ID = 0;\r\n  public readonly id: Id<'collider'> = createId('collider', Collider._ID++);\r\n  /**\r\n   * Composite collider if any this collider is attached to\r\n   *\r\n   * **WARNING** do not tamper with this property\r\n   */\r\n  public composite: CompositeCollider | null = null;\r\n  public events = new EventEmitter();\r\n\r\n  /**\r\n   * Returns a boolean indicating whether this body collided with\r\n   * or was in stationary contact with\r\n   * the body of the other [[Collider]]\r\n   */\r\n  public touching(other: Collider): boolean {\r\n    const contact = this.collide(other);\r\n\r\n    if (contact) {\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public owner: Entity;\r\n\r\n  /**\r\n   * Pixel offset of the collision collider relative to the collider, by default (0, 0) meaning the collider is positioned\r\n   * on top of the collider.\r\n   */\r\n  offset: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Position of the collision collider in world coordinates\r\n   */\r\n  abstract get worldPos(): Vector;\r\n\r\n  /**\r\n   * The center point of the collision collider, for example if the collider is a circle it would be the center.\r\n   */\r\n  abstract get center(): Vector;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in world coordinates\r\n   */\r\n  abstract get bounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in local coordinates\r\n   */\r\n  abstract get localBounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axes of this particular collider\r\n   */\r\n  abstract get axes(): Vector[];\r\n  /**\r\n   * Find the furthest point on the convex hull of this particular collider in a certain direction.\r\n   */\r\n  abstract getFurthestPoint(direction: Vector): Vector;\r\n\r\n  abstract getInertia(mass: number): number;\r\n\r\n  // All new CollisionShape need to do the following\r\n  // Create a new collision function in the CollisionJumpTable against all the primitives\r\n  // Currently there are 3 primitive collision collider 3! = 6 jump functions\r\n  abstract collide(collider: Collider): CollisionContact[];\r\n\r\n  /**\r\n   * Returns the closest line between the surfaces this collider and another\r\n   * @param collider\r\n   */\r\n  abstract getClosestLineBetween(collider: Collider): LineSegment;\r\n\r\n  /**\r\n   * Return wether the collider contains a point inclusive to it's border\r\n   */\r\n  abstract contains(point: Vector): boolean;\r\n\r\n  /**\r\n   * Return the point on the border of the collision collider that intersects with a ray (if any).\r\n   */\r\n  abstract rayCast(ray: Ray, max?: number): RayCastHit | null;\r\n\r\n  /**\r\n   * Create a projection of this collider along an axis. Think of this as casting a \"shadow\" along an axis\r\n   */\r\n  abstract project(axis: Vector): Projection;\r\n\r\n  /**\r\n   * Updates collider world space geometry\r\n   */\r\n  abstract update(transform: Transform): void;\r\n\r\n\r\n  abstract debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number, pointSize: number }): void;\r\n\r\n  abstract clone(): Collider;\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { DeepRequired } from '../Util/Required';\r\nimport { SolverStrategy } from './SolverStrategy';\r\nimport { Physics } from './Physics';\r\nimport { ContactSolveBias } from './Solver/ContactBias';\r\n\r\n\r\nexport interface PhysicsConfig {\r\n  /**\r\n   * Excalibur physics simulation is enabled\r\n   */\r\n  enabled?: boolean;\r\n  /**\r\n   * Configure gravity that applies to all [[CollisionType.Active]] bodies.\r\n   *\r\n   * This is acceleration in pixels/sec^2\r\n   *\r\n   * Default vec(0, 0)\r\n   *\r\n   * [[BodyComponent.useGravity]] to opt out\r\n   */\r\n  gravity?: Vector;\r\n  /**\r\n   * Configure the type of physics simulation you would like\r\n   *\r\n   * * [[SolverStrategy.Arcade]] is suitable for games where you might be doing platforming or top down movement.\r\n   * * [[SolverStrategy.Realistic]] is where you need objects to bounce off each other and respond like real world objects.\r\n   *\r\n   * Default is Arcade\r\n   */\r\n  solver?: SolverStrategy;\r\n\r\n  /**\r\n   * Configure colliders\r\n   */\r\n  colliders?: {\r\n    /**\r\n     * Treat composite collider's member colliders as either separate colliders for the purposes of onCollisionStart/onCollision\r\n     * or as a single collider together.\r\n     *\r\n     * This property can be overridden on individual [[CompositeColliders]].\r\n     *\r\n     * For composites without gaps or small groups of colliders, you probably want 'together'\r\n     *\r\n     * For composites with deliberate gaps, like a platforming level layout, you probably want 'separate'\r\n     *\r\n     * Default is 'together' if unset\r\n     */\r\n    compositeStrategy?: 'separate' | 'together'\r\n  }\r\n\r\n  /**\r\n   * Configure excalibur continuous collision (WIP)\r\n   */\r\n  continuous?: {\r\n\r\n    /**\r\n     * Enable fast moving body checking, this enables checking for collision pairs via raycast for fast moving objects to prevent\r\n     * bodies from tunneling through one another.\r\n     *\r\n     * Default true\r\n     */\r\n    checkForFastBodies?: boolean;\r\n\r\n    /**\r\n     * Disable minimum fast moving body raycast, by default if checkForFastBodies = true Excalibur will only check if the\r\n     * body is moving at least half of its minimum dimension in an update. If disableMinimumSpeedForFastBody is set to true,\r\n     * Excalibur will always perform the fast body raycast regardless of speed.\r\n     *\r\n     * Default false\r\n     */\r\n    disableMinimumSpeedForFastBody?: boolean;\r\n\r\n    /**\r\n     * Surface epsilon is used to help deal with predicting collisions by applying a slop\r\n     *\r\n     * Default 0.1\r\n     */\r\n    surfaceEpsilon?: number;\r\n  }\r\n\r\n  /**\r\n   * Configure body defaults\r\n   */\r\n  bodies?: {\r\n    /**\r\n     * Configure default mass that bodies have\r\n     *\r\n     * Default 10 mass units\r\n     */\r\n    defaultMass?: number;\r\n\r\n    /**\r\n     * Sleep epsilon\r\n     *\r\n     * Default 0.07\r\n     */\r\n    sleepEpsilon?: number;\r\n\r\n    /**\r\n     * Wake Threshold, the amount of \"motion\" need to wake a body from sleep\r\n     *\r\n     * Default 0.07 * 3;\r\n     */\r\n    wakeThreshold?: number;\r\n\r\n    /**\r\n     * Sleep bias\r\n     *\r\n     * Default 0.9\r\n     */\r\n    sleepBias?: number;\r\n\r\n    /**\r\n     * By default bodies do not sleep, this can be turned on to improve perf if you have a lot of bodies.\r\n     *\r\n     * Default false\r\n     */\r\n    canSleepByDefault?: boolean;\r\n  }\r\n\r\n  /**\r\n   * Configure the dynamic tree spatial data structure for locating pairs and raycasts\r\n   */\r\n  dynamicTree?: {\r\n    /**\r\n     * Pad collider BoundingBox by a constant amount for purposes of potential pairs\r\n     *\r\n     * Default 5 pixels\r\n     */\r\n    boundsPadding?: number;\r\n\r\n    /**\r\n     * Factor to add to the collider BoundingBox, bounding box (dimensions += vel * dynamicTreeVelocityMultiplier);\r\n     *\r\n     * Default 2\r\n     */\r\n    velocityMultiplier?: number;\r\n  }\r\n\r\n  /**\r\n   * Configure the [[ArcadeSolver]]\r\n   */\r\n  arcade?: {\r\n    /**\r\n     * Hints the [[ArcadeSolver]] to preferentially solve certain contact directions first.\r\n     *\r\n     * Options:\r\n     * * Solve [[ContactSolveBias.VerticalFirst]] which will do vertical contact resolution first (useful for platformers\r\n     * with up/down gravity)\r\n     * * Solve [[ContactSolveBias.HorizontalFirst]] which will do horizontal contact resolution first (useful for games with\r\n     * left/right forces)\r\n     * * By default [[ContactSolveBias.None]] which sorts by distance\r\n     */\r\n    contactSolveBias?: ContactSolveBias;\r\n  }\r\n\r\n  /**\r\n   * Configure the [[RealisticSolver]]\r\n   */\r\n  realistic?: {\r\n    /**\r\n     * Number of position iterations (overlap) to run in the solver\r\n     *\r\n     * Default 3 iterations\r\n     */\r\n    positionIterations?: number;\r\n\r\n    /**\r\n     * Number of velocity iteration (response) to run in the solver\r\n     *\r\n     * Default 8 iterations\r\n     */\r\n    velocityIterations?: number;\r\n\r\n    /**\r\n     * Amount of overlap to tolerate in pixels\r\n     *\r\n     * Default 1 pixel\r\n     */\r\n    slop?: number;\r\n\r\n    /**\r\n     * Amount of positional overlap correction to apply each position iteration of the solver\r\n     * 0 - meaning no correction, 1 - meaning correct all overlap. Generally values 0 < .5 look nice.\r\n     *\r\n     * Default 0.2\r\n     */\r\n    steeringFactor?: number;\r\n\r\n    /**\r\n     * Warm start set to true re-uses impulses from previous frames back in the solver. Re-using impulses helps\r\n     * the solver converge quicker\r\n     *\r\n     * Default true\r\n     */\r\n    warmStart?: boolean;\r\n  }\r\n}\r\n\r\nexport const DefaultPhysicsConfig: DeepRequired<PhysicsConfig> = {\r\n  enabled: true,\r\n  gravity: vec(0, 0),\r\n  solver: SolverStrategy.Arcade,\r\n  colliders: {\r\n    compositeStrategy: 'together'\r\n  },\r\n  continuous: {\r\n    checkForFastBodies: true,\r\n    disableMinimumSpeedForFastBody: false,\r\n    surfaceEpsilon: 0.1\r\n  },\r\n  bodies: {\r\n    canSleepByDefault: false,\r\n    sleepEpsilon: 0.07,\r\n    wakeThreshold: 0.07 * 3,\r\n    sleepBias: 0.9,\r\n    defaultMass: 10\r\n  },\r\n  dynamicTree: {\r\n    boundsPadding: 5,\r\n    velocityMultiplier: 2\r\n  },\r\n  arcade: {\r\n    contactSolveBias: ContactSolveBias.None\r\n  },\r\n  realistic: {\r\n    positionIterations: 3,\r\n    velocityIterations: 8,\r\n    slop: 1,\r\n    steeringFactor: 0.2,\r\n    warmStart: true\r\n  }\r\n};\r\n\r\n/**\r\n * @deprecated will be removed in v0.30\r\n */\r\nexport function DeprecatedStaticToConfig(): DeepRequired<PhysicsConfig> {\r\n  return {\r\n    enabled: Physics.enabled,\r\n    gravity: Physics.gravity,\r\n    solver: Physics.collisionResolutionStrategy,\r\n    continuous: {\r\n      checkForFastBodies: Physics.checkForFastBodies,\r\n      disableMinimumSpeedForFastBody: Physics.disableMinimumSpeedForFastBody,\r\n      surfaceEpsilon: Physics.surfaceEpsilon\r\n    },\r\n    colliders: {\r\n      compositeStrategy: 'together'\r\n    },\r\n    bodies: {\r\n      canSleepByDefault: Physics.bodiesCanSleepByDefault,\r\n      sleepEpsilon: Physics.sleepEpsilon,\r\n      wakeThreshold: Physics.wakeThreshold,\r\n      sleepBias: Physics.sleepBias,\r\n      defaultMass: Physics.defaultMass\r\n    },\r\n    dynamicTree: {\r\n      boundsPadding: Physics.boundsPadding,\r\n      velocityMultiplier: Physics.dynamicTreeVelocityMultiplier\r\n    },\r\n    arcade: {\r\n      contactSolveBias: ContactSolveBias.None\r\n    },\r\n    realistic: {\r\n      positionIterations: Physics.positionIterations,\r\n      velocityIterations: Physics.velocityIterations,\r\n      slop: Physics.slop,\r\n      steeringFactor: Physics.steeringFactor,\r\n      warmStart: Physics.warmStart\r\n    }\r\n  };\r\n}","import { Util } from '../..';\r\nimport { Pair } from '../Detection/Pair';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Projection } from '../../Math/projection';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Vector } from '../../Math/vector';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { DynamicTree } from '../Detection/DynamicTree';\r\nimport { DynamicTreeCollisionProcessor } from '../Detection/DynamicTreeCollisionProcessor';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\nimport { Collider } from './Collider';\r\nimport { Transform } from '../../Math/transform';\r\nimport { DefaultPhysicsConfig } from '../PhysicsConfig';\r\n\r\nexport class CompositeCollider extends Collider {\r\n  private _transform: Transform;\r\n  private _collisionProcessor = new DynamicTreeCollisionProcessor(DefaultPhysicsConfig);\r\n  private _dynamicAABBTree = new DynamicTree(DefaultPhysicsConfig.dynamicTree);\r\n  private _colliders: Collider[] = [];\r\n\r\n  private _compositeStrategy?: 'separate' | 'together';\r\n  /**\r\n   * Treat composite collider's member colliders as either separate colliders for the purposes of onCollisionStart/onCollision\r\n   * or as a single collider together.\r\n   *\r\n   * This property can be overridden on individual [[CompositeColliders]].\r\n   *\r\n   * For composites without gaps or small groups of colliders, you probably want 'together'\r\n   *\r\n   * For composites with deliberate gaps, like a platforming level layout, you probably want 'separate'\r\n   *\r\n   * Default is 'together' if unset\r\n   */\r\n  public set compositeStrategy(value: 'separate' | 'together') {\r\n    this._compositeStrategy = value;\r\n  }\r\n  public get compositeStrategy() {\r\n    return this._compositeStrategy;\r\n  }\r\n\r\n  constructor(colliders: Collider[]) {\r\n    super();\r\n    for (const c of colliders) {\r\n      this.addCollider(c);\r\n    }\r\n  }\r\n\r\n  clearColliders() {\r\n    this._colliders = [];\r\n  }\r\n\r\n  addCollider(collider: Collider) {\r\n    let colliders: Collider[];\r\n    if (collider instanceof CompositeCollider) {\r\n      colliders = collider.getColliders();\r\n      colliders.forEach(c => c.offset.addEqual(collider.offset));\r\n    } else {\r\n      colliders = [collider];\r\n    }\r\n    // Flatten composites\r\n    for (const c of colliders) {\r\n      c.events.pipe(this.events);\r\n      c.composite = this;\r\n      this._colliders.push(c);\r\n      this._collisionProcessor.track(c);\r\n      this._dynamicAABBTree.trackCollider(c);\r\n    }\r\n  }\r\n\r\n  removeCollider(collider: Collider) {\r\n    collider.events.pipe(this.events);\r\n    collider.composite = null;\r\n    Util.removeItemFromArray(collider, this._colliders);\r\n    this._collisionProcessor.untrack(collider);\r\n    this._dynamicAABBTree.untrackCollider(collider);\r\n  }\r\n\r\n  getColliders(): Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    return (this._transform?.pos ?? Vector.Zero).add(this.offset);\r\n  }\r\n\r\n  get center(): Vector {\r\n    return (this._transform?.pos ?? Vector.Zero).add(this.offset);\r\n  }\r\n\r\n  get bounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce(\r\n      (acc, collider) => acc.combine(collider.bounds),\r\n      colliders[0]?.bounds ?? new BoundingBox().translate(this.worldPos)\r\n    );\r\n\r\n    return results.translate(this.offset);\r\n  }\r\n\r\n  get localBounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce((acc, collider) => acc.combine(collider.localBounds), colliders[0]?.localBounds ?? new BoundingBox());\r\n\r\n    return results;\r\n  }\r\n\r\n  get axes(): Vector[] {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    let axes: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      axes = axes.concat(collider.axes);\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  getFurthestPoint(direction: Vector): Vector {\r\n    const colliders = this.getColliders();\r\n    const furthestPoints: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      furthestPoints.push(collider.getFurthestPoint(direction));\r\n    }\r\n    // Pick best point from all colliders\r\n    let bestPoint = furthestPoints[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (const point of furthestPoints) {\r\n      const distance = point.dot(direction);\r\n      if (distance > maxDistance) {\r\n        bestPoint = point;\r\n        maxDistance = distance;\r\n      }\r\n    }\r\n    return bestPoint;\r\n  }\r\n\r\n  getInertia(mass: number): number {\r\n    const colliders = this.getColliders();\r\n    let totalInertia = 0;\r\n    for (const collider of colliders) {\r\n      totalInertia += collider.getInertia(mass);\r\n    }\r\n    return totalInertia;\r\n  }\r\n\r\n  collide(other: Collider): CollisionContact[] {\r\n    let otherColliders = [other];\r\n    if (other instanceof CompositeCollider) {\r\n      otherColliders = other.getColliders();\r\n    }\r\n\r\n    const pairs: Pair[] = [];\r\n    for (const c of otherColliders) {\r\n      this._dynamicAABBTree.query(c, (potentialCollider: Collider) => {\r\n        pairs.push(new Pair(c, potentialCollider));\r\n        return false;\r\n      });\r\n    }\r\n\r\n    let contacts: CollisionContact[] = [];\r\n    for (const p of pairs) {\r\n      contacts = contacts.concat(p.collide());\r\n    }\r\n    return contacts;\r\n  }\r\n\r\n  getClosestLineBetween(other: Collider): LineSegment {\r\n    const colliders = this.getColliders();\r\n    const lines: LineSegment[] = [];\r\n    if (other instanceof CompositeCollider) {\r\n      const otherColliders = other.getColliders();\r\n      for (const colliderA of colliders) {\r\n        for (const colliderB of otherColliders) {\r\n          const maybeLine = colliderA.getClosestLineBetween(colliderB);\r\n          if (maybeLine) {\r\n            lines.push(maybeLine);\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      for (const collider of colliders) {\r\n        const maybeLine = other.getClosestLineBetween(collider);\r\n        if (maybeLine) {\r\n          lines.push(maybeLine);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (lines.length) {\r\n      let minLength = lines[0].getLength();\r\n      let minLine = lines[0];\r\n      for (const line of lines) {\r\n        const length = line.getLength();\r\n        if (length < minLength) {\r\n          minLength = length;\r\n          minLine = line;\r\n        }\r\n      }\r\n      return minLine;\r\n    }\r\n    return null;\r\n  }\r\n  contains(point: Vector): boolean {\r\n    const colliders = this.getColliders();\r\n    for (const collider of colliders) {\r\n      if (collider.contains(point)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n  rayCast(ray: Ray, max?: number): RayCastHit | null {\r\n    const colliders = this.getColliders();\r\n    const hits: RayCastHit[] = [];\r\n    for (const collider of colliders) {\r\n      const hit = collider.rayCast(ray, max);\r\n      if (hit) {\r\n        hits.push(hit);\r\n      }\r\n    }\r\n    if (hits.length) {\r\n      let minHit = hits[0];\r\n      let minDistance = minHit.point.dot(ray.dir);\r\n      for (const hit of hits) {\r\n        const distance = ray.dir.dot(hit.point);\r\n        if (distance < minDistance) {\r\n          minHit = hit;\r\n          minDistance = distance;\r\n        }\r\n      }\r\n      return minHit;\r\n    }\r\n    return null;\r\n  }\r\n  project(axis: Vector): Projection {\r\n    const colliders = this.getColliders();\r\n    const projections: Projection[] = [];\r\n    for (const collider of colliders) {\r\n      const proj = collider.project(axis);\r\n      if (proj) {\r\n        projections.push(proj);\r\n      }\r\n    }\r\n    // Merge all proj's on the same axis\r\n    if (projections.length) {\r\n      const newProjection = new Projection(projections[0].min, projections[0].max);\r\n      for (const proj of projections) {\r\n        newProjection.min = Math.min(proj.min, newProjection.min);\r\n        newProjection.max = Math.max(proj.max, newProjection.max);\r\n      }\r\n      return newProjection;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  update(transform: Transform): void {\r\n    if (transform) {\r\n      const colliders = this.getColliders();\r\n      for (const collider of colliders) {\r\n        collider.owner = this.owner;\r\n        collider.update(transform);\r\n      }\r\n    }\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color,  options?: { lineWidth: number, pointSize: number }) {\r\n    const colliders = this.getColliders();\r\n    ex.save();\r\n    ex.translate(this.offset.x, this.offset.y);\r\n    for (const collider of colliders) {\r\n      collider.debug(ex, color, options);\r\n    }\r\n    ex.restore();\r\n  }\r\n\r\n  clone(): Collider {\r\n    const result = new CompositeCollider(this._colliders.map((c) => c.clone()));\r\n    result.offset = this.offset.clone();\r\n    return result;\r\n  }\r\n}\r\n","import { Vector } from './vector';\r\n\r\n/**\r\n * A 2D line segment\r\n */\r\n\r\nexport class LineSegment {\r\n\r\n  /**\r\n   * @param begin  The starting point of the line segment\r\n   * @param end  The ending point of the line segment\r\n   */\r\n  constructor(public readonly begin: Vector, public readonly end: Vector) {}\r\n\r\n  /**\r\n   * Gets the raw slope (m) of the line. Will return (+/-)Infinity for vertical lines.\r\n   */\r\n  public get slope() {\r\n    return (this.end.y - this.begin.y) / (this.end.x - this.begin.x);\r\n  }\r\n\r\n  /**\r\n   * Gets the Y-intercept (b) of the line. Will return (+/-)Infinity if there is no intercept.\r\n   */\r\n  public get intercept() {\r\n    return this.begin.y - this.slope * this.begin.x;\r\n  }\r\n\r\n  private _normal: Vector;\r\n  /**\r\n   * Gets the normal of the line\r\n   */\r\n  public normal(): Vector {\r\n    if (this._normal) {\r\n      return this._normal;\r\n    }\r\n    return this._normal = this.end.sub(this.begin).normal();\r\n  }\r\n\r\n  private _dir: Vector;\r\n  public dir(): Vector {\r\n    if (this._dir) {\r\n      return this._dir;\r\n    }\r\n    return this._dir = this.end.sub(this.begin);\r\n  }\r\n\r\n  public getPoints(): Vector[] {\r\n    return [this.begin, this.end];\r\n  }\r\n\r\n  private _slope: Vector;\r\n  /**\r\n   * Returns the slope of the line in the form of a vector of length 1\r\n   */\r\n  public getSlope(): Vector {\r\n    if (this._slope) {\r\n      return this._slope;\r\n    }\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return this._slope = end.sub(begin).scale(1 / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the edge of the line as vector, the length of the vector is the length of the edge\r\n   */\r\n  public getEdge(): Vector {\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    return end.sub(begin);\r\n  }\r\n\r\n  private _length: number;\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    if (this._length) {\r\n      return this._length;\r\n    }\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return this._length = distance;\r\n  }\r\n\r\n  /**\r\n   * Returns the midpoint of the edge\r\n   */\r\n  public get midpoint(): Vector {\r\n    return this.begin.add(this.end).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Flips the direction of the line segment\r\n   */\r\n  public flip(): LineSegment {\r\n    return new LineSegment(this.end, this.begin);\r\n  }\r\n\r\n  /**\r\n   * Tests if a given point is below the line, points in the normal direction above the line are considered above.\r\n   * @param point\r\n   */\r\n  public below(point: Vector): boolean {\r\n    const above2 = (this.end.x - this.begin.x) * (point.y - this.begin.y) - (this.end.y - this.begin.y) * (point.x - this.begin.x);\r\n    return above2 >= 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the clip point\r\n   * @param sideVector Vector that traces the line\r\n   * @param length Length to clip along side\r\n   */\r\n  public clip(sideVector: Vector, length: number): LineSegment {\r\n    let dir = sideVector;\r\n    dir = dir.normalize();\r\n\r\n    const near = dir.dot(this.begin) - length;\r\n    const far = dir.dot(this.end) - length;\r\n\r\n    const results = [];\r\n    if (near <= 0) {\r\n      results.push(this.begin);\r\n    }\r\n    if (far <= 0) {\r\n      results.push(this.end);\r\n    }\r\n\r\n    if (near * far < 0) {\r\n      const clipTime = near / (near - far);\r\n      results.push(this.begin.add(this.end.sub(this.begin).scale(clipTime)));\r\n    }\r\n    if (results.length !== 2) {\r\n      return null;\r\n    }\r\n\r\n    return new LineSegment(results[0], results[1]);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular distance from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * @param point\r\n   */\r\n  public distanceToPoint(point: Vector, signed: boolean = false) {\r\n    const x0 = point.x;\r\n    const y0 = point.y;\r\n\r\n    const l = this.getLength();\r\n\r\n    const dy = this.end.y - this.begin.y;\r\n    const dx = this.end.x - this.begin.x;\r\n    const distance = (dy * x0 - dx * y0 + this.end.x * this.begin.y - this.end.y * this.begin.x) / l;\r\n    return signed ? distance : Math.abs(distance);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular line from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * (a - p) - ((a - p) * n)n\r\n   * a is a point on the line\r\n   * p is the arbitrary point above the line\r\n   * n is a unit vector in direction of the line\r\n   * @param point\r\n   */\r\n  public findVectorToPoint(point: Vector): Vector {\r\n    const aMinusP = this.begin.sub(point);\r\n    const n = this.getSlope();\r\n\r\n    return aMinusP.sub(n.scale(aMinusP.dot(n)));\r\n  }\r\n\r\n  /**\r\n   * Finds a point on the line given only an X or a Y value. Given an X value, the function returns\r\n   * a new point with the calculated Y value and vice-versa.\r\n   * @param x The known X value of the target point\r\n   * @param y The known Y value of the target point\r\n   * @returns A new point with the other calculated axis value\r\n   */\r\n  public findPoint(x: number = null, y: number = null): Vector {\r\n    const m = this.slope;\r\n    const b = this.intercept;\r\n\r\n    if (x !== null) {\r\n      return new Vector(x, m * x + b);\r\n    } else if (y !== null) {\r\n      return new Vector((y - b) / m, y);\r\n    } else {\r\n      throw new Error('You must provide an X or a Y value');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(x: number, y: number, threshold?: number): boolean;\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(v: Vector, threshold?: number): boolean;\r\n\r\n  /**\r\n   * @see http://stackoverflow.com/a/11908158/109458\r\n   */\r\n  public hasPoint(): boolean {\r\n    let currPoint: Vector;\r\n    let threshold = 0;\r\n\r\n    if (typeof arguments[0] === 'number' && typeof arguments[1] === 'number') {\r\n      currPoint = new Vector(arguments[0], arguments[1]);\r\n      threshold = arguments[2] || 0;\r\n    } else if (arguments[0] instanceof Vector) {\r\n      currPoint = arguments[0];\r\n      threshold = arguments[1] || 0;\r\n    } else {\r\n      throw 'Could not determine the arguments for Vector.hasPoint';\r\n    }\r\n\r\n    const dxc = currPoint.x - this.begin.x;\r\n    const dyc = currPoint.y - this.begin.y;\r\n\r\n    const dx1 = this.end.x - this.begin.x;\r\n    const dy1 = this.end.y - this.begin.y;\r\n\r\n    const cross = dxc * dy1 - dyc * dx1;\r\n\r\n    // check whether point lines on the line\r\n    if (Math.abs(cross) > threshold) {\r\n      return false;\r\n    }\r\n\r\n    // check whether point lies in-between start and end\r\n    if (Math.abs(dx1) >= Math.abs(dy1)) {\r\n      return dx1 > 0 ? this.begin.x <= currPoint.x && currPoint.x <= this.end.x : this.end.x <= currPoint.x && currPoint.x <= this.begin.x;\r\n    } else {\r\n      return dy1 > 0 ? this.begin.y <= currPoint.y && currPoint.y <= this.end.y : this.end.y <= currPoint.y && currPoint.y <= this.begin.y;\r\n    }\r\n  }\r\n}\r\n","import { LineSegment } from '../../Math/line-segment';\nimport { Vector } from '../../Math/vector';\nimport { Ray } from '../../Math/ray';\nimport { PolygonCollider } from './PolygonCollider';\nimport { EdgeCollider } from './EdgeCollider';\nimport { CircleCollider } from './CircleCollider';\n\n/**\n * Finds the closes line between 2 line segments, were the magnitude of u, v are the lengths of each segment\n * L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n * L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\n * @param p0 Point where L1 begins\n * @param u Direction and length of L1\n * @param q0 Point were L2 begins\n * @param v Direction and length of L2\n */\nexport function ClosestLine(p0: Vector, u: Vector, q0: Vector, v: Vector) {\n  // Distance between 2 lines http://geomalgorithms.com/a07-_distance.html\n\n  // w(s, t) = P(s) - Q(t)\n  // The w(s, t) that has the minimum distance we will say is w(sClosest, tClosest) = wClosest\n  //\n  // wClosest is the vector that is uniquely perpendicular to the 2 line directions u & v.\n  // wClosest = w0 + sClosest * u - tClosest * v, where w0 is p0 - q0\n  //\n  // The closest point between 2 lines then satisfies this pair of equations\n  // 1: u * wClosest = 0\n  // 2: v * wClosest = 0\n  //\n  // Substituting wClosest into the equations we get\n  //\n  // 1: (u * u) * sClosest - (u * v) tClosest = -u * w0\n  // 2: (v * u) * sClosest - (v * v) tClosest = -v * w0\n\n  // simplify w0\n  const w0 = p0.sub(q0);\n\n  // simplify (u * u);\n  const a = u.dot(u);\n  // simplify (u * v);\n  const b = u.dot(v);\n  // simplify (v * v)\n  const c = v.dot(v);\n  // simplify (u * w0)\n  const d = u.dot(w0);\n  // simplify (v * w0)\n  const e = v.dot(w0);\n\n  // denominator ac - b^2\n  const denom = a * c - b * b;\n  let sDenom = denom;\n  let tDenom = denom;\n  // if denom is 0 they are parallel, use any point from either as the start in this case p0\n  if (denom === 0 || denom <= 0.01) {\n    const tClosestParallel = d / b;\n    return new LineSegment(p0, q0.add(v.scale(tClosestParallel)));\n  }\n\n  // Solve for sClosest for infinite line\n  let sClosest = b * e - c * d; // / denom;\n\n  // Solve for tClosest for infinite line\n  let tClosest = a * e - b * d; // / denom;\n\n  // Solve for segments candidate edges, if sClosest and tClosest are outside their segments\n  if (sClosest < 0) {\n    sClosest = 0;\n    tClosest = e;\n    tDenom = c;\n  } else if (sClosest > sDenom) {\n    sClosest = sDenom;\n    tClosest = e + b;\n    tDenom = c;\n  }\n\n  if (tClosest < 0) {\n    tClosest = 0;\n    if (-d < 0) {\n      sClosest = 0;\n    } else if (-d > a) {\n      sClosest = sDenom;\n    } else {\n      sClosest = -d;\n      sDenom = a;\n    }\n  } else if (tClosest > tDenom) {\n    tClosest = tDenom;\n    if (-d + b < 0) {\n      sClosest = 0;\n    } else if (-d + b > a) {\n      sClosest = sDenom;\n    } else {\n      sClosest = -d + b;\n      sDenom = a;\n    }\n  }\n  sClosest = Math.abs(sClosest) < 0.001 ? 0 : sClosest / sDenom;\n  tClosest = Math.abs(tClosest) < 0.001 ? 0 : tClosest / tDenom;\n\n  return new LineSegment(p0.add(u.scale(sClosest)), q0.add(v.scale(tClosest)));\n}\n\nexport const ClosestLineJumpTable = {\n  PolygonPolygonClosestLine(polygonA: PolygonCollider, polygonB: PolygonCollider) {\n    // Find the 2 closest faces on each polygon\n    const otherWorldPos = polygonB.worldPos;\n    const otherDirection = otherWorldPos.sub(polygonA.worldPos);\n    const thisDirection = otherDirection.negate();\n\n    const rayTowardsOther = new Ray(polygonA.worldPos, otherDirection);\n    const rayTowardsThis = new Ray(otherWorldPos, thisDirection);\n\n    const thisPoint = polygonA.rayCast(rayTowardsOther).point.add(rayTowardsOther.dir.scale(0.1));\n    const otherPoint = polygonB.rayCast(rayTowardsThis).point.add(rayTowardsThis.dir.scale(0.1));\n\n    const thisFace = polygonA.getClosestFace(thisPoint);\n    const otherFace = polygonB.getClosestFace(otherPoint);\n\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n    const p0 = thisFace.face.begin;\n    const u = thisFace.face.getEdge();\n\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\n    const q0 = otherFace.face.begin;\n    const v = otherFace.face.getEdge();\n\n    return ClosestLine(p0, u, q0, v);\n  },\n\n  PolygonEdgeClosestLine(polygon: PolygonCollider, edge: EdgeCollider) {\n    // Find the 2 closest faces on each polygon\n    const otherWorldPos = edge.worldPos;\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\n\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection);\n\n    const thisPoint = polygon.rayCast(rayTowardsOther).point.add(rayTowardsOther.dir.scale(0.1));\n\n    const thisFace = polygon.getClosestFace(thisPoint);\n\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n    const p0 = thisFace.face.begin;\n    const u = thisFace.face.getEdge();\n\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\n    const edgeLine = edge.asLine();\n    const edgeStart = edgeLine.begin;\n    const edgeVector = edgeLine.getEdge();\n    const q0 = edgeStart;\n    const v = edgeVector;\n\n    return ClosestLine(p0, u, q0, v);\n  },\n\n  PolygonCircleClosestLine(polygon: PolygonCollider, circle: CircleCollider) {\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\n    // Find the 2 closest faces on each polygon\n    const otherWorldPos = circle.worldPos;\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\n\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection.normalize());\n\n    const thisPoint = polygon.rayCast(rayTowardsOther).point.add(rayTowardsOther.dir.scale(0.1));\n\n    const thisFace = polygon.getClosestFace(thisPoint);\n\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n    const p0 = thisFace.face.begin;\n    const u = thisFace.face.getEdge();\n\n    // Time of minimum distance\n    let t = (u.x * (otherWorldPos.x - p0.x) + u.y * (otherWorldPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\n\n    // If time of minimum is past the edge clamp\n    if (t > 1) {\n      t = 1;\n    } else if (t < 0) {\n      t = 0;\n    }\n\n    // Minimum distance\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - otherWorldPos.x, 2) + Math.pow(p0.y + u.y * t - otherWorldPos.y, 2)) - circle.radius;\n\n    const circlex = ((p0.x + u.x * t - otherWorldPos.x) * circle.radius) / (circle.radius + d);\n    const circley = ((p0.y + u.y * t - otherWorldPos.y) * circle.radius) / (circle.radius + d);\n    return new LineSegment(u.scale(t).add(p0), new Vector(otherWorldPos.x + circlex, otherWorldPos.y + circley));\n  },\n\n  CircleCircleClosestLine(circleA: CircleCollider, circleB: CircleCollider) {\n    // Find the 2 closest faces on each polygon\n    const otherWorldPos = circleB.worldPos;\n    const otherDirection = otherWorldPos.sub(circleA.worldPos);\n\n    const thisWorldPos = circleA.worldPos;\n    const thisDirection = thisWorldPos.sub(circleB.worldPos);\n\n    const rayTowardsOther = new Ray(circleA.worldPos, otherDirection);\n    const rayTowardsThis = new Ray(circleB.worldPos, thisDirection);\n\n    const thisPoint = circleA.rayCast(rayTowardsOther);\n    const otherPoint = circleB.rayCast(rayTowardsThis);\n\n    return new LineSegment(thisPoint.point, otherPoint.point);\n  },\n\n  CircleEdgeClosestLine(circle: CircleCollider, edge: EdgeCollider) {\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\n    const circleWorldPos = circle.worldPos;\n\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n    const edgeLine = edge.asLine();\n    const edgeStart = edgeLine.begin;\n    const edgeVector = edgeLine.getEdge();\n    const p0 = edgeStart;\n    const u = edgeVector;\n\n    // Time of minimum distance\n    let t = (u.x * (circleWorldPos.x - p0.x) + u.y * (circleWorldPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\n\n    // If time of minimum is past the edge clamp to edge\n    if (t > 1) {\n      t = 1;\n    } else if (t < 0) {\n      t = 0;\n    }\n\n    // Minimum distance\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - circleWorldPos.x, 2) + Math.pow(p0.y + u.y * t - circleWorldPos.y, 2)) - circle.radius;\n\n    const circlex = ((p0.x + u.x * t - circleWorldPos.x) * circle.radius) / (circle.radius + d);\n    const circley = ((p0.y + u.y * t - circleWorldPos.y) * circle.radius) / (circle.radius + d);\n    return new LineSegment(u.scale(t).add(p0), new Vector(circleWorldPos.x + circlex, circleWorldPos.y + circley));\n  },\n\n  EdgeEdgeClosestLine(edgeA: EdgeCollider, edgeB: EdgeCollider) {\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\n    const edgeLineA = edgeA.asLine();\n    const edgeStartA = edgeLineA.begin;\n    const edgeVectorA = edgeLineA.getEdge();\n    const p0 = edgeStartA;\n    const u = edgeVectorA;\n\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\n    const edgeLineB = edgeB.asLine();\n    const edgeStartB = edgeLineB.begin;\n    const edgeVectorB = edgeLineB.getEdge();\n    const q0 = edgeStartB;\n    const v = edgeVectorB;\n\n    return ClosestLine(p0, u, q0, v);\n  }\n};\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\n\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { BodyComponent } from '../Index';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\n\r\nexport interface CircleColliderOptions {\r\n  /**\r\n   * Optional pixel offset to shift the circle relative to the collider, by default (0, 0).\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Required radius of the circle\r\n   */\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * This is a circle collider for the excalibur rigid body physics simulation\r\n */\r\nexport class CircleCollider extends Collider {\r\n  /**\r\n   * Position of the circle relative to the collider, by default (0, 0).\r\n   */\r\n  public offset: Vector = Vector.Zero;\r\n\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  public get worldPos(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  private _naturalRadius: number;\r\n  /**\r\n   * Get the radius of the circle\r\n   */\r\n  public get radius(): number {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    return this._naturalRadius * Math.min(scale.x, scale.y);\r\n  }\r\n\r\n  /**\r\n   * Set the radius of the circle\r\n   */\r\n  public set radius(val: number) {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    this._naturalRadius = val / Math.min(scale.x, scale.y);\r\n  }\r\n\r\n  private _transform: Transform;\r\n\r\n  constructor(options: CircleColliderOptions) {\r\n    super();\r\n    this.offset = options.offset || Vector.Zero;\r\n    this.radius = options.radius || 0;\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this shape, not associated with any collider\r\n   */\r\n  public clone(): CircleCollider {\r\n    return new CircleCollider({\r\n      offset: this.offset.clone(),\r\n      radius: this.radius\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    const pos = this._transform?.pos ?? this.offset;\r\n    const distance = pos.distance(point);\r\n    if (distance <= this.radius) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Casts a ray at the Circle collider and returns the nearest point of collision\r\n   * @param ray\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    //https://en.wikipedia.org/wiki/Line%E2%80%93sphere_intersection\r\n    const c = this.center;\r\n    const dir = ray.dir;\r\n    const orig = ray.pos;\r\n\r\n    const discriminant = Math.sqrt(Math.pow(dir.dot(orig.sub(c)), 2) - Math.pow(orig.sub(c).distance(), 2) + Math.pow(this.radius, 2));\r\n\r\n    if (discriminant < 0) {\r\n      // no intersection\r\n      return null;\r\n    } else {\r\n      let toi = 0;\r\n      // tangent case\r\n      if (discriminant === 0) {\r\n        toi = -dir.dot(orig.sub(c));\r\n        if (toi > 0 && toi < max) {\r\n          const point = ray.getPoint(toi);\r\n          return {\r\n            point,\r\n            normal: point.sub(c).normalize(),\r\n            collider: this,\r\n            body: this.owner?.get(BodyComponent),\r\n            distance: toi\r\n          } satisfies RayCastHit;\r\n        }\r\n        return null;\r\n      } else { // two point\r\n        const toi1 = -dir.dot(orig.sub(c)) + discriminant;\r\n        const toi2 = -dir.dot(orig.sub(c)) - discriminant;\r\n\r\n        const positiveToi: number[] = [];\r\n        if (toi1 >= 0) {\r\n          positiveToi.push(toi1);\r\n        }\r\n\r\n        if (toi2 >= 0) {\r\n          positiveToi.push(toi2);\r\n        }\r\n\r\n        const minToi = Math.min(...positiveToi);\r\n        if (minToi <= max) {\r\n          const point =  ray.getPoint(minToi);\r\n          return {\r\n            point,\r\n            normal: point.sub(c).normalize(),\r\n            collider: this,\r\n            body: this.owner?.get(BodyComponent),\r\n            distance: minToi\r\n          } satisfies RayCastHit;\r\n        }\r\n        return null;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleCircleClosestLine(this, shape);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(this, shape).flip();\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleCircle(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Circle could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    return this.center.add(direction.normalize().scale(this.radius));\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the shape in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const dir = direction.normalize();\r\n    return dir.scale(this.radius);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    const rotation = tx?.globalRotation ?? 0;\r\n    const pos = (tx?.globalPos ?? Vector.Zero);\r\n    return new BoundingBox(\r\n      this.offset.x - this._naturalRadius,\r\n      this.offset.y - this._naturalRadius,\r\n      this.offset.x + this._naturalRadius,\r\n      this.offset.y + this._naturalRadius\r\n    ).rotate(rotation).scale(scale).translate(pos);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return new BoundingBox(\r\n      this.offset.x - this._naturalRadius,\r\n      this.offset.y - this._naturalRadius,\r\n      this.offset.x + this._naturalRadius,\r\n      this.offset.y + this._naturalRadius\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get axis not implemented on circles, since there are infinite axis in a circle\r\n   */\r\n  public get axes(): Vector[] {\r\n    return [];\r\n  }\r\n\r\n  /**\r\n   * Returns the moment of inertia of a circle given it's mass\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    return (mass * this.radius * this.radius) / 2;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Project the circle along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n    const point = this.center;\r\n    const dotProduct = point.dot(axis);\r\n    scalars.push(dotProduct);\r\n    scalars.push(dotProduct + this.radius);\r\n    scalars.push(dotProduct - this.radius);\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number }) {\r\n    const { lineWidth } = { ...{ lineWidth: 1 }, ...options };\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    const rotation = tx?.globalRotation ?? 0;\r\n    const pos = (tx?.globalPos ?? Vector.Zero);\r\n    ex.save();\r\n    ex.translate(pos.x, pos.y);\r\n    ex.rotate(rotation);\r\n    ex.scale(scale.x, scale.y);\r\n    ex.drawCircle((this.offset ?? Vector.Zero), this._naturalRadius, Color.Transparent, color, lineWidth);\r\n    ex.restore();\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\nimport { Collider } from '../Colliders/Collider';\nimport { CollisionType } from '../CollisionType';\nimport { Pair } from './Pair';\nimport { SeparationInfo } from '../Colliders/SeparatingAxis';\nimport { BodyComponent } from '../BodyComponent';\n\n/**\n * Collision contacts are used internally by Excalibur to resolve collision between colliders. This\n * Pair prevents collisions from being evaluated more than one time\n */\nexport class CollisionContact {\n  private _canceled = false;\n\n  /**\n   * Currently the ids between colliders\n   */\n  readonly id: string;\n\n  /**\n   * The first collider in the collision\n   */\n  colliderA: Collider;\n\n  /**\n   * The second collider in the collision\n   */\n  colliderB: Collider;\n\n  /**\n   * The minimum translation vector to resolve overlap, pointing away from colliderA\n   */\n  mtv: Vector;\n\n  /**\n   * World space contact points between colliderA and colliderB\n   */\n  points: Vector[];\n\n  /**\n   * Local space contact points between colliderA and colliderB\n   */\n  localPoints: Vector[];\n\n  /**\n   * The collision normal, pointing away from colliderA\n   */\n  normal: Vector;\n\n  /**\n   * The collision tangent\n   */\n  tangent: Vector;\n\n  /**\n   * Information about the specifics of the collision contact separation\n   */\n  info: SeparationInfo;\n\n  constructor(\n    colliderA: Collider,\n    colliderB: Collider,\n    mtv: Vector,\n    normal: Vector,\n    tangent: Vector,\n    points: Vector[],\n    localPoints: Vector[],\n    info: SeparationInfo\n  ) {\n    this.colliderA = colliderA;\n    this.colliderB = colliderB;\n    this.mtv = mtv;\n    this.normal = normal;\n    this.tangent = tangent;\n    this.points = points;\n    this.localPoints = localPoints;\n    this.info = info;\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\n    if (colliderA.composite || colliderB.composite) {\n      // Add on the parent composite pair for start/end contact if 'together\n      const colliderAId = colliderA.composite?.compositeStrategy === 'separate' ? colliderA.id : colliderA.composite?.id ?? colliderA.id;\n      const colliderBId = colliderB.composite?.compositeStrategy === 'separate' ? colliderB.id : colliderB.composite?.id ?? colliderB.id;\n      this.id += '|' + Pair.calculatePairHash(colliderAId, colliderBId);\n    }\n  }\n\n  /**\n   * Match contact awake state, except if body's are Fixed\n   */\n  public matchAwake(): void {\n    const bodyA = this.colliderA.owner.get(BodyComponent);\n    const bodyB = this.colliderB.owner.get(BodyComponent);\n    if (bodyA && bodyB) {\n      if (bodyA.sleeping !== bodyB.sleeping) {\n        if (bodyA.sleeping && bodyA.collisionType !== CollisionType.Fixed && bodyB.sleepMotion >= bodyA.wakeThreshold) {\n          bodyA.setSleeping(false);\n        }\n        if (bodyB.sleeping && bodyB.collisionType !== CollisionType.Fixed && bodyA.sleepMotion >= bodyB.wakeThreshold) {\n          bodyB.setSleeping(false);\n        }\n      }\n    }\n  }\n\n  public isCanceled() {\n    return this._canceled;\n  }\n\n  public cancel(): void {\n    this._canceled = true;\n  }\n}\n","import { LineSegment } from '../../Math/line-segment';\nimport { Vector } from '../../Math/vector';\nimport { Collider } from './Collider';\nimport { CircleCollider } from './CircleCollider';\nimport { PolygonCollider } from './PolygonCollider';\n\n/**\n * Specific information about a contact and it's separation\n */\nexport interface SeparationInfo {\n  /**\n   * Collider A\n   */\n  collider: Collider;\n\n  /**\n   * Signed value (negative means overlap, positive no overlap)\n   */\n  separation: number;\n\n  /**\n   * Axis of separation from the collider's perspective\n   */\n  axis: Vector;\n\n  /**\n   * Side of separation (reference) from the collider's perspective\n   */\n\n  side?: LineSegment;\n\n  /**\n   * Local side of separation (reference) from the collider's perspective\n   */\n  localSide?: LineSegment;\n\n  /**\n   * Index of the separation side (reference) from the collider's perspective\n   */\n  sideId?: number;\n\n  /**\n   * Point on collider B (incident point)\n   */\n  point: Vector;\n\n  /**\n   * Local point on collider B (incident point)\n   */\n  localPoint?: Vector;\n}\n\nexport class SeparatingAxis {\n  static findPolygonPolygonSeparation(polyA: PolygonCollider, polyB: PolygonCollider): SeparationInfo {\n    let bestSeparation = -Number.MAX_VALUE;\n    let bestSide: LineSegment | null = null;\n    let bestAxis: Vector | null = null;\n    let bestSideIndex: number = -1;\n    let bestOtherPoint: Vector | null = null;\n    const sides = polyA.getSides();\n    const localSides = polyA.getLocalSides();\n    for (let i = 0; i < sides.length; i++) {\n      const side = sides[i];\n      const axis = side.normal();\n      const vertB = polyB.getFurthestPoint(axis.negate());\n      // Separation on side i's axis\n      // We are looking for the largest separation between poly A's sides\n      const vertSeparation = side.distanceToPoint(vertB, true);\n      if (vertSeparation > bestSeparation) {\n        bestSeparation = vertSeparation;\n        bestSide = side;\n        bestAxis = axis;\n        bestSideIndex = i;\n        bestOtherPoint = vertB;\n      }\n    }\n\n    return {\n      collider: polyA,\n      separation: bestAxis ? bestSeparation : 99,\n      axis: bestAxis as Vector,\n      side: bestSide,\n      localSide: localSides[bestSideIndex],\n      sideId: bestSideIndex,\n      point: bestOtherPoint as Vector,\n      localPoint: bestAxis ? polyB.getFurthestLocalPoint(bestAxis!.negate()) : null\n    };\n  }\n\n  static findCirclePolygonSeparation(circle: CircleCollider, polygon: PolygonCollider): Vector | null {\n    const axes = polygon.axes;\n    const pc = polygon.center;\n    // Special SAT with circles\n    const polyDir = pc.sub(circle.worldPos);\n    const closestPointOnPoly = polygon.getFurthestPoint(polyDir.negate());\n    axes.push(closestPointOnPoly.sub(circle.worldPos).normalize());\n\n    let minOverlap = Number.MAX_VALUE;\n    let minAxis = null;\n    let minIndex = -1;\n    for (let i = 0; i < axes.length; i++) {\n      const proj1 = polygon.project(axes[i]);\n      const proj2 = circle.project(axes[i]);\n      const overlap = proj1.getOverlap(proj2);\n      if (overlap <= 0) {\n        return null;\n      } else {\n        if (overlap < minOverlap) {\n          minOverlap = overlap;\n          minAxis = axes[i];\n          minIndex = i;\n        }\n      }\n    }\n    if (minIndex < 0) {\n      return null;\n    }\n    return minAxis.normalize().scale(minOverlap);\n  }\n}\n","import { CircleCollider } from './CircleCollider';\nimport { CollisionContact } from '../Detection/CollisionContact';\nimport { PolygonCollider } from './PolygonCollider';\nimport { EdgeCollider } from './EdgeCollider';\nimport { SeparatingAxis, SeparationInfo } from './SeparatingAxis';\nimport { LineSegment } from '../../Math/line-segment';\nimport { Vector } from '../../Math/vector';\nimport { TransformComponent } from '../../EntityComponentSystem';\nimport { Pair } from '../Detection/Pair';\n\nexport const CollisionJumpTable = {\n  CollideCircleCircle(circleA: CircleCollider, circleB: CircleCollider): CollisionContact[] {\n    const circleAPos = circleA.worldPos;\n    const circleBPos = circleB.worldPos;\n    const combinedRadius = circleA.radius + circleB.radius;\n    const distance = circleAPos.distance(circleBPos);\n\n    if (distance > combinedRadius) {\n      return [];\n    }\n\n    // negative means overlap\n    const separation = combinedRadius - distance;\n\n    // Normal points from A -> B\n    const normal = circleBPos.sub(circleAPos).normalize();\n    const tangent = normal.perpendicular();\n    const mvt = normal.scale(separation);\n\n    const point = circleA.getFurthestPoint(normal);\n    const local = circleA.getFurthestLocalPoint(normal);\n\n    const info: SeparationInfo = {\n      collider: circleA,\n      separation,\n      axis: normal,\n      point: point\n    };\n\n    return [new CollisionContact(circleA, circleB, mvt, normal, tangent, [point], [local], info)];\n  },\n\n  CollideCirclePolygon(circle: CircleCollider, polygon: PolygonCollider): CollisionContact[] {\n    let minAxis = SeparatingAxis.findCirclePolygonSeparation(circle, polygon);\n    if (!minAxis) {\n      return [];\n    }\n\n    // make sure that the minAxis is pointing away from circle\n    const samedir = minAxis.dot(polygon.center.sub(circle.center));\n    minAxis = samedir < 0 ? minAxis.negate() : minAxis;\n\n    const point = circle.getFurthestPoint(minAxis);\n    const xf = circle.owner?.get(TransformComponent) ?? new TransformComponent();\n    const local = xf.applyInverse(point);\n    const normal = minAxis.normalize();\n\n    const info: SeparationInfo = {\n      collider: circle,\n      separation: -minAxis.size,\n      axis: normal,\n      point: point,\n      localPoint: local,\n      side: polygon.findSide(normal.negate()),\n      localSide: polygon.findLocalSide(normal.negate())\n    };\n\n    return [new CollisionContact(circle, polygon, minAxis, normal, normal.perpendicular(), [point], [local], info)];\n  },\n\n  CollideCircleEdge(circle: CircleCollider, edge: EdgeCollider): CollisionContact[] {\n    // TODO not sure this actually abides by local/world collisions\n    // Are edge.begin and edge.end local space or world space? I think they should be local\n\n    // center of the circle in world pos\n    const cc = circle.center;\n    // vector in the direction of the edge\n    const edgeWorld = edge.asLine();\n    const e = edgeWorld.end.sub(edgeWorld.begin);\n\n    // amount of overlap with the circle's center along the edge direction\n    const u = e.dot(edgeWorld.end.sub(cc));\n    const v = e.dot(cc.sub(edgeWorld.begin));\n    const side = edge.asLine();\n    const localSide = edge.asLocalLine();\n\n    // Potential region A collision (circle is on the left side of the edge, before the beginning)\n    if (v <= 0) {\n      const da = edgeWorld.begin.sub(cc);\n      const dda = da.dot(da); // quick and dirty way of calc'n distance in r^2 terms saves some sqrts\n      // save some sqrts\n      if (dda > circle.radius * circle.radius) {\n        return []; // no collision\n      }\n\n      const normal = da.normalize();\n      const separation = circle.radius - Math.sqrt(dda);\n\n      const info: SeparationInfo = {\n        collider: circle,\n        separation: separation,\n        axis: normal,\n        point: side.begin,\n        side: side,\n        localSide: localSide\n      };\n\n      return [\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.begin], [localSide.begin], info)\n      ];\n    }\n\n    // Potential region B collision (circle is on the right side of the edge, after the end)\n    if (u <= 0) {\n      const db = edgeWorld.end.sub(cc);\n      const ddb = db.dot(db);\n      if (ddb > circle.radius * circle.radius) {\n        return [];\n      }\n\n      const normal = db.normalize();\n      const separation = circle.radius - Math.sqrt(ddb);\n\n      const info: SeparationInfo = {\n        collider: circle,\n        separation: separation,\n        axis: normal,\n        point: side.end,\n        side: side,\n        localSide: localSide\n      };\n\n      return [\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.end], [localSide.end], info)\n      ];\n    }\n\n    // Otherwise potential region AB collision (circle is in the middle of the edge between the beginning and end)\n    const den = e.dot(e);\n    const pointOnEdge = edgeWorld.begin\n      .scale(u)\n      .add(edgeWorld.end.scale(v))\n      .scale(1 / den);\n    const d = cc.sub(pointOnEdge);\n\n    const dd = d.dot(d);\n    if (dd > circle.radius * circle.radius) {\n      return []; // no collision\n    }\n\n    let normal = e.perpendicular();\n    // flip correct direction\n    if (normal.dot(cc.sub(edgeWorld.begin)) < 0) {\n      normal.x = -normal.x;\n      normal.y = -normal.y;\n    }\n\n    normal = normal.normalize();\n    const separation = circle.radius - Math.sqrt(dd);\n\n    const mvt = normal.scale(separation);\n    const info: SeparationInfo = {\n      collider: circle,\n      separation: separation,\n      axis: normal,\n      point: pointOnEdge,\n      side: side,\n      localSide: localSide\n    };\n\n    return [\n      new CollisionContact(\n        circle,\n        edge,\n        mvt,\n        normal.negate(),\n        normal.negate().perpendicular(),\n        [pointOnEdge],\n        [pointOnEdge.sub(edge.worldPos)],\n        info\n      )\n    ];\n  },\n\n  CollideEdgeEdge(): CollisionContact[] {\n    // Edge-edge collision doesn't make sense\n    return [];\n  },\n\n  CollidePolygonEdge(polygon: PolygonCollider, edge: EdgeCollider): CollisionContact[] {\n    const pc = polygon.center;\n    const ec = edge.center;\n    const dir = ec.sub(pc).normalize();\n\n    // build a temporary polygon from the edge to use SAT\n    const linePoly = new PolygonCollider({\n      points: [edge.begin, edge.end, edge.end.add(dir.scale(100)), edge.begin.add(dir.scale(100))],\n      offset: edge.offset\n    });\n    linePoly.owner = edge.owner;\n    const tx = edge.owner?.get(TransformComponent);\n    if (tx) {\n      linePoly.update(edge.owner.get(TransformComponent).get());\n    }\n    // Gross hack but poly-poly works well\n    const contact = this.CollidePolygonPolygon(polygon, linePoly);\n    if (contact.length) {\n      // Fudge the contact back to edge\n      contact[0].colliderB = edge;\n      (contact[0].id as any) = Pair.calculatePairHash(polygon.id, edge.id);\n    }\n    return contact;\n  },\n\n  CollidePolygonPolygon(polyA: PolygonCollider, polyB: PolygonCollider): CollisionContact[] {\n    // Multi contact from SAT\n    // https://gamedev.stackexchange.com/questions/111390/multiple-contacts-for-sat-collision-detection\n    // do a SAT test to find a min axis if it exists\n    const separationA = SeparatingAxis.findPolygonPolygonSeparation(polyA, polyB);\n    // If there is no overlap from boxA's perspective we can end early\n    if (separationA.separation > 0) {\n      return [];\n    }\n\n    const separationB = SeparatingAxis.findPolygonPolygonSeparation(polyB, polyA);\n    // If there is no overlap from boxB's perspective exit now\n    if (separationB.separation > 0) {\n      return [];\n    }\n\n    // Separations are both negative, we want to pick the least negative (minimal movement)\n    const separation = separationA.separation > separationB.separation ? separationA : separationB;\n\n    // The incident side is the most opposite from the axes of collision on the other collider\n    const other = separation.collider === polyA ? polyB : polyA;\n    const incident = other.findSide(separation.axis.negate()) as LineSegment;\n\n    // Clip incident side by the perpendicular lines at each end of the reference side\n    // https://en.wikipedia.org/wiki/Sutherland%E2%80%93Hodgman_algorithm\n    const reference = separation.side;\n    const refDir = reference.dir().normalize();\n\n    // Find our contact points by clipping the incident by the collision side\n    const clipRight = incident.clip(refDir.negate(), -refDir.dot(reference.begin));\n    let clipLeft: LineSegment | null = null;\n    if (clipRight) {\n      clipLeft = clipRight.clip(refDir, refDir.dot(reference.end));\n    }\n\n    // If there is no left there is no collision\n    if (clipLeft) {\n      // We only want clip points below the reference edge, discard the others\n      const points = clipLeft.getPoints().filter((p) => {\n        return reference.below(p);\n      });\n\n      let normal = separation.axis;\n      let tangent = normal.perpendicular();\n      // Point Contact A -> B\n      if (polyB.center.sub(polyA.center).dot(normal) < 0) {\n        normal = normal.negate();\n        tangent = normal.perpendicular();\n      }\n      // Points are clipped from incident which is the other collider\n      // Store those as locals\n      let localPoints: Vector[] = [];\n      if (separation.collider === polyA) {\n        const xf = polyB.owner?.get(TransformComponent) ?? new TransformComponent();\n        localPoints = points.map((p) => xf.applyInverse(p));\n      } else {\n        const xf = polyA.owner?.get(TransformComponent) ?? new TransformComponent();\n        localPoints = points.map((p) => xf.applyInverse(p));\n      }\n      return [new CollisionContact(polyA, polyB, normal.scale(-separation.separation), normal, tangent, points, localPoints, separation)];\n    }\n    return [];\n  },\n\n  FindContactSeparation(contact: CollisionContact, localPoint: Vector) {\n    const shapeA = contact.colliderA;\n    const txA = contact.colliderA.owner?.get(TransformComponent) ?? new TransformComponent();\n    const shapeB = contact.colliderB;\n    const txB = contact.colliderB.owner?.get(TransformComponent) ?? new TransformComponent();\n\n    // both are circles\n    if (shapeA instanceof CircleCollider && shapeB instanceof CircleCollider) {\n      const combinedRadius = shapeA.radius + shapeB.radius;\n      const distance = txA.pos.distance(txB.pos);\n      const separation = combinedRadius - distance;\n      return -separation;\n    }\n\n    // both are polygons\n    if (shapeA instanceof PolygonCollider && shapeB instanceof PolygonCollider) {\n      if (contact.info.localSide) {\n        let side: LineSegment;\n        let worldPoint: Vector;\n        if (contact.info.collider === shapeA) {\n          side = new LineSegment(txA.apply(contact.info.localSide.begin), txA.apply(contact.info.localSide.end));\n          worldPoint = txB.apply(localPoint);\n        } else {\n          side = new LineSegment(txB.apply(contact.info.localSide.begin), txB.apply(contact.info.localSide.end));\n          worldPoint = txA.apply(localPoint);\n        }\n\n        return side.distanceToPoint(worldPoint, true);\n      }\n    }\n\n    // polygon v circle\n    if (\n      (shapeA instanceof PolygonCollider && shapeB instanceof CircleCollider) ||\n      (shapeB instanceof PolygonCollider && shapeA instanceof CircleCollider)\n    ) {\n      const worldPoint = txA.apply(localPoint);\n      if (contact.info.side) {\n        return contact.info.side.distanceToPoint(worldPoint, true);\n      }\n    }\n\n    // polygon v edge\n    if (\n      (shapeA instanceof EdgeCollider && shapeB instanceof PolygonCollider) ||\n      (shapeB instanceof EdgeCollider && shapeA instanceof PolygonCollider)\n    ) {\n      let worldPoint: Vector;\n      if (contact.info.collider === shapeA) {\n        worldPoint = txB.apply(localPoint);\n      } else {\n        worldPoint = txA.apply(localPoint);\n      }\n      if (contact.info.side) {\n        return contact.info.side.distanceToPoint(worldPoint, true);\n      }\n    }\n\n    // circle v edge\n    if (\n      (shapeA instanceof CircleCollider && shapeB instanceof EdgeCollider) ||\n      (shapeB instanceof CircleCollider && shapeA instanceof EdgeCollider)\n    ) {\n      // Local point is always on the edge which is always shapeB\n      const worldPoint = txB.apply(localPoint);\n\n      let circlePoint: Vector;\n      if (shapeA instanceof CircleCollider) {\n        circlePoint = shapeA.getFurthestPoint(contact.normal);\n      }\n\n      const dist = worldPoint.distance(circlePoint);\n\n      if (contact.info.side) {\n        return dist > 0 ? -dist : 0;\n      }\n    }\n\n    return 0;\n  }\n};\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { PolygonCollider } from './PolygonCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { BodyComponent } from '../Index';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\n\r\nexport interface EdgeColliderOptions {\r\n  /**\r\n   * The beginning of the edge defined in local coordinates to the collider\r\n   */\r\n  begin: Vector;\r\n  /**\r\n   * The ending of the edge defined in local coordinates to the collider\r\n   */\r\n  end: Vector;\r\n  /**\r\n   * Optionally specify an offset\r\n   */\r\n  offset?: Vector;\r\n}\r\n\r\n/**\r\n * Edge is a single line collider to create collisions with a single line.\r\n */\r\nexport class EdgeCollider extends Collider {\r\n  offset: Vector;\r\n  begin: Vector;\r\n  end: Vector;\r\n\r\n  private _transform: Transform;\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  constructor(options: EdgeColliderOptions) {\r\n    super();\r\n    this.begin = options.begin || Vector.Zero;\r\n    this.end = options.end || Vector.Zero;\r\n    this.offset = options.offset ?? Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this Edge, not associated with any collider\r\n   */\r\n  public clone(): EdgeCollider {\r\n    return new EdgeCollider({\r\n      begin: this.begin.clone(),\r\n      end: this.end.clone()\r\n    });\r\n  }\r\n\r\n  public get worldPos(): Vector {\r\n    const tx = this._transform;\r\n    return tx?.globalPos.add(this.offset) ?? this.offset;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collision area in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const pos = begin.average(end);\r\n    return pos;\r\n  }\r\n\r\n  private _getTransformedBegin(): Vector {\r\n    return this._globalMatrix.multiply(this.begin);\r\n  }\r\n\r\n  private _getTransformedEnd(): Vector {\r\n    return this._globalMatrix.multiply(this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns the slope of the line in the form of a vector\r\n   */\r\n  public getSlope(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return end.sub(begin).scale(1 / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return distance;\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collision area\r\n   */\r\n  public contains(): boolean {\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    const numerator = this._getTransformedBegin().sub(ray.pos);\r\n\r\n    // Test is line and ray are parallel and non intersecting\r\n    if (ray.dir.cross(this.getSlope()) === 0 && numerator.cross(ray.dir) !== 0) {\r\n      return null;\r\n    }\r\n\r\n    // Lines are parallel\r\n    const divisor = ray.dir.cross(this.getSlope());\r\n    if (divisor === 0) {\r\n      return null;\r\n    }\r\n\r\n    const t = numerator.cross(this.getSlope()) / divisor;\r\n\r\n    if (t >= 0 && t <= max) {\r\n      const u = numerator.cross(ray.dir) / divisor / this.getLength();\r\n      if (u >= 0 && u <= 1) {\r\n        return {\r\n          distance: t,\r\n          normal: this.asLine().normal(),\r\n          collider: this,\r\n          body: this.owner?.get(BodyComponent),\r\n          point: ray.getPoint(t)\r\n        } satisfies RayCastHit;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the closes line between this and another collider, from this -> collider\r\n   * @param shape\r\n   */\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.EdgeEdgeClosestLine(this, shape);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(shape: Collider): CollisionContact[] {\r\n    if (shape instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(shape, this);\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideEdgeEdge();\r\n    } else {\r\n      throw new Error(`Edge could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    if (direction.dot(transformedBegin) > 0) {\r\n      return transformedBegin;\r\n    } else {\r\n      return transformedEnd;\r\n    }\r\n  }\r\n\r\n  private _boundsFromBeginEnd(begin: Vector, end: Vector, padding = 10) {\r\n    // A perfectly vertical or horizontal edge would have a bounds 0 width or height\r\n    // this causes problems for the collision system so we give them some padding\r\n    return new BoundingBox(\r\n      Math.min(begin.x, end.x) - padding,\r\n      Math.min(begin.y, end.y) - padding,\r\n      Math.max(begin.x, end.x) + padding,\r\n      Math.max(begin.y, end.y) + padding\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in world space\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    return this._boundsFromBeginEnd(transformedBegin, transformedEnd);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in local space\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return this._boundsFromBeginEnd(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns this edge represented as a line in world coordinates\r\n   */\r\n  public asLine(): LineSegment {\r\n    return new LineSegment(this._getTransformedBegin(), this._getTransformedEnd());\r\n  }\r\n\r\n  /**\r\n   * Return this edge as a line in local line coordinates (relative to the position)\r\n   */\r\n  public asLocalLine(): LineSegment {\r\n    return new LineSegment(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the edge\r\n   */\r\n  public get axes(): Vector[] {\r\n    const e = this._getTransformedEnd().sub(this._getTransformedBegin());\r\n    const edgeNormal = e.normal();\r\n\r\n    const axes = [];\r\n    axes.push(edgeNormal);\r\n    axes.push(edgeNormal.negate());\r\n    axes.push(edgeNormal.normal());\r\n    axes.push(edgeNormal.normal().negate());\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Get the moment of inertia for an edge\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    const length = this.end.sub(this.begin).distance() / 2;\r\n    return mass * length * length;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Project the edge along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n\r\n    const points = [this._getTransformedBegin(), this._getTransformedEnd()];\r\n    const len = points.length;\r\n    for (let i = 0; i < len; i++) {\r\n      scalars.push(points[i].dot(axis));\r\n    }\r\n\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    ex.drawLine(begin, end, color, 2);\r\n    ex.drawCircle(begin, 2, color);\r\n    ex.drawCircle(end, 2, color);\r\n  }\r\n\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext, LineGraphicsOptions, PointGraphicsOptions } from './Context/ExcaliburGraphicsContext';\r\nimport { Color } from '../Color';\r\nimport { Ray } from '../Math/ray';\r\nimport { BoundingBox } from '../excalibur';\r\n\r\nexport class Debug {\r\n  static _drawCalls: ((ctx: ExcaliburGraphicsContext) => void)[] = [];\r\n  static _ctx: ExcaliburGraphicsContext;\r\n  static z: number = Infinity;\r\n  static registerGraphicsContext(ctx: ExcaliburGraphicsContext) {\r\n    Debug._ctx = ctx;\r\n  }\r\n  static draw(debugDrawCall: (ctx: ExcaliburGraphicsContext) => void) {\r\n    this._drawCalls.push(debugDrawCall);\r\n  }\r\n\r\n  static drawPoint(point: Vector, options?: PointGraphicsOptions) {\r\n    Debug.draw(ctx => {\r\n      ctx.debug.drawPoint(point, options);\r\n    });\r\n  }\r\n\r\n  static drawLine(start: Vector, end: Vector, options?: LineGraphicsOptions) {\r\n    Debug.draw(ctx => {\r\n      ctx.debug.drawLine(start, end, options);\r\n    });\r\n  }\r\n\r\n  static drawLines(points: Vector[], options?: LineGraphicsOptions) {\r\n    if (points.length > 1) {\r\n      Debug.draw(ctx => {\r\n        for (let i = 0; i < points.length - 1; i++) {\r\n          ctx.debug.drawLine(points[i], points[i + 1], options);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  static drawText(text: string, pos: Vector) {\r\n    Debug.draw(ctx => {\r\n      ctx.debug.drawText(text, pos);\r\n    });\r\n  }\r\n\r\n  static drawPolygon(points: Vector[], options?: { color?: Color }) {\r\n    if (points.length > 1) {\r\n      Debug.draw(ctx => {\r\n        const firstPoint = points[0];\r\n        const polygon = [...points, firstPoint];\r\n        for (let i = 0; i < polygon.length - 1; i++) {\r\n          ctx.debug.drawLine(polygon[i], polygon[i + 1], options);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  static drawCircle(center: Vector, radius: number, options?: {\r\n    color?: Color,\r\n    strokeColor?: Color,\r\n    width?: number\r\n  }) {\r\n    const { color, strokeColor, width} = {\r\n      color: Color.Black,\r\n      strokeColor: undefined,\r\n      width: undefined,\r\n      ...options\r\n    };\r\n    Debug.draw(ctx => {\r\n      ctx.drawCircle(center, radius, color, strokeColor, width);\r\n    });\r\n  }\r\n\r\n  static drawBounds(boundingBox: BoundingBox, options?: { color?: Color }): void {\r\n    Debug.draw(ctx => {\r\n      ctx.debug.drawRect(boundingBox.left, boundingBox.top, boundingBox.width, boundingBox.height, options);\r\n    });\r\n  }\r\n\r\n  static drawRay(ray: Ray, options?: { distance?: number, color?: Color }) {\r\n    const { distance, color } = {\r\n      color: Color.Blue,\r\n      distance: 10,\r\n      ...options\r\n    };\r\n    Debug.draw((ctx) => {\r\n      const start = ray.pos;\r\n      const end = ray.pos.add(ray.dir.scale(distance));\r\n\r\n      ctx.debug.drawLine(start, end, { color });\r\n    });\r\n  }\r\n\r\n  static flush(ctx: ExcaliburGraphicsContext) {\r\n    ctx.save();\r\n    ctx.z = Debug.z;\r\n    for (const drawCall of Debug._drawCalls) {\r\n      drawCall(ctx);\r\n    }\r\n    ctx.restore();\r\n    Debug.clear();\r\n  }\r\n\r\n  static clear() {\r\n    Debug._drawCalls.length = 0;\r\n  }\r\n}","import { Color } from '../../Color';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Ray } from '../../Math/ray';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { Collider } from './Collider';\r\nimport { BodyComponent, Debug, ExcaliburGraphicsContext, Logger } from '../..';\r\nimport { CompositeCollider } from './CompositeCollider';\r\nimport { Shape } from './Shape';\r\nimport { Transform } from '../../Math/transform';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\n\r\nexport interface PolygonColliderOptions {\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   */\r\n  points: Vector[];\r\n\r\n  /**\r\n   * Suppresses convexity warning\r\n   */\r\n  suppressConvexWarning?: boolean;\r\n}\r\n\r\n/**\r\n * Polygon collider for detecting collisions\r\n */\r\nexport class PolygonCollider extends Collider {\r\n  private _logger = Logger.getInstance();\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  public offset: Vector;\r\n\r\n  public flagDirty() {\r\n    this._localBoundsDirty = true;\r\n    this._localSidesDirty = true;\r\n    this._transformedPointsDirty = true;\r\n    this._sidesDirty = true;\r\n  }\r\n\r\n  private _points: Vector[];\r\n\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public set points(points: Vector[]) {\r\n    this._points = points;\r\n    this.flagDirty();\r\n  }\r\n\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public get points(): Vector[] {\r\n    return this._points;\r\n  }\r\n\r\n  private _transform: Transform;\r\n\r\n  private _transformedPoints: Vector[] = [];\r\n  private _sides: LineSegment[] = [];\r\n  private _localSides: LineSegment[] = [];\r\n\r\n  constructor(options: PolygonColliderOptions) {\r\n    super();\r\n    this.offset = options.offset ?? Vector.Zero;\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n    this.points = options.points ?? [];\r\n    const counterClockwise = this._isCounterClockwiseWinding(this.points);\r\n    if (!counterClockwise) {\r\n      this.points.reverse();\r\n    }\r\n\r\n    if (!this.isConvex()) {\r\n      if (!options.suppressConvexWarning) {\r\n        this._logger.warn(\r\n          'Excalibur only supports convex polygon colliders and will not behave properly.' +\r\n          'Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles');\r\n      }\r\n    }\r\n\r\n    // calculate initial transformation\r\n    this._calculateTransformation();\r\n  }\r\n\r\n  private _isCounterClockwiseWinding(points: Vector[]): boolean {\r\n    // https://stackoverflow.com/a/1165943\r\n    let sum = 0;\r\n    for (let i = 0; i < points.length; i++) {\r\n      sum += (points[(i + 1) % points.length].x - points[i].x) * (points[(i + 1) % points.length].y + points[i].y);\r\n    }\r\n    return sum < 0;\r\n  }\r\n\r\n  /**\r\n   * Returns if the polygon collider is convex, Excalibur does not handle non-convex collision shapes.\r\n   * Call [[Polygon.triangulate]] to generate a [[CompositeCollider]] from this non-convex shape\r\n   */\r\n  public isConvex(): boolean {\r\n    // From SO: https://stackoverflow.com/a/45372025\r\n    if (this.points.length < 3) {\r\n      return false;\r\n    }\r\n    let oldPoint = this.points[this.points.length - 2];\r\n    let newPoint = this.points[this.points.length - 1];\r\n    let direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n    let oldDirection = 0;\r\n    let orientation = 0;\r\n    let angleSum = 0;\r\n    for (const [i, point] of this.points.entries()) {\r\n      oldPoint = newPoint;\r\n      oldDirection = direction;\r\n      newPoint = point;\r\n      direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n      if (oldPoint.equals(newPoint)) {\r\n        return false; // repeat point\r\n      }\r\n      let angle = direction - oldDirection;\r\n      if (angle <= -Math.PI) {\r\n        angle += Math.PI * 2;\r\n      } else if (angle > Math.PI) {\r\n        angle -= Math.PI * 2;\r\n      }\r\n      if (i === 0) {\r\n        if (angle === 0.0) {\r\n          return false;\r\n        }\r\n        orientation = angle > 0 ? 1 : -1;\r\n      } else {\r\n        if (orientation * angle <= 0) {\r\n          return false;\r\n        }\r\n      }\r\n      angleSum += angle;\r\n    }\r\n    return Math.abs(Math.round(angleSum / (Math.PI * 2))) === 1;\r\n  }\r\n\r\n  /**\r\n   * Tessellates the polygon into a triangle fan as a [[CompositeCollider]] of triangle polygons\r\n   */\r\n  public tessellate(): CompositeCollider {\r\n    const polygons: Vector[][] = [];\r\n    for (let i = 1; i < this.points.length - 2; i++) {\r\n      polygons.push([this.points[0], this.points[i + 1], this.points[i + 2]]);\r\n    }\r\n    polygons.push([this.points[0], this.points[1], this.points[2]]);\r\n\r\n    return new CompositeCollider(polygons.map(points => Shape.Polygon(points)));\r\n  }\r\n\r\n  /**\r\n   * Triangulate the polygon collider using the \"Ear Clipping\" algorithm.\r\n   * Returns a new [[CompositeCollider]] made up of smaller triangles.\r\n   */\r\n  public triangulate(): CompositeCollider {\r\n    // https://www.youtube.com/watch?v=hTJFcHutls8\r\n    if (this.points.length < 3) {\r\n      throw Error('Invalid polygon');\r\n    }\r\n\r\n    const triangles: [Vector, Vector, Vector][] = [];\r\n    // algorithm likes clockwise\r\n    const vertices = [...this.points].reverse();\r\n    let vertexCount = vertices.length;\r\n\r\n    /**\r\n     * Returns the previous index based on the current vertex\r\n     */\r\n    function getPrevIndex(index: number) {\r\n      return index === 0 ? vertexCount - 1 : index - 1;\r\n    }\r\n\r\n    /**\r\n     * Retrieves the next index based on the current vertex\r\n     */\r\n    function getNextIndex(index: number) {\r\n      return index === vertexCount - 1 ? 0 : index + 1;\r\n    }\r\n\r\n    /**\r\n     * Whether or not the angle at this vertex index is convex\r\n     */\r\n    function isConvex(index: number) {\r\n      const prev = getPrevIndex(index);\r\n      const next = getNextIndex(index);\r\n\r\n      const va = vertices[prev];\r\n      const vb = vertices[index];\r\n      const vc = vertices[next];\r\n\r\n      // Check convexity\r\n      const leftArm = va.sub(vb);\r\n      const rightArm = vc.sub(vb);\r\n      // Positive cross product is convex\r\n      if (leftArm.cross(rightArm) < 0) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n\r\n    const convexVertices = vertices.map((_,i) => isConvex(i));\r\n\r\n    /**\r\n     * Quick test for point in triangle\r\n     */\r\n    function isPointInTriangle(point: Vector, a: Vector, b: Vector, c: Vector) {\r\n      const ab = b.sub(a);\r\n      const bc = c.sub(b);\r\n      const ca = a.sub(c);\r\n\r\n      const ap = point.sub(a);\r\n      const bp = point.sub(b);\r\n      const cp = point.sub(c);\r\n\r\n      const cross1 = ab.cross(ap);\r\n      const cross2 = bc.cross(bp);\r\n      const cross3 = ca.cross(cp);\r\n\r\n      if (cross1 > 0 || cross2 > 0 || cross3 > 0) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n\r\n    /**\r\n     * Calculate the area of the triangle\r\n     */\r\n    // function triangleArea(a: Vector, b: Vector, c: Vector) {\r\n    //   return Math.abs(a.x * (b.y - c.y) + b.x * (c.y - a.y) + c.x * (a.y - c.y))/2;\r\n    // }\r\n\r\n    /**\r\n     * Find the next suitable ear tip\r\n     */\r\n    function findEarTip() {\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        if (convexVertices[i]) {\r\n\r\n          const prev = getPrevIndex(i);\r\n          const next = getNextIndex(i);\r\n\r\n          const va = vertices[prev];\r\n          const vb = vertices[i];\r\n          const vc = vertices[next];\r\n\r\n          let isEar = true;\r\n          // Check that if any vertices are in the triangle a, b, c\r\n          for (let j = 0; j < vertexCount; j++) {\r\n            // We can skip these verts because they are the triangle we are testing\r\n            if (j === i || j === prev || j === next) {\r\n              continue;\r\n            }\r\n            const point = vertices[j];\r\n            if (isPointInTriangle(point, va, vb, vc)) {\r\n              isEar = false;\r\n              break;\r\n            }\r\n          }\r\n\r\n          // Add ear to polygon list and remove from list\r\n          if (isEar) {\r\n            return i;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Fall back to any convex vertex\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        if (convexVertices[i]) {\r\n          return i;\r\n        }\r\n      }\r\n\r\n      // bail and return the first one?\r\n      return 0;\r\n    }\r\n\r\n    /**\r\n     * Cut the ear and produce a triangle, update internal state\r\n     */\r\n    function cutEarTip(index: number) {\r\n      const prev = getPrevIndex(index);\r\n      const next = getNextIndex(index);\r\n\r\n      const va = vertices[prev];\r\n      const vb = vertices[index];\r\n      const vc = vertices[next];\r\n\r\n      // Clockwise winding\r\n      // if (triangleArea(va, vb, vc) > 0) {\r\n      triangles.push([va, vb, vc]);\r\n      // }\r\n      vertices.splice(index, 1);\r\n      convexVertices.splice(index, 1);\r\n      vertexCount--;\r\n    }\r\n\r\n    // Loop over all the vertices finding ears\r\n    while (vertexCount > 3) {\r\n      const earIndex = findEarTip();\r\n      cutEarTip(earIndex);\r\n\r\n      // reclassify vertices\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        convexVertices[i] = isConvex(i);\r\n      }\r\n    }\r\n\r\n    // Last triangle after the loop\r\n    triangles.push([vertices[0], vertices[1], vertices[2]]);\r\n\r\n    // FIXME: there is a colinear triangle that sneaks in here sometimes\r\n    return new CompositeCollider(\r\n      triangles.map(points => Shape.Polygon(points, Vector.Zero, true)));\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this ConvexPolygon, not associated with any collider\r\n   */\r\n  public clone(): PolygonCollider {\r\n    return new PolygonCollider({\r\n      offset: this.offset.clone(),\r\n      points: this.points.map((p) => p.clone())\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the world position of the collider, which is the current body transform plus any defined offset\r\n   */\r\n  public get worldPos(): Vector {\r\n    if (this._transform) {\r\n      return this._transform.pos.add(this.offset);\r\n    }\r\n    return this.offset;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this.bounds.center;\r\n  }\r\n\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  private _transformedPointsDirty = true;\r\n  /**\r\n   * Calculates the underlying transformation from the body relative space to world space\r\n   */\r\n  private _calculateTransformation() {\r\n    const points = this.points;\r\n    const len = points.length;\r\n    this._transformedPoints.length = 0; // clear out old transform\r\n    for (let i = 0; i < len; i++) {\r\n      this._transformedPoints[i] = this._globalMatrix.multiply(points[i].clone());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the points that make up the polygon in world space, from actor relative space (if specified)\r\n   */\r\n  public getTransformedPoints(): Vector[] {\r\n    if (this._transformedPointsDirty) {\r\n      this._calculateTransformation();\r\n      this._transformedPointsDirty = false;\r\n    }\r\n    return this._transformedPoints;\r\n  }\r\n\r\n  private _sidesDirty = true;\r\n  /**\r\n   * Gets the sides of the polygon in world space\r\n   */\r\n  public getSides(): LineSegment[] {\r\n    if (this._sidesDirty) {\r\n      const lines = [];\r\n      const points = this.getTransformedPoints();\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._sides = lines;\r\n      this._sidesDirty = false;\r\n    }\r\n    return this._sides;\r\n  }\r\n\r\n  private _localSidesDirty = true;\r\n  /**\r\n   * Returns the local coordinate space sides\r\n   */\r\n  public getLocalSides(): LineSegment[] {\r\n    if (this._localSidesDirty) {\r\n      const lines = [];\r\n      const points = this.points;\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._localSides = lines;\r\n      this._localSidesDirty = false;\r\n    }\r\n\r\n    return this._localSides;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the world space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findSide(direction: Vector): LineSegment {\r\n    const sides = this.getSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the local space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findLocalSide(direction: Vector): LineSegment {\r\n    const sides = this.getLocalSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the convex polygon\r\n   */\r\n  public get axes(): Vector[] {\r\n    const axes: Vector[] = [];\r\n    const sides = this.getSides();\r\n    for (let i = 0; i < sides.length; i++) {\r\n      axes.push(sides[i].normal());\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Updates the transform for the collision geometry\r\n   *\r\n   * Collision geometry (points/bounds) will not change until this is called.\r\n   * @param transform\r\n   */\r\n  public update(transform: Transform): void {\r\n    if (transform) {\r\n      this._transform = transform;\r\n      this._transformedPointsDirty = true;\r\n      this._sidesDirty = true;\r\n      // This change means an update must be performed in order for geometry to update\r\n      const globalMat = transform.matrix ?? this._globalMatrix;\r\n      globalMat.clone(this._globalMatrix);\r\n      this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider in world space\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    // Always cast to the right, as long as we cast in a consistent fixed direction we\r\n    // will be fine\r\n    const testRay = new Ray(point, new Vector(1, 0));\r\n    const intersectCount = this.getSides().reduce(function (accum, side) {\r\n      if (testRay.intersect(side) >= 0) {\r\n        return accum + 1;\r\n      }\r\n      return accum;\r\n    }, 0);\r\n\r\n    if (intersectCount % 2 === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getClosestLineBetween(collider: Collider): LineSegment {\r\n    if (collider instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonPolygonClosestLine(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a collision contact if the 2 colliders collide, otherwise collide will\r\n   * return null.\r\n   * @param collider\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(collider, this);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonPolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const pts = this.getTransformedPoints();\r\n    let furthestPoint = null;\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the collider furthest in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const pts = this.points;\r\n    let furthestPoint = pts[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Finds the closes face to the point using perpendicular distance\r\n   * @param point point to test against polygon\r\n   */\r\n  public getClosestFace(point: Vector): { distance: Vector; face: LineSegment } {\r\n    const sides = this.getSides();\r\n    let min = Number.POSITIVE_INFINITY;\r\n    let faceIndex = -1;\r\n    let distance = -1;\r\n    for (let i = 0; i < sides.length; i++) {\r\n      const dist = sides[i].distanceToPoint(point);\r\n      if (dist < min) {\r\n        min = dist;\r\n        faceIndex = i;\r\n        distance = dist;\r\n      }\r\n    }\r\n\r\n    if (faceIndex !== -1) {\r\n      return {\r\n        distance: sides[faceIndex].normal().scale(distance),\r\n        face: sides[faceIndex]\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    return this.localBounds.transform(this._globalMatrix);\r\n  }\r\n\r\n  private _localBoundsDirty = true;\r\n  private _localBounds: BoundingBox;\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (this._localBoundsDirty) {\r\n      this._localBounds = BoundingBox.fromPoints(this.points);\r\n      this._localBoundsDirty = false;\r\n    }\r\n\r\n    return this._localBounds;\r\n  }\r\n\r\n  private _cachedMass: number;\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia for an arbitrary polygon\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    if (this._cachedMass === mass && this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n    let numerator = 0;\r\n    let denominator = 0;\r\n    const points = this.points;\r\n    for (let i = 0; i < points.length; i++) {\r\n      const iplusone = (i + 1) % points.length;\r\n      const crossTerm = points[iplusone].cross(points[i]);\r\n      numerator +=\r\n        crossTerm *\r\n        (points[i].dot(points[i]) + points[i].dot(points[iplusone]) + points[iplusone].dot(points[iplusone]));\r\n      denominator += crossTerm;\r\n    }\r\n    this._cachedMass = mass;\r\n    return this._cachedInertia = (mass / 6) * (numerator / denominator);\r\n  }\r\n\r\n  /**\r\n   * Casts a ray into the polygon and returns a vector representing the point of contact (in world space) or null if no collision.\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    // find the minimum contact time greater than 0\r\n    // contact times less than 0 are behind the ray and we don't want those\r\n    const sides = this.getSides();\r\n    const len = sides.length;\r\n    let minContactTime = Number.MAX_VALUE;\r\n    let contactSide: LineSegment;\r\n    let contactIndex = -1;\r\n    for (let i = 0; i < len; i++) {\r\n      const contactTime = ray.intersect(sides[i]);\r\n      if (contactTime >= 0 && contactTime < minContactTime && contactTime <= max) {\r\n        minContactTime = contactTime;\r\n        contactSide = sides[i];\r\n        contactIndex = i;\r\n      }\r\n    }\r\n\r\n    // contact was found\r\n    if (contactIndex >= 0) {\r\n      return {\r\n        collider: this,\r\n        distance: minContactTime,\r\n        body: this.owner?.get(BodyComponent),\r\n        point: ray.getPoint(minContactTime),\r\n        normal: contactSide.normal()\r\n      } satisfies RayCastHit;\r\n    }\r\n\r\n    // no contact found\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Project the edges of the polygon along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const points = this.getTransformedPoints();\r\n    const len = points.length;\r\n    let min = Number.MAX_VALUE;\r\n    let max = -Number.MAX_VALUE;\r\n    for (let i = 0; i < len; i++) {\r\n      const scalar = points[i].dot(axis);\r\n      min = Math.min(min, scalar);\r\n      max = Math.max(max, scalar);\r\n    }\r\n\r\n    return new Projection(min, max);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number, pointSize: number }) {\r\n    const points = this.getTransformedPoints();\r\n    Debug.drawPolygon(points, { color });\r\n  }\r\n}\r\n","import { PolygonCollider } from './PolygonCollider';\nimport { CircleCollider } from './CircleCollider';\nimport { EdgeCollider } from './EdgeCollider';\nimport { BoundingBox } from '../BoundingBox';\nimport { vec, Vector } from '../../Math/vector';\nimport { CompositeCollider } from './CompositeCollider';\nimport { Logger } from '../..';\n\n/**\n * Excalibur helper for defining colliders quickly\n */\nexport class Shape {\n  /**\n   * Creates a box collider, under the hood defines a [[PolygonCollider]] collider\n   * @param width Width of the box\n   * @param height Height of the box\n   * @param anchor Anchor of the box (default (.5, .5)) which positions the box relative to the center of the collider's position\n   * @param offset Optional offset relative to the collider in local coordinates\n   */\n  static Box(width: number, height: number, anchor: Vector = Vector.Half, offset: Vector = Vector.Zero): PolygonCollider {\n    return new PolygonCollider({\n      points: new BoundingBox(-width * anchor.x, -height * anchor.y, width - width * anchor.x, height - height * anchor.y).getPoints(),\n      offset: offset\n    });\n  }\n\n  /**\n   * Creates a new [[PolygonCollider|arbitrary polygon]] collider\n   *\n   * PolygonColliders are useful for creating convex polygon shapes\n   * @param points Points specified in counter clockwise\n   * @param offset Optional offset relative to the collider in local coordinates\n   */\n  static Polygon(points: Vector[], offset: Vector = Vector.Zero, suppressConvexWarning = false): PolygonCollider {\n    return new PolygonCollider({\n      points: points,\n      offset: offset,\n      suppressConvexWarning\n    });\n  }\n\n  /**\n   * Creates a new [[CircleCollider|circle]] collider\n   *\n   * Circle colliders are useful for balls, or to make collisions more forgiving on sharp edges\n   * @param radius Radius of the circle collider\n   * @param offset Optional offset relative to the collider in local coordinates\n   */\n  static Circle(radius: number, offset: Vector = Vector.Zero): CircleCollider {\n    return new CircleCollider({\n      radius: radius,\n      offset: offset\n    });\n  }\n\n  /**\n   * Creates a new [[EdgeCollider|edge]] collider\n   *\n   * Edge colliders are useful for  floors, walls, and other barriers\n   * @param begin Beginning of the edge in local coordinates to the collider\n   * @param end Ending of the edge in local coordinates to the collider\n   */\n  static Edge(begin: Vector, end: Vector): EdgeCollider {\n    return new EdgeCollider({\n      begin: begin,\n      end: end\n    });\n  }\n\n  /**\n   * Creates a new capsule shaped [[CompositeCollider]] using 2 circles and a box\n   *\n   * Capsule colliders are useful for platformers with incline or jagged floors to have a smooth\n   * player experience.\n   * @param width\n   * @param height\n   * @param offset Optional offset\n   */\n  static Capsule(width: number, height: number, offset = Vector.Zero): CompositeCollider {\n    const logger = Logger.getInstance();\n    if (width === height) {\n      logger.warn('A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider');\n    }\n\n    const vertical = height >= width;\n\n    if (vertical) {\n      // height > width, if equal maybe use a circle\n      const capsule = new CompositeCollider([\n        Shape.Circle(width / 2, vec(0, -height / 2 + width / 2).add(offset)),\n        Shape.Box(width, height - width, Vector.Half, offset),\n        Shape.Circle(width / 2, vec(0, height / 2 - width / 2).add(offset))\n      ]);\n      return capsule;\n    } else {\n      // width > height, if equal maybe use a circle\n      const capsule = new CompositeCollider([\n        Shape.Circle(height / 2, vec(-width / 2 + height / 2, 0).add(offset)),\n        Shape.Box(width - height, height, Vector.Half, offset),\n        Shape.Circle(height / 2, vec(width / 2 - height / 2, 0).add(offset))\n      ]);\n      return capsule;\n    }\n  }\n}\n","import { Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { CollisionEndEvent, CollisionStartEvent, PostCollisionEvent, PreCollisionEvent } from '../Events';\r\nimport { Observable } from '../Util/Observable';\r\nimport { BoundingBox } from './BoundingBox';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { CircleCollider } from './Colliders/CircleCollider';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { PolygonCollider } from './Colliders/PolygonCollider';\r\nimport { EdgeCollider } from './Colliders/EdgeCollider';\r\nimport { Shape } from './Colliders/Shape';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { Actor } from '../Actor';\r\n\r\nexport class ColliderComponent extends Component {\r\n\r\n  public events = new EventEmitter();\r\n  /**\r\n   * Observable that notifies when a collider is added to the body\r\n   */\r\n  public $colliderAdded = new Observable<Collider>();\r\n\r\n  /**\r\n   * Observable that notifies when a collider is removed from the body\r\n   */\r\n  public $colliderRemoved = new Observable<Collider>();\r\n\r\n  constructor(collider?: Collider) {\r\n    super();\r\n    this.set(collider);\r\n  }\r\n\r\n  private _collider: Collider;\r\n  /**\r\n   * Get the current collider geometry\r\n   */\r\n  public get() {\r\n    return this._collider;\r\n  }\r\n\r\n  /**\r\n   * Set the collider geometry\r\n   * @param collider\r\n   * @returns the collider you set\r\n   */\r\n  public set<T extends Collider>(collider: T): T {\r\n    this.clear();\r\n    if (collider) {\r\n      this._collider = collider;\r\n      this._collider.owner = this.owner;\r\n      collider.events.pipe(this.events);\r\n      this.$colliderAdded.notifyAll(collider);\r\n      this.update();\r\n    }\r\n    return collider;\r\n  }\r\n\r\n  private _collidersToRemove: Collider[] = [];\r\n  /**\r\n   * Remove collider geometry from collider component\r\n   */\r\n  public clear() {\r\n    if (this._collider) {\r\n      this._collidersToRemove.push(this._collider);\r\n      this._collider = null;\r\n    }\r\n  }\r\n\r\n  public processColliderRemoval() {\r\n    for (const collider of this._collidersToRemove) {\r\n      collider.events.unpipe(this.events);\r\n      this.$colliderRemoved.notifyAll(collider);\r\n      collider.owner = null;\r\n    }\r\n  }\r\n\r\n  public clone(): ColliderComponent {\r\n    const clone = new ColliderComponent(this._collider.clone());\r\n\r\n    return clone;\r\n  }\r\n\r\n  /**\r\n   * Return world space bounds\r\n   */\r\n  public get bounds() {\r\n    return this._collider?.bounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Return local space bounds\r\n   */\r\n  public get localBounds() {\r\n    return this._collider?.localBounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Update the collider's transformed geometry\r\n   */\r\n  public update() {\r\n    const tx = this.owner?.get(TransformComponent);\r\n    if (this._collider) {\r\n      this._collider.owner = this.owner;\r\n      if (tx) {\r\n        this._collider.update(tx.get());\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Collide component with another\r\n   * @param other\r\n   */\r\n  collide(other: ColliderComponent): CollisionContact[] {\r\n    let colliderA = this._collider;\r\n    let colliderB = other._collider;\r\n    if (!colliderA || !colliderB) {\r\n      return [];\r\n    }\r\n\r\n    // If we have a composite left hand side :(\r\n    // Might bite us, but to avoid updating all the handlers make composite always left side\r\n    let flipped = false;\r\n    if (colliderB instanceof CompositeCollider) {\r\n      colliderA = colliderB;\r\n      colliderB = this._collider;\r\n      flipped = true;\r\n    }\r\n\r\n    if (this._collider) {\r\n      const contacts = colliderA.collide(colliderB);\r\n      if (contacts) {\r\n        if (flipped) {\r\n          contacts.forEach((contact) => {\r\n            contact.mtv = contact.mtv.negate();\r\n            contact.normal = contact.normal.negate();\r\n            contact.tangent = contact.normal.perpendicular();\r\n            contact.colliderA = this._collider;\r\n            contact.colliderB = other._collider;\r\n          });\r\n        }\r\n        return contacts;\r\n      }\r\n      return [];\r\n    }\r\n    return [];\r\n  }\r\n\r\n  onAdd(entity: Entity) {\r\n    if (this._collider) {\r\n      this.update();\r\n    }\r\n    // Wire up the collider events to the owning entity\r\n    this.events.on('precollision', (evt: any) => {\r\n      const precollision = evt as PreCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(\r\n          precollision.target.owner,\r\n          precollision.other.owner,\r\n          precollision.side,\r\n          precollision.intersection,\r\n          precollision.contact\r\n        )\r\n      );\r\n      if (entity instanceof Actor) {\r\n        entity.onPreCollisionResolve(precollision.target, precollision.other, precollision.side, precollision.contact);\r\n      }\r\n    });\r\n    this.events.on('postcollision', (evt: any) => {\r\n      const postcollision = evt as PostCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(\r\n          postcollision.target.owner,\r\n          postcollision.other.owner,\r\n          postcollision.side,\r\n          postcollision.intersection,\r\n          postcollision.contact)\r\n      );\r\n      if (entity instanceof Actor) {\r\n        entity.onPostCollisionResolve(postcollision.target, postcollision.other, postcollision.side, postcollision.contact);\r\n      }\r\n    });\r\n    this.events.on('collisionstart', (evt: any) => {\r\n      const start = evt as CollisionStartEvent<Collider>;\r\n      entity.events.emit('collisionstart', new CollisionStartEvent(start.target.owner, start.other.owner, start.side, start.contact));\r\n      if (entity instanceof Actor) {\r\n        entity.onCollisionStart(start.target, start.other, start.side, start.contact);\r\n      }\r\n    });\r\n    this.events.on('collisionend', (evt: any) => {\r\n      const end = evt as CollisionEndEvent<Collider>;\r\n      entity.events.emit('collisionend', new CollisionEndEvent(end.target.owner, end.other.owner, end.side, end.lastContact));\r\n      if (entity instanceof Actor) {\r\n        entity.onCollisionEnd(end.target, end.other, end.side, end.lastContact);\r\n      }\r\n    });\r\n  }\r\n\r\n  onRemove() {\r\n    this.events.clear();\r\n    this.$colliderRemoved.notifyAll(this._collider);\r\n  }\r\n\r\n  /**\r\n   * Sets up a box geometry based on the current bounds of the associated actor of this physics body.\r\n   *\r\n   * If no width/height are specified the body will attempt to use the associated actor's width/height.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useBoxCollider(width: number, height: number, anchor: Vector = Vector.Half, center: Vector = Vector.Zero): PolygonCollider {\r\n    const collider = Shape.Box(width, height, anchor, center);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Sets up a [[PolygonCollider|polygon]] collision geometry based on a list of of points relative\r\n   *  to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * Only [convex polygon](https://en.wikipedia.org/wiki/Convex_polygon) definitions are supported.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  usePolygonCollider(points: Vector[], center: Vector = Vector.Zero): PolygonCollider {\r\n    const poly = Shape.Polygon(points, center);\r\n    return (this.set(poly));\r\n  }\r\n\r\n  /**\r\n   * Sets up a [[Circle|circle collision geometry]] as the only collider with a specified radius in pixels.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useCircleCollider(radius: number, center: Vector = Vector.Zero): CircleCollider {\r\n    const collider = Shape.Circle(radius, center);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Sets up an [[Edge|edge collision geometry]] with a start point and an end point relative to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useEdgeCollider(begin: Vector, end: Vector): EdgeCollider {\r\n    const collider = Shape.Edge(begin, end);\r\n    return (this.set(collider));\r\n  }\r\n\r\n  /**\r\n   * Setups up a [[CompositeCollider]] which can define any arbitrary set of excalibur colliders\r\n   * @param colliders\r\n   */\r\n  useCompositeCollider(colliders: Collider[]): CompositeCollider {\r\n    return (this.set(new CompositeCollider(colliders)));\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { CollisionType } from './CollisionType';\r\nimport { Clonable } from '../Interfaces/Clonable';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { CollisionGroup } from './Group/CollisionGroup';\r\nimport { createId, Id } from '../Id';\r\nimport { clamp } from '../Math/util';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { Transform } from '../Math/transform';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { DefaultPhysicsConfig, PhysicsConfig } from './PhysicsConfig';\r\nimport { DeepRequired } from '../Util/Required';\r\n\r\nexport interface BodyComponentOptions {\r\n  type?: CollisionType;\r\n  group?: CollisionGroup;\r\n  useGravity?: boolean;\r\n  config?: Pick<PhysicsConfig, 'bodies'>['bodies']\r\n}\r\n\r\nexport enum DegreeOfFreedom {\r\n  Rotation = 'rotation',\r\n  X = 'x',\r\n  Y = 'y'\r\n}\r\n\r\n/**\r\n * Body describes all the physical properties pos, vel, acc, rotation, angular velocity for the purpose of\r\n * of physics simulation.\r\n */\r\nexport class BodyComponent extends Component implements Clonable<BodyComponent> {\r\n  public dependencies = [TransformComponent, MotionComponent];\r\n  public static _ID = 0;\r\n  public readonly id: Id<'body'> = createId('body', BodyComponent._ID++);\r\n  public events = new EventEmitter();\r\n\r\n  public oldTransform = new Transform();\r\n\r\n  /**\r\n   * Indicates whether the old transform has been captured at least once for interpolation\r\n   * @internal\r\n   */\r\n  public __oldTransformCaptured: boolean = false;\r\n\r\n  /**\r\n   * Enable or disabled the fixed update interpolation, by default interpolation is on.\r\n   */\r\n  public enableFixedUpdateInterpolate = true;\r\n\r\n  private _bodyConfig: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>;\r\n  private static _DEFAULT_CONFIG: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']> = {\r\n    ...DefaultPhysicsConfig.bodies\r\n  };\r\n  public wakeThreshold: number;\r\n\r\n  constructor(options?: BodyComponentOptions) {\r\n    super();\r\n    if (options) {\r\n      this.collisionType = options.type ?? this.collisionType;\r\n      this.group = options.group ?? this.group;\r\n      this.useGravity = options.useGravity ?? this.useGravity;\r\n      this._bodyConfig = {\r\n        ...DefaultPhysicsConfig.bodies,\r\n        ...options.config\r\n      };\r\n    } else {\r\n      this._bodyConfig = {\r\n        ...DefaultPhysicsConfig.bodies\r\n      };\r\n    }\r\n    this.updatePhysicsConfig(this._bodyConfig);\r\n    this._mass = BodyComponent._DEFAULT_CONFIG.defaultMass;\r\n  }\r\n\r\n  public get matrix() {\r\n    return this.transform.get().matrix;\r\n  }\r\n\r\n  /**\r\n   * Called by excalibur to update physics config defaults if they change\r\n   * @param config\r\n   */\r\n  public updatePhysicsConfig(config: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>) {\r\n    this._bodyConfig = {\r\n      ...DefaultPhysicsConfig.bodies,\r\n      ...config\r\n    };\r\n    this.canSleep = this._bodyConfig.canSleepByDefault;\r\n    this.sleepMotion =  this._bodyConfig.sleepEpsilon * 5;\r\n    this.wakeThreshold = this._bodyConfig.wakeThreshold;\r\n  }\r\n  /**\r\n   * Called by excalibur to update defaults\r\n   * @param config\r\n   */\r\n  public static updateDefaultPhysicsConfig(config: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>) {\r\n    BodyComponent._DEFAULT_CONFIG = config;\r\n  }\r\n\r\n  /**\r\n   * Collision type for the rigidbody physics simulation, by default [[CollisionType.PreventCollision]]\r\n   */\r\n  public collisionType: CollisionType = CollisionType.PreventCollision;\r\n\r\n  /**\r\n   * The collision group for the body's colliders, by default body colliders collide with everything\r\n   */\r\n  public group: CollisionGroup = CollisionGroup.All;\r\n\r\n  /**\r\n   * The amount of mass the body has\r\n   */\r\n  private _mass: number;\r\n  public get mass(): number {\r\n    return this._mass;\r\n  }\r\n\r\n  public set mass(newMass: number) {\r\n    this._mass = newMass;\r\n    this._cachedInertia = undefined;\r\n    this._cachedInverseInertia = undefined;\r\n  }\r\n\r\n  /**\r\n   * The inverse mass (1/mass) of the body. If [[CollisionType.Fixed]] this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseMass(): number {\r\n    return this.collisionType === CollisionType.Fixed ? 0 : 1 / this.mass;\r\n  }\r\n\r\n  /**\r\n   * Amount of \"motion\" the body has before sleeping. If below [[Physics.sleepEpsilon]] it goes to \"sleep\"\r\n   */\r\n  public sleepMotion: number;\r\n\r\n  /**\r\n   * Can this body sleep, by default bodies do not sleep\r\n   */\r\n  public canSleep: boolean;;\r\n\r\n  private _sleeping = false;\r\n  /**\r\n   * Whether this body is sleeping or not\r\n   */\r\n  public get sleeping(): boolean {\r\n    return this._sleeping;\r\n  }\r\n\r\n  /**\r\n   * Set the sleep state of the body\r\n   * @param sleeping\r\n   */\r\n  public setSleeping(sleeping: boolean) {\r\n    this._sleeping = sleeping;\r\n    if (!sleeping) {\r\n      // Give it a kick to keep it from falling asleep immediately\r\n      this.sleepMotion = this._bodyConfig.sleepEpsilon * 5;\r\n    } else {\r\n      this.vel = Vector.Zero;\r\n      this.acc = Vector.Zero;\r\n      this.angularVelocity = 0;\r\n      this.sleepMotion = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update body's [[BodyComponent.sleepMotion]] for the purpose of sleeping\r\n   */\r\n  public updateMotion() {\r\n    if (this._sleeping) {\r\n      this.setSleeping(true);\r\n    }\r\n    const currentMotion = this.vel.size * this.vel.size + Math.abs(this.angularVelocity * this.angularVelocity);\r\n    const bias = this._bodyConfig.sleepBias;\r\n    this.sleepMotion = bias * this.sleepMotion + (1 - bias) * currentMotion;\r\n    this.sleepMotion = clamp(this.sleepMotion, 0, 10 * this._bodyConfig.sleepEpsilon);\r\n    if (this.canSleep && this.sleepMotion < this._bodyConfig.sleepEpsilon) {\r\n      this.setSleeping(true);\r\n    }\r\n  }\r\n\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia from the [[ColliderComponent]]\r\n   */\r\n  public get inertia() {\r\n    if (this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n\r\n    // Inertia is a property of the geometry, so this is a little goofy but seems to be okay?\r\n    const collider = this.owner.get(ColliderComponent);\r\n    if (collider) {\r\n      collider.$colliderAdded.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      collider.$colliderRemoved.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      const maybeCollider = collider.get();\r\n      if (maybeCollider) {\r\n        return this._cachedInertia = maybeCollider.getInertia(this.mass);\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _cachedInverseInertia: number;\r\n  /**\r\n   * Get the inverse moment of inertial from the [[ColliderComponent]]. If [[CollisionType.Fixed]] this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseInertia() {\r\n    if (this._cachedInverseInertia) {\r\n      return this._cachedInverseInertia;\r\n    }\r\n    return this._cachedInverseInertia = this.collisionType === CollisionType.Fixed ? 0 : 1 / this.inertia;\r\n  }\r\n\r\n  /**\r\n   * The also known as coefficient of restitution of this actor, represents the amount of energy preserved after collision or the\r\n   * bounciness. If 1, it is 100% bouncy, 0 it completely absorbs.\r\n   */\r\n  public bounciness: number = 0.2;\r\n\r\n  /**\r\n   * The coefficient of friction on this actor\r\n   */\r\n  public friction: number = 0.99;\r\n\r\n  /**\r\n   * Should use global gravity [[Physics.gravity]] in it's physics simulation, default is true\r\n   */\r\n  public useGravity: boolean = true;\r\n\r\n  /**\r\n   * Degrees of freedom to limit\r\n   *\r\n   * Note: this only limits responses in the realistic solver, if velocity/angularVelocity is set the actor will still respond\r\n   */\r\n  public limitDegreeOfFreedom: DegreeOfFreedom[] = [];\r\n\r\n  /**\r\n   * Returns if the owner is active\r\n   */\r\n  public get active() {\r\n    return !!this.owner?.active;\r\n  }\r\n\r\n  /**\r\n   * @deprecated Use globalP0s\r\n   */\r\n  public get center() {\r\n    return this.globalPos;\r\n  }\r\n\r\n  public get transform(): TransformComponent {\r\n    return this.owner?.get(TransformComponent);\r\n  }\r\n\r\n  public get motion(): MotionComponent {\r\n    return  this.owner?.get(MotionComponent);\r\n  }\r\n\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this.transform.pos = val;\r\n  }\r\n\r\n  /**\r\n   * The (x, y) position of the actor this will be in the middle of the actor if the\r\n   * [[Actor.anchor]] is set to (0.5, 0.5) which is default.\r\n   * If you want the (x, y) position to be the top left of the actor specify an anchor of (0, 0).\r\n   */\r\n  public get globalPos(): Vector {\r\n    return this.transform.globalPos;\r\n  }\r\n\r\n  public set globalPos(val: Vector) {\r\n    this.transform.globalPos = val;\r\n  }\r\n\r\n  /**\r\n   * The position of the actor last frame (x, y) in pixels\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this.oldTransform.pos;\r\n  }\r\n\r\n  /**\r\n   * The current velocity vector (vx, vy) of the actor in pixels/second\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this.motion.vel = val;\r\n  }\r\n\r\n  /**\r\n   * The velocity of the actor last frame (vx, vy) in pixels/second\r\n   */\r\n  public oldVel: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * The current acceleration vector (ax, ay) of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may\r\n   * be useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  public set acc(val: Vector) {\r\n    this.motion.acc = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public oldAcc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The current torque applied to the actor\r\n   */\r\n  public get torque(): number {\r\n    return this.motion.torque;\r\n  }\r\n\r\n  public set torque(val: number) {\r\n    this.motion.torque = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the rotation of the body from the last frame.\r\n   */\r\n  public get oldRotation(): number {\r\n    return this.oldTransform.rotation;\r\n  }\r\n\r\n  /**\r\n   * The rotation of the body in radians\r\n   */\r\n  public get rotation() {\r\n    return this.transform.globalRotation;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    this.transform.globalRotation = val;\r\n  }\r\n\r\n  /**\r\n   * The scale vector of the actor\r\n   */\r\n  public get scale(): Vector {\r\n    return this.transform.globalScale;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    this.transform.globalScale = val;\r\n  }\r\n\r\n  /**\r\n   * The scale of the actor last frame\r\n   */\r\n  public get oldScale(): Vector {\r\n    return this.oldTransform.scale;\r\n  }\r\n\r\n  /**\r\n   * The scale rate of change of the actor in scale/second\r\n   */\r\n  public get scaleFactor(): Vector {\r\n    return this.motion.scaleFactor;\r\n  }\r\n\r\n  public set scaleFactor(scaleFactor: Vector) {\r\n    this.motion.scaleFactor = scaleFactor;\r\n  }\r\n\r\n  /**\r\n   * Get the angular velocity in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Set the angular velocity in radians/second\r\n   */\r\n  public set angularVelocity(value: number) {\r\n    this.motion.angularVelocity = value;\r\n  }\r\n\r\n  /**\r\n   * Apply a specific impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass);\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel.addEqual(finalImpulse);\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply only linear impulse to the body\r\n   * @param impulse\r\n   */\r\n  public applyLinearImpulse(impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass);\r\n\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel = this.vel.add(finalImpulse);\r\n  }\r\n\r\n  /**\r\n   * Apply only angular impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyAngularImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the old versions of pos, vel, acc, and scale.\r\n   */\r\n  public captureOldTransform() {\r\n    // Capture old values before integration step updates them\r\n    this.__oldTransformCaptured = true;\r\n    const tx = this.transform.get();\r\n    tx.clone(this.oldTransform);\r\n    this.oldTransform.parent = tx.parent; // also grab parent\r\n    this.oldVel.setTo(this.vel.x, this.vel.y);\r\n    this.oldAcc.setTo(this.acc.x, this.acc.y);\r\n  }\r\n\r\n  public clone(): BodyComponent {\r\n    const component = super.clone() as BodyComponent;\r\n    return component;\r\n  }\r\n}\r\n","import { Component, ComponentCtor, isComponentCtor } from './Component';\r\n\r\nimport { Observable, Message } from '../Util/Observable';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate } from '../Interfaces/LifecycleEvents';\r\nimport { Engine } from '../Engine';\r\nimport { InitializeEvent, PreUpdateEvent, PostUpdateEvent } from '../Events';\r\nimport { KillEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { Scene } from '../Scene';\r\nimport { removeItemFromArray } from '../Util/Util';\r\nimport { MaybeKnownComponent } from './Types';\r\n\r\n/**\r\n * Interface holding an entity component pair\r\n */\r\nexport interface EntityComponent {\r\n  component: Component;\r\n  entity: Entity;\r\n}\r\n\r\n/**\r\n * AddedComponent message\r\n */\r\nexport class AddedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Added' = 'Component Added';\r\n  constructor(public data: EntityComponent) { }\r\n}\r\n\r\n/**\r\n * Type guard to know if message is f an Added Component\r\n */\r\nexport function isAddedComponent(x: Message<EntityComponent>): x is AddedComponent {\r\n  return !!x && x.type === 'Component Added';\r\n}\r\n\r\n/**\r\n * RemovedComponent message\r\n */\r\nexport class RemovedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Removed' = 'Component Removed';\r\n  constructor(public data: EntityComponent) { }\r\n}\r\n\r\n/**\r\n * Type guard to know if message is for a Removed Component\r\n */\r\nexport function isRemovedComponent(x: Message<EntityComponent>): x is RemovedComponent {\r\n  return !!x && x.type === 'Component Removed';\r\n}\r\n\r\n/**\r\n * Built in events supported by all entities\r\n */\r\nexport type EntityEvents = {\r\n  'initialize': InitializeEvent;\r\n  'preupdate': PreUpdateEvent;\r\n  'postupdate': PostUpdateEvent;\r\n  'kill': KillEvent\r\n};\r\n\r\nexport const EntityEvents = {\r\n  Initialize: 'initialize',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  Kill: 'kill'\r\n} as const;\r\n\r\nexport interface EntityOptions<TComponents extends Component> {\r\n  name?: string;\r\n  components?: TComponents[];\r\n}\r\n\r\n/**\r\n * An Entity is the base type of anything that can have behavior in Excalibur, they are part of the built in entity component system\r\n *\r\n * Entities can be strongly typed with the components they contain\r\n *\r\n * ```typescript\r\n * const entity = new Entity<ComponentA | ComponentB>();\r\n * entity.components.a; // Type ComponentA\r\n * entity.components.b; // Type ComponentB\r\n * ```\r\n */\r\nexport class Entity<TKnownComponents extends Component = any> implements OnInitialize, OnPreUpdate, OnPostUpdate {\r\n  private static _ID = 0;\r\n  /**\r\n   * The unique identifier for the entity\r\n   */\r\n  public id: number = Entity._ID++;\r\n\r\n  public name = `Entity#${this.id}`;\r\n\r\n  /**\r\n   * Listen to or emit events for an entity\r\n   */\r\n  public events = new EventEmitter<EntityEvents>();\r\n  private _tags = new Set<string>();\r\n  public componentAdded$ = new Observable<Component>;\r\n  public componentRemoved$ = new Observable<Component>;\r\n  public tagAdded$ = new Observable<string>;\r\n  public tagRemoved$ = new Observable<string>;\r\n  /**\r\n   * Current components on the entity\r\n   *\r\n   * **Do not modify**\r\n   *\r\n   * Use addComponent/removeComponent otherwise the ECS will not be notified of changes.\r\n   */\r\n  public readonly components = new Map<Function, Component>();\r\n  private _componentsToRemove: ComponentCtor[] = [];\r\n\r\n  private _instanceOfComponentCacheDirty = true;\r\n  private _instanceOfComponentCache = new Map<Function, Component>();\r\n\r\n  constructor(options: EntityOptions<TKnownComponents>);\r\n  constructor(components?: TKnownComponents[], name?: string);\r\n  constructor(componentsOrOptions?: TKnownComponents[] | EntityOptions<TKnownComponents>, name?: string) {\r\n    let componentsToAdd!: TKnownComponents[];\r\n    let nameToAdd: string | undefined;\r\n    if (Array.isArray(componentsOrOptions)) {\r\n      componentsToAdd = componentsOrOptions;\r\n      nameToAdd = name;\r\n    } else if (componentsOrOptions && typeof componentsOrOptions === 'object') {\r\n      const { components, name } = componentsOrOptions;\r\n      componentsToAdd = components ?? [];\r\n      nameToAdd = name;\r\n    }\r\n    if (nameToAdd) {\r\n      this.name = nameToAdd;\r\n    }\r\n    if (componentsToAdd) {\r\n      for (const component of componentsToAdd) {\r\n        this.addComponent(component);\r\n      }\r\n    }\r\n    // this.addComponent(this.tagsComponent);\r\n  }\r\n\r\n  /**\r\n   * The current scene that the entity is in, if any\r\n   */\r\n  public scene: Scene | null = null;\r\n\r\n  /**\r\n   * Whether this entity is active, if set to false it will be reclaimed\r\n   */\r\n  public active: boolean = true;\r\n\r\n  /**\r\n   * Kill the entity, means it will no longer be updated. Kills are deferred to the end of the update.\r\n   * If parented it will be removed from the parent when killed.\r\n   */\r\n  public kill() {\r\n    if (this.active) {\r\n      this.active = false;\r\n      this.unparent();\r\n    }\r\n    this.emit('kill', new KillEvent(this));\r\n  }\r\n\r\n  public isKilled() {\r\n    return !this.active;\r\n  }\r\n\r\n  /**\r\n   * Specifically get the tags on the entity from [[TagsComponent]]\r\n   */\r\n  public get tags(): Set<string> {\r\n    return this._tags;\r\n  }\r\n\r\n  /**\r\n   * Check if a tag exists on the entity\r\n   * @param tag name to check for\r\n   */\r\n  public hasTag(tag: string): boolean {\r\n    return this._tags.has(tag);\r\n  }\r\n\r\n  /**\r\n   * Adds a tag to an entity\r\n   * @param tag\r\n   */\r\n  public addTag(tag: string): Entity<TKnownComponents> {\r\n    this._tags.add(tag);\r\n    this.tagAdded$.notifyAll(tag);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes a tag on the entity\r\n   *\r\n   * Removals are deferred until the end of update\r\n   * @param tag\r\n   */\r\n  public removeTag(tag: string): Entity<TKnownComponents> {\r\n    this._tags.delete(tag);\r\n    this.tagRemoved$.notifyAll(tag);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * The types of the components on the Entity\r\n   */\r\n  public get types(): ComponentCtor[] {\r\n    return Array.from(this.components.keys()) as ComponentCtor[];\r\n  }\r\n\r\n  /**\r\n   * Returns all component instances on entity\r\n   */\r\n  public getComponents(): Component[] {\r\n    return Array.from(this.components.values());\r\n  }\r\n\r\n  /**\r\n   * Verifies that an entity has all the required types\r\n   * @param requiredTypes\r\n   */\r\n  hasAll<TComponent extends Component>(requiredTypes: ComponentCtor<TComponent>[]): boolean {\r\n    for (let i = 0; i < requiredTypes.length; i++) {\r\n      if (!this.components.has(requiredTypes[i])) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Verifies that an entity has all the required tags\r\n   * @param requiredTags\r\n   */\r\n  hasAllTags(requiredTags: string[]): boolean {\r\n    for (let i = 0; i < requiredTags.length; i++) {\r\n      if (!this.tags.has(requiredTags[i])) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private _getCachedInstanceOfType<TComponent extends Component>(\r\n    type: ComponentCtor<TComponent>): MaybeKnownComponent<TComponent, TKnownComponents> | undefined {\r\n    if (this._instanceOfComponentCacheDirty) {\r\n      this._instanceOfComponentCacheDirty = false;\r\n      this._instanceOfComponentCache.clear();\r\n    }\r\n\r\n    if (this._instanceOfComponentCache.has(type)) {\r\n      return this._instanceOfComponentCache.get(type) as MaybeKnownComponent<TComponent, TKnownComponents>;\r\n    }\r\n\r\n    for (const instance of this.components.values()) {\r\n      if (instance instanceof type) {\r\n        this._instanceOfComponentCache.set(type, instance);\r\n        return instance as MaybeKnownComponent<TComponent, TKnownComponents>;\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  get<TComponent extends Component>(type: ComponentCtor<TComponent>): MaybeKnownComponent<TComponent, TKnownComponents> {\r\n    const maybeComponent = this._getCachedInstanceOfType(type);\r\n    return maybeComponent ?? this.components.get(type) as MaybeKnownComponent<TComponent, TKnownComponents>;\r\n  }\r\n\r\n  private _parent: Entity | null = null;\r\n  public get parent(): Entity | null {\r\n    return this._parent;\r\n  }\r\n\r\n  public childrenAdded$ = new Observable<Entity>();\r\n  public childrenRemoved$ = new Observable<Entity>();\r\n\r\n  private _children: Entity[] = [];\r\n  /**\r\n   * Get the direct children of this entity\r\n   */\r\n  public get children(): readonly Entity[] {\r\n    return this._children;\r\n  }\r\n\r\n  /**\r\n   * Unparents this entity, if there is a parent. Otherwise it does nothing.\r\n   */\r\n  public unparent() {\r\n    if (this._parent) {\r\n      this._parent.removeChild(this);\r\n      this._parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds an entity to be a child of this entity\r\n   * @param entity\r\n   */\r\n  public addChild(entity: Entity): Entity {\r\n    if (entity.parent === null) {\r\n      if (this.getAncestors().includes(entity)) {\r\n        throw new Error('Cycle detected, cannot add entity');\r\n      }\r\n      this._children.push(entity);\r\n      entity._parent = this;\r\n      this.childrenAdded$.notifyAll(entity);\r\n    } else {\r\n      throw new Error('Entity already has a parent, cannot add without unparenting');\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from children if it exists\r\n   * @param entity\r\n   */\r\n  public removeChild(entity: Entity): Entity {\r\n    if (entity.parent === this) {\r\n      removeItemFromArray(entity, this._children);\r\n      entity._parent = null;\r\n      this.childrenRemoved$.notifyAll(entity);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes all children from this entity\r\n   */\r\n  public removeAllChildren(): Entity {\r\n    // Avoid modifying the array issue by walking backwards\r\n    for (let i = this.children.length - 1; i >= 0; i--) {\r\n      this.removeChild(this.children[i]);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a list of parent entities starting with the topmost parent. Includes the current entity.\r\n   */\r\n  public getAncestors(): Entity[] {\r\n    const result: Entity[] = [this];\r\n    let current = this.parent;\r\n    while (current) {\r\n      result.push(current);\r\n      current = current.parent;\r\n    }\r\n    return result.reverse();\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all the entities that descend from this entity. Includes the current entity.\r\n   */\r\n  public getDescendants(): Entity[] {\r\n    let result: Entity[] = [this];\r\n    let queue: Entity[] = [this];\r\n    while (queue.length > 0) {\r\n      const curr = queue.pop();\r\n      if (curr) {\r\n        queue = queue.concat(curr.children);\r\n        result = result.concat(curr.children);\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates a deep copy of the entity and a copy of all its components\r\n   */\r\n  public clone(): Entity {\r\n    const newEntity = new Entity();\r\n    for (const c of this.types) {\r\n      const componentInstance = this.get(c);\r\n      if (componentInstance) {\r\n        newEntity.addComponent(componentInstance.clone());\r\n      }\r\n    }\r\n    for (const child of this.children) {\r\n      newEntity.addChild(child.clone());\r\n    }\r\n    return newEntity;\r\n  }\r\n\r\n  /**\r\n   * Adds a copy of all the components from another template entity as a \"prefab\"\r\n   * @param templateEntity Entity to use as a template\r\n   * @param force Force component replacement if it already exists on the target entity\r\n   */\r\n  public addTemplate(templateEntity: Entity, force: boolean = false): Entity {\r\n    for (const c of templateEntity.getComponents()) {\r\n      this.addComponent(c.clone(), force);\r\n    }\r\n    for (const child of templateEntity.children) {\r\n      this.addChild(child.clone().addTemplate(child));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Adds a component to the entity\r\n   * @param component Component or Entity to add copy of components from\r\n   * @param force Optionally overwrite any existing components of the same type\r\n   */\r\n  public addComponent<TComponent extends Component>(component: TComponent, force: boolean = false): Entity<TKnownComponents | TComponent> {\r\n    this._instanceOfComponentCacheDirty = true;\r\n    // if component already exists, skip if not forced\r\n    if (this.has(component.constructor as ComponentCtor)) {\r\n      if (force) {\r\n        // Remove existing component type if exists when forced\r\n        this.removeComponent(component.constructor as ComponentCtor, true);\r\n      } else {\r\n        // early exit component exits\r\n        return this as Entity<TKnownComponents | TComponent>;\r\n      }\r\n    }\r\n\r\n    // TODO circular dependencies will be a problem\r\n    if (component.dependencies && component.dependencies.length) {\r\n      for (const ctor of component.dependencies) {\r\n        this.addComponent(new ctor());\r\n      }\r\n    }\r\n\r\n    component.owner = this;\r\n    this.components.set(component.constructor, component);\r\n    if (component.onAdd) {\r\n      component.onAdd(this);\r\n    }\r\n\r\n    this.componentAdded$.notifyAll(component);\r\n    return this as Entity<TKnownComponents | TComponent>;\r\n  }\r\n\r\n  /**\r\n   * Removes a component from the entity, by default removals are deferred to the end of entity update to avoid consistency issues\r\n   *\r\n   * Components can be force removed with the `force` flag, the removal is not deferred and happens immediately\r\n   * @param typeOrInstance\r\n   * @param force\r\n   */\r\n  public removeComponent<TComponent extends Component>(\r\n    typeOrInstance: ComponentCtor<TComponent> | TComponent, force = false): Entity<Exclude<TKnownComponents, TComponent>> {\r\n\r\n    let type: ComponentCtor<TComponent>;\r\n    if (isComponentCtor(typeOrInstance)) {\r\n      type = typeOrInstance;\r\n    } else {\r\n      type = typeOrInstance.constructor as ComponentCtor<TComponent>;\r\n    }\r\n\r\n    if (force) {\r\n      const componentToRemove = this.components.get(type);\r\n      if (componentToRemove) {\r\n        this.componentRemoved$.notifyAll(componentToRemove);\r\n        componentToRemove.owner = undefined;\r\n        if (componentToRemove.onRemove) {\r\n          componentToRemove.onRemove(this);\r\n        }\r\n      }\r\n      this.components.delete(type); // remove after the notify to preserve typing\r\n      this._instanceOfComponentCacheDirty = true;\r\n    } else {\r\n      this._componentsToRemove.push(type);\r\n    }\r\n\r\n    return this as any;\r\n  }\r\n\r\n  public clearComponents() {\r\n    const components = this.types;\r\n    for (const c of components) {\r\n      this.removeComponent(c);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @hidden\r\n   * @internal\r\n   */\r\n  public processComponentRemoval() {\r\n    for (const type of this._componentsToRemove) {\r\n      this.removeComponent(type, true);\r\n    }\r\n    this._componentsToRemove.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Check if a component type exists\r\n   * @param type\r\n   */\r\n  public has<TComponent extends Component>(type: ComponentCtor<TComponent>): boolean {\r\n    return this.components.has(type);\r\n  }\r\n\r\n  private _isInitialized = false;\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  /**\r\n   * Initializes this entity, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the entity. This method is meant to be\r\n   * overridden.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an entity is updated.\r\n   */\r\n  public onPreUpdate(engine: Engine, delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an entity is updated.\r\n   */\r\n  public onPostUpdate(engine: Engine, delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   *\r\n   * Entity update lifecycle, called internally\r\n   * @internal\r\n   * @param engine\r\n   * @param delta\r\n   */\r\n  public update(engine: Engine, delta: number): void {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, delta);\r\n    for (const child of this.children) {\r\n      child.update(engine, delta);\r\n    }\r\n    this._postupdate(engine, delta);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, event: EntityEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    if (handler) {\r\n      this.events.off(eventName, handler);\r\n    } else {\r\n      this.events.off(eventName);\r\n    }\r\n  }\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { GetSpriteOptions, SpriteSheet } from './SpriteSheet';\r\nimport { Logger } from '../Util/Log';\r\nimport { clamp } from '../Math/util';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport interface HasTick {\r\n  /**\r\n   *\r\n   * @param elapsedMilliseconds The amount of real world time in milliseconds that has elapsed that must be updated in the animation\r\n   * @param idempotencyToken Optional idempotencyToken prevents a ticking animation from updating twice per frame\r\n   */\r\n  tick(elapsedMilliseconds: number, idempotencyToken?: number): void;\r\n}\r\n\r\nexport enum AnimationDirection {\r\n  /**\r\n   * Animation is playing forwards\r\n   */\r\n  Forward = 'forward',\r\n  /**\r\n   * Animation is playing backwards\r\n   */\r\n  Backward = 'backward'\r\n}\r\n\r\nexport enum AnimationStrategy {\r\n  /**\r\n   * Animation ends without displaying anything\r\n   */\r\n  End = 'end',\r\n  /**\r\n   * Animation loops to the first frame after the last frame\r\n   */\r\n  Loop = 'loop',\r\n  /**\r\n   * Animation plays to the last frame, then backwards to the first frame, then repeats\r\n   */\r\n  PingPong = 'pingpong',\r\n  /**\r\n   * Animation ends stopping on the last frame\r\n   */\r\n  Freeze = 'freeze'\r\n}\r\n\r\n/**\r\n * Frame of animation\r\n */\r\nexport interface Frame {\r\n  /**\r\n   * Optionally specify a graphic to show, no graphic shows an empty frame\r\n   */\r\n  graphic?: Graphic;\r\n  /**\r\n   * Optionally specify the number of ms the frame should be visible, overrides the animation duration (default 100 ms)\r\n   */\r\n  duration?: number;\r\n}\r\n\r\nexport interface FrameEvent extends Frame {\r\n  frameIndex: number;\r\n}\r\n\r\n/**\r\n * Animation options for building an animation via constructor.\r\n */\r\nexport interface AnimationOptions {\r\n  /**\r\n   * List of frames in the order you wish to play them\r\n   */\r\n  frames: Frame[];\r\n  /**\r\n   * Optionally set a positive speed multiplier on the animation.\r\n   *\r\n   * By default 1, meaning 1x speed. If set to 2, it will play the animation twice as fast.\r\n   */\r\n  speed?: number;\r\n  /**\r\n   * Optionally reverse the direction of play\r\n   */\r\n  reverse?: boolean;\r\n  /**\r\n   * Optionally specify a default frame duration in ms (Default is 100)\r\n   */\r\n  frameDuration?: number;\r\n  /**\r\n   * Optionally specify a total duration of the animation in ms to calculate each frame's duration\r\n   */\r\n  totalDuration?: number;\r\n  /**\r\n   * Optionally specify the [[AnimationStrategy]] for the Animation\r\n   */\r\n  strategy?: AnimationStrategy;\r\n}\r\n\r\nexport type AnimationEvents = {\r\n  frame: FrameEvent;\r\n  loop: Animation;\r\n  end: Animation;\r\n};\r\n\r\nexport const AnimationEvents = {\r\n  Frame: 'frame',\r\n  Loop: 'loop',\r\n  End: 'end'\r\n};\r\n\r\nexport interface FromSpriteSheetOptions {\r\n  /**\r\n   * [[SpriteSheet]] to source the animation frames from\r\n   */\r\n  spriteSheet: SpriteSheet;\r\n  /**\r\n   * The list of (x, y) positions of sprites in the [[SpriteSheet]] of each frame, for example (0, 0)\r\n   * is the the top left sprite, (0, 1) is the sprite directly below that, and so on.\r\n   *\r\n   * You may optionally specify a duration for the frame in milliseconds as well, this will override\r\n   * the default duration.\r\n   */\r\n  frameCoordinates: {x: number, y: number, duration?: number, options?: GetSpriteOptions}[];\r\n  /**\r\n   * Optionally specify a default duration for frames in milliseconds\r\n   */\r\n  durationPerFrameMs?: number;\r\n  /**\r\n   * Optionally set a positive speed multiplier on the animation.\r\n   *\r\n   * By default 1, meaning 1x speed. If set to 2, it will play the animation twice as fast.\r\n   */\r\n  speed?: number;\r\n  /**\r\n   * Optionally specify the animation strategy for this animation, by default animations loop [[AnimationStrategy.Loop]]\r\n   */\r\n  strategy?: AnimationStrategy\r\n  /**\r\n   * Optionally specify the animation should be reversed\r\n   */\r\n  reverse?: boolean;\r\n}\r\n\r\n/**\r\n * Create an Animation given a list of [[Frame|frames]] in [[AnimationOptions]]\r\n *\r\n * To create an Animation from a [[SpriteSheet]], use [[Animation.fromSpriteSheet]]\r\n */\r\nexport class Animation extends Graphic implements HasTick {\r\n  private static _LOGGER = Logger.getInstance();\r\n  public events = new EventEmitter<AnimationEvents>();\r\n  public frames: Frame[] = [];\r\n  public strategy: AnimationStrategy = AnimationStrategy.Loop;\r\n  public frameDuration: number = 100;\r\n\r\n  private _idempotencyToken = -1;\r\n\r\n  private _firstTick = true;\r\n  private _currentFrame = 0;\r\n  private _timeLeftInFrame = 0;\r\n  private _pingPongDirection = 1;\r\n  private _done = false;\r\n  private _playing = true;\r\n  private _speed = 1;\r\n\r\n  constructor(options: GraphicOptions & AnimationOptions) {\r\n    super(options);\r\n    this.frames = options.frames;\r\n    this.speed = options.speed ?? this.speed;\r\n    this.strategy = options.strategy ?? this.strategy;\r\n    this.frameDuration = options.totalDuration ? options.totalDuration / this.frames.length : options.frameDuration ?? this.frameDuration;\r\n    if (options.reverse) {\r\n      this.reverse();\r\n    }\r\n    this.goToFrame(0);\r\n  }\r\n\r\n  public clone(): Animation {\r\n    return new Animation({\r\n      frames: this.frames.map((f) => ({ ...f })),\r\n      frameDuration: this.frameDuration,\r\n      speed: this.speed,\r\n      reverse: this._reversed,\r\n      strategy: this.strategy,\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame) {\r\n      return Math.abs(maybeFrame.graphic.width * this.scale.x);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  public override get height(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame) {\r\n      return Math.abs(maybeFrame.graphic.height * this.scale.y);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n\r\n  /**\r\n   * Create an Animation from a [[SpriteSheet]], a list of indices into the sprite sheet, a duration per frame\r\n   * and optional [[AnimationStrategy]]\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const spriteSheet = SpriteSheet.fromImageSource({...});\r\n   *\r\n   * const anim = Animation.fromSpriteSheet(spriteSheet, range(0, 5), 200, AnimationStrategy.Loop);\r\n   * ```\r\n   * @param spriteSheet\r\n   * @param frameIndices\r\n   * @param durationPerFrameMs\r\n   * @param strategy\r\n   */\r\n  public static fromSpriteSheet(\r\n    spriteSheet: SpriteSheet,\r\n    frameIndices: number[],\r\n    durationPerFrameMs: number,\r\n    strategy: AnimationStrategy = AnimationStrategy.Loop\r\n  ): Animation {\r\n    const maxIndex = spriteSheet.sprites.length - 1;\r\n    const invalidIndices = frameIndices.filter((index) => index < 0 || index > maxIndex);\r\n    if (invalidIndices.length) {\r\n      Animation._LOGGER.warn(\r\n        `Indices into SpriteSheet were provided that don\\'t exist: ${invalidIndices.join(',')} no frame will be shown`\r\n      );\r\n    }\r\n    return new Animation({\r\n      frames: spriteSheet.sprites\r\n        .filter((_, index) => frameIndices.indexOf(index) > -1)\r\n        .map((f) => ({\r\n          graphic: f,\r\n          duration: durationPerFrameMs\r\n        })),\r\n      strategy: strategy\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create an [[Animation]] from a [[SpriteSheet]] given a list of coordinates\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const spriteSheet = SpriteSheet.fromImageSource({...});\r\n   *\r\n   * const anim = Animation.fromSpriteSheetCoordinates({\r\n   *  spriteSheet,\r\n   *  frameCoordinates: [\r\n   *    {x: 0, y: 5, duration: 100, options { flipHorizontal: true }},\r\n   *    {x: 1, y: 5, duration: 200},\r\n   *    {x: 2, y: 5, duration: 100},\r\n   *    {x: 3, y: 5, duration: 500}\r\n   *  ],\r\n   *  strategy: AnimationStrategy.PingPong\r\n   * });\r\n   * ```\r\n   * @param options\r\n   * @returns Animation\r\n   */\r\n  public static fromSpriteSheetCoordinates(options: FromSpriteSheetOptions): Animation {\r\n    const { spriteSheet, frameCoordinates, durationPerFrameMs, speed, strategy, reverse } = options;\r\n    const defaultDuration = durationPerFrameMs ?? 100;\r\n    const frames: Frame[] = [];\r\n    for (const coord of frameCoordinates) {\r\n      const {x, y, duration, options } = coord;\r\n      const sprite = spriteSheet.getSprite(x, y, options);\r\n      if (sprite) {\r\n        frames.push({\r\n          graphic: sprite,\r\n          duration: duration ?? defaultDuration\r\n        });\r\n      } else {\r\n        Animation._LOGGER.warn(\r\n          `Skipping frame! SpriteSheet does not have coordinate (${x}, ${y}), please check your SpriteSheet to confirm that sprite exists`\r\n        );\r\n      }\r\n    }\r\n\r\n    return new Animation({\r\n      frames,\r\n      strategy,\r\n      speed,\r\n      reverse\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Current animation speed\r\n   *\r\n   * 1 meaning normal 1x speed.\r\n   * 2 meaning 2x speed and so on.\r\n   */\r\n  public get speed(): number {\r\n    return this._speed;\r\n  }\r\n\r\n  /**\r\n   * Current animation speed\r\n   *\r\n   * 1 meaning normal 1x speed.\r\n   * 2 meaning 2x speed and so on.\r\n   */\r\n  public set speed(val: number) {\r\n    this._speed = clamp(Math.abs(val), 0, Infinity);\r\n  }\r\n\r\n  /**\r\n   * Returns the current Frame of the animation\r\n   *\r\n   * Use [[Animation.currentFrameIndex]] to get the frame number and\r\n   * [[Animation.goToFrame]] to set the current frame index\r\n   */\r\n  public get currentFrame(): Frame | null {\r\n    if (this._currentFrame >= 0 && this._currentFrame < this.frames.length) {\r\n      return this.frames[this._currentFrame];\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the current frame index of the animation\r\n   *\r\n   * Use [[Animation.currentFrame]] to grab the current [[Frame]] object\r\n   */\r\n  public get currentFrameIndex(): number {\r\n    return this._currentFrame;\r\n  }\r\n\r\n  /**\r\n   * Returns the amount of time in milliseconds left in the current frame\r\n   */\r\n  public get currentFrameTimeLeft(): number {\r\n    return this._timeLeftInFrame;\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is playing\r\n   */\r\n  public get isPlaying(): boolean {\r\n    return this._playing;\r\n  }\r\n\r\n  private _reversed = false;\r\n  /**\r\n   * Reverses the play direction of the Animation, this preserves the current frame\r\n   */\r\n  public reverse(): void {\r\n    // Don't mutate with the original frame list, create a copy\r\n    this.frames = this.frames.slice().reverse();\r\n    this._reversed = !this._reversed;\r\n  }\r\n\r\n  /**\r\n   * Returns the current play direction of the animation\r\n   */\r\n  public get direction(): AnimationDirection {\r\n    // Keep logically consistent with ping-pong direction\r\n    // If ping-pong is forward = 1 and reversed is true then we are logically reversed\r\n    const reversed = (this._reversed && this._pingPongDirection === 1) ? true : false;\r\n    return reversed ? AnimationDirection.Backward : AnimationDirection.Forward;\r\n  }\r\n\r\n  /**\r\n   * Plays or resumes the animation from the current frame\r\n   */\r\n  public play(): void {\r\n    this._playing = true;\r\n  }\r\n\r\n  /**\r\n   * Pauses the animation on the current frame\r\n   */\r\n  public pause(): void {\r\n    this._playing = false;\r\n    this._firstTick = true; // firstTick must be set to emit the proper frame event\r\n  }\r\n\r\n  /**\r\n   * Reset the animation back to the beginning, including if the animation were done\r\n   */\r\n  public reset(): void {\r\n    this._done = false;\r\n    this._firstTick = true;\r\n    this._currentFrame = 0;\r\n    this._timeLeftInFrame = this.frameDuration;\r\n    const maybeFrame = this.frames[this._currentFrame];\r\n    if (maybeFrame) {\r\n      this._timeLeftInFrame = (maybeFrame?.duration || this.frameDuration);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation can end\r\n   */\r\n  public get canFinish(): boolean {\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.End:\r\n      case AnimationStrategy.Freeze: {\r\n        return true;\r\n      }\r\n      default: {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is done, for looping type animations\r\n   * `ex.AnimationStrategy.PingPong` and `ex.AnimationStrategy.Loop` this will always return `false`\r\n   *\r\n   * See the `ex.Animation.canFinish()` method to know if an animation type can end\r\n   */\r\n  public get done(): boolean {\r\n    return this._done;\r\n  }\r\n\r\n  /**\r\n   * Jump the animation immediately to a specific frame if it exists\r\n   *\r\n   * Optionally specify an override for the duration of the frame, useful for\r\n   * keeping multiple animations in sync with one another.\r\n   * @param frameNumber\r\n   * @param duration\r\n   */\r\n  public goToFrame(frameNumber: number, duration?: number) {\r\n    this._currentFrame = frameNumber;\r\n    this._timeLeftInFrame = duration ?? this.frameDuration;\r\n    const maybeFrame = this.frames[this._currentFrame];\r\n    if (maybeFrame && !this._done) {\r\n      this._timeLeftInFrame = duration ?? (maybeFrame?.duration || this.frameDuration);\r\n      this.events.emit('frame', {...maybeFrame, frameIndex: this.currentFrameIndex });\r\n    }\r\n  }\r\n\r\n  private _nextFrame(): number {\r\n    const currentFrame = this._currentFrame;\r\n    if (this._done) {\r\n      return currentFrame;\r\n    }\r\n    let next = -1;\r\n\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.Loop: {\r\n        next = (currentFrame + 1) % this.frames.length;\r\n        if (next === 0) {\r\n          this.events.emit('loop', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.End: {\r\n        next = currentFrame + 1;\r\n        if (next >= this.frames.length) {\r\n          this._done = true;\r\n          this._currentFrame = this.frames.length;\r\n          this.events.emit('end', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.Freeze: {\r\n        next = clamp(currentFrame + 1, 0, this.frames.length - 1);\r\n        if (next >= this.frames.length - 1) {\r\n          this._done = true;\r\n          this.events.emit('end', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.PingPong: {\r\n        if (currentFrame + this._pingPongDirection >= this.frames.length) {\r\n          this._pingPongDirection = -1;\r\n          this.events.emit('loop', this);\r\n        }\r\n\r\n        if (currentFrame + this._pingPongDirection < 0) {\r\n          this._pingPongDirection = 1;\r\n          this.events.emit('loop', this);\r\n        }\r\n\r\n        next = currentFrame + (this._pingPongDirection % this.frames.length);\r\n        break;\r\n      }\r\n    }\r\n    return next;\r\n  }\r\n\r\n  /**\r\n   * Called internally by Excalibur to update the state of the animation potential update the current frame\r\n   * @param elapsedMilliseconds Milliseconds elapsed\r\n   * @param idempotencyToken Prevents double ticking in a frame by passing a unique token to the frame\r\n   */\r\n  public tick(elapsedMilliseconds: number, idempotencyToken: number = 0): void {\r\n    if (this._idempotencyToken === idempotencyToken) {\r\n      return;\r\n    }\r\n    this._idempotencyToken = idempotencyToken;\r\n    if (!this._playing) {\r\n      return;\r\n    }\r\n\r\n    // if it's the first frame emit frame event\r\n    if (this._firstTick) {\r\n      this._firstTick = false;\r\n      this.events.emit('frame', {...this.currentFrame, frameIndex: this.currentFrameIndex });\r\n    }\r\n\r\n    this._timeLeftInFrame -= elapsedMilliseconds * this._speed;\r\n    if (this._timeLeftInFrame <= 0) {\r\n      this.goToFrame(this._nextFrame());\r\n    }\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, x: number, y: number) {\r\n    if (this.currentFrame) {\r\n      this.currentFrame.graphic.draw(ctx, x, y);\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\nimport { Graphic, GraphicOptions } from './Graphic';\nimport { Animation, HasTick } from './Animation';\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\nimport { BoundingBox } from '../Collision/Index';\nimport { Logger } from '../Util/Log';\n\nexport interface GraphicsGroupingOptions {\n  members: (GraphicsGrouping | Graphic)[];\n  /**\n   * Default true, GraphicsGroup will use the anchor to position all the graphics based on their combined bounds\n   *\n   * Setting to false will ignore anchoring and position the top left of all graphics at the actor's position,\n   * positioning graphics in the group is done with the `offset` property.\n   */\n  useAnchor?: boolean;\n}\n\nexport interface GraphicsGrouping {\n  offset: Vector;\n  graphic: Graphic;\n  /**\n   * Optionally disable this graphics bounds as part of group calculation, default true\n   * if unspecified\n   *\n   * You may want to do this if you're using text because their bounds will affect\n   * the centering of the whole group\n   */\n  useBounds?: boolean;\n}\n\nexport class GraphicsGroup extends Graphic implements HasTick {\n  private _logger = Logger.getInstance();\n  public useAnchor: boolean = true;\n  public members: (GraphicsGrouping | Graphic)[] = [];\n\n  constructor(options: GraphicsGroupingOptions & GraphicOptions) {\n    super(options);\n    this.members = options.members;\n    this.useAnchor = options.useAnchor ?? this.useAnchor;\n    this._updateDimensions();\n  }\n\n  public clone(): GraphicsGroup {\n    return new GraphicsGroup({\n      members: [...this.members],\n      ...this.cloneGraphicOptions()\n    });\n  }\n\n  private _updateDimensions(): BoundingBox {\n    const bb = this.localBounds;\n    this.width = bb.width;\n    this.height = bb.height;\n    return bb;\n  }\n\n  public get localBounds(): BoundingBox {\n    let bb = new BoundingBox();\n    for (const member of this.members) {\n      if (member instanceof Graphic) {\n        bb = member.localBounds.combine(bb);\n      } else {\n        const { graphic, offset: pos, useBounds } = member;\n        const shouldUseBounds = useBounds === undefined ? true : useBounds;\n        if (graphic) {\n          if (shouldUseBounds) {\n            bb = graphic.localBounds.translate(pos).combine(bb);\n          }\n        } else {\n          this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(member)}.`);\n        }\n      }\n    }\n    return bb;\n  }\n\n  private _isAnimationOrGroup(graphic: Graphic): graphic is Animation | GraphicsGroup {\n    return graphic instanceof Animation || graphic instanceof GraphicsGroup;\n  }\n\n  public tick(elapsedMilliseconds: number, idempotencyToken?: number) {\n    for (const member of this.members) {\n      let graphic: Graphic;\n      if (member instanceof Graphic) {\n        graphic = member;\n      } else {\n        graphic = member.graphic;\n      }\n      if (this._isAnimationOrGroup(graphic)) {\n        graphic.tick(elapsedMilliseconds, idempotencyToken);\n      }\n    }\n  }\n\n  public reset() {\n    for (const member of this.members) {\n      let graphic: Graphic;\n      if (member instanceof Graphic) {\n        graphic = member;\n      } else {\n        graphic = member.graphic;\n      }\n      if (this._isAnimationOrGroup(graphic)) {\n        graphic.reset();\n      }\n    }\n  }\n\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number) {\n    this._updateDimensions();\n    super._preDraw(ex, this.useAnchor ? x : 0, this.useAnchor ? y : 0);\n  }\n\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\n    const pos = Vector.Zero;\n    for (const member of this.members) {\n      let graphic: Graphic;\n      if (member instanceof Graphic) {\n        graphic = member;\n      } else {\n        graphic = member.graphic;\n        member.offset.clone(pos);\n      }\n      if (!graphic) {\n        continue;\n      }\n      ex.save();\n      ex.translate(x, y);\n      graphic.draw(ex, pos.x, pos.y);\n      if (this.showDebug) {\n        /* istanbul ignore next */\n        ex.debug.drawRect(0, 0, this.width, this.height);\n      }\n      ex.restore();\n    }\n  }\n}\n","import { Vector, vec } from '../Math/vector';\r\nimport { Graphic } from './Graphic';\r\nimport { HasTick } from './Animation';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Material } from './Context/material';\r\nimport { Logger } from '../Util/Log';\r\nimport { WatchVector } from '../Math/watch-vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { GraphicsGroup } from '../Graphics/GraphicsGroup';\r\n\r\n/**\r\n * Type guard for checking if a Graphic HasTick (used for graphics that change over time like animations)\r\n * @param graphic\r\n */\r\nexport function hasGraphicsTick(graphic: Graphic): graphic is Graphic & HasTick {\r\n  return !!(graphic as unknown as HasTick).tick;\r\n}\r\nexport interface GraphicsShowOptions {\r\n  offset?: Vector;\r\n  anchor?: Vector;\r\n}\r\n\r\nexport interface GraphicsComponentOptions {\r\n  onPostDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPreDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPreTransformDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPostTransformDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Name of current graphic to use\r\n   */\r\n  current?: string;\r\n\r\n  /**\r\n   * Optionally set a material to use on the graphic\r\n   */\r\n  material?: Material;\r\n\r\n  /**\r\n   * Optionally copy instances of graphics by calling .clone(), you may set this to false to avoid sharing graphics when added to the\r\n   * component for performance reasons. By default graphics are not copied and are shared when added to the component.\r\n   */\r\n  copyGraphics?: boolean;\r\n\r\n  /**\r\n   * Optional visible flag, if the graphics component is not visible it will not be displayed\r\n   */\r\n  visible?: boolean;\r\n\r\n  /**\r\n   * Optional opacity\r\n   */\r\n  opacity?: number;\r\n\r\n  /**\r\n   * List of graphics and optionally the options per graphic\r\n   */\r\n  graphics?: { [graphicName: string]: Graphic | { graphic: Graphic, options: GraphicsShowOptions } };\r\n\r\n  /**\r\n   * Optional offset in absolute pixels to shift all graphics in this component from each graphic's anchor (default is top left corner)\r\n   */\r\n  offset?: Vector;\r\n\r\n  /**\r\n   * Optional anchor\r\n   */\r\n  anchor?: Vector;\r\n}\r\n\r\n/**\r\n * Component to manage drawings, using with the position component\r\n */\r\nexport class GraphicsComponent extends Component {\r\n  private _logger = Logger.getInstance();\r\n\r\n  private _current: string = 'default';\r\n  private _graphics: Record<string, Graphic> = {};\r\n  private _options: Record<string, GraphicsShowOptions> = {};\r\n\r\n  public material: Material | null = null;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, but before graphics component graphics have been drawn\r\n   */\r\n  public onPreDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, and after graphics component graphics has been drawn\r\n   */\r\n  public onPostDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Draws before the entity transform has been applied before any any graphics component drawing\r\n   */\r\n  public onPreTransformDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, and after all graphics component drawing\r\n   */\r\n  public onPostTransformDraw: (ctx: ExcaliburGraphicsContext, elapsedMilliseconds: number) => void;\r\n\r\n  /**\r\n   * Sets or gets wether any drawing should be visible in this component\r\n   */\r\n  public visible: boolean = true;\r\n\r\n  /**\r\n   * Sets or gets wither all drawings should have an opacity applied\r\n   */\r\n  public opacity: number = 1;\r\n\r\n\r\n  private _offset: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Offset to apply to graphics by default\r\n   */\r\n  public get offset(): Vector {\r\n    return new WatchVector(this._offset, () => {\r\n      this.recalculateBounds();\r\n    });\r\n  }\r\n  public set offset(value: Vector) {\r\n    this._offset = value;\r\n    this.recalculateBounds();\r\n  }\r\n\r\n  private _anchor: Vector = Vector.Half;\r\n\r\n  /**\r\n   * Anchor to apply to graphics by default\r\n   */\r\n  public get anchor(): Vector {\r\n    return new WatchVector(this._anchor, () => {\r\n      this.recalculateBounds();\r\n    });\r\n  }\r\n  public set anchor(value: Vector) {\r\n    this._anchor = value;\r\n    this.recalculateBounds();\r\n  }\r\n\r\n  /**\r\n   * Flip all graphics horizontally along the y-axis\r\n   */\r\n  public flipHorizontal: boolean = false;\r\n\r\n  /**\r\n   * Flip all graphics vertically along the x-axis\r\n   */\r\n  public flipVertical: boolean = false;\r\n\r\n  /**\r\n   * If set to true graphics added to the component will be copied. This can effect performance, but is useful if you don't want\r\n   * changes to a graphic to effect all the places it is used.\r\n   */\r\n  public copyGraphics: boolean = false;\r\n\r\n  constructor(options?: GraphicsComponentOptions) {\r\n    super();\r\n    // Defaults\r\n    options = {\r\n      visible: this.visible,\r\n      graphics: {},\r\n      ...options\r\n    };\r\n\r\n    const {\r\n      current,\r\n      anchor,\r\n      opacity,\r\n      visible,\r\n      graphics,\r\n      offset,\r\n      copyGraphics,\r\n      onPreDraw,\r\n      onPostDraw,\r\n      onPreTransformDraw,\r\n      onPostTransformDraw\r\n    } = options;\r\n\r\n    for (const [key, graphicOrOptions] of Object.entries(graphics)) {\r\n      if (graphicOrOptions instanceof Graphic) {\r\n        this._graphics[key] = graphicOrOptions;\r\n      } else {\r\n        this._graphics[key] = graphicOrOptions.graphic;\r\n        this._options[key] = graphicOrOptions.options;\r\n      }\r\n    }\r\n\r\n    this.offset = offset ?? this.offset;\r\n    this.opacity = opacity ?? this.opacity;\r\n    this.anchor = anchor ?? this.anchor;\r\n    this.copyGraphics = copyGraphics ?? this.copyGraphics;\r\n    this.onPreDraw = onPreDraw ?? this.onPreDraw;\r\n    this.onPostDraw = onPostDraw ?? this.onPostDraw;\r\n    this.onPreDraw = onPreTransformDraw ?? this.onPreTransformDraw;\r\n    this.onPostTransformDraw = onPostTransformDraw ?? this.onPostTransformDraw;\r\n    this.visible = !!visible;\r\n    this._current = current ?? this._current;\r\n    if (current && this._graphics[current]) {\r\n      this.use(current);\r\n    }\r\n  }\r\n\r\n  public getGraphic(name: string): Graphic | undefined {\r\n    return this._graphics[name];\r\n  }\r\n  public getOptions(name: string): GraphicsShowOptions | undefined {\r\n    return this._options[name];\r\n  }\r\n\r\n  /**\r\n   * Get registered graphics names\r\n   */\r\n  public getNames(): string[] {\r\n    return Object.keys(this._graphics);\r\n  }\r\n\r\n  /**\r\n   * Returns the currently displayed graphic\r\n   */\r\n  public get current(): Graphic | undefined {\r\n    return this._graphics[this._current];\r\n  }\r\n\r\n  /**\r\n   * Returns the currently displayed graphic offsets\r\n   */\r\n  public get currentOptions(): GraphicsShowOptions | undefined {\r\n    return this._options[this._current];\r\n  }\r\n\r\n  /**\r\n   * Returns all graphics associated with this component\r\n   */\r\n  public get graphics(): { [graphicName: string]: Graphic } {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Returns all graphics options associated with this component\r\n   */\r\n  public get options(): { [graphicName: string]: GraphicsShowOptions } {\r\n    return this._options;\r\n  }\r\n\r\n  /**\r\n   * Adds a named graphic to this component, if the name is \"default\" or not specified, it will be shown by default without needing to call\r\n   * @param graphic\r\n   */\r\n  public add(graphic: Graphic, options?: GraphicsShowOptions): Graphic;\r\n  public add(name: string, graphic: Graphic, options?: GraphicsShowOptions): Graphic;\r\n  public add(nameOrGraphic: string | Graphic, graphicOrOptions?: Graphic | GraphicsShowOptions, options?: GraphicsShowOptions): Graphic {\r\n    let name = 'default';\r\n    let graphicToSet: Graphic = null;\r\n    let optionsToSet: GraphicsShowOptions | undefined = undefined;\r\n    if (typeof nameOrGraphic === 'string' && graphicOrOptions instanceof Graphic) {\r\n      name = nameOrGraphic;\r\n      graphicToSet = graphicOrOptions;\r\n      optionsToSet = options;\r\n    }\r\n    if (nameOrGraphic instanceof Graphic && !(graphicOrOptions instanceof Graphic)) {\r\n      graphicToSet = nameOrGraphic;\r\n      optionsToSet = graphicOrOptions;\r\n    }\r\n\r\n    this._graphics[name] = this.copyGraphics ? graphicToSet.clone() : graphicToSet;\r\n    this._options[name] = this.copyGraphics ? {...optionsToSet} : optionsToSet;\r\n    if (name === 'default') {\r\n      this.use('default');\r\n    }\r\n    return graphicToSet;\r\n  }\r\n\r\n  /**\r\n   * Removes a registered graphic, if the removed graphic is the current it will switch to the default\r\n   * @param name\r\n   */\r\n  public remove(name: string) {\r\n    delete this._graphics[name];\r\n    delete this._options[name];\r\n    if (this._current === name) {\r\n      this._current = 'default';\r\n      this.recalculateBounds();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Shows a graphic, will be removed\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   * @deprecated will be removed in v0.30.0, use `graphics.use(...)`\r\n   */\r\n  public show<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    return this.use(nameOrGraphic, options);\r\n  }\r\n\r\n  /**\r\n   * Use a graphic only, will set the default graphic. Returns the new [[Graphic]]\r\n   *\r\n   * Optionally override the stored options\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   */\r\n  public use<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    if (nameOrGraphic instanceof Graphic) {\r\n      let graphic = nameOrGraphic as Graphic;\r\n      if (this.copyGraphics) {\r\n        graphic = nameOrGraphic.clone();\r\n      }\r\n      this._current = 'default';\r\n      this._graphics[this._current] = graphic;\r\n      this._options[this._current] = options;\r\n    } else {\r\n      this._current = nameOrGraphic;\r\n      this._options[this._current] = options;\r\n      if (!(this._current in this._graphics)) {\r\n        this._logger.warn(\r\n          `Graphic ${this._current} is not registered with the graphics component owned by ${this.owner?.name}. Nothing will be drawn.`);\r\n      }\r\n    }\r\n    this.recalculateBounds();\r\n    return this.current as T;\r\n  }\r\n\r\n  /**\r\n   * Hide currently shown graphic\r\n   */\r\n  public hide(): void {\r\n    this._current = 'ex.none';\r\n  }\r\n\r\n  private _localBounds: BoundingBox = null;\r\n  public set localBounds(bounds: BoundingBox) {\r\n    this._localBounds = bounds;\r\n  }\r\n\r\n  public recalculateBounds() {\r\n    let bb = new BoundingBox();\r\n    const graphic = this._graphics[this._current];\r\n    const options = this._options[this._current];\r\n\r\n    if (!graphic) {\r\n      this._localBounds = bb;\r\n      return;\r\n    }\r\n\r\n    let anchor = this.anchor;\r\n    let offset = this.offset;\r\n    if (options?.anchor) {\r\n      anchor = options.anchor;\r\n    }\r\n    if (options?.offset) {\r\n      offset = options.offset;\r\n    }\r\n    const bounds = graphic.localBounds;\r\n    const offsetX = -bounds.width *  anchor.x + offset.x;\r\n    const offsetY = -bounds.height *  anchor.y + offset.y;\r\n    if (graphic instanceof GraphicsGroup && !graphic.useAnchor) {\r\n      bb = graphic?.localBounds.combine(bb);\r\n    } else {\r\n      bb = graphic?.localBounds.translate(vec(offsetX, offsetY)).combine(bb);\r\n    }\r\n    this._localBounds = bb;\r\n  }\r\n\r\n  /**\r\n   * Get local bounds of graphics component\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (!this._localBounds || this._localBounds.hasZeroDimensions()) {\r\n      this.recalculateBounds();\r\n    }\r\n    return this._localBounds;\r\n  }\r\n\r\n  /**\r\n   * Get world bounds of graphics component\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    let bounds = this.localBounds;\r\n    if (this.owner) {\r\n      const tx = this.owner.get(TransformComponent);\r\n      if (tx) {\r\n        bounds = bounds.transform(tx.get().matrix);\r\n      }\r\n    }\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * Update underlying graphics if necessary, called internally\r\n   * @param elapsed\r\n   * @internal\r\n   */\r\n  public update(elapsed: number, idempotencyToken: number = 0) {\r\n    const graphic = this.current;\r\n    if (graphic && hasGraphicsTick(graphic)) {\r\n      graphic.tick(elapsed, idempotencyToken);\r\n    }\r\n  }\r\n\r\n\r\n  public clone(): GraphicsComponent {\r\n    const graphics = new GraphicsComponent();\r\n    graphics._graphics = { ...this._graphics };\r\n    graphics._options = {... this._options};\r\n    graphics.offset = this.offset.clone();\r\n    graphics.opacity = this.opacity;\r\n    graphics.anchor = this.anchor.clone();\r\n    graphics.copyGraphics = this.copyGraphics;\r\n    graphics.onPreDraw = this.onPreDraw;\r\n    graphics.onPostDraw = this.onPostDraw;\r\n    graphics.visible = this.visible;\r\n\r\n    return graphics;\r\n  }\r\n}\r\n","import { Raster, RasterOptions } from './Raster';\n\nexport interface RectangleOptions {\n  width: number;\n  height: number;\n}\n\n/**\n * A Rectangle [[Graphic]] for drawing rectangles to the [[ExcaliburGraphicsContext]]\n */\nexport class Rectangle extends Raster {\n  constructor(options: RasterOptions & RectangleOptions) {\n    super(options);\n    this.width = options.width;\n    this.height = options.height;\n    this.rasterize();\n  }\n\n  public clone(): Rectangle {\n    return new Rectangle({\n      width: this.width,\n      height: this.height,\n      ...this.cloneGraphicOptions(),\n      ...this.cloneRasterOptions()\n    });\n  }\n\n  execute(ctx: CanvasRenderingContext2D): void {\n    if (this.color) {\n      ctx.fillRect(0, 0, this.width, this.height);\n    }\n    if (this.strokeColor) {\n      ctx.strokeRect(0, 0, this.width, this.height);\n    }\n  }\n}\n","import { ImageFiltering } from './Filtering';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface CircleOptions {\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * A circle [[Graphic]] for drawing circles to the [[ExcaliburGraphicsContext]]\r\n *\r\n * Circles default to [[ImageFiltering.Blended]]\r\n */\r\nexport class Circle extends Raster {\r\n  private _radius: number = 0;\r\n  public get radius() {\r\n    return this._radius;\r\n  }\r\n  public set radius(value: number) {\r\n    this._radius = value;\r\n    this.width = this._radius * 2;\r\n    this.height = this._radius * 2;\r\n    this.flagDirty();\r\n  }\r\n  constructor(options: RasterOptions & CircleOptions) {\r\n    super(options);\r\n    const lineWidth = options.lineWidth ?? (options.strokeColor ? 1 : 0); // default lineWidth in canvas is 1px\r\n    this.padding = options.padding ?? 2 + (lineWidth / 2); // default 2 padding for circles looks nice\r\n    this.radius = options.radius;\r\n    this.filtering = options.filtering ?? ImageFiltering.Blended;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Circle {\r\n    return new Circle({\r\n      radius: this.radius,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.radius > 0) {\r\n      ctx.beginPath();\r\n      ctx.arc(this.radius, this.radius, this.radius, 0, Math.PI * 2);\r\n\r\n      if (this.color) {\r\n        ctx.fill();\r\n      }\r\n\r\n      if (this.strokeColor) {\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { BoundingBox } from '../excalibur';\r\n\r\nexport interface PointerComponentOptions {\r\n  useColliderShape?: boolean;\r\n  useGraphicsBounds?: boolean;\r\n  localBounds?: BoundingBox;\r\n}\r\n\r\n/**\r\n * Add this component to optionally configure how the pointer\r\n * system detects pointer events.\r\n *\r\n * By default the collider shape is used and graphics bounds is not.\r\n *\r\n * If both collider shape and graphics bounds are enabled it will fire events if either or\r\n * are intersecting the pointer.\r\n */\r\nexport class PointerComponent extends Component {\r\n  /**\r\n   * Use any existing Collider component geometry for pointer events. This is useful if you want\r\n   * user pointer events only to trigger on the same collision geometry used in the collider component\r\n   * for collision resolution. Default is `true`.\r\n   */\r\n  public useColliderShape = true;\r\n  /**\r\n   * Use any existing Graphics component bounds for pointers. This is useful if you want the axis aligned\r\n   * bounds around the graphic to trigger pointer events. Default is `true`.\r\n   */\r\n  public useGraphicsBounds = true;\r\n\r\n  /**\r\n   * Optionally use other bounds for pointer testing\r\n   */\r\n  public localBounds?: BoundingBox;\r\n\r\n  constructor(options?: PointerComponentOptions) {\r\n    super();\r\n    this.useColliderShape = options?.useColliderShape ?? this.useColliderShape;\r\n    this.useGraphicsBounds = options?.useGraphicsBounds ?? this.useGraphicsBounds;\r\n    this.localBounds = options?.localBounds;\r\n  }\r\n}","import { Vector } from '../Math/vector';\n\n/**\n * A definition of an EasingFunction. See [[EasingFunctions]].\n */\n// tslint:disable-next-line\nexport interface EasingFunction {\n  (currentTime: number, startValue: number, endValue: number, duration: number): number;\n}\n\n/**\n * Standard easing functions for motion in Excalibur, defined on a domain of [0, duration] and a range from [+startValue,+endValue]\n * Given a time, the function will return a value from positive startValue to positive endValue.\n *\n * ```js\n * function Linear (t) {\n *    return t * t;\n * }\n *\n * // accelerating from zero velocity\n * function EaseInQuad (t) {\n *    return t * t;\n * }\n *\n * // decelerating to zero velocity\n * function EaseOutQuad (t) {\n *    return t * (2 - t);\n * }\n *\n * // acceleration until halfway, then deceleration\n * function EaseInOutQuad (t) {\n *    return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;\n * }\n *\n * // accelerating from zero velocity\n * function EaseInCubic (t) {\n *    return t * t * t;\n * }\n *\n * // decelerating to zero velocity\n * function EaseOutCubic (t) {\n *    return (--t) * t * t + 1;\n * }\n *\n * // acceleration until halfway, then deceleration\n * function EaseInOutCubic (t) {\n *    return t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;\n * }\n * ```\n */\nexport class EasingFunctions {\n  public static CreateReversibleEasingFunction(easing: EasingFunction) {\n    return (time: number, start: number, end: number, duration: number) => {\n      if (end < start) {\n        return start - (easing(time, end, start, duration) - end);\n      } else {\n        return easing(time, start, end, duration);\n      }\n    };\n  }\n\n  public static CreateVectorEasingFunction(easing: EasingFunction) {\n    return (time: number, start: Vector, end: Vector, duration: number) => {\n      return new Vector(easing(time, start.x, end.x, duration), easing(time, start.y, end.y, duration));\n    };\n  }\n\n  public static Linear: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      return (endValue * currentTime) / duration + startValue;\n    }\n  );\n\n  public static EaseInQuad = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration;\n\n      return endValue * currentTime * currentTime + startValue;\n    }\n  );\n\n  public static EaseOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration;\n      return -endValue * currentTime * (currentTime - 2) + startValue;\n    }\n  );\n\n  public static EaseInOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration / 2;\n\n      if (currentTime < 1) {\n        return (endValue / 2) * currentTime * currentTime + startValue;\n      }\n      currentTime--;\n\n      return (-endValue / 2) * (currentTime * (currentTime - 2) - 1) + startValue;\n    }\n  );\n\n  public static EaseInCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration;\n      return endValue * currentTime * currentTime * currentTime + startValue;\n    }\n  );\n\n  public static EaseOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration;\n      currentTime--;\n      return endValue * (currentTime * currentTime * currentTime + 1) + startValue;\n    }\n  );\n\n  public static EaseInOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\n      endValue = endValue - startValue;\n      currentTime /= duration / 2;\n      if (currentTime < 1) {\n        return (endValue / 2) * currentTime * currentTime * currentTime + startValue;\n      }\n      currentTime -= 2;\n      return (endValue / 2) * (currentTime * currentTime * currentTime + 2) + startValue;\n    }\n  );\n}\n","import { ActionCompleteEvent, ActionStartEvent } from '../Events';\nimport { Entity } from '../EntityComponentSystem/Entity';\nimport { Action } from './Action';\n\n/**\n * Action Queues represent an ordered sequence of actions\n *\n * Action queues are part of the [[ActionContext|Action API]] and\n * store the list of actions to be executed for an [[Actor]].\n *\n * Actors implement [[Actor.actions]] which can be manipulated by\n * advanced users to adjust the actions currently being executed in the\n * queue.\n */\nexport class ActionQueue {\n  private _entity: Entity;\n  private _actions: Action[] = [];\n  private _currentAction: Action | null = null;\n  private _completedActions: Action[] = [];\n  constructor(entity: Entity) {\n    this._entity = entity;\n  }\n\n  /**\n   * Add an action to the sequence\n   * @param action\n   */\n  public add(action: Action) {\n    this._actions.push(action);\n  }\n\n  /**\n   * Remove an action by reference from the sequence\n   * @param action\n   */\n  public remove(action: Action) {\n    const index = this._actions.indexOf(action);\n    this._actions.splice(index, 1);\n  }\n\n  /**\n   * Removes all actions from this sequence\n   */\n  public clearActions(): void {\n    this._actions.length = 0;\n    this._completedActions.length = 0;\n    if (this._currentAction) {\n      this._currentAction.stop();\n    }\n  }\n\n  /**\n   *\n   * @returns The total list of actions in this sequence complete or not\n   */\n  public getActions(): Action[] {\n    return this._actions.concat(this._completedActions);\n  }\n\n  /**\n   *\n   * @returns `true` if there are more actions to process in the sequence\n   */\n  public hasNext(): boolean {\n    return this._actions.length > 0;\n  }\n\n  /**\n   * @returns `true` if the current sequence of actions is done\n   */\n  public isComplete(): boolean {\n    return this._actions.length === 0;\n  }\n\n  /**\n   * Resets the sequence of actions, this is used to restart a sequence from the beginning\n   */\n  public reset(): void {\n    this._actions = this.getActions();\n\n    const len = this._actions.length;\n    for (let i = 0; i < len; i++) {\n      this._actions[i].reset();\n    }\n    this._completedActions = [];\n  }\n\n  /**\n   * Update the queue which updates actions and handles completing actions\n   * @param elapsedMs\n   */\n  public update(elapsedMs: number) {\n    if (this._actions.length > 0) {\n      if (this._currentAction !== this._actions[0]) {\n        this._currentAction = this._actions[0];\n        this._entity.emit('actionstart', new ActionStartEvent(this._currentAction, this._entity));\n      }\n\n      this._currentAction.update(elapsedMs);\n\n      if (this._currentAction.isComplete(this._entity)) {\n        this._entity.emit('actioncomplete', new ActionCompleteEvent(this._currentAction, this._entity));\n        const complete = this._actions.shift();\n        if (complete) {\n          this._completedActions.push(complete);\n        }\n      }\n    }\n  }\n}\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\nexport class Repeat implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _repeat: number;\r\n  private _originalRepeat: number;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any, repeat: number) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeat = repeat;\r\n    this._originalRepeat = repeat;\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n    this._repeat--; // current execution is the first repeat\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n      this._repeat--;\r\n    }\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || (this._repeat <= 0 && this._actionQueue.isComplete());\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._repeat = this._originalRepeat;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * RepeatForever Action implementation, it is recommended you use the fluent action\r\n * context API.\r\n *\r\n *\r\n */\r\nexport class RepeatForever implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (this._stopped) {\r\n      return;\r\n    }\r\n\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n    }\r\n\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n    this._actionQueue.clearActions();\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action } from '../Action';\r\n\r\nexport class MoveBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _entity: Entity;\r\n  public x: number;\r\n  public y: number;\r\n  private _distance: number;\r\n  private _speed: number;\r\n\r\n  private _start: Vector;\r\n  private _offset: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, offsetX: number, offsetY: number, speed: number) {\r\n    this._entity = entity;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n    if (speed <= 0) {\r\n      Logger.getInstance().error('Attempted to moveBy with speed less than or equal to zero : ' + speed);\r\n      throw new Error('Speed must be greater than 0 pixels per second');\r\n    }\r\n  }\r\n\r\n  public update(_delta: number) {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._end = this._start.add(this._offset);\r\n      this._distance = this._offset.size;\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n\r\n    if (this.isComplete(this._entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    } else {\r\n      this._motion.vel = this._dir.scale(this._speed);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || tx.pos.distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class MoveTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _distance: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(public entity: Entity, destx: number, desty: number, speed: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = new Vector(destx, desty);\r\n    this._speed = speed;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._distance = this._start.distance(this._end);\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || new Vector(tx.pos.x, tx.pos.y).distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","/**\n * An enum that describes the strategies that rotation actions can use\n */\nexport enum RotationType {\n  /**\n   * Rotation via `ShortestPath` will use the smallest angle\n   * between the starting and ending points. This strategy is the default behavior.\n   */\n  ShortestPath = 0,\n  /**\n   * Rotation via `LongestPath` will use the largest angle\n   * between the starting and ending points.\n   */\n  LongestPath = 1,\n  /**\n   * Rotation via `Clockwise` will travel in a clockwise direction,\n   * regardless of the starting and ending points.\n   */\n  Clockwise = 2,\n  /**\n   * Rotation via `CounterClockwise` will travel in a counterclockwise direction,\n   * regardless of the starting and ending points.\n   */\n  CounterClockwise = 3\n}\n","import { BoundingBox } from '../Collision/BoundingBox';\nimport { Color } from '../Color';\nimport { Vector } from '../Math/vector';\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\n\n/**\n * Enum representing the different font size units\n * https://developer.mozilla.org/en-US/docs/Web/CSS/font-size\n */\nexport enum FontUnit {\n  /**\n   * Em is a scalable unit, 1 em is equal to the current font size of the current element, parent elements can effect em values\n   */\n  Em = 'em',\n  /**\n   * Rem is similar to the Em, it is a scalable unit. 1 rem is equal to the font size of the root element\n   */\n  Rem = 'rem',\n  /**\n   * Pixel is a unit of length in screen pixels\n   */\n  Px = 'px',\n  /**\n   * Point is a physical unit length (1/72 of an inch)\n   */\n  Pt = 'pt',\n  /**\n   * Percent is a scalable unit similar to Em, the only difference is the Em units scale faster when Text-Size stuff\n   */\n  Percent = '%'\n}\n\n/**\n * Enum representing the different horizontal text alignments\n */\nexport enum TextAlign {\n  /**\n   * The text is left-aligned.\n   */\n  Left = 'left',\n  /**\n   * The text is right-aligned.\n   */\n  Right = 'right',\n  /**\n   * The text is centered.\n   */\n  Center = 'center',\n  /**\n   * The text is aligned at the normal start of the line (left-aligned for left-to-right locales,\n   * right-aligned for right-to-left locales).\n   */\n  Start = 'start',\n  /**\n   * The text is aligned at the normal end of the line (right-aligned for left-to-right locales,\n   * left-aligned for right-to-left locales).\n   */\n  End = 'end'\n}\n\n/**\n * Enum representing the different baseline text alignments\n */\nexport enum BaseAlign {\n  /**\n   * The text baseline is the top of the em square.\n   */\n  Top = 'top',\n  /**\n   * The text baseline is the hanging baseline.  Currently unsupported; this will act like\n   * alphabetic.\n   */\n  Hanging = 'hanging',\n  /**\n   * The text baseline is the middle of the em square.\n   */\n  Middle = 'middle',\n  /**\n   * The text baseline is the normal alphabetic baseline.\n   */\n  Alphabetic = 'alphabetic',\n  /**\n   * The text baseline is the ideographic baseline; this is the bottom of\n   * the body of the characters, if the main body of characters protrudes\n   * beneath the alphabetic baseline.  Currently unsupported; this will\n   * act like alphabetic.\n   */\n  Ideographic = 'ideographic',\n  /**\n   * The text baseline is the bottom of the bounding box.  This differs\n   * from the ideographic baseline in that the ideographic baseline\n   * doesn't consider descenders.\n   */\n  Bottom = 'bottom'\n}\n\n/**\n * Enum representing the different possible font styles\n */\nexport enum FontStyle {\n  Normal = 'normal',\n  Italic = 'italic',\n  Oblique = 'oblique'\n}\n\n/**\n * Enum representing the text direction, useful for other languages, or writing text in reverse\n */\nexport enum Direction {\n  LeftToRight = 'ltr',\n  RightToLeft = 'rtl'\n}\n\n/**\n * Font rendering option\n */\nexport interface FontOptions {\n  /**\n   * Optionally the size of the font in the specified [[FontUnit]] by default 10.\n   */\n  size?: number;\n  /**\n   * Optionally specify unit to measure fonts in, by default Pixels\n   */\n  unit?: FontUnit;\n  /**\n   * Optionally specify the font family, by default 'sans-serif'\n   */\n  family?: string;\n  /**\n   * Optionally specify the font style, by default Normal\n   */\n  style?: FontStyle;\n  /**\n   * Optionally set whether the font is bold, by default false\n   */\n  bold?: boolean;\n  /**\n   * Optionally specify the text align, by default Left\n   */\n  textAlign?: TextAlign;\n  /**\n   * Optionally specify the text base align, by default Alphabetic\n   */\n  baseAlign?: BaseAlign;\n  /**\n   * Optionally specify the text direction, by default LeftToRight\n   */\n  direction?: Direction;\n  /**\n   * Optionally override the text line height in pixels, useful for multiline text. If unset will use default.\n   */\n  lineHeight?: number | undefined;\n  /**\n   * Optionally specify the quality of the text bitmap, it is a multiplier on the size size, by default 2.\n   * Higher quality text has a higher memory impact\n   */\n  quality?: number;\n  /**\n   * Optionally specify a text shadow, by default none is specified\n   */\n  shadow?: {\n    blur?: number;\n    offset?: Vector;\n    color?: Color;\n  };\n}\n\n/**\n * @internal\n */\nexport interface FontRenderer {\n  measureText(text: string): BoundingBox;\n  render(ex: ExcaliburGraphicsContext, text: string, color: Color, x: number, y: number): void;\n}\n","import { Action } from '../Action';\r\nimport { RotationType } from '../RotationType';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { TwoPI } from '../../Math/util';\r\n\r\nexport class RotateTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: number;\r\n  private _end: number;\r\n  private _speed: number;\r\n  private _rotationType: RotationType;\r\n  private _direction: number;\r\n  private _distance: number;\r\n  private _shortDistance: number;\r\n  private _longDistance: number;\r\n  private _shortestPathIsPositive: boolean;\r\n  private _currentNonCannonAngle: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angleRadians: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = angleRadians;\r\n    this._speed = speed;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (!this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (_delta / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\nimport { RotationType } from '../RotationType';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { TwoPI } from '../../Math/util';\r\n\r\nexport class RotateBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _start: number;\r\n  private _end: number;\r\n  private _speed: number;\r\n  private _offset: number;\r\n\r\n  private _rotationType: RotationType;\r\n  private _direction: number;\r\n  private _distance: number;\r\n  private _shortDistance: number;\r\n  private _longDistance: number;\r\n  private _shortestPathIsPositive: boolean;\r\n  private _currentNonCannonAngle: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angleRadiansOffset: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = angleRadiansOffset;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      this._end = this._start + this._offset;\r\n\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortDistance >= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (this._shortDistance <= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (_delta / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._start = undefined;\r\n    this._currentNonCannonAngle = undefined;\r\n    this._distance = undefined;\r\n  }\r\n}\r\n","import { vec } from '../../Math/vector';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action } from '../Action';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\n\r\nexport class ScaleTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _startX: number;\r\n  private _startY: number;\r\n  private _endX: number;\r\n  private _endY: number;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  private _distanceX: number;\r\n  private _distanceY: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, scaleX: number, scaleY: number, speedX: number, speedY: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._endX = scaleX;\r\n    this._endY = scaleY;\r\n    this._speedX = speedX;\r\n    this._speedY = speedY;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startX = this._tx.scale.x;\r\n      this._startY = this._tx.scale.y;\r\n      this._distanceX = Math.abs(this._endX - this._startX);\r\n      this._distanceY = Math.abs(this._endY - this._startY);\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.x - this._startX) >= this._distanceX)) {\r\n      const directionX = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.x = this._speedX * directionX;\r\n    } else {\r\n      this._motion.scaleFactor.x = 0;\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.y - this._startY) >= this._distanceY)) {\r\n      const directionY = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.y = this._speedY * directionY;\r\n    } else {\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = vec(this._endX, this._endY);\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.x - this._startX) >= (this._distanceX - 0.01) &&\r\n        Math.abs(this._tx.scale.y - this._startY) >= (this._distanceY - 0.01))\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action } from '../Action';\r\n\r\nexport class ScaleBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _startScale: Vector;\r\n  private _endScale: Vector;\r\n  private _offset: Vector;\r\n  private _distanceX: number;\r\n  private _distanceY: number;\r\n  private _directionX: number;\r\n  private _directionY: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  constructor(entity: Entity, scaleOffsetX: number, scaleOffsetY: number, speed: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._offset = new Vector(scaleOffsetX, scaleOffsetY);\r\n    this._speedX = this._speedY = speed;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startScale = this._tx.scale.clone();\r\n      this._endScale = this._startScale.add(this._offset);\r\n      this._distanceX = Math.abs(this._endScale.x - this._startScale.x);\r\n      this._distanceY = Math.abs(this._endScale.y - this._startScale.y);\r\n      this._directionX = this._endScale.x < this._startScale.x ? -1 : 1;\r\n      this._directionY = this._endScale.y < this._startScale.y ? -1 : 1;\r\n    }\r\n\r\n    this._motion.scaleFactor.x = this._speedX * this._directionX;\r\n    this._motion.scaleFactor.y = this._speedY * this._directionY;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = this._endScale;\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.x - this._startScale.x) >= (this._distanceX - 0.01) &&\r\n        Math.abs(this._tx.scale.y - this._startScale.y) >= (this._distanceY - 0.01))\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\n\r\nexport class CallMethod implements Action {\r\n  private _method: () => any = null;\r\n  private _hasBeenCalled: boolean = false;\r\n  constructor(method: () => any) {\r\n    this._method = method;\r\n  }\r\n\r\n  public update(_delta: number) {\r\n    this._method();\r\n    this._hasBeenCalled = true;\r\n  }\r\n  public isComplete() {\r\n    return this._hasBeenCalled;\r\n  }\r\n  public reset() {\r\n    this._hasBeenCalled = false;\r\n  }\r\n  public stop() {\r\n    this._hasBeenCalled = true;\r\n  }\r\n}\r\n","import { Entity} from '../../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class EaseTo implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    x: number,\r\n    y: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = new Vector(x, y);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += delta;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (delta / 1000), (newY - this._tx.pos.y) / (delta / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class EaseBy implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _offset: Vector;\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    offsetX: number,\r\n    offsetY: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n    this._lerpEnd = this._lerpStart.add(this._offset);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += delta;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (delta / 1000), (newY - this._tx.pos.y) / (delta / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}","import { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\n\r\nexport class Blink implements Action {\r\n  private _graphics: GraphicsComponent;\r\n  private _timeVisible: number = 0;\r\n  private _timeNotVisible: number = 0;\r\n  private _elapsedTime: number = 0;\r\n  private _totalTime: number = 0;\r\n  private _duration: number;\r\n  private _stopped: boolean = false;\r\n  private _started: boolean = false;\r\n  constructor(entity: Entity, timeVisible: number, timeNotVisible: number, numBlinks: number = 1) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._timeVisible = timeVisible;\r\n    this._timeNotVisible = timeNotVisible;\r\n    this._duration = (timeVisible + timeNotVisible) * numBlinks;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._elapsedTime = 0;\r\n      this._totalTime = 0;\r\n    }\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    this._elapsedTime += delta;\r\n    this._totalTime += delta;\r\n    if (this._graphics.visible && this._elapsedTime >= this._timeVisible) {\r\n      this._graphics.visible = false;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (!this._graphics.visible && this._elapsedTime >= this._timeNotVisible) {\r\n      this._graphics.visible = true;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.visible = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._totalTime >= this._duration;\r\n  }\r\n\r\n  public stop(): void {\r\n    if (this._graphics) {\r\n      this._graphics.visible = true;\r\n    }\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset() {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._elapsedTime = 0;\r\n    this._totalTime = 0;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action } from '../Action';\r\n\r\nexport class Fade implements Action {\r\n  private _graphics: GraphicsComponent;\r\n  public x: number;\r\n  public y: number;\r\n\r\n  private _endOpacity: number;\r\n  private _speed: number;\r\n  private _ogspeed: number;\r\n  private _multiplier: number = 1;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, endOpacity: number, speed: number) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._endOpacity = endOpacity;\r\n    this._speed = this._ogspeed = speed;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._speed = this._ogspeed;\r\n\r\n      // determine direction when we start\r\n      if (this._endOpacity < this._graphics.opacity) {\r\n        this._multiplier = -1;\r\n      } else {\r\n        this._multiplier = 1;\r\n      }\r\n    }\r\n\r\n    if (this._speed > 0) {\r\n      this._graphics.opacity += (this._multiplier *\r\n        (Math.abs(this._graphics.opacity - this._endOpacity) * delta)) / this._speed;\r\n    }\r\n\r\n    this._speed -= delta;\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.opacity = this._endOpacity;\r\n    }\r\n\r\n    Logger.getInstance().debug('[Action fade] Actor opacity:', this._graphics.opacity);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || Math.abs(this._graphics.opacity - this._endOpacity) < 0.05;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action } from '../Action';\r\n\r\nexport class Delay implements Action {\r\n  private _elapsedTime: number = 0;\r\n  private _delay: number;\r\n  private _started: boolean = false;\r\n  private _stopped = false;\r\n  constructor(delay: number) {\r\n    this._delay = delay;\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n    }\r\n\r\n    this._elapsedTime += delta;\r\n  }\r\n\r\n  isComplete(): boolean {\r\n    return this._stopped || this._elapsedTime >= this._delay;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  reset(): void {\r\n    this._elapsedTime = 0;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action } from '../Action';\r\nimport { ActionsComponent } from '../ActionsComponent';\r\n\r\nexport class Die implements Action {\r\n  private _entity: Entity;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    this._entity.get(ActionsComponent).clearActions();\r\n    this._entity.kill();\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    return;\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class Follow implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _followTx: TransformComponent;\r\n  private _followMotion: MotionComponent;\r\n\r\n  public x: number;\r\n  public y: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _maximumDistance: number;\r\n  private _distanceBetween: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, entityToFollow: Entity, followDistance?: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._followTx = entityToFollow.get(TransformComponent);\r\n    this._followMotion = entityToFollow.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._maximumDistance = followDistance !== undefined ? followDistance : this._current.distance(this._end);\r\n    this._speed = 0;\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToFollowSpeed = Math.sqrt(Math.pow(this._followMotion.vel.x, 2) + Math.pow(this._followMotion.vel.y, 2));\r\n    if (actorToFollowSpeed !== 0) {\r\n      this._speed = actorToFollowSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    if (this._distanceBetween >= this._maximumDistance) {\r\n      const m = this._dir.scale(this._speed);\r\n      this._motion.vel = vec(m.x, m.y);\r\n    } else {\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    // the actor following should never stop unless specified to do so\r\n    return this._stopped;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Action } from '../Action';\r\n\r\nexport class Meet implements Action {\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _meetTx: TransformComponent;\r\n  private _meetMotion: MotionComponent;\r\n  public x: number;\r\n  public y: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _distanceBetween: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedWasSpecified = false;\r\n\r\n  constructor(actor: Entity, actorToMeet: Entity, speed?: number) {\r\n    this._tx = actor.get(TransformComponent);\r\n    this._motion = actor.get(MotionComponent);\r\n    this._meetTx = actorToMeet.get(TransformComponent);\r\n    this._meetMotion = actorToMeet.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._speed = speed || 0;\r\n\r\n    if (speed !== undefined) {\r\n      this._speedWasSpecified = true;\r\n    }\r\n  }\r\n\r\n  public update(_delta: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToMeetSpeed = Math.sqrt(Math.pow(this._meetMotion.vel.x, 2) + Math.pow(this._meetMotion.vel.y, 2));\r\n    if (actorToMeetSpeed !== 0 && !this._speedWasSpecified) {\r\n      this._speed = actorToMeetSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._distanceBetween <= 1;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._distanceBetween = undefined;\r\n  }\r\n}\r\n","import { RotationType } from './RotationType';\r\n\r\nimport { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { Repeat } from './Action/Repeat';\r\nimport { RepeatForever } from './Action/RepeatForever';\r\nimport { MoveBy } from './Action/MoveBy';\r\nimport { MoveTo } from './Action/MoveTo';\r\nimport { RotateTo } from './Action/RotateTo';\r\nimport { RotateBy } from './Action/RotateBy';\r\nimport { ScaleTo } from './Action/ScaleTo';\r\nimport { ScaleBy } from './Action/ScaleBy';\r\nimport { CallMethod } from './Action/CallMethod';\r\nimport { EaseTo } from './Action/EaseTo';\r\nimport { EaseBy } from './Action/EaseBy';\r\nimport { Blink } from './Action/Blink';\r\nimport { Fade } from './Action/Fade';\r\nimport { Delay } from './Action/Delay';\r\nimport { Die } from './Action/Die';\r\nimport { Follow } from './Action/Follow';\r\nimport { Meet } from './Action/Meet';\r\nimport { Vector } from '../Math/vector';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Action } from './Action';\r\n\r\n/**\r\n * The fluent Action API allows you to perform \"actions\" on\r\n * [[Actor|Actors]] such as following, moving, rotating, and\r\n * more. You can implement your own actions by implementing\r\n * the [[Action]] interface.\r\n */\r\nexport class ActionContext {\r\n  private _entity: Entity;\r\n  private _queue: ActionQueue;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n    this._queue = new ActionQueue(entity);\r\n  }\r\n\r\n  public getQueue(): ActionQueue {\r\n    return this._queue;\r\n  }\r\n\r\n  public update(elapsedMs: number) {\r\n    this._queue.update(elapsedMs);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._queue.clearActions();\r\n  }\r\n\r\n  public runAction(action: Action) {\r\n    action.reset();\r\n    this._queue.add(action);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext\r\n  public easeTo(...args: any[]): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      x = args[0].x;\r\n      y = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      x = args[0];\r\n      y = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseTo(this._entity, x, y, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by a specified vector offset relative to the current position given\r\n   * a duration and a [[EasingFunction]]. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor by a specified x and y offset relative to the current position given\r\n   * a duration and a [[EasingFunction]]. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use [[EasingFunction]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    let offsetX = 0;\r\n    let offsetY = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      offsetX = args[0].x;\r\n      offsetY = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      offsetX = args[0];\r\n      offsetY = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseBy(this._entity, offsetX, offsetY, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPos: number | Vector, yOrSpeed: number, speedOrUndefined?: number | undefined): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let speed = 0;\r\n    if (xOrPos instanceof Vector) {\r\n      x = xOrPos.x;\r\n      y = xOrPos.y;\r\n      speed = yOrSpeed;\r\n    } else {\r\n      x = xOrPos;\r\n      y = yOrSpeed;\r\n      speed = speedOrUndefined;\r\n    }\r\n    this._queue.add(new MoveTo(this._entity, x, y, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(xOffsetOrVector: number | Vector, yOffsetOrSpeed: number, speedOrUndefined?: number | undefined): ActionContext {\r\n    let xOffset = 0;\r\n    let yOffset = 0;\r\n    let speed = 0;\r\n    if (xOffsetOrVector instanceof Vector) {\r\n      xOffset = xOffsetOrVector.x;\r\n      yOffset = xOffsetOrVector.y;\r\n      speed = yOffsetOrSpeed;\r\n    } else {\r\n      xOffset = xOffsetOrVector;\r\n      yOffset = yOffsetOrSpeed;\r\n      speed = speedOrUndefined;\r\n    }\r\n    this._queue.add(new MoveBy(this._entity, xOffset, yOffset, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadians  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The [[RotationType]] to use for this rotation\r\n   */\r\n  public rotateTo(angleRadians: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    this._queue.add(new RotateTo(this._entity, angleRadians, speed, rotationType));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The [[RotationType]] to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    this._queue.add(new RotateBy(this._entity, angleRadiansOffset, speed, rotationType));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(sizeXOrVector: number | Vector,\r\n    sizeYOrSpeed: number | Vector,\r\n    speedXOrUndefined?: number | undefined,\r\n    speedYOrUndefined?: number | undefined): ActionContext {\r\n\r\n    let sizeX = 1;\r\n    let sizeY = 1;\r\n    let speedX = 0;\r\n    let speedY = 0;\r\n\r\n    if (sizeXOrVector instanceof Vector && sizeYOrSpeed instanceof Vector) {\r\n      sizeX = sizeXOrVector.x;\r\n      sizeY = sizeXOrVector.y;\r\n\r\n      speedX = sizeYOrSpeed.x;\r\n      speedY = sizeYOrSpeed.y;\r\n    }\r\n    if (typeof sizeXOrVector === 'number' && typeof sizeYOrSpeed === 'number') {\r\n      sizeX = sizeXOrVector;\r\n      sizeY = sizeYOrSpeed;\r\n\r\n      speedX = speedXOrUndefined;\r\n      speedY = speedYOrUndefined;\r\n    }\r\n\r\n    this._queue.add(new ScaleTo(this._entity, sizeX, sizeY, speedX, speedY));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(sizeOffsetXOrVector: number | Vector, sizeOffsetYOrSpeed: number, speed?: number | undefined): ActionContext {\r\n    let sizeOffsetX = 1;\r\n    let sizeOffsetY = 1;\r\n\r\n    if (sizeOffsetXOrVector instanceof Vector) {\r\n      sizeOffsetX = sizeOffsetXOrVector.x;\r\n      sizeOffsetY = sizeOffsetXOrVector.y;\r\n\r\n      speed = sizeOffsetYOrSpeed;\r\n    }\r\n    if (typeof sizeOffsetXOrVector === 'number' && typeof sizeOffsetYOrSpeed === 'number') {\r\n      sizeOffsetX = sizeOffsetXOrVector;\r\n      sizeOffsetY = sizeOffsetYOrSpeed;\r\n    }\r\n\r\n    this._queue.add(new ScaleBy(this._entity, sizeOffsetX, sizeOffsetY, speed));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks: number = 1): ActionContext {\r\n    this._queue.add(new Blink(this._entity, timeVisible, timeNotVisible, numBlinks));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param time     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, time: number): ActionContext {\r\n    this._queue.add(new Fade(this._entity, opacity, time));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param time  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(time: number): ActionContext {\r\n    this._queue.add(new Delay(time));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    this._queue.add(new Die(this._entity));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    this._queue.add(new CallMethod(method));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    if (!times) {\r\n      this.repeatForever(repeatBuilder);\r\n      return this;\r\n    }\r\n    this._queue.add(new Repeat(this._entity, repeatBuilder, times));\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    this._queue.add(new RepeatForever(this._entity, repeatBuilder));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Entity, followDistance?: number): ActionContext {\r\n    if (followDistance === undefined) {\r\n      this._queue.add(new Follow(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Follow(this._entity, entity, followDistance));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Entity, speed?: number): ActionContext {\r\n    if (speed === undefined) {\r\n      this._queue.add(new Meet(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Meet(this._entity, entity, speed));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    const temp = new Promise<void>((resolve) => {\r\n      this._queue.add(\r\n        new CallMethod(() => {\r\n          resolve();\r\n        })\r\n      );\r\n    });\r\n    return temp;\r\n  }\r\n}\r\n","import { ActionContext } from './ActionContext';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Actor } from '../Actor';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Vector } from '../Math/vector';\r\nimport { EasingFunction } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { RotationType } from './RotationType';\r\nimport { Action } from './Action';\r\n\r\nexport interface ActionContextMethods extends Pick<ActionContext, keyof ActionContext> { };\r\n\r\nexport class ActionsComponent extends Component implements ActionContextMethods {\r\n  dependencies = [TransformComponent, MotionComponent];\r\n  private _ctx: ActionContext | null = null;\r\n\r\n  onAdd(entity: Entity) {\r\n    this._ctx = new ActionContext(entity);\r\n  }\r\n\r\n  onRemove() {\r\n    this._ctx = null;\r\n  }\r\n\r\n  private _getCtx() {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, no context available');\r\n    }\r\n    return this._ctx;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal action queue\r\n   * @returns action queue\r\n   */\r\n  public getQueue(): ActionQueue {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, no queue available');\r\n    }\r\n    return this._ctx.getQueue();\r\n  }\r\n\r\n  public runAction(action: Action): ActionContext {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, cannot run action');\r\n    }\r\n    return this._ctx.runAction(action);\r\n  }\r\n\r\n  /**\r\n   * Updates the internal action context, performing action and moving through the internal queue\r\n   * @param elapsedMs\r\n   */\r\n  public update(elapsedMs: number): void {\r\n    return this._ctx?.update(elapsedMs);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._ctx?.clearActions();\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunctions]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given [[EasingFunctions]] and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use [[EasingFunctions]] or a custom function to use to calculate position, Default is [[EasingFunctions.Linear]]\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeTo(...args: any[]): ActionContext {\r\n    return this._getCtx().easeTo.apply(this._ctx, args as any);\r\n  }\r\n\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    return this._getCtx().easeBy.apply(this._ctx, args as any);\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPos: number | Vector, yOrSpeed: number, speedOrUndefined?: number): ActionContext {\r\n    return this._getCtx().moveTo.apply(this._ctx, [xOrPos, yOrSpeed, speedOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset The (x, y) offset to apply to this actor\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(xOffsetOrVector: number | Vector, yOffsetOrSpeed: number, speedOrUndefined?: number): ActionContext {\r\n    return this._getCtx().moveBy.apply(this._ctx, [xOffsetOrVector, yOffsetOrSpeed, speedOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadians  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The [[RotationType]] to use for this rotation\r\n   */\r\n  public rotateTo(angleRadians: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    return this._getCtx().rotateTo(angleRadians, speed, rotationType);\r\n  }\r\n\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The [[RotationType]] to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext {\r\n    return this._getCtx().rotateBy(angleRadiansOffset, speed, rotationType);\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(\r\n    sizeXOrVector: number | Vector,\r\n    sizeYOrSpeed: number | Vector,\r\n    speedXOrUndefined?: number,\r\n    speedYOrUndefined?: number): ActionContext {\r\n    return this._getCtx().scaleTo.apply(this._ctx, [sizeXOrVector, sizeYOrSpeed, speedXOrUndefined, speedYOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(sizeOffsetXOrVector: number | Vector, sizeOffsetYOrSpeed: number, speed?: number): ActionContext {\r\n    return this._getCtx().scaleBy.apply(this._ctx, [sizeOffsetXOrVector, sizeOffsetYOrSpeed, speed] as any);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks?: number): ActionContext {\r\n    return this._getCtx().blink(timeVisible, timeNotVisible, numBlinks);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param time     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, time: number): ActionContext {\r\n    return this._getCtx().fade(opacity, time);\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param time  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(time: number): ActionContext {\r\n    return this._getCtx().delay(time);\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    return this._getCtx().die();\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    return this._getCtx().callMethod(method);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    return this._getCtx().repeat(repeatBuilder, times);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    return this._getCtx().repeatForever(repeatBuilder);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Actor, followDistance?: number): ActionContext {\r\n    return this._getCtx().follow(entity, followDistance);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Actor, speed?: number): ActionContext {\r\n    return this._getCtx().meet(entity, speed);\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    return this._getCtx().toPromise();\r\n  }\r\n}","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { line } from '../Util/DrawUtil';\r\nimport { ExcaliburGraphicsContextWebGL } from './Context/ExcaliburGraphicsContextWebGL';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Font } from './Font';\r\n\r\nexport class FontTextInstance {\r\n  public canvas: HTMLCanvasElement;\r\n  public ctx: CanvasRenderingContext2D;\r\n  private _textFragments: { x: number; y: number; canvas: HTMLCanvasElement }[] = [];\r\n  public dimensions: BoundingBox;\r\n  public disposed: boolean = false;\r\n  private _lastHashCode: string;\r\n\r\n  constructor(public readonly font: Font, public readonly text: string, public readonly color: Color, public readonly maxWidth?: number) {\r\n    this.canvas = document.createElement('canvas');\r\n    this.ctx = this.canvas.getContext('2d');\r\n    this.dimensions = this.measureText(text);\r\n    this._setDimension(this.dimensions, this.ctx);\r\n    this._lastHashCode = this.getHashCode();\r\n  }\r\n\r\n  measureText(text: string, maxWidth?: number): BoundingBox {\r\n    if (this.disposed) {\r\n      throw Error('Accessing disposed text instance! ' + this.text);\r\n    }\r\n    let lines = null;\r\n    if (maxWidth != null) {\r\n      lines = this._getLinesFromText(text, maxWidth);\r\n    } else {\r\n      lines = text.split('\\n');\r\n    }\r\n\r\n    const maxWidthLine = lines.reduce((a, b) => {\r\n      return a.length > b.length ? a : b;\r\n    });\r\n\r\n    this._applyFont(this.ctx); // font must be applied to the context to measure it\r\n    const metrics = this.ctx.measureText(maxWidthLine);\r\n    let textHeight = Math.abs(metrics.actualBoundingBoxAscent) + Math.abs(metrics.actualBoundingBoxDescent);\r\n\r\n    // TODO line height makes the text bounds wonky\r\n    const lineAdjustedHeight = textHeight * lines.length;\r\n    textHeight = lineAdjustedHeight;\r\n    const bottomBounds = lineAdjustedHeight - Math.abs(metrics.actualBoundingBoxAscent);\r\n    const x = 0;\r\n    const y = 0;\r\n    const measurement = new BoundingBox({\r\n      left: x - Math.abs(metrics.actualBoundingBoxLeft) - this.font.padding,\r\n      top: y - Math.abs(metrics.actualBoundingBoxAscent) - this.font.padding,\r\n      bottom: y + bottomBounds + this.font.padding,\r\n      right: x + Math.abs(metrics.actualBoundingBoxRight) + this.font.padding\r\n    });\r\n\r\n    return measurement;\r\n  }\r\n\r\n  private _setDimension(textBounds: BoundingBox, bitmap: CanvasRenderingContext2D) {\r\n    let lineHeightRatio = 1;\r\n    if (this.font.lineHeight) {\r\n      lineHeightRatio = (this.font.lineHeight/this.font.size);\r\n    }\r\n    // Changing the width and height clears the context properties\r\n    // We double the bitmap width to account for all possible alignment\r\n    // We scale by \"quality\" so we render text without jaggies\r\n    bitmap.canvas.width = (textBounds.width + this.font.padding * 2) * 2 * this.font.quality;\r\n    bitmap.canvas.height = (textBounds.height + this.font.padding * 2) * 2 * this.font.quality * lineHeightRatio;\r\n  }\r\n\r\n  public static getHashCode(font: Font, text: string, color?: Color) {\r\n    const hash =\r\n      text +\r\n      '__hashcode__' +\r\n      font.fontString +\r\n      font.showDebug +\r\n      font.textAlign +\r\n      font.baseAlign +\r\n      font.direction +\r\n      font.lineHeight +\r\n      JSON.stringify(font.shadow) +\r\n      (font.padding.toString() +\r\n        font.smoothing.toString() +\r\n        font.lineWidth.toString() +\r\n        font.lineDash.toString() +\r\n        font.strokeColor?.toString() +\r\n        (color ? color.toString() : font.color.toString()));\r\n    return hash;\r\n  }\r\n\r\n  getHashCode(includeColor: boolean = true) {\r\n    return FontTextInstance.getHashCode(this.font, this.text, includeColor ? this.color : undefined);\r\n  }\r\n\r\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D) {\r\n    ctx.translate(this.font.padding, this.font.padding);\r\n    ctx.imageSmoothingEnabled = this.font.smoothing;\r\n    ctx.lineWidth = this.font.lineWidth;\r\n    ctx.setLineDash(this.font.lineDash ?? ctx.getLineDash());\r\n    ctx.strokeStyle = this.font.strokeColor?.toString();\r\n    ctx.fillStyle = this.color.toString();\r\n  }\r\n\r\n  private _applyFont(ctx: CanvasRenderingContext2D) {\r\n    ctx.resetTransform();\r\n    ctx.translate(this.font.padding + ctx.canvas.width / 2, this.font.padding + ctx.canvas.height / 2);\r\n    ctx.scale(this.font.quality, this.font.quality);\r\n    ctx.textAlign = this.font.textAlign;\r\n    ctx.textBaseline = this.font.baseAlign;\r\n    ctx.font = this.font.fontString;\r\n    ctx.direction = this.font.direction;\r\n\r\n    if (this.font.shadow) {\r\n      ctx.shadowColor = this.font.shadow.color.toString();\r\n      ctx.shadowBlur = this.font.shadow.blur;\r\n      ctx.shadowOffsetX = this.font.shadow.offset.x;\r\n      ctx.shadowOffsetY = this.font.shadow.offset.y;\r\n    }\r\n  }\r\n\r\n  private _drawText(ctx: CanvasRenderingContext2D, lines: string[], lineHeight: number): void {\r\n    this._applyRasterProperties(ctx);\r\n    this._applyFont(ctx);\r\n\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i];\r\n      if (this.color) {\r\n        ctx.fillText(line, 0, i * lineHeight);\r\n      }\r\n\r\n      if (this.font.strokeColor) {\r\n        ctx.strokeText(line, 0, i * lineHeight);\r\n      }\r\n    }\r\n\r\n    if (this.font.showDebug) {\r\n      // Horizontal line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Green, -ctx.canvas.width / 2, 0, ctx.canvas.width / 2, 0, 2);\r\n      // Vertical line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Red, 0, -ctx.canvas.height / 2, 0, ctx.canvas.height / 2, 2);\r\n    }\r\n  }\r\n\r\n  private _splitTextBitmap(bitmap: CanvasRenderingContext2D) {\r\n    const textImages: { x: number; y: number; canvas: HTMLCanvasElement }[] = [];\r\n    let currentX = 0;\r\n    let currentY = 0;\r\n    // 4k is the max for mobile devices\r\n    const width = Math.min(4096, bitmap.canvas.width);\r\n    const height = Math.min(4096, bitmap.canvas.height);\r\n\r\n    // Splits the original bitmap into 4k max chunks\r\n    while (currentX < bitmap.canvas.width) {\r\n      while (currentY < bitmap.canvas.height) {\r\n        // create new bitmap\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        const ctx = canvas.getContext('2d');\r\n\r\n        // draw current slice to new bitmap in < 4k chunks\r\n        ctx.drawImage(bitmap.canvas, currentX, currentY, width, height, 0, 0, width, height);\r\n\r\n        textImages.push({ x: currentX, y: currentY, canvas });\r\n        currentY += height;\r\n      }\r\n      currentX += width;\r\n      currentY = 0;\r\n    }\r\n    return textImages;\r\n  }\r\n\r\n  public flagDirty() {\r\n    this._dirty = true;\r\n  }\r\n  private _dirty = true;\r\n  private _ex: ExcaliburGraphicsContext;\r\n  public render(ex: ExcaliburGraphicsContext, x: number, y: number, maxWidth?: number) {\r\n    if (this.disposed) {\r\n      throw Error('Accessing disposed text instance! ' + this.text);\r\n    }\r\n    this._ex = ex;\r\n    const hashCode = this.getHashCode();\r\n    if (this._lastHashCode !== hashCode) {\r\n      this._dirty = true;\r\n    }\r\n\r\n    // Calculate image chunks\r\n    if (this._dirty) {\r\n      this.dimensions = this.measureText(this.text, maxWidth);\r\n      this._setDimension(this.dimensions, this.ctx);\r\n      const lines = this._getLinesFromText(this.text, maxWidth);\r\n      const lineHeight = this.font.lineHeight ?? this.dimensions.height / lines.length;\r\n\r\n      // draws the text to the main bitmap\r\n      this._drawText(this.ctx, lines, lineHeight);\r\n\r\n      // clear any out old fragments\r\n      if (ex instanceof ExcaliburGraphicsContextWebGL) {\r\n        for (const frag of this._textFragments) {\r\n          ex.textureLoader.delete(frag.canvas);\r\n        }\r\n      }\r\n\r\n      // splits to < 4k fragments for large text\r\n      this._textFragments = this._splitTextBitmap(this.ctx);\r\n\r\n      if (ex instanceof ExcaliburGraphicsContextWebGL) {\r\n        for (const frag of this._textFragments) {\r\n          ex.textureLoader.load(frag.canvas, { filtering: this.font.filtering }, true);\r\n        }\r\n      }\r\n      this._lastHashCode = hashCode;\r\n      this._dirty = false;\r\n    }\r\n\r\n    // draws the bitmap fragments to excalibur graphics context\r\n    for (const frag of this._textFragments) {\r\n      ex.drawImage(\r\n        frag.canvas,\r\n        0,\r\n        0,\r\n        frag.canvas.width,\r\n        frag.canvas.height,\r\n        frag.x / this.font.quality + x - this.ctx.canvas.width / this.font.quality / 2,\r\n        frag.y / this.font.quality + y - this.ctx.canvas.height / this.font.quality / 2,\r\n        frag.canvas.width / this.font.quality,\r\n        frag.canvas.height / this.font.quality\r\n      );\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    this.disposed = true;\r\n    this.dimensions = undefined;\r\n    this.canvas = undefined;\r\n    this.ctx = undefined;\r\n    if (this._ex instanceof ExcaliburGraphicsContextWebGL) {\r\n      for (const frag of this._textFragments) {\r\n        this._ex.textureLoader.delete(frag.canvas);\r\n      }\r\n    }\r\n    this._textFragments.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Return array of lines split based on the \\n character, and the maxWidth? constraint\r\n   * @param text\r\n   * @param maxWidth\r\n   */\r\n  private _cachedText: string;\r\n  private _cachedLines: string[];\r\n  private _cachedRenderWidth: number;\r\n  private _getLinesFromText(text: string, maxWidth?: number) {\r\n    if (this._cachedText === text && this._cachedRenderWidth === maxWidth) {\r\n      return this._cachedLines;\r\n    }\r\n\r\n    const lines = text.split('\\n');\r\n\r\n    if (maxWidth == null) {\r\n      return lines;\r\n    }\r\n\r\n    // If the current line goes past the maxWidth, append a new line without modifying the underlying text.\r\n    for (let i = 0; i < lines.length; i++) {\r\n      let line = lines[i];\r\n      let newLine = '';\r\n      if (this.measureText(line).width > maxWidth) {\r\n        while (this.measureText(line).width > maxWidth) {\r\n          newLine = line[line.length - 1] + newLine;\r\n          line = line.slice(0, -1); // Remove last character from line\r\n        }\r\n\r\n        // Update the array with our new values\r\n        lines[i] = line;\r\n        lines[i + 1] = newLine;\r\n      }\r\n    }\r\n\r\n    this._cachedText = text;\r\n    this._cachedLines = lines;\r\n    this._cachedRenderWidth = maxWidth;\r\n\r\n    return lines;\r\n  }\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\nimport { Color } from '../Color';\nimport { Logger } from '../Util/Log';\nimport { Font } from './Font';\nimport { FontTextInstance } from './FontTextInstance';\n\nexport class FontCache {\n  public static FONT_TIMEOUT = 500;\n  private static _LOGGER = Logger.getInstance();\n  private static _TEXT_USAGE = new Map<FontTextInstance, number>();\n  private static _TEXT_CACHE = new Map<string, FontTextInstance>();\n  private static _MEASURE_CACHE = new Map<string, BoundingBox>();\n\n  static measureText(text: string, font: Font, maxWidth?: number) {\n    const hash = FontTextInstance.getHashCode(font, text);\n    if (FontCache._MEASURE_CACHE.has(hash)) {\n      return FontCache._MEASURE_CACHE.get(hash);\n    }\n    FontCache._LOGGER.debug('Font text measurement cache miss');\n    const measurement = font.measureTextWithoutCache(text, maxWidth);\n    FontCache._MEASURE_CACHE.set(hash, measurement);\n    return measurement;\n  }\n\n  static getTextInstance(text: string, font: Font, color: Color) {\n    const hash = FontTextInstance.getHashCode(font, text, color);\n    let textInstance = FontCache._TEXT_CACHE.get(hash);\n    if (!textInstance) {\n      textInstance = new FontTextInstance(font, text, color);\n      FontCache._TEXT_CACHE.set(hash, textInstance);\n      FontCache._LOGGER.debug('Font text instance cache miss');\n    }\n\n    // Cache the bitmap for certain amount of time\n    FontCache._TEXT_USAGE.set(textInstance, performance.now());\n\n    return textInstance;\n  }\n\n  static checkAndClearCache() {\n    const deferred: FontTextInstance[] = [];\n    const currentHashCodes = new Set<string>();\n    for (const [textInstance, time] of FontCache._TEXT_USAGE.entries()) {\n      // if bitmap hasn't been used in 100 ms clear it\n      if (time + FontCache.FONT_TIMEOUT < performance.now()) {\n        FontCache._LOGGER.debug(`Text cache entry timed out ${textInstance.text}`);\n        deferred.push(textInstance);\n        textInstance.dispose();\n      } else {\n        const hash = textInstance.getHashCode(false);\n        currentHashCodes.add(hash);\n      }\n    }\n    // Deferred removal of text instances\n    deferred.forEach((t) => {\n      FontCache._TEXT_USAGE.delete(t);\n    });\n\n    // Regenerate text instance cache\n    this._TEXT_CACHE.clear();\n    for (const [textInstance] of this._TEXT_USAGE.entries()) {\n      this._TEXT_CACHE.set(textInstance.getHashCode(), textInstance);\n    }\n\n    // Regenerated measurement cache\n    const newTextMeasurementCache = new Map<string, BoundingBox>();\n    for (const current of currentHashCodes) {\n      if (FontCache._MEASURE_CACHE.has(current)) {\n        newTextMeasurementCache.set(current, FontCache._MEASURE_CACHE.get(current));\n      }\n    }\n    this._MEASURE_CACHE.clear();\n    this._MEASURE_CACHE = newTextMeasurementCache;\n  }\n\n  public static get cacheSize() {\n    return FontCache._TEXT_USAGE.size;\n  }\n\n  /**\n   * Force clear all cached text bitmaps\n   */\n  public static clearCache() {\n    for (const [textInstance] of FontCache._TEXT_USAGE.entries()) {\n      textInstance.dispose();\n    }\n    FontCache._TEXT_USAGE.clear();\n    FontCache._TEXT_CACHE.clear();\n    FontCache._MEASURE_CACHE.clear();\n  }\n}\n","import { Vector } from '../Math/vector';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Color } from '../Color';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BaseAlign, Direction, FontOptions, FontStyle, FontUnit, TextAlign, FontRenderer } from './FontCommon';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { RasterOptions } from './Raster';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { FontTextInstance } from './FontTextInstance';\r\nimport { FontCache } from './FontCache';\r\n/**\r\n * Represents a system or web font in Excalibur\r\n *\r\n * If no options specified, the system sans-serif 10 pixel is used\r\n *\r\n * If loading a custom web font be sure to have the font loaded before you use it https://erikonarheim.com/posts/dont-test-fonts/\r\n */\r\nexport class Font extends Graphic implements FontRenderer {\r\n  /**\r\n   * Set the font filtering mode, by default set to [[ImageFiltering.Blended]] regardless of the engine default smoothing\r\n   *\r\n   * If you have a pixel style font that may be a reason to switch this to [[ImageFiltering.Pixel]]\r\n   */\r\n  public filtering: ImageFiltering = ImageFiltering.Blended;\r\n  constructor(options: FontOptions & GraphicOptions & RasterOptions = {}) {\r\n    super(options); // <- Graphics properties\r\n\r\n    // Raster properties\r\n    this.smoothing = options?.smoothing ?? this.smoothing;\r\n    this.padding = options?.padding ?? this.padding;\r\n    this.color = options?.color ?? this.color;\r\n    this.strokeColor = options?.strokeColor ?? this.strokeColor;\r\n    this.lineDash = options?.lineDash ?? this.lineDash;\r\n    this.lineWidth = options?.lineWidth ?? this.lineWidth;\r\n    this.filtering = options?.filtering ?? this.filtering;\r\n\r\n    // Font specific properties\r\n    this.family = options?.family ?? this.family;\r\n    this.style = options?.style ?? this.style;\r\n    this.bold = options?.bold ?? this.bold;\r\n    this.size = options?.size ?? this.size;\r\n    this.unit = options?.unit ?? this.unit;\r\n    this.textAlign = options?.textAlign ?? this.textAlign;\r\n    this.baseAlign = options?.baseAlign ?? this.baseAlign;\r\n    this.direction = options?.direction ?? this.direction;\r\n    this.lineHeight = options?.lineHeight ?? this.lineHeight;\r\n    this.quality = options?.quality ?? this.quality;\r\n    if (options?.shadow) {\r\n      this.shadow = {};\r\n      this.shadow.blur = options.shadow.blur ?? this.shadow.blur;\r\n      this.shadow.offset = options.shadow.offset ?? this.shadow.offset;\r\n      this.shadow.color = options.shadow.color ?? this.shadow.color;\r\n    }\r\n  }\r\n\r\n  public clone() {\r\n    return new Font({\r\n      ...this.cloneGraphicOptions(),\r\n      size: this.size,\r\n      unit: this.unit,\r\n      family: this.family,\r\n      style: this.style,\r\n      bold: this.bold,\r\n      textAlign: this.textAlign,\r\n      baseAlign: this.baseAlign,\r\n      direction: this.direction,\r\n      shadow: this.shadow\r\n        ? {\r\n          blur: this.shadow.blur,\r\n          offset: this.shadow.offset,\r\n          color: this.shadow.color\r\n        }\r\n        : null\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Font quality determines the size of the underlying raster text, higher quality means less jagged edges.\r\n   * If quality is set to 1, then just enough raster bitmap is generated to render the text.\r\n   *\r\n   * You can think of quality as how zoomed in to the text you can get before seeing jagged edges.\r\n   *\r\n   * (Default 2)\r\n   */\r\n  public quality = 2;\r\n\r\n  // Raster properties for fonts\r\n  public padding = 2;\r\n  public smoothing = false;\r\n  public lineWidth = 1;\r\n  public lineDash: number[] = [];\r\n  public color: Color = Color.Black;\r\n  public strokeColor: Color;\r\n\r\n  public family: string = 'sans-serif';\r\n  public style: FontStyle = FontStyle.Normal;\r\n  public bold: boolean = false;\r\n  public unit: FontUnit = FontUnit.Px;\r\n  public textAlign: TextAlign = TextAlign.Left;\r\n  public baseAlign: BaseAlign = BaseAlign.Top;\r\n  public direction: Direction = Direction.LeftToRight;\r\n  /**\r\n   * Font line height in pixels, default line height if unset\r\n   */\r\n  public lineHeight: number | undefined = undefined;\r\n  public size: number = 10;\r\n  public shadow: { blur?: number; offset?: Vector; color?: Color } = null;\r\n\r\n  public get fontString() {\r\n    return `${this.style} ${this.bold ? 'bold' : ''} ${this.size}${this.unit} ${this.family}`;\r\n  }\r\n\r\n  private _textBounds: BoundingBox = new BoundingBox();\r\n\r\n  public get localBounds(): BoundingBox {\r\n    return this._textBounds;\r\n  }\r\n\r\n  protected _drawImage(_ex: ExcaliburGraphicsContext, _x: number, _y: number) {\r\n    // TODO weird vestigial drawimage\r\n  }\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext) {\r\n    // TODO this needs to change depending on the bounding box...\r\n    const origin = this.origin ?? this._textBounds.center;\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this._textBounds.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, -this._textBounds.height / 2 / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n  private _textMeasurement = new FontTextInstance(this, '', Color.Black);\r\n\r\n  public measureTextWithoutCache(text: string, maxWidth?: number) {\r\n    return this._textMeasurement.measureText(text, maxWidth);\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox that is the total size of the text including multiple lines\r\n   *\r\n   * Does not include any padding or adjustment\r\n   * @param text\r\n   * @returns BoundingBox\r\n   */\r\n  public measureText(text: string, maxWidth?: number): BoundingBox {\r\n    return FontCache.measureText(text, this, maxWidth);\r\n  }\r\n\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    ex.restore();\r\n  }\r\n\r\n  public render(ex: ExcaliburGraphicsContext, text: string, colorOverride: Color, x: number, y: number, maxWidth?: number) {\r\n    const textInstance = FontCache.getTextInstance(text, this, colorOverride);\r\n\r\n    // Apply affine transformations\r\n    this._textBounds = textInstance.dimensions;\r\n    this._preDraw(ex, x, y);\r\n\r\n    textInstance.render(ex, x, y, maxWidth);\r\n\r\n    this._postDraw(ex);\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\nimport { BoundingBox } from '../Collision/BoundingBox';\nimport { SpriteFont } from './SpriteFont';\nimport { Graphic, GraphicOptions } from './Graphic';\nimport { Color } from '../Color';\nimport { Font } from './Font';\n\nexport interface TextOptions {\n  /**\n   * Text to draw\n   */\n  text: string;\n\n  /**\n   * Optionally override the font color, currently unsupported by SpriteFont\n   */\n  color?: Color;\n\n  /**\n   * Optionally specify a font, if none specified a default font is used (System sans-serif 10 pixel)\n   */\n  font?: Font | SpriteFont;\n\n  /**\n   * Optionally specify a maximum width in pixels for our text, and wrap to the next line if needed.\n   */\n  maxWidth?: number;\n}\n\n/**\n * Represent Text graphics in excalibur\n *\n * Useful for in game labels, ui, or overlays\n */\nexport class Text extends Graphic {\n  public color?: Color;\n  public maxWidth?: number;\n  constructor(options: TextOptions & GraphicOptions) {\n    super(options);\n    // This order is important font, color, then text\n    this.font = options.font ?? new Font();\n    this.color = options.color ?? this.color;\n    this.text = options.text;\n    this.maxWidth = options.maxWidth;\n  }\n\n  public clone(): Text {\n    return new Text({\n      text: this.text.slice(),\n      color: this.color?.clone() ?? Color.Black,\n      font: this.font.clone(),\n      maxWidth: this.maxWidth\n    });\n  }\n\n  private _text: string = '';\n  public get text() {\n    return this._text;\n  }\n\n  public set text(value: string) {\n    this._text = value;\n    this._calculateDimension();\n  }\n\n  private _font: Font | SpriteFont;\n  public get font(): Font | SpriteFont {\n    return this._font;\n  }\n  public set font(font: Font | SpriteFont) {\n    this._font = font;\n  }\n\n  private _textWidth: number = 0;\n\n  public get width() {\n    if (this._textWidth === 0) {\n      this._calculateDimension();\n    }\n    return this._textWidth * this.scale.x;\n  }\n\n  private _textHeight: number = 0;\n  public get height() {\n    if (this._textHeight === 0) {\n      this._calculateDimension();\n    }\n    return this._textHeight * this.scale.y;\n  }\n\n  private _calculateDimension() {\n    const { width, height } = this.font.measureText(this._text, this.maxWidth);\n    this._textWidth = width;\n    this._textHeight = height;\n  }\n\n  public get localBounds(): BoundingBox {\n    return this.font.measureText(this._text, this.maxWidth).scale(this.scale);\n  }\n\n  protected override _rotate(_ex: ExcaliburGraphicsContext) {\n    // None this is delegated to font\n    // This override erases the default behavior\n  }\n\n  protected override _flip(_ex: ExcaliburGraphicsContext) {\n    // None this is delegated to font\n    // This override erases the default behavior\n  }\n\n  protected override _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\n    if (this.isStale() || this.font.isStale()) {\n      this.font.flipHorizontal = this.flipHorizontal;\n      this.font.flipVertical = this.flipVertical;\n      this.font.rotation = this.rotation;\n      this.font.origin = this.origin;\n      this.font.opacity = this.opacity;\n    }\n    this.font.tint = this.tint;\n    super._preDraw(ex, x, y);\n  }\n\n  protected override _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\n    let color = Color.Black;\n    if (this.font instanceof Font) {\n      color = this.color ?? this.font.color;\n    }\n\n    const { width, height } = this.font.measureText(this._text, this.maxWidth);\n    this._textWidth = width;\n    this._textHeight = height;\n\n    this.font.render(ex, this._text, color, x, y, this.maxWidth);\n\n    if (this.font.showDebug) {\n      ex.debug.drawRect(x - width, y - height, width * 2, height * 2);\n      if (this.maxWidth != null) {\n        ex.debug.drawRect(x, y, this.maxWidth, this.height, {\n          color: Color.Yellow\n        });\n      }\n    }\n  }\n}\n","import {\r\n  KillEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PostCollisionEvent,\r\n  PreCollisionEvent,\r\n  CollisionStartEvent,\r\n  CollisionEndEvent,\r\n  PostKillEvent,\r\n  PreKillEvent,\r\n  EnterViewPortEvent,\r\n  ExitViewPortEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  PreDebugDrawEvent,\r\n  PostDebugDrawEvent,\r\n  ActionStartEvent,\r\n  ActionCompleteEvent\r\n} from './Events';\r\nimport { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { CanInitialize, CanUpdate, CanBeKilled } from './Interfaces/LifecycleEvents';\r\nimport { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { BodyComponent } from './Collision/BodyComponent';\r\nimport { Eventable } from './Interfaces/Evented';\r\nimport { PointerEvents } from './Interfaces/PointerEventHandlers';\r\nimport { CollisionType } from './Collision/CollisionType';\r\n\r\nimport { Entity, EntityEvents } from './EntityComponentSystem/Entity';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from './EntityComponentSystem/Components/MotionComponent';\r\nimport { GraphicsComponent } from './Graphics/GraphicsComponent';\r\nimport { Rectangle } from './Graphics/Rectangle';\r\nimport { ColliderComponent } from './Collision/ColliderComponent';\r\nimport { Shape } from './Collision/Colliders/Shape';\r\nimport { watch } from './Util/Watch';\r\nimport { Collider, CollisionContact, CollisionGroup, Side } from './Collision/Index';\r\nimport { Circle } from './Graphics/Circle';\r\nimport { PointerEvent } from './Input/PointerEvent';\r\nimport { WheelEvent } from './Input/WheelEvent';\r\nimport { PointerComponent } from './Input/PointerComponent';\r\nimport { ActionsComponent } from './Actions/ActionsComponent';\r\nimport { Raster } from './Graphics/Raster';\r\nimport { Text } from './Graphics/Text';\r\nimport { CoordPlane } from './Math/coord-plane';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { Component } from './EntityComponentSystem';\r\n\r\n/**\r\n * Type guard for checking if something is an Actor\r\n * @param x\r\n */\r\nexport function isActor(x: any): x is Actor {\r\n  return x instanceof Actor;\r\n}\r\n\r\n/**\r\n * Actor constructor options\r\n */\r\nexport interface ActorArgs {\r\n  /**\r\n   * Optionally set the name of the actor, default is 'anonymous'\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally set the x position of the actor, default is 0\r\n   */\r\n  x?: number;\r\n  /**\r\n   * Optionally set the y position of the actor, default is 0\r\n   */\r\n  y?: number;\r\n  /**\r\n   * Optionally set the (x, y) position of the actor as a vector, default is (0, 0)\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally set the coordinate plane of the actor, default is [[CoordPlane.World]] meaning actor is subject to camera positioning\r\n   */\r\n  coordPlane?: CoordPlane;\r\n  /**\r\n   * Optionally set the width of a box collider for the actor\r\n   */\r\n  width?: number;\r\n  /**\r\n   * Optionally set the height of a box collider for the actor\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Optionally set the radius of the circle collider for the actor\r\n   */\r\n  radius?: number;\r\n  /**\r\n   * Optionally set the velocity of the actor in pixels/sec\r\n   */\r\n  vel?: Vector;\r\n  /**\r\n   * Optionally set the acceleration of the actor in pixels/sec^2\r\n   */\r\n  acc?: Vector;\r\n  /**\r\n   * Optionally se the rotation in radians (180 degrees = Math.PI radians)\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * Optionally set the angular velocity of the actor in radians/sec (180 degrees = Math.PI radians)\r\n   */\r\n  angularVelocity?: number;\r\n  /**\r\n   * Optionally set the scale of the actor's transform\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * Optionally set the z index of the actor, default is 0\r\n   */\r\n  z?: number;\r\n  /**\r\n   * Optionally set the color of an actor, only used if no graphics are present\r\n   * If a width/height or a radius was set a default graphic will be added\r\n   */\r\n  color?: Color;\r\n  /**\r\n   * Optionally set the color of an actor, only used if no graphics are present\r\n   * If a width/height or a radius was set a default graphic will be added\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * Optionally set the visibility of the actor\r\n   */\r\n  visible?: boolean;\r\n  /**\r\n   * Optionally set the anchor for graphics in the actor\r\n   */\r\n  anchor?: Vector;\r\n  /**\r\n   * Optionally set the anchor for graphics in the actor\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Optionally set the collision type\r\n   */\r\n  collisionType?: CollisionType;\r\n  /**\r\n   * Optionally supply a collider for an actor, if supplied ignores any supplied width/height\r\n   */\r\n  collider?: Collider;\r\n  /**\r\n   * Optionally supply a [[CollisionGroup]]\r\n   */\r\n  collisionGroup?: CollisionGroup;\r\n}\r\n\r\nexport type ActorEvents = EntityEvents & {\r\n  collisionstart: CollisionStartEvent;\r\n  collisionend: CollisionEndEvent;\r\n  precollision: PreCollisionEvent;\r\n  postcollision: PostCollisionEvent;\r\n  kill: KillEvent;\r\n  prekill: PreKillEvent;\r\n  postkill: PostKillEvent;\r\n  predraw: PreDrawEvent;\r\n  postdraw: PostDrawEvent;\r\n  pretransformdraw: PreDrawEvent;\r\n  posttransformdraw: PostDrawEvent;\r\n  predebugdraw: PreDebugDrawEvent;\r\n  postdebugdraw: PostDebugDrawEvent;\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointerenter: PointerEvent;\r\n  pointerleave: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n  pointerwheel: WheelEvent;\r\n  pointerdragstart: PointerEvent;\r\n  pointerdragend: PointerEvent;\r\n  pointerdragenter: PointerEvent;\r\n  pointerdragleave: PointerEvent;\r\n  pointerdragmove: PointerEvent;\r\n  enterviewport: EnterViewPortEvent;\r\n  exitviewport: ExitViewPortEvent;\r\n  actionstart: ActionStartEvent;\r\n  actioncomplete: ActionCompleteEvent;\r\n}\r\n\r\nexport const ActorEvents = {\r\n  CollisionStart: 'collisionstart',\r\n  CollisionEnd: 'collisionend',\r\n  PreCollision: 'precollision',\r\n  PostCollision: 'postcollision',\r\n  Kill: 'kill',\r\n  PreKill: 'prekill',\r\n  PostKill: 'postkill',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PreTransformDraw: 'pretransformdraw',\r\n  PostTransformDraw: 'posttransformdraw',\r\n  PreDebugDraw: 'predebugdraw',\r\n  PostDebugDraw: 'postdebugdraw',\r\n  PointerUp: 'pointerup',\r\n  PointerDown: 'pointerdown',\r\n  PointerEnter: 'pointerenter',\r\n  PointerLeave: 'pointerleave',\r\n  PointerMove: 'pointermove',\r\n  PointerCancel: 'pointercancel',\r\n  Wheel: 'pointerwheel',\r\n  PointerDrag: 'pointerdragstart',\r\n  PointerDragEnd: 'pointerdragend',\r\n  PointerDragEnter: 'pointerdragenter',\r\n  PointerDragLeave: 'pointerdragleave',\r\n  PointerDragMove: 'pointerdragmove',\r\n  EnterViewPort: 'enterviewport',\r\n  ExitViewPort: 'exitviewport',\r\n  ActionStart: 'actionstart',\r\n  ActionComplete: 'actioncomplete'\r\n};\r\n\r\n/**\r\n * The most important primitive in Excalibur is an `Actor`. Anything that\r\n * can move on the screen, collide with another `Actor`, respond to events,\r\n * or interact with the current scene, must be an actor. An `Actor` **must**\r\n * be part of a [[Scene]] for it to be drawn to the screen.\r\n */\r\nexport class Actor extends Entity implements Eventable, PointerEvents, CanInitialize, CanUpdate, CanBeKilled {\r\n  public events = new EventEmitter<ActorEvents>();\r\n  // #region Properties\r\n\r\n  /**\r\n   * Set defaults for all Actors\r\n   */\r\n  public static defaults = {\r\n    anchor: Vector.Half\r\n  };\r\n\r\n  /**\r\n   * The physics body the is associated with this actor. The body is the container for all physical properties, like position, velocity,\r\n   * acceleration, mass, inertia, etc.\r\n   */\r\n  public body: BodyComponent;\r\n\r\n  /**\r\n   * Access the Actor's built in [[TransformComponent]]\r\n   */\r\n  public transform: TransformComponent;\r\n\r\n  /**\r\n   * Access the Actor's built in [[MotionComponent]]\r\n   */\r\n  public motion: MotionComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in [[GraphicsComponent]]\r\n   */\r\n  public graphics: GraphicsComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in [[ColliderComponent]]\r\n   */\r\n  public collider: ColliderComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in [[PointerComponent]] config\r\n   */\r\n  public pointer: PointerComponent;\r\n\r\n  /**\r\n   * Useful for quickly scripting actor behavior, like moving to a place, patrolling back and forth, blinking, etc.\r\n   *\r\n   *  Access to the Actor's built in [[ActionsComponent]] which forwards to the\r\n   * [[ActionContext|Action context]] of the actor.\r\n   */\r\n  public actions: ActionsComponent;\r\n\r\n  /**\r\n   * Gets the position vector of the actor in pixels\r\n   */\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in pixels\r\n   */\r\n  public set pos(thePos: Vector) {\r\n    this.transform.pos = thePos.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the position vector of the actor from the last frame\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this.body.oldPos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in the last frame\r\n   */\r\n  public set oldPos(thePos: Vector) {\r\n    this.body.oldPos.setTo(thePos.x, thePos.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public set vel(theVel: Vector) {\r\n    this.motion.vel = theVel.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor from the last frame\r\n   */\r\n  public get oldVel(): Vector {\r\n    return this.body.oldVel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor from the last frame\r\n   */\r\n  public set oldVel(theVel: Vector) {\r\n    this.body.oldVel.setTo(theVel.x, theVel.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration vector of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may be\r\n   * useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration vector of teh actor in pixels/second/second\r\n   */\r\n  public set acc(theAcc: Vector) {\r\n    this.motion.acc = theAcc.clone();\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public set oldAcc(theAcc: Vector) {\r\n    this.body.oldAcc.setTo(theAcc.x, theAcc.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration of the actor from the last frame. This does not include the global acc [[Physics.acc]].\r\n   */\r\n  public get oldAcc(): Vector {\r\n    return this.body.oldAcc;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public get rotation(): number {\r\n    return this.transform.rotation;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public set rotation(theAngle: number) {\r\n    this.transform.rotation = theAngle;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotational velocity of the actor in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotational velocity of the actor in radians/sec\r\n   */\r\n  public set angularVelocity(angularVelocity: number) {\r\n    this.motion.angularVelocity = angularVelocity;\r\n  }\r\n\r\n  public get scale(): Vector {\r\n    return this.get(TransformComponent).scale;\r\n  }\r\n\r\n  public set scale(scale: Vector) {\r\n    this.get(TransformComponent).scale = scale;\r\n  }\r\n\r\n  private _anchor: Vector = watch(Vector.Half, (v) => this._handleAnchorChange(v));\r\n  /**\r\n   * The anchor to apply all actor related transformations like rotation,\r\n   * translation, and scaling. By default the anchor is in the center of\r\n   * the actor. By default it is set to the center of the actor (.5, .5)\r\n   *\r\n   * An anchor of (.5, .5) will ensure that drawings are centered.\r\n   *\r\n   * Use `anchor.setTo` to set the anchor to a different point using\r\n   * values between 0 and 1. For example, anchoring to the top-left would be\r\n   * `Actor.anchor.setTo(0, 0)` and top-right would be `Actor.anchor.setTo(0, 1)`.\r\n   */\r\n  public get anchor(): Vector {\r\n    return this._anchor;\r\n  }\r\n\r\n  public set anchor(vec: Vector) {\r\n    this._anchor = watch(vec, (v) => this._handleAnchorChange(v));\r\n    this._handleAnchorChange(vec);\r\n  }\r\n\r\n  private _handleAnchorChange(v: Vector) {\r\n    if (this.graphics) {\r\n      this.graphics.anchor = v;\r\n    }\r\n  }\r\n\r\n  private _offset: Vector = watch(Vector.Zero, (v) => this._handleOffsetChange(v));\r\n  /**\r\n   * The offset in pixels to apply to all actor graphics\r\n   *\r\n   * Default offset of (0, 0)\r\n   */\r\n  public get offset(): Vector {\r\n    return this._offset;\r\n  }\r\n\r\n  public set offset(vec: Vector) {\r\n    this._offset = watch(vec, (v) => this._handleOffsetChange(v));\r\n    this._handleOffsetChange(vec);\r\n  }\r\n\r\n  private _handleOffsetChange(v: Vector) {\r\n    if (this.graphics) {\r\n      this.graphics.offset = v;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Indicates whether the actor is physically in the viewport\r\n   */\r\n  public get isOffScreen(): boolean {\r\n    return this.hasTag('ex.offscreen');\r\n  }\r\n\r\n  /**\r\n   * Convenience reference to the global logger\r\n   */\r\n  public logger: Logger = Logger.getInstance();\r\n\r\n  /**\r\n   * Draggable helper\r\n   */\r\n  private _draggable: boolean = false;\r\n  private _dragging: boolean = false;\r\n\r\n  private _pointerDragStartHandler = () => {\r\n    this._dragging = true;\r\n  };\r\n\r\n  private _pointerDragEndHandler = () => {\r\n    this._dragging = false;\r\n  };\r\n\r\n  private _pointerDragMoveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  private _pointerDragLeaveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  public get draggable(): boolean {\r\n    return this._draggable;\r\n  }\r\n\r\n  public set draggable(isDraggable: boolean) {\r\n    if (isDraggable) {\r\n      if (isDraggable && !this._draggable) {\r\n        this.events.on('pointerdragstart', this._pointerDragStartHandler);\r\n        this.events.on('pointerdragend', this._pointerDragEndHandler);\r\n        this.events.on('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.events.on('pointerdragleave', this._pointerDragLeaveHandler);\r\n      } else if (!isDraggable && this._draggable) {\r\n        this.events.off('pointerdragstart', this._pointerDragStartHandler);\r\n        this.events.off('pointerdragend', this._pointerDragEndHandler);\r\n        this.events.off('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.events.off('pointerdragleave', this._pointerDragLeaveHandler);\r\n      }\r\n\r\n      this._draggable = isDraggable;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the color of the actor's current graphic\r\n   */\r\n  public get color(): Color {\r\n    return this._color;\r\n  }\r\n  public set color(v: Color) {\r\n    this._color = v.clone();\r\n    const currentGraphic = this.graphics.current;\r\n    if (currentGraphic instanceof Raster || currentGraphic instanceof Text) {\r\n      currentGraphic.color = this._color;\r\n    }\r\n  }\r\n  private _color: Color;\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   *\r\n   * @param config\r\n   */\r\n  constructor(config?: ActorArgs) {\r\n    super();\r\n\r\n    const {\r\n      name,\r\n      x,\r\n      y,\r\n      pos,\r\n      coordPlane,\r\n      scale,\r\n      width,\r\n      height,\r\n      radius,\r\n      collider,\r\n      vel,\r\n      acc,\r\n      rotation,\r\n      angularVelocity,\r\n      z,\r\n      color,\r\n      visible,\r\n      opacity,\r\n      anchor,\r\n      offset,\r\n      collisionType,\r\n      collisionGroup\r\n    } = {\r\n      ...config\r\n    };\r\n\r\n    this.name = name ?? this.name;\r\n    this.anchor = anchor ?? Actor.defaults.anchor.clone();\r\n    this.offset = offset ?? Vector.Zero;\r\n    this.transform = new TransformComponent();\r\n    this.addComponent(this.transform);\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.rotation = rotation ?? 0;\r\n    this.scale = scale ?? vec(1, 1);\r\n    this.z = z ?? 0;\r\n    this.transform.coordPlane = coordPlane ?? CoordPlane.World;\r\n\r\n    this.pointer = new PointerComponent;\r\n    this.addComponent(this.pointer);\r\n\r\n    this.graphics = new GraphicsComponent({\r\n      anchor: this.anchor,\r\n      offset: this.offset,\r\n      opacity: opacity\r\n    });\r\n    this.addComponent(this.graphics);\r\n\r\n    this.motion = new MotionComponent;\r\n    this.addComponent(this.motion);\r\n    this.vel = vel ?? Vector.Zero;\r\n    this.acc = acc ?? Vector.Zero;\r\n    this.angularVelocity = angularVelocity ?? 0;\r\n\r\n    this.actions = new ActionsComponent;\r\n    this.addComponent(this.actions);\r\n\r\n    this.body = new BodyComponent;\r\n    this.addComponent(this.body);\r\n    this.body.collisionType = collisionType ?? CollisionType.Passive;\r\n    if (collisionGroup) {\r\n      this.body.group = collisionGroup;\r\n    }\r\n\r\n    if (collider) {\r\n      this.collider = new ColliderComponent(collider);\r\n      this.addComponent(this.collider);\r\n    } else if (radius) {\r\n      this.collider = new ColliderComponent(Shape.Circle(radius));\r\n      this.addComponent(this.collider);\r\n    } else {\r\n      if (width > 0 && height > 0) {\r\n        this.collider = new ColliderComponent(Shape.Box(width, height, this.anchor));\r\n        this.addComponent(this.collider);\r\n      } else {\r\n        this.collider = new ColliderComponent();\r\n        this.addComponent(this.collider); // no collider\r\n      }\r\n    }\r\n\r\n    this.graphics.visible = visible ?? true;\r\n\r\n    if (color) {\r\n      this.color = color;\r\n      if (width && height) {\r\n        this.graphics.add(\r\n          new Rectangle({\r\n            color: color,\r\n            width,\r\n            height\r\n          })\r\n        );\r\n      } else if (radius) {\r\n        this.graphics.add(\r\n          new Circle({\r\n            color: color,\r\n            radius\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public clone(): Actor {\r\n    const clone = new Actor({\r\n      color: this.color.clone(),\r\n      anchor: this.anchor.clone(),\r\n      offset: this.offset.clone()\r\n    });\r\n    clone.clearComponents();\r\n    clone.processComponentRemoval();\r\n\r\n    // Clone builtins, order is important, same as ctor\r\n    clone.addComponent(clone.transform = this.transform.clone() as TransformComponent, true);\r\n    clone.addComponent(clone.pointer = this.pointer.clone() as PointerComponent, true);\r\n    clone.addComponent(clone.graphics = this.graphics.clone() as GraphicsComponent, true);\r\n    clone.addComponent(clone.motion = this.motion.clone() as MotionComponent, true);\r\n    clone.addComponent(clone.actions = this.actions.clone() as ActionsComponent, true);\r\n    clone.addComponent(clone.body = this.body.clone() as BodyComponent, true);\r\n    clone.addComponent(clone.collider = this.collider.clone() as ColliderComponent, true);\r\n\r\n    const builtInComponents: Component[] = [\r\n      this.transform,\r\n      this.pointer,\r\n      this.graphics,\r\n      this.motion,\r\n      this.actions,\r\n      this.body,\r\n      this.collider\r\n    ];\r\n\r\n    // Clone non-builtin the current actors components\r\n    const components = this.getComponents();\r\n    for (const c of components) {\r\n      if (!builtInComponents.includes(c)) {\r\n        clone.addComponent(c.clone(), true);\r\n      }\r\n    }\r\n    return clone;\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the actor. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Initializes this actor and all it's child actors, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n    for (const child of this.children) {\r\n      child._initialize(engine);\r\n    }\r\n  }\r\n\r\n  // #region Events\r\n  public emit<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, event: ActorEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for [[onPreKill]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _prekill(scene: Scene) {\r\n    this.events.emit('prekill', new PreKillEvent(this));\r\n    this.onPreKill(scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreKill lifecycle event handler. Synonymous with `.on('prekill', (evt) =>{...})`\r\n   *\r\n   * `onPreKill` is called directly before an actor is killed and removed from its current [[Scene]].\r\n   */\r\n  public onPreKill(scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for [[onPostKill]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postkill(scene: Scene) {\r\n    this.events.emit('postkill', new PostKillEvent(this));\r\n    this.onPostKill(scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostKill lifecycle event handler. Synonymous with `.on('postkill', (evt) => {...})`\r\n   *\r\n   * `onPostKill` is called directly after an actor is killed and remove from its current [[Scene]].\r\n   */\r\n  public onPostKill(scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * If the current actor is a member of the scene, this will remove\r\n   * it from the scene graph. It will no longer be drawn or updated.\r\n   */\r\n  public kill() {\r\n    if (this.scene) {\r\n      this._prekill(this.scene);\r\n      this.events.emit('kill', new KillEvent(this));\r\n      super.kill();\r\n      this._postkill(this.scene);\r\n    } else {\r\n      this.logger.warn(`Cannot kill actor named \"${this.name}\", it was never added to the Scene`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the current actor is killed, it will now not be killed.\r\n   */\r\n  public unkill() {\r\n    this.active = true;\r\n  }\r\n\r\n  /**\r\n   * Indicates wether the actor has been killed.\r\n   */\r\n  public isKilled(): boolean {\r\n    return !this.active;\r\n  }\r\n\r\n  /**\r\n   * Gets the z-index of an actor. The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   */\r\n  public get z(): number {\r\n    return this.get(TransformComponent).z;\r\n  }\r\n\r\n\r\n  /**\r\n   * Sets the z-index of an actor and updates it in the drawing list for the scene.\r\n   * The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   * @param newZ new z-index to assign\r\n   */\r\n  public set z(newZ: number) {\r\n    this.get(TransformComponent).z = newZ;\r\n  }\r\n\r\n  /**\r\n   * Get the center point of an actor (global position)\r\n   */\r\n  public get center(): Vector {\r\n    const globalPos = this.getGlobalPos();\r\n    return new Vector(\r\n      globalPos.x + this.width / 2 - this.anchor.x * this.width,\r\n      globalPos.y + this.height / 2 - this.anchor.y * this.height);\r\n  }\r\n\r\n  /**\r\n   * Get the local center point of an actor\r\n   */\r\n  public get localCenter(): Vector {\r\n    return new Vector(\r\n      this.pos.x + this.width / 2 - this.anchor.x * this.width,\r\n      this.pos.y + this.height / 2 - this.anchor.y * this.height);\r\n  }\r\n\r\n  public get width() {\r\n    return this.collider.localBounds.width * this.getGlobalScale().x;\r\n  }\r\n\r\n  public get height() {\r\n    return this.collider.localBounds.height * this.getGlobalScale().y;\r\n  }\r\n\r\n  /**\r\n   * Gets this actor's rotation taking into account any parent relationships\r\n   * @returns Rotation angle in radians\r\n   */\r\n  public getGlobalRotation(): number {\r\n    return this.get(TransformComponent).globalRotation;\r\n  }\r\n\r\n  /**\r\n   * Gets an actor's world position taking into account parent relationships, scaling, rotation, and translation\r\n   * @returns Position in world coordinates\r\n   */\r\n  public getGlobalPos(): Vector {\r\n    return this.get(TransformComponent).globalPos;\r\n  }\r\n\r\n  /**\r\n   * Gets the global scale of the Actor\r\n   */\r\n  public getGlobalScale(): Vector {\r\n    return this.get(TransformComponent).globalScale;\r\n  }\r\n\r\n  // #region Collision\r\n\r\n  /**\r\n   * Tests whether the x/y specified are contained in the actor\r\n   * @param x  X coordinate to test (in world coordinates)\r\n   * @param y  Y coordinate to test (in world coordinates)\r\n   * @param recurse checks whether the x/y are contained in any child actors (if they exist).\r\n   */\r\n  public contains(x: number, y: number, recurse: boolean = false): boolean {\r\n    const point = vec(x, y);\r\n    const collider = this.get(ColliderComponent);\r\n    collider.update();\r\n    const geom = collider.get();\r\n    if (!geom) {\r\n      return false;\r\n    }\r\n    const containment = geom.contains(point);\r\n\r\n    if (recurse) {\r\n      return (\r\n        containment ||\r\n        this.children.some((child: Actor) => {\r\n          return child.contains(x, y, true);\r\n        })\r\n      );\r\n    }\r\n\r\n    return containment;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the two actor.collider's surfaces are less than or equal to the distance specified from each other\r\n   * @param actor     Actor to test\r\n   * @param distance  Distance in pixels to test\r\n   */\r\n  public within(actor: Actor, distance: number): boolean {\r\n    const collider = this.get(ColliderComponent);\r\n    const otherCollider = actor.get(ColliderComponent);\r\n    const me = collider.get();\r\n    const other = otherCollider.get();\r\n    if (me && other) {\r\n      return me.getClosestLineBetween(other).getLength() <= distance;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // #endregion\r\n\r\n  // #region Update\r\n\r\n  /**\r\n   * Called by the Engine, updates the state of the actor\r\n   * @internal\r\n   * @param engine The reference to the current game engine\r\n   * @param delta  The time elapsed since the last update in milliseconds\r\n   */\r\n  public update(engine: Engine, delta: number) {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, delta);\r\n    this._postupdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an actor is updated.\r\n   */\r\n  public onPreUpdate(engine: Engine, delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an actor is updated.\r\n   */\r\n  public onPostUpdate(engine: Engine, delta: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires before every collision resolution for a confirmed contact\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onPreCollisionResolve(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires after every resolution for a confirmed contact.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onPostCollisionResolve(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires once when 2 entities with a ColliderComponent first start colliding or touching, if the Colliders stay in contact this\r\n   * does not continue firing until they separate and re-collide.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onCollisionStart(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires once when 2 entities with a ColliderComponent separate after having been in contact.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param lastContact\r\n   */\r\n  public onCollisionEnd(self: Collider, other: Collider, side: Side, lastContact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  // endregion\r\n}\r\n","import { Vector, vec } from './Math/vector';\r\nimport { Engine } from './Engine';\r\nimport { Actor, ActorArgs } from './Actor';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { CoordPlane } from './Math/coord-plane';\r\n\r\n/**\r\n * Type guard to detect a screen element\r\n */\r\nexport function isScreenElement(actor: Actor) {\r\n  return actor instanceof ScreenElement;\r\n}\r\n\r\n/**\r\n * Helper [[Actor]] primitive for drawing UI's, optimized for UI drawing. Does\r\n * not participate in collisions. Drawn on top of all other actors.\r\n */\r\nexport class ScreenElement extends Actor {\r\n  protected _engine: Engine;\r\n\r\n  constructor();\r\n  constructor(config?: ActorArgs);\r\n\r\n  constructor(config?: ActorArgs) {\r\n    super({ ...config });\r\n    this.get(TransformComponent).coordPlane = CoordPlane.Screen;\r\n    this.anchor = config?.anchor ?? vec(0, 0);\r\n    this.body.collisionType = config?.collisionType ?? CollisionType.PreventCollision;\r\n    this.pointer.useGraphicsBounds = true;\r\n    this.pointer.useColliderShape = false;\r\n    if (!config?.collider &&\r\n        config?.width > 0 &&\r\n        config?.height > 0) {\r\n      this.collider.useBoxCollider(this.width, this.height, this.anchor);\r\n    }\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    this._engine = engine;\r\n    super._initialize(engine);\r\n  }\r\n\r\n  public contains(x: number, y: number, useWorld: boolean = true) {\r\n    if (useWorld) {\r\n      return super.contains(x, y);\r\n    }\r\n\r\n    const coords = this._engine.worldToScreenCoordinates(new Vector(x, y));\r\n    return super.contains(coords.x, coords.y);\r\n  }\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport * as ex from './index';\r\nimport { Random } from './Math/Random';\r\n\r\n\r\nexport interface TimerOptions {\r\n  repeats?: boolean;\r\n  numberOfRepeats?: number;\r\n  fcn?: () => void;\r\n  interval: number;\r\n  randomRange?: [number, number];\r\n  random?: ex.Random;\r\n}\r\n\r\n/**\r\n * The Excalibur timer hooks into the internal timer and fires callbacks,\r\n * after a certain interval, optionally repeating.\r\n */\r\nexport class Timer {\r\n  private _logger = Logger.getInstance();\r\n  private static _MAX_ID: number = 0;\r\n  public id: number = 0;\r\n\r\n  private _elapsedTime: number = 0;\r\n  private _totalTimeAlive: number = 0;\r\n\r\n  private _running = false;\r\n\r\n  private _numberOfTicks: number = 0;\r\n  private _callbacks: Array<() => void>;\r\n\r\n  public interval: number = 10;\r\n  public repeats: boolean = false;\r\n  public maxNumberOfRepeats: number = -1;\r\n  public randomRange: [number, number] = [0,0];\r\n  public random: ex.Random;\r\n  private _baseInterval = 10;\r\n  private _generateRandomInterval = () => {\r\n    return this._baseInterval + this.random.integer(this.randomRange[0], this.randomRange[1]);\r\n  };\r\n\r\n  private _complete = false;\r\n  public get complete() {\r\n    return this._complete;\r\n  }\r\n\r\n  public scene: Scene = null;\r\n\r\n  /**\r\n   * @param options    Options - repeats, numberOfRepeats, fcn, interval\r\n   * @param repeats    Indicates whether this call back should be fired only once, or repeat after every interval as completed.\r\n   * @param numberOfRepeats Specifies a maximum number of times that this timer will execute.\r\n   * @param fcn        The callback to be fired after the interval is complete.\r\n   * @param randomRange Indicates a range to select a random number to be added onto the interval\r\n   */\r\n  constructor(options: TimerOptions);\r\n  constructor(fcn: TimerOptions | (() => void), interval?: number,\r\n    repeats?: boolean, numberOfRepeats?: number, randomRange?: [number, number], random?: ex.Random) {\r\n    if (typeof fcn !== 'function') {\r\n      const options = fcn;\r\n      fcn = options.fcn;\r\n      interval = options.interval;\r\n      repeats = options.repeats;\r\n      numberOfRepeats = options.numberOfRepeats;\r\n      randomRange = options.randomRange;\r\n      random= options.random;\r\n    }\r\n\r\n    if (!!numberOfRepeats && numberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = numberOfRepeats;\r\n      if (!repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this.id = Timer._MAX_ID++;\r\n    this._callbacks = [];\r\n    this._baseInterval = this.interval = interval;\r\n    if (!!randomRange){\r\n      if (randomRange[0] > randomRange[1]) {\r\n        throw new Error('min value must be lower than max value for range');\r\n      }\r\n      //We use the instance of ex.Random to generate the range\r\n      this.random = random ?? new Random();\r\n      this.randomRange = randomRange;\r\n\r\n      this.interval = this._generateRandomInterval();\r\n      this.on(() => {\r\n        this.interval = this._generateRandomInterval();\r\n      });\r\n    };\r\n    this.repeats = repeats || this.repeats;\r\n    if (fcn) {\r\n      this.on(fcn);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a new callback to be fired after the interval is complete\r\n   * @param fcn The callback to be added to the callback list, to be fired after the interval is complete.\r\n   */\r\n  public on(fcn: () => void) {\r\n    this._callbacks.push(fcn);\r\n  }\r\n\r\n  /**\r\n   * Removes a callback from the callback list to be fired after the interval is complete.\r\n   * @param fcn The callback to be removed from the callback list, to be fired after the interval is complete.\r\n   */\r\n  public off(fcn: () => void) {\r\n    const index = this._callbacks.indexOf(fcn);\r\n    this._callbacks.splice(index, 1);\r\n  }\r\n  /**\r\n   * Updates the timer after a certain number of milliseconds have elapsed. This is used internally by the engine.\r\n   * @param delta  Number of elapsed milliseconds since the last update.\r\n   */\r\n  public update(delta: number) {\r\n    if (this._running) {\r\n      this._totalTimeAlive += delta;\r\n      this._elapsedTime += delta;\r\n\r\n      if (this.maxNumberOfRepeats > -1 && this._numberOfTicks >= this.maxNumberOfRepeats) {\r\n        this._complete = true;\r\n        this._running = false;\r\n        this._elapsedTime = 0;\r\n      }\r\n\r\n      if (!this.complete && this._elapsedTime >= this.interval) {\r\n        this._callbacks.forEach((c) => {\r\n          c.call(this);\r\n        });\r\n        this._numberOfTicks++;\r\n        if (this.repeats) {\r\n          this._elapsedTime = 0;\r\n        } else {\r\n          this._complete = true;\r\n          this._running = false;\r\n          this._elapsedTime = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the timer so that it can be reused, and optionally reconfigure the timers interval.\r\n   *\r\n   * Warning** you may need to call `timer.start()` again if the timer had completed\r\n   * @param newInterval If specified, sets a new non-negative interval in milliseconds to refire the callback\r\n   * @param newNumberOfRepeats If specified, sets a new non-negative upper limit to the number of time this timer executes\r\n   */\r\n  public reset(newInterval?: number, newNumberOfRepeats?: number) {\r\n    if (!!newInterval && newInterval >= 0) {\r\n      this._baseInterval = this.interval= newInterval;\r\n    }\r\n\r\n    if (!!this.maxNumberOfRepeats && this.maxNumberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = newNumberOfRepeats;\r\n      if (!this.repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this._complete = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n  }\r\n\r\n  public get timesRepeated(): number {\r\n    return this._numberOfTicks;\r\n  }\r\n\r\n  public getTimeRunning(): number {\r\n    return this._totalTimeAlive;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds until the next action callback, if complete will return 0\r\n   */\r\n  public get timeToNextAction() {\r\n    if (this.complete) {\r\n      return 0;\r\n    }\r\n    return this.interval - this._elapsedTime;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds elapsed toward the next action\r\n   */\r\n  public get timeElapsedTowardNextAction() {\r\n    return this._elapsedTime;\r\n  }\r\n\r\n  public get isRunning() {\r\n    return this._running;\r\n  }\r\n\r\n  /**\r\n   * Pauses the timer, time will no longer increment towards the next call\r\n   */\r\n  public pause(): Timer {\r\n    this._running = false;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Resumes the timer, time will now increment towards the next call.\r\n   */\r\n  public resume(): Timer {\r\n    this._running = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Starts the timer, if the timer was complete it will restart the timer and reset the elapsed time counter\r\n   */\r\n  public start(): Timer {\r\n    if (!this.scene) {\r\n      this._logger.warn('Cannot start a timer not part of a scene, timer wont start until added');\r\n    }\r\n\r\n    this._running = true;\r\n    if (this.complete) {\r\n      this._complete = false;\r\n      this._elapsedTime = 0;\r\n      this._numberOfTicks = 0;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Stops the timer and resets the elapsed time counter towards the next action invocation\r\n   */\r\n  public stop(): Timer {\r\n    this._running = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Cancels the timer, preventing any further executions.\r\n   */\r\n  public cancel() {\r\n    this.pause();\r\n    if (this.scene) {\r\n      this.scene.cancelTimer(this);\r\n    }\r\n  }\r\n}\r\n\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { vec, Vector } from '../Math/vector';\r\n\r\nexport class ParallaxComponent extends Component {\r\n\r\n  parallaxFactor = vec(1.0, 1.0);\r\n\r\n  constructor(parallaxFactor?: Vector) {\r\n    super();\r\n    this.parallaxFactor = parallaxFactor ?? this.parallaxFactor;\r\n  }\r\n}","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { DebugConfig } from '../Debug';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\n\r\n\r\n/**\r\n * Provide arbitrary drawing for the purposes of debugging your game\r\n *\r\n * Will only show when the Engine is set to debug mode [[Engine.showDebug]] or [[Engine.toggleDebug]]\r\n *\r\n */\r\nexport class DebugGraphicsComponent extends Component {\r\n  constructor(\r\n    public draw: (ctx: ExcaliburGraphicsContext, debugFlags: DebugConfig) => void,\r\n    public useTransform = true) {\r\n    super();\r\n  }\r\n}","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Engine } from '../Engine';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Logger } from '../Util/Log';\r\nimport { Entity, EntityEvents } from '../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { Shape } from '../Collision/Colliders/Shape';\r\nimport { ExcaliburGraphicsContext, Graphic, GraphicsComponent, hasGraphicsTick, ParallaxComponent } from '../Graphics';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { Collider } from '../Collision/Colliders/Collider';\r\nimport { PostDrawEvent, PostUpdateEvent, PreDrawEvent, PreUpdateEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { DebugConfig } from '../Debug';\r\nimport { clamp } from '../Math/util';\r\nimport { PointerComponent } from '../Input/PointerComponent';\r\nimport { PointerEvent } from '../Input/PointerEvent';\r\n\r\nexport interface TileMapOptions {\r\n  /**\r\n   * Optionally name the tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n\r\n  /**\r\n   * Optionally configure the meshing lookbehind for Tilemap, Tilemaps combine solid tiles into optimal\r\n   * geometry and the lookbehind configures how far back the Tilemap to look for geometry when combining. Meshing\r\n   * is an expensive operation, so when the Tilemap geometry is invalidated it must be recalculated.\r\n   *\r\n   * Default is 10 slots, but if your Tilemap does not change positions or solid tiles often you can increase this to\r\n   * Infinity.\r\n   */\r\n  meshingLookBehind?: number;\r\n}\r\n\r\nexport type TilePointerEvents = {\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n}\r\n\r\nexport type TileMapEvents = EntityEvents & TilePointerEvents & {\r\n  preupdate: PreUpdateEvent<TileMap>;\r\n  postupdate: PostUpdateEvent<TileMap>;\r\n  predraw: PreDrawEvent;\r\n  postdraw: PostDrawEvent;\r\n}\r\n\r\nexport const TileMapEvents = {\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PointerUp: 'pointerup',\r\n  PointerDown: 'pointerdown',\r\n  PointerMove: 'pointermove',\r\n  PointerCancel: 'pointercancel'\r\n};\r\n\r\n/**\r\n * The TileMap provides a mechanism for doing flat 2D tiles rendered in a grid.\r\n *\r\n * TileMaps are useful for top down or side scrolling grid oriented games.\r\n */\r\nexport class TileMap extends Entity {\r\n  public events = new EventEmitter<TileMapEvents>();\r\n  private _token = 0;\r\n  private _engine: Engine;\r\n\r\n  public logger: Logger = Logger.getInstance();\r\n  public readonly tiles: Tile[] = [];\r\n  private _rows: Tile[][] = [];\r\n  private _cols: Tile[][] = [];\r\n\r\n  public readonly tileWidth: number;\r\n  public readonly tileHeight: number;\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  public renderFromTopOfGraphic = false;\r\n  public meshingLookBehind = 10;\r\n\r\n  private _collidersDirty = true;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n  }\r\n\r\n  public flagTilesDirty() {\r\n    for (let i = 0; i < this.tiles.length; i++) {\r\n      if (this.tiles[i]) {\r\n        this.tiles[i].flagDirty();\r\n      }\r\n    }\r\n  }\r\n\r\n  public pointer: PointerComponent;\r\n  public transform: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _graphics: GraphicsComponent;\r\n  public collider: ColliderComponent;\r\n  private _composite: CompositeCollider;\r\n\r\n  public get x(): number {\r\n    return this.transform.pos.x ?? 0;\r\n  }\r\n\r\n  public set x(val: number) {\r\n    if (this.transform?.pos) {\r\n      this.get(TransformComponent).pos = vec(val, this.y);\r\n    }\r\n  }\r\n\r\n  public get y(): number {\r\n    return this.transform?.pos.y ?? 0;\r\n  }\r\n\r\n  public set y(val: number) {\r\n    if (this.transform?.pos) {\r\n      this.transform.pos = vec(this.x, val);\r\n    }\r\n  }\r\n\r\n  public get z(): number {\r\n    return this.transform.z ?? 0;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    if (this.transform) {\r\n      this.transform.z = val;\r\n    }\r\n  }\r\n\r\n  private _oldRotation: number;\r\n  public get rotation(): number {\r\n    return this.transform?.rotation ?? 0;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    if (this.transform) {\r\n      this.transform.rotation = val;\r\n    }\r\n  }\r\n\r\n  private _oldScale: Vector;\r\n  public get scale(): Vector {\r\n    return this.transform?.scale ?? Vector.One;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    if (this.transform?.scale) {\r\n      this.transform.scale = val;\r\n    }\r\n  }\r\n\r\n  private _oldPos: Vector;\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this.transform.pos = val;\r\n  }\r\n\r\n  public get vel(): Vector {\r\n    return this._motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this._motion.vel = val;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, event: TileMapEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n\r\n  /**\r\n   * @param options\r\n   */\r\n  constructor(options: TileMapOptions) {\r\n    super([], options.name);\r\n    this.meshingLookBehind = options.meshingLookBehind ?? this.meshingLookBehind;\r\n    this.addComponent(new TransformComponent());\r\n    this.addComponent(new MotionComponent());\r\n    this.addComponent(\r\n      new BodyComponent({\r\n        type: CollisionType.Fixed\r\n      })\r\n    );\r\n    this.addComponent(\r\n      new GraphicsComponent({\r\n        onPostDraw: (ctx, delta) => this.draw(ctx, delta)\r\n      })\r\n    );\r\n    this.addComponent(new DebugGraphicsComponent((ctx, debugFlags) => this.debug(ctx, debugFlags), false));\r\n    this.addComponent(new ColliderComponent());\r\n    this.addComponent(new PointerComponent);\r\n    this.pointer = this.get(PointerComponent);\r\n    this._graphics = this.get(GraphicsComponent);\r\n    this.transform = this.get(TransformComponent);\r\n    this._motion = this.get(MotionComponent);\r\n    this.collider = this.get(ColliderComponent);\r\n    this._composite = this.collider.useCompositeCollider([]);\r\n\r\n    this.transform.pos = options.pos ?? Vector.Zero;\r\n    this._oldPos = this.transform.pos.clone();\r\n    this._oldScale = this.transform.scale.clone();\r\n    this.renderFromTopOfGraphic = options.renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.tileWidth = options.tileWidth;\r\n    this.tileHeight = options.tileHeight;\r\n    this.rows = options.rows;\r\n    this.columns = options.columns;\r\n\r\n    this.tiles = new Array<Tile>(this.rows * this.columns);\r\n    this._rows = new Array(this.rows);\r\n    this._cols = new Array(this.columns);\r\n    let currentCol: Tile[] = [];\r\n    for (let i = 0; i < this.columns; i++) {\r\n      for (let j = 0; j < this.rows; j++) {\r\n        const tile = new Tile({\r\n          x: i,\r\n          y: j,\r\n          map: this\r\n        });\r\n        tile.map = this;\r\n        this.tiles[i + j * this.columns] = tile;\r\n        currentCol.push(tile);\r\n        if (!this._rows[j]) {\r\n          this._rows[j] = [];\r\n        }\r\n        this._rows[j].push(tile);\r\n      }\r\n      this._cols[i] = currentCol;\r\n      currentCol = [];\r\n    }\r\n\r\n    this._setupPointerToTile();\r\n\r\n    this._graphics.localBounds = new BoundingBox({\r\n      left: 0,\r\n      top: 0,\r\n      right: this.columns * this.tileWidth * this.scale.x,\r\n      bottom: this.rows * this.tileHeight * this.scale.y\r\n    });\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n    this._engine = engine;\r\n  }\r\n\r\n  private _forwardPointerEventToTile = (eventType: string) => (evt: PointerEvent) => {\r\n    const tile = this.getTileByPoint(evt.worldPos);\r\n    if (tile) {\r\n      tile.events.emit(eventType, evt);\r\n    }\r\n  };\r\n\r\n  private _setupPointerToTile() {\r\n    this.events.on('pointerup', this._forwardPointerEventToTile('pointerup'));\r\n    this.events.on('pointerdown', this._forwardPointerEventToTile('pointerdown'));\r\n    this.events.on('pointermove', this._forwardPointerEventToTile('pointermove'));\r\n    this.events.on('pointercancel', this._forwardPointerEventToTile('pointercancel'));\r\n  }\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider);\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Tiles colliders based on the solid tiles in the tilemap.\r\n   */\r\n  private _updateColliders(): void {\r\n    this.collider.$colliderRemoved.notifyAll(this._composite);\r\n    this._composite.clearColliders();\r\n    const colliders: BoundingBox[] = [];\r\n    this._composite = this.collider.useCompositeCollider([]);\r\n    let current: BoundingBox;\r\n\r\n    /**\r\n     * Returns wether or not the 2 boxes share an edge and are the same height\r\n     * @param prev\r\n     * @param next\r\n     * @returns true if they share and edge, false if not\r\n     */\r\n    const shareEdges = (prev: BoundingBox, next: BoundingBox) => {\r\n      if (prev && next) {\r\n        // same top/bottom\r\n        return prev.top === next.top &&\r\n        prev.bottom === next.bottom &&\r\n        // Shared right/left edge\r\n        prev.right === next.left;\r\n      }\r\n      return false;\r\n    };\r\n\r\n    /**\r\n     * Potentially merges the current collider into a list of previous ones, mutating the list\r\n     * If checkAndCombine returns true, the collider was successfully merged and should be thrown away\r\n     * @param current current collider to test\r\n     * @param colliders List of colliders to consider merging with\r\n     * @param maxLookBack The amount of colliders to look back for combination\r\n     * @returns false when no combination found, true when successfully combined\r\n     */\r\n    const checkAndCombine = (current: BoundingBox, colliders: BoundingBox[], maxLookBack = this.meshingLookBehind) => {\r\n      if (!current) {\r\n        return false;\r\n      }\r\n      // walk backwards through the list of colliders and combine with the first that shares an edge\r\n      for (let i = colliders.length - 1; i >= 0; i--) {\r\n        if (maxLookBack-- < 0) {\r\n          // blunt the O(n^2) algorithm a bit\r\n          return false;\r\n        }\r\n        const prev = colliders[i];\r\n        if (shareEdges(prev, current)) {\r\n          colliders[i] = prev.combine(current);\r\n          return true;\r\n        }\r\n      }\r\n      return false;\r\n    };\r\n\r\n    // ? configurable bias perhaps, horizontal strips vs. vertical ones\r\n    // Bad tile collider packing algorithm\r\n    for (let i = 0; i < this.columns; i++) {\r\n      // Scan column for colliders\r\n      for (let j = 0; j < this.rows; j++) {\r\n        const tile = this.tiles[i + j * this.columns];\r\n        // Current tile in column is solid build up current collider\r\n        if (tile.solid) {\r\n          // Use custom collider otherwise bounding box\r\n          if (tile.getColliders().length > 0) {\r\n            // tile with custom collider interrupting the current run\r\n            for (const collider of tile.getColliders()) {\r\n              const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n              collider.offset = vec(tile.x * this.tileWidth * this.scale.x, tile.y * this.tileHeight * this.scale.y).add(originalOffset);\r\n              collider.owner = this;\r\n              this._composite.addCollider(collider);\r\n            }\r\n            //we push any current collider before nulling the current run\r\n            if (current && !checkAndCombine(current, colliders)) {\r\n              colliders.push(current);\r\n            }\r\n            current = null;\r\n            // Use the bounding box\r\n          } else {\r\n            if (!current) {\r\n              // no current run, start one\r\n              current = tile.defaultGeometry;\r\n            } else {\r\n              // combine with current run\r\n              current = current.combine(tile.defaultGeometry);\r\n            }\r\n          }\r\n        } else {\r\n          // Not solid skip and cut off the current collider\r\n          // End of run check and combine\r\n          if (current && !checkAndCombine(current, colliders)) {\r\n            colliders.push(current);\r\n          }\r\n          current = null;\r\n        }\r\n      }\r\n      // After a column is complete check to see if it can be merged into the last one\r\n      // Eno of run check and combine\r\n      if (current && !checkAndCombine(current, colliders)) {\r\n        // else new collider if no combination\r\n        colliders.push(current);\r\n      }\r\n      current = null;\r\n    }\r\n\r\n    for (const c of colliders) {\r\n      const collider = Shape.Box(c.width, c.height, Vector.Zero, vec(c.left - this.pos.x, c.top - this.pos.y));\r\n      collider.owner = this;\r\n      this._composite.addCollider(collider);\r\n    }\r\n    this.collider.update();\r\n    // Notify that colliders have been updated\r\n    this.collider.$colliderAdded.notifyAll(this._composite);\r\n  }\r\n\r\n  /**\r\n   * Returns the [[Tile]] by index (row major order)\r\n   */\r\n  public getTileByIndex(index: number): Tile {\r\n    return this.tiles[index];\r\n  }\r\n  /**\r\n   * Returns the [[Tile]] by its x and y integer coordinates\r\n   *\r\n   * For example, if I want the tile in fifth column (x), and second row (y):\r\n   * `getTile(4, 1)` 0 based, so 0 is the first in row/column\r\n   */\r\n  public getTile(x: number, y: number): Tile {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n  /**\r\n   * Returns the [[Tile]] by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): Tile | null {\r\n    const {x, y} = this._getTileCoordinates(point);\r\n    const tile = this.getTile(x, y);\r\n    if (x >= 0 && y >= 0 && x < this.columns && y < this.rows && tile) {\r\n      return tile;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private _getTileCoordinates(point: Vector): {x: number, y: number} {\r\n    // Convert to Tile Space point\r\n    point = this.transform.applyInverse(point);\r\n\r\n    const x = Math.floor(point.x / this.tileWidth);\r\n    const y = Math.floor(point.y / this.tileHeight);\r\n    return {x, y};\r\n  }\r\n\r\n  public getRows(): readonly Tile[][] {\r\n    return this._rows;\r\n  }\r\n\r\n  public getColumns(): readonly Tile[][] {\r\n    return this._cols;\r\n  }\r\n\r\n  /**\r\n   * Returns the on screen tiles for a tilemap, this will overshoot by a small amount because of the internal quad tree data structure.\r\n   *\r\n   * Useful if you need to perform specific logic on onscreen tiles\r\n   */\r\n  public getOnScreenTiles(): readonly Tile[] {\r\n    let worldBounds = this._engine.screen.getWorldBounds();\r\n    const maybeParallax = this.get(ParallaxComponent);\r\n    if (maybeParallax && this.isInitialized) {\r\n      let pos = this.pos;\r\n      const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n      const parallaxOffset = this._engine.currentScene.camera.pos.scale(oneMinusFactor);\r\n      pos = pos.sub(parallaxOffset);\r\n      // adjust world bounds by parallax factor\r\n      worldBounds = worldBounds.translate(pos);\r\n    }\r\n\r\n    const bounds = this.transform.coordPlane === CoordPlane.Screen ?\r\n      this._engine.screen.getScreenBounds() :\r\n      worldBounds;\r\n    const topLeft = this._getTileCoordinates(bounds.topLeft);\r\n    const topRight = this._getTileCoordinates(bounds.topRight);\r\n    const bottomRight = this._getTileCoordinates(bounds.bottomRight);\r\n    const bottomLeft = this._getTileCoordinates(bounds.bottomLeft);\r\n\r\n    const tileStartX = Math.min(\r\n      clamp(topLeft.x, 0, this.columns - 1),\r\n      clamp(topRight.x, 0, this.columns - 1)\r\n    );\r\n    const tileStartY = Math.min(\r\n      clamp(topLeft.y, 0, this.rows - 1),\r\n      clamp(topRight.y, 0, this.rows - 1)\r\n    );\r\n    const tileEndX = Math.max(\r\n      clamp(bottomRight.x, 0, this.columns - 1),\r\n      clamp(bottomLeft.x, 0, this.columns - 1)\r\n    );\r\n    const tileEndY = Math.max(\r\n      clamp(bottomRight.y, 0, this.rows - 1),\r\n      clamp(bottomLeft.y, 0, this.rows - 1)\r\n    );\r\n\r\n    const tiles: Tile[] = [];\r\n    for (let x = tileStartX; x <= tileEndX; x++) {\r\n      for (let y = tileStartY; y <= tileEndY; y++) {\r\n        tiles.push(this.getTile(x, y));\r\n      }\r\n    }\r\n    return tiles;\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    this._initialize(engine);\r\n    this.onPreUpdate(engine, delta);\r\n    this.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    if (!this._oldPos.equals(this.pos) ||\r\n      this._oldRotation !== this.rotation ||\r\n      !this._oldScale.equals(this.scale)) {\r\n      this.flagCollidersDirty();\r\n      this.flagTilesDirty();\r\n    }\r\n    if (this._collidersDirty) {\r\n      this._collidersDirty = false;\r\n      this._updateColliders();\r\n    }\r\n\r\n    this._token++;\r\n\r\n    this.pos.clone(this._oldPos);\r\n    this._oldRotation = this.rotation;\r\n    this.scale.clone(this._oldScale);\r\n    this.transform.pos = this.pos;\r\n    this.onPostUpdate(engine, delta);\r\n    this.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n  }\r\n\r\n  /**\r\n   * Draws the tile map to the screen. Called by the [[Scene]].\r\n   * @param ctx ExcaliburGraphicsContext\r\n   * @param delta  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    if (!this.isInitialized) {\r\n      return;\r\n    }\r\n    this.emit('predraw', new PreDrawEvent(ctx as any, delta, this)); // TODO fix event\r\n\r\n    let graphics: readonly Graphic[], graphicsIndex: number, graphicsLen: number;\r\n\r\n    const tiles = this.getOnScreenTiles();\r\n    for (let i = 0; i < tiles.length; i++) {\r\n      const tile = tiles[i];\r\n      // get non-negative tile sprites\r\n      const offsets = tile.getGraphicsOffsets();\r\n      graphics = tile.getGraphics();\r\n\r\n      for (graphicsIndex = 0, graphicsLen = graphics.length; graphicsIndex < graphicsLen; graphicsIndex++) {\r\n        // draw sprite, warning if sprite doesn't exist\r\n        const graphic = graphics[graphicsIndex];\r\n        const offset = offsets[graphicsIndex];\r\n        if (graphic) {\r\n          if (hasGraphicsTick(graphic)) {\r\n            graphic?.tick(delta, this._token);\r\n          }\r\n          const offsetY = this.renderFromTopOfGraphic ? 0 : (graphic.height - this.tileHeight);\r\n          graphic.draw(ctx, tile.x * this.tileWidth + offset.x, tile.y * this.tileHeight - offsetY + offset.y);\r\n        }\r\n      }\r\n    }\r\n    this.emit('postdraw', new PostDrawEvent(ctx as any, delta, this));\r\n  }\r\n\r\n  public debug(gfx: ExcaliburGraphicsContext, debugFlags: DebugConfig) {\r\n    const {\r\n      showAll,\r\n      showGrid,\r\n      gridColor,\r\n      gridWidth,\r\n      showSolidBounds: showColliderBounds,\r\n      solidBoundsColor: colliderBoundsColor,\r\n      showColliderGeometry\r\n    } = debugFlags.tilemap;\r\n    const {\r\n      geometryColor,\r\n      geometryLineWidth,\r\n      geometryPointSize\r\n    } = debugFlags.collider;\r\n    const width = this.tileWidth * this.columns * this.scale.x;\r\n    const height = this.tileHeight * this.rows * this.scale.y;\r\n    const pos = this.pos;\r\n    if (showGrid || showAll) {\r\n      for (let r = 0; r < this.rows + 1; r++) {\r\n        const yOffset = vec(0, r * this.tileHeight * this.scale.y);\r\n        gfx.drawLine(pos.add(yOffset), pos.add(vec(width, yOffset.y)), gridColor, gridWidth);\r\n      }\r\n\r\n      for (let c = 0; c < this.columns + 1; c++) {\r\n        const xOffset = vec(c * this.tileWidth * this.scale.x, 0);\r\n        gfx.drawLine(pos.add(xOffset), pos.add(vec(xOffset.x, height)), gridColor, gridWidth);\r\n      }\r\n    }\r\n\r\n    if (showAll || showColliderBounds || showColliderGeometry) {\r\n      const colliders = this._composite.getColliders();\r\n      gfx.save();\r\n      gfx.translate(this.pos.x, this.pos.y);\r\n      gfx.scale(this.scale.x, this.scale.y);\r\n      for (const collider of colliders) {\r\n        const bounds = collider.localBounds;\r\n        const pos = collider.worldPos.sub(this.pos);\r\n        if (showColliderBounds) {\r\n          gfx.drawRectangle(pos, bounds.width, bounds.height, colliderBoundsColor);\r\n        }\r\n      }\r\n      gfx.restore();\r\n      if (showColliderGeometry) {\r\n        for (const collider of colliders) {\r\n          collider.debug(gfx, geometryColor, { lineWidth: geometryLineWidth, pointSize: geometryPointSize });\r\n        }\r\n      }\r\n    }\r\n\r\n    if (showAll || showColliderBounds) {\r\n      gfx.save();\r\n      gfx.z = 999;\r\n      if (showColliderBounds) {\r\n        for (let i = 0; i < this.tiles.length; i++) {\r\n          this.tiles[i].bounds.draw(gfx);\r\n        }\r\n      }\r\n      gfx.restore();\r\n    }\r\n  }\r\n}\r\n\r\nexport interface TileOptions {\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  y: number;\r\n  map: TileMap;\r\n  solid?: boolean;\r\n  graphics?: Graphic[];\r\n}\r\n\r\n/**\r\n * TileMap Tile\r\n *\r\n * A light-weight object that occupies a space in a collision map. Generally\r\n * created by a [[TileMap]].\r\n *\r\n * Tiles can draw multiple sprites. Note that the order of drawing is the order\r\n * of the sprites in the array so the last one will be drawn on top. You can\r\n * use transparency to create layers this way.\r\n */\r\nexport class Tile {\r\n  private _bounds: BoundingBox;\r\n  private _geometry: BoundingBox;\r\n  private _pos: Vector;\r\n  private _posDirty = false;\r\n\r\n  public events = new EventEmitter<TilePointerEvents>();\r\n\r\n  /**\r\n   * Return the world position of the top left corner of the tile\r\n   */\r\n  public get pos() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n      this._posDirty = false;\r\n    }\r\n    return this._pos;\r\n  }\r\n\r\n  /**\r\n   * Integer x coordinate of the tile\r\n   */\r\n  public readonly x: number;\r\n\r\n  /**\r\n   * Integer y coordinate of the tile\r\n   */\r\n  public readonly y: number;\r\n\r\n  private _width: number;\r\n  /**\r\n   * Width of the tile in pixels\r\n   */\r\n  public get width(): number {\r\n    return this._width;\r\n  }\r\n\r\n  private _height: number;\r\n  /**\r\n   * Height of the tile in pixels\r\n   */\r\n  public get height(): number {\r\n    return this._height;\r\n  }\r\n\r\n  /**\r\n   * Reference to the TileMap this tile is associated with\r\n   */\r\n  public map: TileMap;\r\n\r\n  private _solid = false;\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public get solid(): boolean {\r\n    return this._solid;\r\n  }\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public set solid(val: boolean) {\r\n    this.map?.flagCollidersDirty();\r\n    this._solid = val;\r\n  }\r\n\r\n  private _graphics: Graphic[] = [];\r\n  private _offsets: Vector[] = [];\r\n\r\n  /**\r\n   * Current list of graphics for this tile\r\n   */\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Current list of offsets for this tile's graphics\r\n   */\r\n  public getGraphicsOffsets(): readonly Vector[] {\r\n    return this._offsets;\r\n  }\r\n\r\n  /**\r\n   * Add another [[Graphic]] to this TileMap tile\r\n   * @param graphic\r\n   */\r\n  public addGraphic(graphic: Graphic, options?: { offset?: Vector }) {\r\n    this._graphics.push(graphic);\r\n    if (options?.offset) {\r\n      this._offsets.push(options.offset);\r\n    } else {\r\n      this._offsets.push(Vector.Zero);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove an instance of a [[Graphic]] from this tile\r\n   */\r\n  public removeGraphic(graphic: Graphic) {\r\n    const index = this._graphics.indexOf(graphic);\r\n    if (index > -1) {\r\n      this._graphics.splice(index, 1);\r\n      this._offsets.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all graphics from this tile\r\n   */\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n    this._offsets.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Current list of colliders for this tile\r\n   */\r\n  private _colliders: Collider[] = [];\r\n\r\n  /**\r\n   * Returns the list of colliders\r\n   */\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a custom collider to the [[Tile]] to use instead of it's bounds\r\n   *\r\n   * If no collider is set but [[Tile.solid]] is set, the tile bounds are used as a collider.\r\n   *\r\n   * **Note!** the [[Tile.solid]] must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the [[Tile]]\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the [[Tile]]\r\n   */\r\n  public clearColliders() {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Arbitrary data storage per tile, useful for any game specific data\r\n   */\r\n  public data = new Map<string, any>();\r\n\r\n  constructor(options: TileOptions) {\r\n    this.x = options.x;\r\n    this.y = options.y;\r\n    this.map = options.map;\r\n    this._width = options.map.tileWidth * this.map.scale.x;\r\n    this._height = options.map.tileHeight * this.map.scale.y;\r\n    this.solid = options.solid ?? this.solid;\r\n    this._graphics = options.graphics ?? [];\r\n    this._recalculate();\r\n  }\r\n\r\n  public flagDirty() {\r\n    return this._posDirty = true;\r\n  }\r\n\r\n  private _recalculate() {\r\n    const geometryPos = this.map.pos.add(vec(this.x * this.map.tileWidth, this.y * this.map.tileHeight));\r\n    this._geometry = new BoundingBox(geometryPos.x, geometryPos.y, geometryPos.x + this.map.tileWidth, geometryPos.y + this.map.tileHeight);\r\n\r\n    this._width = this.map.tileWidth * this.map.scale.x;\r\n    this._height = this.map.tileHeight * this.map.scale.y;\r\n\r\n    this._pos = this.map.pos.add(\r\n      vec(\r\n        this.x * this._width,\r\n        this.y * this._height));\r\n    this._bounds = new BoundingBox(this._pos.x, this._pos.y, this._pos.x + this._width, this._pos.y + this._height);\r\n\r\n    if (this.map.rotation) {\r\n      this._bounds = this._bounds.rotate(this.map.rotation, this.map.pos);\r\n    }\r\n    this._posDirty = false;\r\n  }\r\n\r\n  /**\r\n   * Tile bounds in world space\r\n   */\r\n  public get bounds() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return this._bounds;\r\n  }\r\n\r\n  public get defaultGeometry() {\r\n    return this._geometry;\r\n  }\r\n\r\n  /**\r\n   * Tile position in world space\r\n   */\r\n  public get center(): Vector {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return new Vector(this._pos.x + this._width / 2, this._pos.y + this._height / 2);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<TilePointerEvents>>\r\n  (eventName: TEventName, event: TilePointerEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<TilePointerEvents>>\r\n  (eventName: TEventName, handler: Handler<TilePointerEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<TilePointerEvents>>\r\n  (eventName: TEventName, handler: Handler<TilePointerEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<TilePointerEvents>>\r\n  (eventName: TEventName, handler: Handler<TilePointerEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    if (handler) {\r\n      this.events.off(eventName, handler);\r\n    } else {\r\n      this.events.off(eventName);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Screen } from './Screen';\r\nimport { EasingFunction, EasingFunctions } from './Util/EasingFunctions';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { removeItemFromArray } from './Util/Util';\r\nimport { CanUpdate, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { PreUpdateEvent, PostUpdateEvent, InitializeEvent } from './Events';\r\nimport { BoundingBox } from './Collision/BoundingBox';\r\nimport { Logger } from './Util/Log';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { watchAny } from './Util/Watch';\r\nimport { AffineMatrix } from './Math/affine-matrix';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { pixelSnapEpsilon } from './Graphics';\r\nimport { sign } from './Math/util';\r\n\r\n/**\r\n * Interface that describes a custom camera strategy for tracking targets\r\n */\r\nexport interface CameraStrategy<T> {\r\n  /**\r\n   * Target of the camera strategy that will be passed to the action\r\n   */\r\n  target: T;\r\n\r\n  /**\r\n   * Camera strategies perform an action to calculate a new focus returned out of the strategy\r\n   * @param target The target object to apply this camera strategy (if any)\r\n   * @param camera The current camera implementation in excalibur running the game\r\n   * @param engine The current engine running the game\r\n   * @param delta The elapsed time in milliseconds since the last frame\r\n   */\r\n  action: (target: T, camera: Camera, engine: Engine, delta: number) => Vector;\r\n}\r\n\r\n/**\r\n * Container to house convenience strategy methods\r\n * @internal\r\n */\r\nexport class StrategyContainer {\r\n  constructor(public camera: Camera) {}\r\n\r\n  /**\r\n   * Creates and adds the [[LockCameraToActorStrategy]] on the current camera.\r\n   * @param actor The actor to lock the camera to\r\n   */\r\n  public lockToActor(actor: Actor) {\r\n    this.camera.addStrategy(new LockCameraToActorStrategy(actor));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[LockCameraToActorAxisStrategy]] on the current camera\r\n   * @param actor The actor to lock the camera to\r\n   * @param axis The axis to follow the actor on\r\n   */\r\n  public lockToActorAxis(actor: Actor, axis: Axis) {\r\n    this.camera.addStrategy(new LockCameraToActorAxisStrategy(actor, axis));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[ElasticToActorStrategy]] on the current camera\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   * @param actor Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  public elasticToActor(actor: Actor, cameraElasticity: number, cameraFriction: number) {\r\n    this.camera.addStrategy(new ElasticToActorStrategy(actor, cameraElasticity, cameraFriction));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[RadiusAroundActorStrategy]] on the current camera\r\n   * @param actor Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  public radiusAroundActor(actor: Actor, radius: number) {\r\n    this.camera.addStrategy(new RadiusAroundActorStrategy(actor, radius));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the [[LimitCameraBoundsStrategy]] on the current camera\r\n   * @param box The bounding box to limit the camera to.\r\n   */\r\n  public limitCameraBounds(box: BoundingBox) {\r\n    this.camera.addStrategy(new LimitCameraBoundsStrategy(box));\r\n  }\r\n}\r\n\r\n/**\r\n * Camera axis enum\r\n */\r\nexport enum Axis {\r\n  X,\r\n  Y\r\n}\r\n\r\n/**\r\n * Lock a camera to the exact x/y position of an actor.\r\n */\r\nexport class LockCameraToActorStrategy implements CameraStrategy<Actor> {\r\n  constructor(public target: Actor) {}\r\n  public action = (target: Actor, camera: Camera, engine: Engine, delta: number) => {\r\n    const center = target.center;\r\n    return center;\r\n  };\r\n}\r\n\r\n/**\r\n * Lock a camera to a specific axis around an actor.\r\n */\r\nexport class LockCameraToActorAxisStrategy implements CameraStrategy<Actor> {\r\n  constructor(public target: Actor, public axis: Axis) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const center = target.center;\r\n    const currentFocus = cam.getFocus();\r\n    if (this.axis === Axis.X) {\r\n      return new Vector(center.x, currentFocus.y);\r\n    } else {\r\n      return new Vector(currentFocus.x, center.y);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Using [Hook's law](https://en.wikipedia.org/wiki/Hooke's_law), elastically move the camera towards the target actor.\r\n */\r\nexport class ElasticToActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   * @param target Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  constructor(public target: Actor, public cameraElasticity: number, public cameraFriction: number) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const position = target.center;\r\n    let focus = cam.getFocus();\r\n    let cameraVel = cam.vel.clone();\r\n\r\n    // Calculate the stretch vector, using the spring equation\r\n    // F = kX\r\n    // https://en.wikipedia.org/wiki/Hooke's_law\r\n    // Apply to the current camera velocity\r\n    const stretch = position.sub(focus).scale(this.cameraElasticity); // stretch is X\r\n    cameraVel = cameraVel.add(stretch);\r\n\r\n    // Calculate the friction (-1 to apply a force in the opposition of motion)\r\n    // Apply to the current camera velocity\r\n    const friction = cameraVel.scale(-1).scale(this.cameraFriction);\r\n    cameraVel = cameraVel.add(friction);\r\n\r\n    // Update position by velocity deltas\r\n    focus = focus.add(cameraVel);\r\n\r\n    return focus;\r\n  };\r\n}\r\n\r\nexport class RadiusAroundActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   *\r\n   * @param target Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  constructor(public target: Actor, public radius: number) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const position = target.center;\r\n    const focus = cam.getFocus();\r\n\r\n    const direction = position.sub(focus);\r\n    const distance = direction.size;\r\n    if (distance >= this.radius) {\r\n      const offset = distance - this.radius;\r\n      return focus.add(direction.normalize().scale(offset));\r\n    }\r\n    return focus;\r\n  };\r\n}\r\n\r\n/**\r\n * Prevent a camera from going beyond the given camera dimensions.\r\n */\r\nexport class LimitCameraBoundsStrategy implements CameraStrategy<BoundingBox> {\r\n  /**\r\n   * Useful for limiting the camera to a [[TileMap]]'s dimensions, or a specific area inside the map.\r\n   *\r\n   * Note that this strategy does not perform any movement by itself.\r\n   * It only sets the camera position to within the given bounds when the camera has gone beyond them.\r\n   * Thus, it is a good idea to combine it with other camera strategies and set this strategy as the last one.\r\n   *\r\n   * Make sure that the camera bounds are at least as large as the viewport size.\r\n   * @param target The bounding box to limit the camera to\r\n   */\r\n\r\n  boundSizeChecked: boolean = false; // Check and warn only once\r\n\r\n  constructor(public target: BoundingBox) {}\r\n\r\n  public action = (target: BoundingBox, cam: Camera, _eng: Engine, _delta: number) => {\r\n    const focus = cam.getFocus();\r\n\r\n    if (!this.boundSizeChecked) {\r\n      if (target.bottom - target.top < _eng.drawHeight || target.right - target.left < _eng.drawWidth) {\r\n        Logger.getInstance().warn('Camera bounds should not be smaller than the engine viewport');\r\n      }\r\n      this.boundSizeChecked = true;\r\n    }\r\n\r\n    let focusX = focus.x;\r\n    let focusY = focus.y;\r\n    if (focus.x < target.left + _eng.halfDrawWidth) {\r\n      focusX = target.left + _eng.halfDrawWidth;\r\n    } else if (focus.x > target.right - _eng.halfDrawWidth) {\r\n      focusX = target.right - _eng.halfDrawWidth;\r\n    }\r\n\r\n    if (focus.y < target.top + _eng.halfDrawHeight) {\r\n      focusY = target.top + _eng.halfDrawHeight;\r\n    } else if (focus.y > target.bottom - _eng.halfDrawHeight) {\r\n      focusY = target.bottom - _eng.halfDrawHeight;\r\n    }\r\n\r\n    return vec(focusX, focusY);\r\n  };\r\n}\r\n\r\nexport type CameraEvents = {\r\n  preupdate: PreUpdateEvent<Camera>,\r\n  postupdate: PostUpdateEvent<Camera>,\r\n  initialize: InitializeEvent<Camera>,\r\n\r\n}\r\n\r\nexport const CameraEvents = {\r\n  Initialize: 'initialize',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate'\r\n};\r\n\r\n/**\r\n * Cameras\r\n *\r\n * [[Camera]] is the base class for all Excalibur cameras. Cameras are used\r\n * to move around your game and set focus. They are used to determine\r\n * what is \"off screen\" and can be used to scale the game.\r\n *\r\n */\r\nexport class Camera implements CanUpdate, CanInitialize {\r\n  public events = new EventEmitter<CameraEvents>();\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public inverse: AffineMatrix = AffineMatrix.identity();\r\n\r\n\r\n  protected _follow: Actor;\r\n\r\n  private _cameraStrategies: CameraStrategy<any>[] = [];\r\n\r\n  public strategy: StrategyContainer = new StrategyContainer(this);\r\n\r\n  /**\r\n   * Get or set current zoom of the camera, defaults to 1\r\n   */\r\n  private _z = 1;\r\n  public get zoom(): number {\r\n    return this._z;\r\n  }\r\n\r\n  public set zoom(val: number) {\r\n    this._z = val;\r\n    if (this._engine) {\r\n      this._halfWidth = this._engine.halfDrawWidth;\r\n      this._halfHeight = this._engine.halfDrawHeight;\r\n    }\r\n  }\r\n  /**\r\n   * Get or set rate of change in zoom, defaults to 0\r\n   */\r\n  public dz: number = 0;\r\n  /**\r\n   * Get or set zoom acceleration\r\n   */\r\n  public az: number = 0;\r\n\r\n  /**\r\n   * Current rotation of the camera\r\n   */\r\n  public rotation: number = 0;\r\n\r\n  private _angularVelocity: number = 0;\r\n\r\n  /**\r\n   * Get or set the camera's angular velocity\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this._angularVelocity;\r\n  }\r\n\r\n  public set angularVelocity(value: number) {\r\n    this._angularVelocity = value;\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's position\r\n   */\r\n  private _posChanged = false;\r\n  private _pos: Vector = watchAny(Vector.Zero, () => (this._posChanged = true));\r\n  public get pos(): Vector {\r\n    return this._pos;\r\n  }\r\n  public set pos(vec: Vector) {\r\n    this._pos = watchAny(vec, () => (this._posChanged = true));\r\n    this._posChanged = true;\r\n  }\r\n  /**\r\n   * Interpolated camera position if more draws are running than updates\r\n   *\r\n   * Enabled when `Engine.fixedUpdateFps` is enabled, in all other cases this will be the same as pos\r\n   */\r\n  public drawPos: Vector = this.pos.clone();\r\n\r\n  private _oldPos = this.pos.clone();\r\n\r\n  /**\r\n   * Get or set the camera's velocity\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Get or set the camera's acceleration\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  private _cameraMoving: boolean = false;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1000; // 1 second\r\n  private _lerpStart: Vector = null;\r\n  private _lerpEnd: Vector = null;\r\n  private _lerpResolve: (value: Vector) => void;\r\n  private _lerpPromise: Promise<Vector>;\r\n\r\n  //camera effects\r\n  protected _isShaking: boolean = false;\r\n  private _shakeMagnitudeX: number = 0;\r\n  private _shakeMagnitudeY: number = 0;\r\n  private _shakeDuration: number = 0;\r\n  private _elapsedShakeTime: number = 0;\r\n  private _xShake: number = 0;\r\n  private _yShake: number = 0;\r\n\r\n  protected _isZooming: boolean = false;\r\n  private _zoomStart: number = 1;\r\n  private _zoomEnd: number = 1;\r\n  private _currentZoomTime: number = 0;\r\n  private _zoomDuration: number = 0;\r\n\r\n  private _zoomResolve: (val: boolean) => void;\r\n  private _zoomPromise: Promise<boolean>;\r\n  private _zoomEasing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n  private _easing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n\r\n  private _halfWidth: number = 0;\r\n  private _halfHeight: number = 0;\r\n\r\n  /**\r\n   * Get the camera's x position\r\n   */\r\n  public get x() {\r\n    return this.pos.x;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's x position (cannot be set when following an [[Actor]] or when moving)\r\n   */\r\n  public set x(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(value, this.pos.y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the camera's y position\r\n   */\r\n  public get y() {\r\n    return this.pos.y;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's y position (cannot be set when following an [[Actor]] or when moving)\r\n   */\r\n  public set y(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(this.pos.x, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x velocity\r\n   */\r\n  public get dx() {\r\n    return this.vel.x;\r\n  }\r\n\r\n  public set dx(value: number) {\r\n    this.vel = vec(value, this.vel.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y velocity\r\n   */\r\n  public get dy() {\r\n    return this.vel.y;\r\n  }\r\n\r\n  public set dy(value: number) {\r\n    this.vel = vec(this.vel.x, value);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x acceleration\r\n   */\r\n  public get ax() {\r\n    return this.acc.x;\r\n  }\r\n\r\n  public set ax(value: number) {\r\n    this.acc = vec(value, this.acc.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y acceleration\r\n   */\r\n  public get ay() {\r\n    return this.acc.y;\r\n  }\r\n\r\n  public set ay(value: number) {\r\n    this.acc = vec(this.acc.x, value);\r\n  }\r\n\r\n  /**\r\n   * Returns the focal point of the camera, a new point giving the x and y position of the camera\r\n   */\r\n  public getFocus() {\r\n    return this.pos;\r\n  }\r\n\r\n  /**\r\n   * This moves the camera focal point to the specified position using specified easing function. Cannot move when following an Actor.\r\n   * @param pos The target position to move to\r\n   * @param duration The duration in milliseconds the move should last\r\n   * @param [easingFn] An optional easing function ([[ex.EasingFunctions.EaseInOutCubic]] by default)\r\n   * @returns A [[Promise]] that resolves when movement is finished, including if it's interrupted.\r\n   *          The [[Promise]] value is the [[Vector]] of the target position. It will be rejected if a move cannot be made.\r\n   */\r\n  public move(pos: Vector, duration: number, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<Vector> {\r\n    if (typeof easingFn !== 'function') {\r\n      throw 'Please specify an EasingFunction';\r\n    }\r\n\r\n    // cannot move when following an actor\r\n    if (this._follow) {\r\n      return Promise.reject(pos);\r\n    }\r\n\r\n    // resolve existing promise, if any\r\n    if (this._lerpPromise && this._lerpResolve) {\r\n      this._lerpResolve(pos);\r\n    }\r\n\r\n    this._lerpPromise = new Promise<Vector>((resolve) => {\r\n      this._lerpResolve = resolve;\r\n    });\r\n    this._lerpStart = this.getFocus().clone();\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = pos;\r\n    this._currentLerpTime = 0;\r\n    this._cameraMoving = true;\r\n    this._easing = easingFn;\r\n\r\n    return this._lerpPromise;\r\n  }\r\n\r\n  /**\r\n   * Sets the camera to shake at the specified magnitudes for the specified duration\r\n   * @param magnitudeX  The x magnitude of the shake\r\n   * @param magnitudeY  The y magnitude of the shake\r\n   * @param duration    The duration of the shake in milliseconds\r\n   */\r\n  public shake(magnitudeX: number, magnitudeY: number, duration: number) {\r\n    this._isShaking = true;\r\n    this._shakeMagnitudeX = magnitudeX;\r\n    this._shakeMagnitudeY = magnitudeY;\r\n    this._shakeDuration = duration;\r\n  }\r\n\r\n  /**\r\n   * Zooms the camera in or out by the specified scale over the specified duration.\r\n   * If no duration is specified, it take effect immediately.\r\n   * @param scale    The scale of the zoom\r\n   * @param duration The duration of the zoom in milliseconds\r\n   */\r\n  public zoomOverTime(scale: number, duration: number = 0, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<boolean> {\r\n    this._zoomPromise = new Promise<boolean>((resolve) => {\r\n      this._zoomResolve = resolve;\r\n    });\r\n\r\n    if (duration) {\r\n      this._isZooming = true;\r\n      this._zoomEasing = easingFn;\r\n      this._currentZoomTime = 0;\r\n      this._zoomDuration = duration;\r\n      this._zoomStart = this.zoom;\r\n      this._zoomEnd = scale;\r\n    } else {\r\n      this._isZooming = false;\r\n      this.zoom = scale;\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    return this._zoomPromise;\r\n  }\r\n\r\n  private _viewport: BoundingBox = null;\r\n  /**\r\n   * Gets the bounding box of the viewport of this camera in world coordinates\r\n   */\r\n  public get viewport(): BoundingBox {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n\r\n    return new BoundingBox(0, 0, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Adds a new camera strategy to this camera\r\n   * @param cameraStrategy Instance of an [[CameraStrategy]]\r\n   */\r\n  public addStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    this._cameraStrategies.push(cameraStrategy);\r\n  }\r\n\r\n  /**\r\n   * Removes a camera strategy by reference\r\n   * @param cameraStrategy Instance of an [[CameraStrategy]]\r\n   */\r\n  public removeStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    removeItemFromArray(cameraStrategy, this._cameraStrategies);\r\n  }\r\n\r\n  /**\r\n   * Clears all camera strategies from the camera\r\n   */\r\n  public clearAllStrategies() {\r\n    this._cameraStrategies.length = 0;\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   */\r\n  public onPreUpdate(engine: Engine, delta: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onPostUpdate(engine: Engine, delta: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  private _engine: Engine;\r\n  private _screen: Screen;\r\n  private _isInitialized = false;\r\n  public get isInitialized() {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this._engine = engine;\r\n      this._screen = engine.screen;\r\n\r\n      const currentRes = this._screen.contentArea;\r\n      let center = vec(currentRes.width / 2, currentRes.height / 2);\r\n      if (!this._engine.loadingComplete) {\r\n        // If there was a loading screen, we peek the configured resolution\r\n        const res = this._screen.peekResolution();\r\n        if (res) {\r\n          center = vec(res.width / 2, res.height / 2);\r\n        }\r\n      }\r\n      this._halfWidth = center.x;\r\n      this._halfHeight = center.y;\r\n\r\n      // If the user has not set the camera pos, apply default center screen position\r\n      if (!this._posChanged) {\r\n        this.pos = center;\r\n      }\r\n      this.pos.clone(this.drawPos);\r\n      // First frame bootstrap\r\n\r\n      // Ensure camera tx is correct\r\n      // Run update twice to ensure properties are init'd\r\n      this.updateTransform(this.pos);\r\n\r\n      // Run strategies for first frame\r\n      this.runStrategies(engine, engine.clock.elapsed());\r\n\r\n      // Setup the first frame viewport\r\n      this.updateViewport();\r\n\r\n      // It's important to update the camera after strategies\r\n      // This prevents jitter\r\n      this.updateTransform(this.pos);\r\n      this.pos.clone(this._oldPos);\r\n\r\n      this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onInitialize(engine: Engine) {\r\n    // Overridable\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, event: CameraEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  public runStrategies(engine: Engine, delta: number) {\r\n    for (const s of this._cameraStrategies) {\r\n      this.pos = s.action.call(s, s.target, this, engine, delta);\r\n    }\r\n  }\r\n\r\n  public updateViewport() {\r\n    // recalculate viewport\r\n    this._viewport = new BoundingBox(\r\n      this.x - this._halfWidth,\r\n      this.y - this._halfHeight,\r\n      this.x + this._halfWidth,\r\n      this.y + this._halfHeight\r\n    );\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, delta);\r\n    this.pos.clone(this._oldPos);\r\n\r\n    // Update placements based on linear algebra\r\n    this.pos = this.pos.add(this.vel.scale(delta / 1000));\r\n    this.zoom += (this.dz * delta) / 1000;\r\n\r\n    this.vel = this.vel.add(this.acc.scale(delta / 1000));\r\n    this.dz += (this.az * delta) / 1000;\r\n\r\n    this.rotation += (this.angularVelocity * delta) / 1000;\r\n\r\n    if (this._isZooming) {\r\n      if (this._currentZoomTime < this._zoomDuration) {\r\n        const zoomEasing = this._zoomEasing;\r\n        const newZoom = zoomEasing(this._currentZoomTime, this._zoomStart, this._zoomEnd, this._zoomDuration);\r\n\r\n        this.zoom = newZoom;\r\n        this._currentZoomTime += delta;\r\n      } else {\r\n        this._isZooming = false;\r\n        this.zoom = this._zoomEnd;\r\n        this._currentZoomTime = 0;\r\n        this._zoomResolve(true);\r\n      }\r\n    }\r\n\r\n    if (this._cameraMoving) {\r\n      if (this._currentLerpTime < this._lerpDuration) {\r\n        const moveEasing = EasingFunctions.CreateVectorEasingFunction(this._easing);\r\n\r\n        const lerpPoint = moveEasing(this._currentLerpTime, this._lerpStart, this._lerpEnd, this._lerpDuration);\r\n\r\n        this.pos = lerpPoint;\r\n\r\n        this._currentLerpTime += delta;\r\n      } else {\r\n        this.pos = this._lerpEnd;\r\n        const end = this._lerpEnd.clone();\r\n\r\n        this._lerpStart = null;\r\n        this._lerpEnd = null;\r\n        this._currentLerpTime = 0;\r\n        this._cameraMoving = false;\r\n        // Order matters here, resolve should be last so any chain promises have a clean slate\r\n        this._lerpResolve(end);\r\n      }\r\n    }\r\n\r\n    if (this._isDoneShaking()) {\r\n      this._isShaking = false;\r\n      this._elapsedShakeTime = 0;\r\n      this._shakeMagnitudeX = 0;\r\n      this._shakeMagnitudeY = 0;\r\n      this._shakeDuration = 0;\r\n      this._xShake = 0;\r\n      this._yShake = 0;\r\n    } else {\r\n      this._elapsedShakeTime += delta;\r\n      this._xShake = ((Math.random() * this._shakeMagnitudeX) | 0) + 1;\r\n      this._yShake = ((Math.random() * this._shakeMagnitudeY) | 0) + 1;\r\n    }\r\n\r\n    this.runStrategies(engine, delta);\r\n\r\n    this.updateViewport();\r\n\r\n    // It's important to update the camera after strategies\r\n    // This prevents jitter\r\n    this.updateTransform(this.pos);\r\n\r\n    this._postupdate(engine, delta);\r\n  }\r\n\r\n  private _snapPos = vec(0, 0);\r\n  /**\r\n   * Applies the relevant transformations to the game canvas to \"move\" or apply effects to the Camera\r\n   * @param ctx Canvas context to apply transformations\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext): void {\r\n    // default to the current position\r\n    this.pos.clone(this.drawPos);\r\n\r\n    // interpolation if fixed update is on\r\n    // must happen on the draw, because more draws are potentially happening than updates\r\n    if (this._engine.fixedUpdateFps) {\r\n      const blend = this._engine.currentFrameLagMs / (1000 / this._engine.fixedUpdateFps);\r\n      const interpolatedPos = this.pos.scale(blend).add(\r\n        this._oldPos.scale(1.0 - blend)\r\n      );\r\n      interpolatedPos.clone(this.drawPos);\r\n      this.updateTransform(interpolatedPos);\r\n    }\r\n    // Snap camera to pixel\r\n    if (ctx.snapToPixel) {\r\n      const snapPos = this.drawPos.clone(this._snapPos);\r\n      snapPos.x = ~~(snapPos.x + pixelSnapEpsilon * sign(snapPos.x));\r\n      snapPos.y = ~~(snapPos.y + pixelSnapEpsilon * sign(snapPos.y));\r\n      snapPos.clone(this.drawPos);\r\n      this.updateTransform(snapPos);\r\n    }\r\n    ctx.multiply(this.transform);\r\n  }\r\n\r\n  public updateTransform(pos: Vector) {\r\n    // center the camera\r\n    const newCanvasWidth = this._screen.resolution.width / this.zoom;\r\n    const newCanvasHeight = this._screen.resolution.height / this.zoom;\r\n    const cameraPos = vec(-pos.x + newCanvasWidth / 2 + this._xShake, -pos.y + newCanvasHeight / 2 + this._yShake);\r\n\r\n    // Calculate camera transform\r\n    this.transform.reset();\r\n\r\n    this.transform.scale(this.zoom, this.zoom);\r\n\r\n    // rotate about the focus\r\n    this.transform.translate(newCanvasWidth / 2, newCanvasHeight / 2);\r\n    this.transform.rotate(this.rotation);\r\n    this.transform.translate(-newCanvasWidth / 2, -newCanvasHeight / 2);\r\n\r\n    this.transform.translate(cameraPos.x, cameraPos.y);\r\n    this.transform.inverse(this.inverse);\r\n  }\r\n\r\n  private _isDoneShaking(): boolean {\r\n    return !this._isShaking || this._elapsedShakeTime >= this._shakeDuration;\r\n  }\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Vector } from './Math/vector';\r\nimport { ExitTriggerEvent, EnterTriggerEvent, CollisionEndEvent, CollisionStartEvent } from './Events';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { Entity } from './EntityComponentSystem';\r\nimport { Actor, ActorEvents } from './Actor';\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\nexport type TriggerEvents = ActorEvents & {\r\n  exit: ExitTriggerEvent,\r\n  enter: EnterTriggerEvent\r\n}\r\n\r\nexport const TriggerEvents = {\r\n  ExitTrigger: 'exit',\r\n  EnterTrigger: 'enter'\r\n};\r\n\r\n/**\r\n * TriggerOptions\r\n */\r\nexport interface TriggerOptions {\r\n  // position of the trigger\r\n  pos: Vector;\r\n  // width of the trigger\r\n  width: number;\r\n  // height of the trigger\r\n  height: number;\r\n  // whether the trigger is visible or not\r\n  visible: boolean;\r\n  // action to take when triggered\r\n  action: () => void;\r\n  // if specified the trigger will only fire on a specific actor and overrides any filter\r\n  target: Entity;\r\n  // Returns true if the triggers should fire on the collided actor\r\n  filter: (actor: Entity) => boolean;\r\n  // -1 if it should repeat forever\r\n  repeat: number;\r\n}\r\n\r\nconst triggerDefaults: Partial<TriggerOptions> = {\r\n  pos: Vector.Zero,\r\n  width: 10,\r\n  height: 10,\r\n  visible: false,\r\n  action: () => {\r\n    return;\r\n  },\r\n  filter: () => true,\r\n  repeat: -1\r\n};\r\n\r\n/**\r\n * Triggers are a method of firing arbitrary code on collision. These are useful\r\n * as 'buttons', 'switches', or to trigger effects in a game. By default triggers\r\n * are invisible, and can only be seen when [[Trigger.visible]] is set to `true`.\r\n */\r\nexport class Trigger extends Actor {\r\n  public events = new EventEmitter<TriggerEvents & ActorEvents>();\r\n  private _target: Entity;\r\n  /**\r\n   * Action to fire when triggered by collision\r\n   */\r\n  public action: () => void = () => {\r\n    return;\r\n  };\r\n  /**\r\n   * Filter to add additional granularity to action dispatch, if a filter is specified the action will only fire when\r\n   * filter return true for the collided actor.\r\n   */\r\n  public filter: (actor: Entity) => boolean = () => true;\r\n  /**\r\n   * Number of times to repeat before killing the trigger,\r\n   */\r\n  public repeat: number = -1;\r\n\r\n  /**\r\n   *\r\n   * @param opts Trigger options\r\n   */\r\n  constructor(opts: Partial<TriggerOptions>) {\r\n    super({ x: opts.pos.x, y: opts.pos.y, width: opts.width, height: opts.height });\r\n    opts = {\r\n      ...triggerDefaults,\r\n      ...opts\r\n    };\r\n\r\n    this.filter = opts.filter || this.filter;\r\n    this.repeat = opts.repeat || this.repeat;\r\n    this.action = opts.action || this.action;\r\n    if (opts.target) {\r\n      this.target = opts.target;\r\n    }\r\n\r\n    this.graphics.visible = opts.visible;\r\n    this.body.collisionType = CollisionType.Passive;\r\n\r\n    this.events.on('collisionstart', (evt: CollisionStartEvent<Actor>) => {\r\n      if (this.filter(evt.other)) {\r\n        this.events.emit('enter', new EnterTriggerEvent(this, evt.other));\r\n        this._dispatchAction();\r\n        // remove trigger if its done, -1 repeat forever\r\n        if (this.repeat === 0) {\r\n          this.kill();\r\n        }\r\n      }\r\n    });\r\n\r\n    this.events.on('collisionend', (evt: CollisionEndEvent<Actor>) => {\r\n      if (this.filter(evt.other)) {\r\n        this.events.emit('exit', new ExitTriggerEvent(this, evt.other));\r\n      }\r\n    });\r\n  }\r\n\r\n  public set target(target: Entity) {\r\n    this._target = target;\r\n    this.filter = (actor: Entity) => actor === target;\r\n  }\r\n\r\n  public get target() {\r\n    return this._target;\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n  private _dispatchAction() {\r\n    if (this.repeat !== 0) {\r\n      this.action.call(this);\r\n      this.repeat--;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Higher priorities run earlier than others in the system update\r\n */\r\nexport const SystemPriority = {\r\n  Highest: -Infinity,\r\n  Higher: -5,\r\n  Average: 0,\r\n  Lower: 5,\r\n  Lowest: Infinity\r\n} as const;","import { Scene } from '../Scene';\r\nimport { SystemPriority } from './Priority';\r\nimport { World } from './World';\r\n\r\n/**\r\n * Enum that determines whether to run the system in the update or draw phase\r\n */\r\nexport enum SystemType {\r\n  Update = 'update',\r\n  Draw = 'draw'\r\n}\r\n\r\n/**\r\n * An Excalibur [[System]] that updates entities of certain types.\r\n * Systems are scene specific\r\n *\r\n *\r\n *\r\n * Excalibur Systems currently require at least 1 Component type to operated\r\n *\r\n * Multiple types are declared as a type union\r\n * For example:\r\n *\r\n * ```typescript\r\n * class MySystem extends System<ComponentA | ComponentB> {\r\n *   public readonly types = ['a', 'b'] as const;\r\n *   public readonly systemType = SystemType.Update;\r\n *   public update(entities: Entity<ComponentA | ComponentB>) {\r\n *      ...\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport abstract class System {\r\n\r\n  /**\r\n   * Determine whether the system is called in the [[SystemType.Update]] or the [[SystemType.Draw]] phase. Update is first, then Draw.\r\n   */\r\n  abstract readonly systemType: SystemType;\r\n\r\n  /**\r\n   * System can execute in priority order, by default all systems are priority 0. Lower values indicated higher priority.\r\n   * For a system to execute before all other a lower priority value (-1 for example) must be set.\r\n   * For a system to execute after all other a higher priority value (10 for example) must be set.\r\n   */\r\n  public priority: number = SystemPriority.Average;\r\n\r\n  /**\r\n   * Optionally specify an initialize handler\r\n   * @param scene\r\n   */\r\n  initialize?(world: World, scene: Scene): void;\r\n\r\n  /**\r\n   * Update all entities that match this system's types\r\n   * @param entities Entities to update that match this system's types\r\n   * @param elapsedMs Time in milliseconds\r\n   */\r\n  abstract update(elapsedMs: number): void;\r\n\r\n  /**\r\n   * Optionally run a preupdate before the system processes matching entities\r\n   * @param scene\r\n   * @param elapsedMs Time in milliseconds since the last frame\r\n   */\r\n  preupdate?(scene: Scene, elapsedMs: number): void;\r\n\r\n  /**\r\n   * Optionally run a postupdate after the system processes matching entities\r\n   * @param scene\r\n   * @param elapsedMs Time in milliseconds since the last frame\r\n   */\r\n  postupdate?(scene: Scene, elapsedMs: number): void;\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Actor } from './Actor';\r\nimport { Color } from './Color';\r\nimport { Vector, vec } from './Math/vector';\r\nimport * as Util from './Util/Util';\r\nimport { Configurable } from './Configurable';\r\nimport { Random } from './Math/Random';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { GraphicsComponent } from './Graphics/GraphicsComponent';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { BoundingBox } from './Collision/BoundingBox';\r\nimport { clamp, randomInRange } from './Math/util';\r\nimport { Graphic } from './Graphics';\r\n\r\n/**\r\n * An enum that represents the types of emitter nozzles\r\n */\r\nexport enum EmitterType {\r\n  /**\r\n   * Constant for the circular emitter type\r\n   */\r\n  Circle,\r\n  /**\r\n   * Constant for the rectangular emitter type\r\n   */\r\n  Rectangle\r\n}\r\n\r\n/**\r\n * @hidden\r\n */\r\nexport class ParticleImpl extends Entity {\r\n  public position: Vector = new Vector(0, 0);\r\n  public velocity: Vector = new Vector(0, 0);\r\n  public acceleration: Vector = new Vector(0, 0);\r\n  public particleRotationalVelocity: number = 0;\r\n  public currentRotation: number = 0;\r\n\r\n  public focus: Vector = null;\r\n  public focusAccel: number = 0;\r\n  public opacity: number = 1;\r\n  public beginColor: Color = Color.White;\r\n  public endColor: Color = Color.White;\r\n\r\n  // Life is counted in ms\r\n  public life: number = 300;\r\n  public fadeFlag: boolean = false;\r\n\r\n  // Color transitions\r\n  private _rRate: number = 1;\r\n  private _gRate: number = 1;\r\n  private _bRate: number = 1;\r\n  private _aRate: number = 0;\r\n  private _currentColor: Color = Color.White;\r\n\r\n  public emitter: ParticleEmitter = null;\r\n  public particleSize: number = 5;\r\n  public particleSprite: Graphic = null;\r\n\r\n  public startSize: number;\r\n  public endSize: number;\r\n  public sizeRate: number = 0;\r\n  public elapsedMultiplier: number = 0;\r\n\r\n  public visible = true;\r\n  public isOffscreen = false;\r\n\r\n  public transform: TransformComponent;\r\n  public graphics: GraphicsComponent;\r\n\r\n  constructor(\r\n    emitterOrConfig: ParticleEmitter | ParticleArgs,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number,\r\n    particleSprite?: Graphic\r\n  ) {\r\n    super();\r\n    let emitter = emitterOrConfig;\r\n    if (emitter && !(emitterOrConfig instanceof ParticleEmitter)) {\r\n      const config = emitterOrConfig;\r\n      emitter = config.emitter;\r\n      life = config.life;\r\n      opacity = config.opacity;\r\n      endColor = config.endColor;\r\n      beginColor = config.beginColor;\r\n      position = config.position;\r\n      velocity = config.velocity;\r\n      acceleration = config.acceleration;\r\n      startSize = config.startSize;\r\n      endSize = config.endSize;\r\n      particleSprite = config.particleSprite;\r\n    }\r\n    this.emitter = <ParticleEmitter>emitter;\r\n    this.life = life || this.life;\r\n    this.opacity = opacity || this.opacity;\r\n    this.endColor = endColor || this.endColor.clone();\r\n    this.beginColor = beginColor || this.beginColor.clone();\r\n    this._currentColor = this.beginColor.clone();\r\n    this.particleSprite = particleSprite;\r\n\r\n    if (this.emitter.particleTransform === ParticleTransform.Global) {\r\n      const globalPos = this.emitter.transform.globalPos;\r\n      this.position = (position || this.position).add(globalPos);\r\n      this.velocity = (velocity || this.velocity).rotate(this.emitter.transform.globalRotation);\r\n    } else {\r\n      this.velocity = velocity || this.velocity;\r\n      this.position = (position || this.position);\r\n    }\r\n    this.acceleration = acceleration || this.acceleration;\r\n    this._rRate = (this.endColor.r - this.beginColor.r) / this.life;\r\n    this._gRate = (this.endColor.g - this.beginColor.g) / this.life;\r\n    this._bRate = (this.endColor.b - this.beginColor.b) / this.life;\r\n    this._aRate = this.opacity / this.life;\r\n\r\n    this.startSize = startSize || 0;\r\n    this.endSize = endSize || 0;\r\n\r\n    if (this.endSize > 0 && this.startSize > 0) {\r\n      this.sizeRate = (this.endSize - this.startSize) / this.life;\r\n      this.particleSize = this.startSize;\r\n    }\r\n\r\n    this.addComponent((this.transform = new TransformComponent()));\r\n    this.addComponent((this.graphics = new GraphicsComponent()));\r\n\r\n    this.transform.pos = this.position;\r\n    this.transform.rotation = this.currentRotation;\r\n    this.transform.scale = vec(1, 1); // TODO wut\r\n    this.transform.z = this.emitter.z;\r\n    if (this.particleSprite) {\r\n      this.graphics.opacity = this.opacity;\r\n      this.graphics.use(this.particleSprite);\r\n    } else {\r\n      this.graphics.localBounds = BoundingBox.fromDimension(this.particleSize, this.particleSize, Vector.Half);\r\n      this.graphics.onPostDraw = (ctx) => {\r\n        ctx.save();\r\n        this.graphics.opacity = this.opacity;\r\n        const tmpColor = this._currentColor.clone();\r\n        tmpColor.a = 1;\r\n        ctx.debug.drawPoint(vec(0, 0), { color: tmpColor, size: this.particleSize });\r\n        ctx.restore();\r\n      };\r\n    }\r\n  }\r\n\r\n  public kill() {\r\n    this.emitter.removeParticle(this);\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    this.life = this.life - delta;\r\n    this.elapsedMultiplier = this.elapsedMultiplier + delta;\r\n\r\n    if (this.life < 0) {\r\n      this.kill();\r\n    }\r\n\r\n    if (this.fadeFlag) {\r\n      this.opacity = clamp(this._aRate * this.life, 0.0001, 1);\r\n    }\r\n\r\n    if (this.startSize > 0 && this.endSize > 0) {\r\n      this.particleSize = clamp(\r\n        this.sizeRate * delta + this.particleSize,\r\n        Math.min(this.startSize, this.endSize),\r\n        Math.max(this.startSize, this.endSize)\r\n      );\r\n    }\r\n\r\n    this._currentColor.r = clamp(this._currentColor.r + this._rRate * delta, 0, 255);\r\n    this._currentColor.g = clamp(this._currentColor.g + this._gRate * delta, 0, 255);\r\n    this._currentColor.b = clamp(this._currentColor.b + this._bRate * delta, 0, 255);\r\n    this._currentColor.a = clamp(this.opacity, 0.0001, 1);\r\n\r\n    if (this.focus) {\r\n      const accel = this.focus\r\n        .sub(this.position)\r\n        .normalize()\r\n        .scale(this.focusAccel)\r\n        .scale(delta / 1000);\r\n      this.velocity = this.velocity.add(accel);\r\n    } else {\r\n      this.velocity = this.velocity.add(this.acceleration.scale(delta / 1000));\r\n    }\r\n    this.position = this.position.add(this.velocity.scale(delta / 1000));\r\n\r\n    if (this.particleRotationalVelocity) {\r\n      this.currentRotation = (this.currentRotation + (this.particleRotationalVelocity * delta) / 1000) % (2 * Math.PI);\r\n    }\r\n\r\n    this.transform.pos = this.position;\r\n    this.transform.rotation = this.currentRotation;\r\n    this.transform.scale = vec(1, 1); // todo wut\r\n    this.graphics.opacity = this.opacity;\r\n  }\r\n}\r\n\r\nexport interface ParticleArgs extends Partial<ParticleImpl> {\r\n  emitter: ParticleEmitter;\r\n  position?: Vector;\r\n  velocity?: Vector;\r\n  acceleration?: Vector;\r\n  particleRotationalVelocity?: number;\r\n  currentRotation?: number;\r\n  particleSize?: number;\r\n  particleSprite?: Graphic;\r\n}\r\n\r\n/**\r\n * Particle is used in a [[ParticleEmitter]]\r\n */\r\nexport class Particle extends Configurable(ParticleImpl) {\r\n  constructor(config: ParticleArgs);\r\n  constructor(\r\n    emitter: ParticleEmitter,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number,\r\n    particleSprite?: Graphic\r\n  );\r\n  constructor(\r\n    emitterOrConfig: ParticleEmitter | ParticleArgs,\r\n    life?: number,\r\n    opacity?: number,\r\n    beginColor?: Color,\r\n    endColor?: Color,\r\n    position?: Vector,\r\n    velocity?: Vector,\r\n    acceleration?: Vector,\r\n    startSize?: number,\r\n    endSize?: number,\r\n    particleSprite?: Graphic\r\n  ) {\r\n    super(emitterOrConfig, life, opacity, beginColor, endColor, position, velocity, acceleration, startSize, endSize, particleSprite);\r\n  }\r\n}\r\n\r\nexport enum ParticleTransform {\r\n  /**\r\n   * [[ParticleTransform.Global]] is the default and emits particles as if\r\n   * they were world space objects, useful for most effects.\r\n   */\r\n  Global = 'global',\r\n  /**\r\n   * [[ParticleTransform.Local]] particles are children of the emitter and move relative to the emitter\r\n   * as they would in a parent/child actor relationship.\r\n   */\r\n  Local = 'local'\r\n}\r\n\r\nexport interface ParticleEmitterArgs {\r\n  x?: number;\r\n  y?: number;\r\n  z?: number;\r\n  pos?: Vector;\r\n  width?: number;\r\n  height?: number;\r\n  isEmitting?: boolean;\r\n  minVel?: number;\r\n  maxVel?: number;\r\n  acceleration?: Vector;\r\n  minAngle?: number;\r\n  maxAngle?: number;\r\n  emitRate?: number;\r\n  particleLife?: number;\r\n  /**\r\n   * Optionally set the emitted particle transform style, [[ParticleTransform.Global]] is the default and emits particles as if\r\n   * they were world space objects, useful for most effects.\r\n   *\r\n   * If set to [[ParticleTransform.Local]] particles are children of the emitter and move relative to the emitter\r\n   * as they would in a parent/child actor relationship.\r\n   */\r\n  particleTransform?: ParticleTransform;\r\n  opacity?: number;\r\n  fadeFlag?: boolean;\r\n  focus?: Vector;\r\n  focusAccel?: number;\r\n  startSize?: number;\r\n  endSize?: number;\r\n  minSize?: number;\r\n  maxSize?: number;\r\n  beginColor?: Color;\r\n  endColor?: Color;\r\n  particleSprite?: Graphic;\r\n  emitterType?: EmitterType;\r\n  radius?: number;\r\n  particleRotationalVelocity?: number;\r\n  randomRotation?: boolean;\r\n  random?: Random;\r\n}\r\n\r\n/**\r\n * Using a particle emitter is a great way to create interesting effects\r\n * in your game, like smoke, fire, water, explosions, etc. `ParticleEmitter`\r\n * extend [[Actor]] allowing you to use all of the features that come with.\r\n */\r\nexport class ParticleEmitter extends Actor {\r\n  private _particlesToEmit: number = 0;\r\n\r\n  public numParticles: number = 0;\r\n\r\n  /**\r\n   * Random number generator\r\n   */\r\n  public random: Random;\r\n\r\n  /**\r\n   * Gets or sets the isEmitting flag\r\n   */\r\n  public isEmitting: boolean = true;\r\n  /**\r\n   * Gets or sets the backing particle collection\r\n   */\r\n  public particles: Particle[] = [];\r\n\r\n  /**\r\n   * Gets or sets the backing deadParticle collection\r\n   */\r\n  public deadParticles: Particle[] = [];\r\n\r\n  /**\r\n   * Gets or sets the minimum particle velocity\r\n   */\r\n  public minVel: number = 0;\r\n  /**\r\n   * Gets or sets the maximum particle velocity\r\n   */\r\n  public maxVel: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the acceleration vector for all particles\r\n   */\r\n  public acceleration: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Gets or sets the minimum angle in radians\r\n   */\r\n  public minAngle: number = 0;\r\n  /**\r\n   * Gets or sets the maximum angle in radians\r\n   */\r\n  public maxAngle: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the emission rate for particles (particles/sec)\r\n   */\r\n  public emitRate: number = 1; //particles/sec\r\n  /**\r\n   * Gets or sets the life of each particle in milliseconds\r\n   */\r\n  public particleLife: number = 2000;\r\n  /**\r\n   * Gets the opacity of each particle from 0 to 1.0\r\n   */\r\n  public get opacity(): number {\r\n    return this.graphics.opacity;\r\n  }\r\n  /**\r\n   * Gets the opacity of each particle from 0 to 1.0\r\n   */\r\n  public set opacity(opacity: number) {\r\n    this.graphics.opacity = opacity;\r\n  }\r\n  /**\r\n   * Gets or sets the fade flag which causes particles to gradually fade out over the course of their life.\r\n   */\r\n  public fadeFlag: boolean = false;\r\n\r\n  /**\r\n   * Gets or sets the optional focus where all particles should accelerate towards\r\n   */\r\n  public focus: Vector = null;\r\n  /**\r\n   * Gets or sets the acceleration for focusing particles if a focus has been specified\r\n   */\r\n  public focusAccel: number = null;\r\n  /**\r\n   * Gets or sets the optional starting size for the particles\r\n   */\r\n  public startSize: number = null;\r\n  /**\r\n   * Gets or sets the optional ending size for the particles\r\n   */\r\n  public endSize: number = null;\r\n\r\n  /**\r\n   * Gets or sets the minimum size of all particles\r\n   */\r\n  public minSize: number = 5;\r\n  /**\r\n   * Gets or sets the maximum size of all particles\r\n   */\r\n  public maxSize: number = 5;\r\n\r\n  /**\r\n   * Gets or sets the beginning color of all particles\r\n   */\r\n  public beginColor: Color = Color.White;\r\n  /**\r\n   * Gets or sets the ending color of all particles\r\n   */\r\n  public endColor: Color = Color.White;\r\n\r\n  private _sprite: Graphic = null;\r\n  /**\r\n   * Gets or sets the sprite that a particle should use\r\n   */\r\n  public get particleSprite(): Graphic {\r\n    return this._sprite;\r\n  }\r\n\r\n  public set particleSprite(val: Graphic) {\r\n    if (val) {\r\n      this._sprite = val;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the emitter type for the particle emitter\r\n   */\r\n  public emitterType: EmitterType = EmitterType.Rectangle;\r\n\r\n  /**\r\n   * Gets or sets the emitter radius, only takes effect when the [[emitterType]] is [[EmitterType.Circle]]\r\n   */\r\n  public radius: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the particle rotational speed velocity\r\n   */\r\n  public particleRotationalVelocity: number = 0;\r\n\r\n  /**\r\n   * Indicates whether particles should start with a random rotation\r\n   */\r\n  public randomRotation: boolean = false;\r\n\r\n  /**\r\n   * Gets or sets the emitted particle transform style, [[ParticleTransform.Global]] is the default and emits particles as if\r\n   * they were world space objects, useful for most effects.\r\n   *\r\n   * If set to [[ParticleTransform.Local]] particles are children of the emitter and move relative to the emitter\r\n   * as they would in a parent/child actor relationship.\r\n   */\r\n  public particleTransform: ParticleTransform = ParticleTransform.Global;\r\n\r\n  /**\r\n   * @param config particle emitter options bag\r\n   */\r\n  constructor(config: ParticleEmitterArgs) {\r\n    super({ width: config.width ?? 0, height: config.height ?? 0 });\r\n\r\n    const {\r\n      x,\r\n      y,\r\n      z,\r\n      pos,\r\n      isEmitting,\r\n      minVel,\r\n      maxVel,\r\n      acceleration,\r\n      minAngle,\r\n      maxAngle,\r\n      emitRate,\r\n      particleLife,\r\n      opacity,\r\n      fadeFlag,\r\n      focus,\r\n      focusAccel,\r\n      startSize,\r\n      endSize,\r\n      minSize,\r\n      maxSize,\r\n      beginColor,\r\n      endColor,\r\n      particleSprite,\r\n      emitterType,\r\n      radius,\r\n      particleRotationalVelocity,\r\n      particleTransform,\r\n      randomRotation,\r\n      random\r\n    } = { ...config };\r\n\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.z = z ?? 0;\r\n    this.isEmitting = isEmitting ?? this.isEmitting;\r\n    this.minVel = minVel ?? this.minVel;\r\n    this.maxVel = maxVel ?? this.maxVel;\r\n    this.acceleration = acceleration ?? this.acceleration;\r\n    this.minAngle = minAngle ?? this.minAngle;\r\n    this.maxAngle = maxAngle ?? this.maxAngle;\r\n    this.emitRate = emitRate ?? this.emitRate;\r\n    this.particleLife = particleLife ?? this.particleLife;\r\n    this.opacity = opacity ?? this.opacity;\r\n    this.fadeFlag = fadeFlag ?? this.fadeFlag;\r\n    this.focus = focus ?? this.focus;\r\n    this.focusAccel = focusAccel ?? this.focusAccel;\r\n    this.startSize = startSize ?? this.startSize;\r\n    this.endSize = endSize ?? this.endSize;\r\n    this.minSize = minSize ?? this.minSize;\r\n    this.maxSize = maxSize ?? this.maxSize;\r\n    this.beginColor = beginColor ?? this.beginColor;\r\n    this.endColor = endColor ?? this.endColor;\r\n    this.particleSprite = particleSprite ?? this.particleSprite;\r\n    this.emitterType = emitterType ?? this.emitterType;\r\n    this.radius = radius ?? this.radius;\r\n    this.particleRotationalVelocity = particleRotationalVelocity ?? this.particleRotationalVelocity;\r\n    this.randomRotation = randomRotation ?? this.randomRotation;\r\n    this.particleTransform = particleTransform ?? this.particleTransform;\r\n\r\n    this.body.collisionType = CollisionType.PreventCollision;\r\n\r\n    this.random = random ?? new Random();\r\n  }\r\n\r\n  public removeParticle(particle: Particle) {\r\n    this.deadParticles.push(particle);\r\n  }\r\n\r\n  /**\r\n   * Causes the emitter to emit particles\r\n   * @param particleCount  Number of particles to emit right now\r\n   */\r\n  public emitParticles(particleCount: number) {\r\n    for (let i = 0; i < particleCount; i++) {\r\n      const p = this._createParticle();\r\n      this.particles.push(p);\r\n      if (this?.scene?.world) {\r\n        if (this.particleTransform === ParticleTransform.Global) {\r\n          this.scene.world.add(p);\r\n        } else {\r\n          this.addChild(p);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public clearParticles() {\r\n    this.particles.length = 0;\r\n  }\r\n\r\n  // Creates a new particle given the constraints of the emitter\r\n  private _createParticle(): Particle {\r\n    // todo implement emitter constraints;\r\n    let ranX = 0;\r\n    let ranY = 0;\r\n\r\n    const angle = randomInRange(this.minAngle, this.maxAngle, this.random);\r\n    const vel = randomInRange(this.minVel, this.maxVel, this.random);\r\n    const size = this.startSize || randomInRange(this.minSize, this.maxSize, this.random);\r\n    const dx = vel * Math.cos(angle);\r\n    const dy = vel * Math.sin(angle);\r\n\r\n    if (this.emitterType === EmitterType.Rectangle) {\r\n      ranX = randomInRange(0, this.width, this.random);\r\n      ranY = randomInRange(0, this.height, this.random);\r\n    } else if (this.emitterType === EmitterType.Circle) {\r\n      const radius = randomInRange(0, this.radius, this.random);\r\n      ranX = radius * Math.cos(angle);\r\n      ranY = radius * Math.sin(angle);\r\n    }\r\n\r\n    const p = new Particle(\r\n      this,\r\n      this.particleLife,\r\n      this.opacity,\r\n      this.beginColor,\r\n      this.endColor,\r\n      new Vector(ranX, ranY),\r\n      new Vector(dx, dy),\r\n      this.acceleration,\r\n      this.startSize,\r\n      this.endSize,\r\n      this.particleSprite\r\n    );\r\n    p.fadeFlag = this.fadeFlag;\r\n    p.particleSize = size;\r\n    p.particleRotationalVelocity = this.particleRotationalVelocity;\r\n    if (this.randomRotation) {\r\n      p.currentRotation = randomInRange(0, Math.PI * 2, this.random);\r\n    }\r\n    if (this.focus) {\r\n      p.focus = this.focus.add(new Vector(this.pos.x, this.pos.y));\r\n      p.focusAccel = this.focusAccel;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public update(engine: Engine, delta: number) {\r\n    super.update(engine, delta);\r\n\r\n    if (this.isEmitting) {\r\n      this._particlesToEmit += this.emitRate * (delta / 1000);\r\n      if (this._particlesToEmit > 1.0) {\r\n        this.emitParticles(Math.floor(this._particlesToEmit));\r\n        this._particlesToEmit = this._particlesToEmit - Math.floor(this._particlesToEmit);\r\n      }\r\n    }\r\n\r\n    // deferred removal\r\n    for (let i = 0; i < this.deadParticles.length; i++) {\r\n      Util.removeItemFromArray(this.deadParticles[i], this.particles);\r\n      if (this?.scene?.world) {\r\n        this.scene.world.remove(this.deadParticles[i], false);\r\n      }\r\n    }\r\n    this.deadParticles.length = 0;\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { World } from './World';\r\nimport { removeItemFromArray } from '../Util/Util';\r\nimport { Scene } from '../Scene';\r\n\r\n// Add/Remove entities and components\r\n\r\nexport class EntityManager {\r\n  public entities: Entity[] = [];\r\n  public _entityIndex: { [entityId: string]: Entity } = {};\r\n\r\n  constructor(private _world: World) {}\r\n\r\n  /**\r\n   * Runs the entity lifecycle\r\n   * @param scene\r\n   * @param elapsed\r\n   */\r\n  public updateEntities(scene: Scene, elapsed: number) {\r\n    for (const entity of this.entities) {\r\n      entity.update(scene.engine, elapsed);\r\n      if (!entity.active) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  public findEntitiesForRemoval() {\r\n    for (const entity of this.entities) {\r\n      if (!entity.active) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds an entity to be tracked by the EntityManager\r\n   * @param entity\r\n   */\r\n  public addEntity(entity: Entity): void {\r\n    entity.active = true;\r\n    entity.scene = this._world.scene;\r\n    if (entity && !this._entityIndex[entity.id]) {\r\n      this._entityIndex[entity.id] = entity;\r\n      this.entities.push(entity);\r\n      this._world.queryManager.addEntity(entity);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => {\r\n        c.scene = entity.scene;\r\n        this.addEntity(c);\r\n      });\r\n      entity.childrenAdded$.register({\r\n        notify: (e) => {\r\n          this.addEntity(e);\r\n        }\r\n      });\r\n      entity.childrenRemoved$.register({\r\n        notify: (e) => {\r\n          this.removeEntity(e, false);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  public removeEntity(entity: Entity, deferred?: boolean): void;\r\n  public removeEntity(id: number, deferred?: boolean): void;\r\n  public removeEntity(idOrEntity: number | Entity, deferred = true): void {\r\n    let id = 0;\r\n    if (idOrEntity instanceof Entity) {\r\n      id = idOrEntity.id;\r\n    } else {\r\n      id = idOrEntity;\r\n    }\r\n    const entity = this._entityIndex[id];\r\n    if (entity && entity.active) {\r\n      entity.active = false;\r\n    }\r\n\r\n    if (entity && deferred) {\r\n      this._entitiesToRemove.push(entity);\r\n      return;\r\n    }\r\n\r\n    delete this._entityIndex[id];\r\n    if (entity) {\r\n      entity.scene = null;\r\n      removeItemFromArray(entity, this.entities);\r\n      this._world.queryManager.removeEntity(entity);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => {\r\n        c.scene = null;\r\n        this.removeEntity(c, deferred);\r\n      });\r\n      entity.childrenAdded$.clear();\r\n      entity.childrenRemoved$.clear();\r\n\r\n      // stats\r\n      if (this._world?.scene?.engine) {\r\n        this._world.scene.engine.stats.currFrame.actors.killed++;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _entitiesToRemove: Entity[] = [];\r\n  public processEntityRemovals(): void {\r\n    for (const entity of this._entitiesToRemove) {\r\n      if (entity.active) {\r\n        continue;\r\n      }\r\n      this.removeEntity(entity, false);\r\n    }\r\n    this._entitiesToRemove.length = 0;\r\n  }\r\n\r\n  public processComponentRemovals(): void {\r\n    for (const entity of this.entities) {\r\n      entity.processComponentRemoval();\r\n    }\r\n  }\r\n\r\n  public getById(id: number): Entity {\r\n    return this._entityIndex[id];\r\n  }\r\n\r\n  public getByName(name: string): Entity[]{\r\n    return this.entities.filter(e => e.name === name);\r\n  }\r\n\r\n  public clear(): void {\r\n    for (let i = this.entities.length - 1; i >= 0; i--) {\r\n      this.removeEntity(this.entities[i]);\r\n    }\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { Observable } from '../Util/Observable';\r\nimport { Component, ComponentCtor } from '../EntityComponentSystem/Component';\r\n\r\nexport type ComponentInstance<T> = T extends ComponentCtor<infer R> ? R : never;\r\n\r\n/**\r\n * Represents query for entities that match a list of types that is cached and observable\r\n *\r\n * Queries can be strongly typed by supplying a type union in the optional type parameter\r\n * ```typescript\r\n * const queryAB = new ex.Query<ComponentTypeA | ComponentTypeB>(['A', 'B']);\r\n * ```\r\n */\r\nexport class Query<TKnownComponentCtors extends ComponentCtor<Component> = never> {\r\n  public readonly id: string;\r\n  public components = new Set<TKnownComponentCtors>();\r\n  public entities: Entity<ComponentInstance<TKnownComponentCtors>>[] = [];\r\n  /**\r\n   * This fires right after the component is added\r\n   */\r\n  public entityAdded$ = new Observable<Entity<ComponentInstance<TKnownComponentCtors>>>();\r\n  /**\r\n   * This fires right before the component is actually removed from the entity, it will still be available for cleanup purposes\r\n   */\r\n  public entityRemoved$ = new Observable<Entity<ComponentInstance<TKnownComponentCtors>>>();\r\n\r\n  constructor(public readonly requiredComponents: TKnownComponentCtors[]) {\r\n    if (requiredComponents.length === 0) {\r\n      throw new Error('Cannot create query without components');\r\n    }\r\n    for (const type of requiredComponents) {\r\n      this.components.add(type);\r\n    }\r\n\r\n    this.id = Query.createId(requiredComponents);\r\n  }\r\n\r\n  static createId(requiredComponents: Function[]) {\r\n    // TODO what happens if a user defines the same type name as a built in type\r\n    // ! TODO this could be dangerous depending on the bundler's settings for names\r\n    // Maybe some kind of hash function is better here?\r\n    return requiredComponents.slice().map(c => c.name).sort().join('-');\r\n  }\r\n\r\n  /**\r\n   * Potentially adds an entity to a query index, returns true if added, false if not\r\n   * @param entity\r\n   */\r\n  checkAndAdd(entity: Entity) {\r\n    if (!this.entities.includes(entity) && entity.hasAll(Array.from(this.components))) {\r\n      this.entities.push(entity);\r\n      this.entityAdded$.notifyAll(entity);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  removeEntity(entity: Entity) {\r\n    const index = this.entities.indexOf(entity);\r\n    if (index > -1) {\r\n      this.entities.splice(index, 1);\r\n      this.entityRemoved$.notifyAll(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a list of entities that match the query\r\n   * @param sort Optional sorting function to sort entities returned from the query\r\n   */\r\n  public getEntities(sort?: (a: Entity, b: Entity) => number): Entity<ComponentInstance<TKnownComponentCtors>>[] {\r\n    if (sort) {\r\n      this.entities.sort(sort);\r\n    }\r\n    return this.entities;\r\n  }\r\n}","import { Observable } from '../Util/Observable';\r\nimport { Entity } from './Entity';\r\n\r\n\r\nexport class TagQuery<TKnownTags extends string = never> {\r\n  public readonly id: string;\r\n  public tags = new Set<TKnownTags>();\r\n  public entities: Entity<any>[] = [];\r\n  /**\r\n   * This fires right after the component is added\r\n   */\r\n  public entityAdded$ = new Observable<Entity<any>>();\r\n  /**\r\n   * This fires right before the component is actually removed from the entity, it will still be available for cleanup purposes\r\n   */\r\n  public entityRemoved$ = new Observable<Entity<any>>();\r\n\r\n  constructor(public readonly requiredTags: TKnownTags[]) {\r\n    if (requiredTags.length === 0) {\r\n      throw new Error('Cannot create tag query without tags');\r\n    }\r\n    for (const tag of requiredTags) {\r\n      this.tags.add(tag);\r\n    }\r\n\r\n    this.id = TagQuery.createId(requiredTags);\r\n  }\r\n\r\n  static createId(requiredComponents: string[]) {\r\n    return requiredComponents.slice().sort().join('-');\r\n  }\r\n\r\n  checkAndAdd(entity: Entity) {\r\n    if (!this.entities.includes(entity) && entity.hasAllTags(Array.from(this.tags))) {\r\n      this.entities.push(entity);\r\n      this.entityAdded$.notifyAll(entity);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  removeEntity(entity: Entity) {\r\n    const index = this.entities.indexOf(entity);\r\n    if (index > -1) {\r\n      this.entities.splice(index, 1);\r\n      this.entityRemoved$.notifyAll(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a list of entities that match the query\r\n   * @param sort Optional sorting function to sort entities returned from the query\r\n   */\r\n  public getEntities(sort?: (a: Entity, b: Entity) => number): Entity<any>[] {\r\n    if (sort) {\r\n      this.entities.sort(sort);\r\n    }\r\n    return this.entities;\r\n  }\r\n}","import { Entity } from './Entity';\r\nimport { Query } from './Query';\r\nimport { Component, ComponentCtor } from './Component';\r\nimport { World } from './World';\r\nimport { TagQuery } from './TagQuery';\r\n\r\n/**\r\n * The query manager is responsible for updating all queries when entities/components change\r\n */\r\nexport class QueryManager {\r\n  private _queries = new Map<string, Query<any>>();\r\n  private _addComponentHandlers = new Map<Entity, (c: Component) => any>();\r\n  private _removeComponentHandlers = new Map<Entity, (c: Component) => any>();\r\n  private _componentToQueriesIndex = new Map<ComponentCtor<any>, Query<any>[]>();\r\n\r\n  private _tagQueries = new Map<string, TagQuery<any>>();\r\n  private _addTagHandlers = new Map<Entity, (tag: string) => any>();\r\n  private _removeTagHandlers = new Map<Entity, (tag: string) => any>();\r\n  private _tagToQueriesIndex = new Map<string, TagQuery<any>[]>();\r\n\r\n  constructor(private _world: World) {}\r\n\r\n  public createQuery<TKnownComponentCtors extends ComponentCtor<Component>>(\r\n    requiredComponents: TKnownComponentCtors[]): Query<TKnownComponentCtors> {\r\n    const id = Query.createId(requiredComponents);\r\n    if (this._queries.has(id)) {\r\n      // short circuit if query is already created\r\n      return this._queries.get(id) as Query<TKnownComponentCtors>;\r\n    }\r\n\r\n    const query = new Query(requiredComponents);\r\n\r\n    this._queries.set(query.id, query);\r\n\r\n    // index maintenance\r\n    for (const component of requiredComponents) {\r\n      const queries = this._componentToQueriesIndex.get(component);\r\n      if (!queries) {\r\n        this._componentToQueriesIndex.set(component, [query]);\r\n      } else {\r\n        queries.push(query);\r\n      }\r\n    }\r\n\r\n    for (const entity of this._world.entities) {\r\n      this.addEntity(entity);\r\n    }\r\n\r\n    return query;\r\n  }\r\n\r\n  public createTagQuery<TKnownTags extends string>(requiredTags: TKnownTags[]): TagQuery<TKnownTags> {\r\n    const id = TagQuery.createId(requiredTags);\r\n    if (this._tagQueries.has(id)) {\r\n      // short circuit if query is already created\r\n      return this._tagQueries.get(id) as TagQuery<TKnownTags>;\r\n    }\r\n\r\n    const query = new TagQuery(requiredTags);\r\n\r\n    this._tagQueries.set(query.id, query);\r\n\r\n    // index maintenance\r\n    for (const tag of requiredTags) {\r\n      const queries = this._tagToQueriesIndex.get(tag);\r\n      if (!queries) {\r\n        this._tagToQueriesIndex.set(tag, [query]);\r\n      } else {\r\n        queries.push(query);\r\n      }\r\n    }\r\n\r\n    for (const entity of this._world.entities) {\r\n      this.addEntity(entity);\r\n    }\r\n\r\n    return query;\r\n  }\r\n\r\n  private _createAddComponentHandler = (entity: Entity) => (c: Component) => {\r\n    this.addComponent(entity, c);\r\n  };\r\n\r\n  private _createRemoveComponentHandler = (entity: Entity) => (c: Component) => {\r\n    this.removeComponent(entity, c);\r\n  };\r\n\r\n  private _createAddTagHandler = (entity: Entity) => (tag: string) => {\r\n    this.addTag(entity, tag);\r\n  };\r\n\r\n  private _createRemoveTagHandler = (entity: Entity) => (tag: string) => {\r\n    this.removeTag(entity, tag);\r\n  };\r\n\r\n  /**\r\n   * Scans queries and locates any that need this entity added\r\n   * @param entity\r\n   */\r\n  addEntity(entity: Entity) {\r\n    const maybeAddComponent = this._addComponentHandlers.get(entity);\r\n    const maybeRemoveComponent = this._removeComponentHandlers.get(entity);\r\n    const addComponent = maybeAddComponent ?? this._createAddComponentHandler(entity);\r\n    const removeComponent = maybeRemoveComponent ?? this._createRemoveComponentHandler(entity);\r\n    this._addComponentHandlers.set(entity, addComponent);\r\n    this._removeComponentHandlers.set(entity, removeComponent);\r\n\r\n    const maybeAddTag = this._addTagHandlers.get(entity);\r\n    const maybeRemoveTag = this._removeTagHandlers.get(entity);\r\n    const addTag = maybeAddTag ?? this._createAddTagHandler(entity);\r\n    const removeTag = maybeRemoveTag ?? this._createRemoveTagHandler(entity);\r\n    this._addTagHandlers.set(entity, addTag);\r\n    this._removeTagHandlers.set(entity, removeTag);\r\n\r\n    for (const query of this._queries.values()) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n    for (const tagQuery of this._tagQueries.values()) {\r\n      tagQuery.checkAndAdd(entity);\r\n    }\r\n    entity.componentAdded$.subscribe(addComponent);\r\n    entity.componentRemoved$.subscribe(removeComponent);\r\n    entity.tagAdded$.subscribe(addTag);\r\n    entity.tagRemoved$.subscribe(removeTag);\r\n  }\r\n\r\n  /**\r\n   * Scans queries and locates any that need this entity removed\r\n   * @param entity\r\n   */\r\n  removeEntity(entity: Entity) {\r\n    // Handle components\r\n    const addComponent = this._addComponentHandlers.get(entity);\r\n    const removeComponent = this._removeComponentHandlers.get(entity);\r\n    for (const query of this._queries.values()) {\r\n      query.removeEntity(entity);\r\n    }\r\n    if (addComponent) {\r\n      entity.componentAdded$.unsubscribe(addComponent);\r\n    }\r\n    if (removeComponent) {\r\n      entity.componentRemoved$.unsubscribe(removeComponent);\r\n    }\r\n\r\n    // Handle tags\r\n    const addTag = this._addTagHandlers.get(entity);\r\n    const removeTag = this._removeTagHandlers.get(entity);\r\n    for (const tagQuery of this._tagQueries.values()) {\r\n      tagQuery.removeEntity(entity);\r\n    }\r\n\r\n    if (addTag) {\r\n      entity.tagAdded$.unsubscribe(addTag);\r\n    }\r\n    if (removeTag) {\r\n      entity.tagRemoved$.unsubscribe(removeTag);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is added to an entity\r\n   * @param entity\r\n   * @param component\r\n   */\r\n  addComponent(entity: Entity, component: Component) {\r\n    const queries = this._componentToQueriesIndex.get(component.constructor as ComponentCtor<any>) ?? [];\r\n    for (const query of queries) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is removed from an entity\r\n   * @param entity\r\n   * @param component\r\n   */\r\n  removeComponent(entity: Entity, component: Component) {\r\n    const queries = this._componentToQueriesIndex.get(component.constructor as ComponentCtor<any>) ?? [];\r\n    for (const query of queries) {\r\n      query.removeEntity(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a tag is added to an entity\r\n   * @param entity\r\n   * @param tag\r\n   */\r\n  addTag(entity: Entity, tag: string) {\r\n    const queries = this._tagToQueriesIndex.get(tag) ?? [];\r\n    for (const query of queries) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is removed from an entity\r\n   * @param entity\r\n   * @param tag\r\n   */\r\n  removeTag(entity: Entity, tag: string) {\r\n    const queries = this._tagToQueriesIndex.get(tag) ?? [];\r\n    for (const query of queries) {\r\n      query.removeEntity(entity);\r\n    }\r\n  }\r\n\r\n\r\n}\r\n","import { System, SystemType } from './System';\nimport { Scene } from '../Scene';\nimport { World } from './World';\nimport { removeItemFromArray } from '../Util/Util';\n\nexport interface SystemCtor<T extends System> {\n  new (...args: any[]): T;\n}\n\n/**\n *\n */\nexport function isSystemConstructor(x: any): x is SystemCtor<System> {\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\n}\n\n/**\n * The SystemManager is responsible for keeping track of all systems in a scene.\n * Systems are scene specific\n */\nexport class SystemManager {\n  /**\n   * List of systems, to add a new system call [[SystemManager.addSystem]]\n   */\n  public systems: System[] = [];\n  public initialized = false;\n  constructor(private _world: World) {}\n\n  /**\n   * Get a system registered in the manager by type\n   * @param systemType\n   */\n  public get<T extends System>(systemType: SystemCtor<T>): T | null {\n    return this.systems.find((s) => s instanceof systemType) as unknown as T;\n  }\n\n  /**\n   * Adds a system to the manager, it will now be updated every frame\n   * @param systemOrCtor\n   */\n  public addSystem(systemOrCtor: SystemCtor<System> | System): void {\n    let system: System;\n    if (systemOrCtor instanceof System) {\n      system = systemOrCtor;\n    } else {\n      system = new systemOrCtor(this._world);\n    }\n\n    this.systems.push(system);\n    this.systems.sort((a, b) => a.priority - b.priority);\n    // If systems are added and the manager has already been init'd\n    // then immediately init the system\n    if (this.initialized && system.initialize) {\n      system.initialize(this._world, this._world.scene);\n    }\n  }\n\n  /**\n   * Removes a system from the manager, it will no longer be updated\n   * @param system\n   */\n  public removeSystem(system: System) {\n    removeItemFromArray(system, this.systems);\n  }\n\n  /**\n   * Initialize all systems in the manager\n   *\n   * Systems added after initialize() will be initialized on add\n   */\n  public initialize() {\n    if (!this.initialized) {\n      this.initialized = true;\n      for (const s of this.systems) {\n        if (s.initialize) {\n          s.initialize(this._world, this._world.scene);\n        }\n      }\n    }\n  }\n\n  /**\n   * Updates all systems\n   * @param type whether this is an update or draw system\n   * @param scene context reference\n   * @param delta time in milliseconds\n   */\n  public updateSystems(type: SystemType, scene: Scene, delta: number) {\n    const systems = this.systems.filter((s) => s.systemType === type);\n    for (const s of systems) {\n      if (s.preupdate) {\n        s.preupdate(scene, delta);\n      }\n    }\n\n    for (const s of systems) {\n      s.update(delta);\n    }\n\n    for (const s of systems) {\n      if (s.postupdate) {\n        s.postupdate(scene, delta);\n      }\n    }\n  }\n\n  public clear(): void {\n    for (let i = this.systems.length - 1; i >= 0; i--) {\n      this.removeSystem(this.systems[i]);\n    }\n  }\n}\n","import { Scene } from '../Scene';\r\nimport { Component, ComponentCtor } from './Component';\r\nimport { Entity } from './Entity';\r\nimport { EntityManager } from './EntityManager';\r\nimport { Query } from './Query';\r\nimport { QueryManager } from './QueryManager';\r\nimport { System, SystemType } from './System';\r\nimport { SystemCtor, SystemManager, isSystemConstructor } from './SystemManager';\r\nimport { TagQuery } from './TagQuery';\r\n\r\n/**\r\n * The World is a self-contained entity component system for a particular context.\r\n */\r\nexport class World {\r\n  public queryManager: QueryManager = new QueryManager(this);\r\n  public entityManager: EntityManager = new EntityManager(this);\r\n  public systemManager: SystemManager = new SystemManager(this);\r\n\r\n  /**\r\n   * The context type is passed to the system updates\r\n   * @param scene\r\n   */\r\n  constructor(public scene: Scene) {}\r\n\r\n  /**\r\n   * Query the ECS world for entities that match your components\r\n   * @param requiredTypes\r\n   */\r\n  query<TKnownComponentCtors extends ComponentCtor<Component>>(\r\n    requiredTypes: TKnownComponentCtors[]): Query<TKnownComponentCtors> {\r\n    return this.queryManager.createQuery(requiredTypes);\r\n  }\r\n\r\n  queryTags<TKnownTags extends string>(requiredTags: TKnownTags[]): TagQuery<TKnownTags> {\r\n    return this.queryManager.createTagQuery(requiredTags);\r\n  }\r\n\r\n  /**\r\n   * Update systems by type and time elapsed in milliseconds\r\n   */\r\n  update(type: SystemType, delta: number) {\r\n    if (type === SystemType.Update) {\r\n      this.entityManager.updateEntities(this.scene, delta);\r\n    }\r\n    this.systemManager.updateSystems(type, this.scene, delta);\r\n    this.entityManager.findEntitiesForRemoval();\r\n    this.entityManager.processComponentRemovals();\r\n    this.entityManager.processEntityRemovals();\r\n  }\r\n\r\n  /**\r\n   * Add an entity to the ECS world\r\n   * @param entity\r\n   */\r\n  add(entity: Entity): void;\r\n  /**\r\n   * Add a system to the ECS world\r\n   * @param system\r\n   */\r\n  add(system: System): void;\r\n  add(system: SystemCtor<System>): void;\r\n  add(entityOrSystem: Entity | System | SystemCtor<System>): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.addEntity(entityOrSystem);\r\n    }\r\n\r\n    if (entityOrSystem instanceof System || isSystemConstructor(entityOrSystem)) {\r\n      this.systemManager.addSystem(entityOrSystem);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a system out of the ECS world\r\n   */\r\n  get(system: SystemCtor<System>) {\r\n    return this.systemManager.get(system);\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from the ECS world\r\n   * @param entity\r\n   */\r\n  remove(entity: Entity, deferred?: boolean): void;\r\n  /**\r\n   * Remove a system from the ECS world\r\n   * @param system\r\n   */\r\n  remove(system: System): void;\r\n  remove(entityOrSystem: Entity | System, deferred = true): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.removeEntity(entityOrSystem, deferred);\r\n    }\r\n\r\n    if (entityOrSystem instanceof System) {\r\n      this.systemManager.removeSystem(entityOrSystem);\r\n    }\r\n  }\r\n\r\n  get entities() {\r\n    return this.entityManager.entities;\r\n  }\r\n\r\n  clearEntities(): void {\r\n    this.entityManager.clear();\r\n  }\r\n\r\n  clearSystems(): void {\r\n    this.systemManager.clear();\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\nimport { TransformComponent } from '../EntityComponentSystem';\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\n\nexport class EulerIntegrator {\n  // Scratch vectors to avoid allocation\n  private static _POS = new Vector(0, 0);\n  private static _SCALE = new Vector(1, 1);\n\n  private static _ACC = new Vector(0, 0);\n  private static _VEL = new Vector(0, 0);\n  private static _VEL_ACC = new Vector(0, 0);\n  private static _SCALE_FACTOR = new Vector(0, 0);\n\n  static integrate(transform: TransformComponent, motion: MotionComponent, totalAcc: Vector, elapsedMs: number): void {\n    const seconds = elapsedMs / 1000;\n    // This code looks a little wild, but it's to avoid creating any new Vector instances\n    // integration is done in a tight loop so this is key to avoid GC'ing\n    motion.vel.addEqual(totalAcc.scale(seconds, EulerIntegrator._ACC));\n    transform.pos\n      .add(motion.vel.scale(seconds, EulerIntegrator._VEL), EulerIntegrator._POS)\n      .addEqual(totalAcc.scale(0.5 * seconds * seconds, EulerIntegrator._VEL_ACC));\n\n    motion.angularVelocity += motion.torque * (1.0 / motion.inertia) * seconds;\n    const rotation = transform.rotation + motion.angularVelocity * seconds;\n\n    transform.scale.add(motion.scaleFactor.scale(seconds, this._SCALE_FACTOR), EulerIntegrator._SCALE);\n    const tx = transform.get();\n    tx.setTransform(EulerIntegrator._POS, rotation, EulerIntegrator._SCALE);\n  }\n}\n","import { Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { BodyComponent } from './BodyComponent';\r\nimport { CollisionType } from './CollisionType';\r\nimport { EulerIntegrator } from './Integrator';\r\nimport { PhysicsWorld } from './PhysicsWorld';\r\n\r\nexport class MotionSystem extends System {\r\n  public systemType = SystemType.Update;\r\n  public priority = SystemPriority.Higher;\r\n  private _physicsConfigDirty = false;\r\n  query: Query<typeof TransformComponent | typeof MotionComponent>;\r\n  constructor(public world: World, public physics: PhysicsWorld) {\r\n    super();\r\n    physics.$configUpdate.subscribe(() => this._physicsConfigDirty = true);\r\n    this.query = this.world.query([TransformComponent, MotionComponent]);\r\n  }\r\n\r\n  update(elapsedMs: number): void {\r\n    let transform: TransformComponent;\r\n    let motion: MotionComponent;\r\n    const entities = this.query.entities;\r\n    for (let i = 0; i < entities.length; i++) {\r\n      transform = entities[i].get(TransformComponent);\r\n      motion = entities[i].get(MotionComponent);\r\n\r\n      const optionalBody = entities[i].get(BodyComponent);\r\n      if (this._physicsConfigDirty && optionalBody) {\r\n        optionalBody.updatePhysicsConfig(this.physics.config.bodies);\r\n      }\r\n\r\n      if (optionalBody?.sleeping) {\r\n        continue;\r\n      }\r\n\r\n      const totalAcc = motion.acc.clone();\r\n      if (optionalBody?.collisionType === CollisionType.Active && optionalBody?.useGravity) {\r\n        totalAcc.addEqual(this.physics.config.gravity);\r\n      }\r\n      optionalBody?.captureOldTransform();\r\n\r\n      // Update transform and motion based on Euler linear algebra\r\n      EulerIntegrator.integrate(transform, motion, totalAcc, elapsedMs);\r\n    }\r\n    this._physicsConfigDirty = false;\r\n  }\r\n}\r\n","import { PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Side } from '../Side';\r\nimport { CollisionSolver } from './Solver';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { ContactBias, ContactSolveBias, HorizontalFirst, None, VerticalFirst } from './ContactBias';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\nimport { DeepRequired } from '../../Util/Required';\r\n\r\n/**\r\n * ArcadeSolver is the default in Excalibur. It solves collisions so that there is no overlap between contacts,\r\n * and negates velocity along the collision normal.\r\n *\r\n * This is usually the type of collisions used for 2D games that don't need a more realistic collision simulation.\r\n *\r\n */\r\nexport class ArcadeSolver implements CollisionSolver {\r\n  directionMap = new Map<string, 'horizontal' | 'vertical'>();\r\n  distanceMap = new Map<string, number>();\r\n\r\n  constructor(public config: DeepRequired<Pick<PhysicsConfig, 'arcade'>['arcade']>) {}\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter(c => !c.isCanceled());\r\n\r\n    // Locate collision bias order\r\n    let bias: ContactBias;\r\n    switch (this.config.contactSolveBias) {\r\n      case ContactSolveBias.HorizontalFirst: {\r\n        bias = HorizontalFirst;\r\n        break;\r\n      }\r\n      case ContactSolveBias.VerticalFirst: {\r\n        bias = VerticalFirst;\r\n        break;\r\n      }\r\n      default: {\r\n        bias = None;\r\n      }\r\n    }\r\n\r\n    // Sort by bias (None, VerticalFirst, HorizontalFirst) to avoid artifacts with seams\r\n    // Sort contacts by distance to avoid artifacts with seams\r\n    // It's important to solve in a specific order\r\n    contacts.sort((a, b) => {\r\n      const aDir = this.directionMap.get(a.id);\r\n      const bDir = this.directionMap.get(b.id);\r\n      const aDist = this.distanceMap.get(a.id);\r\n      const bDist = this.distanceMap.get(b.id);\r\n      return (bias[aDir] - bias[bDir]) || (aDist - bDist);\r\n    });\r\n\r\n    for (const contact of contacts) {\r\n      // Solve position first in arcade\r\n      this.solvePosition(contact);\r\n\r\n      // Solve velocity second in arcade\r\n      this.solveVelocity(contact);\r\n    }\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  public preSolve(contacts: CollisionContact[]) {\r\n    const epsilon = .0001;\r\n    for (const contact of contacts) {\r\n      if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n        // Cancel near 0 mtv collisions\r\n        contact.cancel();\r\n        continue;\r\n      }\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n\r\n      const distance = contact.colliderA.worldPos.squareDistance(contact.colliderB.worldPos);\r\n      this.distanceMap.set(contact.id, distance);\r\n\r\n      this.directionMap.set(contact.id, side === Side.Left || side === Side.Right ? 'horizontal' : 'vertical');\r\n\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderA, contact.colliderB, side, mtv, contact));\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate(), contact)\r\n      );\r\n    }\r\n  }\r\n\r\n  public postSolve(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      if (contact.isCanceled()) {\r\n        continue;\r\n      }\r\n      const colliderA = contact.colliderA;\r\n      const colliderB = contact.colliderB;\r\n      const bodyA = colliderA.owner?.get(BodyComponent);\r\n      const bodyB = colliderB.owner?.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderA, contact.colliderB, side, mtv, contact));\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate(), contact)\r\n      );\r\n    }\r\n  }\r\n\r\n  public solvePosition(contact: CollisionContact) {\r\n    const epsilon = .0001;\r\n    // if bounds no longer intersect skip to the next\r\n    // this removes jitter from overlapping/stacked solid tiles or a wall of solid tiles\r\n    if (!contact.colliderA.bounds.overlaps(contact.colliderB.bounds, epsilon)) {\r\n      // Cancel the contact to prevent and solving\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n      // Cancel near 0 mtv collisions\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    let mtv = contact.mtv;\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      if (bodyA.collisionType === CollisionType.Active && bodyB.collisionType === CollisionType.Active) {\r\n        // split overlaps if both are Active\r\n        mtv = mtv.scale(0.5);\r\n      }\r\n\r\n      // Resolve overlaps\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        bodyA.globalPos.x -= mtv.x;\r\n        bodyA.globalPos.y -= mtv.y;\r\n        colliderA.update(bodyA.transform.get());\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        bodyB.globalPos.x += mtv.x;\r\n        bodyB.globalPos.y += mtv.y;\r\n        colliderB.update(bodyB.transform.get());\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  public solveVelocity(contact: CollisionContact) {\r\n    if (contact.isCanceled()) {\r\n      return;\r\n    }\r\n\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n\r\n    if (bodyA && bodyB) {\r\n\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      const normal = contact.normal;\r\n      const opposite = normal.negate();\r\n\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform when sliding off\r\n        if (bodyA.vel.normalize().dot(opposite) < 0) {\r\n          // Cancel out velocity opposite direction of collision normal\r\n          const velAdj = normal.scale(normal.dot(bodyA.vel.negate()));\r\n          bodyA.vel = bodyA.vel.add(velAdj);\r\n        }\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform\r\n        if (bodyB.vel.normalize().dot(normal) < 0) {\r\n          const velAdj = opposite.scale(opposite.dot(bodyB.vel.negate()));\r\n          bodyB.vel = bodyB.vel.add(velAdj);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\n\r\n/**\r\n * Holds information about contact points, meant to be reused over multiple frames of contact\r\n */\r\nexport class ContactConstraintPoint {\r\n  constructor(public point: Vector, public local: Vector, public contact: CollisionContact) {\r\n    this.update();\r\n  }\r\n\r\n  /**\r\n   * Updates the contact information\r\n   */\r\n  update() {\r\n    const bodyA = this.contact.colliderA.owner?.get(BodyComponent);\r\n    const bodyB = this.contact.colliderB.owner?.get(BodyComponent);\r\n\r\n    if (bodyA && bodyB) {\r\n      const normal = this.contact.normal;\r\n      const tangent = this.contact.tangent;\r\n\r\n      this.aToContact = this.point.sub(bodyA.globalPos);\r\n      this.bToContact = this.point.sub(bodyB.globalPos);\r\n\r\n      const aToContactNormal = this.aToContact.cross(normal);\r\n      const bToContactNormal = this.bToContact.cross(normal);\r\n\r\n      this.normalMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n        bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n      const aToContactTangent = this.aToContact.cross(tangent);\r\n      const bToContactTangent = this.bToContact.cross(tangent);\r\n\r\n      this.tangentMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n        bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns the relative velocity between bodyA and bodyB\r\n   */\r\n  public getRelativeVelocity() {\r\n    const bodyA = this.contact.colliderA.owner?.get(BodyComponent);\r\n    const bodyB = this.contact.colliderB.owner?.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      // Relative velocity in linear terms\r\n      // Angular to linear velocity formula -> omega = velocity/radius so omega x radius = velocity\r\n      const velA = bodyA.vel.add(Vector.cross(bodyA.angularVelocity, this.aToContact));\r\n      const velB = bodyB.vel.add(Vector.cross(bodyB.angularVelocity, this.bToContact));\r\n      return velB.sub(velA);\r\n    }\r\n    return Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Impulse accumulated over time in normal direction\r\n   */\r\n  public normalImpulse: number = 0;\r\n\r\n  /**\r\n   * Impulse accumulated over time in the tangent direction\r\n   */\r\n  public tangentImpulse: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the normal direction\r\n   */\r\n  public normalMass: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the tangent direction\r\n   */\r\n  public tangentMass: number = 0;\r\n\r\n  /**\r\n   * Direction from center of mass of bodyA to contact point\r\n   */\r\n  public aToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Direction from center of mass of bodyB to contact point\r\n   */\r\n  public bToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Original contact velocity combined with bounciness\r\n   */\r\n  public originalVelocityAndRestitution: number = 0;\r\n}\r\n","import { CollisionPostSolveEvent, CollisionPreSolveEvent, PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { clamp } from '../../Math/util';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { ContactConstraintPoint } from './ContactConstraintPoint';\r\nimport { Side } from '../Side';\r\nimport { CollisionSolver } from './Solver';\r\nimport { BodyComponent, DegreeOfFreedom } from '../BodyComponent';\r\nimport { CollisionJumpTable } from '../Colliders/CollisionJumpTable';\r\nimport { DeepRequired } from '../../Util/Required';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\n\r\nexport class RealisticSolver implements CollisionSolver {\r\n  constructor(public config: DeepRequired<Pick<PhysicsConfig, 'realistic'>['realistic']>) {}\r\n  lastFrameContacts: Map<string, CollisionContact> = new Map();\r\n\r\n  // map contact id to contact points\r\n  idToContactConstraint: Map<string, ContactConstraintPoint[]> = new Map();\r\n\r\n  getContactConstraints(id: string) {\r\n    return this.idToContactConstraint.get(id) ?? [];\r\n  }\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter(c => !c.isCanceled());\r\n\r\n    // Solve velocity first\r\n    this.solveVelocity(contacts);\r\n\r\n    // Solve position last because non-overlap is the most important\r\n    this.solvePosition(contacts);\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  preSolve(contacts: CollisionContact[]) {\r\n    const epsilon = .0001;\r\n    for (const contact of contacts) {\r\n      if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n        // Cancel near 0 mtv collisions\r\n        contact.cancel();\r\n        continue;\r\n      }\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      contact.colliderA.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact));\r\n      contact.colliderA.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact)\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n\r\n      // Match awake state for sleeping\r\n      contact.matchAwake();\r\n    }\r\n\r\n    // Keep track of contacts that done\r\n    const finishedContactIds = Array.from(this.idToContactConstraint.keys());\r\n    for (const contact of contacts) {\r\n      // Remove all current contacts that are not done\r\n      const index = finishedContactIds.indexOf(contact.id);\r\n      if (index > -1) {\r\n        finishedContactIds.splice(index, 1);\r\n      }\r\n      const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n      let pointIndex = 0;\r\n      const bodyA = contact.colliderA.owner.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        for (const point of contact.points) {\r\n          const normal = contact.normal;\r\n          const tangent = contact.tangent;\r\n\r\n          const aToContact = point.sub(bodyA.globalPos);\r\n          const bToContact = point.sub(bodyB.globalPos);\r\n\r\n          const aToContactNormal = aToContact.cross(normal);\r\n          const bToContactNormal = bToContact.cross(normal);\r\n\r\n          const normalMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n            bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n          const aToContactTangent = aToContact.cross(tangent);\r\n          const bToContactTangent = bToContact.cross(tangent);\r\n\r\n          const tangentMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n            bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n\r\n          // Preserve normal/tangent impulse by re-using the contact point if it's close\r\n          if (contactPoints[pointIndex] && contactPoints[pointIndex]?.point?.squareDistance(point) < 4) {\r\n            contactPoints[pointIndex].point = point;\r\n            contactPoints[pointIndex].local = contact.localPoints[pointIndex];\r\n          } else {\r\n            // new contact if it's not close or doesn't exist\r\n            contactPoints[pointIndex] = new ContactConstraintPoint(point, contact.localPoints[pointIndex], contact);\r\n          }\r\n\r\n          // Update contact point calculations\r\n          contactPoints[pointIndex].aToContact = aToContact;\r\n          contactPoints[pointIndex].bToContact = bToContact;\r\n          contactPoints[pointIndex].normalMass = 1.0 / normalMass;\r\n          contactPoints[pointIndex].tangentMass = 1.0 / tangentMass;\r\n\r\n          // Calculate relative velocity before solving to accurately do restitution\r\n          const restitution = bodyA.bounciness > bodyB.bounciness ? bodyA.bounciness : bodyB.bounciness;\r\n          const relativeVelocity = contact.normal.dot(contactPoints[pointIndex].getRelativeVelocity());\r\n          contactPoints[pointIndex].originalVelocityAndRestitution = 0;\r\n          if (relativeVelocity < -0.1) { // TODO what's a good threshold here?\r\n            contactPoints[pointIndex].originalVelocityAndRestitution = -restitution * relativeVelocity;\r\n          }\r\n          pointIndex++;\r\n        }\r\n      }\r\n      this.idToContactConstraint.set(contact.id, contactPoints);\r\n    }\r\n\r\n    // Clean up any contacts that did not occur last frame\r\n    for (const id of finishedContactIds) {\r\n      this.idToContactConstraint.delete(id);\r\n    }\r\n\r\n    // Warm contacts with accumulated impulse\r\n    // Useful for tall stacks\r\n    if (this.config.warmStart) {\r\n      this.warmStart(contacts);\r\n    } else {\r\n      for (const contact of contacts) {\r\n        const contactPoints = this.getContactConstraints(contact.id);\r\n        for (const point of contactPoints) {\r\n          point.normalImpulse = 0;\r\n          point.tangentImpulse = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  postSolve(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      const bodyA = contact.colliderA.owner.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner.get(BodyComponent);\r\n\r\n      if (bodyA && bodyB) {\r\n        // Skip post solve for active+passive collisions\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n\r\n        // Update motion values for sleeping\r\n        bodyA.updateMotion();\r\n        bodyB.updateMotion();\r\n      }\r\n\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      contact.colliderA.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact)\r\n      );\r\n      contact.colliderA.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact)\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n    }\r\n\r\n    // Store contacts\r\n    this.lastFrameContacts.clear();\r\n    for (const c of contacts) {\r\n      this.lastFrameContacts.set(c.id, c);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Warm up body's based on previous frame contact points\r\n   * @param contacts\r\n   */\r\n  warmStart(contacts: CollisionContact[]) {\r\n    for (const contact of contacts) {\r\n      const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n      const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n        for (const point of contactPoints) {\r\n          if (this.config.warmStart) {\r\n            const normalImpulse = contact.normal.scale(point.normalImpulse);\r\n            const tangentImpulse = contact.tangent.scale(point.tangentImpulse);\r\n            const impulse = normalImpulse.add(tangentImpulse);\r\n\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          } else {\r\n            point.normalImpulse = 0;\r\n            point.tangentImpulse = 0;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Iteratively solve the position overlap constraint\r\n   * @param contacts\r\n   */\r\n  solvePosition(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < this.config.positionIterations; i++) {\r\n      for (const contact of contacts) {\r\n        const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n        const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n          for (const point of constraints) {\r\n            const normal = contact.normal;\r\n            const separation = CollisionJumpTable.FindContactSeparation(contact, point.local);\r\n\r\n            const steeringConstant = this.config.steeringFactor; //0.2;\r\n            const maxCorrection = -5;\r\n            const slop = this.config.slop; //1;\r\n\r\n            // Clamp to avoid over-correction\r\n            // Remember that we are shooting for 0 overlap in the end\r\n            const steeringForce = clamp(steeringConstant * (separation + slop), maxCorrection, 0);\r\n            const impulse = normal.scale(-steeringForce * point.normalMass);\r\n\r\n            // This is a pseudo impulse, meaning we aren't doing a real impulse calculation\r\n            // We adjust position and rotation instead of doing the velocity\r\n            if (bodyA.collisionType === CollisionType.Active) {\r\n              // TODO make applyPseudoImpulse function?\r\n              const impulseForce = impulse.negate().scale(bodyA.inverseMass);\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyA.globalPos = bodyA.globalPos.add(impulseForce);\r\n              if (!bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyA.rotation -= point.aToContact.cross(impulse) * bodyA.inverseInertia;\r\n              }\r\n            }\r\n\r\n            if (bodyB.collisionType === CollisionType.Active) {\r\n              const impulseForce = impulse.scale(bodyB.inverseMass);\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyB.globalPos = bodyB.globalPos.add(impulseForce);\r\n              if (!bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyB.rotation += point.bToContact.cross(impulse) * bodyB.inverseInertia;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  solveVelocity(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < this.config.velocityIterations; i++) {\r\n      for (const contact of contacts) {\r\n        const bodyA = contact.colliderA.owner?.get(BodyComponent);\r\n        const bodyB = contact.colliderB.owner?.get(BodyComponent);\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const friction = Math.min(bodyA.friction, bodyB.friction);\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n          // Friction constraint\r\n          for (const point of constraints) {\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Negate velocity in tangent direction to simulate friction\r\n            const tangentVelocity = -relativeVelocity.dot(contact.tangent);\r\n            let impulseDelta = tangentVelocity * point.tangentMass;\r\n\r\n            // Clamping based in Erin Catto's GDC 2006 talk\r\n            // Correct clamping https://github.com/erincatto/box2d-lite/blob/master/docs/GDC2006_Catto_Erin_PhysicsTutorial.pdf\r\n            // Accumulated fiction impulse is always between -uMaxFriction < dT < uMaxFriction\r\n            // But deltas can vary\r\n            const maxFriction = friction * point.normalImpulse;\r\n            const newImpulse = clamp(point.tangentImpulse + impulseDelta, -maxFriction, maxFriction);\r\n            impulseDelta = newImpulse - point.tangentImpulse;\r\n            point.tangentImpulse = newImpulse;\r\n\r\n            const impulse = contact.tangent.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n\r\n          // Bounce constraint\r\n          for (const point of constraints) {\r\n            // Need to recalc relative velocity because the previous step could have changed vel\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Compute impulse in normal direction\r\n            const normalVelocity = relativeVelocity.dot(contact.normal);\r\n\r\n            // Per Erin it is a mistake to apply the restitution inside the iteration\r\n            // From Erin Catto's Box2D we keep original contact velocity and adjust by small impulses\r\n            let impulseDelta = -point.normalMass * (normalVelocity - point.originalVelocityAndRestitution);\r\n\r\n            // Clamping based in Erin Catto's GDC 2014 talk\r\n            // Accumulated impulse stored in the contact is always positive (dV > 0)\r\n            // But deltas can be negative\r\n            const newImpulse = Math.max(point.normalImpulse + impulseDelta, 0);\r\n            impulseDelta = newImpulse - point.normalImpulse;\r\n            point.normalImpulse = newImpulse;\r\n\r\n            const impulse = contact.normal.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { ComponentCtor, Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { CollisionEndEvent, CollisionStartEvent, ContactEndEvent, ContactStartEvent } from '../Events';\r\nimport { SolverStrategy } from './SolverStrategy';\r\nimport { ArcadeSolver } from './Solver/ArcadeSolver';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { RealisticSolver } from './Solver/RealisticSolver';\r\nimport { CollisionSolver } from './Solver/Solver';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { Engine } from '../Engine';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Scene } from '../Scene';\r\nimport { Side } from '../Collision/Side';\r\nimport { DynamicTreeCollisionProcessor } from './Detection/DynamicTreeCollisionProcessor';\r\nimport { PhysicsWorld } from './PhysicsWorld';\r\nexport class CollisionSystem extends System {\r\n  public systemType = SystemType.Update;\r\n  public priority = SystemPriority.Higher;\r\n  public query: Query<ComponentCtor<TransformComponent> | ComponentCtor<MotionComponent> | ComponentCtor<ColliderComponent>>;\r\n\r\n  private _engine: Engine;\r\n  private _configDirty = false;\r\n  private _realisticSolver: RealisticSolver;\r\n  private _arcadeSolver: ArcadeSolver;\r\n  private _lastFrameContacts = new Map<string, CollisionContact>();\r\n  private _currentFrameContacts = new Map<string, CollisionContact>();\r\n  private get _processor(): DynamicTreeCollisionProcessor {\r\n    return this._physics.collisionProcessor;\r\n  };\r\n\r\n  private _trackCollider: (c: Collider) => void;\r\n  private _untrackCollider: (c: Collider) => void;\r\n\r\n  constructor(world: World, private _physics: PhysicsWorld) {\r\n    super();\r\n    this._arcadeSolver = new ArcadeSolver(_physics.config.arcade);\r\n    this._realisticSolver = new RealisticSolver(_physics.config.realistic);\r\n    this._physics.$configUpdate.subscribe(() => this._configDirty = true);\r\n    this._trackCollider = (c: Collider) => this._processor.track(c);\r\n    this._untrackCollider = (c: Collider) => this._processor.untrack(c);\r\n    this.query = world.query([TransformComponent, MotionComponent, ColliderComponent]);\r\n    this.query.entityAdded$.subscribe(e => {\r\n      const colliderComponent = e.get(ColliderComponent);\r\n      colliderComponent.$colliderAdded.subscribe(this._trackCollider);\r\n      colliderComponent.$colliderRemoved.subscribe(this._untrackCollider);\r\n      const collider = colliderComponent.get();\r\n      if (collider) {\r\n        this._processor.track(collider);\r\n      }\r\n    });\r\n    this.query.entityRemoved$.subscribe(e => {\r\n      const colliderComponent = e.get(ColliderComponent);\r\n      const collider = colliderComponent.get();\r\n      if (colliderComponent && collider) {\r\n        this._processor.untrack(collider);\r\n      }\r\n    });\r\n  }\r\n\r\n  initialize(world: World, scene: Scene) {\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  update(elapsedMs: number): void {\r\n    if (!this._physics.config.enabled) {\r\n      return;\r\n    }\r\n\r\n    // Collect up all the colliders and update them\r\n    let colliders: Collider[] = [];\r\n    for (const entity of this.query.entities) {\r\n      const colliderComp = entity.get(ColliderComponent);\r\n      const collider = colliderComp?.get();\r\n      if (colliderComp && colliderComp.owner?.active && collider) {\r\n        colliderComp.update();\r\n        if (collider instanceof CompositeCollider) {\r\n          const compositeColliders = collider.getColliders();\r\n          if (!collider.compositeStrategy) {\r\n            collider.compositeStrategy = this._physics.config.colliders.compositeStrategy;\r\n          }\r\n          colliders = colliders.concat(compositeColliders);\r\n        } else {\r\n          colliders.push(collider);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update the spatial partitioning data structures\r\n    // TODO if collider invalid it will break the processor\r\n    // TODO rename \"update\" to something more specific\r\n    this._processor.update(colliders);\r\n\r\n    // Run broadphase on all colliders and locates potential collisions\r\n    const pairs = this._processor.broadphase(colliders, elapsedMs);\r\n\r\n    this._currentFrameContacts.clear();\r\n\r\n    // Given possible pairs find actual contacts\r\n    let contacts = this._processor.narrowphase(pairs, this._engine?.debug?.stats?.currFrame);\r\n\r\n    const solver: CollisionSolver = this.getSolver();\r\n\r\n    // Solve, this resolves the position/velocity so entities aren't overlapping\r\n    contacts = solver.solve(contacts);\r\n\r\n    // Record contacts for start/end\r\n    for (const contact of contacts) {\r\n      if (contact.isCanceled()) {\r\n        continue;\r\n      }\r\n      // Process composite ids, things with the same composite id are treated as the same collider for start/end\r\n      const index = contact.id.indexOf('|');\r\n      if (index > 0) {\r\n        const compositeId = contact.id.substring(index + 1);\r\n        this._currentFrameContacts.set(compositeId, contact);\r\n      } else {\r\n        this._currentFrameContacts.set(contact.id, contact);\r\n      }\r\n    }\r\n\r\n    // Emit contact start/end events\r\n    this.runContactStartEnd();\r\n\r\n    // reset the last frame cache\r\n    this._lastFrameContacts.clear();\r\n\r\n    // Keep track of collisions contacts that have started or ended\r\n    this._lastFrameContacts = new Map(this._currentFrameContacts);\r\n\r\n    // Process deferred collider removals\r\n    for (const entity of this.query.entities) {\r\n      const collider = entity.get(ColliderComponent);\r\n      if (collider) {\r\n        collider.processColliderRemoval();\r\n      }\r\n    }\r\n  }\r\n\r\n  getSolver(): CollisionSolver {\r\n    if (this._configDirty) {\r\n      this._configDirty = false;\r\n      this._arcadeSolver = new ArcadeSolver(this._physics.config.arcade);\r\n      this._realisticSolver = new RealisticSolver(this._physics.config.realistic);\r\n    }\r\n    return this._physics.config.solver === SolverStrategy.Realistic ? this._realisticSolver : this._arcadeSolver;\r\n  }\r\n\r\n  debug(ex: ExcaliburGraphicsContext) {\r\n    this._processor.debug(ex);\r\n  }\r\n\r\n  public runContactStartEnd() {\r\n    // If composite colliders are 'together' collisions may have a duplicate id because we want to treat those as a singular start/end\r\n    for (const [id, c] of this._currentFrameContacts) {\r\n      // find all new contacts\r\n      if (!this._lastFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        const side = Side.fromDirection(c.mtv);\r\n        const opposite = Side.getOpposite(side);\r\n        colliderA.events.emit('collisionstart', new CollisionStartEvent(colliderA, colliderB, side, c));\r\n        colliderA.events.emit('contactstart', new ContactStartEvent(colliderA, colliderB, side, c) as any);\r\n        colliderB.events.emit('collisionstart', new CollisionStartEvent(colliderB, colliderA, opposite, c));\r\n        colliderB.events.emit('contactstart', new ContactStartEvent(colliderB, colliderA, opposite, c) as any);\r\n      }\r\n    }\r\n\r\n    // find all contacts that have ceased\r\n    for (const [id, c] of this._lastFrameContacts) {\r\n      if (!this._currentFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        const side = Side.fromDirection(c.mtv);\r\n        const opposite = Side.getOpposite(side);\r\n        colliderA.events.emit('collisionend', new CollisionEndEvent(colliderA, colliderB, side, c));\r\n        colliderA.events.emit('contactend', new ContactEndEvent(colliderA, colliderB, side, c) as any);\r\n        colliderB.events.emit('collisionend', new CollisionEndEvent(colliderB, colliderA, opposite, c));\r\n        colliderB.events.emit('contactend', new ContactEndEvent(colliderB, colliderA, opposite, c) as any);\r\n      }\r\n    }\r\n  }\r\n}\r\n","export type Constructor<T> = {\r\n  new (...args: any[]): T;\r\n};\r\n/**\r\n * Configurable helper extends base type and makes all properties available as option bag arguments\r\n * @internal\r\n * @param base\r\n */\r\nexport function Configurable<T extends Constructor<{}>>(base: T): T {\r\n  return class extends base {\r\n    public assign(props: Partial<T>) {\r\n      //set the value of every property that was passed in,\r\n      //if the constructor previously set this value, it will be overridden here\r\n      for (const k in props) {\r\n        // eslint-disable-next-line\r\n        if (typeof (<any>this)[k] !== 'function') {\r\n          // eslint-disable-next-line\r\n          (<any>this)[k] = (<any>props)[k];\r\n        }\r\n      }\r\n    }\r\n\r\n    constructor(...args: any[]) {\r\n      super(...args);\r\n      //get the number of arguments that aren't undefined. TS passes a value to all parameters\r\n      //of whatever ctor is the implementation, so args.length doesn't work here.\r\n      const size = args.filter(function(value) {\r\n        return value !== undefined;\r\n      }).length;\r\n      if (size === 1 && args[0] && typeof args[0] === 'object' && !(args[0] instanceof Array)) {\r\n        this.assign(args[0]);\r\n      }\r\n    }\r\n  };\r\n}\r\n","import { Transform } from '../Math/transform';\r\n\r\n/**\r\n * Blend 2 transforms for interpolation, will interpolate from the context of newTx's parent if it exists\r\n */\r\nexport function blendTransform(oldTx: Transform, newTx: Transform, blend: number, target?: Transform): Transform {\r\n  if (oldTx.parent !== newTx.parent) {\r\n    // Caller expects a local transform\r\n    // Adjust old tx to be local to the new parent whatever that is\r\n    const oldTxWithNewParent = oldTx.clone();\r\n    const oldGlobalPos = oldTx.globalPos.clone();\r\n    const oldGlobalScale = oldTx.globalScale.clone();\r\n    const oldGlobalRotation = oldTx.globalRotation;\r\n    oldTxWithNewParent.parent = newTx.parent;\r\n    oldTxWithNewParent.globalPos = oldGlobalPos;\r\n    oldTxWithNewParent.globalScale = oldGlobalScale;\r\n    oldTxWithNewParent.globalRotation = oldGlobalRotation;\r\n    oldTx = oldTxWithNewParent;\r\n  }\r\n  let interpolatedPos = newTx.pos;\r\n  let interpolatedScale = newTx.scale;\r\n  let interpolatedRotation = newTx.rotation;\r\n\r\n  interpolatedPos = newTx.pos.scale(blend).add(\r\n    oldTx.pos.scale(1.0 - blend)\r\n  );\r\n  interpolatedScale = newTx.scale.scale(blend).add(\r\n    oldTx.scale.scale(1.0 - blend)\r\n  );\r\n  // Rotational lerp https://stackoverflow.com/a/30129248\r\n  const cosine = (1.0 - blend) * Math.cos(oldTx.rotation) + blend * Math.cos(newTx.rotation);\r\n  const sine = (1.0 - blend) * Math.sin(oldTx.rotation) + blend * Math.sin(newTx.rotation);\r\n  interpolatedRotation = Math.atan2(sine, cosine);\r\n\r\n  const tx = target ?? new Transform();\r\n  tx.setTransform(interpolatedPos, interpolatedRotation, interpolatedScale);\r\n  return tx;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function blendGlobalTransform(oldTx: Transform, newTx: Transform, blend: number, target?: Transform): Transform {\r\n  let interpolatedPos = newTx.globalPos;\r\n  let interpolatedScale = newTx.globalScale;\r\n  let interpolatedRotation = newTx.globalRotation;\r\n\r\n  interpolatedPos = newTx.globalPos.scale(blend).add(\r\n    oldTx.globalPos.scale(1.0 - blend)\r\n  );\r\n  interpolatedScale = newTx.globalScale.scale(blend).add(\r\n    oldTx.globalScale.scale(1.0 - blend)\r\n  );\r\n  // Rotational lerp https://stackoverflow.com/a/30129248\r\n  const cosine = (1.0 - blend) * Math.cos(oldTx.globalRotation) + blend * Math.cos(newTx.globalRotation);\r\n  const sine = (1.0 - blend) * Math.sin(oldTx.globalRotation) + blend * Math.sin(newTx.globalRotation);\r\n  interpolatedRotation = Math.atan2(sine, cosine);\r\n\r\n  const tx = target ?? new Transform();\r\n  tx.setTransform(interpolatedPos, interpolatedRotation, interpolatedScale);\r\n  return tx;\r\n}","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Scene } from '../Scene';\r\nimport { GraphicsComponent } from './GraphicsComponent';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Camera } from '../Camera';\r\nimport { Query, System, SystemPriority, SystemType, World } from '../EntityComponentSystem';\r\nimport { Engine } from '../Engine';\r\nimport { GraphicsGroup } from './GraphicsGroup';\r\nimport { Particle } from '../Particles'; // this import seems to bomb wallaby\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { FontCache } from './FontCache';\r\nimport { PostDrawEvent, PostTransformDrawEvent, PreDrawEvent, PreTransformDrawEvent } from '../Events';\r\nimport { Transform } from '../Math/transform';\r\nimport { blendTransform } from './TransformInterpolation';\r\nimport { Graphic } from './Graphic';\r\n\r\nexport class GraphicsSystem extends System {\r\n  public readonly systemType = SystemType.Draw;\r\n  public priority = SystemPriority.Average;\r\n  private _token = 0;\r\n  private _graphicsContext: ExcaliburGraphicsContext;\r\n  private _camera: Camera;\r\n  private _engine: Engine;\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  query: Query<typeof TransformComponent | typeof GraphicsComponent>;\r\n  public get sortedTransforms() {\r\n    return this._sortedTransforms;\r\n  }\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, GraphicsComponent]);\r\n    this.query.entityAdded$.subscribe(e => {\r\n      const tx = e.get(TransformComponent);\r\n      this._sortedTransforms.push(tx);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    });\r\n    this.query.entityRemoved$.subscribe(e => {\r\n      const tx = e.get(TransformComponent);\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    // Graphics context could be switched to fallback in a new frame\r\n    this._graphicsContext = this._engine.graphicsContext;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return a.z - b.z;\r\n      });\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    this._token++;\r\n    let graphics: GraphicsComponent;\r\n    FontCache.checkAndClearCache();\r\n\r\n    // This is a performance enhancement, most things are in world space\r\n    // so if we can only do this once saves a ton of transform updates\r\n    this._graphicsContext.save();\r\n    if (this._camera) {\r\n      this._camera.draw(this._graphicsContext);\r\n    }\r\n    for (const transform of this._sortedTransforms) {\r\n      const entity = transform.owner as Entity;\r\n\r\n      // If the entity is offscreen skip\r\n      if (entity.hasTag('ex.offscreen')) {\r\n        continue;\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      // Exit if graphics set to not visible\r\n      if (!graphics.visible) {\r\n        continue;\r\n      }\r\n\r\n      // Optionally run the onPreTransformDraw graphics lifecycle draw\r\n      if (graphics.onPreTransformDraw) {\r\n        graphics.onPreTransformDraw(this._graphicsContext, delta);\r\n      }\r\n      entity.events.emit('pretransformdraw', new PreTransformDrawEvent(this._graphicsContext, delta, entity));\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.restore();\r\n      }\r\n\r\n      this._graphicsContext.save();\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n\r\n      // Tick any graphics state (but only once) for animations and graphics groups\r\n      graphics.update(delta, this._token);\r\n\r\n      // Apply parallax\r\n      const parallax = entity.get(ParallaxComponent);\r\n      if (parallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(parallax.parallaxFactor);\r\n        const parallaxOffset = this._camera.drawPos.scale(oneMinusFactor);\r\n        this._graphicsContext.translate(parallaxOffset.x, parallaxOffset.y);\r\n      }\r\n\r\n      // Position the entity + estimate lag\r\n      this._applyTransform(entity);\r\n\r\n      // If there is a material enable it on the context\r\n      if (graphics.material) {\r\n        this._graphicsContext.material = graphics.material;\r\n      }\r\n\r\n      // Optionally run the onPreDraw graphics lifecycle draw\r\n      if (graphics.onPreDraw) {\r\n        graphics.onPreDraw(this._graphicsContext, delta);\r\n      }\r\n      entity.events.emit('predraw', new PreDrawEvent(this._graphicsContext, delta, entity));\r\n\r\n      // TODO remove this hack on the particle redo\r\n      // Remove this line after removing the wallaby import\r\n      const particleOpacity = (entity instanceof Particle) ? entity.opacity : 1;\r\n      this._graphicsContext.opacity *= graphics.opacity * particleOpacity;\r\n\r\n      // Draw the graphics component\r\n      this._drawGraphicsComponent(graphics, transform);\r\n\r\n      // Optionally run the onPostDraw graphics lifecycle draw\r\n      if (graphics.onPostDraw) {\r\n        graphics.onPostDraw(this._graphicsContext, delta);\r\n      }\r\n      entity.events.emit('postdraw', new PostDrawEvent(this._graphicsContext, delta, entity));\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      // Reset the transform back to the original world space\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.save();\r\n        if (this._camera) {\r\n          this._camera.draw(this._graphicsContext);\r\n        }\r\n      }\r\n\r\n      // Optionally run the onPreTransformDraw graphics lifecycle draw\r\n      if (graphics.onPostTransformDraw) {\r\n        graphics.onPostTransformDraw(this._graphicsContext, delta);\r\n      }\r\n      entity.events.emit('posttransformdraw', new PostTransformDrawEvent(this._graphicsContext, delta, entity));\r\n    }\r\n    this._graphicsContext.restore();\r\n  }\r\n\r\n  private _drawGraphicsComponent(graphicsComponent: GraphicsComponent, transformComponent: TransformComponent) {\r\n    if (graphicsComponent.visible) {\r\n      const flipHorizontal = graphicsComponent.flipHorizontal;\r\n      const flipVertical = graphicsComponent.flipVertical;\r\n\r\n      const graphic = graphicsComponent.current;\r\n      const options = graphicsComponent.currentOptions ?? {};\r\n\r\n      if (graphic) {\r\n        let anchor = graphicsComponent.anchor;\r\n        let offset = graphicsComponent.offset;\r\n        let scaleX = 1;\r\n        let scaleY = 1;\r\n        // handle specific overrides\r\n        if (options?.anchor) {\r\n          anchor = options.anchor;\r\n        }\r\n        if (options?.offset) {\r\n          offset = options.offset;\r\n        }\r\n        const globalScale = transformComponent.globalScale;\r\n        scaleX *= graphic.scale.x * globalScale.x;\r\n        scaleY *= graphic.scale.y * globalScale.y;\r\n\r\n        // See https://github.com/excaliburjs/Excalibur/pull/619 for discussion on this formula\r\n        const offsetX = -graphic.width * anchor.x + offset.x * scaleX;\r\n        const offsetY = -graphic.height * anchor.y + offset.y * scaleY;\r\n\r\n        const oldFlipHorizontal = graphic.flipHorizontal;\r\n        const oldFlipVertical = graphic.flipVertical;\r\n        if (flipHorizontal || flipVertical) {\r\n          // flip any currently flipped graphics\r\n          graphic.flipHorizontal = flipHorizontal ? !oldFlipHorizontal : oldFlipHorizontal;\r\n          graphic.flipVertical = flipVertical ? !oldFlipVertical : oldFlipVertical;\r\n        }\r\n\r\n        graphic?.draw(\r\n          this._graphicsContext,\r\n          offsetX,\r\n          offsetY);\r\n\r\n        if (flipHorizontal || flipVertical) {\r\n          graphic.flipHorizontal = oldFlipHorizontal;\r\n          graphic.flipVertical = oldFlipVertical;\r\n        }\r\n\r\n        // TODO move debug code out?\r\n        if (this._engine?.isDebug && this._engine.debug.graphics.showBounds) {\r\n          const offset = vec(offsetX, offsetY);\r\n          if (graphic instanceof GraphicsGroup) {\r\n            for (const member of graphic.members) {\r\n              let g: Graphic;\r\n              let pos: Vector = Vector.Zero;\r\n              if (member instanceof Graphic) {\r\n                g = member;\r\n              } else {\r\n                g = member.graphic;\r\n                pos = member.offset;\r\n              }\r\n\r\n              if (graphic.useAnchor) {\r\n                g?.localBounds.translate(offset.add(pos)).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n              } else {\r\n                g?.localBounds.translate(pos).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n              }\r\n            }\r\n          } else {\r\n            /* istanbul ignore next */\r\n            graphic?.localBounds.translate(offset).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _targetInterpolationTransform = new Transform();\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (const ancestor of ancestors) {\r\n      const transform = ancestor?.get(TransformComponent);\r\n      const optionalBody = ancestor?.get(BodyComponent);\r\n      let tx = transform.get();\r\n      if (optionalBody) {\r\n        if (this._engine.fixedUpdateFps &&\r\n          optionalBody.__oldTransformCaptured &&\r\n          optionalBody.enableFixedUpdateInterpolate) {\r\n          // Interpolate graphics if needed\r\n          const blend = this._engine.currentFrameLagMs / (1000 / this._engine.fixedUpdateFps);\r\n          tx = blendTransform(optionalBody.oldTransform, transform.get(), blend, this._targetInterpolationTransform);\r\n        }\r\n      }\r\n\r\n      if (transform) {\r\n        this._graphicsContext.z = transform.z;\r\n        this._graphicsContext.translate(tx.pos.x, tx.pos.y);\r\n        this._graphicsContext.scale(tx.scale.x, tx.scale.y);\r\n        this._graphicsContext.rotate(tx.rotation);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Camera } from '../Camera';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Entity, Query, SystemPriority, TransformComponent, World } from '../EntityComponentSystem';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { toDegrees } from '../Math/util';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { CollisionSystem } from '../Collision/CollisionSystem';\r\nimport { CompositeCollider  } from '../Collision/Colliders/CompositeCollider';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Particle } from '../Particles';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { Debug } from '../Graphics/Debug';\r\n\r\nexport class DebugSystem extends System {\r\n  public readonly systemType = SystemType.Draw;\r\n  public priority = SystemPriority.Lowest;\r\n  private _graphicsContext: ExcaliburGraphicsContext;\r\n  private _collisionSystem: CollisionSystem;\r\n  private _camera: Camera;\r\n  private _engine: Engine;\r\n  query: Query<typeof TransformComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent]);\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._graphicsContext = scene.engine.graphicsContext;\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n    this._collisionSystem = world.systemManager.get(CollisionSystem);\r\n  }\r\n\r\n  update(): void {\r\n    if (!this._engine.isDebug) {\r\n      return;\r\n    }\r\n\r\n    const filterSettings = this._engine.debug.filter;\r\n\r\n    let id: number;\r\n    let name: string;\r\n    const entitySettings = this._engine.debug.entity;\r\n\r\n    let tx: TransformComponent;\r\n    const txSettings = this._engine.debug.transform;\r\n\r\n    let motion: MotionComponent;\r\n    const motionSettings = this._engine.debug.motion;\r\n\r\n    let colliderComp: ColliderComponent;\r\n    const colliderSettings = this._engine.debug.collider;\r\n\r\n    const physicsSettings = this._engine.debug.physics;\r\n\r\n    let graphics: GraphicsComponent;\r\n    const graphicsSettings = this._engine.debug.graphics;\r\n\r\n    let debugDraw: DebugGraphicsComponent;\r\n\r\n    let body: BodyComponent;\r\n    const bodySettings = this._engine.debug.body;\r\n\r\n    const cameraSettings = this._engine.debug.camera;\r\n    for (const entity of this.query.entities) {\r\n      if (entity.hasTag('offscreen')) {\r\n        // skip offscreen entities\r\n        continue;\r\n      }\r\n      if (entity instanceof Particle) {\r\n        // Particles crush the renderer :(\r\n        continue;\r\n      }\r\n      if (filterSettings.useFilter) {\r\n        const allIds = filterSettings.ids.length === 0;\r\n        const idMatch = allIds || filterSettings.ids.includes(entity.id);\r\n        if (!idMatch) {\r\n          continue;\r\n        }\r\n        const allNames = filterSettings.nameQuery === '';\r\n        const nameMatch = allNames || entity.name.includes(filterSettings.nameQuery);\r\n        if (!nameMatch) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      let cursor = Vector.Zero;\r\n      const lineHeight = vec(0, 16);\r\n      id = entity.id;\r\n      name = entity.name;\r\n      tx = entity.get(TransformComponent);\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      this._pushCameraTransform(tx);\r\n\r\n      this._graphicsContext.save();\r\n      if (tx.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n      this._graphicsContext.z = txSettings.debugZIndex;\r\n\r\n      this._applyTransform(entity);\r\n      if (tx) {\r\n        if (txSettings.showAll || txSettings.showPosition) {\r\n          this._graphicsContext.debug.drawPoint(Vector.Zero, { size: 4, color: txSettings.positionColor });\r\n        }\r\n        if (txSettings.showAll || txSettings.showPositionLabel) {\r\n          this._graphicsContext.debug.drawText(`pos${tx.pos.toString(2)}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n        if (txSettings.showAll || txSettings.showZIndex) {\r\n          this._graphicsContext.debug.drawText(`z(${tx.z.toFixed(1)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showId) {\r\n          this._graphicsContext.debug.drawText(`id(${id}) ${entity.parent ? 'child of id(' + entity.parent?.id + ')' : ''}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showName) {\r\n          this._graphicsContext.debug.drawText(`name(${name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showRotation) {\r\n          this._graphicsContext.drawLine(\r\n            Vector.Zero,\r\n            Vector.fromAngle(tx.rotation).scale(50).add(Vector.Zero),\r\n            txSettings.rotationColor,\r\n            2\r\n          );\r\n          this._graphicsContext.debug.drawText(`rot deg(${toDegrees(tx.rotation).toFixed(2)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showScale) {\r\n          this._graphicsContext.drawLine(Vector.Zero, tx.scale.add(Vector.Zero), txSettings.scaleColor, 2);\r\n        }\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      if (graphics) {\r\n        if (graphicsSettings.showAll || graphicsSettings.showBounds) {\r\n          const bounds = graphics.localBounds;\r\n          bounds.draw(this._graphicsContext, graphicsSettings.boundsColor);\r\n        }\r\n      }\r\n\r\n      debugDraw = entity.get(DebugGraphicsComponent);\r\n      if (debugDraw) {\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.restore();\r\n        }\r\n        debugDraw.draw(this._graphicsContext, this._engine.debug);\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.save();\r\n          this._applyTransform(entity);\r\n        }\r\n      }\r\n\r\n      body = entity.get(BodyComponent);\r\n      if (body) {\r\n        if (bodySettings.showAll || bodySettings.showCollisionGroup) {\r\n          this._graphicsContext.debug.drawText(`collision group(${body.group.name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showCollisionType) {\r\n          this._graphicsContext.debug.drawText(`collision type(${body.collisionType})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMass) {\r\n          this._graphicsContext.debug.drawText(`mass(${body.mass})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMotion) {\r\n          this._graphicsContext.debug.drawText(`motion(${body.sleepMotion})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showSleeping) {\r\n          this._graphicsContext.debug.drawText(`sleeping(${body.canSleep ? body.sleeping: 'cant sleep'})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      // World space\r\n      this._graphicsContext.save();\r\n      if (tx.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n      this._graphicsContext.z = txSettings.debugZIndex;\r\n      motion = entity.get(MotionComponent);\r\n      if (motion) {\r\n        if (motionSettings.showAll || motionSettings.showVelocity) {\r\n          this._graphicsContext.debug.drawText(`vel${motion.vel.toString(2)}`, cursor.add(tx.globalPos));\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.vel), motionSettings.velocityColor, 2);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (motionSettings.showAll || motionSettings.showAcceleration) {\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.acc), motionSettings.accelerationColor, 2);\r\n        }\r\n      }\r\n\r\n      // Colliders live in world space already so after the restore()\r\n      colliderComp = entity.get(ColliderComponent);\r\n      if (colliderComp) {\r\n        const collider = colliderComp.get();\r\n        if ((colliderSettings.showAll || colliderSettings.showGeometry) && collider) {\r\n          collider.debug(this._graphicsContext, colliderSettings.geometryColor, {\r\n            lineWidth: colliderSettings.geometryLineWidth,\r\n            pointSize: colliderSettings.geometryPointSize\r\n          });\r\n        }\r\n        if (colliderSettings.showAll || colliderSettings.showBounds) {\r\n          if (collider instanceof CompositeCollider) {\r\n            const colliders = collider.getColliders();\r\n            for (const collider of colliders) {\r\n              const bounds = collider.bounds;\r\n              const pos = vec(bounds.left, bounds.top);\r\n              this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n              if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n                this._graphicsContext.debug.drawText(`owner id(${collider.owner.id})`, pos);\r\n              }\r\n            }\r\n            colliderComp.bounds.draw(this._graphicsContext, colliderSettings.boundsColor);\r\n          } else if (collider) {\r\n            const bounds = colliderComp.bounds;\r\n            const pos = vec(bounds.left, bounds.top);\r\n            this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n            if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n              this._graphicsContext.debug.drawText(`owner id(${colliderComp.owner.id})`, pos);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n      this._popCameraTransform(tx);\r\n    }\r\n\r\n    this._graphicsContext.save();\r\n    this._camera.draw(this._graphicsContext);\r\n    if (physicsSettings.showAll || physicsSettings.showBroadphaseSpacePartitionDebug) {\r\n      this._collisionSystem.debug(this._graphicsContext);\r\n    }\r\n    if (physicsSettings.showAll || physicsSettings.showCollisionContacts || physicsSettings.showCollisionNormals) {\r\n      for (const [_, contact] of this._engine.debug.stats.currFrame.physics.contacts) {\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionContacts) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawPoint(point, {\r\n              size: physicsSettings.contactSize,\r\n              color: physicsSettings.collisionContactColor\r\n            });\r\n          }\r\n        }\r\n\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionNormals) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawLine(point, contact.normal.scale(30).add(point), {\r\n              color: physicsSettings.collisionNormalColor\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    this._graphicsContext.restore();\r\n\r\n    if (cameraSettings) {\r\n      this._graphicsContext.save();\r\n      this._camera.draw(this._graphicsContext);\r\n      if (cameraSettings.showAll || cameraSettings.showFocus) {\r\n        this._graphicsContext.drawCircle(this._camera.pos, 4, cameraSettings.focusColor);\r\n      }\r\n      if (cameraSettings.showAll || cameraSettings.showZoom) {\r\n        this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`, this._camera.pos);\r\n      }\r\n      this._graphicsContext.restore();\r\n    }\r\n\r\n    this._graphicsContext.flush();\r\n  }\r\n\r\n  postupdate(engine: Scene<unknown>, elapsedMs: number): void {\r\n    if (this._engine.isDebug) {\r\n      this._graphicsContext.save();\r\n      if (this._camera) {\r\n        this._camera.draw(this._graphicsContext);\r\n      }\r\n      Debug.flush(this._graphicsContext);\r\n      this._graphicsContext.restore();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (const ancestor of ancestors) {\r\n      const transform = ancestor?.get(TransformComponent);\r\n      if (transform) {\r\n        this._graphicsContext.translate(transform.pos.x, transform.pos.y);\r\n        this._graphicsContext.scale(transform.scale.x, transform.scale.y);\r\n        this._graphicsContext.rotate(transform.rotation);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Applies the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _pushCameraTransform(transform: TransformComponent) {\r\n    // Establish camera offset per entity\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      this._graphicsContext.save();\r\n      if (this._camera) {\r\n        this._camera.draw(this._graphicsContext);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _popCameraTransform(transform: TransformComponent) {\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      // Apply camera world offset\r\n      this._graphicsContext.restore();\r\n    }\r\n  }\r\n}\r\n","import { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Engine } from '../Engine';\r\nimport {\r\n  System,\r\n  TransformComponent,\r\n  SystemType,\r\n  Entity,\r\n  World,\r\n  Query,\r\n  SystemPriority\r\n} from '../EntityComponentSystem';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Scene } from '../Scene';\r\nimport { PointerComponent } from './PointerComponent';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\n\r\n/**\r\n * The PointerSystem is responsible for dispatching pointer events to entities\r\n * that need them.\r\n *\r\n * The PointerSystem can be optionally configured by the [[PointerComponent]], by default Entities use\r\n * the [[Collider]]'s shape for pointer events.\r\n */\r\nexport class PointerSystem extends System {\r\n  public readonly systemType = SystemType.Update;\r\n  public priority = SystemPriority.Higher;\r\n\r\n  private _engine: Engine;\r\n  private _receivers: PointerEventReceiver[];\r\n  private _engineReceiver: PointerEventReceiver;\r\n  query: Query<typeof TransformComponent | typeof PointerComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, PointerComponent]);\r\n    this.query.entityAdded$.subscribe(e => {\r\n      const tx = e.get(TransformComponent);\r\n      this._sortedTransforms.push(tx);\r\n      this._sortedEntities.push(tx.owner);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    });\r\n\r\n    this.query.entityRemoved$.subscribe(e => {\r\n      const tx = e.get(TransformComponent);\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n        this._sortedEntities.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseColliderShape = false;\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseGraphicsBounds = false;\r\n\r\n  public lastFrameEntityToPointers = new Map<number, number[]>();\r\n  public currentFrameEntityToPointers = new Map<number, number[]>();\r\n  private _scene: Scene<unknown>;\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._engine = scene.engine;\r\n    this._scene = scene;\r\n  }\r\n\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  private _sortedEntities: Entity[] = [];\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    // event receiver might change per frame\r\n    this._receivers = [this._engine.input.pointers, this._scene.input.pointers];\r\n    this._engineReceiver = this._engine.input.pointers;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return b.z - a.z;\r\n      });\r\n      this._sortedEntities = this._sortedTransforms.map(t => t.owner);\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n\r\n\r\n  public entityCurrentlyUnderPointer(entity: Entity, pointerId: number) {\r\n    return this.currentFrameEntityToPointers.has(entity.id) &&\r\n           this.currentFrameEntityToPointers.get(entity.id).includes(pointerId);\r\n  }\r\n\r\n  public entityWasUnderPointer(entity: Entity, pointerId: number) {\r\n    return this.lastFrameEntityToPointers.has(entity.id) &&\r\n           this.lastFrameEntityToPointers.get(entity.id).includes(pointerId);\r\n  }\r\n\r\n  public entered(entity: Entity, pointerId: number) {\r\n    return this.entityCurrentlyUnderPointer(entity, pointerId) &&\r\n           !this.lastFrameEntityToPointers.has(entity.id);\r\n  }\r\n\r\n  public left(entity: Entity, pointerId: number) {\r\n    return !this.currentFrameEntityToPointers.has(entity.id) &&\r\n            this.entityWasUnderPointer(entity, pointerId);\r\n  }\r\n\r\n  public addPointerToEntity(entity: Entity, pointerId: number) {\r\n    if (!this.currentFrameEntityToPointers.has(entity.id)) {\r\n      this.currentFrameEntityToPointers.set(entity.id, [pointerId]);\r\n      return;\r\n    }\r\n    const pointers = this.currentFrameEntityToPointers.get(entity.id);\r\n    this.currentFrameEntityToPointers.set(entity.id, pointers.concat(pointerId));\r\n  }\r\n\r\n  public update(): void {\r\n    // Locate all the pointer/entity mappings\r\n    this._processPointerToEntity(this._sortedEntities);\r\n\r\n    // Dispatch pointer events on entities\r\n    this._dispatchEvents(this._sortedEntities);\r\n\r\n    // Clear last frame's events\r\n    this._receivers.forEach(r => r.update());\r\n    this.lastFrameEntityToPointers.clear();\r\n    this.lastFrameEntityToPointers = new Map<number, number[]>(this.currentFrameEntityToPointers);\r\n    this.currentFrameEntityToPointers.clear();\r\n    this._receivers.forEach(r => r.clear());\r\n  }\r\n\r\n  private _processPointerToEntity(entities: Entity[]) {\r\n    let transform: TransformComponent;\r\n    let collider: ColliderComponent;\r\n    let graphics: GraphicsComponent;\r\n    let pointer: PointerComponent;\r\n    const receiver = this._engineReceiver;\r\n\r\n    // TODO probably a spatial partition optimization here to quickly query bounds for pointer\r\n    // doesn't seem to cause issues tho for perf\r\n\r\n    // Pre-process find entities under pointers\r\n    for (const entity of entities) {\r\n      transform = entity.get(TransformComponent);\r\n      pointer = entity.get(PointerComponent) ?? new PointerComponent;\r\n      // If pointer bounds defined\r\n      if (pointer.localBounds) {\r\n        const pointerBounds = pointer.localBounds.transform(transform.get().matrix);\r\n        for (const [pointerId, pos] of receiver.currentFramePointerCoords.entries()) {\r\n          if (pointerBounds.contains(transform.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos)) {\r\n            this.addPointerToEntity(entity, pointerId);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Check collider contains pointer\r\n      collider = entity.get(ColliderComponent);\r\n      if (collider && (pointer.useColliderShape || this.overrideUseColliderShape)) {\r\n        collider.update();\r\n        const geom = collider.get();\r\n        if (geom) {\r\n          for (const [pointerId, pos] of receiver.currentFramePointerCoords.entries()) {\r\n            if (geom.contains(transform.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos)) {\r\n              this.addPointerToEntity(entity, pointerId);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Check graphics contains pointer\r\n      graphics = entity.get(GraphicsComponent);\r\n      if (graphics && (pointer.useGraphicsBounds || this.overrideUseGraphicsBounds)) {\r\n        const graphicBounds = graphics.localBounds.transform(transform.get().matrix);\r\n        for (const [pointerId, pos] of receiver.currentFramePointerCoords.entries()) {\r\n          if (graphicBounds.contains(transform.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos)) {\r\n            this.addPointerToEntity(entity, pointerId);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processDownAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const receiver = this._engineReceiver;\r\n    const lastDownPerPointer = new Map<number, PointerEvent>(); // TODO will this get confused between receivers?\r\n    // Loop through down and dispatch to entities\r\n    for (const event of receiver.currentFrameDown) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        entity.events.emit('pointerdown', event as any);\r\n        if (receiver.isDragStart(event.pointerId)) {\r\n          entity.events.emit('pointerdragstart', event as any);\r\n        }\r\n      }\r\n      lastDownPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastDownPerPointer;\r\n  }\r\n\r\n  private _processUpAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const receiver = this._engineReceiver;\r\n    const lastUpPerPointer = new Map<number, PointerEvent>();\r\n    // Loop through up and dispatch to entities\r\n    for (const event of receiver.currentFrameUp) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        entity.events.emit('pointerup', event as any);\r\n        if (receiver.isDragEnd(event.pointerId)) {\r\n          entity.events.emit('pointerdragend', event as any);\r\n        }\r\n      }\r\n      lastUpPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastUpPerPointer;\r\n  }\r\n\r\n  private _processMoveAndEmit(entity: Entity): Map<number, PointerEvent> {\r\n    const receiver = this._engineReceiver;\r\n    const lastMovePerPointer = new Map<number, PointerEvent>();\r\n    // Loop through move and dispatch to entities\r\n    for (const event of receiver.currentFrameMove) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)) {\r\n        // move\r\n        entity.events.emit('pointermove', event as any);\r\n\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragmove', event as any);\r\n        }\r\n      }\r\n      lastMovePerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastMovePerPointer;\r\n  }\r\n\r\n  private _processEnterLeaveAndEmit(entity: Entity, lastUpDownMoveEvents: PointerEvent[]) {\r\n    const receiver = this._engineReceiver;\r\n    // up, down, and move are considered for enter and leave\r\n    for (const event of lastUpDownMoveEvents) {\r\n      // enter\r\n      if (event.active && entity.active && this.entered(entity, event.pointerId)) {\r\n        entity.events.emit('pointerenter', event as any);\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragenter', event as any);\r\n        }\r\n        break;\r\n      }\r\n      if (event.active && entity.active &&\r\n          // leave can happen on move\r\n          (this.left(entity, event.pointerId) ||\r\n          // or leave can happen on pointer up\r\n          (this.entityCurrentlyUnderPointer(entity, event.pointerId) && event.type === 'up'))) {\r\n        entity.events.emit('pointerleave', event as any);\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          entity.events.emit('pointerdragleave', event as any);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processCancelAndEmit(entity: Entity) {\r\n    const receiver = this._engineReceiver;\r\n    // cancel\r\n    for (const event of receiver.currentFrameCancel) {\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, event.pointerId)){\r\n        entity.events.emit('pointercancel', event as any);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processWheelAndEmit(entity: Entity) {\r\n    const receiver = this._engineReceiver;\r\n    // wheel\r\n    for (const event of receiver.currentFrameWheel) {\r\n      // Currently the wheel only fires under the primary pointer '0'\r\n      if (event.active && entity.active && this.entityCurrentlyUnderPointer(entity, 0)) {\r\n        entity.events.emit('pointerwheel', event as any);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _dispatchEvents(entities: Entity[]) {\r\n    const lastFrameEntities = new Set(this.lastFrameEntityToPointers.keys());\r\n    const currentFrameEntities = new Set(this.currentFrameEntityToPointers.keys());\r\n    // Filter preserves z order\r\n    const entitiesWithEvents = entities.filter(e => lastFrameEntities.has(e.id) || currentFrameEntities.has(e.id));\r\n    let lastMovePerPointer: Map<number, PointerEvent>;\r\n    let lastUpPerPointer: Map<number, PointerEvent>;\r\n    let lastDownPerPointer: Map<number, PointerEvent>;\r\n    // Dispatch events in entity z order\r\n    for (const entity of entitiesWithEvents) {\r\n      lastDownPerPointer = this._processDownAndEmit(entity);\r\n\r\n      lastUpPerPointer = this._processUpAndEmit(entity);\r\n\r\n      lastMovePerPointer = this._processMoveAndEmit(entity);\r\n\r\n      const lastUpDownMoveEvents = [\r\n        ...lastMovePerPointer.values(),\r\n        ...lastDownPerPointer.values(),\r\n        ...lastUpPerPointer.values()\r\n      ];\r\n      this._processEnterLeaveAndEmit(entity, lastUpDownMoveEvents);\r\n\r\n      this._processCancelAndEmit(entity);\r\n\r\n      this._processWheelAndEmit(entity);\r\n    }\r\n  }\r\n}","import { Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ActionsComponent } from './ActionsComponent';\r\n\r\nexport class ActionsSystem extends System {\r\n  systemType = SystemType.Update;\r\n  priority = SystemPriority.Higher;\r\n  private _actions: ActionsComponent[] = [];\r\n  query: Query<typeof ActionsComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([ActionsComponent]);\r\n\r\n    this.query.entityAdded$.subscribe(e => this._actions.push(e.get(ActionsComponent)));\r\n    this.query.entityRemoved$.subscribe(e => {\r\n      const action = e.get(ActionsComponent);\r\n      const index = this._actions.indexOf(action);\r\n      if (index > -1) {\r\n        this._actions.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n  update(delta: number): void {\r\n    for (const actions of this._actions) {\r\n      actions.update(delta);\r\n    }\r\n  }\r\n}","import { Component } from '../EntityComponentSystem/Component';\r\nimport { IsometricMap } from './IsometricMap';\r\n\r\nexport interface IsometricEntityComponentOptions {\r\n  columns: number;\r\n  rows: number;\r\n  tileWidth: number;\r\n  tileHeight: number;\r\n}\r\n\r\nexport class IsometricEntityComponent extends Component {\r\n  /**\r\n   * Vertical \"height\" in the isometric world\r\n   */\r\n  public elevation: number = 0;\r\n\r\n  public readonly columns: number;\r\n  public readonly rows: number;\r\n  public readonly tileWidth: number;\r\n  public readonly tileHeight: number;\r\n\r\n  /**\r\n   * Specify the isometric map to use to position this entity's z-index\r\n   * @param mapOrOptions\r\n   */\r\n  constructor(mapOrOptions: IsometricMap | IsometricEntityComponentOptions) {\r\n    super();\r\n    this.columns = mapOrOptions.columns;\r\n    this.rows = mapOrOptions.rows;\r\n    this.tileWidth = mapOrOptions.tileWidth;\r\n    this.tileHeight = mapOrOptions.tileHeight;\r\n  }\r\n}","import { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\nimport { Query, SystemPriority, World } from '../EntityComponentSystem';\r\n\r\n\r\nexport class IsometricEntitySystem extends System {\r\n  public readonly systemType = SystemType.Update;\r\n  priority: number = SystemPriority.Lower;\r\n  query: Query<typeof TransformComponent | typeof IsometricEntityComponent>;\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, IsometricEntityComponent]);\r\n  }\r\n\r\n  update(): void {\r\n    let transform: TransformComponent;\r\n    let iso: IsometricEntityComponent;\r\n    for (const entity of this.query.entities) {\r\n      transform = entity.get(TransformComponent);\r\n      iso = entity.get(IsometricEntityComponent);\r\n\r\n      const maxZindexPerElevation = Math.max(iso.columns * iso.tileWidth, iso.rows * iso.tileHeight);\r\n\r\n      const newZ = maxZindexPerElevation * iso.elevation + transform.pos.y;\r\n      transform.z = newZ;\r\n    }\r\n  }\r\n}","import { GraphicsComponent } from './GraphicsComponent';\r\nimport { EnterViewPortEvent, ExitViewPortEvent } from '../Events';\r\nimport { Scene } from '../Scene';\r\nimport { Screen } from '../Screen';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Camera } from '../Camera';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { Vector } from '../Math/vector';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Query, SystemPriority, World } from '../EntityComponentSystem';\r\n\r\nexport class OffscreenSystem extends System {\r\n  public systemType = SystemType.Draw;\r\n  priority: number = SystemPriority.Higher;\r\n  private _camera: Camera;\r\n  private _screen: Screen;\r\n  private _worldBounds: BoundingBox;\r\n  query: Query<typeof TransformComponent | typeof GraphicsComponent>;\r\n\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, GraphicsComponent]);\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._camera = scene.camera;\r\n    this._screen = scene.engine.screen;\r\n  }\r\n\r\n  update(): void {\r\n    this._worldBounds = this._screen.getWorldBounds();\r\n    let transform: TransformComponent;\r\n    let graphics: GraphicsComponent;\r\n    let maybeParallax: ParallaxComponent;\r\n\r\n    for (const entity of this.query.entities) {\r\n      graphics = entity.get(GraphicsComponent);\r\n      transform = entity.get(TransformComponent);\r\n      maybeParallax = entity.get(ParallaxComponent);\r\n\r\n      let parallaxOffset: Vector;\r\n      if (maybeParallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n        parallaxOffset = this._camera.pos.scale(oneMinusFactor);\r\n      }\r\n\r\n      // Figure out if entities are offscreen\r\n      const entityOffscreen = this._isOffscreen(transform, graphics, parallaxOffset);\r\n      if (entityOffscreen && !entity.hasTag('ex.offscreen')) {\r\n        entity.events.emit('exitviewport', new ExitViewPortEvent(entity));\r\n        entity.addTag('ex.offscreen');\r\n      }\r\n\r\n      if (!entityOffscreen && entity.hasTag('ex.offscreen')) {\r\n        entity.events.emit('enterviewport', new EnterViewPortEvent(entity));\r\n        entity.removeTag('ex.offscreen');\r\n      }\r\n    }\r\n  }\r\n\r\n  private _isOffscreen(transform: TransformComponent, graphics: GraphicsComponent, parallaxOffset: Vector) {\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      let bounds = graphics.localBounds;\r\n      if (parallaxOffset) {\r\n        bounds = bounds.translate(parallaxOffset);\r\n      }\r\n      const transformedBounds = bounds.transform(transform.get().matrix);\r\n      const graphicsOffscreen = !this._worldBounds.overlaps(transformedBounds);\r\n      return graphicsOffscreen;\r\n    } else {\r\n      // TODO screen coordinates\r\n      return false;\r\n    }\r\n  }\r\n\r\n}","import { Ray } from '../Math/ray';\r\nimport { DeepRequired } from '../Util/Required';\r\nimport { Observable } from '../Util/Observable';\r\nimport { DynamicTreeCollisionProcessor, RayCastHit, RayCastOptions } from './Index';\r\nimport { BodyComponent } from './BodyComponent';\r\nimport { PhysicsConfig } from './PhysicsConfig';\r\nimport { watchDeep } from '../Util/Watch';\r\n\r\nexport class PhysicsWorld {\r\n\r\n  $configUpdate = new Observable<DeepRequired<PhysicsConfig>>;\r\n\r\n  private _configDirty = false;\r\n  private _config: DeepRequired<PhysicsConfig>;\r\n  get config(): DeepRequired<PhysicsConfig> {\r\n    return watchDeep(this._config, change => {\r\n      this.$configUpdate.notifyAll(change);\r\n    });\r\n  }\r\n  set config(newConfig: DeepRequired<PhysicsConfig>) {\r\n    this._config = newConfig;\r\n    this.$configUpdate.notifyAll(newConfig);\r\n  }\r\n\r\n  private _collisionProcessor: DynamicTreeCollisionProcessor;\r\n  /**\r\n   * Spatial data structure for locating potential collision pairs and ray casts\r\n   */\r\n  public get collisionProcessor(): DynamicTreeCollisionProcessor {\r\n    if (this._configDirty) {\r\n      this._configDirty = false;\r\n      // preserve tracked colliders if config updates\r\n      const colliders = this._collisionProcessor.getColliders();\r\n      this._collisionProcessor = new DynamicTreeCollisionProcessor(this._config);\r\n      for (const collider of colliders) {\r\n        this._collisionProcessor.track(collider);\r\n      }\r\n    }\r\n    return this._collisionProcessor;\r\n  }\r\n  constructor(config: DeepRequired<PhysicsConfig>) {\r\n    this.config = config;\r\n    this.$configUpdate.subscribe((config) => {\r\n      this._configDirty = true;\r\n      BodyComponent.updateDefaultPhysicsConfig(config.bodies);\r\n    });\r\n    this._collisionProcessor = new DynamicTreeCollisionProcessor(this.config);\r\n  }\r\n\r\n  /**\r\n   * Raycast into the scene's physics world\r\n   * @param ray\r\n   * @param options\r\n   */\r\n  public rayCast(ray: Ray, options?: RayCastOptions): RayCastHit[] {\r\n    return this.collisionProcessor.rayCast(ray, options);\r\n  }\r\n}","import { GamepadConnectEvent, GamepadDisconnectEvent, GamepadButtonEvent, GamepadAxisEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\nexport type GamepadEvents = {\r\n  connect: GamepadConnectEvent,\r\n  disconnect: GamepadDisconnectEvent,\r\n  button: GamepadButtonEvent,\r\n  axis: GamepadAxisEvent\r\n}\r\n\r\nexport const GamepadEvents = {\r\n  GamepadConnect: 'connect',\r\n  GamepadDisconnect: 'disconnect',\r\n  GamepadButton: 'button',\r\n  GamepadAxis: 'axis'\r\n};\r\n\r\n/**\r\n * Excalibur leverages the HTML5 Gamepad API [where it is supported](http://caniuse.com/#feat=gamepad)\r\n * to provide controller support for your games.\r\n */\r\nexport class Gamepads {\r\n  public events = new EventEmitter<GamepadEvents>();\r\n  /**\r\n   * Whether or not to poll for Gamepad input (default: `false`)\r\n   */\r\n  public enabled = false;\r\n\r\n  /**\r\n   * Whether or not Gamepad API is supported\r\n   */\r\n  public supported = !!(<any>navigator).getGamepads;\r\n\r\n  /**\r\n   * The minimum value an axis has to move before considering it a change\r\n   */\r\n  public static MinAxisMoveThreshold = 0.05;\r\n\r\n  private _gamePadTimeStamps = [0, 0, 0, 0];\r\n  private _oldPads: Gamepad[] = [];\r\n  private _pads: Gamepad[] = [];\r\n  private _initSuccess: boolean = false;\r\n  private _navigator: NavigatorGamepads = <any>navigator;\r\n  private _minimumConfiguration: GamepadConfiguration = null;\r\n  private _enabled = true;\r\n\r\n  public init() {\r\n    if (!this.supported) {\r\n      return;\r\n    }\r\n    if (this._initSuccess) {\r\n      return;\r\n    }\r\n\r\n    // In Chrome, this will return 4 undefined items until a button is pressed\r\n    // In FF, this will not return any items until a button is pressed\r\n    this._oldPads = this._clonePads(this._navigator.getGamepads());\r\n    if (this._oldPads.length && this._oldPads[0]) {\r\n      this._initSuccess = true;\r\n    }\r\n  }\r\n\r\n  public toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Sets the minimum gamepad configuration, for example {axis: 4, buttons: 4} means\r\n   * this game requires at minimum 4 axis inputs and 4 buttons, this is not restrictive\r\n   * all other controllers with more axis or buttons are valid as well. If no minimum\r\n   * configuration is set all pads are valid.\r\n   */\r\n  public setMinimumGamepadConfiguration(config: GamepadConfiguration): void {\r\n    this._enableAndUpdate(); // if config is used, implicitly enable\r\n    this._minimumConfiguration = config;\r\n  }\r\n\r\n  /**\r\n   * When implicitly enabled, set the enabled flag and run an update so information is updated\r\n   */\r\n  private _enableAndUpdate() {\r\n    if (!this.enabled) {\r\n      this.enabled = true;\r\n      this.update();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks a navigator gamepad against the minimum configuration if present.\r\n   */\r\n  private _isGamepadValid(pad: NavigatorGamepad): boolean {\r\n    if (!this._minimumConfiguration) {\r\n      return true;\r\n    }\r\n    if (!pad) {\r\n      return false;\r\n    }\r\n    const axesLength = pad.axes.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n\r\n    const buttonLength = pad.buttons.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n    return axesLength >= this._minimumConfiguration.axis && buttonLength >= this._minimumConfiguration.buttons && pad.connected;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, event: GamepadEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Updates Gamepad state and publishes Gamepad events\r\n   */\r\n  public update() {\r\n    if (!this.enabled || !this.supported) {\r\n      return;\r\n    }\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    this.init();\r\n\r\n    const gamepads = this._navigator.getGamepads();\r\n\r\n    for (let i = 0; i < gamepads.length; i++) {\r\n      if (!gamepads[i]) {\r\n        const gamepad = this.at(i);\r\n        // If was connected, but now isn't emit the disconnect event\r\n        if (gamepad.connected) {\r\n          this.events.emit('disconnect', new GamepadDisconnectEvent(i, gamepad));\r\n        }\r\n        // Reset connection status\r\n        gamepad.connected = false;\r\n        continue;\r\n      } else {\r\n        if (!this.at(i).connected && this._isGamepadValid(gamepads[i])) {\r\n          this.events.emit('connect', new GamepadConnectEvent(i, this.at(i)));\r\n        }\r\n        // Set connection status\r\n        this.at(i).connected = true;\r\n      }\r\n\r\n      this.at(i).update();\r\n\r\n      // Only supported in Chrome\r\n      if (gamepads[i].timestamp && gamepads[i].timestamp === this._gamePadTimeStamps[i]) {\r\n        continue;\r\n      }\r\n\r\n      this._gamePadTimeStamps[i] = gamepads[i].timestamp;\r\n\r\n      // Add reference to navigator gamepad\r\n      this.at(i).navigatorGamepad = gamepads[i];\r\n\r\n      // Buttons\r\n      let b: string, bi: number, a: string, ai: number, value: number;\r\n\r\n      for (b in Buttons) {\r\n        bi = <any>Buttons[b];\r\n        if (typeof bi === 'number') {\r\n          if (gamepads[i].buttons[bi]) {\r\n            value = gamepads[i].buttons[bi].value;\r\n            if (value !== this._oldPads[i].getButton(bi)) {\r\n              if (gamepads[i].buttons[bi].pressed) {\r\n                this.at(i).updateButton(bi, value);\r\n                this.at(i).events.emit('button', new GamepadButtonEvent(bi, value, this.at(i)));\r\n              } else {\r\n                this.at(i).updateButton(bi, 0);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Axes\r\n      for (a in Axes) {\r\n        ai = <any>Axes[a];\r\n        if (typeof ai === 'number') {\r\n          value = gamepads[i].axes[ai];\r\n          if (value !== this._oldPads[i].getAxes(ai)) {\r\n            this.at(i).updateAxes(ai, value);\r\n            this.at(i).events.emit('axis', new GamepadAxisEvent(ai, value, this.at(i)));\r\n          }\r\n        }\r\n      }\r\n\r\n      this._oldPads[i] = this._clonePad(gamepads[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safely retrieves a Gamepad at a specific index and creates one if it doesn't yet exist\r\n   */\r\n  public at(index: number): Gamepad {\r\n    this._enableAndUpdate(); // implicitly enable gamepads when at() is called\r\n    if (index >= this._pads.length) {\r\n      // Ensure there is a pad to retrieve\r\n      for (let i = this._pads.length - 1, max = index; i < max; i++) {\r\n        this._pads.push(new Gamepad());\r\n        this._oldPads.push(new Gamepad());\r\n      }\r\n    }\r\n\r\n    return this._pads[index];\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all valid gamepads that meet the minimum configuration requirement.\r\n   */\r\n  public getValidGamepads(): Gamepad[] {\r\n    this._enableAndUpdate();\r\n    const result: Gamepad[] = [];\r\n    for (let i = 0; i < this._pads.length; i++) {\r\n      if (this._isGamepadValid(this.at(i).navigatorGamepad) && this.at(i).connected) {\r\n        result.push(this.at(i));\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Gets the number of connected gamepads\r\n   */\r\n  public count() {\r\n    return this._pads.filter((p) => p.connected).length;\r\n  }\r\n\r\n  private _clonePads(pads: NavigatorGamepad[]): Gamepad[] {\r\n    const arr = [];\r\n    for (let i = 0, len = pads.length; i < len; i++) {\r\n      arr.push(this._clonePad(pads[i]));\r\n    }\r\n    return arr;\r\n  }\r\n\r\n  /**\r\n   * Fastest way to clone a known object is to do it yourself\r\n   */\r\n  private _clonePad(pad: NavigatorGamepad): Gamepad {\r\n    let i, len;\r\n    const clonedPad = new Gamepad();\r\n\r\n    if (!pad) {\r\n      return clonedPad;\r\n    }\r\n\r\n    for (i = 0, len = pad.buttons.length; i < len; i++) {\r\n      if (pad.buttons[i]) {\r\n        clonedPad.updateButton(i, pad.buttons[i].value);\r\n      }\r\n    }\r\n    for (i = 0, len = pad.axes.length; i < len; i++) {\r\n      clonedPad.updateAxes(i, pad.axes[i]);\r\n    }\r\n\r\n\r\n    return clonedPad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad holds state information for a connected controller. See [[Gamepads]]\r\n * for more information on handling controller input.\r\n */\r\nexport class Gamepad {\r\n  public events = new EventEmitter<GamepadEvents>();\r\n  public connected = false;\r\n  public navigatorGamepad: NavigatorGamepad;\r\n  private _axes: number[] = new Array(4);\r\n  private _buttons: number[] = new Array(16);\r\n  private _buttonsUp: number[] = new Array(16);\r\n  private _buttonsDown: number[] = new Array(16);\r\n\r\n  constructor() {\r\n    for (let i = 0; i < this._buttons.length; i++) {\r\n      this._buttons[i] = 0;\r\n    }\r\n    for (let i = 0; i < this._axes.length; i++) {\r\n      this._axes[i] = 0;\r\n    }\r\n  }\r\n\r\n  public update() {\r\n    // Reset buttonsDown and buttonsUp after update is complete\r\n    this._buttonsDown = new Array(16);\r\n    this._buttonsUp = new Array(16);\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given button is pressed\r\n   * @deprecated will be removed in v0.28.0. Use isButtonHeld instead\r\n   * @param button     The button to query\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public isButtonPressed(button: Buttons, threshold: number = 1) {\r\n    return this._buttons[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button is held down. This is persisted between frames.\r\n   * @param button     The button to query\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public isButtonHeld(button: Buttons, threshold: number = 1) {\r\n    return this._buttons[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button was just pressed this frame. This is cleared at the end of the update frame.\r\n   * @param button Test whether a button was just pressed\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public wasButtonPressed(button: Buttons, threshold: number = 1) {\r\n    return this._buttonsDown[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button was just released this frame. This is cleared at the end of the update frame.\r\n   * @param button  Test whether a button was just released\r\n   */\r\n  public wasButtonReleased(button: Buttons) {\r\n    return Boolean(this._buttonsUp[button]);\r\n  }\r\n\r\n  /**\r\n   * Gets the given button value between 0 and 1\r\n   */\r\n  public getButton(button: Buttons) {\r\n    return this._buttons[button];\r\n  }\r\n\r\n  /**\r\n   * Gets the given axis value between -1 and 1. Values below\r\n   * [[MinAxisMoveThreshold]] are considered 0.\r\n   */\r\n  public getAxes(axes: Axes) {\r\n    const value = this._axes[axes];\r\n\r\n    if (Math.abs(value) < Gamepads.MinAxisMoveThreshold) {\r\n      return 0;\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  public updateButton(buttonIndex: number, value: number) {\r\n    // button was just released\r\n    if (value === 0 && this._buttons[buttonIndex]) {\r\n      this._buttonsUp[buttonIndex] = 1;\r\n\r\n    // button was just pressed\r\n    } else {\r\n      this._buttonsDown[buttonIndex] = value;\r\n    }\r\n\r\n    this._buttons[buttonIndex] = value;\r\n  }\r\n\r\n  public updateAxes(axesIndex: number, value: number) {\r\n    this._axes[axesIndex] = value;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, event: GamepadEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad Buttons enumeration\r\n */\r\nexport enum Buttons {\r\n  /**\r\n   * Face 1 button (e.g. A)\r\n   */\r\n  Face1 = 0,\r\n  /**\r\n   * Face 2 button (e.g. B)\r\n   */\r\n  Face2 = 1,\r\n  /**\r\n   * Face 3 button (e.g. X)\r\n   */\r\n  Face3 = 2,\r\n  /**\r\n   * Face 4 button (e.g. Y)\r\n   */\r\n  Face4 = 3,\r\n  /**\r\n   * Left bumper button\r\n   */\r\n  LeftBumper = 4,\r\n  /**\r\n   * Right bumper button\r\n   */\r\n  RightBumper = 5,\r\n  /**\r\n   * Left trigger button\r\n   */\r\n  LeftTrigger = 6,\r\n  /**\r\n   * Right trigger button\r\n   */\r\n  RightTrigger = 7,\r\n  /**\r\n   * Select button\r\n   */\r\n  Select = 8,\r\n  /**\r\n   * Start button\r\n   */\r\n  Start = 9,\r\n  /**\r\n   * Left analog stick press (e.g. L3)\r\n   */\r\n  LeftStick = 10,\r\n  /**\r\n   * Right analog stick press (e.g. R3)\r\n   */\r\n  RightStick = 11,\r\n  /**\r\n   * D-pad up\r\n   */\r\n  DpadUp = 12,\r\n  /**\r\n   * D-pad down\r\n   */\r\n  DpadDown = 13,\r\n  /**\r\n   * D-pad left\r\n   */\r\n  DpadLeft = 14,\r\n  /**\r\n   * D-pad right\r\n   */\r\n  DpadRight = 15\r\n}\r\n\r\n/**\r\n * Gamepad Axes enumeration\r\n */\r\nexport enum Axes {\r\n  /**\r\n   * Left analogue stick X direction\r\n   */\r\n  LeftStickX = 0,\r\n  /**\r\n   * Left analogue stick Y direction\r\n   */\r\n  LeftStickY = 1,\r\n  /**\r\n   * Right analogue stick X direction\r\n   */\r\n  RightStickX = 2,\r\n  /**\r\n   * Right analogue stick Y direction\r\n   */\r\n  RightStickY = 3\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepads {\r\n  getGamepads(): NavigatorGamepad[];\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepad {\r\n  axes: number[];\r\n  buttons: NavigatorGamepadButton[];\r\n  connected: boolean;\r\n  id: string;\r\n  index: number;\r\n  mapping: string;\r\n  timestamp: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadButton {\r\n  pressed: boolean;\r\n  value: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadEvent {\r\n  gamepad: NavigatorGamepad;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface GamepadConfiguration {\r\n  axis: number;\r\n  buttons: number;\r\n}\r\n","import { Logger } from '../Util/Log';\r\nimport * as Events from '../Events';\r\nimport { isCrossOriginIframe } from '../Util/IFrame';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\n/**\r\n * Enum representing physical input key codes\r\n */\r\nexport enum Keys {\r\n  // NUMPAD\r\n  Num0 = 'Numpad0',\r\n  Num1 = 'Numpad1',\r\n  Num2 = 'Numpad2',\r\n  Num3 = 'Numpad3',\r\n  Num4 = 'Numpad4',\r\n  Num5 = 'Numpad5',\r\n  Num6 = 'Numpad6',\r\n  Num7 = 'Numpad7',\r\n  Num8 = 'Numpad8',\r\n  Num9 = 'Numpad9',\r\n  NumAdd = 'NumpadAdd',\r\n  NumSubtract = 'NumpadSubtract',\r\n  NumMultiply = 'NumpadMultiply',\r\n  NumDivide = 'NumpadDivide',\r\n  // NumComma = 'NumpadComma', // not x-browser\r\n  NumDecimal = 'NumpadDecimal',\r\n  Numpad0 = 'Numpad0',\r\n  Numpad1 = 'Numpad1',\r\n  Numpad2 = 'Numpad2',\r\n  Numpad3 = 'Numpad3',\r\n  Numpad4 = 'Numpad4',\r\n  Numpad5 = 'Numpad5',\r\n  Numpad6 = 'Numpad6',\r\n  Numpad7 = 'Numpad7',\r\n  Numpad8 = 'Numpad8',\r\n  Numpad9 = 'Numpad9',\r\n  NumpadAdd = 'NumpadAdd',\r\n  NumpadSubtract = 'NumpadSubtract',\r\n  NumpadMultiply = 'NumpadMultiply',\r\n  NumpadDivide = 'NumpadDivide',\r\n  // NumpadComma = 'NumpadComma', // not x-browser\r\n  NumpadDecimal = 'NumpadDecimal',\r\n\r\n  // MODIFIERS\r\n  NumLock = 'NumLock',\r\n  ShiftLeft = 'ShiftLeft',\r\n  ShiftRight = 'ShiftRight',\r\n  AltLeft = 'AltLeft',\r\n  AltRight = 'AltRight',\r\n  ControlLeft = 'ControlLeft',\r\n  ControlRight = 'ControlRight',\r\n  MetaLeft = 'MetaLeft',\r\n  MetaRight = 'MetaRight',\r\n\r\n  // NUMBERS\r\n  Key0 = 'Digit0',\r\n  Key1 = 'Digit1',\r\n  Key2 = 'Digit2',\r\n  Key3 = 'Digit3',\r\n  Key4 = 'Digit4',\r\n  Key5 = 'Digit5',\r\n  Key6 = 'Digit6',\r\n  Key7 = 'Digit7',\r\n  Key8 = 'Digit8',\r\n  Key9 = 'Digit9',\r\n  Digit0 = 'Digit0',\r\n  Digit1 = 'Digit1',\r\n  Digit2 = 'Digit2',\r\n  Digit3 = 'Digit3',\r\n  Digit4 = 'Digit4',\r\n  Digit5 = 'Digit5',\r\n  Digit6 = 'Digit6',\r\n  Digit7 = 'Digit7',\r\n  Digit8 = 'Digit8',\r\n  Digit9 = 'Digit9',\r\n\r\n  // FUNCTION KEYS\r\n  F1 = 'F1',\r\n  F2 = 'F2',\r\n  F3 = 'F3',\r\n  F4 = 'F4',\r\n  F5 = 'F5',\r\n  F6 = 'F6',\r\n  F7 = 'F7',\r\n  F8 = 'F8',\r\n  F9 = 'F9',\r\n  F10 = 'F10',\r\n  F11 = 'F11',\r\n  F12 = 'F12',\r\n\r\n  // LETTERS\r\n  A = 'KeyA',\r\n  B = 'KeyB',\r\n  C = 'KeyC',\r\n  D = 'KeyD',\r\n  E = 'KeyE',\r\n  F = 'KeyF',\r\n  G = 'KeyG',\r\n  H = 'KeyH',\r\n  I = 'KeyI',\r\n  J = 'KeyJ',\r\n  K = 'KeyK',\r\n  L = 'KeyL',\r\n  M = 'KeyM',\r\n  N = 'KeyN',\r\n  O = 'KeyO',\r\n  P = 'KeyP',\r\n  Q = 'KeyQ',\r\n  R = 'KeyR',\r\n  S = 'KeyS',\r\n  T = 'KeyT',\r\n  U = 'KeyU',\r\n  V = 'KeyV',\r\n  W = 'KeyW',\r\n  X = 'KeyX',\r\n  Y = 'KeyY',\r\n  Z = 'KeyZ',\r\n  KeyA = 'KeyA',\r\n  KeyB = 'KeyB',\r\n  KeyC = 'KeyC',\r\n  KeyD = 'KeyD',\r\n  KeyE = 'KeyE',\r\n  KeyF = 'KeyF',\r\n  KeyG = 'KeyG',\r\n  KeyH = 'KeyH',\r\n  KeyI = 'KeyI',\r\n  KeyJ = 'KeyJ',\r\n  KeyK = 'KeyK',\r\n  KeyL = 'KeyL',\r\n  KeyM = 'KeyM',\r\n  KeyN = 'KeyN',\r\n  KeyO = 'KeyO',\r\n  KeyP = 'KeyP',\r\n  KeyQ = 'KeyQ',\r\n  KeyR = 'KeyR',\r\n  KeyS = 'KeyS',\r\n  KeyT = 'KeyT',\r\n  KeyU = 'KeyU',\r\n  KeyV = 'KeyV',\r\n  KeyW = 'KeyW',\r\n  KeyX = 'KeyX',\r\n  KeyY = 'KeyY',\r\n  KeyZ = 'KeyZ',\r\n\r\n  // SYMBOLS\r\n  Semicolon = 'Semicolon',\r\n  Quote = 'Quote',\r\n  Comma = 'Comma',\r\n  Minus = 'Minus',\r\n  Period = 'Period',\r\n  Slash = 'Slash',\r\n  Equal = 'Equal',\r\n  BracketLeft = 'BracketLeft',\r\n  Backslash = 'Backslash',\r\n  BracketRight = 'BracketRight',\r\n  Backquote = 'Backquote',\r\n\r\n  // DIRECTIONS\r\n  Up = 'ArrowUp',\r\n  Down = 'ArrowDown',\r\n  Left = 'ArrowLeft',\r\n  Right = 'ArrowRight',\r\n  ArrowUp = 'ArrowUp',\r\n  ArrowDown = 'ArrowDown',\r\n  ArrowLeft = 'ArrowLeft',\r\n  ArrowRight = 'ArrowRight',\r\n\r\n  // OTHER\r\n  Space = 'Space',\r\n  Backspace = 'Backspace',\r\n  Delete = 'Delete',\r\n  Esc = 'Escape',\r\n  Escape = 'Escape',\r\n  Enter = 'Enter',\r\n  NumpadEnter = 'NumpadEnter',\r\n  ContextMenu = 'ContextMenu'\r\n}\r\n\r\n/**\r\n * Event thrown on a game object for a key event\r\n */\r\nexport class KeyEvent extends Events.GameEvent<any> {\r\n  /**\r\n   * @param key  The key responsible for throwing the event\r\n   * @param value The key's typed value the browser detected\r\n   * @param originalEvent The original keyboard event that Excalibur handled\r\n   */\r\n  constructor(public key: Keys, public value?: string, public originalEvent?: KeyboardEvent) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport interface KeyboardInitOptions {\r\n  global?: GlobalEventHandlers,\r\n  grabWindowFocus?: boolean\r\n}\r\n\r\nexport type KeyEvents = {\r\n  press: KeyEvent,\r\n  hold: KeyEvent,\r\n  release: KeyEvent\r\n};\r\n\r\nexport const KeyEvents = {\r\n  Press: 'press',\r\n  Hold: 'hold',\r\n  Release: 'release'\r\n};\r\n\r\n/**\r\n * Provides keyboard support for Excalibur.\r\n */\r\nexport class Keyboard {\r\n  public events = new EventEmitter<KeyEvents>();\r\n  private _enabled = true;\r\n  /**\r\n   * Keys that are currently held down\r\n   */\r\n  private _keys: Keys[] = [];\r\n  /**\r\n   * Keys up in the current frame\r\n   */\r\n  private _keysUp: Keys[] = [];\r\n  /**\r\n   * Keys down in the current frame\r\n   */\r\n  private _keysDown: Keys[] = [];\r\n\r\n  public emit<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, event: KeyEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Initialize Keyboard event listeners\r\n   */\r\n  init(keyboardOptions?: KeyboardInitOptions): void {\r\n    let { global } = keyboardOptions;\r\n    const { grabWindowFocus } = keyboardOptions;\r\n    if (!global) {\r\n      if (isCrossOriginIframe()) {\r\n        global = window;\r\n        // Workaround for iframes like for itch.io or codesandbox\r\n        // https://www.reddit.com/r/gamemaker/comments/kfs5cs/keyboard_inputs_no_longer_working_in_html5_game/\r\n        // https://forum.gamemaker.io/index.php?threads/solved-keyboard-issue-on-itch-io.87336/\r\n        if (grabWindowFocus) {\r\n          window.focus();\r\n        }\r\n\r\n        Logger.getInstance().warn('Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus');\r\n      } else {\r\n        global = window.top;\r\n      }\r\n    }\r\n\r\n    global.addEventListener('blur', () => {\r\n      this._keys.length = 0; // empties array efficiently\r\n    });\r\n\r\n    // key up is on window because canvas cannot have focus\r\n    global.addEventListener('keyup', this._handleKeyUp);\r\n\r\n    // key down is on window because canvas cannot have focus\r\n    global.addEventListener('keydown', this._handleKeyDown);\r\n  }\r\n\r\n  toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  private _releaseAllKeys = (ev: KeyboardEvent) => {\r\n    for (const code of this._keys) {\r\n      const keyEvent = new KeyEvent(code, ev.key, ev);\r\n      this.events.emit('up', keyEvent);\r\n      this.events.emit('release', keyEvent);\r\n    }\r\n    this._keysUp = Array.from((new Set(this._keys.concat(this._keysUp))));\r\n    this._keys.length = 0;\r\n  };\r\n\r\n  private _handleKeyDown = (ev: KeyboardEvent) => {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n\r\n    // handle macos meta key issue\r\n    // https://github.com/excaliburjs/Excalibur/issues/2608\r\n    if (!ev.metaKey && (this._keys.includes(Keys.MetaLeft) || this._keys.includes(Keys.MetaRight))) {\r\n      this._releaseAllKeys(ev);\r\n    }\r\n\r\n    const code = ev.code as Keys;\r\n    if (this._keys.indexOf(code) === -1) {\r\n      this._keys.push(code);\r\n      this._keysDown.push(code);\r\n      const keyEvent = new KeyEvent(code, ev.key, ev);\r\n      this.events.emit('down', keyEvent);\r\n      this.events.emit('press', keyEvent);\r\n    }\r\n  };\r\n\r\n  private _handleKeyUp = (ev: KeyboardEvent) => {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    const code = ev.code as Keys;\r\n    const key = this._keys.indexOf(code);\r\n    this._keys.splice(key, 1);\r\n    this._keysUp.push(code);\r\n    const keyEvent = new KeyEvent(code, ev.key, ev);\r\n\r\n    // alias the old api, we may want to deprecate this in the future\r\n    this.events.emit('up', keyEvent);\r\n    this.events.emit('release', keyEvent);\r\n\r\n    // handle macos meta key issue\r\n    // https://github.com/excaliburjs/Excalibur/issues/2608\r\n    if (ev.key === 'Meta') {\r\n      this._releaseAllKeys(ev);\r\n    }\r\n  };\r\n\r\n  public update() {\r\n    // Reset keysDown and keysUp after update is complete\r\n    this._keysDown.length = 0;\r\n    this._keysUp.length = 0;\r\n\r\n    // Emit synthetic \"hold\" event\r\n    for (let i = 0; i < this._keys.length; i++) {\r\n      this.events.emit('hold', new KeyEvent(this._keys[i]));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets list of keys being pressed down\r\n   */\r\n  public getKeys(): Keys[] {\r\n    return this._keys;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just pressed this frame. This is cleared at the end of the update frame.\r\n   * @param key Test whether a key was just pressed\r\n   */\r\n  public wasPressed(key: Keys): boolean {\r\n    return this._keysDown.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key is held down. This is persisted between frames.\r\n   * @param key  Test whether a key is held down\r\n   */\r\n  public isHeld(key: Keys): boolean {\r\n    return this._keys.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just released this frame. This is cleared at the end of the update frame.\r\n   * @param key  Test whether a key was just released\r\n   */\r\n  public wasReleased(key: Keys): boolean {\r\n    return this._keysUp.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Trigger a manual key event\r\n   * @param type\r\n   * @param key\r\n   * @param character\r\n   */\r\n  public triggerEvent(type: 'down' | 'up', key: Keys, character?: string) {\r\n    if (type === 'down') {\r\n      this._handleKeyDown(new KeyboardEvent('keydown', {\r\n        code: key,\r\n        key: character ?? null\r\n      }));\r\n    }\r\n    if (type === 'up') {\r\n      this._handleKeyUp(new KeyboardEvent('keyup', {\r\n        code: key,\r\n        key: character ?? null\r\n      }));\r\n    }\r\n  }\r\n}\r\n","import { Gamepads } from './Gamepad';\r\nimport { Keyboard } from './Keyboard';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\n\r\nexport interface InputsOptions {\r\n  keyboard: Keyboard;\r\n  gamepads: Gamepads;\r\n  pointers: PointerEventReceiver;\r\n}\r\n\r\n/**\r\n * This allows you to map multiple inputs to specific commands! This is especially useful when\r\n * you need to allow multiple input sources to control a specific action.\r\n */\r\nexport class InputMapper {\r\n\r\n  private _handlers = new Map<any, any>();\r\n  constructor(public inputs: InputsOptions) {}\r\n\r\n  /**\r\n   * Executes the input map, called internally by Excalibur\r\n   */\r\n  execute() {\r\n    for (const [input, command] of this._handlers.entries()) {\r\n      const results = input(this.inputs);\r\n      if (results) {\r\n        command(results);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This allows you to map multiple inputs to specific commands! This is useful\r\n   *\r\n   * The inputHandler should return a truthy value if you wish the commandHandler to fire.\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const moveRight = (amount: number) => { actor.vel.x = 100 * amount }\r\n   * const moveLeft = (amount: number) => { actor.vel.x = -100 * amount }\r\n   * const moveUp = (amount: number) => { actor.vel.y = -100 * amount }\r\n   * const moveDown = (amount: number) => { actor.vel.y = 100 * amount }\r\n   *\r\n   * engine.inputMapper.on(({keyboard}) => keyboard.isHeld(ex.Keys.ArrowRight) ? 1 : 0, moveRight);\r\n   * engine.inputMapper.on(({gamepads}) => gamepads.at(0).isButtonPressed(ex.Buttons.DpadRight) ? 1 : 0, moveRight);\r\n   * engine.inputMapper.on(({gamepads}) => gamepads.at(0).getAxes(ex.Axes.LeftStickX) > 0 ?\r\n   *  gamepads.at(0).getAxes(ex.Axes.LeftStickX) : 0, moveRight);\r\n   * ```\r\n   * @param inputHandler\r\n   * @param commandHandler\r\n   */\r\n  on<TInputHandlerData>(\r\n    inputHandler: (inputs: InputsOptions) => TInputHandlerData | false,\r\n    commandHandler: (data: TInputHandlerData) => any) {\r\n    this._handlers.set(inputHandler, commandHandler);\r\n  }\r\n}","\r\n\r\n/**\r\n * Checks if excalibur is in a x-origin iframe\r\n */\r\nexport function isCrossOriginIframe() {\r\n  try {\r\n    // Try and listen to events on top window frame if within an iframe.\r\n    //\r\n    // See https://github.com/excaliburjs/Excalibur/issues/1294\r\n    //\r\n    // Attempt to add an event listener, which triggers a DOMException on\r\n    // cross-origin iframes\r\n    const noop = () => {\r\n      return;\r\n    };\r\n    window.top.addEventListener('blur', noop);\r\n    window.top.removeEventListener('blur', noop);\r\n  } catch {\r\n    return true;\r\n  }\r\n  return false;\r\n}","import { Engine } from '../Engine';\r\nimport { Vector } from './vector';\r\n\r\nexport class GlobalCoordinates {\r\n  public static fromPagePosition(x: number, y: number, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(pos: Vector, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(xOrPos: number | Vector, yOrEngine: number | Engine, engineOrUndefined?: Engine): GlobalCoordinates {\r\n    let pageX: number;\r\n    let pageY: number;\r\n    let pagePos: Vector;\r\n    let engine: Engine;\r\n\r\n    if (arguments.length === 3) {\r\n      pageX = <number>xOrPos;\r\n      pageY = <number>yOrEngine;\r\n      pagePos = new Vector(pageX, pageY);\r\n      engine = engineOrUndefined;\r\n    } else {\r\n      pagePos = <Vector>xOrPos;\r\n      pageX = pagePos.x;\r\n      pageY = pagePos.y;\r\n      engine = <Engine>yOrEngine;\r\n    }\r\n\r\n    const screenPos = engine.screen.pageToScreenCoordinates(pagePos);\r\n    const worldPos = engine.screen.screenToWorldCoordinates(screenPos);\r\n\r\n    return new GlobalCoordinates(worldPos, pagePos, screenPos);\r\n  }\r\n\r\n  constructor(public worldPos: Vector, public pagePos: Vector, public screenPos: Vector) {}\r\n}\r\n","import { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { Vector } from '../Math/vector';\r\nimport { PointerButton } from './PointerButton';\r\nimport { PointerType } from './PointerType';\r\n\r\nexport class PointerEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n\r\n  get pagePos(): Vector {\r\n    return this.coordinates.pagePos;\r\n  }\r\n\r\n  get screenPos(): Vector {\r\n    return this.coordinates.screenPos;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    return this.coordinates.worldPos;\r\n  }\r\n\r\n  constructor(\r\n    public type: 'down' | 'up' | 'move' | 'cancel',\r\n    public pointerId: number,\r\n    public button: PointerButton,\r\n    public pointerType: PointerType,\r\n    public coordinates: GlobalCoordinates,\r\n    public nativeEvent: Event) { };\r\n}\r\n","import { WheelDeltaMode } from './WheelDeltaMode';\r\n\r\n\r\nexport class WheelEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n  constructor(\r\n    public x: number,\r\n    public y: number,\r\n    public pageX: number,\r\n    public pageY: number,\r\n    public screenX: number,\r\n    public screenY: number,\r\n    public index: number,\r\n    public deltaX: number,\r\n    public deltaY: number,\r\n    public deltaZ: number,\r\n    public deltaMode: WheelDeltaMode,\r\n    public ev: Event\r\n  ) { }\r\n}\r\n","import { Vector } from '../Math/vector';\nimport { PointerEvent } from './PointerEvent';\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\nimport { PointerEvents } from './PointerEventReceiver';\n\nexport class PointerAbstraction {\n  public events = new EventEmitter<PointerEvents>();\n  /**\n   * The last position on the document this pointer was at. Can be `null` if pointer was never active.\n   */\n  public lastPagePos: Vector = Vector.Zero;\n\n  /**\n   * The last position on the screen this pointer was at. Can be `null` if pointer was never active.\n   */\n  public lastScreenPos: Vector = Vector.Zero;\n\n  /**\n   * The last position in the game world coordinates this pointer was at. Can be `null` if pointer was never active.\n   */\n  public lastWorldPos: Vector = Vector.Zero;\n\n  constructor() {\n    this.on('move', this._onPointerMove);\n    this.on('down', this._onPointerDown);\n  }\n\n  public emit<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, event: PointerEvents[TEventName]): void;\n  public emit(eventName: string, event?: any): void;\n  public emit<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, event?: any): void {\n    this.events.emit(eventName, event);\n  }\n\n  public on<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\n  public on<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\n    return this.events.on(eventName, handler);\n  }\n\n  public once<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\n  public once<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\n    return this.events.once(eventName, handler);\n  }\n\n  public off<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): void;\n  public off(eventName: string, handler: Handler<unknown>): void;\n  public off(eventName: string): void;\n  public off<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\n    this.events.off(eventName, handler);\n  }\n\n  private _onPointerMove = (ev: PointerEvent): void => {\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\n  };\n\n  private _onPointerDown = (ev: PointerEvent): void => {\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\n  };\n}\n","\r\nexport enum WheelDeltaMode {\r\n  Pixel = 'Pixel',\r\n  Line = 'Line',\r\n  Page = 'Page'\r\n}\r\n","/**\n * Native browser button enumeration\n */\nexport enum NativePointerButton {\n  NoButton = -1,\n  Left = 0,\n  Middle = 1,\n  Right = 2,\n  Unknown = 3\n}\n","/**\n * The mouse button being pressed.\n */\nexport enum PointerButton {\n  Left = 'Left',\n  Middle = 'Middle',\n  Right = 'Right',\n  Unknown = 'Unknown',\n  NoButton = 'NoButton'\n}\n","/**\n * The type of pointer for a [[PointerEvent]].\n */\nexport enum PointerType {\n  Touch = 'Touch',\n  Mouse = 'Mouse',\n  Pen = 'Pen',\n  Unknown = 'Unknown'\n}\n","import { Engine, ScrollPreventionMode } from '../Engine';\r\nimport { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { WheelEvent } from './WheelEvent';\r\nimport { PointerAbstraction } from './PointerAbstraction';\r\n\r\nimport { WheelDeltaMode } from './WheelDeltaMode';\r\nimport { PointerSystem } from './PointerSystem';\r\nimport { NativePointerButton } from './NativePointerButton';\r\nimport { PointerButton } from './PointerButton';\r\nimport { fail } from '../Util/Util';\r\nimport { PointerType } from './PointerType';\r\nimport { isCrossOriginIframe } from '../Util/IFrame';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\n\r\nexport type NativePointerEvent = globalThis.PointerEvent;\r\nexport type NativeMouseEvent = globalThis.MouseEvent;\r\nexport type NativeTouchEvent = globalThis.TouchEvent;\r\nexport type NativeWheelEvent = globalThis.WheelEvent;\r\n\r\nexport type PointerEvents = {\r\n  move: PointerEvent,\r\n  down: PointerEvent,\r\n  up: PointerEvent,\r\n  wheel: WheelEvent\r\n}\r\n\r\nexport const PointerEvents = {\r\n  Move: 'move',\r\n  Down: 'down',\r\n  Up: 'up',\r\n  Wheel: 'wheel'\r\n};\r\n\r\n/**\r\n * Is this event a native touch event?\r\n */\r\nfunction isTouchEvent(value: any): value is NativeTouchEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.TouchEvent && value instanceof globalThis.TouchEvent;\r\n}\r\n\r\n/**\r\n * Is this event a native pointer event\r\n */\r\nfunction isPointerEvent(value: any): value is NativePointerEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.PointerEvent && value instanceof globalThis.PointerEvent;\r\n}\r\n\r\nexport interface PointerInitOptions {\r\n  grabWindowFocus?: boolean;\r\n}\r\n\r\n/**\r\n * The PointerEventProcessor is responsible for collecting all the events from the canvas and transforming them into GlobalCoordinates\r\n */\r\nexport class PointerEventReceiver {\r\n  public events = new EventEmitter<PointerEvents>();\r\n  public primary: PointerAbstraction = new PointerAbstraction();\r\n\r\n  private _activeNativePointerIdsToNormalized = new Map<number, number>();\r\n  public lastFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n  public currentFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n\r\n  public currentFramePointerDown = new Map<number, boolean>();\r\n  public lastFramePointerDown = new Map<number, boolean>();\r\n\r\n  public currentFrameDown: PointerEvent[] = [];\r\n  public currentFrameUp: PointerEvent[] = [];\r\n  public currentFrameMove: PointerEvent[] = [];\r\n  public currentFrameCancel: PointerEvent[] = [];\r\n  public currentFrameWheel: WheelEvent[] = [];\r\n\r\n  private _enabled = true;\r\n\r\n  constructor(public readonly target: GlobalEventHandlers & EventTarget, public engine: Engine) {}\r\n\r\n  public toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Creates a new PointerEventReceiver with a new target and engine while preserving existing pointer event\r\n   * handlers.\r\n   * @param target\r\n   * @param engine\r\n   */\r\n  public recreate(target: GlobalEventHandlers & EventTarget, engine: Engine) {\r\n    const eventReceiver = new PointerEventReceiver(target, engine);\r\n    eventReceiver.primary = this.primary;\r\n    eventReceiver._pointers = this._pointers;\r\n    return eventReceiver;\r\n  }\r\n\r\n  private _pointers: PointerAbstraction[] = [this.primary];\r\n  /**\r\n   * Locates a specific pointer by id, creates it if it doesn't exist\r\n   * @param index\r\n   */\r\n  public at(index: number): PointerAbstraction {\r\n    if (index >= this._pointers.length) {\r\n      // Ensure there is a pointer to retrieve\r\n      for (let i = this._pointers.length - 1, max = index; i < max; i++) {\r\n        this._pointers.push(new PointerAbstraction());\r\n      }\r\n    }\r\n    return this._pointers[index];\r\n  }\r\n\r\n  /**\r\n   * The number of pointers currently being tracked by excalibur\r\n   */\r\n  public count(): number {\r\n    return this._pointers.length;\r\n  }\r\n\r\n  /**\r\n   * Is the specified pointer id down this frame\r\n   * @param pointerId\r\n   */\r\n  public isDown(pointerId: number) {\r\n    return this.currentFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Was the specified pointer id down last frame\r\n   * @param pointerId\r\n   */\r\n  public wasDown(pointerId: number) {\r\n    return this.lastFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer is currently dragging.\r\n   */\r\n  public isDragging(pointerId: number): boolean {\r\n    return this.isDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just started dragging.\r\n   */\r\n  public isDragStart(pointerId: number): boolean {\r\n    return this.isDown(pointerId) && !this.wasDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just ended dragging.\r\n   */\r\n  public isDragEnd(pointerId: number): boolean {\r\n    return !this.isDown(pointerId) && this.wasDown(pointerId);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, event: PointerEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Called internally by excalibur\r\n   *\r\n   * Updates the current frame pointer info and emits raw pointer events\r\n   *\r\n   * This does not emit events to entities, see PointerSystem\r\n   */\r\n  public update() {\r\n    this.lastFramePointerDown = new Map(this.currentFramePointerDown);\r\n    this.lastFramePointerCoords = new Map(this.currentFramePointerCoords);\r\n\r\n    for (const event of this.currentFrameDown) {\r\n      this.emit('down', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('down', event);\r\n      this.primary.emit('pointerdown', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameUp) {\r\n      this.emit('up', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('up', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameMove) {\r\n      this.emit('move', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('move', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameCancel) {\r\n      this.emit('cancel', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('cancel', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameWheel) {\r\n      this.emit('wheel', event);\r\n      this.primary.emit('pointerwheel', event);\r\n      this.primary.emit('wheel', event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clears the current frame event and pointer data\r\n   */\r\n  public clear() {\r\n    for (const event of this.currentFrameUp) {\r\n      this.currentFramePointerCoords.delete(event.pointerId);\r\n      const ids = this._activeNativePointerIdsToNormalized.entries();\r\n      for (const [native, normalized] of ids) {\r\n        if (normalized === event.pointerId) {\r\n          this._activeNativePointerIdsToNormalized.delete(native);\r\n        }\r\n      }\r\n    }\r\n    this.currentFrameDown.length = 0;\r\n    this.currentFrameUp.length = 0;\r\n    this.currentFrameMove.length = 0;\r\n    this.currentFrameCancel.length = 0;\r\n    this.currentFrameWheel.length = 0;\r\n  }\r\n\r\n  private _boundHandle = this._handle.bind(this);\r\n  private _boundWheel = this._handleWheel.bind(this);\r\n  /**\r\n   * Initializes the pointer event receiver so that it can start listening to native\r\n   * browser events.\r\n   */\r\n  public init(options?: PointerInitOptions) {\r\n    if (this.engine.isDisposed()) {\r\n      return;\r\n    }\r\n    // Disabling the touch action avoids browser/platform gestures from firing on the canvas\r\n    // It is important on mobile to have touch action 'none'\r\n    // https://stackoverflow.com/questions/48124372/pointermove-event-not-working-with-touch-why-not\r\n    if (this.target === this.engine.canvas) {\r\n      this.engine.canvas.style.touchAction = 'none';\r\n    } else {\r\n      document.body.style.touchAction = 'none';\r\n    }\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.addEventListener('pointerdown', this._boundHandle);\r\n      this.target.addEventListener('pointerup', this._boundHandle);\r\n      this.target.addEventListener('pointermove', this._boundHandle);\r\n      this.target.addEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.addEventListener('touchstart', this._boundHandle);\r\n      this.target.addEventListener('touchend', this._boundHandle);\r\n      this.target.addEventListener('touchmove', this._boundHandle);\r\n      this.target.addEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.addEventListener('mousedown', this._boundHandle);\r\n      this.target.addEventListener('mouseup', this._boundHandle);\r\n      this.target.addEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    // MDN MouseWheelEvent\r\n    const wheelOptions = {\r\n      passive: !(\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas\r\n      )\r\n    };\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.addEventListener('wheel', this._boundWheel, wheelOptions);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel, wheelOptions);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel, wheelOptions);\r\n    }\r\n\r\n    const grabWindowFocus = options?.grabWindowFocus ?? true;\r\n    // Handle cross origin iframe\r\n    if (grabWindowFocus && isCrossOriginIframe()) {\r\n      const grabFocus = () => {\r\n        window.focus();\r\n      };\r\n      // Preferred pointer events\r\n      if (window.PointerEvent) {\r\n        this.target.addEventListener('pointerdown', grabFocus);\r\n      } else {\r\n        // Touch Events\r\n        this.target.addEventListener('touchstart', grabFocus);\r\n\r\n        // Mouse Events\r\n        this.target.addEventListener('mousedown', grabFocus);\r\n      }\r\n    }\r\n  }\r\n\r\n  public detach() {\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.removeEventListener('pointerdown', this._boundHandle);\r\n      this.target.removeEventListener('pointerup', this._boundHandle);\r\n      this.target.removeEventListener('pointermove', this._boundHandle);\r\n      this.target.removeEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.removeEventListener('touchstart', this._boundHandle);\r\n      this.target.removeEventListener('touchend', this._boundHandle);\r\n      this.target.removeEventListener('touchmove', this._boundHandle);\r\n      this.target.removeEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.removeEventListener('mousedown', this._boundHandle);\r\n      this.target.removeEventListener('mouseup', this._boundHandle);\r\n      this.target.removeEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.removeEventListener('wheel', this._boundWheel);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Take native pointer id and map it to index in active pointers\r\n   * @param nativePointerId\r\n   */\r\n  private _normalizePointerId(nativePointerId: number) {\r\n    // Add to the the native pointer set id\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, -1);\r\n\r\n    // Native pointer ids in ascending order\r\n    const currentPointerIds = Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a, b) => a - b);\r\n\r\n    // The index into sorted ids will be the new id, will always have an id\r\n    const id = currentPointerIds.findIndex(p => p === nativePointerId);\r\n\r\n    // Save the mapping so we can reverse it later\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, id);\r\n\r\n    // ignore pointer because game isn't watching\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Responsible for handling and parsing pointer events\r\n   */\r\n  private _handle(ev: NativeTouchEvent | NativePointerEvent | NativeMouseEvent) {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    ev.preventDefault();\r\n    const eventCoords = new Map<number, GlobalCoordinates>();\r\n    let button: PointerButton;\r\n    let pointerType: PointerType;\r\n    if (isTouchEvent(ev)) {\r\n      button = PointerButton.Unknown;\r\n      pointerType = PointerType.Touch;\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/TouchEvent\r\n      for (let i = 0; i < ev.changedTouches.length; i++) {\r\n        const touch = ev.changedTouches[i];\r\n        const coordinates = GlobalCoordinates.fromPagePosition(touch.pageX, touch.pageY, this.engine);\r\n        const nativePointerId = i + 1;\r\n        const pointerId = this._normalizePointerId(nativePointerId);\r\n        this.currentFramePointerCoords.set(pointerId, coordinates);\r\n        eventCoords.set(pointerId, coordinates);\r\n      }\r\n    } else {\r\n      button = this._nativeButtonToPointerButton(ev.button);\r\n      pointerType = PointerType.Mouse;\r\n      const coordinates = GlobalCoordinates.fromPagePosition(ev.pageX, ev.pageY, this.engine);\r\n      let nativePointerId = 1;\r\n      if (isPointerEvent(ev)) {\r\n        nativePointerId = ev.pointerId;\r\n        pointerType = this._stringToPointerType(ev.pointerType);\r\n      }\r\n      const pointerId = this._normalizePointerId(nativePointerId);\r\n      this.currentFramePointerCoords.set(pointerId, coordinates);\r\n      eventCoords.set(pointerId, coordinates);\r\n    }\r\n\r\n    for (const [pointerId, coord] of eventCoords.entries()) {\r\n      switch (ev.type) {\r\n        case 'mousedown':\r\n        case 'pointerdown':\r\n        case 'touchstart':\r\n          this.currentFrameDown.push(new PointerEvent('down', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, true);\r\n          break;\r\n        case 'mouseup':\r\n        case 'pointerup':\r\n        case 'touchend':\r\n          this.currentFrameUp.push(new PointerEvent('up', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, false);\r\n          break;\r\n        case 'mousemove':\r\n        case 'pointermove':\r\n        case 'touchmove':\r\n          this.currentFrameMove.push(new PointerEvent('move', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n        case 'touchcancel':\r\n        case 'pointercancel':\r\n          this.currentFrameCancel.push(new PointerEvent('cancel', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _handleWheel(ev: NativeWheelEvent) {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    // Should we prevent page scroll because of this event\r\n    if (\r\n      this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n      (this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas && ev.target === this.engine.canvas)\r\n    ) {\r\n      ev.preventDefault();\r\n    }\r\n    const screen = this.engine.screen.pageToScreenCoordinates(vec(ev.pageX, ev.pageY));\r\n    const world = this.engine.screen.screenToWorldCoordinates(screen);\r\n\r\n    /**\r\n     * A constant used to normalize wheel events across different browsers\r\n     *\r\n     * This normalization factor is pulled from\r\n     * https://developer.mozilla.org/en-US/docs/Web/Events/wheel#Listening_to_this_event_across_browser\r\n     */\r\n    const ScrollWheelNormalizationFactor = -1 / 40;\r\n\r\n    const deltaX = ev.deltaX || ev.wheelDeltaX * ScrollWheelNormalizationFactor || 0;\r\n    const deltaY =\r\n        ev.deltaY || ev.wheelDeltaY * ScrollWheelNormalizationFactor || ev.wheelDelta * ScrollWheelNormalizationFactor || ev.detail || 0;\r\n    const deltaZ = ev.deltaZ || 0;\r\n    let deltaMode = WheelDeltaMode.Pixel;\r\n\r\n    if (ev.deltaMode) {\r\n      if (ev.deltaMode === 1) {\r\n        deltaMode = WheelDeltaMode.Line;\r\n      } else if (ev.deltaMode === 2) {\r\n        deltaMode = WheelDeltaMode.Page;\r\n      }\r\n    }\r\n\r\n    const we = new WheelEvent(world.x, world.y, ev.pageX, ev.pageY, screen.x, screen.y, 0, deltaX, deltaY, deltaZ, deltaMode, ev);\r\n    this.currentFrameWheel.push(we);\r\n  }\r\n\r\n  /**\r\n   * Triggers an excalibur pointer event in a world space pos\r\n   *\r\n   * Useful for testing pointers in excalibur\r\n   * @param type\r\n   * @param pos\r\n   */\r\n  public triggerEvent(type: 'down' | 'up' | 'move' | 'cancel', pos: Vector) {\r\n    const page = this.engine.screen.worldToPageCoordinates(pos);\r\n    // Send an event to the event receiver\r\n    if (window.PointerEvent) {\r\n      this._handle(new window.PointerEvent('pointer' + type, {\r\n        pointerId: 0,\r\n        clientX: page.x,\r\n        clientY: page.y\r\n      }));\r\n    } else {\r\n      // Safari hack\r\n      this._handle(new window.MouseEvent('mouse' + type, {\r\n        clientX: page.x,\r\n        clientY: page.y\r\n      }));\r\n    }\r\n\r\n    // Force update pointer system\r\n    const pointerSystem = this.engine.currentScene.world.get(PointerSystem);\r\n    pointerSystem.preupdate(this.engine.currentScene, 1);\r\n    pointerSystem.update(1);\r\n  }\r\n\r\n  private _nativeButtonToPointerButton(s: NativePointerButton): PointerButton {\r\n    switch (s) {\r\n      case NativePointerButton.NoButton:\r\n        return PointerButton.NoButton;\r\n      case NativePointerButton.Left:\r\n        return PointerButton.Left;\r\n      case NativePointerButton.Middle:\r\n        return PointerButton.Middle;\r\n      case NativePointerButton.Right:\r\n        return PointerButton.Right;\r\n      case NativePointerButton.Unknown:\r\n        return PointerButton.Unknown;\r\n      default:\r\n        return fail(s);\r\n    }\r\n  }\r\n\r\n  private _stringToPointerType(s: string) {\r\n    switch (s) {\r\n      case 'touch':\r\n        return PointerType.Touch;\r\n      case 'mouse':\r\n        return PointerType.Mouse;\r\n      case 'pen':\r\n        return PointerType.Pen;\r\n      default:\r\n        return PointerType.Unknown;\r\n    }\r\n  }\r\n}","import { Engine } from '../Engine';\r\nimport { Gamepads } from './Gamepad';\r\nimport { InputMapper } from './InputMapper';\r\nimport { Keyboard } from './Keyboard';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\n\r\nexport interface InputHostOptions {\r\n  pointerTarget: Document | HTMLCanvasElement\r\n  grabWindowFocus: boolean,\r\n  engine: Engine\r\n}\r\n\r\nexport class InputHost {\r\n  private _enabled = true;\r\n\r\n  keyboard: Keyboard;\r\n  pointers: PointerEventReceiver;\r\n  gamepads: Gamepads;\r\n  inputMapper: InputMapper;\r\n\r\n  constructor(options: InputHostOptions) {\r\n    const { pointerTarget, grabWindowFocus, engine } = options;\r\n    this.keyboard = new Keyboard();\r\n    this.pointers = new PointerEventReceiver(pointerTarget, engine);\r\n    this.gamepads = new Gamepads();\r\n\r\n    this.keyboard.init({grabWindowFocus});\r\n    this.pointers.init({grabWindowFocus});\r\n    this.gamepads.init();\r\n    this.inputMapper = new InputMapper({\r\n      keyboard: this.keyboard,\r\n      pointers: this.pointers,\r\n      gamepads: this.gamepads\r\n    });\r\n  }\r\n\r\n  get enabled() {\r\n    return this._enabled;\r\n  }\r\n\r\n  toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n    this.keyboard.toggleEnabled(this._enabled);\r\n    this.pointers.toggleEnabled(this._enabled);\r\n    this.gamepads.toggleEnabled(this._enabled);\r\n  }\r\n\r\n  update() {\r\n    if (this._enabled) {\r\n      this.inputMapper.execute();\r\n      this.keyboard.update();\r\n      this.gamepads.update();\r\n    }\r\n  }\r\n}","import { isScreenElement, ScreenElement } from './ScreenElement';\r\nimport {\r\n  InitializeEvent,\r\n  ActivateEvent,\r\n  DeactivateEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  PreDebugDrawEvent,\r\n  PostDebugDrawEvent\r\n} from './Events';\r\nimport { Logger } from './Util/Log';\r\nimport { Timer } from './Timer';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Camera } from './Camera';\r\nimport { Actor } from './Actor';\r\nimport { CanInitialize, CanActivate, CanDeactivate, CanUpdate, CanDraw, SceneActivationContext } from './Interfaces/LifecycleEvents';\r\nimport * as Util from './Util/Util';\r\nimport { Trigger } from './Trigger';\r\nimport { SystemType } from './EntityComponentSystem/System';\r\nimport { World } from './EntityComponentSystem/World';\r\nimport { MotionSystem } from './Collision/MotionSystem';\r\nimport { CollisionSystem } from './Collision/CollisionSystem';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { GraphicsSystem } from './Graphics/GraphicsSystem';\r\nimport { DebugSystem } from './Debug/DebugSystem';\r\nimport { PointerSystem } from './Input/PointerSystem';\r\nimport { ActionsSystem } from './Actions/ActionsSystem';\r\nimport { IsometricEntitySystem } from './TileMap/IsometricEntitySystem';\r\nimport { OffscreenSystem } from './Graphics/OffscreenSystem';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\nimport { PhysicsWorld } from './Collision/PhysicsWorld';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { Color } from './Color';\r\nimport { DefaultLoader } from './Director/DefaultLoader';\r\nimport { Transition } from './Director';\r\nimport { InputHost } from './Input/InputHost';\r\nimport { PointerScope } from './Input/PointerScope';\r\nimport { DefaultPhysicsConfig } from './Collision/PhysicsConfig';\r\n\r\nexport class PreLoadEvent {\r\n  loader: DefaultLoader;\r\n}\r\n\r\nexport type SceneEvents = {\r\n  initialize: InitializeEvent<Scene>,\r\n  activate: ActivateEvent,\r\n  deactivate: DeactivateEvent,\r\n  preupdate: PreUpdateEvent,\r\n  postupdate: PostUpdateEvent,\r\n  predraw: PreDrawEvent,\r\n  postdraw: PostDrawEvent,\r\n  predebugdraw: PreDebugDrawEvent,\r\n  postdebugdraw: PostDebugDrawEvent\r\n  preload: PreLoadEvent\r\n}\r\n\r\nexport const SceneEvents = {\r\n  Initialize: 'initialize',\r\n  Activate: 'activate',\r\n  Deactivate: 'deactivate',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PreDebugDraw: 'predebugdraw',\r\n  PostDebugDraw: 'postdebugdraw',\r\n  PreLoad: 'preload'\r\n};\r\n\r\nexport type SceneConstructor = new (...args: any[]) => Scene;\r\n/**\r\n *\r\n */\r\nexport function isSceneConstructor(x: any): x is SceneConstructor {\r\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\r\n}\r\n\r\n/**\r\n * [[Actor|Actors]] are composed together into groupings called Scenes in\r\n * Excalibur. The metaphor models the same idea behind real world\r\n * actors in a scene. Only actors in scenes will be updated and drawn.\r\n *\r\n * Typical usages of a scene include: levels, menus, loading screens, etc.\r\n */\r\nexport class Scene<TActivationData = unknown>\r\nimplements CanInitialize, CanActivate<TActivationData>, CanDeactivate, CanUpdate, CanDraw {\r\n  private _logger: Logger = Logger.getInstance();\r\n  public events = new EventEmitter<SceneEvents>();\r\n\r\n  /**\r\n   * Gets or sets the current camera for the scene\r\n   */\r\n  public camera: Camera = new Camera();\r\n\r\n  /**\r\n   * Scene specific background color\r\n   */\r\n  public backgroundColor?: Color;\r\n\r\n  /**\r\n   * The ECS world for the scene\r\n   */\r\n  public world: World = new World(this);\r\n\r\n  /**\r\n   * The Excalibur physics world for the scene. Used to interact\r\n   * with colliders included in the scene.\r\n   *\r\n   * Can be used to perform scene ray casts, track colliders, broadphase, and narrowphase.\r\n   */\r\n  public physics = new PhysicsWorld(DefaultPhysicsConfig);\r\n\r\n  /**\r\n   * The actors in the current scene\r\n   */\r\n  public get actors(): readonly Actor[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof Actor;\r\n    }) as Actor[];\r\n  }\r\n\r\n  /**\r\n   * The entities in the current scene\r\n   */\r\n  public get entities(): readonly Entity[] {\r\n    return this.world.entityManager.entities;\r\n  }\r\n\r\n  /**\r\n   * The triggers in the current scene\r\n   */\r\n  public get triggers(): readonly Trigger[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof Trigger;\r\n    }) as Trigger[];\r\n  }\r\n\r\n  /**\r\n   * The [[TileMap]]s in the scene, if any\r\n   */\r\n  public get tileMaps(): readonly TileMap[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof TileMap;\r\n    }) as TileMap[];\r\n  }\r\n\r\n  /**\r\n   * Access to the Excalibur engine\r\n   */\r\n  public engine: Engine;\r\n\r\n  /**\r\n   * Access scene specific input, handlers on this only fire when this scene is active.\r\n   */\r\n  public input: InputHost;\r\n\r\n  private _isInitialized: boolean = false;\r\n  private _timers: Timer[] = [];\r\n  public get timers(): readonly Timer[] {\r\n    return this._timers;\r\n  }\r\n  private _cancelQueue: Timer[] = [];\r\n\r\n  constructor() {\r\n    // Initialize systems\r\n\r\n    // Update\r\n    this.world.add(ActionsSystem);\r\n    this.world.add(new MotionSystem(this.world, this.physics));\r\n    this.world.add(new CollisionSystem(this.world, this.physics));\r\n    this.world.add(PointerSystem);\r\n    this.world.add(IsometricEntitySystem);\r\n    // Draw\r\n    this.world.add(OffscreenSystem);\r\n    this.world.add(GraphicsSystem);\r\n    this.world.add(DebugSystem);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, event: SceneEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Event hook to provide Scenes a way of loading scene specific resources.\r\n   *\r\n   * This is called before the Scene.onInitialize during scene transition. It will only ever fire once for a scene.\r\n   * @param loader\r\n   */\r\n  public onPreLoad(loader: DefaultLoader) {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Event hook fired directly before transition, either \"in\" or \"out\" of the scene\r\n   *\r\n   * This overrides the Engine scene definition. However transitions specified in goToScene take highest precedence\r\n   *\r\n   * ```typescript\r\n   * // Overrides all\r\n   * Engine.goToScene('scene', { destinationIn: ..., sourceOut: ... });\r\n   * ```\r\n   *\r\n   * This can be used to configure custom transitions for a scene dynamically\r\n   */\r\n  public onTransition(direction: 'in' | 'out'): Transition | undefined {\r\n    // will be overridden\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * This is called before the first update of the [[Scene]]. Initializes scene members like the camera. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made active and started. It is meant to be overridden,\r\n   * this is where you should setup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onActivate(context: SceneActivationContext<TActivationData>): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made transitioned away from and stopped. It is meant to be overridden,\r\n   * this is where you should cleanup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onDeactivate(context: SceneActivationContext): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   */\r\n  public onPreUpdate(engine: Engine, delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onPostUpdate(engine: Engine, delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreDraw` is called directly before a scene is drawn.\r\n   *\r\n   */\r\n  public onPreDraw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostDraw` is called directly after a scene is drawn.\r\n   *\r\n   */\r\n  public onPostDraw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Initializes actors in the scene\r\n   */\r\n  private _initializeChildren() {\r\n    for (const child of this.entities) {\r\n      child._initialize(this.engine);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets whether or not the [[Scene]] has been initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Initializes the scene before the first update, meant to be called by engine not by users of\r\n   * Excalibur\r\n   * @internal\r\n   */\r\n  public async _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      try {\r\n        this.engine = engine;\r\n        // PhysicsWorld config is watched so things will automagically update\r\n        this.physics.config = this.engine.physics;\r\n        this.input = new InputHost({\r\n          pointerTarget: engine.pointerScope === PointerScope.Canvas ? engine.canvas : document,\r\n          grabWindowFocus: engine.grabWindowFocus,\r\n          engine\r\n        });\r\n        // Initialize camera first\r\n        this.camera._initialize(engine);\r\n\r\n        this.world.systemManager.initialize();\r\n\r\n        // This order is important! we want to be sure any custom init that add actors\r\n        // fire before the actor init\r\n        await this.onInitialize(engine);\r\n        this._initializeChildren();\r\n\r\n        this._logger.debug('Scene.onInitialize', this, engine);\r\n        this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      } catch (e) {\r\n        this._logger.error(`Error during scene initialization for scene ${engine.director?.getSceneName(this)}!`);\r\n        throw e;\r\n      }\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Activates the scene with the base behavior, then calls the overridable `onActivate` implementation.\r\n   * @internal\r\n   */\r\n  public async _activate(context: SceneActivationContext<TActivationData>) {\r\n    try {\r\n      this._logger.debug('Scene.onActivate', this);\r\n      this.input.toggleEnabled(true);\r\n      await this.onActivate(context);\r\n    } catch (e) {\r\n      this._logger.error(`Error during scene activation for scene ${this.engine?.director?.getSceneName(this)}!`);\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Deactivates the scene with the base behavior, then calls the overridable `onDeactivate` implementation.\r\n   * @internal\r\n   */\r\n  public async _deactivate(context: SceneActivationContext<never>) {\r\n    this._logger.debug('Scene.onDeactivate', this);\r\n    this.input.toggleEnabled(false);\r\n    await this.onDeactivate(context);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPreUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, delta: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(engine, delta, this));\r\n    this.onPreUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for [[onPostUpdate]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, delta: number): void {\r\n    this.emit('postupdate', new PostUpdateEvent(engine, delta, this));\r\n    this.onPostUpdate(engine, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _predraw handler for [[onPreDraw]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _predraw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    this.emit('predraw', new PreDrawEvent(ctx, delta, this));\r\n    this.onPreDraw(ctx, delta);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _postdraw handler for [[onPostDraw]] lifecycle event\r\n   * @internal\r\n   */\r\n  public _postdraw(ctx: ExcaliburGraphicsContext, delta: number): void {\r\n    this.emit('postdraw', new PostDrawEvent(ctx, delta, this));\r\n    this.onPostDraw(ctx, delta);\r\n  }\r\n\r\n  /**\r\n   * Updates all the actors and timers in the scene. Called by the [[Engine]].\r\n   * @param engine  Reference to the current Engine\r\n   * @param delta   The number of milliseconds since the last update\r\n   */\r\n  public update(engine: Engine, delta: number) {\r\n    if (!this.isInitialized) {\r\n      this._logger.warnOnce(`Scene update called before initialize for scene ${engine.director?.getSceneName(this)}!`);\r\n      return;\r\n    }\r\n    this._preupdate(engine, delta);\r\n\r\n    // TODO differed entity removal for timers\r\n    let i: number, len: number;\r\n    // Remove timers in the cancel queue before updating them\r\n    for (i = 0, len = this._cancelQueue.length; i < len; i++) {\r\n      this.removeTimer(this._cancelQueue[i]);\r\n    }\r\n    this._cancelQueue.length = 0;\r\n\r\n    // Cycle through timers updating timers\r\n    for (const timer of this._timers) {\r\n      timer.update(delta);\r\n    }\r\n\r\n    this.world.update(SystemType.Update, delta);\r\n\r\n    // Camera last keeps renders smooth that are based on entity/actor\r\n    if (this.camera) {\r\n      this.camera.update(engine, delta);\r\n    }\r\n\r\n    this._collectActorStats(engine);\r\n\r\n    this._postupdate(engine, delta);\r\n\r\n    this.input.update();\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors in the Scene. Called by the [[Engine]].\r\n   * @param ctx    The current rendering context\r\n   * @param delta  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    if (!this.isInitialized) {\r\n      this._logger.warnOnce(`Scene draw called before initialize!`);\r\n      return;\r\n    }\r\n    this._predraw(ctx, delta);\r\n\r\n    this.world.update(SystemType.Draw, delta);\r\n\r\n    if (this.engine?.isDebug) {\r\n      this.debugDraw(ctx);\r\n    }\r\n    this._postdraw(ctx, delta);\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors' debug information in the Scene. Called by the [[Engine]].\r\n   * @param ctx  The current rendering context\r\n   */\r\n  /* istanbul ignore next */\r\n  public debugDraw(ctx: ExcaliburGraphicsContext) {\r\n    this.emit('predebugdraw', new PreDebugDrawEvent(ctx, this));\r\n    // pass\r\n    this.emit('postdebugdraw', new PostDebugDrawEvent(ctx, this));\r\n  }\r\n\r\n  /**\r\n   * Checks whether an actor is contained in this scene or not\r\n   */\r\n  public contains(actor: Actor): boolean {\r\n    return this.actors.indexOf(actor) > -1;\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the current [[Scene]].\r\n   * @param timer  The timer to add to the current [[Scene]].\r\n   */\r\n  public add(timer: Timer): void;\r\n\r\n  /**\r\n   * Adds a [[TileMap]] to the [[Scene]], once this is done the [[TileMap]] will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Adds a [[Trigger]] to the [[Scene]], once this is done the [[Trigger]] will listen for interactions with other actors.\r\n   * @param trigger\r\n   */\r\n  public add(trigger: Trigger): void;\r\n\r\n  /**\r\n   * Adds an actor to the scene, once this is done the [[Actor]] will be drawn and updated.\r\n   * @param actor  The actor to add to the current scene\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  /**\r\n   * Adds an [[Entity]] to the scene, once this is done the [[Actor]] will be drawn and updated.\r\n   * @param entity The entity to add to the current scene\r\n   */\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a [[ScreenElement]] to the scene.\r\n   * @param screenElement  The ScreenElement to add to the current scene\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    this.emit('entityadded', { target: entity } as any);\r\n    this.world.add(entity);\r\n    entity.scene = this;\r\n    if (entity instanceof Timer) {\r\n      if (!Util.contains(this._timers, entity)) {\r\n        this.addTimer(entity);\r\n      }\r\n      return;\r\n    }\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Removes a [[Timer]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param timer The Timer to transfer to the current scene\r\n   */\r\n  public transfer(timer: Timer): void;\r\n\r\n  /**\r\n   * Removes a [[TileMap]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param tileMap The TileMap to transfer to the current scene\r\n   */\r\n  public transfer(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Removes a [[Trigger]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param trigger The Trigger to transfer to the current scene\r\n   */\r\n  public transfer(trigger: Trigger): void;\r\n\r\n  /**\r\n   * Removes an [[Actor]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param actor The Actor to transfer to the current scene\r\n   */\r\n  public transfer(actor: Actor): void;\r\n\r\n  /**\r\n   * Removes an [[Entity]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param entity The Entity to transfer to the current scene\r\n   */\r\n  public transfer(entity: Entity): void;\r\n\r\n  /**\r\n   * Removes a [[ScreenElement]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param screenElement The ScreenElement to transfer to the current scene\r\n   */\r\n  public transfer(screenElement: ScreenElement): void;\r\n\r\n  /**\r\n   * Removes an [[Entity]] (Actor, TileMap, Trigger, etc) or [[Timer]] from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param entity\r\n   */\r\n  public transfer(entity: any): void {\r\n    let scene: Scene;\r\n    if (entity instanceof Entity && entity.scene && entity.scene !== this) {\r\n      scene = entity.scene;\r\n      entity.scene.world.remove(entity, false);\r\n    }\r\n    if (entity instanceof Timer && entity.scene) {\r\n      scene = entity.scene;\r\n      entity.scene.removeTimer(entity);\r\n    }\r\n    scene?.emit('entityremoved', { target: entity } as any);\r\n    this.add(entity);\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the current scene, it will no longer be updated.\r\n   * @param timer  The timer to remove to the current scene.\r\n   */\r\n  public remove(timer: Timer): void;\r\n\r\n  /**\r\n   * Removes a [[TileMap]] from the scene, it will no longer be drawn or updated.\r\n   * @param tileMap {TileMap}\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Removes an actor from the scene, it will no longer be drawn or updated.\r\n   * @param actor  The actor to remove from the current scene.\r\n   */\r\n  public remove(actor: Actor): void;\r\n\r\n  public remove(entity: Entity): void;\r\n\r\n  /**\r\n   * Removes a [[ScreenElement]] to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the current scene\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    if (entity instanceof Entity) {\r\n      this.emit('entityremoved', { target: entity } as any);\r\n      if (entity.active) {\r\n        entity.kill();\r\n      }\r\n      this.world.remove(entity);\r\n    }\r\n    if (entity instanceof Timer) {\r\n      this.removeTimer(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all entities and timers from the scene, optionally indicate whether deferred should or shouldn't be used.\r\n   *\r\n   * By default entities use deferred removal\r\n   * @param deferred\r\n   */\r\n  public clear(deferred: boolean = true): void {\r\n    for (let i = this.entities.length - 1; i >= 0; i--) {\r\n      this.world.remove(this.entities[i], deferred);\r\n    }\r\n    for (let i = this.timers.length - 1; i >= 0; i--) {\r\n      this.removeTimer(this.timers[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the scene\r\n   * @param timer  The timer to add\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    this._timers.push(timer);\r\n    timer.scene = this;\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the scene.\r\n   * @warning Can be dangerous, use [[cancelTimer]] instead\r\n   * @param timer  The timer to remove\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    const i = this._timers.indexOf(timer);\r\n    if (i !== -1) {\r\n      this._timers.splice(i, 1);\r\n    }\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Cancels a [[Timer]], removing it from the scene nicely\r\n   * @param timer  The timer to cancel\r\n   */\r\n  public cancelTimer(timer: Timer): Timer {\r\n    this._cancelQueue.push(timer);\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a [[Timer]] is active in the scene\r\n   */\r\n  public isTimerActive(timer: Timer): boolean {\r\n    return this._timers.indexOf(timer) > -1 && !timer.complete;\r\n  }\r\n\r\n  public isCurrentScene(): boolean {\r\n    if (this.engine) {\r\n      return this.engine.currentScene === this;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _collectActorStats(engine: Engine) {\r\n    const screenElements = this.actors.filter((a) => a instanceof ScreenElement) as ScreenElement[];\r\n    for (const _ui of screenElements) {\r\n      engine.stats.currFrame.actors.ui++;\r\n    }\r\n\r\n    for (const actor of this.actors) {\r\n      engine.stats.currFrame.actors.alive++;\r\n      for (const child of actor.children) {\r\n        if (isScreenElement(child as Actor)) {\r\n          // TODO not true\r\n          engine.stats.currFrame.actors.ui++;\r\n        } else {\r\n          engine.stats.currFrame.actors.alive++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","\r\n\r\nexport enum ColorBlindnessMode {\r\n  Protanope = 'Protanope',\r\n  Deuteranope = 'Deuteranope',\r\n  Tritanope = 'Tritanope'\r\n}\r\n","import { Shader } from '../Context/shader';\r\nimport { VertexBuffer } from '../Context/vertex-buffer';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\n\r\n/**\r\n * Helper that defines a whole screen renderer, just provide a fragment source!\r\n *\r\n * Currently supports 1 varying\r\n * - vec2 a_texcoord between 0-1 which corresponds to screen position\r\n */\r\nexport class ScreenShader {\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(gl: WebGL2RenderingContext, fragmentSource: string) {\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: `#version 300 es\r\n      in vec2 a_position;\r\n      in vec2 a_texcoord;\r\n      out vec2 v_texcoord;\r\n\r\n      void main() {\r\n        gl_Position = vec4(a_position, 0.0, 1.0);\r\n        // Pass the texcoord to the fragment shader.\r\n        v_texcoord = a_texcoord;\r\n      }`,\r\n      fragmentSource: fragmentSource\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1,          0, 0,\r\n        -1, 1,           0, 1,\r\n        1, -1,           1, 0,\r\n\r\n        1, -1,            1, 0,\r\n        -1, 1,           0, 1,\r\n        1, 1,            1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_texcoord', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  public getShader() {\r\n    return this._shader;\r\n  }\r\n  public getLayout() {\r\n    return this._layout;\r\n  }\r\n}","import colorBlindCorrectSource from './color-blind-fragment.glsl';\r\nimport { PostProcessor } from './PostProcessor';\r\nimport { ColorBlindnessMode } from './ColorBlindnessMode';\r\nimport { Shader } from '../Context/shader';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\nimport { ScreenShader } from './ScreenShader';\r\n\r\nexport class ColorBlindnessPostProcessor implements PostProcessor {\r\n  private _shader: ScreenShader;\r\n  private _simulate = false;\r\n  constructor(private _colorBlindnessMode: ColorBlindnessMode, simulate = false) {\r\n    this._simulate = simulate;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext): void {\r\n    this._shader = new ScreenShader(gl, colorBlindCorrectSource);\r\n    this.simulate = this._simulate;\r\n    this.colorBlindnessMode = this._colorBlindnessMode;\r\n  }\r\n\r\n  getShader(): Shader {\r\n    return this._shader.getShader();\r\n  }\r\n\r\n  getLayout(): VertexLayout {\r\n    return this._shader.getLayout();\r\n  }\r\n\r\n  set colorBlindnessMode(colorBlindMode: ColorBlindnessMode) {\r\n    this._colorBlindnessMode = colorBlindMode;\r\n    if (this._shader) {\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      if (this._colorBlindnessMode === ColorBlindnessMode.Protanope) {\r\n        shader.setUniformInt('u_type', 0);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Deuteranope) {\r\n        shader.setUniformInt('u_type', 1);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Tritanope) {\r\n        shader.setUniformInt('u_type', 2);\r\n      }\r\n    }\r\n  }\r\n\r\n  get colorBlindnessMode(): ColorBlindnessMode {\r\n    return this._colorBlindnessMode;\r\n  }\r\n\r\n  set simulate(value: boolean) {\r\n    this._simulate = value;\r\n    if (this._shader) {\r\n\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      shader.setUniformBoolean('u_simulate', value);\r\n    }\r\n  }\r\n\r\n  get simulate(): boolean {\r\n    return this._simulate;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n// our texture\\r\\nuniform sampler2D u_image;\\r\\n// the texCoords passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// color blind type\\r\\nuniform int u_type;\\r\\n\\r\\n// simulation?\\r\\nuniform bool u_simulate;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  vec4 o =  texture(u_image, v_texcoord);\\r\\n  // RGB to LMS matrix conversion\\r\\n  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\\r\\n  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\\r\\n  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\\r\\n  // Simulate color blindness\\r\\n  float l;\\r\\n  float m;\\r\\n  float s;\\r\\n  //MODE CODE//\\r\\n  if (u_type == 0) {\\r\\n    // Protanope\\r\\n    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;;\\r\\n  } else if (u_type == 1) {\\r\\n    // Deuteranope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;\\r\\n  } else if (u_type == 2) {\\r\\n    // Tritanope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\\r\\n  }\\r\\n\\r\\n  // LMS to RGB matrix conversion\\r\\n  vec4 error; // simulate the colors\\r\\n  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\\r\\n  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\\r\\n  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\\r\\n  error.a = 1.0;\\r\\n  vec4 diff = o - error;\\r\\n  vec4 correction; // correct the colors\\r\\n  correction.r = 0.0;\\r\\n  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\\r\\n  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\\r\\n  correction = o + correction;\\r\\n  correction.a = o.a;\\r\\n  //SIMULATE//\\r\\n\\r\\n  // sim \\r\\n  if (u_simulate) {\\r\\n    fragColor = error.rgba;\\r\\n  } else {\\r\\n    fragColor = correction.rgba;\\r\\n  }\\r\\n}\";","import { ColorBlindnessMode } from '../Graphics/PostProcessor/ColorBlindnessMode';\nimport { ColorBlindnessPostProcessor } from '../Graphics/PostProcessor/ColorBlindnessPostProcessor';\nimport { Engine } from '../Engine';\nimport { ExcaliburGraphicsContextWebGL } from '../Graphics/Context/ExcaliburGraphicsContextWebGL';\n\nexport class ColorBlindFlags {\n  private _engine: Engine;\n  private _colorBlindPostProcessor: ColorBlindnessPostProcessor;\n\n  constructor(engine: Engine) {\n    this._engine = engine;\n    this._colorBlindPostProcessor = new ColorBlindnessPostProcessor(ColorBlindnessMode.Protanope);\n  }\n\n  /**\n   * Correct colors for a specified color blindness\n   * @param colorBlindness\n   */\n  public correct(colorBlindness: ColorBlindnessMode) {\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\n      this.clear();\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\n      this._colorBlindPostProcessor.simulate = false;\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\n    }\n  }\n\n  /**\n   * Simulate colors for a specified color blindness\n   * @param colorBlindness\n   */\n  public simulate(colorBlindness: ColorBlindnessMode) {\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\n      this.clear();\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\n      this._colorBlindPostProcessor.simulate = true;\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\n    }\n  }\n\n  /**\n   * Remove color blindness post processor\n   */\n  public clear() {\n    this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor);\n  }\n}\n","import { ColorBlindFlags } from './DebugFlags';\r\nimport { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { CollisionContact } from '../Collision/Detection/CollisionContact';\r\nimport { StandardClock, TestClock } from '../Util/Clock';\r\n\r\n/**\r\n * Debug stats containing current and previous frame statistics\r\n */\r\nexport interface DebugStats {\r\n  currFrame: FrameStats;\r\n  prevFrame: FrameStats;\r\n}\r\n\r\n/**\r\n * Represents a frame's individual statistics\r\n */\r\nexport interface FrameStatistics {\r\n  /**\r\n   * The number of the frame\r\n   */\r\n  id: number;\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame scaled by [[Engine.timescale]]) (in ms)\r\n   */\r\n  delta: number;\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  fps: number;\r\n\r\n  /**\r\n   * Duration statistics (in ms)\r\n   */\r\n  duration: FrameDurationStats;\r\n\r\n  /**\r\n   * Actor statistics\r\n   */\r\n  actors: FrameActorStats;\r\n\r\n  /**\r\n   * Physics statistics\r\n   */\r\n  physics: PhysicsStatistics;\r\n\r\n  /**\r\n   * Graphics statistics\r\n   */\r\n  graphics: GraphicsStatistics;\r\n}\r\n\r\n/**\r\n * Represents actor stats for a frame\r\n */\r\nexport interface FrameActorStats {\r\n  /**\r\n   * Gets the frame's number of actors (alive)\r\n   */\r\n  alive: number;\r\n\r\n  /**\r\n   * Gets the frame's number of actors (killed)\r\n   */\r\n  killed: number;\r\n\r\n  /**\r\n   * Gets the frame's number of remaining actors (alive - killed)\r\n   */\r\n  remaining: number;\r\n\r\n  /**\r\n   * Gets the frame's number of UI actors\r\n   */\r\n  ui: number;\r\n\r\n  /**\r\n   * Gets the frame's number of total actors (remaining + UI)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents duration stats for a frame\r\n */\r\nexport interface FrameDurationStats {\r\n  /**\r\n   * Gets the frame's total time to run the update function (in ms)\r\n   */\r\n  update: number;\r\n\r\n  /**\r\n   * Gets the frame's total time to run the draw function (in ms)\r\n   */\r\n  draw: number;\r\n\r\n  /**\r\n   * Gets the frame's total render duration (update + draw duration) (in ms)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents physics stats for the current frame\r\n */\r\nexport interface PhysicsStatistics {\r\n  /**\r\n   * Gets the number of broadphase collision pairs which\r\n   */\r\n  pairs: number;\r\n\r\n  /**\r\n   * Gets the number of actual collisions\r\n   */\r\n  collisions: number;\r\n\r\n  /**\r\n   * Copy of the current frame contacts (only updated if debug is toggled on)\r\n   */\r\n  contacts: Map<string, CollisionContact>;\r\n\r\n  /**\r\n   * Gets the number of fast moving bodies using raycast continuous collisions in the scene\r\n   */\r\n  fastBodies: number;\r\n\r\n  /**\r\n   * Gets the number of bodies that had a fast body collision resolution\r\n   */\r\n  fastBodyCollisions: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the broadphase pairs\r\n   */\r\n  broadphase: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the narrowphase\r\n   */\r\n  narrowphase: number;\r\n}\r\n\r\nexport interface GraphicsStatistics {\r\n  drawCalls: number;\r\n  drawnImages: number;\r\n}\r\n\r\n/**\r\n * Debug statistics and flags for Excalibur. If polling these values, it would be\r\n * best to do so on the `postupdate` event for [[Engine]], after all values have been\r\n * updated during a frame.\r\n */\r\nexport class DebugConfig {\r\n  private _engine: Engine;\r\n\r\n  constructor(engine: Engine) {\r\n    this._engine = engine;\r\n\r\n    this.colorBlindMode = new ColorBlindFlags(this._engine);\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the [[TestClock]] and return\r\n   * it in the same running state.\r\n   *\r\n   * This is useful when you need to debug frame by frame.\r\n   */\r\n  public useTestClock(): TestClock {\r\n    const clock = this._engine.clock;\r\n    const wasRunning = clock.isRunning();\r\n    clock.stop();\r\n\r\n    const testClock = clock.toTestClock();\r\n    if (wasRunning) {\r\n      testClock.start();\r\n    }\r\n    this._engine.clock = testClock;\r\n    return testClock;\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the [[StandardClock]] and\r\n   * return it in the same running state.\r\n   *\r\n   * This is useful when you need to switch back to normal mode after\r\n   * debugging.\r\n   */\r\n  public useStandardClock(): StandardClock {\r\n    const currentClock = this._engine.clock;\r\n    const wasRunning = currentClock.isRunning();\r\n    currentClock.stop();\r\n\r\n    const standardClock = currentClock.toStandardClock();\r\n    if (wasRunning) {\r\n      standardClock.start();\r\n    }\r\n    this._engine.clock = standardClock;\r\n    return standardClock;\r\n  }\r\n\r\n  /**\r\n   * Performance statistics\r\n   */\r\n  public stats: DebugStats = {\r\n    /**\r\n     * Current frame statistics. Engine reuses this instance, use [[FrameStats.clone]] to copy frame stats.\r\n     * Best accessed on [[postframe]] event. See [[FrameStats]]\r\n     */\r\n    currFrame: new FrameStats(),\r\n\r\n    /**\r\n     * Previous frame statistics. Engine reuses this instance, use [[FrameStats.clone]] to copy frame stats.\r\n     * Best accessed on [[preframe]] event. Best inspected on engine event `preframe`. See [[FrameStats]]\r\n     */\r\n    prevFrame: new FrameStats()\r\n  };\r\n\r\n  /**\r\n   * Correct or simulate color blindness using [[ColorBlindnessPostProcessor]].\r\n   * @warning Will reduce FPS.\r\n   */\r\n  public colorBlindMode: ColorBlindFlags;\r\n\r\n  /**\r\n   * Filter debug context to named entities or entity ids\r\n   */\r\n  public filter: { useFilter: boolean; nameQuery: string; ids: number[] } = {\r\n    /**\r\n     * Toggle filter on or off (default off) must be on for DebugDraw to use filters\r\n     */\r\n    useFilter: false,\r\n    /**\r\n     * Query for entities by name, if the entity name contains `nameQuery` it will be included\r\n     */\r\n    nameQuery: '',\r\n    /**\r\n     * Query for Entity ids, if the id matches it will be included\r\n     */\r\n    ids: []\r\n  };\r\n\r\n  /**\r\n   * Entity debug settings\r\n   */\r\n  public entity = {\r\n    showAll: false,\r\n    showId: false,\r\n    showName: false\r\n  };\r\n\r\n  /**\r\n   * Transform component debug settings\r\n   */\r\n  public transform = {\r\n    showAll: false,\r\n\r\n    debugZIndex: 10_000_000,\r\n    showPosition: false,\r\n    showPositionLabel: false,\r\n    positionColor: Color.Yellow,\r\n\r\n    showZIndex: false,\r\n\r\n    showScale: false,\r\n    scaleColor: Color.Green,\r\n\r\n    showRotation: false,\r\n    rotationColor: Color.Blue\r\n  };\r\n\r\n  /**\r\n   * Graphics component debug settings\r\n   */\r\n  public graphics = {\r\n    showAll: false,\r\n\r\n    showBounds: false,\r\n    boundsColor: Color.Yellow\r\n  };\r\n\r\n  /**\r\n   * Collider component debug settings\r\n   */\r\n  public collider = {\r\n    showAll: false,\r\n\r\n    showBounds: false,\r\n    boundsColor: Color.Blue,\r\n\r\n    showOwner: false,\r\n\r\n    showGeometry: true,\r\n    geometryColor: Color.Green,\r\n    geometryLineWidth: 1,\r\n    geometryPointSize: .5\r\n  };\r\n\r\n  /**\r\n   * Physics simulation debug settings\r\n   */\r\n  public physics = {\r\n    showAll: false,\r\n\r\n    showBroadphaseSpacePartitionDebug: false,\r\n\r\n    showCollisionNormals: false,\r\n    collisionNormalColor: Color.Cyan,\r\n\r\n    showCollisionContacts: true,\r\n    contactSize: 2,\r\n    collisionContactColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Motion component debug settings\r\n   */\r\n  public motion = {\r\n    showAll: false,\r\n\r\n    showVelocity: false,\r\n    velocityColor: Color.Yellow,\r\n\r\n    showAcceleration: false,\r\n    accelerationColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Body component debug settings\r\n   */\r\n  public body = {\r\n    showAll: false,\r\n\r\n    showCollisionGroup: false,\r\n    showCollisionType: false,\r\n    showSleeping: false,\r\n    showMotion: false,\r\n    showMass: false\r\n  };\r\n\r\n  /**\r\n   * Camera debug settings\r\n   */\r\n  public camera = {\r\n    showAll: false,\r\n\r\n    showFocus: false,\r\n    focusColor: Color.Red,\r\n\r\n    showZoom: false\r\n  };\r\n\r\n  public tilemap = {\r\n    showAll: false,\r\n\r\n    showGrid: false,\r\n    gridColor: Color.Red,\r\n    gridWidth: .5,\r\n    showSolidBounds: false,\r\n    solidBoundsColor: Color.fromHex('#8080807F'), // grayish\r\n    showColliderGeometry: true\r\n  };\r\n\r\n  public isometric = {\r\n    showAll: false,\r\n    showPosition: false,\r\n    positionColor: Color.Yellow,\r\n    positionSize: 1,\r\n    showGrid: false,\r\n    gridColor: Color.Red,\r\n    gridWidth: 1,\r\n    showColliderGeometry: true\r\n  };\r\n}\r\n\r\n/**\r\n * Implementation of a frame's stats. Meant to have values copied via [[FrameStats.reset]], avoid\r\n * creating instances of this every frame.\r\n */\r\nexport class FrameStats implements FrameStatistics {\r\n  private _id: number = 0;\r\n  private _delta: number = 0;\r\n  private _fps: number = 0;\r\n  private _actorStats: FrameActorStats = {\r\n    alive: 0,\r\n    killed: 0,\r\n    ui: 0,\r\n    get remaining() {\r\n      return this.alive - this.killed;\r\n    },\r\n    get total() {\r\n      return this.remaining + this.ui;\r\n    }\r\n  };\r\n  private _durationStats: FrameDurationStats = {\r\n    update: 0,\r\n    draw: 0,\r\n    get total() {\r\n      return this.update + this.draw;\r\n    }\r\n  };\r\n\r\n  private _physicsStats: PhysicsStats = new PhysicsStats();\r\n\r\n  private _graphicsStats: GraphicsStatistics = {\r\n    drawCalls: 0,\r\n    drawnImages: 0\r\n  };\r\n\r\n  /**\r\n   * Zero out values or clone other IFrameStat stats. Allows instance reuse.\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: FrameStatistics) {\r\n    if (otherStats) {\r\n      this.id = otherStats.id;\r\n      this.delta = otherStats.delta;\r\n      this.fps = otherStats.fps;\r\n      this.actors.alive = otherStats.actors.alive;\r\n      this.actors.killed = otherStats.actors.killed;\r\n      this.actors.ui = otherStats.actors.ui;\r\n      this.duration.update = otherStats.duration.update;\r\n      this.duration.draw = otherStats.duration.draw;\r\n      this._physicsStats.reset(otherStats.physics);\r\n      this.graphics.drawCalls = otherStats.graphics.drawCalls;\r\n      this.graphics.drawnImages = otherStats.graphics.drawnImages;\r\n    } else {\r\n      this.id = this.delta = this.fps = 0;\r\n      this.actors.alive = this.actors.killed = this.actors.ui = 0;\r\n      this.duration.update = this.duration.draw = 0;\r\n      this._physicsStats.reset();\r\n      this.graphics.drawnImages = this.graphics.drawCalls = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): FrameStats {\r\n    const fs = new FrameStats();\r\n\r\n    fs.reset(this);\r\n\r\n    return fs;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's id\r\n   */\r\n  public get id() {\r\n    return this._id;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's id\r\n   */\r\n  public set id(value: number) {\r\n    this._id = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame)\r\n   */\r\n  public get delta() {\r\n    return this._delta;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's delta (time since last frame). Internal use only.\r\n   * @internal\r\n   */\r\n  public set delta(value: number) {\r\n    this._delta = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  public get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's frames-per-second (FPS). Internal use only.\r\n   * @internal\r\n   */\r\n  public set fps(value: number) {\r\n    this._fps = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's actor statistics\r\n   */\r\n  public get actors() {\r\n    return this._actorStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's duration statistics\r\n   */\r\n  public get duration() {\r\n    return this._durationStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's physics statistics\r\n   */\r\n  public get physics() {\r\n    return this._physicsStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's graphics statistics\r\n   */\r\n  public get graphics() {\r\n    return this._graphicsStats;\r\n  }\r\n}\r\n\r\nexport class PhysicsStats implements PhysicsStatistics {\r\n  private _pairs: number = 0;\r\n  private _collisions: number = 0;\r\n  private _contacts: Map<string, CollisionContact> = new Map();\r\n  private _fastBodies: number = 0;\r\n  private _fastBodyCollisions: number = 0;\r\n  private _broadphase: number = 0;\r\n  private _narrowphase: number = 0;\r\n\r\n  /**\r\n   * Zero out values or clone other IPhysicsStats stats. Allows instance reuse.\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: PhysicsStatistics) {\r\n    if (otherStats) {\r\n      this.pairs = otherStats.pairs;\r\n      this.collisions = otherStats.collisions;\r\n      this.contacts = otherStats.contacts;\r\n      this.fastBodies = otherStats.fastBodies;\r\n      this.fastBodyCollisions = otherStats.fastBodyCollisions;\r\n      this.broadphase = otherStats.broadphase;\r\n      this.narrowphase = otherStats.narrowphase;\r\n    } else {\r\n      this.pairs = this.collisions = this.fastBodies = 0;\r\n      this.fastBodyCollisions = this.broadphase = this.narrowphase = 0;\r\n      this.contacts.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): PhysicsStatistics {\r\n    const ps = new PhysicsStats();\r\n\r\n    ps.reset(this);\r\n\r\n    return ps;\r\n  }\r\n\r\n  public get pairs(): number {\r\n    return this._pairs;\r\n  }\r\n\r\n  public set pairs(value: number) {\r\n    this._pairs = value;\r\n  }\r\n\r\n  public get collisions(): number {\r\n    return this._collisions;\r\n  }\r\n\r\n  public set collisions(value: number) {\r\n    this._collisions = value;\r\n  }\r\n\r\n  public get contacts(): Map<string, CollisionContact> {\r\n    return this._contacts;\r\n  }\r\n\r\n  public set contacts(contacts: Map<string, CollisionContact>) {\r\n    this._contacts = contacts;\r\n  }\r\n\r\n  public get fastBodies(): number {\r\n    return this._fastBodies;\r\n  }\r\n\r\n  public set fastBodies(value: number) {\r\n    this._fastBodies = value;\r\n  }\r\n\r\n  public get fastBodyCollisions(): number {\r\n    return this._fastBodyCollisions;\r\n  }\r\n\r\n  public set fastBodyCollisions(value: number) {\r\n    this._fastBodyCollisions = value;\r\n  }\r\n\r\n  public get broadphase(): number {\r\n    return this._broadphase;\r\n  }\r\n\r\n  public set broadphase(value: number) {\r\n    this._broadphase = value;\r\n  }\r\n\r\n  public get narrowphase(): number {\r\n    return this._narrowphase;\r\n  }\r\n\r\n  public set narrowphase(value: number) {\r\n    this._narrowphase = value;\r\n  }\r\n}\r\n","export interface NativeEventable {\r\n  addEventListener(name: string, handler: (...any: any[]) => any): any;\r\n  removeEventListener(name: string, handler: (...any: any[]) => any): any;\r\n}\r\n\r\nexport class BrowserComponent<T extends NativeEventable> {\r\n  private _paused = false;\r\n  private _nativeHandlers: { [key: string]: (handler: any) => void } = {};\r\n\r\n  on(eventName: string, handler: (evt: any) => void): void {\r\n    if (this._nativeHandlers[eventName]) {\r\n      this.off(eventName, this._nativeHandlers[eventName]);\r\n    }\r\n    this._nativeHandlers[eventName] = this._decorate(handler);\r\n    this.nativeComponent.addEventListener(eventName, this._nativeHandlers[eventName]);\r\n  }\r\n  off(eventName: string, handler?: (event: any) => void): void {\r\n    if (!handler) {\r\n      handler = this._nativeHandlers[eventName];\r\n    }\r\n    this.nativeComponent.removeEventListener(eventName, handler);\r\n    this._nativeHandlers[eventName] = null;\r\n  }\r\n\r\n  private _decorate(handler: (evt: any) => void): (evt: any) => void {\r\n    return (evt: any) => {\r\n      if (!this._paused) {\r\n        handler(evt);\r\n      }\r\n    };\r\n  }\r\n\r\n  public pause() {\r\n    this._paused = true;\r\n  }\r\n\r\n  public resume() {\r\n    this._paused = false;\r\n  }\r\n\r\n  public clear() {\r\n    for (const event in this._nativeHandlers) {\r\n      this.off(event);\r\n    }\r\n  }\r\n\r\n  constructor(public nativeComponent: T) {}\r\n}\r\n\r\nexport class BrowserEvents {\r\n  private _windowComponent: BrowserComponent<Window>;\r\n  private _documentComponent: BrowserComponent<Document>;\r\n  constructor(private _windowGlobal: Window, private _documentGlobal: Document) {\r\n    this._windowComponent = new BrowserComponent(this._windowGlobal);\r\n    this._documentComponent = new BrowserComponent(this._documentGlobal);\r\n  }\r\n\r\n  public get window(): BrowserComponent<Window> {\r\n    return this._windowComponent;\r\n  }\r\n\r\n  public get document(): BrowserComponent<Document> {\r\n    return this._documentComponent;\r\n  }\r\n\r\n  public pause() {\r\n    this.window.pause();\r\n    this.document.pause();\r\n  }\r\n\r\n  public resume() {\r\n    this.window.resume();\r\n    this.document.resume();\r\n  }\r\n\r\n  public clear() {\r\n    this.window.clear();\r\n    this.document.clear();\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { Resolution } from '../../Screen';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\nimport { ImageFiltering } from '../Filtering';\r\n\r\nexport type HTMLImageSource = HTMLImageElement | HTMLCanvasElement;\r\n\r\nexport interface AntialiasOptions {\r\n  /**\r\n   * Turns on the special pixel art sampler in excalibur's image shader for sub pixel\r\n   * anti-aliasing\r\n   *\r\n   * Default false\r\n   */\r\n  pixelArtSampler?: boolean;\r\n  /**\r\n   * Configures the webgl's getContext('webgl2', {antialias: true | false}) or configures\r\n   * Canvas2D imageSmoothing = true;\r\n   *\r\n   * **Note** this option is incompatible with `multiSampleAntialiasing`\r\n   *\r\n   * Default false\r\n   */\r\n  nativeContextAntialiasing?: boolean;\r\n  /**\r\n   * Configures the internal render buffer multi-sampling settings\r\n   *\r\n   * Default true, with max samples that the platform supports\r\n   */\r\n  multiSampleAntialiasing?: boolean | {\r\n    /**\r\n     * Optionally specify number of samples (will be clamped to the max the platform supports)\r\n     *\r\n     * Default most platforms are 16 samples\r\n     */\r\n    samples: number;\r\n  };\r\n  /**\r\n   * Sets the default image filtering for excalibur\r\n   *\r\n   * Default [[ImageFiltering.Blended]]\r\n   */\r\n  filtering?: ImageFiltering;\r\n  /**\r\n   * Sets the canvas image rendering CSS style\r\n   *\r\n   * Default 'auto'\r\n   */\r\n  canvasImageRendering?: 'pixelated' | 'auto';\r\n}\r\n\r\nexport const DefaultAntialiasOptions: Required<AntialiasOptions> = {\r\n  pixelArtSampler: false,\r\n  nativeContextAntialiasing: false,\r\n  multiSampleAntialiasing: true,\r\n  filtering: ImageFiltering.Blended,\r\n  canvasImageRendering: 'auto'\r\n};\r\n\r\nexport const DefaultPixelArtOptions: Required<AntialiasOptions> = {\r\n  pixelArtSampler: true,\r\n  nativeContextAntialiasing: false,\r\n  multiSampleAntialiasing: true,\r\n  filtering: ImageFiltering.Blended,\r\n  canvasImageRendering: 'auto'\r\n};\r\n\r\nexport interface ExcaliburGraphicsContextOptions {\r\n  /**\r\n   * Target existing html canvas element\r\n   */\r\n  canvasElement: HTMLCanvasElement;\r\n  /**\r\n   * Enables antialiasing on the canvas context (smooths pixels with default canvas sampling)\r\n   */\r\n  antialiasing?: boolean;\r\n  /**\r\n   * Enable the sub pixel antialiasing pixel art sampler for nice looking pixel art\r\n   */\r\n  pixelArtSampler?: boolean;\r\n  /**\r\n   * Enable canvas transparency\r\n   */\r\n  enableTransparency?: boolean;\r\n  /**\r\n   * Enable or disable multi-sample antialiasing in the internal render buffer.\r\n   *\r\n   * If true the max number of samples will be used\r\n   *\r\n   * By default enabled\r\n   */\r\n  multiSampleAntialiasing?: boolean | {\r\n    /**\r\n     * Specify number of samples to use during the multi sample anti-alias, if not specified the max will be used.\r\n     * Limited by the hardware (usually 16)\r\n     */\r\n    samples: number\r\n  },\r\n  /**\r\n   * UV padding in pixels to use in the internal image rendering\r\n   *\r\n   * Recommended .25 - .5 of a pixel\r\n   */\r\n  uvPadding?: number;\r\n  /**\r\n   * Hint the power preference to the graphics context\r\n   */\r\n  powerPreference?: 'default' | 'high-performance' | 'low-power';\r\n  /**\r\n   * Snaps the pixel to an integer value (floor)\r\n   */\r\n  snapToPixel?: boolean;\r\n  /**\r\n   * Current clearing color of the context\r\n   */\r\n  backgroundColor?: Color;\r\n  /**\r\n   * Feature flag that enables draw sorting will removed in v0.29\r\n   */\r\n  useDrawSorting?: boolean;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContextState {\r\n  opacity: number;\r\n  z: number;\r\n  tint: Color;\r\n  material: Material;\r\n}\r\nexport interface LineGraphicsOptions {\r\n  color?: Color;\r\n}\r\n\r\nexport interface RectGraphicsOptions {\r\n  color?: Color;\r\n}\r\n\r\nexport interface PointGraphicsOptions {\r\n  color: Color;\r\n  size: number;\r\n}\r\n\r\nexport interface DebugDraw {\r\n  /**\r\n   * Draw a debugging rectangle to the screen\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   * @param rectOptions\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number, rectOptions?: RectGraphicsOptions): void;\r\n  /**\r\n   * Draw a debugging line to the screen\r\n   * @param start '\r\n   * @param end\r\n   * @param lineOptions\r\n   */\r\n  drawLine(start: Vector, end: Vector, lineOptions?: LineGraphicsOptions): void;\r\n  /**\r\n   * Draw a debugging point to the screen\r\n   * @param point\r\n   * @param pointOptions\r\n   */\r\n  drawPoint(point: Vector, pointOptions?: PointGraphicsOptions): void;\r\n\r\n  /**\r\n   * Draw debug text\r\n   * @param text\r\n   * @param pos\r\n   */\r\n  drawText(text: string, pos: Vector): void;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContext {\r\n  width: number;\r\n  height: number;\r\n\r\n  /**\r\n   * Excalibur will automatically sort draw calls by z and priority for maximal draw performance,\r\n   * this can disrupt a specific desired painter order.\r\n   *\r\n   * To force a specific draw call order, use [[ExcaliburGraphicsContext.z]]\r\n   *\r\n   * By default `useDrawSorting` is `true`, to opt out set this to `false`\r\n   */\r\n  useDrawSorting: boolean;\r\n\r\n  /**\r\n   * Set the current z context for the graphics context. Draw calls issued to the context will use this z\r\n   * to inform their sort order.\r\n   *\r\n   * Note it is important to all [[ExcaliburGraphicsContext.save]] and [[ExcaliburGraphicsContext.restore]] when modifying state.\r\n   */\r\n  z: number;\r\n\r\n  /**\r\n   * Snaps all drawings to the nearest pixel truncated down, by default false\r\n   */\r\n  snapToPixel: boolean;\r\n\r\n  /**\r\n   * Enable smoothed drawing (also known as anti-aliasing), by default true\r\n   */\r\n  smoothing: boolean;\r\n\r\n  /**\r\n   * Set the background color of the graphics context, default is [[Color.ExcaliburBlue]]\r\n   */\r\n  backgroundColor: Color;\r\n\r\n  /**\r\n   * Sets the opacity of the current [[Graphic]] being drawn, default is 1\r\n   */\r\n  opacity: number;\r\n\r\n  /**\r\n   * Sets the tint color to be multiplied by any images drawn, default is black 0xFFFFFFFF\r\n   */\r\n  tint: Color;\r\n\r\n  /**\r\n   * Resets the current transform to the identity matrix\r\n   */\r\n  resetTransform(): void;\r\n\r\n  /**\r\n   * Gets the current transform\r\n   */\r\n  getTransform(): AffineMatrix;\r\n\r\n  /**\r\n   * Multiplies the current transform by a matrix\r\n   * @param m\r\n   */\r\n  multiply(m: AffineMatrix): void;\r\n\r\n  /**\r\n   * Update the context with the current viewport dimensions (used in resizing)\r\n   */\r\n  updateViewport(resolution: Resolution): void;\r\n\r\n  /**\r\n   * Access the debug drawing api\r\n   */\r\n  debug: DebugDraw;\r\n\r\n  /**\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate using the images width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate with a specific width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context specifying the source image coordinates (sx, sy, swidth, sheight)\r\n   * and to a specific destination on the context (dx, dy, dwidth, dheight)\r\n   */\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n\r\n  /**\r\n   * Draw a solid line to the Excalibur Graphics context\r\n   * @param start\r\n   * @param end\r\n   * @param color\r\n   * @param thickness\r\n   */\r\n  drawLine(start: Vector, end: Vector, color: Color, thickness: number): void;\r\n\r\n  /**\r\n   * Draw a solid rectangle to the Excalibur Graphics context\r\n   * @param pos\r\n   * @param width\r\n   * @param height\r\n   * @param color\r\n   */\r\n  drawRectangle(pos: Vector, width: number, height: number, color: Color, stroke?: Color, strokeThickness?: number): void;\r\n\r\n  /**\r\n   * Draw a circle to the Excalibur Graphics context\r\n   * @param pos\r\n   * @param radius\r\n   * @param color\r\n   * @param stroke Optionally specify the stroke color\r\n   * @param thickness\r\n   */\r\n  drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number): void;\r\n\r\n  /**\r\n   * Save the current state of the canvas to the stack (transforms and opacity)\r\n   */\r\n  save(): void;\r\n\r\n  /**\r\n   * Restore the state of the canvas from the stack\r\n   */\r\n  restore(): void;\r\n\r\n  /**\r\n   * Translate the origin of the context by an x and y\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number): void;\r\n\r\n  /**\r\n   * Rotate the context about the current origin\r\n   */\r\n  rotate(angle: number): void;\r\n\r\n  /**\r\n   * Scale the context by an x and y factor\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number): void;\r\n\r\n  /**\r\n   * Add a post processor to the graphics context\r\n   *\r\n   * Post processors are run in the order they were added.\r\n   * @param postprocessor\r\n   */\r\n  addPostProcessor(postprocessor: PostProcessor): void;\r\n\r\n  /**\r\n   * Remove a specific post processor from the graphics context\r\n   * @param postprocessor\r\n   */\r\n  removePostProcessor(postprocessor: PostProcessor): void;\r\n\r\n  /**\r\n   * Remove all post processors from the graphics context\r\n   */\r\n  clearPostProcessors(): void;\r\n\r\n  /**\r\n   * Updates all post processors in the graphics context\r\n   *\r\n   * Called internally by Excalibur\r\n   * @param delta\r\n   * @internal\r\n   */\r\n  updatePostProcessors(delta: number): void;\r\n\r\n  /**\r\n   * Gets or sets the material to be used in the current context's drawings\r\n   *\r\n   * This allows customs shaders to be used but draw calls are no longer batched by default.\r\n   * @param material\r\n   */\r\n  material: Material;\r\n\r\n  /**\r\n   * Creates and initializes the material which compiles the internal shader\r\n   * @param options\r\n   * @returns\r\n   */\r\n  createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material;\r\n\r\n  /**\r\n   * Clears the screen with the current background color\r\n   */\r\n  clear(): void;\r\n\r\n  /**\r\n   * Flushes the batched draw calls to the screen\r\n   */\r\n  flush(): void;\r\n\r\n  beginDrawLifecycle(): void;\r\n\r\n  endDrawLifecycle(): void;\r\n\r\n  dispose(): void;\r\n}\r\n","export interface FpsSamplerOptions {\r\n  /**\r\n   * Specify the sampling period in milliseconds (default 100)\r\n   */\r\n  samplePeriod?: number;\r\n  /**\r\n   * Specify the initial FPS\r\n   */\r\n  initialFps: number;\r\n\r\n  /**\r\n   * Specify the function used to return the current time (in milliseconds)\r\n   */\r\n  nowFn: () => number;\r\n}\r\n\r\nexport class FpsSampler {\r\n  private _fps: number;\r\n  private _samplePeriod: number = 100;\r\n  private _currentFrameTime: number = 0;\r\n  private _frames: number = 0;\r\n  private _previousSampleTime: number = 0;\r\n  private _beginFrameTime: number = 0;\r\n  private _nowFn: () => number;\r\n\r\n  constructor(options: FpsSamplerOptions) {\r\n    this._fps = options.initialFps;\r\n    this._samplePeriod = options.samplePeriod ?? this._samplePeriod;\r\n    this._currentFrameTime = 1000/options.initialFps;\r\n    this._nowFn = options.nowFn;\r\n    this._previousSampleTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * Start of code block to sample FPS for\r\n   */\r\n  start() {\r\n    this._beginFrameTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * End of code block to sample FPS for\r\n   */\r\n  end() {\r\n    this._frames++;\r\n    const time = this._nowFn();\r\n\r\n    this._currentFrameTime = time - this._beginFrameTime;\r\n\r\n    if (time >= this._previousSampleTime + this._samplePeriod) {\r\n      this._fps = (this._frames * 1000) / (time - this._previousSampleTime);\r\n      this._previousSampleTime = time;\r\n      this._frames = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the currently sampled fps over the last sample period, by default every 100ms\r\n   */\r\n  get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Return the instantaneous fps, this can be less useful because it will fluctuate given the current frames time\r\n   */\r\n  get instant() {\r\n    return 1000 / this._currentFrameTime;\r\n  }\r\n}","import { Logger } from '../Util/Log';\r\nimport { FpsSampler } from './Fps';\r\n\r\nexport type ScheduledCallbackTiming = 'preframe' | 'postframe' | 'preupdate' | 'postupdate' | 'predraw' | 'postdraw';\r\n\r\nexport interface ClockOptions {\r\n  /**\r\n   * Define the function you'd like the clock to tick when it is started\r\n   */\r\n  tick: (elapsedMs: number) => any;\r\n  /**\r\n   * Optionally define the fatal exception handler, used if an error is thrown in tick\r\n   */\r\n  onFatalException?: (e: unknown) => any;\r\n  /**\r\n   * Optionally limit the maximum FPS of the clock\r\n   */\r\n  maxFps?: number;\r\n}\r\n\r\n\r\n/**\r\n * Abstract Clock is the base type of all Clocks\r\n *\r\n * It has a few opinions\r\n * 1. It manages the calculation of what \"elapsed\" time means and thus maximum fps\r\n * 2. The default timing api is implemented in now()\r\n *\r\n * To implement your own clock, extend Clock and override start/stop to start and stop the clock, then call update() with whatever\r\n * method is unique to your clock implementation.\r\n */\r\nexport abstract class Clock {\r\n  protected tick: (elapsedMs: number) => any;\r\n  private _onFatalException: (e: unknown) => any = () => { /* default nothing */ };\r\n  private _maxFps: number = Infinity;\r\n  private _lastTime: number = 0;\r\n  public fpsSampler: FpsSampler;\r\n  private _options: ClockOptions;\r\n  private _elapsed: number = 1;\r\n  private _scheduledCbs: [cb: (elapsedMs: number) => any, scheduledTime: number, timing: ScheduledCallbackTiming][] = [];\r\n  private _totalElapsed: number = 0;\r\n  constructor(options: ClockOptions) {\r\n    this._options = options;\r\n    this.tick = options.tick;\r\n    this._lastTime = this.now() ?? 0;\r\n    this._maxFps = options.maxFps ?? this._maxFps;\r\n    this._onFatalException = options.onFatalException ?? this._onFatalException;\r\n    this.fpsSampler = new FpsSampler({\r\n      initialFps: 60,\r\n      nowFn: () => this.now()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the elapsed time for the last completed frame\r\n   */\r\n  public elapsed(): number {\r\n    return this._elapsed;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public now(): number {\r\n    return performance.now();\r\n  }\r\n\r\n  public toTestClock() {\r\n    const testClock = new TestClock({\r\n      ...this._options,\r\n      defaultUpdateMs: 16.6\r\n    });\r\n    return testClock;\r\n  }\r\n\r\n  public toStandardClock() {\r\n    const clock = new StandardClock({\r\n      ...this._options\r\n    });\r\n    return clock;\r\n  }\r\n\r\n  public setFatalExceptionHandler(handler: (e: unknown) => any) {\r\n    this._onFatalException = handler;\r\n  }\r\n\r\n  /**\r\n   * Schedule a callback to fire given a timeout in milliseconds using the excalibur [[Clock]]\r\n   *\r\n   * This is useful to use over the built in browser `setTimeout` because callbacks will be tied to the\r\n   * excalibur update clock, instead of browser time, this means that callbacks wont fire if the game is\r\n   * stopped or paused.\r\n   * @param cb callback to fire\r\n   * @param timeoutMs Optionally specify a timeout in milliseconds from now, default is 0ms which means the next possible tick\r\n   * @param timing Optionally specify a timeout in milliseconds from now, default is 0ms which means the next possible tick\r\n   */\r\n  public schedule(cb: (elapsedMs: number) => any, timeoutMs: number = 0, timing: ScheduledCallbackTiming = 'preframe') {\r\n    // Scheduled based on internal elapsed time\r\n    const scheduledTime = this._totalElapsed + timeoutMs;\r\n    this._scheduledCbs.push([cb, scheduledTime, timing]);\r\n  }\r\n\r\n  /**\r\n   * Called internally to trigger scheduled callbacks in the clock\r\n   * @param timing\r\n   * @internal\r\n   */\r\n  public __runScheduledCbs(timing: ScheduledCallbackTiming = 'preframe') {\r\n    // walk backwards to delete items as we loop\r\n    for (let i = this._scheduledCbs.length - 1; i > -1; i--) {\r\n      if (timing === this._scheduledCbs[i][2] && this._scheduledCbs[i][1] <= this._totalElapsed) {\r\n        this._scheduledCbs[i][0](this._elapsed);\r\n        this._scheduledCbs.splice(i, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  protected update(overrideUpdateMs?: number): void {\r\n    try {\r\n      this.fpsSampler.start();\r\n      // Get the time to calculate time-elapsed\r\n      const now = this.now();\r\n      let elapsed = now - this._lastTime || 1; // first frame\r\n\r\n      // Constrain fps\r\n      const fpsInterval = (1000 / this._maxFps);\r\n\r\n      // only run frame if enough time has elapsed\r\n      if (elapsed >= fpsInterval) {\r\n        let leftover = 0;\r\n        if (fpsInterval !== 0) {\r\n          leftover = (elapsed % fpsInterval);\r\n          elapsed = elapsed - leftover; // shift elapsed to be \"in phase\" with the current loop fps\r\n        }\r\n\r\n        // Resolves issue #138 if the game has been paused, or blurred for\r\n        // more than a 200 milliseconds, reset elapsed time to 1. This improves reliability\r\n        // and provides more expected behavior when the engine comes back\r\n        // into focus\r\n        if (elapsed > 200) {\r\n          elapsed = 1;\r\n        }\r\n\r\n        // tick the mainloop and run scheduled callbacks\r\n        this._elapsed = overrideUpdateMs || elapsed;\r\n        this._totalElapsed += this._elapsed;\r\n        this.__runScheduledCbs('preframe');\r\n        this.tick(overrideUpdateMs || elapsed);\r\n        this.__runScheduledCbs('postframe');\r\n\r\n        if (fpsInterval !== 0) {\r\n          this._lastTime = now - leftover;\r\n        } else {\r\n          this._lastTime = now;\r\n        }\r\n        this.fpsSampler.end();\r\n      }\r\n    } catch (e) {\r\n      this._onFatalException(e);\r\n      this.stop();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns if the clock is currently running\r\n   */\r\n  public abstract isRunning(): boolean;\r\n\r\n  /**\r\n   * Start the clock, it will then periodically call the tick(elapsedMilliseconds) since the last tick\r\n   */\r\n  public abstract start(): void;\r\n\r\n  /**\r\n   * Stop the clock, tick() is no longer called\r\n   */\r\n  public abstract stop(): void;\r\n}\r\n\r\n\r\n/**\r\n * The [[StandardClock]] implements the requestAnimationFrame browser api to run the tick()\r\n */\r\nexport class StandardClock extends Clock {\r\n\r\n  private _running = false;\r\n  private _requestId: number;\r\n  constructor(options: ClockOptions) {\r\n    super(options);\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n\r\n  public start(): void {\r\n    if (this._running) {\r\n      return;\r\n    }\r\n    this._running = true;\r\n    const mainloop = () => {\r\n      // stop the loop\r\n      if (!this._running) {\r\n        return;\r\n      }\r\n      try {\r\n        // request next loop\r\n        this._requestId = window.requestAnimationFrame(mainloop);\r\n        this.update();\r\n      } catch (e) {\r\n        window.cancelAnimationFrame(this._requestId);\r\n        throw e;\r\n      }\r\n    };\r\n\r\n    // begin the first frame\r\n    mainloop();\r\n  }\r\n\r\n  public stop(): void {\r\n    window.cancelAnimationFrame(this._requestId);\r\n    this._running = false;\r\n  }\r\n}\r\n\r\nexport interface TestClockOptions {\r\n  /**\r\n   * Specify the update milliseconds to use for each manual step()\r\n   */\r\n  defaultUpdateMs: number;\r\n}\r\n\r\n/**\r\n * The TestClock is meant for debugging interactions in excalibur that require precise timing to replicate or test\r\n */\r\nexport class TestClock extends Clock {\r\n  private _logger = Logger.getInstance();\r\n  private _updateMs: number;\r\n  private _running: boolean = false;\r\n  private _currentTime = 0;\r\n  constructor(options: ClockOptions & TestClockOptions) {\r\n    super({\r\n      ...options\r\n    });\r\n    this._updateMs = options.defaultUpdateMs;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public override now() {\r\n    return this._currentTime ?? 0;\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n  public start(): void {\r\n    this._running = true;\r\n  }\r\n  public stop(): void {\r\n    this._running = false;\r\n  }\r\n\r\n  /**\r\n   * Manually step the clock forward 1 tick, optionally specify an elapsed time in milliseconds\r\n   * @param overrideUpdateMs\r\n   */\r\n  step(overrideUpdateMs?: number): void {\r\n    const time = overrideUpdateMs ?? this._updateMs;\r\n\r\n    if (this._running) {\r\n      // to be comparable to RAF this needs to be a full blown Task\r\n      // For example, images cannot decode synchronously in a single step\r\n      this.update(time);\r\n      this._currentTime += time;\r\n    } else {\r\n      this._logger.warn('The clock is not running, no step will be performed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run a number of steps that tick the clock, optionally specify an elapsed time in milliseconds\r\n   * @param numberOfSteps\r\n   * @param overrideUpdateMs\r\n   */\r\n  run(numberOfSteps: number, overrideUpdateMs?: number): void {\r\n    for (let i = 0; i < numberOfSteps; i++) {\r\n      this.step(overrideUpdateMs ?? this._updateMs);\r\n    }\r\n  }\r\n}","import toasterCss from './Toaster.css';\r\n\r\n/**\r\n * The Toaster is only meant to be called from inside Excalibur to display messages to players\r\n */\r\nexport class Toaster {\r\n  private _styleBlock: HTMLStyleElement;\r\n  private _container: HTMLDivElement;\r\n  private _toasterCss: string = toasterCss.toString();\r\n\r\n  private _isInitialized = false;\r\n  private _initialize() {\r\n    if (!this._isInitialized) {\r\n      this._container = document.createElement('div');\r\n      this._container.id = 'ex-toast-container';\r\n      document.body.appendChild(this._container);\r\n      this._isInitialized = true;\r\n\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._toasterCss;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n  }\r\n\r\n  public dispose() {\r\n    this._container.parentElement.removeChild(this._container);\r\n\r\n    this._styleBlock.parentElement.removeChild(this._styleBlock);\r\n\r\n    this._isInitialized = false;\r\n  }\r\n\r\n  private _createFragment(message: string) {\r\n    const toastMessage = document.createElement('span');\r\n    toastMessage.innerText = message;\r\n    return toastMessage;\r\n  }\r\n\r\n  /**\r\n   * Display a toast message to a player\r\n   * @param message Text of the message, messages may have a single \"[LINK]\" to influence placement\r\n   * @param linkTarget Optionally specify a link location\r\n   * @param linkName Optionally specify a name for that link location\r\n   */\r\n  public toast(message: string, linkTarget?: string, linkName?: string) {\r\n    this._initialize();\r\n    const toast = document.createElement('div');\r\n    toast.className = 'ex-toast-message';\r\n\r\n    const messageFragments: HTMLElement[] = message.split('[LINK]').map(message => this._createFragment(message));\r\n\r\n    if (linkTarget) {\r\n      const link = document.createElement('a');\r\n      link.href = linkTarget;\r\n      if (linkName) {\r\n        link.innerText = linkName;\r\n      } else {\r\n        link.innerText = linkTarget;\r\n      }\r\n      messageFragments.splice(1, 0, link);\r\n    }\r\n\r\n    // Assembly message\r\n    const finalMessage = document.createElement('div');\r\n    messageFragments.forEach(message => {\r\n      finalMessage.appendChild(message);\r\n    });\r\n    toast.appendChild(finalMessage);\r\n\r\n    // Dismiss button\r\n    const dismissBtn = document.createElement('button');\r\n    dismissBtn.innerText = 'x';\r\n    dismissBtn.addEventListener('click', () => {\r\n      this._container.removeChild(toast);\r\n    });\r\n    toast.appendChild(dismissBtn);\r\n\r\n    // Escape to dismiss\r\n    const keydownHandler = (evt: KeyboardEvent) => {\r\n      if (evt.key === 'Escape') {\r\n        try {\r\n          this._container.removeChild(toast);\r\n        } catch {\r\n          // pass\r\n        }\r\n      }\r\n      document.removeEventListener('keydown', keydownHandler);\r\n    };\r\n    document.addEventListener('keydown', keydownHandler);\r\n\r\n    // Insert into container\r\n    const first = this._container.firstChild;\r\n    this._container.insertBefore(toast, first);\r\n  }\r\n}","import { Engine } from '../Engine';\r\nimport { DefaultLoader, LoaderConstructor, isLoaderConstructor } from './DefaultLoader';\r\nimport { Scene, SceneConstructor, isSceneConstructor } from '../Scene';\r\nimport { Transition } from './Transition';\r\nimport { Loader } from './Loader';\r\nimport { Logger } from '../Util/Log';\r\nimport { ActivateEvent, DeactivateEvent } from '../Events';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport interface DirectorNavigationEvent {\r\n  sourceName: string;\r\n  sourceScene: Scene;\r\n  destinationName: string;\r\n  destinationScene: Scene;\r\n}\r\n\r\nexport type DirectorEvents = {\r\n  navigationstart: DirectorNavigationEvent,\r\n  navigation: DirectorNavigationEvent,\r\n  navigationend: DirectorNavigationEvent,\r\n}\r\n\r\nexport const DirectorEvents = {\r\n  NavigationStart: 'navigationstart',\r\n  Navigation: 'navigation',\r\n  NavigationEnd: 'navigationend'\r\n};\r\n\r\nexport interface SceneWithOptions {\r\n  /**\r\n   * Scene associated with this route\r\n   *\r\n   * If a constructor is provided it will not be constructed until navigation is requested\r\n   */\r\n  scene: Scene | SceneConstructor;\r\n  /**\r\n   * Specify scene transitions\r\n   */\r\n  transitions?: {\r\n    /**\r\n     * Optionally specify a transition when going \"in\" to this scene\r\n     */\r\n    in?: Transition;\r\n    /**\r\n     * Optionally specify a transition when going \"out\" of this scene\r\n     */\r\n    out?: Transition;\r\n  };\r\n  /**\r\n   * Optionally specify a loader for the scene\r\n   */\r\n  loader?: DefaultLoader | LoaderConstructor;\r\n}\r\n\r\nexport type WithRoot<TScenes> = TScenes | 'root';\r\n\r\nexport type SceneMap<TKnownScenes extends string = any> = Record<TKnownScenes, Scene | SceneConstructor | SceneWithOptions>;\r\n\r\nexport interface StartOptions {\r\n  /**\r\n   * First transition from the game start screen\r\n   */\r\n  inTransition: Transition;\r\n  /**\r\n   * Optionally provide a main loader to run before the game starts\r\n   */\r\n  loader?: DefaultLoader | LoaderConstructor\r\n}\r\n\r\n\r\n/**\r\n * Provide scene activation data and override any existing configured route transitions or loaders\r\n */\r\nexport interface GoToOptions<TActivationData = any> {\r\n  /**\r\n   * Optionally supply scene activation data passed to Scene.onActivate\r\n   */\r\n  sceneActivationData?: TActivationData;\r\n  /**\r\n   * Optionally supply destination scene \"in\" transition, this will override any previously defined transition\r\n   */\r\n  destinationIn?: Transition;\r\n  /**\r\n   * Optionally supply source scene \"out\" transition, this will override any previously defined transition\r\n   */\r\n  sourceOut?: Transition;\r\n  /**\r\n   * Optionally supply a different loader for the destination scene, this will override any previously defined loader\r\n   */\r\n  loader?: DefaultLoader;\r\n}\r\n\r\n/**\r\n * The Director is responsible for managing scenes and changing scenes in Excalibur.\r\n *\r\n * It deals with transitions, scene loaders, switching scenes\r\n *\r\n * This is used internally by Excalibur, generally not mean to\r\n * be instantiated end users directly.\r\n */\r\nexport class Director<TKnownScenes extends string = any> {\r\n  public events = new EventEmitter<DirectorEvents>();\r\n  private _logger = Logger.getInstance();\r\n  private _deferredGoto: string;\r\n  private _deferredTransition: Transition;\r\n  private _initialized = false;\r\n\r\n  /**\r\n   * Current scene's name\r\n   */\r\n  currentSceneName: string;\r\n  /**\r\n   * Current scene playing in excalibur\r\n   */\r\n  currentScene: Scene;\r\n  /**\r\n   * Current transition if any\r\n   */\r\n  currentTransition: Transition | null;\r\n\r\n  /**\r\n   * All registered scenes in Excalibur\r\n   */\r\n  public readonly scenes: SceneMap<WithRoot<TKnownScenes>> = {} as SceneMap<WithRoot<TKnownScenes>>;\r\n\r\n  /**\r\n   * Holds all instantiated scenes\r\n   */\r\n  private _sceneToInstance = new Map<string, Scene>();\r\n\r\n  startScene: string;\r\n  mainLoader: DefaultLoader;\r\n\r\n  /**\r\n   * The default [[Scene]] of the game, use [[Engine.goToScene]] to transition to different scenes.\r\n   */\r\n  public readonly rootScene: Scene;\r\n\r\n  private _sceneToLoader = new Map<string, DefaultLoader>();\r\n  private _sceneToTransition = new Map<string, {in: Transition, out: Transition }>();\r\n  /**\r\n   * Used to keep track of scenes that have already been loaded so we don't load multiple times\r\n   */\r\n  private _loadedScenes = new Set<Scene>();\r\n\r\n  private _isTransitioning = false;\r\n\r\n  /**\r\n   * Gets whether the director currently transitioning between scenes\r\n   *\r\n   * Useful if you need to block behavior during transition\r\n   */\r\n  public get isTransitioning() {\r\n    return this._isTransitioning;\r\n  }\r\n\r\n  constructor(private _engine: Engine, scenes: SceneMap<TKnownScenes>) {\r\n    this.rootScene = this.currentScene = new Scene();\r\n    this.add('root', this.rootScene);\r\n    this.currentScene = this.rootScene;\r\n    this.currentSceneName = 'root';\r\n    for (const sceneKey in scenes) {\r\n      const sceneOrOptions = scenes[sceneKey];\r\n      this.add(sceneKey, sceneOrOptions);\r\n      if (sceneKey === 'root') {\r\n        this.rootScene = this.getSceneInstance('root');\r\n        this.currentScene = this.rootScene;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the director's internal state\r\n   */\r\n  async onInitialize() {\r\n    if (!this._initialized) {\r\n      this._initialized = true;\r\n      if (this._deferredGoto) {\r\n        const deferredScene = this._deferredGoto;\r\n        const deferredTransition = this._deferredTransition;\r\n        this._deferredGoto = null;\r\n        this._deferredTransition = null;\r\n        await this.swapScene(deferredScene);\r\n        if (deferredTransition) {\r\n          await this.playTransition(deferredTransition);\r\n        }\r\n      } else {\r\n        await this.swapScene('root');\r\n      }\r\n    }\r\n  }\r\n\r\n  get isInitialized() {\r\n    return this._initialized;\r\n  }\r\n\r\n  /**\r\n   * Configures the start scene, and optionally the transition & loader for the director\r\n   *\r\n   * Typically this is called at the beginning of the game to the start scene and transition and never again.\r\n   * @param startScene\r\n   * @param options\r\n   */\r\n  configureStart(startScene: WithRoot<TKnownScenes>, options?: StartOptions) {\r\n    const maybeLoaderOrCtor = options?.loader;\r\n    if (maybeLoaderOrCtor instanceof DefaultLoader) {\r\n      this.mainLoader = maybeLoaderOrCtor;\r\n    } else if (isLoaderConstructor(maybeLoaderOrCtor)) {\r\n      this.mainLoader = new maybeLoaderOrCtor();\r\n    } else {\r\n      this.mainLoader = new Loader();\r\n    }\r\n\r\n    let maybeStartTransition: Transition;\r\n\r\n    if (options) {\r\n      const { inTransition } = options;\r\n      maybeStartTransition = inTransition;\r\n    }\r\n\r\n    this.startScene = startScene;\r\n\r\n    // Fire and forget promise for the initial scene\r\n    if (maybeStartTransition) {\r\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n      this.swapScene(this.startScene).then(() => {\r\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n        this.playTransition(maybeStartTransition);\r\n      });\r\n    } else {\r\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n      this.swapScene(this.startScene);\r\n    }\r\n\r\n    this.currentSceneName = this.startScene;\r\n  }\r\n\r\n  private _getLoader(sceneName: string) {\r\n    return this._sceneToLoader.get(sceneName);\r\n  }\r\n\r\n  private _getInTransition(sceneName: string): Transition | undefined {\r\n    const sceneOrRoute = this.scenes[sceneName as TKnownScenes];\r\n    if (sceneOrRoute instanceof Scene || isSceneConstructor(sceneOrRoute)) {\r\n      return null;\r\n    }\r\n    return sceneOrRoute?.transitions?.in;\r\n  }\r\n\r\n  private _getOutTransition(sceneName: string): Transition | undefined {\r\n    const sceneOrRoute = this.scenes[sceneName as TKnownScenes];\r\n    if (sceneOrRoute instanceof Scene || isSceneConstructor(sceneOrRoute)) {\r\n      return null;\r\n    }\r\n    return sceneOrRoute?.transitions?.out;\r\n  }\r\n\r\n  getDeferredScene() {\r\n    const maybeDeferred = this.getSceneDefinition(this._deferredGoto);\r\n    if (this._deferredGoto && maybeDeferred) {\r\n      return maybeDeferred;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns a scene by name if it exists, might be the constructor and not the instance of a scene\r\n   * @param name\r\n   */\r\n  getSceneDefinition(name: string): Scene | SceneConstructor | undefined {\r\n    const maybeScene = this.scenes[name as TKnownScenes];\r\n    if (maybeScene instanceof Scene || isSceneConstructor(maybeScene)) {\r\n      return maybeScene;\r\n    } else if (maybeScene) {\r\n      return maybeScene.scene;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Returns the name of the registered scene, null if none can be found\r\n   * @param scene\r\n   */\r\n  getSceneName(scene: Scene): string | null {\r\n    for (const [name, maybeScene] of Object.entries(this.scenes)) {\r\n      if (maybeScene instanceof Scene) {\r\n        if (scene === maybeScene) {\r\n          return name;\r\n        }\r\n      } else if (!isSceneConstructor(maybeScene)) {\r\n        if (scene === maybeScene.scene) {\r\n          return name;\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const [name, maybeScene] of Object.entries(this.scenes)) {\r\n      if (isSceneConstructor(maybeScene)) {\r\n        if (scene.constructor === maybeScene) {\r\n          return name;\r\n        }\r\n      } else if (!(maybeScene instanceof Scene)) {\r\n        if (scene.constructor === maybeScene.scene) {\r\n          return name;\r\n        }\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the same Director, but asserts a scene DOES exist to the type system\r\n   * @param name\r\n   */\r\n  assertAdded<TScene extends string>(name: TScene): Director<TKnownScenes | TScene> {\r\n    return this as Director<TKnownScenes | TScene>;\r\n  }\r\n\r\n  /**\r\n   * Returns the same Director, but asserts a scene DOES NOT exist to the type system\r\n   * @param name\r\n   */\r\n  assertRemoved<TScene extends string>(name: TScene): Director<Exclude<TKnownScenes, TScene>> {\r\n    return this as Director<Exclude<TKnownScenes, TScene>>;\r\n  }\r\n\r\n  /**\r\n   * Adds additional Scenes to the game!\r\n   * @param name\r\n   * @param sceneOrRoute\r\n   */\r\n  add<TScene extends string>(name: TScene, sceneOrRoute: Scene | SceneConstructor | SceneWithOptions): Director<TKnownScenes | TScene> {\r\n    if (!(sceneOrRoute instanceof Scene) && !(isSceneConstructor(sceneOrRoute))) {\r\n      const { loader, transitions } = sceneOrRoute;\r\n      const {in: inTransition, out: outTransition } = transitions ?? {};\r\n      this._sceneToTransition.set(name, {in: inTransition, out: outTransition});\r\n\r\n      if (isLoaderConstructor(loader)) {\r\n        this._sceneToLoader.set(name, new loader());\r\n      } else {\r\n        this._sceneToLoader.set(name, loader);\r\n      }\r\n    }\r\n\r\n    if (this.scenes[name as unknown as TKnownScenes]) {\r\n      this._logger.warn('Scene', name, 'already exists overwriting');\r\n    }\r\n    this.scenes[name as unknown as TKnownScenes] = sceneOrRoute;\r\n    return this.assertAdded(name);\r\n  }\r\n\r\n  remove(scene: Scene): void;\r\n  remove(sceneCtor: SceneConstructor): void;\r\n  remove(name: WithRoot<TKnownScenes>): void;\r\n  remove(nameOrScene: TKnownScenes | Scene | SceneConstructor | string) {\r\n\r\n    if (nameOrScene instanceof Scene || isSceneConstructor(nameOrScene)) {\r\n      const sceneOrCtor = nameOrScene;\r\n      // remove scene\r\n      for (const key in this.scenes) {\r\n        if (this.scenes.hasOwnProperty(key)) {\r\n          const potentialSceneOrOptions = this.scenes[key as TKnownScenes];\r\n          let scene: Scene | SceneConstructor;\r\n          if (potentialSceneOrOptions instanceof Scene || isSceneConstructor(potentialSceneOrOptions)) {\r\n            scene = potentialSceneOrOptions;\r\n          } else {\r\n            scene = potentialSceneOrOptions.scene;\r\n          }\r\n\r\n          if (scene === sceneOrCtor) {\r\n            if (key === this.currentSceneName) {\r\n              throw new Error(`Cannot remove a currently active scene: ${key}`);\r\n            }\r\n\r\n            this._sceneToInstance.delete(key);\r\n            this._sceneToTransition.delete(key);\r\n            this._sceneToLoader.delete(key);\r\n            delete this.scenes[key as TKnownScenes];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (typeof nameOrScene === 'string') {\r\n      if (nameOrScene === this.currentSceneName) {\r\n        throw new Error(`Cannot remove a currently active scene: ${nameOrScene}`);\r\n      }\r\n\r\n      // remove scene\r\n      this._sceneToInstance.delete(nameOrScene);\r\n      this._sceneToTransition.delete(nameOrScene);\r\n      this._sceneToLoader.delete(nameOrScene);\r\n      delete this.scenes[nameOrScene as TKnownScenes];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Go to a specific scene, and optionally override loaders and transitions\r\n   * @param destinationScene\r\n   * @param options\r\n   */\r\n  async goto(destinationScene: TKnownScenes | string, options?: GoToOptions) {\r\n\r\n    const maybeDest = this.getSceneInstance(destinationScene);\r\n    if (!maybeDest) {\r\n      this._logger.warn(`Scene ${destinationScene} does not exist! Check the name, are you sure you added it?`);\r\n      return;\r\n    }\r\n\r\n    const sourceScene = this.currentSceneName;\r\n    const engineInputEnabled = this._engine.input?.enabled ?? true;\r\n    this._isTransitioning = true;\r\n\r\n    const maybeSourceOut = this.getSceneInstance(sourceScene)?.onTransition('out');\r\n    const maybeDestinationIn = maybeDest?.onTransition('in');\r\n\r\n    options = {\r\n      // Engine configuration then dynamic scene transitions\r\n      ...{ sourceOut: this._getOutTransition(this.currentSceneName) ?? maybeSourceOut},\r\n      ...{ destinationIn: this._getInTransition(destinationScene) ?? maybeDestinationIn},\r\n      // Goto options\r\n      ...options };\r\n\r\n    const { sourceOut, destinationIn, sceneActivationData } = options;\r\n\r\n    const outTransition = sourceOut ?? this._getOutTransition(this.currentSceneName);\r\n    const inTransition = destinationIn ?? this._getInTransition(destinationScene);\r\n\r\n    const hideLoader = outTransition?.hideLoader || inTransition?.hideLoader;\r\n    if (hideLoader) {\r\n      // Start hidden loader early and take advantage of the transition\r\n      // Don't await and block on a hidden loader\r\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n      this.maybeLoadScene(destinationScene, hideLoader);\r\n    }\r\n\r\n    this._emitEvent('navigationstart', sourceScene, destinationScene);\r\n\r\n    // Run the out transition on the current scene if present\r\n    await this.playTransition(outTransition);\r\n\r\n    // Run the loader if present\r\n    await this.maybeLoadScene(destinationScene, hideLoader);\r\n\r\n    // Give incoming transition a chance to grab info from previous\r\n    await inTransition?.onPreviousSceneDeactivate(this.currentScene);\r\n\r\n    // Swap to the new scene\r\n    await this.swapScene(destinationScene, sceneActivationData);\r\n    this._emitEvent('navigation', sourceScene, destinationScene);\r\n\r\n    // Run the in transition on the new scene if present\r\n    await this.playTransition(inTransition);\r\n    this._emitEvent('navigationend', sourceScene, destinationScene);\r\n\r\n    this._engine.input?.toggleEnabled(engineInputEnabled);\r\n    this._isTransitioning = false;\r\n  }\r\n\r\n  /**\r\n   * Retrieves a scene instance by key if it's registered.\r\n   *\r\n   * This will call any constructors that were given as a definition\r\n   * @param scene\r\n   */\r\n  getSceneInstance(scene: string): Scene | undefined {\r\n    const sceneDefinition = this.getSceneDefinition(scene);\r\n    if (!sceneDefinition) {\r\n      return undefined;\r\n    }\r\n    if (this._sceneToInstance.has(scene)) {\r\n      return this._sceneToInstance.get(scene) as Scene;\r\n    }\r\n    if (sceneDefinition instanceof Scene) {\r\n      this._sceneToInstance.set(scene, sceneDefinition);\r\n      return sceneDefinition;\r\n    }\r\n    const newScene = new sceneDefinition();\r\n    this._sceneToInstance.set(scene, newScene);\r\n    return newScene;\r\n  }\r\n\r\n  /**\r\n   * Triggers scene loading if has not already been loaded\r\n   * @param scene\r\n   * @param hideLoader\r\n   */\r\n  async maybeLoadScene(scene: string, hideLoader = false) {\r\n    const loader = this._getLoader(scene) ?? new DefaultLoader();\r\n    const sceneToLoad = this.getSceneDefinition(scene);\r\n    const sceneToLoadInstance = this.getSceneInstance(scene);\r\n    if (sceneToLoad && sceneToLoadInstance && !this._loadedScenes.has(sceneToLoadInstance)) {\r\n      sceneToLoadInstance.onPreLoad(loader);\r\n      sceneToLoadInstance.events.emit('preload', { loader });\r\n      if (hideLoader) {\r\n        // Don't await a hidden loader\r\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n        this._engine.load(loader, hideLoader);\r\n      } else {\r\n        await this._engine.load(loader);\r\n      }\r\n      this._loadedScenes.add(sceneToLoadInstance);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Plays a transition in the current scene\r\n   * @param transition\r\n   */\r\n  async playTransition(transition: Transition) {\r\n    if (!this.isInitialized) {\r\n      this._deferredTransition = transition;\r\n      return;\r\n    }\r\n\r\n    if (transition) {\r\n      this.currentTransition = transition;\r\n      const currentScene = this._engine.currentScene;\r\n      const sceneInputEnabled = currentScene.input?.enabled ?? true;\r\n\r\n      currentScene.input?.toggleEnabled(!transition.blockInput);\r\n      this._engine.input?.toggleEnabled(!transition.blockInput);\r\n\r\n      await this.currentTransition.play(this._engine);\r\n\r\n      currentScene.input?.toggleEnabled(sceneInputEnabled);\r\n    }\r\n    this.currentTransition?.kill();\r\n    this.currentTransition?.reset();\r\n    this.currentTransition = null;\r\n  }\r\n\r\n  /**\r\n   * Swaps the current and destination scene after performing required lifecycle events\r\n   * @param destinationScene\r\n   * @param data\r\n   */\r\n  async swapScene<TData = undefined>(destinationScene: string, data?: TData): Promise<void> {\r\n    const engine = this._engine;\r\n    // if not yet initialized defer goToScene\r\n    if (!this.isInitialized) {\r\n      this._deferredGoto = destinationScene;\r\n      return;\r\n    }\r\n\r\n    const maybeDest = this.getSceneInstance(destinationScene);\r\n\r\n    if (maybeDest) {\r\n      const previousScene = this.currentScene;\r\n      const nextScene = maybeDest;\r\n\r\n      this._logger.debug('Going to scene:', destinationScene);\r\n      // only deactivate when initialized\r\n      if (this.currentScene.isInitialized) {\r\n        const context = { engine, previousScene, nextScene };\r\n        await this.currentScene._deactivate(context);\r\n        this.currentScene.events.emit('deactivate', new DeactivateEvent(context, this.currentScene));\r\n      }\r\n\r\n      // wait for the scene to be loaded if needed\r\n      const destLoader = this._sceneToLoader.get(destinationScene);\r\n      await destLoader?.areResourcesLoaded();\r\n\r\n      // set current scene to new one\r\n      this.currentScene = nextScene;\r\n      this.currentSceneName = destinationScene;\r\n      engine.screen.setCurrentCamera(nextScene.camera);\r\n\r\n      // initialize the current scene if has not been already\r\n      await this.currentScene._initialize(engine);\r\n\r\n      const context = { engine, previousScene, nextScene, data };\r\n      await this.currentScene._activate(context);\r\n      this.currentScene.events.emit('activate', new ActivateEvent(context, this.currentScene));\r\n    } else {\r\n      this._logger.error('Scene', destinationScene, 'does not exist!');\r\n    }\r\n  }\r\n\r\n  private _emitEvent(eventName: keyof DirectorEvents, sourceScene: string, destinationScene: string) {\r\n    const source = this.getSceneDefinition(sourceScene)!;\r\n    const dest = this.getSceneDefinition(destinationScene)!;\r\n    this.events.emit(eventName, {\r\n      sourceScene: source,\r\n      sourceName: sourceScene,\r\n      destinationScene: dest,\r\n      destinationName: destinationScene\r\n    } as DirectorNavigationEvent);\r\n  }\r\n}\r\n\r\n\r\n","import { EX_VERSION } from './';\r\nimport { Future } from './Util/Future';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { PointerScope } from './Input/PointerScope';\r\nimport { Flags } from './Flags';\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\nimport { CanUpdate, CanDraw, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { Vector } from './Math/vector';\r\nimport { Screen, DisplayMode, Resolution, ViewportDimension } from './Screen';\r\nimport { ScreenElement } from './ScreenElement';\r\nimport { Actor } from './Actor';\r\nimport { Timer } from './Timer';\r\nimport { TileMap } from './TileMap';\r\nimport { DefaultLoader } from './Director/DefaultLoader';\r\nimport { Loader } from './Director/Loader';\r\nimport { Detector } from './Util/Detector';\r\nimport {\r\n  VisibleEvent,\r\n  HiddenEvent,\r\n  GameStartEvent,\r\n  GameStopEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreFrameEvent,\r\n  PostFrameEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  InitializeEvent\r\n} from './Events';\r\nimport { Logger, LogLevel } from './Util/Log';\r\nimport { Color } from './Color';\r\nimport { Scene, SceneConstructor, isSceneConstructor } from './Scene';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { DebugConfig, DebugStats } from './Debug/DebugConfig';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport {\r\n  AntialiasOptions,\r\n  DefaultAntialiasOptions,\r\n  DefaultPixelArtOptions,\r\n  ExcaliburGraphicsContext,\r\n  ExcaliburGraphicsContext2DCanvas,\r\n  ExcaliburGraphicsContextWebGL,\r\n  TextureLoader\r\n} from './Graphics';\r\nimport { Clock, StandardClock } from './Util/Clock';\r\nimport { ImageFiltering } from './Graphics/Filtering';\r\nimport { GraphicsDiagnostics } from './Graphics/GraphicsDiagnostics';\r\nimport { Toaster } from './Util/Toaster';\r\nimport { InputMapper } from './Input/InputMapper';\r\nimport { GoToOptions, SceneMap, Director, StartOptions, SceneWithOptions, WithRoot } from './Director/Director';\r\nimport { InputHost } from './Input/InputHost';\r\nimport { DefaultPhysicsConfig, DeprecatedStaticToConfig, PhysicsConfig } from './Collision/PhysicsConfig';\r\nimport { DeepRequired } from './Util/Required';\r\nimport { Context, createContext, useContext } from './Context';\r\n\r\nexport type EngineEvents = {\r\n  fallbackgraphicscontext: ExcaliburGraphicsContext2DCanvas,\r\n  initialize: InitializeEvent<Engine>,\r\n  visible: VisibleEvent,\r\n  hidden: HiddenEvent,\r\n  start: GameStartEvent,\r\n  stop: GameStopEvent,\r\n  preupdate: PreUpdateEvent<Engine>,\r\n  postupdate: PostUpdateEvent<Engine>,\r\n  preframe: PreFrameEvent,\r\n  postframe: PostFrameEvent,\r\n  predraw: PreDrawEvent,\r\n  postdraw: PostDrawEvent,\r\n}\r\n\r\nexport const EngineEvents = {\r\n  FallbackGraphicsContext: 'fallbackgraphicscontext',\r\n  Initialize: 'initialize',\r\n  Visible: 'visible',\r\n  Hidden: 'hidden',\r\n  Start: 'start',\r\n  Stop: 'stop',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreFrame: 'preframe',\r\n  PostFrame: 'postframe',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw'\r\n} as const;\r\n\r\n\r\n\r\n/**\r\n * Enum representing the different mousewheel event bubble prevention\r\n */\r\nexport enum ScrollPreventionMode {\r\n  /**\r\n   * Do not prevent any page scrolling\r\n   */\r\n  None,\r\n  /**\r\n   * Prevent page scroll if mouse is over the game canvas\r\n   */\r\n  Canvas,\r\n  /**\r\n   * Prevent all page scrolling via mouse wheel\r\n   */\r\n  All\r\n}\r\n\r\n/**\r\n * Defines the available options to configure the Excalibur engine at constructor time.\r\n */\r\nexport interface EngineOptions<TKnownScenes extends string = any> {\r\n  /**\r\n   * Optionally configure the width of the viewport in css pixels\r\n   */\r\n  width?: number;\r\n\r\n  /**\r\n   * Optionally configure the height of the viewport in css pixels\r\n   */\r\n  height?: number;\r\n\r\n  /**\r\n   * Optionally configure the width & height of the viewport in css pixels.\r\n   * Use `viewport` instead of [[EngineOptions.width]] and [[EngineOptions.height]], or vice versa.\r\n   */\r\n  viewport?: ViewportDimension;\r\n\r\n  /**\r\n   * Optionally specify the size the logical pixel resolution, if not specified it will be width x height.\r\n   * See [[Resolution]] for common presets.\r\n   */\r\n  resolution?: Resolution;\r\n\r\n  /**\r\n   * Optionally specify antialiasing (smoothing), by default true (smooth pixels)\r\n   *\r\n   *  * `true` - useful for high resolution art work you would like smoothed, this also hints excalibur to load images\r\n   * with default blending [[ImageFiltering.Blended]]\r\n   *\r\n   *  * `false` - useful for pixel art style art work you would like sharp, this also hints excalibur to load images\r\n   * with default blending [[ImageFiltering.Pixel]]\r\n   *\r\n   * * [[AntialiasOptions]] Optionally deeply configure the different antialiasing settings, **WARNING** thar be dragons here.\r\n   * It is recommended you stick to `true` or `false` unless you understand what you're doing and need to control rendering to\r\n   * a high degree.\r\n   */\r\n  antialiasing?: boolean | AntialiasOptions\r\n\r\n  /**\r\n   * Quick convenience property to configure Excalibur to use special settings for \"pretty\" anti-aliased pixel art\r\n   *\r\n   * 1. Turns on special shader condition to blend for pixel art and enables various antialiasing settings,\r\n   *  notice blending is ON for this special mode.\r\n   *\r\n   * Equivalent to:\r\n   * ```javascript\r\n   * antialiasing: {\r\n   *  pixelArtSampler: true,\r\n   *  canvasImageRendering: 'auto',\r\n   *  filtering: ImageFiltering.Blended,\r\n   *  webglAntialiasing: true\r\n   * }\r\n   * ```\r\n   */\r\n  pixelArt?: boolean;\r\n\r\n  /**\r\n   * Specify any UV padding you want use in pixels, this brings sampling into the texture if you're using\r\n   * a sprite sheet in one image to prevent sampling bleed.\r\n   *\r\n   * Defaults:\r\n   * * `antialiasing: false` or `filtering: ImageFiltering.Pixel` - 0.0;\r\n   * * `pixelArt: true` - 0.25\r\n   * * All else 0.01\r\n   */\r\n  uvPadding?: number;\r\n\r\n  /**\r\n   * Optionally hint the graphics context into a specific power profile\r\n   *\r\n   * Default \"high-performance\"\r\n   */\r\n  powerPreference?: 'default' | 'high-performance' | 'low-power';\r\n\r\n  /**\r\n   * Optionally upscale the number of pixels in the canvas. Normally only useful if you need a smoother look to your assets, especially\r\n   * [[Text]] or Pixel Art assets.\r\n   *\r\n   * **WARNING** It is recommended you try using `antialiasing: true` before adjusting pixel ratio. Pixel ratio will consume more memory\r\n   * and on mobile may break if the internal size of the canvas exceeds 4k pixels in width or height.\r\n   *\r\n   * Default is based the display's pixel ratio, for example a HiDPI screen might have the value 2;\r\n   */\r\n  pixelRatio?: number;\r\n\r\n  /**\r\n   * Optionally configure the native canvas transparent backdrop\r\n   */\r\n  enableCanvasTransparency?: boolean;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element to render the game in\r\n   */\r\n  canvasElementId?: string;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element directly\r\n   */\r\n  canvasElement?: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Optionally snap graphics to nearest pixel, default is false\r\n   */\r\n  snapToPixel?: boolean;\r\n\r\n  /**\r\n   * The [[DisplayMode]] of the game, by default [[DisplayMode.FitScreen]] with aspect ratio 4:3 (800x600).\r\n   * Depending on this value, [[width]] and [[height]] may be ignored.\r\n   */\r\n  displayMode?: DisplayMode;\r\n\r\n  /**\r\n   * Configures the pointer scope. Pointers scoped to the 'Canvas' can only fire events within the canvas viewport; whereas, 'Document'\r\n   * (default) scoped will fire anywhere on the page.\r\n   */\r\n  pointerScope?: PointerScope;\r\n\r\n  /**\r\n   * Suppress boot up console message, which contains the \"powered by Excalibur message\"\r\n   */\r\n  suppressConsoleBootMessage?: boolean;\r\n\r\n  /**\r\n   * Suppress minimum browser feature detection, it is not recommended users of excalibur switch this off. This feature ensures that\r\n   * the currently running browser meets the minimum requirements for running excalibur. This can be useful if running on non-standard\r\n   * browsers or if there is a bug in excalibur preventing execution.\r\n   */\r\n  suppressMinimumBrowserFeatureDetection?: boolean;\r\n\r\n  /**\r\n   * Suppress HiDPI auto detection and scaling, it is not recommended users of excalibur switch off this feature. This feature detects\r\n   * and scales the drawing canvas appropriately to accommodate HiDPI screens.\r\n   */\r\n  suppressHiDPIScaling?: boolean;\r\n\r\n  /**\r\n   * Suppress play button, it is not recommended users of excalibur switch this feature. Some browsers require a user gesture (like a click)\r\n   * for certain browser features to work like web audio.\r\n   */\r\n  suppressPlayButton?: boolean;\r\n\r\n  /**\r\n   * Sets the focus of the window, this is needed when hosting excalibur in a cross-origin iframe in order for certain events\r\n   * (like keyboard) to work.\r\n   * For example: itch.io or codesandbox.io\r\n   *\r\n   * By default set to true,\r\n   */\r\n  grabWindowFocus?: boolean;\r\n\r\n  /**\r\n   * Scroll prevention method.\r\n   */\r\n  scrollPreventionMode?: ScrollPreventionMode;\r\n\r\n  /**\r\n   * Optionally set the background color\r\n   */\r\n  backgroundColor?: Color;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  maxFps?: number;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desireable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   */\r\n  fixedUpdateFps?: number;\r\n\r\n  /**\r\n   * Default `true`, optionally configure excalibur to use optimal draw call sorting, to opt out set this to `false`.\r\n   *\r\n   * Excalibur will automatically sort draw calls by z and priority into renderer batches for maximal draw performance,\r\n   * this can disrupt a specific desired painter order.\r\n   */\r\n  useDrawSorting?: boolean;\r\n\r\n  /**\r\n   * Optionally provide a custom handler for the webgl context lost event\r\n   */\r\n  handleContextLost?: (e: Event) => void;\r\n\r\n  /**\r\n   * Optionally provide a custom handler for the webgl context restored event\r\n   */\r\n  handleContextRestored?: (e: Event) => void;\r\n\r\n  /**\r\n   * Optionally configure how excalibur handles poor performance on a player's browser\r\n   */\r\n  configurePerformanceCanvas2DFallback?: {\r\n    /**\r\n     * By default `false`, this will switch the internal graphics context to Canvas2D which can improve performance on non hardware\r\n     * accelerated browsers.\r\n     */\r\n    allow: boolean;\r\n    /**\r\n     * By default `false`, if set to `true` a dialogue will be presented to the player about their browser and how to potentially\r\n     * address any issues.\r\n     */\r\n    showPlayerMessage?: boolean;\r\n    /**\r\n     * Default `{ numberOfFrames: 100, fps: 20 }`, optionally configure excalibur to fallback to the 2D Canvas renderer\r\n     * if bad performance is detected.\r\n     *\r\n     * In this example of the default if excalibur is running at 20fps or less for 100 frames it will trigger the fallback to the 2D\r\n     * Canvas renderer.\r\n     */\r\n    threshold?: { numberOfFrames: number, fps: number };\r\n  },\r\n\r\n  /**\r\n   * Optionally configure the physics simulation in excalibur\r\n   *\r\n   * If false, Excalibur will not produce a physics simulation.\r\n   *\r\n   * Default is configured to use [[SolverStrategy.Arcade]] physics simulation\r\n   */\r\n  physics?: boolean | PhysicsConfig\r\n\r\n  /**\r\n   * Optionally specify scenes with their transitions and loaders to excalibur's scene [[Director]]\r\n   *\r\n   * Scene transitions can can overridden dynamically by the `Scene` or by the call to `.goToScene`\r\n   */\r\n  scenes?: SceneMap<TKnownScenes>\r\n}\r\n\r\n/**\r\n * The Excalibur Engine\r\n *\r\n * The [[Engine]] is the main driver for a game. It is responsible for\r\n * starting/stopping the game, maintaining state, transmitting events,\r\n * loading resources, and managing the scene.\r\n */\r\nexport class Engine<TKnownScenes extends string = any> implements CanInitialize, CanUpdate, CanDraw {\r\n  static Context: Context<Engine | null> = createContext<Engine | null>();\r\n  static useEngine(): Engine {\r\n    const value = useContext(Engine.Context);\r\n\r\n    if (!value) {\r\n      throw new Error('Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.');\r\n    }\r\n\r\n    return value;\r\n  }\r\n  static InstanceCount = 0;\r\n\r\n  /**\r\n   * Anything run under scope can use `useEngine()` to inject the current engine\r\n   * @param cb\r\n   */\r\n  scope = <TReturn>(cb: () => TReturn) => Engine.Context.scope(this, cb);\r\n\r\n  /**\r\n   * Current Excalibur version string\r\n   *\r\n   * Useful for plugins or other tools that need to know what features are available\r\n   */\r\n  public readonly version = EX_VERSION;\r\n\r\n  /**\r\n   * Listen to and emit events on the Engine\r\n   */\r\n  public events = new EventEmitter<EngineEvents>();\r\n\r\n  /**\r\n   * Excalibur browser events abstraction used for wiring to native browser events safely\r\n   */\r\n  public browser: BrowserEvents;\r\n\r\n  /**\r\n   * Screen abstraction\r\n   */\r\n  public screen: Screen;\r\n\r\n  /**\r\n   * Scene director, manages all scenes, scene transitions, and loaders in excalibur\r\n   */\r\n  public director: Director<TKnownScenes>;\r\n\r\n  /**\r\n   * Direct access to the engine's canvas element\r\n   */\r\n  public canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Direct access to the ExcaliburGraphicsContext used for drawing things to the screen\r\n   */\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Direct access to the canvas element ID, if an ID exists\r\n   */\r\n  public canvasElementId: string;\r\n\r\n  /**\r\n   * Direct access to the physics configuration for excalibur\r\n   */\r\n  public physics: DeepRequired<PhysicsConfig>;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  public maxFps: number = Number.POSITIVE_INFINITY;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desireable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   */\r\n  public fixedUpdateFps?: number;\r\n\r\n  /**\r\n   * Direct access to the excalibur clock\r\n   */\r\n  public clock: Clock;\r\n\r\n  public readonly pointerScope: PointerScope;\r\n  public readonly grabWindowFocus: boolean;\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.screen.canvasWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.screen.halfCanvasWidth;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.screen.canvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.screen.halfCanvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    return this.screen.drawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.screen.halfDrawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    return this.screen.drawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.screen.halfDrawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns whether excalibur detects the current screen to be HiDPI\r\n   */\r\n  public get isHiDpi(): boolean {\r\n    return this.screen.isHiDpi;\r\n  }\r\n\r\n  /**\r\n   * Access engine input like pointer, keyboard, or gamepad\r\n   */\r\n  public input: InputHost;\r\n\r\n  /**\r\n   * Map multiple input sources to specific game actions actions\r\n   */\r\n  public inputMapper: InputMapper;\r\n\r\n  private _inputEnabled: boolean = true;\r\n\r\n  /**\r\n   * Access Excalibur debugging functionality.\r\n   *\r\n   * Useful when you want to debug different aspects of built in engine features like\r\n   *   * Transform\r\n   *   * Graphics\r\n   *   * Colliders\r\n   */\r\n  public debug: DebugConfig;\r\n\r\n  /**\r\n   * Access [[stats]] that holds frame statistics.\r\n   */\r\n  public get stats(): DebugStats {\r\n    return this.debug.stats;\r\n  }\r\n\r\n  /**\r\n   * The current [[Scene]] being drawn and updated on screen\r\n   */\r\n  public get currentScene(): Scene {\r\n    return this.director.currentScene;\r\n  }\r\n\r\n\r\n  /**\r\n   * The current [[Scene]] being drawn and updated on screen\r\n   */\r\n  public get currentSceneName(): string {\r\n    return this.director.currentSceneName;\r\n  }\r\n\r\n  /**\r\n   * The default [[Scene]] of the game, use [[Engine.goToScene]] to transition to different scenes.\r\n   */\r\n  public get rootScene(): Scene {\r\n    return this.director.rootScene;\r\n  }\r\n\r\n  /**\r\n   * Contains all the scenes currently registered with Excalibur\r\n   */\r\n  public get scenes(): { [key: string]: Scene | SceneConstructor | SceneWithOptions } {\r\n    return this.director.scenes;\r\n  };\r\n\r\n  /**\r\n   * Indicates whether the engine is set to fullscreen or not\r\n   */\r\n  public get isFullscreen(): boolean {\r\n    return this.screen.isFullScreen;\r\n  }\r\n\r\n  /**\r\n   * Indicates the current [[DisplayMode]] of the engine.\r\n   */\r\n  public get displayMode(): DisplayMode {\r\n    return this.screen.displayMode;\r\n  }\r\n\r\n  private _suppressPlayButton: boolean = false;\r\n  /**\r\n   * Returns the calculated pixel ration for use in rendering\r\n   */\r\n  public get pixelRatio(): number {\r\n    return this.screen.pixelRatio;\r\n  }\r\n\r\n  /**\r\n   * Indicates whether audio should be paused when the game is no longer visible.\r\n   */\r\n  public pauseAudioWhenHidden: boolean = true;\r\n\r\n  /**\r\n   * Indicates whether the engine should draw with debug information\r\n   */\r\n  private _isDebug: boolean = false;\r\n  public get isDebug(): boolean {\r\n    return this._isDebug;\r\n  }\r\n\r\n  /**\r\n   * Sets the background color for the engine.\r\n   */\r\n  public backgroundColor: Color;\r\n\r\n  /**\r\n   * Sets the Transparency for the engine.\r\n   */\r\n  public enableCanvasTransparency: boolean = true;\r\n\r\n  /**\r\n   * Hints the graphics context to truncate fractional world space coordinates\r\n   */\r\n  public get snapToPixel(): boolean {\r\n    return this.graphicsContext.snapToPixel;\r\n  };\r\n\r\n  public set snapToPixel(shouldSnapToPixel: boolean) {\r\n    this.graphicsContext.snapToPixel = shouldSnapToPixel;\r\n  };\r\n\r\n  /**\r\n   * The action to take when a fatal exception is thrown\r\n   */\r\n  public onFatalException = (e: any) => {\r\n    Logger.getInstance().fatal(e, e.stack);\r\n  };\r\n\r\n  /**\r\n   * The mouse wheel scroll prevention mode\r\n   */\r\n  public pageScrollPreventionMode: ScrollPreventionMode;\r\n\r\n  private _logger: Logger;\r\n\r\n  private _toaster: Toaster = new Toaster();\r\n\r\n  // this determines whether excalibur is compatible with your browser\r\n  private _compatible: boolean;\r\n\r\n  private _timescale: number = 1.0;\r\n\r\n  // loading\r\n  private _loader: DefaultLoader;\r\n\r\n  private _isInitialized: boolean = false;\r\n\r\n  public emit<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, event: EngineEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Default [[EngineOptions]]\r\n   */\r\n  private static _DEFAULT_ENGINE_OPTIONS: EngineOptions = {\r\n    width: 0,\r\n    height: 0,\r\n    enableCanvasTransparency: true,\r\n    useDrawSorting: true,\r\n    configurePerformanceCanvas2DFallback: {\r\n      allow: false,\r\n      showPlayerMessage: false,\r\n      threshold: { fps: 20, numberOfFrames: 100 }\r\n    },\r\n    canvasElementId: '',\r\n    canvasElement: undefined,\r\n    snapToPixel: false,\r\n    antialiasing: true,\r\n    pixelArt: false,\r\n    powerPreference: 'high-performance',\r\n    pointerScope: PointerScope.Canvas,\r\n    suppressConsoleBootMessage: null,\r\n    suppressMinimumBrowserFeatureDetection: null,\r\n    suppressHiDPIScaling: null,\r\n    suppressPlayButton: null,\r\n    grabWindowFocus: true,\r\n    scrollPreventionMode: ScrollPreventionMode.Canvas,\r\n    backgroundColor: Color.fromHex('#2185d0') // Excalibur blue\r\n  };\r\n\r\n  private _originalOptions: EngineOptions = {};\r\n  public readonly _originalDisplayMode: DisplayMode;\r\n\r\n  /**\r\n   * Creates a new game using the given [[EngineOptions]]. By default, if no options are provided,\r\n   * the game will be rendered full screen (taking up all available browser window space).\r\n   * You can customize the game rendering through [[EngineOptions]].\r\n   *\r\n   * Example:\r\n   *\r\n   * ```js\r\n   * var game = new ex.Engine({\r\n   *   width: 0, // the width of the canvas\r\n   *   height: 0, // the height of the canvas\r\n   *   enableCanvasTransparency: true, // the transparencySection of the canvas\r\n   *   canvasElementId: '', // the DOM canvas element ID, if you are providing your own\r\n   *   displayMode: ex.DisplayMode.FullScreen, // the display mode\r\n   *   pointerScope: ex.PointerScope.Document, // the scope of capturing pointer (mouse/touch) events\r\n   *   backgroundColor: ex.Color.fromHex('#2185d0') // background color of the engine\r\n   * });\r\n   *\r\n   * // call game.start, which is a Promise\r\n   * game.start().then(function () {\r\n   *   // ready, set, go!\r\n   * });\r\n   * ```\r\n   */\r\n  constructor(options?: EngineOptions<TKnownScenes>) {\r\n    options = { ...Engine._DEFAULT_ENGINE_OPTIONS, ...options };\r\n    this._originalOptions = options;\r\n\r\n    Flags.freeze();\r\n\r\n    // Initialize browser events facade\r\n    this.browser = new BrowserEvents(window, document);\r\n\r\n    // Check compatibility\r\n    const detector = new Detector();\r\n    if (!options.suppressMinimumBrowserFeatureDetection && !(this._compatible = detector.test())) {\r\n      const message = document.createElement('div');\r\n      message.innerText = 'Sorry, your browser does not support all the features needed for Excalibur';\r\n      document.body.appendChild(message);\r\n\r\n      detector.failedTests.forEach(function (test) {\r\n        const testMessage = document.createElement('div');\r\n        testMessage.innerText = 'Browser feature missing ' + test;\r\n        document.body.appendChild(testMessage);\r\n      });\r\n\r\n      if (options.canvasElementId) {\r\n        const canvas = document.getElementById(options.canvasElementId);\r\n        if (canvas) {\r\n          canvas.parentElement.removeChild(canvas);\r\n        }\r\n      }\r\n\r\n      return;\r\n    } else {\r\n      this._compatible = true;\r\n    }\r\n\r\n    // Use native console API for color fun\r\n    // eslint-disable-next-line no-console\r\n    if (console.log && !options.suppressConsoleBootMessage) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `%cPowered by Excalibur.js (v${EX_VERSION})`,\r\n        'background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;'\r\n      );\r\n      // eslint-disable-next-line no-console\r\n      console.log('\\n\\\r\n      /| ________________\\n\\\r\nO|===|* >________________>\\n\\\r\n      \\\\|');\r\n      // eslint-disable-next-line no-console\r\n      console.log('Visit', 'http://excaliburjs.com', 'for more information');\r\n    }\r\n\r\n    // Suppress play button\r\n    if (options.suppressPlayButton) {\r\n      this._suppressPlayButton = true;\r\n    }\r\n\r\n    this._logger = Logger.getInstance();\r\n\r\n    // If debug is enabled, let's log browser features to the console.\r\n    if (this._logger.defaultLevel === LogLevel.Debug) {\r\n      detector.logBrowserFeatures();\r\n    }\r\n\r\n    this._logger.debug('Building engine...');\r\n\r\n    this.canvasElementId = options.canvasElementId;\r\n\r\n    if (options.canvasElementId) {\r\n      this._logger.debug('Using Canvas element specified: ' + options.canvasElementId);\r\n\r\n      //test for existence of element\r\n      if (document.getElementById(options.canvasElementId) === null)  {\r\n        throw new Error('Cannot find existing element in the DOM, please ensure element is created prior to engine creation.');\r\n      }\r\n\r\n      this.canvas = <HTMLCanvasElement>document.getElementById(options.canvasElementId);\r\n    } else if (options.canvasElement) {\r\n      this._logger.debug('Using Canvas element specified:', options.canvasElement);\r\n      this.canvas = options.canvasElement;\r\n    } else {\r\n      this._logger.debug('Using generated canvas element');\r\n      this.canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    }\r\n\r\n    let displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    if ((options.width && options.height) || options.viewport) {\r\n      if (options.displayMode === undefined) {\r\n        displayMode = DisplayMode.Fixed;\r\n      }\r\n      this._logger.debug('Engine viewport is size ' + options.width + ' x ' + options.height);\r\n    } else if (!options.displayMode) {\r\n      this._logger.debug('Engine viewport is fit');\r\n      displayMode = DisplayMode.FitScreen;\r\n    }\r\n\r\n    this._originalDisplayMode = displayMode;\r\n\r\n    let pixelArtSampler: boolean;\r\n    let uvPadding: number;\r\n    let nativeContextAntialiasing: boolean;\r\n    let canvasImageRendering: 'pixelated' | 'auto';\r\n    let filtering: ImageFiltering;\r\n    let multiSampleAntialiasing: boolean | { samples: number };\r\n    if (typeof options.antialiasing === 'object') {\r\n      ({\r\n        pixelArtSampler,\r\n        nativeContextAntialiasing,\r\n        multiSampleAntialiasing,\r\n        filtering,\r\n        canvasImageRendering\r\n      } = {\r\n        ...(options.pixelArt ? DefaultPixelArtOptions : DefaultAntialiasOptions),\r\n        ...options.antialiasing\r\n      });\r\n\r\n    } else {\r\n      pixelArtSampler = !!options.pixelArt;\r\n      nativeContextAntialiasing = false;\r\n      multiSampleAntialiasing = options.antialiasing;\r\n      canvasImageRendering = options.antialiasing ? 'auto' : 'pixelated';\r\n      filtering = options.antialiasing ? ImageFiltering.Blended : ImageFiltering.Pixel;\r\n    }\r\n\r\n    if (nativeContextAntialiasing && multiSampleAntialiasing) {\r\n      this._logger.warnOnce(`Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing` +\r\n      ` at the same time, they are incompatible settings. If you aren\\'t sure use multiSampleAntialiasing`);\r\n    }\r\n\r\n    if (options.pixelArt) {\r\n      uvPadding = .25;\r\n    }\r\n\r\n    if (!options.antialiasing || filtering === ImageFiltering.Pixel) {\r\n      uvPadding = 0;\r\n    }\r\n\r\n    // Override with any user option, if non default to .25 for pixel art, 0.01 for everything else\r\n    uvPadding = options.uvPadding ?? uvPadding ?? 0.01;\r\n\r\n    // Canvas 2D fallback can be flagged on\r\n    let useCanvasGraphicsContext = Flags.isEnabled('use-canvas-context');\r\n    if (!useCanvasGraphicsContext) {\r\n      // Attempt webgl first\r\n      try {\r\n        this.graphicsContext = new ExcaliburGraphicsContextWebGL({\r\n          canvasElement: this.canvas,\r\n          enableTransparency: this.enableCanvasTransparency,\r\n          pixelArtSampler: pixelArtSampler,\r\n          antialiasing: nativeContextAntialiasing,\r\n          multiSampleAntialiasing: multiSampleAntialiasing,\r\n          uvPadding: uvPadding,\r\n          powerPreference: options.powerPreference,\r\n          backgroundColor: options.backgroundColor,\r\n          snapToPixel: options.snapToPixel,\r\n          useDrawSorting: options.useDrawSorting,\r\n          handleContextLost: options.handleContextLost ?? this._handleWebGLContextLost,\r\n          handleContextRestored: options.handleContextRestored\r\n        });\r\n      } catch (e) {\r\n        this._logger.warn(\r\n          `Excalibur could not load webgl for some reason (${(e as Error).message}) and loaded a Canvas 2D fallback. ` +\r\n          `Some features of Excalibur will not work in this mode. \\n\\n` +\r\n          'Read more about this issue at https://excaliburjs.com/docs/performance'\r\n        );\r\n        // fallback to canvas in case of failure\r\n        useCanvasGraphicsContext = true;\r\n      }\r\n    }\r\n\r\n    if (useCanvasGraphicsContext) {\r\n      this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n        canvasElement: this.canvas,\r\n        enableTransparency: this.enableCanvasTransparency,\r\n        antialiasing: nativeContextAntialiasing,\r\n        backgroundColor: options.backgroundColor,\r\n        snapToPixel: options.snapToPixel,\r\n        useDrawSorting: options.useDrawSorting\r\n      });\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: nativeContextAntialiasing,\r\n      canvasImageRendering: canvasImageRendering,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : (options.pixelRatio ?? null)\r\n    });\r\n\r\n    // TODO REMOVE STATIC!!!\r\n    // Set default filtering based on antialiasing\r\n    TextureLoader.filtering = filtering;\r\n\r\n    if (options.backgroundColor) {\r\n      this.backgroundColor = options.backgroundColor.clone();\r\n    }\r\n\r\n    this.grabWindowFocus = options.grabWindowFocus;\r\n    this.pointerScope = options.pointerScope;\r\n\r\n    this.maxFps = options.maxFps ?? this.maxFps;\r\n    this.fixedUpdateFps = options.fixedUpdateFps ?? this.fixedUpdateFps;\r\n\r\n    this.clock = new StandardClock({\r\n      maxFps: this.maxFps,\r\n      tick: this._mainloop.bind(this),\r\n      onFatalException: (e) => this.onFatalException(e)\r\n    });\r\n\r\n    this.enableCanvasTransparency = options.enableCanvasTransparency;\r\n\r\n    if (typeof options.physics === 'boolean') {\r\n      this.physics = {\r\n        ...DefaultPhysicsConfig,\r\n        ...DeprecatedStaticToConfig(),\r\n        enabled: options.physics\r\n      };\r\n    } else {\r\n      this.physics = {\r\n        ...DefaultPhysicsConfig,\r\n        ...DeprecatedStaticToConfig(),\r\n        ...options.physics as DeepRequired<PhysicsConfig>\r\n      };\r\n    }\r\n\r\n    this.debug = new DebugConfig(this);\r\n\r\n    this.director = new Director(this, options.scenes);\r\n\r\n    this._initialize(options);\r\n\r\n    (window as any).___EXCALIBUR_DEVTOOL = this;\r\n    Engine.InstanceCount++;\r\n  }\r\n\r\n  private _handleWebGLContextLost = (e: Event) => {\r\n    e.preventDefault();\r\n    this.clock.stop();\r\n    this._logger.fatalOnce('WebGL Graphics Lost', e);\r\n    const container = document.createElement('div');\r\n    container.id = 'ex-webgl-graphics-context-lost';\r\n    container.style.position = 'absolute';\r\n    container.style.zIndex = '99';\r\n    container.style.left = '50%';\r\n    container.style.top = '50%';\r\n    container.style.display = 'flex';\r\n    container.style.flexDirection = 'column';\r\n    container.style.transform = 'translate(-50%, -50%)';\r\n    container.style.backgroundColor = 'white';\r\n    container.style.padding = '10px';\r\n    container.style.borderStyle = 'solid 1px';\r\n\r\n    const div = document.createElement('div');\r\n    div.innerHTML = `\r\n      <h1>There was an issue rendering, please refresh the page.</h1>\r\n      <div>\r\n        <p>WebGL Graphics Context Lost</p>\r\n\r\n        <button id=\"ex-webgl-graphics-reload\">Refresh Page</button>\r\n\r\n        <p>There are a few reasons this might happen:</p>\r\n        <ul>\r\n          <li>Two or more pages are placing a high demand on the GPU</li>\r\n          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>\r\n          <li>The computer has multiple GPUs and the user has switched between them</li>\r\n          <li>Graphics driver has crashed or restarted</li>\r\n          <li>Graphics driver was updated</li>\r\n        </ul>\r\n      </div>\r\n    `;\r\n    container.appendChild(div);\r\n    if (this.canvas?.parentElement) {\r\n      this.canvas.parentElement.appendChild(container);\r\n      const button = div.querySelector('#ex-webgl-graphics-reload');\r\n      button?.addEventListener('click', () => location.reload());\r\n    }\r\n  };\r\n\r\n  private _performanceThresholdTriggered = false;\r\n  private _fpsSamples: number[] = [];\r\n  private _monitorPerformanceThresholdAndTriggerFallback() {\r\n    const { allow } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    let { threshold, showPlayerMessage } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    if (threshold === undefined) {\r\n      threshold = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold;\r\n    }\r\n    if (showPlayerMessage === undefined) {\r\n      showPlayerMessage = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage;\r\n    }\r\n    if (!Flags.isEnabled('use-canvas-context') && allow && this.ready && !this._performanceThresholdTriggered) {\r\n      // Calculate Average fps for last X number of frames after start\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        this._fpsSamples.splice(0, 1);\r\n      }\r\n      this._fpsSamples.push(this.clock.fpsSampler.fps);\r\n      let total = 0;\r\n      for (let i = 0; i < this._fpsSamples.length; i++) {\r\n        total += this._fpsSamples[i];\r\n      }\r\n      const average = total / this._fpsSamples.length;\r\n\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        if (average <= threshold.fps) {\r\n          this._performanceThresholdTriggered = true;\r\n          this._logger.warn(\r\n            `Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.\\n` +\r\n            'this might mean your browser doesn\\'t have webgl enabled or hardware acceleration is unavailable.\\n\\n' +\r\n            'If in Chrome:\\n' +\r\n            '  * Visit Settings > Advanced > System, and ensure \"Use Hardware Acceleration\" is checked.\\n'+\r\n            '  * Visit chrome://flags/#ignore-gpu-blocklist and ensure \"Override software rendering list\" is \"enabled\"\\n' +\r\n            'If in Firefox, visit about:config\\n' +\r\n            '  * Ensure webgl.disabled = false\\n' +\r\n            '  * Ensure webgl.force-enabled = true\\n' +\r\n            '  * Ensure layers.acceleration.force-enabled = true\\n\\n' +\r\n            'Read more about this issue at https://excaliburjs.com/docs/performance'\r\n          );\r\n\r\n          if (showPlayerMessage) {\r\n            this._toaster.toast(\r\n              'Excalibur is encountering performance issues. '+\r\n              'It\\'s possible that your browser doesn\\'t have hardware acceleration enabled. ' +\r\n              'Visit [LINK] for more information and potential solutions.',\r\n              'https://excaliburjs.com/docs/performance'\r\n            );\r\n          }\r\n          this.useCanvas2DFallback();\r\n          this.emit('fallbackgraphicscontext', this.graphicsContext);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Switches the engine's graphics context to the 2D Canvas.\r\n   * @warning Some features of Excalibur will not work in this mode.\r\n   */\r\n  public useCanvas2DFallback() {\r\n    // Swap out the canvas\r\n    const newCanvas = this.canvas.cloneNode(false) as HTMLCanvasElement;\r\n    this.canvas.parentNode.replaceChild(newCanvas, this.canvas);\r\n    this.canvas = newCanvas;\r\n\r\n    const options = { ...this._originalOptions, antialiasing: this.getAntialiasing() };\r\n    const displayMode = this._originalDisplayMode;\r\n\r\n    // New graphics context\r\n    this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n      canvasElement: this.canvas,\r\n      enableTransparency: this.enableCanvasTransparency,\r\n      antialiasing: options.antialiasing,\r\n      backgroundColor: options.backgroundColor,\r\n      snapToPixel: options.snapToPixel,\r\n      useDrawSorting: options.useDrawSorting\r\n    });\r\n\r\n    // Reset screen\r\n    if (this.screen) {\r\n      this.screen.dispose();\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: options.antialiasing ?? true,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : (options.pixelRatio ?? null)\r\n    });\r\n    this.screen.setCurrentCamera(this.currentScene.camera);\r\n\r\n    // Reset pointers\r\n    this.input.pointers.detach();\r\n    const pointerTarget = options && options.pointerScope === PointerScope.Document ? document : this.canvas;\r\n    this.input.pointers = this.input.pointers.recreate(pointerTarget, this);\r\n    this.input.pointers.init();\r\n  }\r\n\r\n  private _disposed = false;\r\n  /**\r\n   * Attempts to completely clean up excalibur resources, including removing the canvas from the dom.\r\n   *\r\n   * To start again you will need to new up an Engine.\r\n   */\r\n  public dispose() {\r\n    if (!this._disposed) {\r\n      this._disposed = true;\r\n      this.stop();\r\n      this.input.toggleEnabled(false);\r\n      this.canvas.parentNode.removeChild(this.canvas);\r\n      this.canvas = null;\r\n      this.screen.dispose();\r\n      this.graphicsContext.dispose();\r\n      this.graphicsContext = null;\r\n      Engine.InstanceCount--;\r\n    }\r\n  }\r\n\r\n  public isDisposed() {\r\n    return this._disposed;\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   */\r\n  public getWorldBounds() {\r\n    return this.screen.getWorldBounds();\r\n  }\r\n\r\n  /**\r\n   * Gets the current engine timescale factor (default is 1.0 which is 1:1 time)\r\n   */\r\n  public get timescale() {\r\n    return this._timescale;\r\n  }\r\n\r\n  /**\r\n   * Sets the current engine timescale factor. Useful for creating slow-motion effects or fast-forward effects\r\n   * when using time-based movement.\r\n   */\r\n  public set timescale(value: number) {\r\n    if (value <= 0) {\r\n      Logger.getInstance().error('Cannot set engine.timescale to a value of 0 or less than 0.');\r\n      return;\r\n    }\r\n\r\n    this._timescale = value;\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Timer]] to the [[currentScene]].\r\n   * @param timer  The timer to add to the [[currentScene]].\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    return this.currentScene.addTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Timer]] from the [[currentScene]].\r\n   * @param timer  The timer to remove to the [[currentScene]].\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    return this.currentScene.removeTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Scene]] to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   * @param key  The name of the scene, must be unique\r\n   * @param scene The scene to add to the engine\r\n   */\r\n  public addScene<TScene extends string>(key: TScene, scene: Scene | SceneConstructor | SceneWithOptions): Engine<TKnownScenes | TScene> {\r\n    this.director.add(key, scene);\r\n    return this as Engine<TKnownScenes | TScene>;\r\n  }\r\n\r\n  /**\r\n   * Removes a [[Scene]] instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public removeScene(scene: Scene | SceneConstructor): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param key  The scene key to remove\r\n   */\r\n  public removeScene(key: string): void;\r\n  /**\r\n   * @internal\r\n   */\r\n  public removeScene(entity: any): void {\r\n    this.director.remove(entity);\r\n  }\r\n\r\n  /**\r\n   * Adds a [[Scene]] to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   * @param sceneKey  The key of the scene, must be unique\r\n   * @param scene     The scene to add to the engine\r\n   */\r\n  public add(sceneKey: string, scene: Scene | SceneConstructor | SceneWithOptions): void;\r\n  /**\r\n   * Adds a [[Timer]] to the [[currentScene]].\r\n   * @param timer  The timer to add to the [[currentScene]].\r\n   */\r\n  public add(timer: Timer): void;\r\n  /**\r\n   * Adds a [[TileMap]] to the [[currentScene]], once this is done the TileMap\r\n   * will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n  /**\r\n   * Adds an actor to the [[currentScene]] of the game. This is synonymous\r\n   * to calling `engine.currentScene.add(actor)`.\r\n   *\r\n   * Actors can only be drawn if they are a member of a scene, and only\r\n   * the [[currentScene]] may be drawn or updated.\r\n   * @param actor  The actor to add to the [[currentScene]]\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a [[ScreenElement]] to the [[currentScene]] of the game,\r\n   * ScreenElements do not participate in collisions, instead the\r\n   * remain in the same place on the screen.\r\n   * @param screenElement  The ScreenElement to add to the [[currentScene]]\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    if (arguments.length === 2) {\r\n      this.director.add(<string>arguments[0], <Scene | SceneConstructor | SceneWithOptions>arguments[1]);\r\n      return;\r\n    }\r\n    const maybeDeferred = this.director.getDeferredScene();\r\n    if (maybeDeferred instanceof Scene) {\r\n      maybeDeferred.add(entity);\r\n    } else {\r\n      this.currentScene.add(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a scene instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public remove(scene: Scene | SceneConstructor): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param sceneKey  The scene to remove\r\n   */\r\n  public remove(sceneKey: string): void;\r\n  /**\r\n   * Removes a [[Timer]] from the [[currentScene]].\r\n   * @param timer  The timer to remove to the [[currentScene]].\r\n   */\r\n  public remove(timer: Timer): void;\r\n  /**\r\n   * Removes a [[TileMap]] from the [[currentScene]], it will no longer be drawn or updated.\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n  /**\r\n   * Removes an actor from the [[currentScene]] of the game. This is synonymous\r\n   * to calling `engine.currentScene.removeChild(actor)`.\r\n   * Actors that are removed from a scene will no longer be drawn or updated.\r\n   * @param actor  The actor to remove from the [[currentScene]].\r\n   */\r\n  public remove(actor: Actor): void;\r\n  /**\r\n   * Removes a [[ScreenElement]] to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the [[currentScene]]\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    if (entity instanceof Entity) {\r\n      this.currentScene.remove(entity);\r\n    }\r\n\r\n    if (entity instanceof Scene || isSceneConstructor(entity)) {\r\n      this.removeScene(entity);\r\n    }\r\n\r\n    if (typeof entity === 'string') {\r\n      this.removeScene(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Changes the current scene with optionally supplied:\r\n   * * Activation data\r\n   * * Transitions\r\n   * * Loaders\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * game.goToScene('myScene', {\r\n   *   sceneActivationData: {any: 'thing at all'},\r\n   *   destinationIn: new FadeInOut({duration: 1000, direction: 'in'}),\r\n   *   sourceOut: new FadeInOut({duration: 1000, direction: 'out'}),\r\n   *   loader: MyLoader\r\n   * });\r\n   * ```\r\n   *\r\n   * Scenes are defined in the Engine constructor\r\n   * ```typescript\r\n   * const engine = new ex.Engine({\r\n      scenes: {...}\r\n    });\r\n   * ```\r\n   * Or by adding dynamically\r\n   *\r\n   * ```typescript\r\n   * engine.addScene('myScene', new ex.Scene());\r\n   * ```\r\n   * @param destinationScene\r\n   * @param options\r\n   * @deprecated use goToScene, it now behaves the same as goto\r\n   */\r\n  public async goto(destinationScene: WithRoot<TKnownScenes>, options?: GoToOptions) {\r\n    await this.scope(async () => {\r\n      await this.director.goto(destinationScene, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Changes the current scene with optionally supplied:\r\n   * * Activation data\r\n   * * Transitions\r\n   * * Loaders\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * game.goToScene('myScene', {\r\n   *   sceneActivationData: {any: 'thing at all'},\r\n   *   destinationIn: new FadeInOut({duration: 1000, direction: 'in'}),\r\n   *   sourceOut: new FadeInOut({duration: 1000, direction: 'out'}),\r\n   *   loader: MyLoader\r\n   * });\r\n   * ```\r\n   *\r\n   * Scenes are defined in the Engine constructor\r\n   * ```typescript\r\n   * const engine = new ex.Engine({\r\n      scenes: {...}\r\n    });\r\n   * ```\r\n   * Or by adding dynamically\r\n   *\r\n   * ```typescript\r\n   * engine.addScene('myScene', new ex.Scene());\r\n   * ```\r\n   * @param destinationScene\r\n   * @param options\r\n   */\r\n  public async goToScene<TData = undefined>(destinationScene: WithRoot<TKnownScenes>, options?: GoToOptions<TData>): Promise<void> {\r\n    await this.scope(async () => {\r\n      await this.director.goto(destinationScene, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Transforms the current x, y from screen coordinates to world coordinates\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    return this.screen.screenToWorldCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Transforms a world coordinate, to a screen coordinate\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    return this.screen.worldToScreenCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Initializes the internal canvas, rendering context, display mode, and native event listeners\r\n   */\r\n  private _initialize(options?: EngineOptions) {\r\n    this.pageScrollPreventionMode = options.scrollPreventionMode;\r\n\r\n    // initialize inputs\r\n    const pointerTarget = options && options.pointerScope === PointerScope.Document ? document : this.canvas;\r\n    const grabWindowFocus = this._originalOptions?.grabWindowFocus ?? true;\r\n    this.input = new InputHost({\r\n      pointerTarget,\r\n      grabWindowFocus,\r\n      engine: this\r\n    });\r\n    this.inputMapper = this.input.inputMapper;\r\n\r\n    // Issue #385 make use of the visibility api\r\n    // https://developer.mozilla.org/en-US/docs/Web/Guide/User_experience/Using_the_Page_Visibility_API\r\n\r\n    this.browser.document.on('visibilitychange', () => {\r\n      if (document.visibilityState === 'hidden') {\r\n        this.events.emit('hidden', new HiddenEvent(this));\r\n        this._logger.debug('Window hidden');\r\n      } else if (document.visibilityState === 'visible') {\r\n        this.events.emit('visible', new VisibleEvent(this));\r\n        this._logger.debug('Window visible');\r\n      }\r\n    });\r\n\r\n    if (!this.canvasElementId && !options.canvasElement) {\r\n      document.body.appendChild(this.canvas);\r\n    }\r\n  }\r\n\r\n  public toggleInputEnabled(enabled: boolean) {\r\n    this._inputEnabled = enabled;\r\n    this.input.toggleEnabled(this._inputEnabled);\r\n  }\r\n\r\n  public onInitialize(engine: Engine) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * If supported by the browser, this will set the antialiasing flag on the\r\n   * canvas. Set this to `false` if you want a 'jagged' pixel art look to your\r\n   * image resources.\r\n   * @param isSmooth  Set smoothing to true or false\r\n   * @deprecated Set in engine constructor, will be removed in v0.30\r\n   */\r\n  public setAntialiasing(isSmooth: boolean) {\r\n    this.screen.antialiasing = isSmooth;\r\n  }\r\n\r\n  /**\r\n   * Return the current smoothing status of the canvas\r\n   * @deprecated Set in engine constructor, will be removed in v0.30\r\n   */\r\n  public getAntialiasing(): boolean {\r\n    return this.screen.antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  private async _overrideInitialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      await this.director.onInitialize();\r\n      await this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the entire state of the game\r\n   * @param delta  Number of milliseconds elapsed since the last update.\r\n   */\r\n  private _update(delta: number) {\r\n    if (this._isLoading) {\r\n      // suspend updates until loading is finished\r\n      this._loader?.onUpdate(this, delta);\r\n      // Update input listeners\r\n      this.input.update();\r\n      return;\r\n    }\r\n\r\n    // Publish preupdate events\r\n    this.clock.__runScheduledCbs('preupdate');\r\n    this._preupdate(delta);\r\n\r\n    // process engine level events\r\n    this.currentScene.update(this, delta);\r\n\r\n    // Update graphics postprocessors\r\n    this.graphicsContext.updatePostProcessors(delta);\r\n\r\n    // Publish update event\r\n    this.clock.__runScheduledCbs('postupdate');\r\n    this._postupdate(delta);\r\n\r\n    // Update input listeners\r\n    this.input.update();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _preupdate(delta: number) {\r\n    this.emit('preupdate', new PreUpdateEvent(this, delta, this));\r\n    this.onPreUpdate(this, delta);\r\n  }\r\n\r\n  public onPreUpdate(engine: Engine, delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postupdate(delta: number) {\r\n    this.emit('postupdate', new PostUpdateEvent(this, delta, this));\r\n    this.onPostUpdate(this, delta);\r\n  }\r\n\r\n  public onPostUpdate(engine: Engine, delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Draws the entire game\r\n   * @param delta  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  private _draw(delta: number) {\r\n    this.graphicsContext.beginDrawLifecycle();\r\n    this.graphicsContext.clear();\r\n    this.clock.__runScheduledCbs('predraw');\r\n    this._predraw(this.graphicsContext, delta);\r\n\r\n    // Drawing nothing else while loading\r\n    if (this._isLoading) {\r\n      if (!this._hideLoader) {\r\n        this._loader?.canvas.draw(this.graphicsContext, 0, 0);\r\n        this.clock.__runScheduledCbs('postdraw');\r\n        this.graphicsContext.flush();\r\n        this.graphicsContext.endDrawLifecycle();\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Use scene background color if present, fallback to engine\r\n    this.graphicsContext.backgroundColor = this.currentScene.backgroundColor ?? this.backgroundColor;\r\n\r\n    this.currentScene.draw(this.graphicsContext, delta);\r\n\r\n    this.clock.__runScheduledCbs('postdraw');\r\n    this._postdraw(this.graphicsContext, delta);\r\n\r\n    // Flush any pending drawings\r\n    this.graphicsContext.flush();\r\n    this.graphicsContext.endDrawLifecycle();\r\n\r\n    this._checkForScreenShots();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _predraw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    this.emit('predraw', new PreDrawEvent(ctx, delta, this));\r\n    this.onPreDraw(ctx, delta);\r\n  }\r\n\r\n  public onPreDraw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postdraw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    this.emit('postdraw', new PostDrawEvent(ctx, delta, this));\r\n    this.onPostDraw(ctx, delta);\r\n  }\r\n\r\n  public onPostDraw(ctx: ExcaliburGraphicsContext, delta: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Enable or disable Excalibur debugging functionality.\r\n   * @param toggle a value that debug drawing will be changed to\r\n   */\r\n  public showDebug(toggle: boolean): void {\r\n    this._isDebug = toggle;\r\n  }\r\n\r\n  /**\r\n   * Toggle Excalibur debugging functionality.\r\n   */\r\n  public toggleDebug(): boolean {\r\n    this._isDebug = !this._isDebug;\r\n    return this._isDebug;\r\n  }\r\n\r\n  /**\r\n   * Returns true when loading is totally complete and the player has clicked start\r\n   */\r\n  public get loadingComplete() {\r\n    return !this._isLoading;\r\n  }\r\n\r\n  private _isLoading = false;\r\n  private _hideLoader = false;\r\n  private _isReadyFuture = new Future<void>();\r\n  public get ready() {\r\n    return this._isReadyFuture.isCompleted;\r\n  }\r\n  public isReady(): Promise<void> {\r\n    return this._isReadyFuture.promise;\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * Starts the internal game loop for Excalibur after loading\r\n   * any provided assets.\r\n   * @param loader  Optional [[Loader]] to use to load resources. The default loader is [[Loader]],\r\n   * override to provide your own custom loader.\r\n   *\r\n   * Note: start() only resolves AFTER the user has clicked the play button\r\n   */\r\n  public async start(loader?: DefaultLoader): Promise<void>;\r\n  /**\r\n   * Starts the internal game loop for Excalibur after configuring any routes, loaders, or transitions\r\n   * @param startOptions Optional [[StartOptions]] to configure the routes for scenes in Excalibur\r\n   *\r\n   * Note: start() only resolves AFTER the user has clicked the play button\r\n   */\r\n  public async start(sceneName: WithRoot<TKnownScenes>, options?: StartOptions): Promise<void>;\r\n  /**\r\n   * Starts the internal game loop after any loader is finished\r\n   * @param loader\r\n   */\r\n  public async start(loader?: DefaultLoader): Promise<void>;\r\n  public async start(sceneNameOrLoader?: WithRoot<TKnownScenes> | DefaultLoader, options?: StartOptions): Promise<void> {\r\n    await this.scope(async () => {\r\n      if (!this._compatible) {\r\n        throw new Error('Excalibur is incompatible with your browser');\r\n      }\r\n      this._isLoading = true;\r\n      let loader: DefaultLoader;\r\n      if (sceneNameOrLoader instanceof DefaultLoader) {\r\n        loader = sceneNameOrLoader;\r\n      } else if (typeof sceneNameOrLoader === 'string') {\r\n        this.director.configureStart(sceneNameOrLoader, options);\r\n        loader = this.director.mainLoader;\r\n      }\r\n\r\n      // Start the excalibur clock which drives the mainloop\r\n      this._logger.debug('Starting game clock...');\r\n      this.browser.resume();\r\n      this.clock.start();\r\n      this._logger.debug('Game clock started');\r\n\r\n      await this.load(loader ?? new Loader());\r\n\r\n      // Initialize before ready\r\n      await this._overrideInitialize(this);\r\n\r\n      this._isReadyFuture.resolve();\r\n      this.emit('start', new GameStartEvent(this));\r\n      return this._isReadyFuture.promise;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the current frames elapsed milliseconds\r\n   */\r\n  public currentFrameElapsedMs = 0;\r\n\r\n  /**\r\n   * Returns the current frame lag when in fixed update mode\r\n   */\r\n  public currentFrameLagMs = 0;\r\n\r\n  private _lagMs = 0;\r\n  private _mainloop(elapsed: number) {\r\n    this.scope(() => {\r\n      this.emit('preframe', new PreFrameEvent(this, this.stats.prevFrame));\r\n      const delta = elapsed * this.timescale;\r\n      this.currentFrameElapsedMs = delta;\r\n\r\n      // reset frame stats (reuse existing instances)\r\n      const frameId = this.stats.prevFrame.id + 1;\r\n      this.stats.currFrame.reset();\r\n      this.stats.currFrame.id = frameId;\r\n      this.stats.currFrame.delta = delta;\r\n      this.stats.currFrame.fps = this.clock.fpsSampler.fps;\r\n      GraphicsDiagnostics.clear();\r\n\r\n      const beforeUpdate = this.clock.now();\r\n      const fixedTimestepMs = 1000 / this.fixedUpdateFps;\r\n      if (this.fixedUpdateFps) {\r\n        this._lagMs += delta;\r\n        while (this._lagMs >= fixedTimestepMs) {\r\n          this._update(fixedTimestepMs);\r\n          this._lagMs -= fixedTimestepMs;\r\n        }\r\n      } else {\r\n        this._update(delta);\r\n      }\r\n      const afterUpdate = this.clock.now();\r\n      this.currentFrameLagMs = this._lagMs;\r\n      this._draw(delta);\r\n      const afterDraw = this.clock.now();\r\n\r\n      this.stats.currFrame.duration.update = afterUpdate - beforeUpdate;\r\n      this.stats.currFrame.duration.draw = afterDraw - afterUpdate;\r\n      this.stats.currFrame.graphics.drawnImages = GraphicsDiagnostics.DrawnImagesCount;\r\n      this.stats.currFrame.graphics.drawCalls = GraphicsDiagnostics.DrawCallCount;\r\n\r\n      this.emit('postframe', new PostFrameEvent(this, this.stats.currFrame));\r\n      this.stats.prevFrame.reset(this.stats.currFrame);\r\n\r\n      this._monitorPerformanceThresholdAndTriggerFallback();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stops Excalibur's main loop, useful for pausing the game.\r\n   */\r\n  public stop() {\r\n    if (this.clock.isRunning()) {\r\n      this.emit('stop', new GameStopEvent(this));\r\n      this.browser.pause();\r\n      this.clock.stop();\r\n      this._logger.debug('Game stopped');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the Engine's running status, Useful for checking whether engine is running or paused.\r\n   */\r\n  public isRunning() {\r\n    return this.clock.isRunning();\r\n  }\r\n\r\n\r\n  private _screenShotRequests: { preserveHiDPIResolution: boolean, resolve: (image: HTMLImageElement) => void }[] = [];\r\n  /**\r\n   * Takes a screen shot of the current viewport and returns it as an\r\n   * HTML Image Element.\r\n   * @param preserveHiDPIResolution in the case of HiDPI return the full scaled backing image, by default false\r\n   */\r\n  public screenshot(preserveHiDPIResolution = false): Promise<HTMLImageElement> {\r\n    const screenShotPromise = new Promise<HTMLImageElement>((resolve) => {\r\n      this._screenShotRequests.push({preserveHiDPIResolution, resolve});\r\n    });\r\n    return screenShotPromise;\r\n  }\r\n\r\n  private _checkForScreenShots() {\r\n    // We must grab the draw buffer before we yield to the browser\r\n    // the draw buffer is cleared after compositing\r\n    // the reason for the asynchrony is setting `preserveDrawingBuffer: true`\r\n    // forces the browser to copy buffers which can have a mass perf impact on mobile\r\n    for (const request of this._screenShotRequests) {\r\n      const finalWidth = request.preserveHiDPIResolution ? this.canvas.width : this.screen.resolution.width;\r\n      const finalHeight = request.preserveHiDPIResolution ? this.canvas.height : this.screen.resolution.height;\r\n      const screenshot = document.createElement('canvas');\r\n      screenshot.width = finalWidth;\r\n      screenshot.height = finalHeight;\r\n      const ctx = screenshot.getContext('2d');\r\n      ctx.imageSmoothingEnabled = this.screen.antialiasing;\r\n      ctx.drawImage(this.canvas, 0, 0, finalWidth, finalHeight);\r\n\r\n      const result = new Image();\r\n      const raw = screenshot.toDataURL('image/png');\r\n      result.src = raw;\r\n      request.resolve(result);\r\n    }\r\n    // Reset state\r\n    this._screenShotRequests.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Another option available to you to load resources into the game.\r\n   * Immediately after calling this the game will pause and the loading screen\r\n   * will appear.\r\n   * @param loader  Some [[Loadable]] such as a [[Loader]] collection, [[Sound]], or [[Texture]].\r\n   */\r\n  public async load(loader: DefaultLoader, hideLoader = false): Promise<void> {\r\n    await this.scope(async () => {\r\n      try {\r\n        // early exit if loaded\r\n        if (loader.isLoaded()) {\r\n          return;\r\n        }\r\n        this._loader = loader;\r\n        this._isLoading = true;\r\n        this._hideLoader = hideLoader;\r\n\r\n        if (loader instanceof Loader) {\r\n          loader.suppressPlayButton = loader.suppressPlayButton || this._suppressPlayButton;\r\n        }\r\n        this._loader.onInitialize(this);\r\n\r\n        await loader.load();\r\n      } catch (e) {\r\n        this._logger.error('Error loading resources, things may not behave properly', e);\r\n        await Promise.resolve();\r\n      } finally {\r\n        this._isLoading = false;\r\n        this._hideLoader = false;\r\n        this._loader = null;\r\n      }\r\n    });\r\n  }\r\n}","export interface Context<TValue> {\r\n  /**\r\n   * Run the callback before popping the context value\r\n   * @param value\r\n   * @param cb\r\n   */\r\n  scope: <TReturn>(value: TValue, cb: () => TReturn) => TReturn;\r\n  value: TValue;\r\n}\r\n\r\n\r\n/**\r\n * Creates a injectable context that can be retrieved later with `useContext(context)`\r\n *\r\n * Example\r\n * ```typescript\r\n *\r\n * const AppContext = createContext({some: 'value'});\r\n * context.scope(val, () => {\r\n *    const value = useContext(AppContext);\r\n * })\r\n *\r\n * ```\r\n */\r\nexport function createContext<TValue>() {\r\n  const ctx: Context<TValue> = {\r\n    scope: (value, cb) => {\r\n      ctx.value = value;\r\n      return cb();\r\n    },\r\n    value: undefined\r\n  };\r\n  return ctx;\r\n}\r\n\r\n/**\r\n * Retrieves the value from the current context\r\n */\r\nexport function useContext<TValue>(context: Context<TValue>): TValue {\r\n  return context.value;\r\n}","import { GameEvent } from './Events';\r\nimport { Eventable } from './Interfaces/Evented';\r\n\r\n/**\r\n * @deprecated Use [[EventEmitter]] will be removed in v0.29.0\r\n */\r\nexport class EventDispatcher<T = any> implements Eventable {\r\n  private _handlers: { [key: string]: { (event: GameEvent<T>): void }[] } = {};\r\n  private _wiredEventDispatchers: Eventable[] = [];\r\n\r\n  /**\r\n   * Clears any existing handlers or wired event dispatchers on this event dispatcher\r\n   */\r\n  public clear() {\r\n    this._handlers = {};\r\n    this._wiredEventDispatchers = [];\r\n  }\r\n\r\n  private _deferedHandlerRemovals: {name: string, handler?: (...args: any[]) => any }[] = [];\r\n  private _processDeferredHandlerRemovals() {\r\n    for (const eventHandler of this._deferedHandlerRemovals) {\r\n      this._removeHandler(eventHandler.name, eventHandler.handler);\r\n    }\r\n    this._deferedHandlerRemovals.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Emits an event for target\r\n   * @param eventName  The name of the event to publish\r\n   * @param event      Optionally pass an event data object to the handler\r\n   */\r\n  public emit(eventName: string, event: GameEvent<T>) {\r\n    this._processDeferredHandlerRemovals();\r\n    if (!eventName) {\r\n      // key not mapped\r\n      return;\r\n    }\r\n    eventName = eventName.toLowerCase();\r\n    if (typeof event === 'undefined' || event === null) {\r\n      event = new GameEvent();\r\n    }\r\n    let i: number, len: number;\r\n\r\n    if (this._handlers[eventName]) {\r\n      i = 0;\r\n      len = this._handlers[eventName].length;\r\n      for (i; i < len; i++) {\r\n        this._handlers[eventName][i](event);\r\n      }\r\n    }\r\n\r\n    i = 0;\r\n    len = this._wiredEventDispatchers.length;\r\n\r\n    for (i; i < len; i++) {\r\n      this._wiredEventDispatchers[i].emit(eventName, event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe an event handler to a particular event name, multiple handlers per event name are allowed.\r\n   * @param eventName  The name of the event to subscribe to\r\n   * @param handler    The handler callback to fire on this event\r\n   */\r\n  public on(eventName: string, handler: (event: GameEvent<T>) => void) {\r\n    this._processDeferredHandlerRemovals();\r\n    eventName = eventName.toLowerCase();\r\n\r\n    if (!this._handlers[eventName]) {\r\n      this._handlers[eventName] = [];\r\n    }\r\n    this._handlers[eventName].push(handler);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe an event handler(s) from an event. If a specific handler\r\n   * is specified for an event, only that handler will be unsubscribed.\r\n   * Otherwise all handlers will be unsubscribed for that event.\r\n   * @param eventName  The name of the event to unsubscribe\r\n   * @param handler    Optionally the specific handler to unsubscribe\r\n   */\r\n  public off(eventName: string, handler?: (event: GameEvent<T>) => void) {\r\n    this._deferedHandlerRemovals.push({name: eventName, handler});\r\n  }\r\n\r\n  private _removeHandler(eventName: string, handler?: (event: GameEvent<T>) => void) {\r\n    eventName = eventName.toLowerCase();\r\n    const eventHandlers = this._handlers[eventName];\r\n\r\n    if (eventHandlers) {\r\n      // if no explicit handler is give with the event name clear all handlers\r\n      if (!handler) {\r\n        this._handlers[eventName].length = 0;\r\n      } else {\r\n        const index = eventHandlers.indexOf(handler);\r\n        if (index > -1) {\r\n          this._handlers[eventName].splice(index, 1);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Once listens to an event one time, then unsubscribes from that event\r\n   * @param eventName The name of the event to subscribe to once\r\n   * @param handler   The handler of the event that will be auto unsubscribed\r\n   */\r\n  public once(eventName: string, handler: (event: GameEvent<T>) => void) {\r\n    this._processDeferredHandlerRemovals();\r\n    const metaHandler = (event: GameEvent<T>) => {\r\n      const ev = event || new GameEvent();\r\n      this.off(eventName, metaHandler);\r\n      handler(ev);\r\n    };\r\n\r\n    this.on(eventName, metaHandler);\r\n  }\r\n\r\n  /**\r\n   * Wires this event dispatcher to also receive events from another\r\n   */\r\n  public wire(eventDispatcher: EventDispatcher): void {\r\n    eventDispatcher._wiredEventDispatchers.push(this);\r\n  }\r\n\r\n  /**\r\n   * Unwires this event dispatcher from another\r\n   */\r\n  public unwire(eventDispatcher: EventDispatcher): void {\r\n    const index = eventDispatcher._wiredEventDispatchers.indexOf(this);\r\n    if (index > -1) {\r\n      eventDispatcher._wiredEventDispatchers.splice(index, 1);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { vec, Vector } from './Math/vector';\r\nimport { Text } from './Graphics/Text';\r\nimport { GraphicsComponent, SpriteFont } from './Graphics';\r\nimport { Font } from './Graphics/Font';\r\nimport { Actor } from './Actor';\r\nimport { ActorArgs } from './Actor';\r\n\r\n/**\r\n * Option for creating a label\r\n */\r\nexport interface LabelOptions {\r\n  /**\r\n   * Specify the label text\r\n   */\r\n  text?: string;\r\n  /**\r\n   * Specify the color of the text (does not apply to SpriteFonts)\r\n   */\r\n  color?: Color;\r\n  x?: number;\r\n  y?: number;\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally specify a sprite font, will take precedence over any other [[Font]]\r\n   */\r\n  spriteFont?: SpriteFont;\r\n  /**\r\n   * Specify a custom font\r\n   */\r\n  font?: Font\r\n}\r\n\r\n/**\r\n * Labels are the way to draw small amounts of text to the screen. They are\r\n * actors and inherit all of the benefits and capabilities.\r\n */\r\nexport class Label extends Actor {\r\n  private _font: Font = new Font();\r\n  private _text: Text = new Text({ text: '', font: this._font });\r\n\r\n  public get font(): Font {\r\n    return this._font;\r\n  }\r\n\r\n  public set font(newFont: Font) {\r\n    this._font = newFont;\r\n    this._text.font = newFont;\r\n  }\r\n\r\n  /**\r\n   * The text to draw.\r\n   */\r\n  public get text(): string {\r\n    return this._text.text;\r\n  }\r\n\r\n  public set text(text: string) {\r\n    this._text.text = text;\r\n  }\r\n\r\n  public override get color(): Color {\r\n    return this._text.color;\r\n  }\r\n\r\n  public override set color(color: Color) {\r\n    if (this._text) {\r\n      this._text.color = color;\r\n    }\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this._text.opacity;\r\n  }\r\n\r\n  public set opacity(opacity: number) {\r\n    this._text.opacity = opacity;\r\n  }\r\n\r\n  private _spriteFont: SpriteFont;\r\n  /**\r\n   * The [[SpriteFont]] to use, if any. Overrides [[Font|font]] if present.\r\n   */\r\n  public get spriteFont(): SpriteFont {\r\n    return this._spriteFont;\r\n  }\r\n\r\n  public set spriteFont(sf: SpriteFont) {\r\n    if (sf) {\r\n      this._spriteFont = sf;\r\n      this._text.font = this._spriteFont;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build a new label\r\n   * @param options\r\n   */\r\n  constructor(options?: LabelOptions & ActorArgs) {\r\n    super(options);\r\n    const {text, pos, x, y, spriteFont, font, color} = { text: '', ...options };\r\n\r\n    this.pos = pos ?? (x && y ? vec(x, y) : this.pos);\r\n    this.text = text ?? this.text;\r\n    this.font = font ?? this.font;\r\n    this.spriteFont = spriteFont ?? this.spriteFont;\r\n    this._text.color = color ?? this.color;\r\n    const gfx = this.get(GraphicsComponent);\r\n    gfx.anchor = Vector.Zero;\r\n    gfx.use(this._text);\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the text in the label (in pixels);\r\n   */\r\n  public getTextWidth(): number {\r\n    return this._text.width;\r\n  }\r\n}\r\n","import { BodyComponent } from '../Collision/BodyComponent';\r\nimport { BoundingBox} from '../Collision/BoundingBox';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Collider } from '../Collision/Colliders/Collider';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity, EntityEvents } from '../EntityComponentSystem/Entity';\r\nimport { DebugGraphicsComponent, ExcaliburGraphicsContext, Graphic, GraphicsComponent } from '../Graphics';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\nimport { DebugConfig } from '../Debug';\r\nimport { PointerComponent } from '../Input/PointerComponent';\r\nimport { PointerEvent } from '../Input/PointerEvent';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport type IsometricTilePointerEvents = {\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n}\r\n\r\nexport class IsometricTile extends Entity {\r\n  /**\r\n   * Indicates whether this tile is solid\r\n   */\r\n  public solid: boolean = false;\r\n\r\n  public events = new EventEmitter<EntityEvents & IsometricTilePointerEvents>();\r\n\r\n  private _gfx: GraphicsComponent;\r\n  private _tileBounds = new BoundingBox();\r\n  private _graphics: Graphic[] = [];\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n  /**\r\n   * Tile graphics\r\n   */\r\n  public addGraphic(graphic: Graphic, options?: {offset?: Vector}) {\r\n    this._graphics.push(graphic);\r\n    this._gfx.visible = this.map.visible;\r\n    this._gfx.opacity = this.map.opacity;\r\n    if (options?.offset) {\r\n      this._gfx.offset = options.offset;\r\n    }\r\n    // TODO detect when this changes on the map and apply to all tiles\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  private _recalculateBounds(): BoundingBox {\r\n    let bounds = this._tileBounds.clone();\r\n    for (const graphic of this._graphics) {\r\n      const offset = vec(\r\n        this.map.graphicsOffset.x - this.map.tileWidth / 2,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : (graphic.height - this.map.tileHeight)));\r\n      bounds = bounds.combine(graphic.localBounds.translate(offset));\r\n    }\r\n    return bounds;\r\n  }\r\n\r\n  public removeGraphic(graphic: Graphic) {\r\n    const index = this._graphics.indexOf(graphic);\r\n    if (index > -1) {\r\n      this._graphics.splice(index, 1);\r\n    }\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n    this._gfx.visible = false;\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  /**\r\n   * Tile colliders\r\n   */\r\n  private _colliders: Collider[] = [];\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a collider to the IsometricTile\r\n   *\r\n   * **Note!** the [[Tile.solid]] must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the IsometricTile\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the IsometricTile\r\n   */\r\n  public clearColliders(): void {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  public readonly x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  public readonly y: number;\r\n  /**\r\n   * Reference to the [[IsometricMap]] this tile is part of\r\n   */\r\n  public readonly map: IsometricMap;\r\n\r\n  private _transform: TransformComponent;\r\n  private _isometricEntityComponent: IsometricEntityComponent;\r\n\r\n  /**\r\n   * Returns the top left corner of the [[IsometricTile]] in world space\r\n   */\r\n  public get pos(): Vector {\r\n    return this.map.tileToWorld(vec(this.x, this.y));\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the [[IsometricTile]]\r\n   */\r\n  public get center(): Vector {\r\n    return this.pos.add(vec(0, this.map.tileHeight / 2));\r\n  }\r\n\r\n  /**\r\n   * Arbitrary data storage per tile, useful for any game specific data\r\n   */\r\n  public data = new Map<string, any>();\r\n\r\n  /**\r\n   * Construct a new IsometricTile\r\n   * @param x tile coordinate in x (not world position)\r\n   * @param y tile coordinate in y (not world position)\r\n   * @param graphicsOffset offset that tile should be shifted by (default (0, 0))\r\n   * @param map reference to owning IsometricMap\r\n   */\r\n  constructor(x: number, y: number, graphicsOffset: Vector | null, map: IsometricMap) {\r\n    super([\r\n      new TransformComponent(),\r\n      new GraphicsComponent({\r\n        offset: graphicsOffset ?? Vector.Zero,\r\n        onPostDraw: (gfx, elapsed) => this.draw(gfx, elapsed)\r\n      }),\r\n      new IsometricEntityComponent(map)\r\n    ]);\r\n    this.x = x;\r\n    this.y = y;\r\n    this.map = map;\r\n    this._transform = this.get(TransformComponent);\r\n    this._isometricEntityComponent = this.get(IsometricEntityComponent);\r\n\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    const halfTileHeight = this.map.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    // The x position shifts left with every y step\r\n    const xPos = (this.x - this.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (this.x + this.y) * halfTileHeight;\r\n    this._transform.pos = vec(xPos, yPos);\r\n    this._isometricEntityComponent.elevation = map.elevation;\r\n\r\n    this._gfx = this.get(GraphicsComponent);\r\n    this._gfx.visible = false; // start not visible\r\n    const totalWidth = this.map.tileWidth;\r\n    const totalHeight = this.map.tileHeight;\r\n\r\n    // initial guess at gfx bounds based on the tile\r\n    const offset = vec(0, (this.map.renderFromTopOfGraphic ? totalHeight : 0));\r\n    this._gfx.localBounds = this._tileBounds = new BoundingBox({\r\n      left: -totalWidth / 2,\r\n      top: -totalHeight,\r\n      right: totalWidth / 2,\r\n      bottom: totalHeight\r\n    }).translate(offset);\r\n  }\r\n\r\n  draw(gfx: ExcaliburGraphicsContext, _elapsed: number) {\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    gfx.save();\r\n    // shift left origin to corner of map, not the left corner of the first sprite\r\n    gfx.translate(-halfTileWidth, 0);\r\n    for (const graphic of this._graphics) {\r\n      graphic.draw(\r\n        gfx,\r\n        this.map.graphicsOffset.x,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : (graphic.height - this.map.tileHeight)));\r\n    }\r\n    gfx.restore();\r\n  }\r\n}\r\n\r\nexport interface IsometricMapOptions {\r\n  /**\r\n   * Optionally name the isometric tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the isometric tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n  /**\r\n   * Optionally present a graphics offset, this can be useful depending on your tile graphics\r\n   */\r\n  graphicsOffset?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels, this should be the width of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels, this should be the height of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n\r\n  elevation?: number;\r\n}\r\n\r\n/**\r\n * The IsometricMap is a special tile map that provides isometric rendering support to Excalibur\r\n *\r\n * The tileWidth and tileHeight should be the height and width in pixels of the parallelogram of the base of the tile art asset.\r\n * The tileWidth and tileHeight is not necessarily the same as your graphic pixel width and height.\r\n *\r\n * Please refer to the docs https://excaliburjs.com for more details calculating what your tile width and height should be given\r\n * your art assets.\r\n */\r\nexport class IsometricMap extends Entity {\r\n  public readonly elevation: number = 0;\r\n\r\n  /**\r\n   * Width of individual tile in pixels\r\n   */\r\n  public readonly tileWidth: number;\r\n  /**\r\n   * Height of individual tile in pixels\r\n   */\r\n  public readonly tileHeight: number;\r\n  /**\r\n   * Number of tiles wide\r\n   */\r\n  public readonly columns: number;\r\n  /**\r\n   * Number of tiles high\r\n   */\r\n  public readonly rows: number;\r\n  /**\r\n   * List containing all of the tiles in IsometricMap\r\n   */\r\n  public readonly tiles: IsometricTile[];\r\n\r\n  /**\r\n   * Whether tiles should be visible\r\n   */\r\n  public visible = true;\r\n\r\n  /**\r\n   * Opacity of tiles\r\n   */\r\n  public opacity = 1.0;\r\n\r\n  /**\r\n   * Render the tile graphic from the top instead of the bottom\r\n   *\r\n   * default is `false` meaning rendering from the bottom\r\n   */\r\n  public renderFromTopOfGraphic: boolean = false;\r\n  public graphicsOffset: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Isometric map [[TransformComponent]]\r\n   */\r\n  public transform: TransformComponent;\r\n\r\n  /**\r\n   * Isometric map [[ColliderComponent]]\r\n   */\r\n  public collider: ColliderComponent;\r\n\r\n  public pointer: PointerComponent;\r\n\r\n  private _composite: CompositeCollider;\r\n\r\n  constructor(options: IsometricMapOptions) {\r\n    super([\r\n      new TransformComponent(),\r\n      new BodyComponent({\r\n        type: CollisionType.Fixed\r\n      }),\r\n      new ColliderComponent(),\r\n      new PointerComponent(),\r\n      new DebugGraphicsComponent((ctx, debugFlags) => this.debug(ctx, debugFlags), false)\r\n    ], options.name);\r\n    const { pos, tileWidth, tileHeight, columns: width, rows: height, renderFromTopOfGraphic, graphicsOffset, elevation } = options;\r\n\r\n    this.transform = this.get(TransformComponent);\r\n    if (pos) {\r\n      this.transform.pos = pos;\r\n    }\r\n\r\n    this.collider = this.get(ColliderComponent);\r\n    if (this.collider) {\r\n      this.collider.set(this._composite = new CompositeCollider([]));\r\n    }\r\n\r\n    this.pointer = this.get(PointerComponent);\r\n\r\n    this.renderFromTopOfGraphic = renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.graphicsOffset = graphicsOffset ?? this.graphicsOffset;\r\n\r\n    this.elevation = elevation ?? this.elevation;\r\n    this.tileWidth = tileWidth;\r\n    this.tileHeight = tileHeight;\r\n    this.columns = width;\r\n    this.rows = height;\r\n\r\n    this.tiles = new Array(width * height);\r\n\r\n    // build up tile representation\r\n    for (let y = 0; y < height; y++) {\r\n      for (let x = 0; x < width; x++) {\r\n        const tile = new IsometricTile(x, y, this.graphicsOffset, this);\r\n        this.tiles[x + y * width] = tile;\r\n        this.addChild(tile);\r\n      }\r\n    }\r\n\r\n    this.pointer.localBounds = BoundingBox.fromDimension(\r\n      tileWidth * width * this.transform.scale.x,\r\n      tileHeight * height * this.transform.scale.y,\r\n      vec(.5, 0)\r\n    );\r\n\r\n    this._setupPointerToTile();\r\n  }\r\n\r\n  private _forwardPointerEventToTile = (eventType: string) => (evt: PointerEvent) => {\r\n    const tile = this.getTileByPoint(evt.worldPos);\r\n    if (tile) {\r\n      tile.events.emit(eventType, evt);\r\n    }\r\n  };\r\n\r\n  private _setupPointerToTile() {\r\n    this.events.on('pointerup', this._forwardPointerEventToTile('pointerup'));\r\n    this.events.on('pointerdown', this._forwardPointerEventToTile('pointerdown'));\r\n    this.events.on('pointermove', this._forwardPointerEventToTile('pointermove'));\r\n    this.events.on('pointercancel', this._forwardPointerEventToTile('pointercancel'));\r\n  }\r\n\r\n  public update(): void {\r\n    if (this._collidersDirty) {\r\n      this.updateColliders();\r\n      this._collidersDirty = false;\r\n    }\r\n  }\r\n\r\n  private _collidersDirty = false;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n  }\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider);\r\n    }\r\n  }\r\n  public updateColliders() {\r\n    this._composite.clearColliders();\r\n    const pos = this.get(TransformComponent).pos;\r\n    for (const tile of this.tiles) {\r\n      if (tile.solid) {\r\n        for (const collider of tile.getColliders()) {\r\n          const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n          collider.offset = this.tileToWorld(vec(tile.x, tile.y))\r\n            .sub(pos)\r\n            .add(originalOffset)\r\n            .sub(vec(this.tileWidth / 2, this.tileHeight)); // We need to unshift height based on drawing\r\n          collider.owner = this;\r\n          this._composite.addCollider(collider);\r\n        }\r\n      }\r\n    }\r\n    this.collider.update();\r\n  }\r\n\r\n  /**\r\n   * Convert world space coordinates to the tile x, y coordinate\r\n   * @param worldCoordinate\r\n   */\r\n  public worldToTile(worldCoordinate: Vector): Vector {\r\n    // TODO I don't think this handles parent transform see TileMap\r\n    worldCoordinate = worldCoordinate.sub(this.transform.globalPos);\r\n\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    return vec(\r\n      ~~((worldCoordinate.x / halfTileWidth + (worldCoordinate.y / halfTileHeight)) / 2),\r\n      ~~((worldCoordinate.y / halfTileHeight - (worldCoordinate.x / halfTileWidth)) / 2));\r\n  }\r\n\r\n  /**\r\n   * Given a tile coordinate, return the top left corner in world space\r\n   * @param tileCoordinate\r\n   */\r\n  public tileToWorld(tileCoordinate: Vector): Vector {\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // The x position shifts left with every y step\r\n    const xPos = (tileCoordinate.x - tileCoordinate.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (tileCoordinate.x + tileCoordinate.y) * halfTileHeight;\r\n    return vec(xPos, yPos).add(this.transform.pos);\r\n  }\r\n\r\n  /**\r\n   * Returns the [[IsometricTile]] by its x and y coordinates\r\n   */\r\n  public getTile(x: number, y: number): IsometricTile | null {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n\r\n  /**\r\n   * Returns the [[IsometricTile]] by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): IsometricTile | null {\r\n    const tileCoord = this.worldToTile(point);\r\n    const tile = this.getTile(tileCoord.x, tileCoord.y);\r\n    return tile;\r\n  }\r\n\r\n  private _getMaxZIndex(): number {\r\n    let maxZ = Number.NEGATIVE_INFINITY;\r\n    for (const tile of this.tiles) {\r\n      const currentZ = tile.get(TransformComponent).z;\r\n      if (currentZ > maxZ) {\r\n        maxZ =  currentZ;\r\n      }\r\n    }\r\n    return maxZ;\r\n  }\r\n\r\n  /**\r\n   * Debug draw for IsometricMap, called internally by excalibur when debug mode is toggled on\r\n   * @param gfx\r\n   */\r\n  public debug(gfx: ExcaliburGraphicsContext, debugFlags: DebugConfig) {\r\n    const {\r\n      showAll,\r\n      showPosition,\r\n      positionColor,\r\n      positionSize,\r\n      showGrid,\r\n      gridColor,\r\n      gridWidth,\r\n      showColliderGeometry\r\n    } = debugFlags.isometric;\r\n\r\n    const {\r\n      geometryColor,\r\n      geometryLineWidth,\r\n      geometryPointSize\r\n    } = debugFlags.collider;\r\n    gfx.save();\r\n    gfx.z = this._getMaxZIndex() + 0.5;\r\n    if (showAll || showGrid) {\r\n      for (let y = 0; y < this.rows + 1; y++) {\r\n        const left = this.tileToWorld(vec(0, y));\r\n        const right = this.tileToWorld(vec(this.columns, y));\r\n        gfx.drawLine(left, right, gridColor, gridWidth);\r\n      }\r\n\r\n      for (let x = 0; x < this.columns + 1; x++) {\r\n        const top = this.tileToWorld(vec(x, 0));\r\n        const bottom = this.tileToWorld(vec(x, this.rows));\r\n        gfx.drawLine(top, bottom, gridColor, gridWidth);\r\n      }\r\n    }\r\n\r\n    if (showAll || showPosition) {\r\n      for (const tile of this.tiles) {\r\n        gfx.drawCircle(this.tileToWorld(vec(tile.x, tile.y)), positionSize, positionColor);\r\n      }\r\n    }\r\n    if (showAll || showColliderGeometry) {\r\n      for (const tile of this.tiles) {\r\n        if (tile.solid) { // only draw solid tiles\r\n          for (const collider of tile.getColliders()) {\r\n            collider.debug(gfx, geometryColor, { lineWidth: geometryLineWidth, pointSize: geometryPointSize });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    gfx.restore();\r\n  }\r\n}","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * Action that can represent a sequence of actions, this can be useful in conjunction with\r\n * [[ParallelActions]] to run multiple sequences in parallel.\r\n */\r\nexport class ActionSequence implements Action {\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _sequenceContext: ActionContext;\r\n  private _sequenceBuilder: (actionContext: ActionContext) => any;\r\n  constructor(entity: Entity, actionBuilder: (actionContext: ActionContext) => any) {\r\n    this._sequenceBuilder = actionBuilder;\r\n    this._sequenceContext = new ActionContext(entity);\r\n    this._actionQueue = this._sequenceContext.getQueue();\r\n    this._sequenceBuilder(this._sequenceContext);\r\n  }\r\n\r\n  public update(delta: number): void {\r\n    this._actionQueue.update(delta);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._actionQueue.isComplete();\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._stopped = false;\r\n    this._actionQueue.reset();\r\n  }\r\n\r\n  public clone(entity: Entity) {\r\n    return new ActionSequence(entity, this._sequenceBuilder);\r\n  }\r\n}","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action } from '../Action';\r\n\r\n\r\n/**\r\n * Action that can run multiple [[Action]]s or [[ActionSequence]]s at the same time\r\n */\r\nexport class ParallelActions implements Action {\r\n  private _actions: Action[];\r\n\r\n  constructor(parallelActions: Action[]) {\r\n    this._actions = parallelActions;\r\n  }\r\n\r\n  update(delta: number): void {\r\n    for (let i = 0; i < this._actions.length; i++) {\r\n      this._actions[i].update(delta);\r\n    }\r\n  }\r\n  isComplete(entity: Entity): boolean {\r\n    return this._actions.every(a => a.isComplete(entity));\r\n  }\r\n  reset(): void {\r\n    this._actions.forEach(a => a.reset());\r\n  }\r\n  stop(): void {\r\n    this._actions.forEach(a => a.stop());\r\n  }\r\n}","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics';\r\nimport { BoundingBox } from '../BoundingBox';\r\n\r\nexport interface QuadTreeItem {\r\n  bounds: BoundingBox;\r\n}\r\n\r\nexport interface QuadTreeOptions {\r\n  maxDepth?: number;\r\n  capacity: number;\r\n  level?: number;\r\n}\r\n\r\n/**\r\n * QuadTree spatial data structure. Useful for quickly retrieving all objects that might\r\n * be in a specific location.\r\n */\r\nexport class QuadTree<TItem extends QuadTreeItem> {\r\n  private _defaultOptions: QuadTreeOptions = {\r\n    maxDepth: 10,\r\n    capacity: 10,\r\n    level: 0\r\n  };\r\n\r\n  public halfWidth: number;\r\n  public halfHeight: number;\r\n  public items: TItem[] = [];\r\n  private _isDivided = false;\r\n\r\n  public topLeft: QuadTree<TItem> | null = null;\r\n  public topRight: QuadTree<TItem> | null = null;\r\n  public bottomLeft: QuadTree<TItem> | null = null;\r\n  public bottomRight: QuadTree<TItem> | null = null;\r\n\r\n  constructor(public bounds: BoundingBox, public options?: QuadTreeOptions) {\r\n    this.options = {...this._defaultOptions, ...options};\r\n    this.halfWidth = bounds.width / 2;\r\n    this.halfHeight = bounds.height / 2;\r\n  }\r\n\r\n  /**\r\n   * Splits the quad tree one level deeper\r\n   */\r\n  private _split() {\r\n    this._isDivided = true;\r\n    const newLevelOptions = {\r\n      maxDepth: this.options.maxDepth,\r\n      capacity: this.options.capacity,\r\n      level: this.options.level + 1\r\n    };\r\n    this.topLeft = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left,\r\n        top: this.bounds.top,\r\n        right: this.bounds.left + this.halfWidth,\r\n        bottom: this.bounds.top + this.halfHeight\r\n      }), newLevelOptions);\r\n    this.topRight = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left + this.halfWidth,\r\n        top: this.bounds.top,\r\n        right: this.bounds.right,\r\n        bottom: this.bounds.top + this.halfHeight\r\n      }), newLevelOptions);\r\n    this.bottomLeft = new QuadTree<TItem>(new BoundingBox({\r\n      left: this.bounds.left,\r\n      top: this.bounds.top + this.halfHeight,\r\n      right: this.bounds.left + this.halfWidth,\r\n      bottom: this.bounds.bottom\r\n    }), newLevelOptions);\r\n    this.bottomRight = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left + this.halfWidth,\r\n        top: this.bounds.top + this.halfHeight,\r\n        right: this.bounds.right,\r\n        bottom: this.bounds.bottom\r\n      }), newLevelOptions);\r\n  }\r\n\r\n  private _insertIntoSubNodes(item: TItem) {\r\n    if (this.topLeft?.bounds.overlaps(item.bounds)) {\r\n      this.topLeft.insert(item);\r\n    }\r\n\r\n    if (this.topRight?.bounds.overlaps(item.bounds)) {\r\n      this.topRight.insert(item);\r\n    }\r\n\r\n    if (this.bottomLeft?.bounds.overlaps(item.bounds)) {\r\n      this.bottomLeft.insert(item);\r\n    }\r\n\r\n    if (this.bottomRight?.bounds.overlaps(item.bounds)) {\r\n      this.bottomRight.insert(item);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Insert an item to be tracked in the QuadTree\r\n   * @param item\r\n   */\r\n  insert(item: TItem): void {\r\n    // add to subnodes if it matches\r\n    if (this._isDivided) {\r\n      this._insertIntoSubNodes(item);\r\n      return;\r\n    }\r\n\r\n\r\n    // leaf case\r\n    this.items.push(item);\r\n\r\n    // capacity\r\n    if (this.items.length > this.options.capacity && this.options.level < this.options.maxDepth) {\r\n      if (!this._isDivided) {\r\n        this._split();\r\n      }\r\n      // divide this level's items into it's subnodes\r\n      for (const item of this.items) {\r\n        this._insertIntoSubNodes(item);\r\n      }\r\n      // clear this level\r\n      this.items.length = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a tracked item in the QuadTree\r\n   * @param item\r\n   */\r\n  remove(item: TItem): void {\r\n    if (!this.bounds.overlaps(item.bounds)) {\r\n      return;\r\n    }\r\n\r\n    if (!this._isDivided) {\r\n      const index = this.items.indexOf(item);\r\n      if (index > -1) {\r\n        this.items.splice(index, 1);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (this.topLeft?.bounds.overlaps(item.bounds)) {\r\n      this.topLeft.remove(item);\r\n    }\r\n\r\n    if (this.topRight?.bounds.overlaps(item.bounds)) {\r\n      this.topRight.remove(item);\r\n    }\r\n\r\n    if (this.bottomLeft?.bounds.overlaps(item.bounds)) {\r\n      this.bottomLeft.remove(item);\r\n    }\r\n\r\n    if (this.bottomRight?.bounds.overlaps(item.bounds)) {\r\n      this.bottomRight.remove(item);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query the structure for all objects that intersect the bounding box\r\n   * @param boundingBox\r\n   * @returns items\r\n   */\r\n  query(boundingBox: BoundingBox): TItem[] {\r\n\r\n    let results = this.items;\r\n\r\n    if (this._isDivided) {\r\n      if (this.topLeft.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.topLeft.query(boundingBox));\r\n      }\r\n      if (this.topRight.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.topRight.query(boundingBox));\r\n      }\r\n      if (this.bottomLeft.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.bottomLeft.query(boundingBox));\r\n      }\r\n      if (this.bottomRight.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.bottomRight.query(boundingBox));\r\n      }\r\n    }\r\n\r\n    results = results.filter((item, index) => {\r\n      return results.indexOf(item) >= index;\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  clear() {\r\n    this.items = [];\r\n    this._isDivided = false;\r\n\r\n    this.topLeft = null;\r\n    this.topRight = null;\r\n    this.bottomLeft = null;\r\n    this.bottomRight = null;\r\n  }\r\n\r\n  getAllItems(): TItem[] {\r\n    let results = this.items;\r\n\r\n    if (this._isDivided) {\r\n      results = results.concat(this.topLeft.getAllItems());\r\n      results = results.concat(this.topRight.getAllItems());\r\n      results = results.concat(this.bottomLeft.getAllItems());\r\n      results = results.concat(this.bottomRight.getAllItems());\r\n    }\r\n\r\n    results = results.filter((item, index) => {\r\n      return results.indexOf(item) >= index;\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  getTreeDepth(): number {\r\n    if (!this._isDivided) {\r\n      return 0;\r\n    }\r\n\r\n    return 1 + Math.max(\r\n      this.topLeft.getTreeDepth(),\r\n      this.topRight.getTreeDepth(),\r\n      this.bottomLeft.getTreeDepth(),\r\n      this.bottomRight.getTreeDepth()\r\n    );\r\n  }\r\n\r\n  debug(ctx: ExcaliburGraphicsContext) {\r\n    this.bounds.draw(ctx, Color.Yellow);\r\n    if (this._isDivided) {\r\n      this.topLeft.bounds.draw(ctx, Color.Yellow);\r\n      this.topRight.bounds.draw(ctx, Color.Yellow);\r\n      this.bottomLeft.bounds.draw(ctx, Color.Yellow);\r\n      this.bottomRight.bounds.draw(ctx, Color.Yellow);\r\n    }\r\n  }\r\n}","import { Engine } from './../Engine';\nimport * as Events from './../Events';\nimport { Scene } from '../Scene';\nimport { ExcaliburGraphicsContext } from '../Graphics';\n\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport interface _initialize {\n  _initialize(engine: Engine): void;\n}\n\n/**\n * Type guard checking for internal initialize method\n * @internal\n * @param a\n */\nexport function has_initialize(a: any): a is _initialize {\n  return !!a._initialize;\n}\n\nexport interface OnInitialize {\n  onInitialize(engine: Engine): void;\n}\n\n/**\n *\n */\nexport function hasOnInitialize(a: any): a is OnInitialize {\n  return !!a.onInitialize;\n}\n\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport interface _preupdate {\n  _preupdate(engine: Engine, delta: number): void;\n}\n\n/**\n *\n */\nexport function has_preupdate(a: any): a is _preupdate {\n  return !!a._preupdate;\n}\n\nexport interface OnPreUpdate {\n  onPreUpdate(engine: Engine, delta: number): void;\n}\n\n/**\n *\n */\nexport function hasOnPreUpdate(a: any): a is OnPreUpdate {\n  return !!a.onPreUpdate;\n}\n\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport interface _postupdate {\n  _postupdate(engine: Engine, delta: number): void;\n}\n\n/**\n *\n */\nexport function has_postupdate(a: any): a is _postupdate {\n  return !!a.onPostUpdate;\n}\n\nexport interface OnPostUpdate {\n  onPostUpdate(engine: Engine, delta: number): void;\n}\n\n/**\n *\n */\nexport function hasOnPostUpdate(a: any): a is OnPostUpdate {\n  return !!a.onPostUpdate;\n}\n\nexport interface CanInitialize {\n  /**\n   * Overridable implementation\n   */\n  onInitialize(engine: Engine): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\n  once(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\n  off(eventName: Events.initialize, handler?: (event: Events.InitializeEvent<any>) => void): void;\n}\n\nexport interface SceneActivationContext<TData = undefined> {\n  data?: TData;\n  previousScene: Scene;\n  nextScene: Scene;\n  engine: Engine;\n}\n\nexport interface CanActivate<TData = undefined> {\n  /**\n   * Overridable implementation\n   */\n  onActivate(context: SceneActivationContext<TData>): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\n  once(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\n  off(eventName: Events.activate, handler?: (event: Events.ActivateEvent) => void): void;\n}\n\nexport interface CanDeactivate {\n  /**\n   * Overridable implementation\n   */\n  onDeactivate(context: SceneActivationContext<never>): void;\n\n  /**\n   * Event signature\n   */\n  on(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\n  once(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\n  off(eventName: Events.deactivate, handler?: (event: Events.DeactivateEvent) => void): void;\n}\n\nexport interface CanUpdate {\n  /**\n   * Overridable implementation\n   */\n  onPreUpdate(engine: Engine, delta: number): void;\n\n  /**\n   * Event signature\n   */\n  on(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\n  once(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\n  off(eventName: Events.preupdate, handler?: (event: Events.PreUpdateEvent<any>) => void): void;\n\n  /**\n   * Overridable implementation\n   */\n  onPostUpdate(engine: Engine, delta: number): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\n  once(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\n  off(eventName: Events.postupdate, handler?: (event: Events.PostUpdateEvent<any>) => void): void;\n}\n\nexport interface OnPreDraw {\n  /**\n   * Overridable implementation\n   */\n  onPreDraw(ctx: ExcaliburGraphicsContext, delta: number): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\n}\n\nexport interface OnPostDraw {\n  /**\n   * Overridable implementation\n   */\n  onPostDraw(ctx: ExcaliburGraphicsContext, delta: number): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\n}\n\nexport interface CanDraw extends OnPreDraw, OnPostDraw {\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\n\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\n\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\n}\n\n/**\n *\n */\nexport function hasPreDraw(a: any): a is OnPreDraw {\n  return !!a.onPreDraw;\n}\n\n/**\n *\n */\nexport function hasPostDraw(a: any): a is OnPostDraw {\n  return !!a.onPostDraw;\n}\n\nexport interface CanBeKilled {\n  /**\n   * Overridable implementation\n   */\n  onPreKill(_scene: Scene): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\n  once(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\n  off(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\n\n  /**\n   * Overridable implementation\n   */\n  onPostKill(_scene: Scene): void;\n\n  /**\n   * Event signatures\n   */\n  on(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\n  once(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\n  off(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\n}\n","import { Resource } from './Resource';\r\nimport { Sprite } from '../Graphics/Sprite';\r\nimport { Color } from '../Color';\r\nimport { SpriteSheet } from '../Graphics/SpriteSheet';\r\nimport { Animation } from '../Graphics/Animation';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { ImageSource } from '../Graphics/ImageSource';\r\nimport { range } from '../Math/util';\r\n/**\r\n * The [[Texture]] object allows games built in Excalibur to load image resources.\r\n * [[Texture]] is an [[Loadable]] which means it can be passed to a [[Loader]]\r\n * to pre-load before starting a level or game.\r\n */\r\nexport class Gif implements Loadable<ImageSource[]> {\r\n  private _resource: Resource<ArrayBuffer>;\r\n\r\n  /**\r\n   * The width of the texture in pixels\r\n   */\r\n  public width: number;\r\n\r\n  /**\r\n   * The height of the texture in pixels\r\n   */\r\n  public height: number;\r\n\r\n\r\n  private _stream: Stream = null;\r\n  private _gif: ParseGif = null;\r\n  private _textures: ImageSource[] = [];\r\n  private _animation: Animation = null;\r\n  private _transparentColor: Color = null;\r\n\r\n  public data: ImageSource[];\r\n\r\n  /**\r\n   * @param path       Path to the image resource\r\n   * @param color      Optionally set the color to treat as transparent the gif, by default [[Color.Magenta]]\r\n   * @param bustCache  Optionally load texture with cache busting\r\n   */\r\n  constructor(public path: string, public color: Color = Color.Magenta, bustCache = false) {\r\n    this._resource = new Resource(path, 'arraybuffer', bustCache);\r\n    this._transparentColor = color;\r\n  }\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  /**\r\n   * Begins loading the texture and returns a promise to be resolved on completion\r\n   */\r\n  public async load(): Promise<ImageSource[]> {\r\n    const arraybuffer = await this._resource.load();\r\n    this._stream = new Stream(arraybuffer);\r\n    this._gif = new ParseGif(this._stream, this._transparentColor);\r\n    const images = this._gif.images.map(i => new ImageSource(i.src, false));\r\n\r\n    // Load all textures\r\n    await Promise.all(images.map(t => t.load()));\r\n    return this.data = this._textures = images;\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  /**\r\n   * Return a frame of the gif as a sprite by id\r\n   * @param id\r\n   */\r\n  public toSprite(id: number = 0): Sprite {\r\n    const sprite = this._textures[id].toSprite();\r\n    return sprite;\r\n  }\r\n\r\n  /**\r\n   * Return the gif as a spritesheet\r\n   */\r\n  public toSpriteSheet(): SpriteSheet {\r\n    const sprites: Sprite[] = this._textures.map((image) => {\r\n      return image.toSprite();\r\n    });\r\n    return new SpriteSheet({ sprites });\r\n  }\r\n\r\n  /**\r\n   * Transform the GIF into an animation with duration per frame\r\n   */\r\n  public toAnimation(durationPerFrameMs: number): Animation {\r\n    const spriteSheet: SpriteSheet = this.toSpriteSheet();\r\n    const length = spriteSheet.sprites.length;\r\n    this._animation = Animation.fromSpriteSheet(spriteSheet, range(0, length), durationPerFrameMs);\r\n    return this._animation;\r\n  }\r\n\r\n  public get readCheckBytes(): number[] {\r\n    return this._gif.checkBytes;\r\n  }\r\n}\r\n\r\nexport interface GifFrame {\r\n  sentinel: number;\r\n  type: string;\r\n  leftPos: number;\r\n  topPos: number;\r\n  width: number;\r\n  height: number;\r\n  lctFlag: boolean;\r\n  interlaced: boolean;\r\n  sorted: boolean;\r\n  reserved: boolean[];\r\n  lctSize: number;\r\n  lzwMinCodeSize: number;\r\n  pixels: number[];\r\n}\r\n\r\nconst bitsToNum = (ba: any) => {\r\n  return ba.reduce(function (s: number, n: number) {\r\n    return s * 2 + n;\r\n  }, 0);\r\n};\r\n\r\nconst byteToBitArr = (bite: any) => {\r\n  const a = [];\r\n  for (let i = 7; i >= 0; i--) {\r\n    a.push(!!(bite & (1 << i)));\r\n  }\r\n  return a;\r\n};\r\n\r\nexport class Stream {\r\n  data: any = null;\r\n  len: number = 0;\r\n  position: number = 0;\r\n\r\n  constructor(dataArray: ArrayBuffer) {\r\n    this.data = new Uint8Array(dataArray);\r\n    this.len = this.data.byteLength;\r\n    if (this.len === 0) {\r\n      throw new Error('No data loaded from file');\r\n    }\r\n  }\r\n\r\n  public readByte = () => {\r\n    if (this.position >= this.data.byteLength) {\r\n      throw new Error('Attempted to read past end of stream.');\r\n    }\r\n    return this.data[this.position++];\r\n  };\r\n\r\n  public readBytes = (n: number) => {\r\n    const bytes = [];\r\n    for (let i = 0; i < n; i++) {\r\n      bytes.push(this.readByte());\r\n    }\r\n    return bytes;\r\n  };\r\n\r\n  public read = (n: number) => {\r\n    let s = '';\r\n    for (let i = 0; i < n; i++) {\r\n      s += String.fromCharCode(this.readByte());\r\n    }\r\n    return s;\r\n  };\r\n\r\n  public readUnsigned = () => {\r\n    // Little-endian.\r\n    const a = this.readBytes(2);\r\n    return (a[1] << 8) + a[0];\r\n  };\r\n}\r\n\r\nconst lzwDecode = function (minCodeSize: number, data: any) {\r\n  // TODO: Now that the GIF parser is a bit different, maybe this should get an array of bytes instead of a String?\r\n  let pos = 0; // Maybe this streaming thing should be merged with the Stream?\r\n\r\n  const readCode = function (size: number) {\r\n    let code = 0;\r\n    for (let i = 0; i < size; i++) {\r\n      if (data.charCodeAt(pos >> 3) & (1 << (pos & 7))) {\r\n        code |= 1 << i;\r\n      }\r\n      pos++;\r\n    }\r\n    return code;\r\n  };\r\n\r\n  const output: any[] = [];\r\n\r\n  const clearCode = 1 << minCodeSize;\r\n  const eoiCode = clearCode + 1;\r\n\r\n  let codeSize = minCodeSize + 1;\r\n\r\n  let dict: any[] = [];\r\n\r\n  const clear = function () {\r\n    dict = [];\r\n    codeSize = minCodeSize + 1;\r\n    for (let i = 0; i < clearCode; i++) {\r\n      dict[i] = [i];\r\n    }\r\n    dict[clearCode] = [];\r\n    dict[eoiCode] = null;\r\n  };\r\n\r\n  let code;\r\n  let last;\r\n\r\n  while (true) {\r\n    last = code;\r\n    code = readCode(codeSize);\r\n    if (code === clearCode) {\r\n      clear();\r\n      continue;\r\n    }\r\n    if (code === eoiCode) {\r\n      break;\r\n    }\r\n\r\n    if (code < dict.length) {\r\n      if (last !== clearCode) {\r\n        dict.push(dict[last].concat(dict[code][0]));\r\n      }\r\n    } else {\r\n      if (code !== dict.length) {\r\n        throw new Error('Invalid LZW code.');\r\n      }\r\n      dict.push(dict[last].concat(dict[last][0]));\r\n    }\r\n    output.push.apply(output, dict[code]);\r\n\r\n    if (dict.length === 1 << codeSize && codeSize < 12) {\r\n      // If we're at the last code and codeSize is 12, the next code will be a clearCode, and it'll be 12 bits long.\r\n      codeSize++;\r\n    }\r\n  }\r\n\r\n  // I don't know if this is technically an error, but some GIFs do it.\r\n  //if (Math.ceil(pos / 8) !== data.length) throw new Error('Extraneous LZW bytes.');\r\n  return output;\r\n};\r\n\r\n// The actual parsing; returns an object with properties.\r\nexport class ParseGif {\r\n  private _st: Stream = null;\r\n  private _handler: any = {};\r\n  private _transparentColor: Color = null;\r\n  public frames: GifFrame[] = [];\r\n  public images: HTMLImageElement[] = [];\r\n  public globalColorTable: any[] = [];\r\n  public checkBytes: number[] = [];\r\n\r\n  constructor(stream: Stream, color: Color = Color.Magenta) {\r\n    this._st = stream;\r\n    this._handler = {};\r\n    this._transparentColor = color;\r\n    this.parseHeader();\r\n    this.parseBlock();\r\n  }\r\n\r\n  // LZW (GIF-specific)\r\n  parseColorTable = (entries: any) => {\r\n    // Each entry is 3 bytes, for RGB.\r\n    const ct = [];\r\n    for (let i = 0; i < entries; i++) {\r\n      const rgb: number[] = this._st.readBytes(3);\r\n      const rgba =\r\n        '#' +\r\n        rgb\r\n          .map((x: any) => {\r\n            const hex = x.toString(16);\r\n            return hex.length === 1 ? '0' + hex : hex;\r\n          })\r\n          .join('');\r\n      ct.push(rgba);\r\n    }\r\n    return ct;\r\n  };\r\n\r\n  readSubBlocks = () => {\r\n    let size, data;\r\n    data = '';\r\n    do {\r\n      size = this._st.readByte();\r\n      data += this._st.read(size);\r\n    } while (size !== 0);\r\n    return data;\r\n  };\r\n\r\n  parseHeader = () => {\r\n    const hdr: any = {\r\n      sig: null,\r\n      ver: null,\r\n      width: null,\r\n      height: null,\r\n      colorRes: null,\r\n      globalColorTableSize: null,\r\n      gctFlag: null,\r\n      sorted: null,\r\n      globalColorTable: [],\r\n      bgColor: null,\r\n      pixelAspectRatio: null // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n    };\r\n\r\n    hdr.sig = this._st.read(3);\r\n    hdr.ver = this._st.read(3);\r\n    if (hdr.sig !== 'GIF') {\r\n      throw new Error('Not a GIF file.'); // XXX: This should probably be handled more nicely.\r\n    }\r\n\r\n    hdr.width = this._st.readUnsigned();\r\n    hdr.height = this._st.readUnsigned();\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    hdr.gctFlag = bits.shift();\r\n    hdr.colorRes = bitsToNum(bits.splice(0, 3));\r\n    hdr.sorted = bits.shift();\r\n    hdr.globalColorTableSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    hdr.bgColor = this._st.readByte();\r\n    hdr.pixelAspectRatio = this._st.readByte(); // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n\r\n    if (hdr.gctFlag) {\r\n      hdr.globalColorTable = this.parseColorTable(1 << (hdr.globalColorTableSize + 1));\r\n      this.globalColorTable = hdr.globalColorTable;\r\n    }\r\n    if (this._handler.hdr && this._handler.hdr(hdr)) {\r\n      this.checkBytes.push(this._handler.hdr);\r\n    }\r\n  };\r\n\r\n  parseExt = (block: any) => {\r\n    const parseGCExt = (block: any) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 4\r\n\r\n      const bits = byteToBitArr(this._st.readByte());\r\n      block.reserved = bits.splice(0, 3); // Reserved; should be 000.\r\n      block.disposalMethod = bitsToNum(bits.splice(0, 3));\r\n      block.userInput = bits.shift();\r\n      block.transparencyGiven = bits.shift();\r\n\r\n      block.delayTime = this._st.readUnsigned();\r\n\r\n      block.transparencyIndex = this._st.readByte();\r\n\r\n      block.terminator = this._st.readByte();\r\n\r\n      if (this._handler.gce && this._handler.gce(block)) {\r\n        this.checkBytes.push(this._handler.gce);\r\n      }\r\n    };\r\n\r\n    const parseComExt = (block: any) => {\r\n      block.comment = this.readSubBlocks();\r\n      if (this._handler.com && this._handler.com(block)) {\r\n        this.checkBytes.push(this._handler.com);\r\n      }\r\n    };\r\n\r\n    const parsePTExt = (block: any) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 12\r\n      block.ptHeader = this._st.readBytes(12);\r\n      block.ptData = this.readSubBlocks();\r\n      if (this._handler.pte && this._handler.pte(block)) {\r\n        this.checkBytes.push(this._handler.pte);\r\n      }\r\n    };\r\n\r\n    const parseAppExt = (block: any) => {\r\n      const parseNetscapeExt = (block: any) => {\r\n        this.checkBytes.push(this._st.readByte()); // Always 3\r\n        block.unknown = this._st.readByte(); // Q: Always 1? What is this?\r\n        block.iterations = this._st.readUnsigned();\r\n        block.terminator = this._st.readByte();\r\n        if (this._handler.app && this._handler.app.NETSCAPE && this._handler.app.NETSCAPE(block)) {\r\n          this.checkBytes.push(this._handler.app);\r\n        }\r\n      };\r\n\r\n      const parseUnknownAppExt = (block: any) => {\r\n        block.appData = this.readSubBlocks();\r\n        // FIXME: This won't work if a handler wants to match on any identifier.\r\n        if (this._handler.app && this._handler.app[block.identifier] && this._handler.app[block.identifier](block)) {\r\n          this.checkBytes.push(this._handler.app[block.identifier]);\r\n        }\r\n      };\r\n\r\n      this.checkBytes.push(this._st.readByte()); // Always 11\r\n      block.identifier = this._st.read(8);\r\n      block.authCode = this._st.read(3);\r\n      switch (block.identifier) {\r\n        case 'NETSCAPE':\r\n          parseNetscapeExt(block);\r\n          break;\r\n        default:\r\n          parseUnknownAppExt(block);\r\n          break;\r\n      }\r\n    };\r\n\r\n    const parseUnknownExt = (block: any) => {\r\n      block.data = this.readSubBlocks();\r\n      if (this._handler.unknown && this._handler.unknown(block)) {\r\n        this.checkBytes.push(this._handler.unknown);\r\n      }\r\n    };\r\n\r\n    block.label = this._st.readByte();\r\n    switch (block.label) {\r\n      case 0xf9:\r\n        block.extType = 'gce';\r\n        parseGCExt(block);\r\n        break;\r\n      case 0xfe:\r\n        block.extType = 'com';\r\n        parseComExt(block);\r\n        break;\r\n      case 0x01:\r\n        block.extType = 'pte';\r\n        parsePTExt(block);\r\n        break;\r\n      case 0xff:\r\n        block.extType = 'app';\r\n        parseAppExt(block);\r\n        break;\r\n      default:\r\n        block.extType = 'unknown';\r\n        parseUnknownExt(block);\r\n        break;\r\n    }\r\n  };\r\n\r\n  parseImg = (img: any) => {\r\n    const deinterlace = (pixels: any, width: any) => {\r\n      // Of course this defeats the purpose of interlacing. And it's *probably*\r\n      // the least efficient way it's ever been implemented. But nevertheless...\r\n\r\n      const newPixels = new Array(pixels.length);\r\n      const rows = pixels.length / width;\r\n      const cpRow = (toRow: any, fromRow: any) => {\r\n        const fromPixels = pixels.slice(fromRow * width, (fromRow + 1) * width);\r\n        newPixels.splice.apply(newPixels, [toRow * width, width].concat(fromPixels));\r\n      };\r\n\r\n      const offsets = [0, 4, 2, 1];\r\n      const steps = [8, 8, 4, 2];\r\n\r\n      let fromRow = 0;\r\n      for (let pass = 0; pass < 4; pass++) {\r\n        for (let toRow = offsets[pass]; toRow < rows; toRow += steps[pass]) {\r\n          cpRow(toRow, fromRow);\r\n          fromRow++;\r\n        }\r\n      }\r\n\r\n      return newPixels;\r\n    };\r\n\r\n    img.leftPos = this._st.readUnsigned();\r\n    img.topPos = this._st.readUnsigned();\r\n    img.width = this._st.readUnsigned();\r\n    img.height = this._st.readUnsigned();\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    img.lctFlag = bits.shift();\r\n    img.interlaced = bits.shift();\r\n    img.sorted = bits.shift();\r\n    img.reserved = bits.splice(0, 2);\r\n    img.lctSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    if (img.lctFlag) {\r\n      img.lct = this.parseColorTable(1 << (img.lctSize + 1));\r\n    }\r\n\r\n    img.lzwMinCodeSize = this._st.readByte();\r\n\r\n    const lzwData = this.readSubBlocks();\r\n\r\n    img.pixels = lzwDecode(img.lzwMinCodeSize, lzwData);\r\n\r\n    if (img.interlaced) {\r\n      // Move\r\n      img.pixels = deinterlace(img.pixels, img.width);\r\n    }\r\n\r\n    this.frames.push(img);\r\n    this.arrayToImage(img);\r\n    if (this._handler.img && this._handler.img(img)) {\r\n      this.checkBytes.push(this._handler);\r\n    }\r\n  };\r\n\r\n  public parseBlock = () => {\r\n    const block = {\r\n      sentinel: this._st.readByte(),\r\n      type: ''\r\n    };\r\n    const blockChar = String.fromCharCode(block.sentinel);\r\n    switch (blockChar) {\r\n      case '!':\r\n        block.type = 'ext';\r\n        this.parseExt(block);\r\n        break;\r\n      case ',':\r\n        block.type = 'img';\r\n        this.parseImg(block);\r\n        break;\r\n      case ';':\r\n        block.type = 'eof';\r\n        if (this._handler.eof && this._handler.eof(block)) {\r\n          this.checkBytes.push(this._handler.eof);\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error('Unknown block: 0x' + block.sentinel.toString(16));\r\n    }\r\n\r\n    if (block.type !== 'eof') {\r\n      this.parseBlock();\r\n    }\r\n  };\r\n\r\n  arrayToImage = (frame: GifFrame) => {\r\n    let count = 0;\r\n    const c = document.createElement('canvas');\r\n    c.id = count.toString();\r\n    c.width = frame.width;\r\n    c.height = frame.height;\r\n    count++;\r\n    const context = c.getContext('2d');\r\n    const pixSize = 1;\r\n    let y = 0;\r\n    let x = 0;\r\n    for (let i = 0; i < frame.pixels.length; i++) {\r\n      if (x % frame.width === 0) {\r\n        y++;\r\n        x = 0;\r\n      }\r\n      if (this.globalColorTable[frame.pixels[i]] === this._transparentColor.toHex()) {\r\n        context.fillStyle = `rgba(0, 0, 0, 0)`;\r\n      } else {\r\n        context.fillStyle = this.globalColorTable[frame.pixels[i]];\r\n      }\r\n\r\n      context.fillRect(x, y, pixSize, pixSize);\r\n      x++;\r\n    }\r\n    const img = new Image();\r\n    img.src = c.toDataURL();\r\n    this.images.push(img);\r\n  };\r\n}\r\n","import { Font } from '../Graphics/Font';\r\nimport { FontOptions } from '../Graphics/FontCommon';\r\nimport { GraphicOptions, RasterOptions } from '../Graphics';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport { Resource } from './Resource';\r\n\r\n\r\nexport interface FontSourceOptions\r\n  extends Omit<FontOptions, 'family'>,\r\n  GraphicOptions,\r\n  RasterOptions {\r\n  /**\r\n   * Whether or not to cache-bust requests\r\n   */\r\n  bustCache?: boolean\r\n}\r\n\r\nexport class FontSource implements Loadable<FontFace> {\r\n  private _resource: Resource<Blob>;\r\n  private _isLoaded = false;\r\n  private _options: FontSourceOptions;\r\n\r\n  data!: FontFace;\r\n\r\n\r\n  constructor(\r\n    /**\r\n     * Path to the font resource relative from the HTML document hosting the game, or absolute\r\n     */\r\n    public readonly path: string,\r\n    /**\r\n     * The font family name\r\n     */\r\n    public readonly family: string,\r\n    { bustCache, ...options }: FontSourceOptions = {}\r\n  ) {\r\n    this._resource = new Resource(path, 'blob', bustCache);\r\n    this._options = options;\r\n  }\r\n\r\n  async load(): Promise<FontFace> {\r\n    if (this.isLoaded()) {\r\n      return this.data;\r\n    }\r\n\r\n    try {\r\n      const blob = await this._resource.load();\r\n      const url = URL.createObjectURL(blob);\r\n\r\n      if (!this.data) {\r\n        this.data = new FontFace(this.family, `url(${url})`);\r\n        document.fonts.add(this.data);\r\n      }\r\n\r\n      await this.data.load();\r\n      this._isLoaded = true;\r\n    } catch (error) {\r\n      throw `Error loading FontSource from path '${this.path}' with error [${\r\n        (error as Error).message\r\n      }]`;\r\n    }\r\n    return this.data;\r\n  }\r\n\r\n  isLoaded(): boolean {\r\n    return this._isLoaded;\r\n  }\r\n\r\n  /**\r\n   * Build a font from this FontSource.\r\n   * @param options {FontOptions} Override the font options\r\n   */\r\n  toFont(options?: FontOptions & GraphicOptions & RasterOptions): Font {\r\n    return new Font({ family: this.family, ...this._options, ...options });\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { ScheduledCallbackTiming } from './Clock';\r\nexport type CoroutineGenerator = () => Generator<number | Promise<any> | undefined, void, number>;\r\n\r\nconst generatorFunctionDeclaration = /^\\s*(?:function)?\\*/;\r\n/**\r\n *\r\n */\r\nfunction isCoroutineGenerator(x: any): x is CoroutineGenerator {\r\n  if (typeof x !== 'function') {\r\n    return false;\r\n  }\r\n  if (generatorFunctionDeclaration.test(Function.prototype.toString.call(x))) {\r\n    return true;\r\n  }\r\n  if (!Object.getPrototypeOf) {\r\n    return false;\r\n  }\r\n  return Object.getPrototypeOf(x) === Object.getPrototypeOf(new Function('return function * () {}')());\r\n}\r\n\r\nexport interface CoroutineOptions {\r\n  timing?: ScheduledCallbackTiming;\r\n}\r\n\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param thisArg set the \"this\" context of the generator, by default is globalThis\r\n * @param engine pass a specific engine to use for running the coroutine\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(thisArg: any, engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param engine pass a specific engine to use for running the coroutine\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param thisArg set the \"this\" context of the generator, by default is globalThis\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(thisArg: any, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n/**\r\n *\r\n */\r\nexport function coroutine(...args: any[]): Promise<void> {\r\n  let coroutineGenerator: CoroutineGenerator;\r\n  let thisArg: any;\r\n  let options: CoroutineOptions | undefined;\r\n  let passedEngine: Engine | undefined;\r\n\r\n  // coroutine(coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n  if (isCoroutineGenerator(args[0])) {\r\n    thisArg = globalThis;\r\n    coroutineGenerator = args[0];\r\n    options = args[1];\r\n  }\r\n\r\n  // coroutine(thisArg: any, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n  if (isCoroutineGenerator(args[1])) {\r\n    thisArg = args[0];\r\n    coroutineGenerator = args[1];\r\n    options = args[2];\r\n  }\r\n\r\n  // coroutine(thisArg: any, engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n  if (args[1] instanceof Engine) {\r\n    thisArg = args[0];\r\n    passedEngine = args[1];\r\n    coroutineGenerator = args[2];\r\n    options = args[3];\r\n  }\r\n\r\n  // coroutine(engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): Promise<void>;\r\n  if (args[0] instanceof Engine) {\r\n    thisArg = globalThis;\r\n    passedEngine = args[0];\r\n    coroutineGenerator = args[1];\r\n    options = args[2];\r\n  }\r\n\r\n  const schedule = options?.timing;\r\n  let engine: Engine;\r\n  try {\r\n    engine = passedEngine ?? Engine.useEngine();\r\n  } catch (_) {\r\n    throw Error(\r\n      'Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.\\n' +\r\n      'Pass an engine parameter to ex.coroutine(engine, function * {...})');\r\n  }\r\n  const generatorFcn = coroutineGenerator.bind(thisArg);\r\n  return new Promise<void>((resolve, reject) => {\r\n    const generator = generatorFcn();\r\n    const loop = (elapsedMs: number) => {\r\n      try {\r\n        const { done, value } = generator.next(elapsedMs);\r\n        if (done) {\r\n          resolve();\r\n        }\r\n\r\n        if (value instanceof Promise) {\r\n          value.then(() => {\r\n            // schedule next loop\r\n            engine.clock.schedule(loop, 0, schedule);\r\n          });\r\n        } else if (value === undefined || value === (void 0)) {\r\n          // schedule next frame\r\n          engine.clock.schedule(loop, 0, schedule);\r\n        } else {\r\n          // schedule value milliseconds from now\r\n          engine.clock.schedule(loop, value || 0, schedule);\r\n        }\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    };\r\n    loop(engine.clock.elapsed());// run first frame immediately\r\n  });\r\n}","import { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Future } from '../Util/Future';\r\nimport { Entity, TransformComponent } from '../EntityComponentSystem';\r\nimport { GraphicsComponent } from '../Graphics';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { Vector } from '../Math/vector';\r\nimport { clamp } from '../Math/util';\r\nimport { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { coroutine } from '../Util/Coroutine';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport interface TransitionOptions {\r\n  /**\r\n   * Transition duration in milliseconds\r\n   */\r\n  duration: number;\r\n\r\n  /**\r\n   * Optionally hides the loader during the transition\r\n   *\r\n   * If either the out or in transition have this set to true, then the loader will be hidden.\r\n   *\r\n   * Default false\r\n   */\r\n  hideLoader?: boolean;\r\n\r\n  /**\r\n   * Optionally blocks user input during a transition\r\n   *\r\n   * Default false\r\n   */\r\n  blockInput?: boolean;\r\n\r\n  /**\r\n   * Optionally specify a easing function, by default linear\r\n   */\r\n  easing?: EasingFunction;\r\n  /**\r\n   * Optionally specify a transition direction, by default 'out'\r\n   *\r\n   * * For 'in' direction transitions start at 1 and complete is at 0\r\n   * * For 'out' direction transitions start at 0 and complete is at 1\r\n   */\r\n  direction?: 'out' | 'in';\r\n}\r\n\r\n/**\r\n * Base Transition that can be extended to provide custom scene transitions in Excalibur.\r\n */\r\nexport class Transition extends Entity {\r\n  private _logger: Logger = Logger.getInstance();\r\n  transform = new TransformComponent();\r\n  graphics = new GraphicsComponent();\r\n  readonly hideLoader: boolean;\r\n  readonly blockInput: boolean;\r\n  readonly duration: number;\r\n  readonly easing: EasingFunction;\r\n  readonly direction: 'out' | 'in';\r\n  private _completeFuture = new Future<void>();\r\n\r\n  // State needs to be reset between uses\r\n  public started = false;\r\n  private _currentDistance: number = 0;\r\n  private _currentProgress: number = 0;\r\n\r\n  public done = this._completeFuture.promise;\r\n\r\n  /**\r\n   * Returns a number between [0, 1] indicating what state the transition is in.\r\n   *\r\n   * * For 'out' direction transitions start at 0 and end at 1\r\n   * * For 'in' direction transitions start at 1 and end at 0\r\n   */\r\n  get progress(): number {\r\n    return this._currentProgress;\r\n  }\r\n\r\n  get complete(): boolean {\r\n    if (this.direction === 'out') {\r\n      return this.progress >= 1;\r\n    } else {\r\n      return this.progress <= 0;\r\n    }\r\n  }\r\n\r\n  constructor(options: TransitionOptions) {\r\n    super();\r\n    this.name = `Transition#${this.id}`;\r\n    this.duration = options.duration;\r\n    this.easing = options.easing ?? EasingFunctions.Linear;\r\n    this.direction = options.direction ?? 'out';\r\n    this.hideLoader = options.hideLoader ?? false;\r\n    this.blockInput = options.blockInput ?? false;\r\n    this.transform.coordPlane = CoordPlane.Screen;\r\n    this.transform.pos = Vector.Zero;\r\n    this.transform.z = Infinity; // Transitions sit on top of everything\r\n    this.graphics.anchor = Vector.Zero;\r\n    this.addComponent(this.transform);\r\n    this.addComponent(this.graphics);\r\n\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = 0;\r\n    } else {\r\n      this._currentProgress = 1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called before each update.\r\n   *\r\n   * **WARNING BE SURE** to call `super.updateTransition()` if overriding in your own custom implementation\r\n   * @param engine\r\n   * @param delta\r\n   */\r\n  public updateTransition(engine: Engine, delta: number): void {\r\n    if (this.complete) {\r\n      return;\r\n    }\r\n\r\n    this._currentDistance += clamp(delta / this.duration, 0, 1);\r\n    if (this._currentDistance >= 1) {\r\n      this._currentDistance = 1;\r\n    }\r\n\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = clamp(this.easing(this._currentDistance, 0, 1, 1), 0, 1);\r\n    } else {\r\n      this._currentProgress = clamp(this.easing(this._currentDistance, 1, 0, 1), 0, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called right before the previous scene has deactivated.\r\n   *\r\n   * This gives incoming transition a chance to grab info from previous scene if desired\r\n   * @param scene\r\n   */\r\n  async onPreviousSceneDeactivate(scene: Scene) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called once at the beginning of the transition\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onStart(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called every frame of the transition\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onUpdate(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called at the end of the transition,\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onEnd(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called when the transition is reset\r\n   *\r\n   * Use this to override and provide your own reset logic for internal state in custom transition implementations\r\n   */\r\n  onReset() {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * reset() is called by the engine to reset transitions\r\n   */\r\n  reset() {\r\n    this.started = false;\r\n    this._completeFuture = new Future<void>();\r\n    this.done = this._completeFuture.promise;\r\n    this._currentDistance = 0;\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = 0;\r\n    } else {\r\n      this._currentProgress = 1;\r\n    }\r\n    this.onReset();\r\n  }\r\n\r\n  play(engine: Engine, targetScene?: Scene) {\r\n    if (this.started) {\r\n      this.reset();\r\n      this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`);\r\n    }\r\n\r\n    const currentScene = targetScene ?? engine.currentScene;\r\n    currentScene.add(this);\r\n    const self = this;\r\n    return coroutine(engine, function * () {\r\n      while (!self.complete) {\r\n        const elapsed = yield; // per frame\r\n        self.updateTransition(engine, elapsed);\r\n        self.execute();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * execute() is called by the engine every frame to update the Transition lifecycle onStart/onUpdate/onEnd\r\n   */\r\n  execute() {\r\n    if (!this.isInitialized) {\r\n      return;\r\n    }\r\n\r\n    if (!this.started) {\r\n      this.started = true;\r\n      this.onStart(this.progress);\r\n    }\r\n\r\n    this.onUpdate(this.progress);\r\n\r\n    if (this.complete && !this._completeFuture.isCompleted) {\r\n      this.onEnd(this.progress);\r\n      this._completeFuture.resolve();\r\n    }\r\n  }\r\n}","import { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { Rectangle } from '../Graphics';\r\nimport { Transition, TransitionOptions } from './Transition';\r\n\r\nexport interface FadeOptions {\r\n  duration?: number;\r\n  color?: Color;\r\n}\r\n\r\nexport class FadeInOut extends Transition {\r\n  screenCover: Rectangle;\r\n  color: Color;\r\n  constructor(options: FadeOptions & TransitionOptions) {\r\n    super({\r\n      ...options,\r\n      duration: options.duration ?? 2000\r\n    });\r\n    this.name = `FadeInOut#${this.id}`;\r\n    this.color = options.color ?? Color.Black;\r\n  }\r\n\r\n  public onInitialize(engine: Engine): void {\r\n    this.transform.pos = engine.screen.unsafeArea.topLeft;\r\n    this.screenCover = new Rectangle({\r\n      width: engine.screen.resolution.width,\r\n      height: engine.screen.resolution.height,\r\n      color: this.color\r\n    });\r\n    this.graphics.add(this.screenCover);\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onReset() {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onStart(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onEnd(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onUpdate(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n}","import { ImageSource, Sprite } from '../Graphics';\r\nimport { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Transition, TransitionOptions } from './Transition';\r\nimport { vec } from '../Math/vector';\r\n\r\nexport interface CrossFadeOptions {\r\n  duration: number;\r\n}\r\n\r\n/**\r\n * CrossFades between the previous scene and the destination scene\r\n *\r\n * Note: CrossFade only works as an \"in\" transition\r\n */\r\nexport class CrossFade extends Transition {\r\n  engine: Engine;\r\n  image: HTMLImageElement;\r\n  screenCover: Sprite;\r\n  constructor(options: TransitionOptions & CrossFadeOptions) {\r\n    super({direction: 'in', ...options}); // default the correct direction\r\n    this.name = `CrossFade#${this.id}`;\r\n  }\r\n\r\n  override async onPreviousSceneDeactivate(scene: Scene<unknown>) {\r\n    this.image = await scene.engine.screenshot(true);\r\n    // Firefox is particularly slow\r\n    // needed in case the image isn't ready yet\r\n    await this.image.decode();\r\n  }\r\n\r\n  override onInitialize(engine: Engine): void {\r\n    this.engine = engine;\r\n    this.transform.pos = engine.screen.unsafeArea.topLeft;\r\n    this.screenCover = ImageSource.fromHtmlImageElement(this.image).toSprite();\r\n    this.graphics.add(this.screenCover);\r\n    this.transform.scale = vec(1 / engine.screen.pixelRatio, 1 / engine.screen.pixelRatio);\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onStart(_progress: number): void {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onReset() {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onEnd(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onUpdate(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n}","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Graphic } from './Graphic';\r\n\r\nexport interface LineOptions {\r\n  start: Vector;\r\n  end: Vector;\r\n  color?: Color;\r\n  thickness?: number;\r\n}\r\nexport class Line extends Graphic {\r\n  readonly start: Vector;\r\n  readonly end: Vector;\r\n  color: Color = Color.Black;\r\n  thickness: number = 1;\r\n  private _localBounds: BoundingBox;\r\n  constructor(options: LineOptions) {\r\n    super();\r\n    const { start, end, color, thickness } = options;\r\n    this.start = start;\r\n    this.end = end;\r\n    this.color = color ?? this.color;\r\n    this.thickness = thickness ?? this.thickness;\r\n    this._localBounds = this._calculateBounds();\r\n    const { width, height } = this._localBounds;\r\n\r\n    this.width = width;\r\n    this.height = height;\r\n  }\r\n\r\n  public get localBounds() {\r\n    return this._localBounds;\r\n  }\r\n\r\n  private _calculateBounds(): BoundingBox {\r\n    const lineNormal = this.end.sub(this.start).normal();\r\n\r\n    const halfThickness = this.thickness / 2;\r\n\r\n    const points = [\r\n      this.start.add(lineNormal.scale(halfThickness)),\r\n      this.end.add(lineNormal.scale(halfThickness)),\r\n      this.end.add(lineNormal.scale(-halfThickness)),\r\n      this.start.add(lineNormal.scale(-halfThickness))\r\n    ];\r\n\r\n    return BoundingBox.fromPoints(points);\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, _x: number, _y: number): void {\r\n    ctx.drawLine(this.start, this.end, this.color, this.thickness);\r\n  }\r\n\r\n  clone(): Line {\r\n    return new Line({\r\n      start: this.start,\r\n      end: this.end,\r\n      color: this.color,\r\n      thickness: this.thickness\r\n    });\r\n  }\r\n}","import { ImageFiltering } from './Filtering';\nimport { Vector, vec } from '../Math/vector';\nimport { Raster, RasterOptions } from './Raster';\n\nexport interface PolygonOptions {\n  points: Vector[];\n}\n\n/**\n * A polygon [[Graphic]] for drawing arbitrary polygons to the [[ExcaliburGraphicsContext]]\n *\n * Polygons default to [[ImageFiltering.Blended]]\n */\nexport class Polygon extends Raster {\n  private _points: Vector[];\n  public get points(): Vector[] {\n    return this._points;\n  }\n  public set points(points: Vector[]) {\n    this._points = points;\n    const min = this.minPoint;\n    this.width = this._points.reduce((max, p) => Math.max(p.x, max), 0) - min.x;\n    this.height = this._points.reduce((max, p) => Math.max(p.y, max), 0) - min.y;\n    this.flagDirty();\n  }\n\n  public get minPoint() {\n    const minX = this._points.reduce((min, p) => Math.min(p.x, min), Infinity);\n    const minY = this._points.reduce((min, p) => Math.min(p.y, min), Infinity);\n    return vec(minX, minY);\n  }\n\n  constructor(options: RasterOptions & PolygonOptions) {\n    super(options);\n    this.points = options.points;\n    this.filtering = ImageFiltering.Blended;\n    this.rasterize();\n  }\n\n  public clone(): Polygon {\n    return new Polygon({\n      points: this.points.map((p) => p.clone()),\n      ...this.cloneGraphicOptions(),\n      ...this.cloneRasterOptions()\n    });\n  }\n\n  execute(ctx: CanvasRenderingContext2D): void {\n    if (this.points && this.points.length) {\n      ctx.beginPath();\n      // Iterate through the supplied points and construct a 'polygon'\n      const min = this.minPoint.negate();\n      const firstPoint = this.points[0].add(min);\n      ctx.moveTo(firstPoint.x, firstPoint.y);\n      this.points.forEach((point) => {\n        ctx.lineTo(point.x + min.x, point.y + min.y);\n      });\n      ctx.lineTo(firstPoint.x, firstPoint.y);\n      ctx.closePath();\n      if (this.color) {\n        ctx.fill();\n      }\n      if (this.strokeColor) {\n        ctx.stroke();\n      }\n    }\n  }\n}\n","import { Flags } from '../Flags';\nimport { Logger } from './Log';\n\n/**\n * Obsolete decorator options\n */\nexport interface ObsoleteOptions {\n  // Optionally specify a custom message\n  message?: string;\n  // Optionally indicate that an alternate method to the obsolete one exists\n  alternateMethod?: string;\n  // Optional show stack trace, by default off\n  showStackTrace?: boolean;\n}\n\nexport const maxMessages = 5;\nconst obsoleteMessage: { [messageCount: string]: number } = {};\nexport const resetObsoleteCounter = () => {\n  for (const message in obsoleteMessage) {\n    obsoleteMessage[message] = 0;\n  }\n};\n\nconst logMessage = (message: string, options: ObsoleteOptions) => {\n  const suppressObsoleteMessages = Flags.isEnabled('suppress-obsolete-message');\n  if (obsoleteMessage[message] < maxMessages && !suppressObsoleteMessages) {\n    Logger.getInstance().warn(message);\n\n    // tslint:disable-next-line: no-console\n    if (console.trace && options.showStackTrace) {\n      // tslint:disable-next-line: no-console\n      console.trace();\n    }\n  }\n  obsoleteMessage[message]++;\n};\n\n/**\n * Obsolete decorator for marking Excalibur methods obsolete, you can optionally specify a custom message and/or alternate replacement\n * method do the deprecated one. Inspired by https://github.com/jayphelps/core-decorators.js\n */\nexport function obsolete(options?: ObsoleteOptions): any {\n  options = {\n    message: 'This feature will be removed in future versions of Excalibur.',\n    alternateMethod: null,\n    showStackTrace: false,\n    ...options\n  };\n\n  return function (target: any, property: string, descriptor: PropertyDescriptor): any {\n    if (\n      descriptor &&\n      !(typeof descriptor.value === 'function' || typeof descriptor.get === 'function' || typeof descriptor.set === 'function')\n    ) {\n      throw new SyntaxError('Only classes/functions/getters/setters can be marked as obsolete');\n    }\n    const methodSignature = `${target.name || ''}${target.name && property ? '.' : ''}${property ? property : ''}`;\n\n    const message =\n      `${methodSignature} is marked obsolete: ${options.message}` +\n      (options.alternateMethod ? ` Use ${options.alternateMethod} instead` : '');\n\n    if (!obsoleteMessage[message]) {\n      obsoleteMessage[message] = 0;\n    }\n\n    // If descriptor is null it is a class\n    const method = descriptor ? { ...descriptor } : target;\n    if (!descriptor) {\n      // with es2015 classes we need to change our decoration tactic\n      class DecoratedClass extends method {\n        constructor(...args: any) {\n          logMessage(message, options);\n          super(...args);\n        }\n      }\n      return DecoratedClass;\n    }\n\n    if (descriptor && descriptor.value) {\n      method.value = function (this: any) {\n        logMessage(message, options);\n        return descriptor.value.apply(this, arguments);\n      };\n      return method;\n    }\n\n    if (descriptor && descriptor.get) {\n      method.get = function (this: any) {\n        logMessage(message, options);\n        return descriptor.get.apply(this, arguments);\n      };\n    }\n\n    if (descriptor && descriptor.set) {\n      method.set = function (this: any) {\n        logMessage(message, options);\n        return descriptor.set.apply(this, arguments);\n      };\n    }\n    return method;\n  };\n}\n","import { Future } from './Future';\r\n\r\nclass AsyncWaitQueue<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _queue: Future<T>[] = [];\r\n\r\n  public get length(): number {\r\n    return this._queue.length;\r\n  }\r\n\r\n  public enqueue(): Promise<T> {\r\n    const future = new Future<T>();\r\n    this._queue.push(future);\r\n    return future.promise;\r\n  }\r\n\r\n  public dequeue(value: T): void {\r\n    const future = this._queue.shift();\r\n    future.resolve(value);\r\n  }\r\n}\r\n\r\n/**\r\n * Semaphore allows you to limit the amount of async calls happening between `enter()` and `exit()`\r\n *\r\n * This can be useful when limiting the number of http calls, browser api calls, etc either for performance or to work\r\n * around browser limitations like max Image.decode() calls in chromium being 256.\r\n */\r\nexport class Semaphore {\r\n  private _waitQueue = new AsyncWaitQueue();\r\n  constructor(private _count: number) { }\r\n\r\n  public get count() {\r\n    return this._count;\r\n  }\r\n\r\n  public get waiting() {\r\n    return this._waitQueue.length;\r\n  }\r\n\r\n  // eslint-disable-next-line require-await\r\n  public async enter() {\r\n    if (this._count !== 0) {\r\n      this._count--;\r\n      return Promise.resolve();\r\n    }\r\n    return this._waitQueue.enqueue();\r\n  }\r\n\r\n  public exit(count: number = 1) {\r\n    if (count === 0) {\r\n      return;\r\n    }\r\n    while (count !== 0 && this._waitQueue.length !== 0) {\r\n      this._waitQueue.dequeue(null);\r\n      count--;\r\n    }\r\n    this._count += count;\r\n  }\r\n}","/**\r\n * The current Excalibur version string\r\n * @description `process.env.__EX_VERSION` gets replaced by Webpack on build\r\n */\r\nexport const EX_VERSION = process.env.__EX_VERSION;\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\n\r\n// This file is used as the bundle entry point and exports everything\r\n// that will be exposed as the `ex` global variable.\r\nexport * from './Flags';\r\nexport * from './Id';\r\nexport * from './Engine';\r\nexport * from './Screen';\r\nexport { Actor, ActorArgs } from './Actor';\r\nexport * from './Math/Index';\r\nexport * from './Camera';\r\nexport * from './Configurable';\r\nexport * from './Debug/index';\r\nexport * from './EventDispatcher';\r\nexport * from './EventEmitter';\r\nexport * from './Events/MediaEvents';\r\nexport * from './Events';\r\nexport * from './Label';\r\nexport { FontStyle, FontUnit, TextAlign, BaseAlign } from './Graphics/FontCommon';\r\nexport { Particle, ParticleTransform, ParticleEmitter, ParticleArgs, ParticleEmitterArgs, EmitterType } from './Particles';\r\nexport * from './Collision/Physics';\r\nexport * from './Scene';\r\n\r\nexport * from './TileMap/index';\r\n\r\nexport * from './Timer';\r\nexport * from './Trigger';\r\nexport * from './ScreenElement';\r\n\r\nexport * from './Actions/Index';\r\nexport * from './Collision/Index';\r\n\r\nexport * from './Interfaces/Index';\r\nexport * from './Resources/Index';\r\n\r\nexport * from './EntityComponentSystem/index';\r\n\r\nexport * from './Director/index';\r\n\r\nexport * from './Color';\r\n\r\nexport * from './Graphics/index';\r\n\r\n// ex.Events namespace\r\nimport * as events from './Events';\r\nexport { events as Events };\r\n\r\n// ex.Input namespace\r\n// TODO deprecated import site remove in v0.29.0\r\nimport * as input from './Input/Index';\r\nexport { input as Input };\r\n\r\nexport {\r\n  WheelEvent\r\n} from './Input/WheelEvent';\r\n\r\nexport {\r\n  PointerEvent\r\n} from './Input/PointerEvent';\r\n\r\nexport {\r\n  WheelDeltaMode\r\n} from './Input/WheelDeltaMode';\r\n\r\nexport {\r\n  PointerButton\r\n} from './Input/PointerButton';\r\n\r\nexport {\r\n  NativePointerButton\r\n} from './Input/NativePointerButton';\r\n\r\nexport {\r\n  CapturePointerConfig\r\n} from './Input/CapturePointerConfig';\r\n\r\n\r\nexport {\r\n  NativePointerEvent,\r\n  NativeMouseEvent,\r\n  NativeTouchEvent,\r\n  NativeWheelEvent,\r\n  PointerInitOptions,\r\n  PointerEventReceiver\r\n} from './Input/PointerEventReceiver';\r\n\r\nexport { PointerAbstraction } from './Input/PointerAbstraction';\r\nexport { PointerComponent } from './Input/PointerComponent';\r\nexport { PointerSystem } from './Input/PointerSystem';\r\nexport { PointerType } from './Input/PointerType';\r\nexport { PointerScope } from './Input/PointerScope';\r\n\r\nexport {\r\n  Gamepads,\r\n  Gamepad,\r\n  Buttons,\r\n  Axes,\r\n  NavigatorGamepads,\r\n  NavigatorGamepad,\r\n  NavigatorGamepadButton,\r\n  NavigatorGamepadEvent,\r\n  GamepadConfiguration\r\n} from './Input/Gamepad';\r\n\r\nexport {\r\n  Keys,\r\n  KeyEvent,\r\n  KeyboardInitOptions,\r\n  Keyboard\r\n} from './Input/Keyboard';\r\nexport * from './Input/InputHost';\r\nexport * from './Input/InputMapper';\r\n\r\n// ex.Util namespaces\r\nimport * as util from './Util/Index';\r\nexport { util as Util };\r\n\r\nexport * from './Util/Browser';\r\nexport * from './Util/Decorators';\r\nexport * from './Util/Detector';\r\nexport * from './Util/EasingFunctions';\r\nexport * from './Util/Observable';\r\nexport * from './Util/Log';\r\nexport * from './Util/Pool';\r\nexport * from './Util/Fps';\r\nexport * from './Util/Clock';\r\nexport * from './Util/WebAudio';\r\nexport * from './Util/Toaster';\r\nexport * from './Util/StateMachine';\r\nexport * from './Util/Future';\r\nexport * from './Util/Semaphore';\r\nexport * from './Util/Coroutine';\r\n\r\n// ex.Deprecated\r\n// import * as deprecated from './Deprecated';\r\n// export { deprecated as Deprecated };\r\n// export * from './Deprecated';\r\n"],"names":["root","factory","exports","module","define","amd","self","___CSS_LOADER_EXPORT___","push","id","cssWithMappingToString","list","toString","this","map","item","content","needLayer","concat","length","join","i","modules","media","dedupe","supports","layer","undefined","alreadyImportedModules","k","_k","cssMapping","btoa","base64","unescape","encodeURIComponent","JSON","stringify","data","sourceMapping","entryUnbind","path","Object","keys","isCallable","tryToString","$TypeError","TypeError","argument","isObject","$String","String","toIndexedObject","toAbsoluteIndex","lengthOfArrayLike","createMethod","IS_INCLUDES","$this","el","fromIndex","O","value","index","includes","indexOf","fails","METHOD_NAME","method","call","uncurryThis","slice","arraySlice","floor","Math","sort","array","comparefn","element","j","middle","left","right","llength","rlength","lindex","rindex","stringSlice","it","TO_STRING_TAG_SUPPORT","classofRaw","TO_STRING_TAG","wellKnownSymbol","$Object","CORRECT_ARGUMENTS","arguments","tag","result","key","error","tryGet","callee","hasOwn","ownKeys","getOwnPropertyDescriptorModule","definePropertyModule","target","source","exceptions","defineProperty","f","getOwnPropertyDescriptor","DESCRIPTORS","createPropertyDescriptor","object","bitmap","enumerable","configurable","writable","makeBuiltIn","defineGlobalProperty","options","simple","name","global","unsafe","nonConfigurable","nonWritable","P","get","document","EXISTS","createElement","firefox","match","UA","test","navigator","userAgent","version","process","Deno","versions","v8","split","webkit","CONSTRUCTOR","METHOD","prototype","createNonEnumerableProperty","defineBuiltIn","copyConstructorProperties","isForced","targetProperty","sourceProperty","descriptor","TARGET","GLOBAL","STATIC","stat","dontCallGetSet","forced","sham","exec","bind","hasOwnProperty","NATIVE_BIND","Function","apply","FunctionPrototype","getDescriptor","PROPER","CONFIGURABLE","uncurryThisWithBind","fn","namespace","aCallable","isNullOrUndefined","V","func","check","globalThis","window","g","toObject","a","classof","propertyIsEnumerable","store","functionToString","inspectSource","set","has","NATIVE_WEAK_MAP","shared","sharedKey","hiddenKeys","OBJECT_ALREADY_INITIALIZED","WeakMap","state","metadata","facade","STATE","enforce","getterFor","TYPE","type","documentAll","all","replacement","feature","detection","normalize","POLYFILL","NATIVE","string","replace","toLowerCase","getBuiltIn","isPrototypeOf","USE_SYMBOL_AS_UID","$Symbol","toLength","obj","CONFIGURABLE_FUNCTION_NAME","InternalStateModule","enforceInternalState","getInternalState","CONFIGURABLE_LENGTH","TEMPLATE","getter","setter","arity","constructor","ceil","trunc","x","n","IE8_DOM_DEFINE","V8_PROTOTYPE_DEFINE_BUG","anObject","toPropertyKey","$defineProperty","$getOwnPropertyDescriptor","ENUMERABLE","WRITABLE","Attributes","current","propertyIsEnumerableModule","internalObjectKeys","getOwnPropertyNames","getOwnPropertySymbols","names","enumBugKeys","$propertyIsEnumerable","NASHORN_BUG","input","pref","val","valueOf","getOwnPropertyNamesModule","getOwnPropertySymbolsModule","uid","IS_PURE","SHARED","mode","copyright","license","V8_VERSION","symbol","Symbol","toIntegerOrInfinity","max","min","integer","IndexedObject","requireObjectCoercible","number","len","isSymbol","getMethod","ordinaryToPrimitive","TO_PRIMITIVE","exoticToPrim","toPrimitive","postfix","random","NATIVE_SYMBOL","iterator","WellKnownSymbolsStore","createWellKnownSymbol","withoutSetter","$","deletePropertyOrThrow","internalSort","arrayMethodIsStrict","FF","IE_OR_EDGE","V8","WEBKIT","nativeSort","FAILS_ON_UNDEFINED","FAILS_ON_NULL","STRICT_METHOD","STABLE_SORT","code","chr","fromCharCode","v","b","charAt","proto","itemsLength","items","arrayLength","y","getSortCompare","nativeKeys","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","__esModule","d","definition","o","e","prop","r","toStringTag","PointerScope","polyfill","audioContext","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","callback","setInterval","cancelAnimationFrame","webkitCancelAnimationFrame","mozCancelAnimationFrame","AudioContext","webkitAudioContext","replaceMe","decodeAudioData","arrayBuffer","Promise","resolve","reject","mozAudioContext","msAudioContext","oAudioContext","devicePixelRatio","Flags","useCanvasGraphicsContext","enable","freeze","_FROZEN","_reset","_FLAGS","flagName","Error","disable","isEnabled","show","createId","Future","_isCompleted","promise","_resolver","_rejecter","isCompleted","EventEmitter","_paused","_listeners","_listenersOnce","_pipes","clear","on","eventName","handler","close","off","once","newListeners","filter","h","newOnceListeners","emit","event","forEach","onces","pipe","emitter","splice","unpipe","pause","unpause","BITMASK32","Random","seed","_lowerMask","_upperMask","_w","_n","_m","_a","_u","_s","_b","_t","_c","_l","_f","_mt","Array","Date","now","s","_index","_twist","mag01","nextInt","next","floating","bool","likelihood","pickOne","pickSet","numPicks","allowDuplicates","_pickSetWithDuplicates","_pickSetWithoutDuplicates","currentPick","tempArray","shuffle","swap","randomIndex","range","d4","d6","d8","d10","d12","d20","TwoPI","PI","frac","sign","clamp","canonicalizeAngle","angle","tmpAngle","toDegrees","radians","toRadians","degrees","from","to","_x","randomInRange","randomIntInRange","round","Vector","Zero","One","Half","Up","Down","Left","Right","fromAngle","cos","sin","isValid","vec","isNaN","Infinity","distance","vec1","vec2","sqrt","pow","_y","setTo","equals","vector","tolerance","EQUALS_EPSILON","abs","deltaX","deltaY","squareDistance","clampMagnitude","magnitude","newSize","size","newLength","scale","average","add","sizeOrScale","dest","sub","addEqual","subEqual","scaleEqual","dot","cross","num","perpendicular","normal","negate","toAngle","atan2","rotate","anchor","sinAngle","cosAngle","clone","fixed","toFixed","Color","fromRGB","fromRGBString","parseInt","parseFloat","fromHex","hex","fromHSL","l","HSLColor","toRGBA","lighten","factor","temp","fromRGBA","darken","saturate","desaturate","multiply","color","newR","newG","newB","newA","screen","color1","invert","color2","equal","format","toHSLA","toHex","_componentToHex","c","hexRepresentation","fillStyle","Black","White","Gray","LightGray","DarkGray","Yellow","Orange","Red","Vermilion","Rose","Magenta","Violet","Blue","Azure","Cyan","Viridian","Green","Chartreuse","Transparent","ExcaliburBlue","hue2rgb","p","q","t","LogLevel","Side","MatrixLocations","Logger","_appenders","defaultLevel","Info","_logOnceSet","Set","_INSTANCE","addAppender","ConsoleAppender","getInstance","appender","clearAppenders","_log","level","args","log","_logOnce","serialized","debug","Debug","debugOnce","info","infoOnce","warn","Warn","warnOnce","errorOnce","fatal","Fatal","fatalOnce","console","consoleArgs","unshift","ScreenAppender","_messages","_pos","_color","_options","canvas","_ctx","getContext","style","position","zIndex","body","appendChild","_positionScreenAppenderCanvas","engine","events","width","resolution","height","pagePos","screenToPageCoordinates","top","xPos","message","clearRect","pos","fillText","getOpposite","side","Top","Bottom","None","fromDirection","direction","directions","directionEnum","Number","MAX_VALUE","maxIndex","BoundingBox","leftOrOptions","bottom","_points","getSideFromIntersection","intersection","fromPoints","points","minX","minY","maxX","maxY","fromDimension","hasZeroDimensions","center","topLeft","bottomRight","topRight","bottomLeft","translate","point","getPoints","shifted","transform","matrix","xa1","xa2","xb1","xb2","ya1","ya2","yb1","yb2","matrixPos","getPosition","getPerimeter","_left","_right","_top","_bottom","rayCast","ray","farClipDistance","tmin","tmax","xinv","dir","yinv","tx1","tx2","ty1","ty2","rayCastTime","contains","combine","other","dimensions","overlaps","epsilon","totalBoundingBox","intersect","overlapX","overlapY","intersectWithSide","bb","draw","ex","drawRect","rect","getBoundingClientRect","scrollX","scrollY","addItemToArray","removeItemFromArray","fail","delay","milliseconds","clock","future","schedule","setTimeout","omit","newObj","Matrix","Float32Array","_scaleX","_scaleSignX","_scaleY","_scaleSignY","ortho","near","far","mat","toDOMMatrix","DOMMatrix","fromFloat32Array","identity","reset","translation","sx","sy","rotation","angleRadians","vectorOrMatrix","resultX","resultY","a11","a21","a31","a41","a12","a22","a32","a42","a13","a23","a33","a43","a14","a24","a34","a44","b11","b21","b31","b41","b12","b22","b32","b42","b13","b23","b33","b43","b14","b24","b34","b44","getScale","setPosition","sine","cosine","setRotation","currentScale","getRotation","getScaleY","getScaleX","xscale","yscale","setScaleX","setScaleY","setScale","getBasisDeterminant","getAffineInverse","inverseDet","m","tx","ty","isIdentity","AffineMatrix","Float64Array","_scale","determinant","inverse","multiplyQuadInPlace","quad","resultTopLeftX","resultTopLeftY","resultTopRightX","resultTopRightY","resultBottomLeftX","resultBottomLeftY","resultBottomRightX","resultBottomRightY","to4x4","TransformStack","_transforms","_currentTransform","save","restore","pop","StateStack","_getDefaultState","_states","opacity","z","tint","material","_cloneState","ResourceEvents","Complete","Load","LoadStart","Progress","Resource","responseType","bustCache","logger","isLoaded","_cacheBust","uri","load","request","XMLHttpRequest","open","addEventListener","status","response","statusText","send","watch","change","__isProxy","Proxy","createHandler","typeType","watchAny","Graphic","isStale","_transformStale","flipHorizontal","_flipHorizontal","flipVertical","_flipVertical","_rotation","origin","_origin","_ID","showDebug","_width","_height","cloneGraphicOptions","localBounds","_preDraw","_drawImage","_postDraw","_rotate","_flip","scaleDirX","scaleDirY","Sprite","image","super","_logger","_dirty","sourceView","destSize","_updateSpriteDimensions","ready","then","newWidth","newHeight","nativeWidth","nativeHeight","drawImage","ImageFiltering","ImageWrapping","parseImageFiltering","Pixel","Blended","parseImageWrapping","Clamp","Repeat","Mirror","TextureLoader","gl","_textureMap","Map","_gl","_MAX_TEXTURE_SIZE","getParameter","MAX_TEXTURE_SIZE","dispose","delete","forceUpdate","filtering","wrapping","wrappingConfig","tex","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","createTexture","checkImageSizeSupportedAndLog","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","xWrap","yWrap","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","REPEAT","MIRRORED_REPEAT","TEXTURE_WRAP_T","filterMode","TEXTURE_MIN_FILTER","NEAREST","LINEAR","TEXTURE_MAG_FILTER","deleteTexture","originalSrc","dataset","_LOGGER","ImageSourceAttributeConstants","Filtering","WrappingX","WrappingY","ImageSource","naturalWidth","naturalHeight","_src","src","bustCacheOrOptions","Image","_readyFuture","_resource","endsWith","fromHtmlImageElement","imageSource","setAttribute","url","blob","URL","createObjectURL","loadedFuture","onload","toSprite","unload","SpriteFont","_text","alphabet","shadow","caseInsensitive","spacing","lineHeight","spriteSheet","_getCharacterSprites","text","results","textToRender","toLocaleLowerCase","letterIndex","letter","spriteIndex","letterSprite","sprites","measureText","maxWidth","lines","_getLinesFromText","maxWidthLine","reduce","sprite","xCursor","yCursor","line","render","bounds","offset","_cachedText","_cachedRenderWidth","_cachedLines","newLine","SpriteSheet","rows","columns","getSprite","spriteWithOptions","fromImageSourceWithSourceViews","sourceViews","fromImageSource","grid","cols","spriteWidth","spriteHeight","originOffset","margin","offsetDefaults","marginDefaults","DebugText","fontSheet","_imageSource","_spriteSheet","_spriteFont","write","ctx","RenderSource","_texture","use","activeTexture","TEXTURE0","RenderTarget","antialias","samples","transparency","MAX_SAMPLES","drawingBufferFormat","bufferFormat","RGBA8","RGB8","_setupRenderBuffer","_setupFramebuffer","setResolution","_frameTexture","_renderBuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorageMultisample","renderBuffer","renderFrameBuffer","_renderFrameBuffer","frameBuffer","_frameBuffer","frameTexture","createRenderbuffer","createFramebuffer","bindFramebuffer","FRAMEBUFFER","framebufferRenderbuffer","COLOR_ATTACHMENT0","attachmentPoint","framebufferTexture2D","toRenderSource","blitRenderBufferToFrameBuffer","blitToScreen","READ_FRAMEBUFFER","DRAW_FRAMEBUFFER","clearBufferfv","COLOR","blitFramebuffer","COLOR_BUFFER_BIT","copyToTexture","texture","copyTexImage2D","viewport","getGlTypeSizeBytes","FLOAT","SHORT","UNSIGNED_SHORT","BYTE","isAttributeInSource","variable","matches","RegExp","getGLTypeFromSource","groups","INT","UNSIGNED_INT","BOOL","getAttributeComponentSize","LOW_FLOAT","HIGH_FLOAT","FLOAT_VEC2","FLOAT_VEC3","FLOAT_VEC4","getAttributePointerType","Shader","compiled","_compiled","uniforms","attributes","vertexSource","fragmentSource","deleteProgram","program","useProgram","_ACTIVE_SHADER_INSTANCE","isCurrentlyBound","compile","vertexShader","_compileShader","VERTEX_SHADER","fragmentShader","FRAGMENT_SHADER","_createProgram","getAttributes","attribute","getUniforms","uniform","uniformCount","getProgramParameter","ACTIVE_UNIFORMS","getActiveUniform","uniformLocation","getUniformLocation","glType","location","attributeCount","ACTIVE_ATTRIBUTES","getActiveAttrib","attributeLocation","getAttribLocation","normalized","setTexture","slotNumber","setUniformInt","setUniform","trySetUniformInt","trySetUniform","setUniformIntArray","trySetUniformIntArray","setUniformBoolean","trySetUniformBoolean","setUniformFloat","trySetUniformFloat","setUniformFloatArray","trySetUniformFloatArray","setUniformFloatVector","trySetUniformFloatVector","setUniformFloatColor","trySetUniformFloatColor","setUniformMatrix","trySetUniformMatrix","uniformType","createProgram","attachShader","linkProgram","LINK_STATUS","getProgramInfoLog","typeName","shader","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","errorInfo","getShaderInfoLog","_processSourceForError","errorLineStart","search","errorLineEnd","_","error2","VertexBuffer","buffer","createBuffer","bufferData","bindBuffer","ARRAY_BUFFER","STATIC_DRAW","DYNAMIC_DRAW","unbind","upload","count","bufferSubData","deleteBuffer","VertexLayout","vertexBuffer","_vertexBuffer","_attributes","_suppressWarnings","_layout","_vertexTotalSizeBytes","_initialized","suppressWarnings","_shader","initialize","totalVertexSizeBytes","shaderAttributes","attrib","componentsPerVertex","vertAttribute","typeSize","_vao","createVertexArray","bindVertexArray","vert","vertexAttribPointer","enableVertexAttribArray","uploadBuffer","GraphicsDiagnostics","DrawCallCount","DrawnImagesCount","LineRenderer","priority","_maxLines","_vertexIndex","_lineCount","context","_context","start","end","_isFull","flush","getTransform","finalStart","finalEnd","hasPendingDraws","drawArrays","LINES","PointRenderer","_maxPoints","_pointCount","_buffer","snapToPixel","finalPoint","pixelSnapEpsilon","POINTS","ScreenPassPainter","renderWithPostProcessor","postprocessor","getShader","getLayout","TRIANGLES","renderToScreen","QuadIndexBuffer","numberOfQuads","useUint16","ELEMENT_ARRAY_BUFFER","totalVertices","maxUint16","maxUint16Index","bufferGlType","Uint16Array","Uint32Array","currentQuad","ImageRenderer","_maxImages","_maxTextures","_imageCount","_textures","_textureIndex","_textureToIndex","_images","_imageToWidth","_imageToHeight","_view","_dest","_quad","pixelArtSampler","uvPadding","MAX_TEXTURE_IMAGE_UNITS","transformedFrag","_transformFragmentSource","_quads","maxTextures","newSource","texturePickerBuilder","_addImageAsTexture","maybeFiltering","getAttribute","wrapX","wrapY","force","textureLoader","removeAttribute","_bindTextures","_getTextureIdForImage","maybeTexture","_getImageWidth","maybeWidth","_getImageHeight","maybeHeight","swidth","sheight","dx","dy","dwidth","dheight","maybeImageWidth","maybeImageHeight","sw","sh","textureId","imageWidth","imageHeight","uvx0","uvy0","uvx1","uvy1","txWidth","txHeight","drawElements","RectangleRenderer","_maxRectangles","_rectangleCount","drawLine","drawRectangle","thickness","halfThick","startTop","startBottom","endTop","endBottom","stroke","strokeThickness","CircleRenderer","_maxCircles","_circleCount","radius","Pool","builder","recycler","maxObjects","totalAllocations","objects","disableWarnings","preallocate","using","done","borrow","poolIndex","DrawCall","Material","graphicsContext","images","_name","_vertexSource","_fragmentSource","ExcaliburGraphicsContextWebGL","_graphicsContext","_initialize","addImageSource","graphicsContextWebGL","__gl","_maxTextureSlots","isUsingScreenTexture","update","textureUniformName","removeImageSource","textureName","_loadImageSource","imageElement","uploadAndBind","startingTextureSlot","textureSlot","entries","MaterialRenderer","vertexIndex","view","topLeftScreen","bottomRightScreen","screenUVX0","screenUVY0","screenUVX1","screenUVY1","performance","materialScreenTexture","ExcaliburGraphicsContextWebGLDebug","_webglCtx","_debugText","rectOptions","lineOptions","drawPoint","pointOptions","drawText","_state","_ortho","checkIfResolutionSupported","dim","supported","_renderers","_isDrawLifecycle","useDrawSorting","_drawCallPool","instance","renderer","_drawCallIndex","_drawCalls","fill","_postProcessTargets","_postprocessors","_transform","smoothing","backgroundColor","multiSampleAntialiasing","_isContextLost","_disposed","_totalPostProcessorTime","canvasElement","enableTransparency","antialiasing","powerPreference","handleContextLost","handleContextRestored","premultipliedAlpha","alpha","depth","_init","values","clearColor","BLEND","blendEquation","FUNC_ADD","blendFunc","ONE","ONE_MINUS_SRC_ALPHA","blendEquationSeparate","blendFuncSeparate","register","_screenRenderer","_renderTarget","_msaaTarget","rendererName","_isCurrentRenderer","_currentRenderer","beginDrawLifecycle","endDrawLifecycle","drawCall","resetTransform","updateViewport","trace","drawCircle","addPostProcessor","removePostProcessor","clearPostProcessors","updatePostProcessors","delta","find","u","onUpdate","createMaterial","currentTarget","originalSort","firstIndex","originalSortOrder","oldTransform","oldState","currentRendererName","currentRenderer","ExcaliburGraphicsContext2DCanvasDebug","_ex","__ctx","strokeStyle","strokeRect","beginPath","moveTo","lineTo","lineWidth","closePath","arc","ExcaliburGraphicsContext2DCanvas","imageSmoothingEnabled","_resolution","globalAlpha","fillRect","setTransform","_postprocessor","DisplayMode","Resolution","SVGA","Standard","Atari2600","GameBoy","GameBoyAdvance","NintendoDS","NES","SNES","ScreenEvents","ScreenResize","PixelRatioChange","FullScreenChange","Screen","_antialiasing","_canvasImageRendering","_resolutionStack","_viewportStack","_pixelRatioOverride","_isFullScreen","_isDisposed","_fullscreenChangeHandler","fullscreen","isFullScreen","_pixelRatioChangeHandler","_listenForPixelRatio","_devicePixelRatio","_calculateDevicePixelRatio","applyResolutionAndViewport","pixelRatio","_resizeHandler","parent","_setResolutionAndViewportByDisplayMode","_contentArea","_unsafeArea","_contentResolution","_displayMode","displayMode","Fixed","_canvas","canvasImageRendering","_browser","browser","_applyDisplayMode","_mediaQueryList","removeListener","nativeComponent","matchMedia","addListener","_resizeObserver","disconnect","removeEventListener","pixelRatioOverride","isHiDpi","FillContainer","FitContainer","FitContainerAndFill","FitContainerAndZoom","parentElement","_viewport","aspectRatio","scaledWidth","scaledHeight","setCurrentCamera","camera","_camera","pushResolutionAndViewport","peekViewport","peekResolution","popResolutionAndViewport","currentPixelRatio","newResolutionSupported","imageRendering","widthUnit","heightUnit","isSmooth","goFullScreen","elementId","maybeElement","getElementById","requestFullscreen","exitFullScreen","exitFullscreen","_viewportToPixels","offsetWidth","offsetHeight","pageToScreenCoordinates","newX","newY","innerWidth","innerHeight","screenHeight","screenWidth","contentArea","screenMarginY","screenMarginX","screenToWorldCoordinates","worldToScreenCoordinates","pageToWorldCoordinates","worldToPageCoordinates","getWorldBounds","zoom","drawPos","getScreenBounds","canvasWidth","halfCanvasWidth","canvasHeight","halfCanvasHeight","drawWidth","halfDrawWidth","drawHeight","halfDrawHeight","unsafeArea","_computeFit","overflow","aspect","adjustedWidth","adjustedHeight","_computeFitScreenAndFill","vw","vh","_computeFitAndFill","_computeFitContainerAndFill","clip","_computeFitScreenAndZoom","_computeFitAndZoom","_computeFitContainerAndZoom","scaleX","scaleY","maxScaleFactor","zoomedWidth","zoomedHeight","_computeFitContainer","clientWidth","clientHeight","Window","ResizeObserver","observe","FillScreen","FitScreen","FitScreenAndFill","FitScreenAndZoom","AudioContextFactory","create","WebAudio","unlock","_UNLOCKED","unlockTimeoutTimer","resume","createBufferSource","ended","connect","destination","onended","playbackState","isLegacyWebAudioSource","currentTime","PLAYING_STATE","FINISHED_STATE","clearTimeout","isUnlocked","Raster","lineCap","quality","_smoothing","flagDirty","_lineWidth","_lineDash","_padding","strokeColor","lineDash","padding","_bitmap","bitmapWidth","bitmapHeight","maybeCtx","cloneRasterOptions","dirty","_getTotalWidth","_originalWidth","_getTotalHeight","_originalHeight","_strokeColor","rasterize","_applyRasterProperties","execute","setLineDash","getLineDash","Canvas","cache","ExResponse","any","json","arraybuffer","StateMachine","states","currentState","_currentState","machineDescription","machine","stateName","transitionState","transitions","startState","go","eventData","potentialNewState","onExit","onEnter","onState","elapsedMs","saveKey","localStorage","setItem","parse","getItem","WebAudioInstance","_createNewBufferSource","_instance","_audioContext","loop","playbackRate","_playbackRate","_volumeNode","_handleEnd","_playingFuture","_loop","volume","_volume","_stateMachine","in","gain","setTargetAtTime","duration","_duration","getTotalPlaybackDuration","createGain","PLAYING","pausedAt","startedAt","_playStarted","stop","SEEK","STOPPED","PAUSED","isPlaying","isPaused","isStopped","play","playStarted","seek","getPlaybackPosition","EventTypes","GameEvent","_bubbles","bubbles","stopPropagation","KillEvent","PreKillEvent","PostKillEvent","GameStartEvent","GameStopEvent","PreDrawEvent","PostDrawEvent","PreTransformDrawEvent","PostTransformDrawEvent","PreDebugDrawEvent","PostDebugDrawEvent","PreUpdateEvent","PostUpdateEvent","PreFrameEvent","prevStats","PostFrameEvent","stats","GamepadConnectEvent","gamepad","GamepadDisconnectEvent","GamepadButtonEvent","button","GamepadAxisEvent","axis","VisibleEvent","HiddenEvent","PreCollisionEvent","actor","contact","PostCollisionEvent","ContactStartEvent","ContactEndEvent","lastContact","CollisionPreSolveEvent","CollisionPostSolveEvent","CollisionStartEvent","CollisionEndEvent","InitializeEvent","ActivateEvent","DeactivateEvent","ExitViewPortEvent","EnterViewPortEvent","EnterTriggerEvent","ExitTriggerEvent","ActionStartEvent","action","ActionCompleteEvent","MediaEvent","_value","_path","_val","propagate","layPath","_actor","NativeSoundEvent","track","NativeSoundProcessedEvent","_processedData","canPlayFile","file","Audio","filetype","canPlayType","SoundEvents","VolumeChange","Processed","Pause","Stop","PlaybackEnd","Resume","PlaybackStart","Sound","_tracks","instances","paths","_isStopped","_wasPlayingOnHidden","audiobuffer","decodeAudio","wireEngine","_engine","pauseAudioWhenHidden","instanceCount","some","_resumePlayback","_startPlayback","trackId","_getTrackInstance","getTrackId","resumed","complete","newTrack","LoaderEvents","BeforeLoad","AfterLoad","UserAction","LoadResourceStart","LoadResourceEnd","isLoaderConstructor","DefaultLoader","resources","_resources","onDraw","_numLoaded","_totalTimeMs","_loadingFuture","loadables","addResources","onInitialize","onUserAction","onBeforeLoad","onAfterLoad","addResource","loadable","markResourceComplete","progress","total","elapsedMilliseconds","seconds","speed","font","textbox","actualBoundingBoxLeft","actualBoundingBoxRight","actualBoundingBoxAscent","actualBoundingBoxDescent","areResourcesLoaded","async","finally","resource","x1","y1","x2","y2","cap","roundRect","br","tl","tr","bl","defaultRadius","quadraticCurveTo","circle","Loader","_image","_imageElement","_imageLoaded","logo","playButtonRootElement","_playButtonRootElement","playButtonElement","_playButtonElement","_playButton","existingRoot","_styleBlock","textContent","_playButtonStyles","head","startButtonFactory","loadablesOrOptions","isArray","_originalOptions","_playButtonShown","logoWidth","logoHeight","loadingBarColor","suppressPlayButton","playButtonText","buttonElement","display","_configuredPixelRatio","_DEFAULT_LOADER_OPTIONS","showPlayButton","resizeHandler","_positionPlayButton","evt","click","playButtonClicked","startButtonHandler","hidePlayButton","fullscreenAfterLoad","fullscreenContainer","HTMLElement","removeChild","decode","buttonWidth","buttonHeight","playButtonPosition","logoY","logoX","logoPosition","oldAntialias","getAntialiasing","setAntialiasing","loadingX","loadingY","loadingBarPosition","progressWidth","REPORTED_FEATURES","webgl","webaudio","gamepadapi","Detector","_features","failedTests","_criticalTests","canvasSupport","elem","arrayBufferSupport","xhr","dataUrlSupport","toDataURL","objectUrlSupport","rgbaSupport","cssText","_warningTest","webAudioSupport","webglSupport","_loadBrowserFeatures","getBrowserFeatures","logBrowserFeatures","msg","dataurl","objecturl","rgba","getGamepads","failedCritical","warning","CollisionType","CoordPlane","SolverStrategy","BroadphaseStrategy","Integrator","ContactSolveBias","VectorView","_getX","getX","_getY","getY","_setX","setX","_setY","setY","WatchVector","original","_parent","_children","_isDirty","_isInverseDirty","_matrix","_inverse","children","globalPos","localPos","canonRotation","globalRotation","inverseRotation","globalScale","inverseScale","globalScaleX","globalScaleY","_calculateMatrix","applyInverse","isComponentCtor","Component","owner","newComponent","Observable","observers","subscriptions","observer","subscribe","unregister","unsubscribe","notifyAll","observersLength","notify","subscriptionsLength","TransformComponent","_parentComponent","_addChildTransform","child","childTxComponent","zIndexChanged$","_z","_coordPlane","World","onAdd","childrenAdded$","childrenRemoved$","onRemove","_previousOwner","oldz","coordPlane","component","MotionComponent","vel","acc","scaleFactor","angularVelocity","torque","inertia","CollisionGroupManager","mask","_CURRENT_GROUP","_MAX_GROUPS","_GROUPS","existingGroup","group","CollisionGroup","_CURRENT_BIT","groupByName","_STARTING_BIT","category","_category","_mask","canCollide","overlap1","overlap2","collisionGroups","combinedName","combinedMask","collidesWith","padStart","All","Pair","colliderA","colliderB","calculatePairHash","bodyA","BodyComponent","bodyB","collisionType","PreventCollision","active","collide","hasCollider","collider","idA","idB","Projection","projection","getOverlap","TreeNode","isLeaf","DynamicTree","_config","worldBounds","nodes","_insert","leaf","leafAABB","currentRoot","area","combinedArea","cost","inheritanceCost","leftCost","leftCombined","newArea","oldArea","rightCost","rightCombined","oldParent","newParent","currentNode","_balance","_remove","grandParent","sibling","trackCollider","node","updateCollider","untrackCollider","boundsPadding","multdx","velocityMultiplier","multdy","balance","getHeight","query","helper","rayCastQuery","getNodes","Ray","numerator","begin","getSlope","divisor","getLength","intersectPoint","time","getPoint","DynamicTreeCollisionProcessor","_pairs","_collisionPairCache","_colliders","_dynamicCollisionTree","dynamicTree","getColliders","maxDistance","collisionGroup","collisionMask","searchAllColliders","maybeBody","ignoreCollisionGroupAll","hit","CompositeCollider","colliders","untrack","_pairExists","hash","broadphase","targets","potentialColliders","pair","physics","pairs","continuous","checkForFastBodies","Active","updateDistance","minDimension","disableMinimumSpeedForFastBody","fastBodies","updateVec","oldPos","centerPoint","furthestPoint","getFurthestPoint","minCollider","surfaceEpsilon","minTranslate","shift","fastBodyCollisions","narrowphase","contacts","newContacts","collisions","updated","Collider","composite","touching","Physics","gravity","useArcadePhysics","collisionResolutionStrategy","Arcade","useRealisticPhysics","Realistic","enabled","broadphaseStrategy","DynamicAABBTree","defaultMass","integrator","Euler","dynamicTreeVelocityMultiplier","positionIterations","velocityIterations","slop","steeringFactor","warmStart","bodiesCanSleepByDefault","sleepEpsilon","wakeThreshold","sleepBias","VerticalFirst","HorizontalFirst","DefaultPhysicsConfig","solver","compositeStrategy","bodies","canSleepByDefault","arcade","contactSolveBias","realistic","DeprecatedStaticToConfig","_compositeStrategy","_collisionProcessor","_dynamicAABBTree","addCollider","clearColliders","removeCollider","worldPos","axes","furthestPoints","bestPoint","getInertia","mass","totalInertia","otherColliders","potentialCollider","getClosestLineBetween","maybeLine","minLength","minLine","hits","minHit","minDistance","project","projections","proj","newProjection","LineSegment","slope","intercept","_normal","_dir","_slope","getEdge","_length","midpoint","flip","below","sideVector","clipTime","distanceToPoint","signed","x0","y0","findVectorToPoint","aMinusP","findPoint","hasPoint","currPoint","threshold","dxc","dyc","dx1","dy1","ClosestLine","p0","q0","w0","denom","sDenom","tDenom","tClosestParallel","sClosest","tClosest","ClosestLineJumpTable","PolygonPolygonClosestLine","polygonA","polygonB","otherWorldPos","otherDirection","thisDirection","rayTowardsOther","rayTowardsThis","thisPoint","otherPoint","thisFace","getClosestFace","otherFace","face","PolygonEdgeClosestLine","polygon","edge","edgeLine","asLine","PolygonCircleClosestLine","circlex","circley","CircleCircleClosestLine","circleA","circleB","CircleEdgeClosestLine","circleWorldPos","EdgeEdgeClosestLine","edgeA","edgeB","edgeLineA","edgeLineB","CircleCollider","_globalMatrix","_naturalRadius","orig","discriminant","toi","toi1","toi2","positiveToi","minToi","shape","PolygonCollider","EdgeCollider","CollisionJumpTable","CollideCircleCircle","CollideCirclePolygon","CollideCircleEdge","getFurthestLocalPoint","scalars","dotProduct","CollisionContact","mtv","tangent","localPoints","_canceled","colliderAId","colliderBId","matchAwake","sleeping","sleepMotion","setSleeping","isCanceled","cancel","SeparatingAxis","findPolygonPolygonSeparation","polyA","polyB","bestSeparation","bestSide","bestAxis","bestSideIndex","bestOtherPoint","sides","getSides","localSides","getLocalSides","vertB","vertSeparation","separation","localSide","sideId","localPoint","findCirclePolygonSeparation","polyDir","closestPointOnPoly","minOverlap","minAxis","minIndex","proj1","proj2","overlap","circleAPos","circleBPos","combinedRadius","mvt","local","samedir","findSide","findLocalSide","cc","edgeWorld","asLocalLine","da","dda","db","ddb","den","pointOnEdge","dd","CollideEdgeEdge","CollidePolygonEdge","pc","linePoly","CollidePolygonPolygon","separationA","separationB","incident","reference","refDir","clipRight","clipLeft","xf","FindContactSeparation","shapeA","txA","shapeB","txB","worldPoint","circlePoint","dist","_getTransformedBegin","_getTransformedEnd","transformedBegin","transformedEnd","_boundsFromBeginEnd","edgeNormal","registerGraphicsContext","debugDrawCall","drawLines","drawPolygon","firstPoint","drawBounds","boundingBox","drawRay","_localBoundsDirty","_localSidesDirty","_transformedPointsDirty","_sidesDirty","_transformedPoints","_sides","_localSides","_isCounterClockwiseWinding","reverse","isConvex","suppressConvexWarning","_calculateTransformation","sum","oldPoint","newPoint","oldDirection","orientation","angleSum","tessellate","polygons","Shape","Polygon","triangulate","triangles","vertices","vertexCount","getPrevIndex","getNextIndex","prev","va","vb","vc","leftArm","rightArm","convexVertices","isPointInTriangle","ab","bc","ca","ap","bp","cp","cross1","cross2","cross3","findEarTip","isEar","cutEarTip","getTransformedPoints","currentSide","mostDirection","testRay","accum","pts","POSITIVE_INFINITY","faceIndex","_localBounds","_cachedMass","_cachedInertia","denominator","iplusone","crossTerm","contactSide","minContactTime","contactIndex","contactTime","scalar","Box","Circle","Edge","Capsule","ColliderComponent","$colliderAdded","$colliderRemoved","_collidersToRemove","_collider","processColliderRemoval","flipped","entity","precollision","Actor","onPreCollisionResolve","postcollision","onPostCollisionResolve","onCollisionStart","onCollisionEnd","useBoxCollider","usePolygonCollider","poly","useCircleCollider","useEdgeCollider","useCompositeCollider","DegreeOfFreedom","dependencies","__oldTransformCaptured","enableFixedUpdateInterpolate","_sleeping","bounciness","friction","useGravity","limitDegreeOfFreedom","oldVel","oldAcc","_bodyConfig","config","updatePhysicsConfig","_mass","_DEFAULT_CONFIG","canSleep","updateDefaultPhysicsConfig","newMass","_cachedInverseInertia","inverseMass","updateMotion","currentMotion","bias","maybeCollider","inverseInertia","motion","oldRotation","oldScale","applyImpulse","impulse","finalImpulse","X","Y","Rotation","distanceFromCenter","applyLinearImpulse","applyAngularImpulse","captureOldTransform","AddedComponent","isAddedComponent","RemovedComponent","isRemovedComponent","EntityEvents","Initialize","PreUpdate","PostUpdate","Kill","Entity","componentsOrOptions","componentsToAdd","nameToAdd","_tags","componentAdded$","componentRemoved$","tagAdded$","tagRemoved$","components","_componentsToRemove","_instanceOfComponentCacheDirty","_instanceOfComponentCache","scene","_isInitialized","addComponent","kill","unparent","isKilled","tags","hasTag","addTag","removeTag","types","getComponents","hasAll","requiredTypes","hasAllTags","requiredTags","_getCachedInstanceOfType","maybeComponent","addChild","getAncestors","removeAllChildren","getDescendants","queue","curr","newEntity","componentInstance","addTemplate","templateEntity","removeComponent","ctor","typeOrInstance","componentToRemove","clearComponents","processComponentRemoval","isInitialized","_preupdate","onPreUpdate","_postupdate","onPostUpdate","AnimationDirection","AnimationStrategy","AnimationEvents","Frame","Loop","End","Animation","frames","strategy","frameDuration","_idempotencyToken","_firstTick","_currentFrame","_timeLeftInFrame","_pingPongDirection","_done","_playing","_speed","_reversed","totalDuration","goToFrame","maybeFrame","currentFrame","graphic","fromSpriteSheet","frameIndices","durationPerFrameMs","invalidIndices","fromSpriteSheetCoordinates","frameCoordinates","defaultDuration","coord","currentFrameIndex","currentFrameTimeLeft","Backward","Forward","canFinish","Freeze","frameNumber","frameIndex","_nextFrame","PingPong","tick","idempotencyToken","GraphicsGroup","useAnchor","members","_updateDimensions","member","useBounds","_isAnimationOrGroup","hasGraphicsTick","GraphicsComponent","_offset","recalculateBounds","_anchor","_current","_graphics","visible","copyGraphics","graphics","onPreDraw","onPostDraw","onPreTransformDraw","onPostTransformDraw","graphicOrOptions","getGraphic","getOptions","getNames","currentOptions","nameOrGraphic","optionsToSet","graphicToSet","remove","hide","offsetX","offsetY","elapsed","Rectangle","_radius","PointerComponent","useColliderShape","useGraphicsBounds","EasingFunctions","CreateReversibleEasingFunction","easing","CreateVectorEasingFunction","Linear","startValue","endValue","EaseInQuad","EaseOutQuad","EaseInOutQuad","EaseInCubic","EaseOutCubic","EaseInOutCubic","ActionQueue","_actions","_currentAction","_completedActions","_entity","clearActions","getActions","hasNext","isComplete","repeatBuilder","repeat","_stopped","_repeatBuilder","_repeatContext","ActionContext","_actionQueue","getQueue","_repeat","_originalRepeat","RepeatForever","MoveBy","_started","_tx","_motion","_delta","_start","_end","_distance","MoveTo","destx","desty","RotationType","FontUnit","TextAlign","BaseAlign","FontStyle","Direction","RotateTo","rotationType","_rotationType","ShortestPath","_currentNonCannonAngle","distance1","distance2","_shortDistance","_longDistance","_shortestPathIsPositive","_direction","LongestPath","Clockwise","CounterClockwise","distanceTraveled","RotateBy","angleRadiansOffset","ScaleTo","speedX","speedY","_endX","_endY","_speedX","_speedY","_startX","_startY","_distanceX","_distanceY","directionX","directionY","ScaleBy","scaleOffsetX","scaleOffsetY","_startScale","_endScale","_directionX","_directionY","CallMethod","_method","_hasBeenCalled","EaseTo","easingFcn","_currentLerpTime","_lerpDuration","_lerpStart","_lerpEnd","EaseBy","Blink","timeVisible","timeNotVisible","numBlinks","_timeVisible","_timeNotVisible","_elapsedTime","_totalTime","Fade","endOpacity","_multiplier","_endOpacity","_ogspeed","Delay","_delay","Die","ActionsComponent","Follow","entityToFollow","followDistance","_followTx","_followMotion","_maximumDistance","_distanceBetween","actorToFollowSpeed","Meet","actorToMeet","_speedWasSpecified","_meetTx","_meetMotion","actorToMeetSpeed","_queue","runAction","easeTo","easeBy","xOrPos","yOrSpeed","speedOrUndefined","moveBy","xOffsetOrVector","yOffsetOrSpeed","xOffset","yOffset","rotateTo","rotateBy","scaleTo","sizeXOrVector","sizeYOrSpeed","speedXOrUndefined","speedYOrUndefined","sizeX","sizeY","scaleBy","sizeOffsetXOrVector","sizeOffsetYOrSpeed","sizeOffsetX","sizeOffsetY","blink","fade","die","callMethod","times","repeatForever","follow","meet","toPromise","_getCtx","FontTextInstance","_textFragments","disposed","_setDimension","_lastHashCode","getHashCode","_applyFont","metrics","textHeight","lineAdjustedHeight","bottomBounds","textBounds","lineHeightRatio","fontString","textAlign","baseAlign","includeColor","textBaseline","shadowColor","shadowBlur","blur","shadowOffsetX","shadowOffsetY","_drawText","strokeText","_splitTextBitmap","textImages","currentX","currentY","hashCode","frag","FontCache","_MEASURE_CACHE","measurement","measureTextWithoutCache","getTextInstance","textInstance","_TEXT_CACHE","_TEXT_USAGE","checkAndClearCache","deferred","currentHashCodes","FONT_TIMEOUT","newTextMeasurementCache","cacheSize","clearCache","Font","family","Normal","bold","unit","Px","LeftToRight","_textBounds","_textMeasurement","colorOverride","Text","_textWidth","_textHeight","_calculateDimension","_font","thePos","theVel","theAcc","theAngle","_handleAnchorChange","_handleOffsetChange","isOffScreen","draggable","_draggable","isDraggable","_pointerDragStartHandler","_pointerDragEndHandler","_pointerDragMoveHandler","_pointerDragLeaveHandler","currentGraphic","_dragging","pe","defaults","pointer","actions","Passive","builtInComponents","_prekill","onPreKill","_postkill","onPostKill","unkill","newZ","getGlobalPos","localCenter","getGlobalScale","getGlobalRotation","recurse","geom","containment","within","otherCollider","me","isScreenElement","ScreenElement","useWorld","coords","Timer","_complete","fcn","interval","repeats","numberOfRepeats","randomRange","_totalTimeAlive","_running","_numberOfTicks","maxNumberOfRepeats","_baseInterval","_generateRandomInterval","_MAX_ID","_callbacks","newInterval","newNumberOfRepeats","timesRepeated","getTimeRunning","timeToNextAction","timeElapsedTowardNextAction","isRunning","cancelTimer","ParallaxComponent","parallaxFactor","DebugGraphicsComponent","useTransform","TileMapEvents","PreDraw","PostDraw","PointerUp","PointerDown","PointerMove","PointerCancel","TileMap","flagCollidersDirty","_collidersDirty","flagTilesDirty","tiles","_token","_rows","_cols","renderFromTopOfGraphic","meshingLookBehind","_forwardPointerEventToTile","eventType","tile","getTileByPoint","_originalOffsets","debugFlags","_composite","_oldPos","_oldScale","tileWidth","tileHeight","currentCol","Tile","_setupPointerToTile","_getOrSetColliderOriginalOffset","originalOffset","_updateColliders","shareEdges","checkAndCombine","maxLookBack","solid","defaultGeometry","getTileByIndex","getTile","_getTileCoordinates","getRows","getColumns","getOnScreenTiles","maybeParallax","oneMinusFactor","parallaxOffset","currentScene","tileStartX","tileStartY","tileEndX","tileEndY","_oldRotation","graphicsIndex","graphicsLen","offsets","getGraphicsOffsets","getGraphics","gfx","showAll","showGrid","gridColor","gridWidth","showSolidBounds","showColliderBounds","solidBoundsColor","colliderBoundsColor","showColliderGeometry","tilemap","geometryColor","geometryLineWidth","geometryPointSize","pointSize","_posDirty","_recalculate","_solid","_offsets","addGraphic","removeGraphic","clearGraphics","geometryPos","_geometry","_bounds","StrategyContainer","lockToActor","addStrategy","LockCameraToActorStrategy","lockToActorAxis","LockCameraToActorAxisStrategy","elasticToActor","cameraElasticity","cameraFriction","ElasticToActorStrategy","radiusAroundActor","RadiusAroundActorStrategy","limitCameraBounds","box","LimitCameraBoundsStrategy","Axis","cam","_eng","currentFocus","getFocus","focus","cameraVel","stretch","boundSizeChecked","focusX","focusY","CameraEvents","Camera","_cameraStrategies","dz","az","_angularVelocity","_posChanged","_cameraMoving","_isShaking","_shakeMagnitudeX","_shakeMagnitudeY","_shakeDuration","_elapsedShakeTime","_xShake","_yShake","_isZooming","_zoomStart","_zoomEnd","_currentZoomTime","_zoomDuration","_zoomEasing","_easing","_halfWidth","_halfHeight","_snapPos","_follow","ax","ay","move","easingFn","_lerpPromise","_lerpResolve","shake","magnitudeX","magnitudeY","zoomOverTime","_zoomPromise","_zoomResolve","cameraStrategy","removeStrategy","clearAllStrategies","_screen","currentRes","loadingComplete","res","updateTransform","runStrategies","newZoom","zoomEasing","lerpPoint","moveEasing","_isDoneShaking","fixedUpdateFps","blend","currentFrameLagMs","interpolatedPos","snapPos","newCanvasWidth","newCanvasHeight","cameraPos","TriggerEvents","ExitTrigger","EnterTrigger","triggerDefaults","Trigger","opts","_dispatchAction","_target","SystemPriority","Highest","Higher","Average","Lower","Lowest","SystemType","EmitterType","ParticleTransform","System","EntityManager","_world","entities","_entityIndex","_entitiesToRemove","updateEntities","removeEntity","findEntitiesForRemoval","addEntity","queryManager","idOrEntity","currFrame","actors","killed","processEntityRemovals","processComponentRemovals","getById","getByName","Query","requiredComponents","entityAdded$","entityRemoved$","checkAndAdd","getEntities","TagQuery","QueryManager","_queries","_addComponentHandlers","_removeComponentHandlers","_componentToQueriesIndex","_tagQueries","_addTagHandlers","_removeTagHandlers","_tagToQueriesIndex","_createAddComponentHandler","_createRemoveComponentHandler","_createAddTagHandler","_createRemoveTagHandler","createQuery","queries","createTagQuery","maybeAddComponent","maybeRemoveComponent","maybeAddTag","maybeRemoveTag","tagQuery","isSystemConstructor","SystemManager","systems","initialized","systemType","addSystem","systemOrCtor","system","removeSystem","updateSystems","preupdate","postupdate","entityManager","systemManager","queryTags","Update","entityOrSystem","clearEntities","clearSystems","EulerIntegrator","integrate","totalAcc","_ACC","_VEL","_POS","_VEL_ACC","_SCALE_FACTOR","_SCALE","MotionSystem","world","_physicsConfigDirty","$configUpdate","optionalBody","ArcadeSolver","directionMap","distanceMap","solve","preSolve","aDir","bDir","aDist","bDist","solvePosition","solveVelocity","postSolve","opposite","velAdj","ContactConstraintPoint","normalImpulse","tangentImpulse","normalMass","tangentMass","aToContact","bToContact","originalVelocityAndRestitution","aToContactNormal","bToContactNormal","aToContactTangent","bToContactTangent","getRelativeVelocity","velA","RealisticSolver","lastFrameContacts","idToContactConstraint","getContactConstraints","finishedContactIds","contactPoints","pointIndex","restitution","relativeVelocity","constraints","maxCorrection","steeringForce","impulseForce","impulseDelta","maxFriction","newImpulse","normalVelocity","CollisionSystem","_processor","_physics","collisionProcessor","_configDirty","_lastFrameContacts","_currentFrameContacts","_arcadeSolver","_realisticSolver","_trackCollider","_untrackCollider","colliderComponent","colliderComp","compositeColliders","getSolver","compositeId","substring","runContactStartEnd","Configurable","base","assign","props","ParticleImpl","emitterOrConfig","life","beginColor","endColor","velocity","acceleration","startSize","endSize","particleSprite","particleRotationalVelocity","currentRotation","focusAccel","fadeFlag","_rRate","_gRate","_bRate","_aRate","_currentColor","particleSize","sizeRate","elapsedMultiplier","isOffscreen","ParticleEmitter","particleTransform","Global","tmpColor","removeParticle","accel","Particle","_sprite","_particlesToEmit","numParticles","isEmitting","particles","deadParticles","minVel","maxVel","minAngle","maxAngle","emitRate","particleLife","minSize","maxSize","emitterType","randomRotation","particle","emitParticles","particleCount","_createParticle","clearParticles","ranX","ranY","blendTransform","oldTx","newTx","oldTxWithNewParent","oldGlobalPos","oldGlobalScale","oldGlobalRotation","interpolatedScale","interpolatedRotation","GraphicsSystem","sortedTransforms","_sortedTransforms","Draw","_zHasChanged","_zIndexUpdate","_targetInterpolationTransform","parallax","_applyTransform","particleOpacity","_drawGraphicsComponent","graphicsComponent","transformComponent","oldFlipHorizontal","oldFlipVertical","isDebug","showBounds","boundsColor","ancestors","ancestor","DebugSystem","_collisionSystem","filterSettings","entitySettings","txSettings","motionSettings","colliderSettings","physicsSettings","graphicsSettings","debugDraw","bodySettings","cameraSettings","useFilter","ids","nameQuery","cursor","_pushCameraTransform","debugZIndex","showPosition","positionColor","showPositionLabel","showZIndex","showId","showName","showRotation","rotationColor","showScale","scaleColor","showCollisionGroup","showCollisionType","showMass","showMotion","showSleeping","showVelocity","velocityColor","showAcceleration","accelerationColor","showGeometry","showOwner","_popCameraTransform","showBroadphaseSpacePartitionDebug","showCollisionContacts","showCollisionNormals","contactSize","collisionContactColor","collisionNormalColor","showFocus","focusColor","showZoom","PointerSystem","overrideUseColliderShape","overrideUseGraphicsBounds","lastFrameEntityToPointers","currentFrameEntityToPointers","_sortedEntities","_scene","_receivers","pointers","_engineReceiver","entityCurrentlyUnderPointer","pointerId","entityWasUnderPointer","entered","addPointerToEntity","_processPointerToEntity","_dispatchEvents","receiver","pointerBounds","currentFramePointerCoords","screenPos","graphicBounds","_processDownAndEmit","lastDownPerPointer","currentFrameDown","isDragStart","_processUpAndEmit","lastUpPerPointer","currentFrameUp","isDragEnd","_processMoveAndEmit","lastMovePerPointer","currentFrameMove","isDragging","_processEnterLeaveAndEmit","lastUpDownMoveEvents","_processCancelAndEmit","currentFrameCancel","_processWheelAndEmit","currentFrameWheel","lastFrameEntities","currentFrameEntities","entitiesWithEvents","ActionsSystem","IsometricEntityComponent","mapOrOptions","elevation","IsometricEntitySystem","iso","OffscreenSystem","_worldBounds","entityOffscreen","_isOffscreen","transformedBounds","PhysicsWorld","newConfig","Gamepads","_gamePadTimeStamps","_oldPads","_pads","_initSuccess","_navigator","_minimumConfiguration","_enabled","init","_clonePads","toggleEnabled","setMinimumGamepadConfiguration","_enableAndUpdate","_isGamepadValid","pad","axesLength","buttonLength","buttons","connected","gamepads","at","timestamp","bi","ai","navigatorGamepad","Buttons","getButton","pressed","updateButton","Axes","getAxes","updateAxes","_clonePad","Gamepad","getValidGamepads","pads","arr","clonedPad","MinAxisMoveThreshold","_axes","_buttons","_buttonsUp","_buttonsDown","isButtonPressed","isButtonHeld","wasButtonPressed","wasButtonReleased","Boolean","buttonIndex","axesIndex","Keys","InputMapper","inputs","_handlers","command","inputHandler","commandHandler","isCrossOriginIframe","noop","KeyEvent","originalEvent","Keyboard","_keys","_keysUp","_keysDown","_releaseAllKeys","ev","keyEvent","_handleKeyDown","metaKey","MetaLeft","MetaRight","_handleKeyUp","keyboardOptions","grabWindowFocus","getKeys","wasPressed","isHeld","wasReleased","triggerEvent","character","KeyboardEvent","GlobalCoordinates","fromPagePosition","yOrEngine","engineOrUndefined","pageX","pageY","PointerEvent","coordinates","pointerType","nativeEvent","WheelEvent","screenX","screenY","deltaZ","deltaMode","PointerAbstraction","lastPagePos","lastScreenPos","lastWorldPos","_onPointerMove","_onPointerDown","WheelDeltaMode","NativePointerButton","PointerButton","PointerType","PointerEventReceiver","primary","_activeNativePointerIdsToNormalized","lastFramePointerCoords","currentFramePointerDown","lastFramePointerDown","_pointers","_boundHandle","_handle","_boundWheel","_handleWheel","recreate","eventReceiver","isDown","wasDown","native","isDisposed","touchAction","wheelOptions","passive","pageScrollPreventionMode","ScrollPreventionMode","onmousewheel","grabFocus","detach","_normalizePointerId","nativePointerId","findIndex","preventDefault","eventCoords","TouchEvent","Unknown","Touch","changedTouches","touch","_nativeButtonToPointerButton","Mouse","isPointerEvent","_stringToPointerType","ScrollWheelNormalizationFactor","wheelDeltaX","wheelDeltaY","wheelDelta","detail","Line","Page","we","page","clientX","clientY","MouseEvent","pointerSystem","NoButton","Middle","Pen","InputHost","pointerTarget","keyboard","inputMapper","PreLoadEvent","SceneEvents","Activate","Deactivate","PreDebugDraw","PostDebugDraw","PreLoad","isSceneConstructor","Scene","triggers","tileMaps","timers","_timers","_cancelQueue","onPreLoad","loader","onTransition","onActivate","onDeactivate","_initializeChildren","pointerScope","director","getSceneName","_activate","_deactivate","_predraw","_postdraw","removeTimer","timer","_collectActorStats","addTimer","transfer","isTimerActive","isCurrentScene","screenElements","_ui","ui","alive","ColorBlindnessMode","ScreenShader","ColorBlindnessPostProcessor","_colorBlindnessMode","simulate","_simulate","colorBlindnessMode","colorBlindMode","Protanope","Deuteranope","Tritanope","ColorBlindFlags","_colorBlindPostProcessor","correct","colorBlindness","DebugConfig","FrameStats","prevFrame","isometric","positionSize","useTestClock","wasRunning","testClock","toTestClock","useStandardClock","currentClock","standardClock","toStandardClock","_id","_fps","_actorStats","remaining","_durationStats","_physicsStats","PhysicsStats","_graphicsStats","drawCalls","drawnImages","otherStats","fps","fs","_collisions","_contacts","_fastBodies","_fastBodyCollisions","_broadphase","_narrowphase","ps","BrowserComponent","_nativeHandlers","_decorate","BrowserEvents","_windowGlobal","_documentGlobal","_windowComponent","_documentComponent","DefaultAntialiasOptions","nativeContextAntialiasing","DefaultPixelArtOptions","FpsSampler","_samplePeriod","_currentFrameTime","_frames","_previousSampleTime","_beginFrameTime","initialFps","samplePeriod","_nowFn","nowFn","instant","Clock","_onFatalException","_maxFps","_lastTime","_elapsed","_scheduledCbs","_totalElapsed","maxFps","onFatalException","fpsSampler","TestClock","defaultUpdateMs","StandardClock","setFatalExceptionHandler","cb","timeoutMs","timing","scheduledTime","__runScheduledCbs","overrideUpdateMs","fpsInterval","leftover","mainloop","_requestId","_currentTime","_updateMs","step","run","numberOfSteps","Toaster","_toasterCss","_container","_createFragment","toastMessage","innerText","toast","linkTarget","linkName","className","messageFragments","link","href","finalMessage","dismissBtn","keydownHandler","first","firstChild","insertBefore","DirectorEvents","NavigationStart","Navigation","NavigationEnd","Director","isTransitioning","_isTransitioning","scenes","_sceneToInstance","_sceneToLoader","_sceneToTransition","_loadedScenes","rootScene","currentSceneName","sceneKey","sceneOrOptions","getSceneInstance","_deferredGoto","deferredScene","deferredTransition","_deferredTransition","swapScene","playTransition","configureStart","startScene","maybeLoaderOrCtor","maybeStartTransition","mainLoader","inTransition","_getLoader","sceneName","_getInTransition","sceneOrRoute","_getOutTransition","out","getDeferredScene","maybeDeferred","getSceneDefinition","maybeScene","assertAdded","assertRemoved","outTransition","nameOrScene","sceneOrCtor","potentialSceneOrOptions","goto","destinationScene","maybeDest","sourceScene","engineInputEnabled","maybeSourceOut","maybeDestinationIn","sourceOut","destinationIn","sceneActivationData","hideLoader","maybeLoadScene","_emitEvent","onPreviousSceneDeactivate","sceneDefinition","newScene","sceneToLoad","sceneToLoadInstance","transition","currentTransition","sceneInputEnabled","blockInput","previousScene","nextScene","destLoader","sourceName","destinationName","EngineEvents","FallbackGraphicsContext","Visible","Hidden","Start","PreFrame","PostFrame","Engine","useEngine","Context","isFullscreen","_isDebug","shouldSnapToPixel","scope","EX_VERSION","_inputEnabled","_suppressPlayButton","enableCanvasTransparency","stack","_toaster","_timescale","_handleWebGLContextLost","container","flexDirection","borderStyle","div","innerHTML","querySelector","reload","_performanceThresholdTriggered","_fpsSamples","_isLoading","_hideLoader","_isReadyFuture","currentFrameElapsedMs","_lagMs","_screenShotRequests","_DEFAULT_ENGINE_OPTIONS","detector","suppressMinimumBrowserFeatureDetection","_compatible","testMessage","canvasElementId","suppressConsoleBootMessage","_originalDisplayMode","pixelArt","suppressHiDPIScaling","_mainloop","___EXCALIBUR_DEVTOOL","InstanceCount","_monitorPerformanceThresholdAndTriggerFallback","allow","configurePerformanceCanvas2DFallback","showPlayerMessage","numberOfFrames","useCanvas2DFallback","newCanvas","cloneNode","parentNode","replaceChild","Document","timescale","addScene","removeScene","goToScene","scrollPreventionMode","visibilityState","toggleInputEnabled","_overrideInitialize","_update","_loader","_draw","_checkForScreenShots","toggle","toggleDebug","isReady","sceneNameOrLoader","frameId","beforeUpdate","fixedTimestepMs","afterUpdate","afterDraw","screenshot","preserveHiDPIResolution","finalWidth","finalHeight","raw","createContext","EventDispatcher","_wiredEventDispatchers","_deferedHandlerRemovals","_processDeferredHandlerRemovals","eventHandler","_removeHandler","eventHandlers","metaHandler","wire","eventDispatcher","unwire","Label","newFont","spriteFont","sf","getTextWidth","IsometricTile","_gfx","_recalculateBounds","_tileBounds","graphicsOffset","tileToWorld","_isometricEntityComponent","halfTileWidth","halfTileHeight","yPos","totalWidth","totalHeight","IsometricMap","updateColliders","worldToTile","worldCoordinate","tileCoordinate","tileCoord","_getMaxZIndex","maxZ","NEGATIVE_INFINITY","currentZ","ActionSequence","actionBuilder","_sequenceBuilder","_sequenceContext","ParallelActions","parallelActions","every","QuadTree","_defaultOptions","maxDepth","capacity","_isDivided","halfWidth","halfHeight","_split","newLevelOptions","_insertIntoSubNodes","insert","getAllItems","getTreeDepth","has_initialize","hasOnInitialize","has_preupdate","hasOnPreUpdate","has_postupdate","hasOnPostUpdate","hasPreDraw","hasPostDraw","Gif","_stream","_gif","_animation","_transparentColor","Stream","ParseGif","toSpriteSheet","toAnimation","readCheckBytes","checkBytes","bitsToNum","ba","byteToBitArr","bite","dataArray","readByte","byteLength","readBytes","bytes","read","readUnsigned","Uint8Array","stream","_st","_handler","globalColorTable","parseColorTable","ct","readSubBlocks","parseHeader","hdr","sig","ver","colorRes","globalColorTableSize","gctFlag","sorted","bgColor","pixelAspectRatio","bits","parseExt","block","parseGCExt","reserved","disposalMethod","userInput","transparencyGiven","delayTime","transparencyIndex","terminator","gce","parseComExt","comment","com","parsePTExt","ptHeader","ptData","pte","parseAppExt","parseNetscapeExt","unknown","iterations","app","NETSCAPE","parseUnknownAppExt","appData","identifier","authCode","parseUnknownExt","label","extType","parseImg","img","leftPos","topPos","lctFlag","interlaced","lctSize","lct","lzwMinCodeSize","lzwData","pixels","minCodeSize","readCode","charCodeAt","output","clearCode","eoiCode","codeSize","dict","last","lzwDecode","newPixels","cpRow","toRow","fromRow","fromPixels","steps","pass","deinterlace","arrayToImage","parseBlock","sentinel","eof","frame","FontSource","_isLoaded","FontFace","fonts","toFont","generatorFunctionDeclaration","isCoroutineGenerator","getPrototypeOf","coroutine","coroutineGenerator","thisArg","passedEngine","generatorFcn","generator","Transition","_currentProgress","_completeFuture","started","_currentDistance","updateTransition","onStart","onEnd","onReset","targetScene","FadeInOut","screenCover","CrossFade","_progress","_calculateBounds","lineNormal","halfThickness","minPoint","maxMessages","obsoleteMessage","resetObsoleteCounter","logMessage","suppressObsoleteMessages","showStackTrace","obsolete","alternateMethod","property","SyntaxError","DecoratedClass","AsyncWaitQueue","enqueue","dequeue","Semaphore","_count","_waitQueue","waiting","enter","exit"],"sourceRoot":""}